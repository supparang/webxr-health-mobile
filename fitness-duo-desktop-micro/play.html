<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>เล่น — Fitness Duo (Desktop Micro)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body{margin:0;background:#0b0f14;font-family:system-ui,Arial;color:#e8eef6}
    .hud{position:fixed;left:0;right:0;top:0;padding:8px 12px;display:flex;gap:8px;pointer-events:none z-index:10000; }
    .badge{background:rgba(0,0,0,.45);padding:6px 10px;border-radius:10px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:rgba(0,0,0,.8);
           padding:10px 14px;border-radius:999px;display:none z-index:10001; }
    a-scene{pointer-events:auto}
  </style>
</head>
<body>
  <div class="hud">
    <div class="badge" id="hudMode">โหมดฝึก</div>
    <div class="badge" id="hudTime">เวลา: ∞</div>
    <div class="badge" id="hudScore">คะแนน: 0</div>
    <div class="badge" id="hudCombo">คอมโบ: x1</div>
    <div class="badge"><a href="index.html" style="color:#8fbaff">กลับเมนู</a></div>
  </div>
  <div id="toast" class="toast"></div>

  <a-scene renderer="colorManagement: true">
    <a-assets timeout="10000">
      <img id="bg-jungle" src="assets/backgrounds/jungle.png" crossorigin="anonymous">
      <img id="bg-city" src="assets/backgrounds/city.png" crossorigin="anonymous">
      <img id="bg-space" src="assets/backgrounds/space.png" crossorigin="anonymous">
    </a-assets>

    <a-sky id="sky" color="#111122"></a-sky>
    <a-entity id="spawner"></a-entity>

    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="camera" wasd-controls-enabled="false"></a-camera>
      <!-- Cursor for desktop mouse -->
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable; far: 30; interval: 0"></a-entity>
    </a-entity>

    <a-entity light="type: ambient; color: #BBB"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 4 -2"></a-entity>
  </a-scene>

  <script>
    // --- helpers ---
    const $ = (id)=>document.getElementById(id);
    const toast=(m,ms=900)=>{ const t=$('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); };
    const q = new URLSearchParams(location.search);
    const theme = q.get('theme') || 'jungle';
    const mode = q.get('mode') || 'practice';

    const st = {
      theme, mode,
      timeLeft: mode==='timed'?60:999,
      score: 0, combo: 1,
      playing: false,
      spawnEveryMs: 1000, spawnTimer: 0,
      hit:0, miss:0, total:0
    };

    function setThemeSky(name){
      const sky = document.querySelector('#sky');
      const map = {jungle:'#bg-jungle', city:'#bg-city', space:'#bg-space'};
      sky.setAttribute('src', map[name] || '#bg-jungle');
    }
    function updateHUD(){
      $('hudMode').textContent = st.mode==='timed' ? 'จับเวลา' : 'โหมดฝึก';
      $('hudTime').textContent = st.mode==='timed' ? `เวลา: ${Math.ceil(st.timeLeft)}` : 'เวลา: ∞';
      $('hudScore').textContent = `คะแนน: ${st.score}`;
      $('hudCombo').textContent = `คอมโบ: x${st.combo}`;
    }

    function clearTargets(){
      const spawner = document.querySelector('#spawner');
      while (spawner.firstChild) spawner.removeChild(spawner.firstChild);
    }
    function addScore(base){
      st.combo = Math.min(5, st.combo+1);
      st.score += base + (st.combo-1)*10;
      updateHUD();
    }
    function spawn(){
      const spawner = document.querySelector('#spawner');
      const e = document.createElement('a-entity');
      e.setAttribute('geometry', 'primitive: sphere; radius: 0.22');
      e.setAttribute('material', 'color:#39c5bb; emissive:#083; metalness:0.1; roughness:0.4');
      const rx=(Math.random()*2-1)*1.2, ry=1+Math.random()*1.2, rz=-2.2-Math.random()*0.6;
      e.setAttribute('position', {x:rx,y:ry,z:rz});
      e.classList.add('clickable');
      e.setAttribute('animation__pulse','property: scale; to:1.15 1.15 1.15; dir:alternate; loop:true; dur:650');
      e.addEventListener('click', ()=>{ if(!st.playing) return; st.hit++; addScore(100); e.remove(); toast('เยี่ยม! +100', 700); });
      setTimeout(()=>{ if(!e.parentNode) return; st.miss++; st.combo=1; e.remove(); }, 1600+Math.random()*300);
      spawner.appendChild(e);
      st.total++;
    }

    // Manual raycast fallback (in case cursor fails)
    function manualRay(evt){
      if(!st.playing) return;
      const sceneEl = document.querySelector('a-scene');
      const camEl = document.querySelector('#camera');
      const renderer = sceneEl && sceneEl.renderer;
      const camera = camEl && camEl.getObject3D('camera');
      if(!renderer || !camera) return;
      const rect = renderer.domElement.getBoundingClientRect();
      const mouse = new THREE.Vector2(((evt.clientX-rect.left)/rect.width)*2-1, -((evt.clientY-rect.top)/rect.height)*2+1);
      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, camera);
      const nodes = Array.from(document.querySelectorAll('.clickable')).map(el=>el.object3D).filter(Boolean);
      const hits = raycaster.intersectObjects(nodes, true);
      if(hits.length){
        let obj = hits[0].object;
        while(obj && !obj.el) obj=obj.parent;
        if(obj && obj.el){ obj.el.emit('click'); }
      }
    }
    ['click','mousedown','mouseup'].forEach(t=> window.addEventListener(t, manualRay, {passive:false}));

    function loop(){
      let last = performance.now();
      const tick = ()=>{
        if(!st.playing) return;
        const now = performance.now(), dt=(now-last)/1000; last=now;
        if(now - st.spawnTimer > st.spawnEveryMs){ st.spawnTimer=now; spawn(); }
        if(st.mode==='timed'){
          st.timeLeft = Math.max(0, st.timeLeft - dt);
          $('hudTime').textContent = `เวลา: ${Math.ceil(st.timeLeft)}`;
          if(st.timeLeft<=0){ st.playing=false; toast(`จบเกม | คะแนน ${st.score}`, 2500); return; }
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    // Auto-start when scene loaded
    document.querySelector('a-scene').addEventListener('loaded', ()=>{
      document.querySelector('.hud').style.display='flex';
      st.playing = true;
      st.spawnTimer = performance.now();
      setThemeSky(st.theme);
      updateHUD();
      clearTargets();
      loop();
    });
  </script>
</body>
</html>