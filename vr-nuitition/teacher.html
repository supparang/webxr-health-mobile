<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health ‚Äî Teacher Dashboard</title>
  <meta name="color-scheme" content="light dark"/>
  <style>
    :root{
      color-scheme: light dark;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.15), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.18), transparent 55%),
        #020617;
      color:#e5e7eb;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px 32px;
    }
    header{
      margin-bottom:16px;
    }
    h1{
      margin:0 0 6px;
      font-size:24px;
    }
    .subtitle{
      font-size:13px;
      color:#cbd5f5;
      max-width:640px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.92);
      color:#e5e7eb;
      margin-bottom:8px;
    }

    .grid{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:16px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      border-radius:18px;
      padding:14px 16px 16px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.96);
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      margin-bottom:14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:16px;
    }
    .card p{
      margin:0 0 8px;
      font-size:12px;
      color:#cbd5f5;
    }

    input[type="file"]{
      font-size:12px;
    }

    .summary-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .summary-pill{
      flex:1 1 140px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.95);
      padding:6px 10px;
      font-size:12px;
    }
    .summary-label{
      color:#9ca3af;
      font-size:11px;
    }
    .summary-value{
      font-weight:600;
      font-size:14px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    th,td{
      border-bottom:1px solid rgba(55,65,81,0.9);
      padding:4px 6px;
      text-align:left;
    }
    th{
      font-weight:600;
      font-size:11px;
      color:#cbd5f5;
    }
    tbody tr:hover{
      background:rgba(31,41,55,0.9);
    }

    .pill-mode{
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.95);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">üìä Hero Health ‚Äî Teacher / Research Dashboard</div>
      <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° Hero Health ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h1>
      <p class="subtitle">
        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° <strong>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</strong> ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å
      </p>
    </header>

    <!-- ‡πÅ‡∏ñ‡∏ß‡∏ã‡πâ‡∏≤‡∏¢: upload + summary / ‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏ß‡∏≤: chart -->
    <div class="grid">
      <div>
        <!-- Upload -->
        <div class="card">
          <h2>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h2>
          <p>
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏° (‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π/‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÉ‡∏ä‡πâ schema ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)
          </p>
          <input id="csvInput" type="file" accept=".csv,text/csv"/>
        </div>

        <!-- Overall summary -->
        <div class="card">
          <h2>2. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
          <div class="summary-row">
            <div class="summary-pill">
              <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
              <div class="summary-value" id="sumPlayers">‚Äì</div>
            </div>
            <div class="summary-pill">
              <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô event (hit/miss)</div>
              <div class="summary-value" id="sumEvents">‚Äì</div>
            </div>
            <div class="summary-pill">
              <div class="summary-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
              <div class="summary-value" id="sumAcc">‚Äì</div>
            </div>
            <div class="summary-pill">
              <div class="summary-label">RT ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (ms)</div>
              <div class="summary-value" id="sumRt">‚Äì</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div>
        <!-- per-student chart -->
        <div id="chartCard" class="card" style="display:none;">
          <h2>3. ‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô</h2>
          <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á</p>
          <canvas id="studentChart" height="220"></canvas>
        </div>

        <!-- diff compare chart -->
        <div id="diffCard" class="card" style="display:none;">
          <h2>4. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</h2>
          <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Easy / Normal / Hard</p>
          <canvas id="diffChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <h2>5. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô</h2>
      <p>‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / accuracy / RT ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</p>
      <div style="overflow:auto;">
        <table id="studentTable">
          <thead>
            <tr>
              <th>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏ä‡∏±‡πâ‡∏ô</th>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö</th>
              <th>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
              <th>Accuracy ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
              <th>RT ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (ms)</th>
              <th>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center;color:#9ca3af;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const csvInput = document.getElementById('csvInput');
    const sumPlayersEl = document.getElementById('sumPlayers');
    const sumEventsEl  = document.getElementById('sumEvents');
    const sumAccEl     = document.getElementById('sumAcc');
    const sumRtEl      = document.getElementById('sumRt');

    const studentTable = document.getElementById('studentTable').querySelector('tbody');
    const chartCard    = document.getElementById('chartCard');
    const diffCard     = document.getElementById('diffCard');

    const studentCanvas = document.getElementById('studentChart');
    const diffCanvas    = document.getElementById('diffChart');

    let parsedRows = [];
    let perStudent = {};
    let chartInstance = null;
    let diffChartInstance = null;

    function parseCsv(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (!lines.length) return [];

      const header = lines[0].split(',').map(h => h.trim());
      const rows = [];

      for (let i=1;i<lines.length;i++){
        const raw = lines[i];
        if (!raw.trim()) continue;
        const cols = raw.split(',');
        const obj = {};
        for (let c=0;c<header.length;c++){
          const key = header[c];
          let val = cols[c] != null ? cols[c].trim() : '';
          if (key === 'correct' || key === 'fever' || key === 'quest_streak5_done' ||
              key === 'quest_combo_done' || key === 'quest_fever_twice' || key === 'quest_fever_done'){
            obj[key] = (val === '1' || val.toLowerCase() === 'true');
          } else if (key === 'rt_ms' || key === 'score_after' || key === 'combo_after' || key === 'time_left'){
            const n = parseFloat(val);
            obj[key] = isNaN(n) ? null : n;
          } else {
            obj[key] = val;
          }
        }
        rows.push(obj);
      }
      return rows;
    }

    function buildPerStudent(rows){
      const map = {};
      rows.forEach(r => {
        const name  = r.profile_name || '';
        const grade = r.profile_grade || '';
        const sid   = r.profile_id || '';
        const key = (name || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)') + '|' + (sid || '-');

        if (!map[key]){
          map[key] = {
            name, grade, sid,
            rounds:0,
            maxScore:0,
            modes: new Set(),
            diffSet: new Set(),
            hitEvents:0,
            correctEvents:0,
            rtSum:0,
            rtCount:0,
            questDoneCount:0
          };
        }
        const st = map[key];

        // ‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏à‡∏≤‡∏Å event hit/boss-hit ‡∏ó‡∏µ‡πà time_left = 0 ? ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ per-file ‡πÅ‡∏ö‡∏ö‡∏´‡∏¢‡∏≤‡∏ö:
        // ‡πÉ‡∏ä‡πâ kind === 'hit' ‡∏´‡∏£‡∏∑‡∏≠ 'boss-hit'
        if (r.kind === 'hit' || r.kind === 'boss-hit'){
          st.hitEvents++;
          if (r.correct) st.correctEvents++;
          if (typeof r.rt_ms === 'number' && r.rt_ms > 0){
            st.rtSum += r.rt_ms;
            st.rtCount++;
          }
          if (typeof r.score_after === 'number' && r.score_after > st.maxScore){
            st.maxScore = r.score_after;
          }
          if (r.mode) st.modes.add(r.mode);
          if (r.diff) st.diffSet.add(r.diff);
        }

        // ‡∏ô‡∏±‡∏ö quest ‡∏à‡∏≤‡∏Å flag ‡πÉ‡∏î ‡πÜ
        if (r.quest_streak5_done || r.quest_combo_done || r.quest_fever_done){
          st.questDoneCount++;
        }
      });

      // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì rounds ‡∏à‡∏≤‡∏Å hitEvents/20 (‡πÉ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 20 hit; ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
      Object.values(map).forEach(st => {
        st.rounds = Math.max(1, Math.round(st.hitEvents / 20));
      });

      return map;
    }

    function fillSummaryAndTable(){
      const keys = Object.keys(perStudent);
      const students = keys.map(k => perStudent[k]);

      if (!students.length){
        sumPlayersEl.textContent = '0';
        sumEventsEl.textContent  = '0';
        sumAccEl.textContent     = '‚Äì';
        sumRtEl.textContent      = '‚Äì';
        studentTable.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#9ca3af;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        chartCard.style.display = 'none';
        diffCard.style.display  = 'none';
        return;
      }

      // summary overall
      let totalEvents = 0, totalCorrect = 0, rtSum=0, rtCount=0;
      students.forEach(st => {
        totalEvents  += st.hitEvents;
        totalCorrect += st.correctEvents;
        rtSum        += st.rtSum;
        rtCount      += st.rtCount;
      });

      const acc = totalEvents ? (totalCorrect/totalEvents)*100 : 0;
      const rtAvg = rtCount ? (rtSum/rtCount) : 0;

      sumPlayersEl.textContent = String(students.length);
      sumEventsEl.textContent  = String(totalEvents || 0);
      sumAccEl.textContent     = totalEvents ? acc.toFixed(1)+'%' : '‚Äì';
      sumRtEl.textContent      = rtCount ? rtAvg.toFixed(1) : '‚Äì';

      // table
      studentTable.innerHTML = '';
      students.forEach(st => {
        const tr = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = st.name || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)';

        const gradeCell = document.createElement('td');
        gradeCell.textContent = st.grade || '-';

        const sidCell = document.createElement('td');
        sidCell.textContent = st.sid || '-';

        const roundsCell = document.createElement('td');
        roundsCell.textContent = String(st.rounds);

        const modeCell = document.createElement('td');
        const pill = document.createElement('span');
        pill.className = 'pill-mode';
        pill.textContent = Array.from(st.modes).join(', ') || '-';
        modeCell.appendChild(pill);

        const scoreCell = document.createElement('td');
        scoreCell.textContent = String(st.maxScore || 0);

        const accCell = document.createElement('td');
        const sAcc = st.hitEvents ? (st.correctEvents / st.hitEvents)*100 : 0;
        accCell.textContent = st.hitEvents ? sAcc.toFixed(1)+'%' : '‚Äì';

        const rtCell = document.createElement('td');
        const sRt = st.rtCount ? (st.rtSum / st.rtCount) : 0;
        rtCell.textContent = st.rtCount ? sRt.toFixed(1) : '‚Äì';

        const questCell = document.createElement('td');
        questCell.textContent = String(st.questDoneCount || 0);

        tr.appendChild(nameCell);
        tr.appendChild(gradeCell);
        tr.appendChild(sidCell);
        tr.appendChild(roundsCell);
        tr.appendChild(modeCell);
        tr.appendChild(scoreCell);
        tr.appendChild(accCell);
        tr.appendChild(rtCell);
        tr.appendChild(questCell);

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≤‡∏ü
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => {
          updateStudentChart(st);
        });

        studentTable.appendChild(tr);
      });

      // default: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
      updateStudentChart(students[0]);
      chartCard.style.display = 'block';
    }

    function updateStudentChart(st){
      if (!st) return;

      const label = st.name || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)';
      const acc = st.hitEvents ? (st.correctEvents / st.hitEvents)*100 : 0;
      const rt  = st.rtCount ? (st.rtSum / st.rtCount) : 0;
      const score = st.maxScore || 0;

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(studentCanvas.getContext('2d'), {
        type:'bar',
        data:{
          labels:['Score ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î','Accuracy (%)','RT (ms)'],
          datasets:[{
            label: label,
            data:[score, acc, rt]
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{display:false},
            tooltip:{enabled:true}
          },
          scales:{
            y:{
              beginAtZero:true
            }
          }
        }
      });
    }

    function updateDiffChart(){
      if (!parsedRows.length) return;

      const byDiff = {
        easy:   { hit:0, correct:0, sumRt:0, rtCount:0 },
        normal: { hit:0, correct:0, sumRt:0, rtCount:0 },
        hard:   { hit:0, correct:0, sumRt:0, rtCount:0 }
      };

      parsedRows.forEach(r => {
        const d = (r.diff || '').toLowerCase();
        if (!(d in byDiff)) return;

        if (r.kind === 'hit' || r.kind === 'boss-hit'){
          byDiff[d].hit++;
          if (r.correct) byDiff[d].correct++;
          if (typeof r.rt_ms === 'number' && r.rt_ms > 0){
            byDiff[d].sumRt += r.rt_ms;
            byDiff[d].rtCount++;
          }
        }
      });

      const labels = ['Easy','Normal','Hard'];
      const accData = [];
      const rtData  = [];

      ['easy','normal','hard'].forEach(d => {
        const s = byDiff[d];
        let acc = 0, rt = 0;
        if (s.hit > 0)   acc = (s.correct / s.hit)*100;
        if (s.rtCount>0) rt  = s.sumRt / s.rtCount;
        accData.push(acc);
        rtData.push(rt);
      });

      if (diffChartInstance) diffChartInstance.destroy();

      diffChartInstance = new Chart(diffCanvas.getContext('2d'), {
        type:'bar',
        data:{
          labels:labels,
          datasets:[
            {
              label:'Accuracy ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%)',
              data:accData
            },
            {
              label:'RT ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (ms)',
              data:rtData
            }
          ]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{display:true},
            tooltip:{enabled:true}
          },
          scales:{
            y:{
              beginAtZero:true
            }
          }
        }
      });

      diffCard.style.display = 'block';
    }

    csvInput.addEventListener('change', function(){
      const file = csvInput.files && csvInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const text = String(ev.target.result || '');
        parsedRows = parseCsv(text);
        perStudent = buildPerStudent(parsedRows);
        fillSummaryAndTable();
        updateDiffChart();
      };
      reader.readAsText(file, 'utf-8');
    });
  </script>
</body>
</html>
