<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <title>Hero Health — Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{color-scheme:light dark;}
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    .wrap{
      max-width:1080px;
      margin:24px auto;
      padding:0 16px 40px;
    }
    h1{
      margin:0 0 4px;
      font-size:22px;
    }
    .muted{
      color:#9ca3af;
      font-size:13px;
    }
    .panel{
      margin-top:16px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(51,65,85,0.9);
    }
    label{
      font-size:13px;
      display:inline-block;
      margin-right:8px;
    }
    select,input[type="file"]{
      background:#020617;
      border-radius:999px;
      border:1px solid #334155;
      color:#e5e7eb;
      padding:6px 10px;
      font-size:13px;
      margin-right:8px;
    }
    canvas{
      background:#020617;
      border-radius:16px;
      padding:8px;
    }
    .grid{
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,0.8fr);
      gap:16px;
      margin-top:16px;
    }
    @media(max-width:768px){
      .grid{grid-template-columns: minmax(0,1fr);}
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:10px;
    }
    th,td{
      border-bottom:1px solid rgba(55,65,81,0.9);
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    th{color:#cbd5f5;}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Hero Health — Teacher Dashboard</h1>
    <div class="muted">
      อัปโหลดไฟล์ CSV แบบย่อจากเกม แล้วเลือกชั้น/ห้อง เพื่อดูสัดส่วน Rank ของเด็กแต่ละกลุ่ม
    </div>

    <div class="panel">
      <div style="margin-bottom:8px;font-size:13px;">
        1) เปิดหน้าเกม Hero Health → จบรอบ → กด <b>“ดาวน์โหลด CSV → แบบย่อ (สำหรับครู)”</b><br/>
        2) นำไฟล์ที่ได้มาอัปโหลดที่นี่
      </div>
      <input id="fileInput" type="file" accept=".csv"/>
      <label>ชั้น (Grade):
        <select id="gradeSelect">
          <option value="">ทั้งหมด</option>
        </select>
      </label>
      <label>ห้อง (Room):
        <select id="roomSelect">
          <option value="">ทั้งหมด</option>
        </select>
      </label>
    </div>

    <div class="grid">
      <div class="panel">
        <h3 style="margin:0 0 6px;font-size:15px;">กราฟแท่ง: จำนวนเด็กแต่ละ Rank</h3>
        <div class="muted" style="margin-bottom:6px;font-size:12px;">
          ใช้ดูว่าภาพรวมในชั้น/ห้องนี้ อยู่ในระดับ Healthy God / Super Fit / Active Hero / Rookie / Sleepy เท่าไหร่
        </div>
        <canvas id="barChart" height="220"></canvas>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 6px;font-size:15px;">กราฟโดนัท: สัดส่วน Rank</h3>
        <div class="muted" style="margin-bottom:6px;font-size:12px;">
          เปอร์เซ็นต์ของเด็กแต่ละ Rank ในกลุ่มที่เลือก
        </div>
        <canvas id="pieChart" height="220"></canvas>
      </div>
    </div>

    <div class="panel" style="margin-top:18px;">
      <h3 style="margin:0 0 6px;font-size:15px;">ข้อมูลล่าสุด (top 10)</h3>
      <table id="summaryTable">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>ชั้น</th>
            <th>ห้อง</th>
            <th>โหมด</th>
            <th>ระดับ</th>
            <th>Rank</th>
            <th>คะแนน</th>
            <th>Acc%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // โครงข้อมูลหลัง parse CSV (teacher)
    let teacherRows = []; // แต่ละแถว = object จาก CSV
    let barChart, pieChart;

    const RANK_ORDER = ['healthy-god','super-fit','active-hero','rookie','sleepy'];
    const RANK_LABEL = {
      'healthy-god': 'Healthy God',
      'super-fit': 'Super Fit',
      'active-hero': 'Active Hero',
      'rookie': 'Rookie',
      'sleepy': 'Sleepy Mode'
    };

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (!lines.length) return [];
      const header = lines[0].split(',');
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = splitCsvLine(lines[i]);
        if (!cols.length || cols.length < header.length) continue;
        const obj = {};
        for (let j = 0; j < header.length; j++) {
          obj[header[j]] = cols[j] != null ? cols[j] : '';
        }
        rows.push(obj);
      }
      return rows;
    }

    // split CSV แบบง่าย ๆ รองรับค่าใน ""
    function splitCsvLine(line) {
      const res = [];
      let cur = '';
      let inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"' ) {
          if (inQuote && line[i+1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuote = !inQuote;
          }
        } else if (ch === ',' && !inQuote) {
          res.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      res.push(cur);
      return res;
    }

    function initSelectors() {
      const grades = new Set();
      const rooms = new Set();
      teacherRows.forEach(r => {
        if (r.profile_grade) grades.add(r.profile_grade);
        if (r.profile_room) rooms.add(r.profile_room);
      });

      const gradeSel = document.getElementById('gradeSelect');
      const roomSel = document.getElementById('roomSelect');

      gradeSel.innerHTML = '<option value="">ทั้งหมด</option>';
      Array.from(grades).sort().forEach(g => {
        const op = document.createElement('option');
        op.value = g;
        op.textContent = g;
        gradeSel.appendChild(op);
      });

      roomSel.innerHTML = '<option value="">ทั้งหมด</option>';
      Array.from(rooms).sort().forEach(r => {
        const op = document.createElement('option');
        op.value = r;
        op.textContent = r;
        roomSel.appendChild(op);
      });

      gradeSel.onchange = updateDashboard;
      roomSel.onchange = updateDashboard;
    }

    function filterRows() {
      const grade = document.getElementById('gradeSelect').value || '';
      const room = document.getElementById('roomSelect').value || '';

      return teacherRows.filter(r => {
        if (grade && r.profile_grade !== grade) return false;
        if (room && r.profile_room !== room) return false;
        return true;
      });
    }

    function buildRankStats(rows) {
      const counts = {};
      RANK_ORDER.forEach(k => counts[k] = 0);
      rows.forEach(r => {
        const slug = (r.rank_slug || '').toLowerCase();
        if (counts.hasOwnProperty(slug)) counts[slug] += 1;
        else counts['sleepy'] += 1;
      });
      return counts;
    }

    function updateDashboard() {
      const rows = filterRows();
      const stats = buildRankStats(rows);

      // update table
      updateTable(rows);

      const labels = RANK_ORDER.map(k => RANK_LABEL[k]);
      const data = RANK_ORDER.map(k => stats[k]);

      // bar
      const barCtx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'จำนวนเด็ก',
            data
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });

      // pie
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            label: 'สัดส่วน Rank',
            data
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateTable(rows) {
      const tb = document.querySelector('#summaryTable tbody');
      tb.innerHTML = '';
      const sorted = rows.slice().sort((a,b) => (b.score - a.score));
      sorted.slice(0, 10).forEach(r => {
        const tr = document.createElement('tr');

        const rankSlug = (r.rank_slug || '').toLowerCase();
        const rankLabel = RANK_LABEL[rankSlug] || 'Sleepy Mode';

        tr.innerHTML = `
          <td>${(r.profile_name || '').replace(/^"|"$/g,'')}</td>
          <td>${r.profile_grade || ''}</td>
          <td>${r.profile_room || ''}</td>
          <td>${r.mode || ''}</td>
          <td>${r.diff || ''}</td>
          <td>
            <span class="pill" style="${rankColorStyle(rankSlug)}">
              ${rankLabel}
            </span>
          </td>
          <td>${r.score || 0}</td>
          <td>${r.accuracy || ''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function rankColorStyle(slug) {
      switch (slug) {
        case 'healthy-god':
          return 'background:rgba(56,189,248,0.2);color:#bfdbfe;';
        case 'super-fit':
          return 'background:rgba(34,197,94,0.2);color:#bbf7d0;';
        case 'active-hero':
          return 'background:rgba(234,179,8,0.2);color:#facc15;';
        case 'rookie':
          return 'background:rgba(59,130,246,0.15);color:#bfdbfe;';
        case 'sleepy':
        default:
          return 'background:rgba(75,85,99,0.4);color:#e5e7eb;';
      }
    }

    document.getElementById('fileInput').addEventListener('change', function (ev) {
      const file = ev.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          teacherRows = parseCsv(e.target.result || '');
          if (!teacherRows.length) {
            alert('อ่านไฟล์ไม่สำเร็จ หรือไม่มีข้อมูล');
            return;
          }
          initSelectors();
          updateDashboard();
        } catch (err) {
          console.error(err);
          alert('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV');
        }
      };
      reader.readAsText(file, 'utf-8');
    });
  </script>
</body>
</html>
