// Nutrition VR ‚Äî Easy Mode (P.5)
// - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ ‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ + ‡∏™‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£
// - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‚Üí ‡∏Å‡∏î Finish ‚Üí ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏≤‡∏ß + ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏¥‡πâ‡∏° + ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
// - ‡πÄ‡∏•‡πà‡∏ô‡∏á‡πà‡∏≤‡∏¢: ‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≠‡∏á (fuse 1200ms) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î OK

//////////////////////
// Analytics (‡πÄ‡∏ö‡∏≤) //
//////////////////////
const GAME_ID = "Nutrition-Easy";
function track(eventName, props = {}) {
  try { if (window.plausible) window.plausible(eventName, { props: { game: GAME_ID, ...props } }); } catch(e){}
}

//////////////////////
// DOM Refs & HUD   //
//////////////////////
const $ = id => document.getElementById(id);
const shelfRoot = $('shelfRoot');
const plateRoot = $('plateRoot');
const hudLine1 = $('hudLine1');
const hudLine2 = $('hudLine2');
const modeBadge = $('modeBadge');
const goalBadge = $('goalBadge');

const BTN = {
  start: $('btnStart'),
  finish: $('btnFinish'),
  reset: $('btnReset'),
  learning: $('btnLearning'),
  challenge: $('btnChallenge')
};

//////////////////////
// Easy Game Config //
//////////////////////
let MODE = 'Learning'; // Learning | Challenge
const GOAL_COUNT = 4;

// ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (6‚Äì8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å
// ‡∏´‡∏°‡∏ß‡∏î: grain, protein, veggie, fruit, dairy, healthy, caution
const MENU = [
  { id:'g01', name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢',         cat:'grain',  kcal:200, emoji:'üçö', color:'#60a5fa' },
  { id:'p01', name:'‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á',         cat:'protein',kcal:165, emoji:'üçó', color:'#f59e0b' },
  { id:'v01', name:'‡∏ú‡∏±‡∏î‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°',       cat:'veggie', kcal:150, emoji:'ü•ó', color:'#22c55e' },
  { id:'f01', name:'‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°',       cat:'fruit',  kcal:90,  emoji:'üçé', color:'#84cc16' },
  { id:'d01', name:'‡∏ô‡∏°‡∏à‡∏∑‡∏î',          cat:'dairy',  kcal:130, emoji:'ü•õ', color:'#a78bfa' },
  { id:'h01', name:'‡∏ã‡∏∏‡∏õ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡πÉ‡∏™',    cat:'healthy',kcal:110, emoji:'üç≤', color:'#2dd4bf' },
  { id:'c01', name:'‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î',         cat:'caution',kcal:260, emoji:'üçü', color:'#ef4444' },
  { id:'s01', name:'‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô',        cat:'caution',kcal:240, emoji:'üç∞', color:'#ef4444' }
];

let selected = []; // [{id,name,cat,kcal,emoji,color,qty}]

//////////////////////
// Utilities        //
//////////////////////
function clearEntity(root){ while(root.firstChild) root.removeChild(root.firstChild); }
function fmt(n){ return Math.round(n*10)/10; }

//////////////////////
// Render Shelf     //
//////////////////////
function renderShelf(){
  clearEntity(shelfRoot);

  // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå
  const backdrop = document.createElement('a-plane');
  backdrop.setAttribute('width','2.6');
  backdrop.setAttribute('height','1.6');
  backdrop.setAttribute('color','#0a0f1a');
  backdrop.setAttribute('position','0 0 -0.02');
  backdrop.setAttribute('material','shader: flat; opacity: 0.95');
  shelfRoot.appendChild(backdrop);

  // ‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á
  const shelf = document.createElement('a-box');
  shelf.setAttribute('width','2.4'); shelf.setAttribute('height','0.06'); shelf.setAttribute('depth','0.45');
  shelf.setAttribute('color','#0b1220'); shelf.setAttribute('position','0 -0.2 0');
  shelfRoot.appendChild(shelf);

  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÉ‡∏´‡∏ç‡πà/‡∏ä‡∏±‡∏î, ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î)
  const cols = 3, gapX = 0.75, gapY = 0.48;
  MENU.forEach((m, i)=>{
    const col = i % cols;
    const row = Math.floor(i / cols);
    const x = (col - (cols-1)/2) * gapX;
    const y = 0.55 - row * gapY;

    const card = document.createElement('a-entity');
    card.classList.add('clickable','food');
    card.setAttribute('geometry', 'primitive: plane; width: 0.68; height: 0.36');
    card.setAttribute('material', `color: ${m.color}; opacity: 0.25; shader: flat; transparent:true`);
    card.setAttribute('position', `${x} ${y} 0.01`);

    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
    const inner = document.createElement('a-plane');
    inner.setAttribute('width','0.64'); inner.setAttribute('height','0.32');
    inner.setAttribute('position','0 0 0.001');
    inner.setAttribute('color','#111827'); inner.setAttribute('opacity','0.98');
    inner.setAttribute('material','shader: flat; transparent:true');
    card.appendChild(inner);

    const emoji = document.createElement('a-entity');
    emoji.setAttribute('text', `value:${m.emoji}; width:2.2; align:center; color:#fff`);
    emoji.setAttribute('position','-0.20 0 0.002');
    card.appendChild(emoji);

    const label = document.createElement('a-entity');
    label.setAttribute('text', `value:${m.name}\n~${m.kcal} kcal; width:2.6; color:#F5F7FF; align:left; baseline:top`);
    label.setAttribute('position','-0.02 0.10 0.002');
    card.appendChild(label);

    // ‡∏Ñ‡∏•‡∏¥‡∏Å/‡∏ü‡∏¥‡∏ß‡∏™‡πå = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏à‡∏≤‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°)
    card.addEventListener('click', ()=> addItem(m));
    card.addEventListener('mouseenter', ()=> card.setAttribute('scale','1.05 1.05 1'));
    card.addEventListener('mouseleave', ()=> card.setAttribute('scale','1 1 1'));

    shelfRoot.appendChild(card);
  });

  // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
  const title = document.createElement('a-entity');
  title.setAttribute('text', 'value:‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á; width:5.2; color:#E8F0FF; align:center');
  title.setAttribute('position','0 0.95 0.01');
  shelfRoot.appendChild(title);
}

//////////////////////
// Render Plate     //
//////////////////////
function renderPlate(){
  clearEntity(plateRoot);

  const base = document.createElement('a-circle');
  base.setAttribute('radius','0.65'); base.setAttribute('color','#0b1220');
  base.setAttribute('rotation','-90 0 0'); base.setAttribute('position','0 -0.35 0');
  plateRoot.appendChild(base);

  const head = document.createElement('a-entity');
  head.setAttribute('text','value:‡∏à‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å); width:5.5; color:#E8F0FF; align:center');
  head.setAttribute('position','0 0.55 0.02');
  plateRoot.appendChild(head);

  const cols = 2, gapX = 0.5, gapY = 0.36;
  selected.forEach((p, i)=>{
    const col = i % cols;
    const row = Math.floor(i / cols);
    const x = (col - (cols-1)/2) * gapX;
    const y = 0.22 - row * gapY;

    const item = document.createElement('a-entity');
    item.classList.add('clickable','plate-item');
    item.setAttribute('geometry','primitive: plane; width: 0.58; height: 0.28');
    item.setAttribute('material','color:#0f172a; opacity:0.98; shader:flat; transparent:true');
    item.setAttribute('position', `${x} ${y} 0.02`);

    const emoji = document.createElement('a-entity');
    emoji.setAttribute('text', `value:${p.emoji}; width:2.2; align:center; color:#fff`);
    emoji.setAttribute('position','-0.20 0 0.002');
    item.appendChild(emoji);

    const txt = `${p.name} √ó${p.qty}`;
    const label = document.createElement('a-entity');
    label.setAttribute('text', `value:${txt}; width:2.6; color:#DDE7FF; align:left; baseline:top`);
    label.setAttribute('position','-0.06 0.08 0.002');
    item.appendChild(label);

    item.addEventListener('click', ()=> removeItem(p.id));
    item.addEventListener('mouseenter', ()=> item.setAttribute('scale','1.03 1.03 1'));
    item.addEventListener('mouseleave', ()=> item.setAttribute('scale','1 1 1'));
    plateRoot.appendChild(item);
  });
}

//////////////////////
// Add / Remove     //
//////////////////////
function addItem(m){
  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏ä‡∏¥‡πâ‡∏ô (‡πÅ‡∏ï‡πà HUD ‡∏ä‡∏ß‡∏ô‡πÉ‡∏´‡πâ 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)
  const totalCount = selected.reduce((a,b)=>a+b.qty,0);
  if (totalCount >= 6) { speakHUD("‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!", "‡∏•‡∏≠‡∏á‡∏Å‡∏î Finish ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏∞"); return; }

  const f = selected.find(x=>x.id===m.id);
  if (f){ if (f.qty >= 2) return; f.qty += 1; }
  else { selected.push({ ...m, qty:1 }); }

  renderPlate(); updateHUDProgress();
}
function removeItem(id){
  const idx = selected.findIndex(x=>x.id===id);
  if (idx>=0){
    if (selected[idx].qty>1) selected[idx].qty -= 1;
    else selected.splice(idx,1);
    renderPlate(); updateHUDProgress();
  }
}

//////////////////////
// HUD Helpers      //
//////////////////////
function speakHUD(line1, line2){
  hudLine1.textContent = line1;
  hudLine2.textContent = line2;
}
function updateHUDProgress(){
  const count = selected.reduce((a,b)=>a+b.qty,0);
  const cats = new Set();
  selected.forEach(s=>cats.add(s.cat));
  const needed = Math.max(0, GOAL_COUNT - count);

  const checkIcons = categoryHints(cats);
  speakHUD(
    `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${count} ‡∏ä‡∏¥‡πâ‡∏ô\n${checkIcons}`,
    needed>0 ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${needed} ‡∏ä‡∏¥‡πâ‡∏ô` : `‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î Finish ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`
  );
}
function categoryHints(catSet){
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å/‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å
  const need = ['grain','protein','veggie','fruit'];
  const mapLabel = {grain:'‡∏ò‡∏±‡∏ç‡∏û‡∏∑‡∏ä', protein:'‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', veggie:'‡∏ú‡∏±‡∏Å', fruit:'‡∏ú‡∏•‡πÑ‡∏°‡πâ'};
  return need.map(k => catSet.has(k) ? `‚úÖ ${mapLabel[k]}` : `‚¨ú ${mapLabel[k]}`).join('  ');
}

//////////////////////
// Scoring (Easy)   //
//////////////////////
// 3 ‡∏î‡∏≤‡∏ß: ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å + ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏ß‡∏° ~350‚Äì650 + ‡πÑ‡∏°‡πà‡∏°‡∏µ caution ‡πÄ‡∏Å‡∏¥‡∏ô 1
// 2 ‡∏î‡∏≤‡∏ß: ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏´‡∏°‡∏ß‡∏î + ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà 300‚Äì800 + caution ‚â§1
// 1 ‡∏î‡∏≤‡∏ß: ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô
function scorePlate(){
  const totalKcal = selected.reduce((a,b)=>a + b.kcal*b.qty, 0);
  const counts = {grain:0,protein:0,veggie:0,fruit:0,dairy:0,healthy:0,caution:0};
  selected.forEach(s=>{ counts[s.cat] = (counts[s.cat]||0) + s.qty; });

  const has4 = ['grain','protein','veggie','fruit'].every(k=>counts[k]>0);
  const has3 = ['grain','protein','veggie','fruit'].filter(k=>counts[k]>0).length >= 3;

  let stars = 1, face='üòê', msg='‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏î‡∏π‡∏ô‡∏∞';
  if (has4 && totalKcal>=350 && totalKcal<=650 && counts.caution<=1){ stars=3; face='üòä'; msg='‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏°‡∏≤‡∏Å'; }
  else if (has3 && totalKcal>=300 && totalKcal<=800 && counts.caution<=1){ stars=2; face='üôÇ'; msg='‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î'; }
  else { stars=1; face='üòê'; msg='‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î/‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ'; }

  return { stars, face, msg, totalKcal, counts };
}

function showResult(){
  const {stars, face, msg, totalKcal, counts} = scorePlate();
  const starStr = '‚≠ê'.repeat(stars) + (stars<3 ? '‚òÜ'.repeat(3-stars) : '');
  const summary =
    `${face}  ${starStr}\n` +
    `${msg}\n` +
    `‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° ‚âà ${Math.round(totalKcal)} kcal`;

  // ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£
  const needList = ['grain','protein','veggie','fruit'].filter(k=>!counts[k]);
  const mapLabel = {grain:'‡∏ò‡∏±‡∏ç‡∏û‡∏∑‡∏ä', protein:'‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', veggie:'‡∏ú‡∏±‡∏Å', fruit:'‡∏ú‡∏•‡πÑ‡∏°‡πâ'};
  const hint = needList.length ? `‡∏Ç‡∏≤‡∏î: ${needList.map(k=>mapLabel[k]).join(', ')}` : '‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß';

  speakHUD(summary, hint);
}

//////////////////////
// Flow Control     //
//////////////////////
function startGame(){
  selected = [];
  renderShelf();
  renderPlate();
  speakHUD("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∞!", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
  track('GameStart', { mode: MODE });
}
function finishGame(){
  showResult();
  track('GameFinish', { mode: MODE, count: selected.reduce((a,b)=>a+b.qty,0) });
}
function resetGame(){
  selected = [];
  renderPlate();
  updateHUDProgress();
  track('Reset', {});
}

BTN.start.onclick = startGame;
BTN.finish.onclick = finishGame;
BTN.reset.onclick = resetGame;

BTN.learning.onclick = ()=>{ MODE='Learning'; modeBadge.textContent='Learning'; track('Mode', {mode:MODE}); };
BTN.challenge.onclick= ()=>{ MODE='Challenge'; modeBadge.textContent='Challenge'; track('Mode', {mode:MODE}); };

// Boot once
startGame();
