<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO Training Protocol ‚Äî Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Core ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <style>
    .grid{max-width:1040px;margin:84px auto 40px;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .card{background:rgba(14,20,36,.85);border:1px solid #112848;border-radius:12px;padding:14px}
    .card h3{margin:.2rem 0 .6rem 0}
    .row{display:flex;gap:8px;align-items:center;margin:.35rem 0}
    select,input[type="number"],input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #1a315a;background:#0b1325;color:#e6f2ff}
    .muted{color:#7f8ea3;font-size:12px}
    .btn.wide{width:100%;text-align:center}
    .hint{font-size:12px;color:#a7c5ff;margin-top:6px}
    label{min-width:94px}
    .xpbar{height:8px;border-radius:6px;background:#0b1325;border:1px solid #1a315a;overflow:hidden}
    .xpbar>div{height:100%}
    header.hud .box.right{gap:8px}
    .lang{display:flex;align-items:center;gap:6px}
    .lang select{padding:6px 8px;border-radius:8px;border:1px solid #1a315a;background:#0b1325;color:#e6f2ff}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="hud">
    <div class="box"><strong id="txtTitle">EXO TRAINING PROTOCOL</strong></div>
    <div class="box right">
      <div class="lang">
        <span class="muted" id="txtLang">Language</span>
        <select id="langSel" aria-label="Language">
          <option value="th">‡πÑ‡∏ó‡∏¢</option>
          <option value="en">English</option>
        </select>
      </div>
      <!-- ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /shadow-breaker/ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index -->
      <a class="btn" href="leaderboard.html" id="btnLeaderboard">üèÜ Leaderboard</a>
      <a class="btn" href="vs.html" id="btnVS">‚öî VS</a>
      <a class="btn" href="settings.html" id="btnSettings">‚öô Settings</a>
    </div>
  </header>

  <main class="grid">
    <!-- Dashboard -->
    <section class="card" id="cardDashboard">
      <h3 id="dashTitle">Dashboard</h3>
      <div class="row"><div class="muted" id="lblRank">Rank</div><div id="rank" style="margin-left:auto;font-weight:700">-</div></div>
      <div class="row"><div class="muted" id="lblLevel">Level</div><div id="level" style="margin-left:auto;font-weight:700">1</div></div>
      <div class="xpbar"><div id="xpbar" style="width:0%; background:#3B82F6;"></div></div>
      <div class="row"><div class="muted" id="lblSess">Sessions</div><div id="sess" style="margin-left:auto">0</div></div>
      <div class="row"><div class="muted" id="lblTotalTime">Total Time</div><div id="ttime" style="margin-left:auto">0s</div></div>
      <div class="row"><div class="muted" id="lblTotalScore">Total Score</div><div id="tscore" style="margin-left:auto">0</div></div>
      <div class="row"><div class="muted" id="lblAvgScore">Avg Score</div><div id="avg" style="margin-left:auto">0</div></div>
      <div class="hint" id="lblRecent">Recent Sessions (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</div>
      <ul id="recent" style="margin:.4rem 0 0 1rem; padding:0; list-style:disc; font-size:12px;"></ul>
    </section>

    <!-- Workout Programs -->
    <section class="card" id="cardProg">
      <h3 id="progTitle">Workout Program</h3>
      <p class="muted" id="progDesc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ù‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏Å‡∏°</p>
      <div class="row">
        <label id="lblProgram">Program</label>
        <select id="progSel">
          <option value="quick" data-i18n="prog.quick">Quick Sweat (‚âà6 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
          <option value="rhythm" data-i18n="prog.rhythm">Rhythm Focus</option>
          <option value="lower" data-i18n="prog.lower">Lower Body Power</option>
        </select>
      </div>
      <div class="row"><button id="btnProg" class="btn wide">‚ñ∂ <span id="btnProgTxt">Start Program</span></button></div>
      <div class="hint" id="progHint">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Å‡∏° ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
    </section>

    <!-- Combat Reflex (‡πÄ‡∏Å‡∏° 1) -->
    <section class="card" id="cardCombat">
      <h3 id="combatTitle">Combat Reflex</h3>
      <p class="muted" id="combatDesc">‡πÄ‡∏Å‡∏° 1 ‚Äî ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Hit Line</p>
      <div class="row"><label id="lblDiff1">Difficulty</label>
        <select id="combatDiff">
          <option value="easy" data-i18n="diff.easy">easy</option>
          <option value="normal" selected data-i18n="diff.normal">normal</option>
          <option value="hard" data-i18n="diff.hard">hard</option>
        </select>
      </div>
      <div class="row"><label id="lblTime1">Time (s)</label><input id="combatTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row">
        <label id="lblItems1">Items</label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="combatItemTime" type="checkbox">
          <span class="muted" id="lblTimeOrb">Time Orb (+‡πÄ‡∏ß‡∏•‡∏≤)</span>
        </label>
      </div>
      <div class="row"><button id="btnCombat" class="btn wide">‚ñ∂ <span id="btnCombatTxt">Play Combat Reflex</span></button></div>
    </section>

    <!-- Rhythm Sync (‡πÄ‡∏Å‡∏° 2) -->
    <section class="card" id="cardRhythm">
      <h3 id="rhythmTitle">Rhythm Sync</h3>
      <p class="muted" id="rhythmDesc">‡πÄ‡∏Å‡∏° 2 ‚Äî ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ BPM + Chart (‡∏à‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï‡∏´‡∏°‡∏î)</p>
      <div class="row"><label id="lblDiff2">Difficulty</label>
        <select id="rhythmDiff">
          <option value="easy" data-i18n="diff.easy">easy</option>
          <option value="normal" selected data-i18n="diff.normal">normal</option>
          <option value="hard" data-i18n="diff.hard">hard</option>
        </select>
      </div>
      <div class="row"><label id="lblBpm">BPM</label><input id="rhythmBpm" type="number" value="110" min="60" max="220" step="1"></div>
      <div class="row">
        <label id="lblChart">Chart</label>
        <select id="chartPreset">
          <option value="">{default by diff}</option>
          <option value="../rhythm-rider/charts/easy.json">charts/easy.json</option>
          <option value="../rhythm-rider/charts/normal.json">charts/normal.json</option>
          <option value="../rhythm-rider/charts/hard.json">charts/hard.json</option>
          <option value="../rhythm-rider/charts/sprint.json">charts/sprint.json</option>
          <option value="../rhythm-rider/charts/crossfire.json">charts/crossfire.json</option>
          <option value="../rhythm-rider/charts/marathon.json">charts/marathon.json</option>
          <option value="__custom__" data-i18n="chart.custom">Custom URL‚Ä¶</option>
        </select>
      </div>
      <div class="row" id="customWrap" style="display:none"><label id="lblUrl">URL</label><input id="chartUrl" type="text" placeholder="https://your.host/chart.json"></div>
      <div class="hint" id="rhythmHint">Tip: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ ?music=assets/track.ogg</div>
      <div class="row"><button id="btnRhythm" class="btn wide">‚ñ∂ <span id="btnRhythmTxt">Play Rhythm Sync</span></button></div>
    </section>

    <!-- Mobility Dash (‡πÄ‡∏Å‡∏° 3) -->
    <section class="card" id="cardDashMobility">
      <h3 id="dashGameTitle">Mobility Dash</h3>
      <p class="muted" id="dashGameDesc">‡πÄ‡∏Å‡∏° 3 ‚Äî ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏ô‡∏´‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</p>
      <div class="row"><label id="lblDiff3">Difficulty</label>
        <select id="dashDiff">
          <option value="easy" data-i18n="diff.easy">easy</option>
          <option value="normal" selected data-i18n="diff.normal">normal</option>
          <option value="hard" data-i18n="diff.hard">hard</option>
        </select>
      </div>
      <div class="row"><label id="lblTime3">Time (s)</label><input id="dashTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row"><button id="btnDash" class="btn wide">‚ñ∂ <span id="btnDashTxt">Play Mobility Dash</span></button></div>
    </section>

    <!-- Power Control (‡πÄ‡∏Å‡∏° 4) -->
    <section class="card" id="cardPower">
      <h3 id="powerTitle">Power Control</h3>
      <p class="muted" id="powerDesc">‡πÄ‡∏Å‡∏° 4 ‚Äî ‡∏¢‡πà‡∏≠/‡∏¢‡∏∑‡∏ô ‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</p>
      <div class="row"><label id="lblDiff4">Difficulty</label>
        <select id="powerDiff">
          <option value="easy" data-i18n="diff.easy">easy</option>
          <option value="normal" selected data-i18n="diff.normal">normal</option>
          <option value="hard" data-i18n="diff.hard">hard</option>
        </select>
      </div>
      <div class="row"><label id="lblTime4">Time (s)</label><input id="powerTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row"><button id="btnPower" class="btn wide">‚ñ∂ <span id="btnPowerTxt">Play Power Control</span></button></div>
    </section>
  </main>

  <!-- Core scripts -->
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
  <script src="../core/exo-settings.js"></script>

  <script>
    /* -------- i18n (TH/EN) -------- */
    const I18N = {
      th: { title:"EXO TRAINING PROTOCOL", language:"‡∏†‡∏≤‡∏©‡∏≤",
        leaderboard:"üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö", vs:"‚öî ‡πÇ‡∏´‡∏°‡∏î VS", settings:"‚öô ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        dashTitle:"‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î", rank:"‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö", level:"‡πÄ‡∏•‡πÄ‡∏ß‡∏•", sessions:"‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô",
        totalTime:"‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°", totalScore:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°", avgScore:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢",
        recent:"‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):",
        progTitle:"‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ù‡∏∂‡∏Å", progDesc:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ù‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏Å‡∏°",
        program:"‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°", progStart:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°",
        progHint:"‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Å‡∏° ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
        prog:{quick:"Quick Sweat (‚âà6 ‡∏ô‡∏≤‡∏ó‡∏µ)", rhythm:"Rhythm Focus", lower:"Lower Body Power"},
        diff:{easy:"‡∏á‡πà‡∏≤‡∏¢", normal:"‡∏õ‡∏Å‡∏ï‡∏¥", hard:"‡∏¢‡∏≤‡∏Å"},
        combatTitle:"Combat Reflex", combatDesc:"‡πÄ‡∏Å‡∏° 1 ‚Äî ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡πâ‡∏ô", playCombat:"‡πÄ‡∏£‡∏¥‡πà‡∏° Combat Reflex",
        rhythmTitle:"Rhythm Sync", rhythmDesc:"‡πÄ‡∏Å‡∏° 2 ‚Äî ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ (‡∏à‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï‡∏´‡∏°‡∏î)", playRhythm:"‡πÄ‡∏£‡∏¥‡πà‡∏° Rhythm Sync",
        dashGameTitle:"Mobility Dash", dashGameDesc:"‡πÄ‡∏Å‡∏° 3 ‚Äî ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏ô‡∏´‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á", playDash:"‡πÄ‡∏£‡∏¥‡πà‡∏° Mobility Dash",
        powerTitle:"Power Control", powerDesc:"‡πÄ‡∏Å‡∏° 4 ‚Äî ‡∏¢‡πà‡∏≠/‡∏¢‡∏∑‡∏ô ‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô", playPower:"‡πÄ‡∏£‡∏¥‡πà‡∏° Power Control",
        difficulty:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å", timeS:"‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", items:"‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°", timeOrb:"Time Orb (+‡πÄ‡∏ß‡∏•‡∏≤)",
        bpm:"BPM", chart:"‡∏ä‡∏≤‡∏£‡πå‡∏ï", custom:"‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡πÄ‡∏≠‡∏á‚Ä¶", url:"URL",
        tipMusic:"‡∏ó‡∏¥‡∏õ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ ?music=assets/track.ogg"
      },
      en: { title:"EXO TRAINING PROTOCOL", language:"Language",
        leaderboard:"üèÜ Leaderboard", vs:"‚öî VS", settings:"‚öô Settings",
        dashTitle:"Dashboard", rank:"Rank", level:"Level", sessions:"Sessions",
        totalTime:"Total Time", totalScore:"Total Score", avgScore:"Avg Score",
        recent:"Recent Sessions (last 5):",
        progTitle:"Workout Program", progDesc:"Pick a program; games will chain automatically.",
        program:"Program", progStart:"Start Program",
        progHint:"Between games, it auto-continues to the next.",
        prog:{quick:"Quick Sweat (‚âà6 min)", rhythm:"Rhythm Focus", lower:"Lower Body Power"},
        diff:{easy:"easy", normal:"normal", hard:"hard"},
        combatTitle:"Combat Reflex", combatDesc:"Game 1 ‚Äî Fast reaction, hit on the line", playCombat:"Play Combat Reflex",
        rhythmTitle:"Rhythm Sync", rhythmDesc:"Game 2 ‚Äî Follow BPM + Chart (ends when notes finish)", playRhythm:"Play Rhythm Sync",
        dashGameTitle:"Mobility Dash", dashGameDesc:"Game 3 ‚Äî Lane-switch obstacle dodge", playDash:"Play Mobility Dash",
        powerTitle:"Power Control", powerDesc:"Game 4 ‚Äî Squat/Stand through rings", playPower:"Play Power Control",
        difficulty:"Difficulty", timeS:"Time (s)", items:"Items", timeOrb:"Time Orb (+time)",
        bpm:"BPM", chart:"Chart", custom:"Custom URL‚Ä¶", url:"URL",
        tipMusic:"Tip: add music via ?music=assets/track.ogg"
      }
    };

    const $ = (id)=> document.getElementById(id);
    function getLang(){
      const q = new URLSearchParams(location.search);
      const urlLang = q.get('lang');
      const saved = (window.EXO && EXO.store && EXO.store.get('EXO_LANG')) || null;
      return (urlLang || saved || 'th');
    }
    function setLang(lang){
      try{ window.EXO && EXO.store && EXO.store.set('EXO_LANG', lang); }catch(e){}
      document.documentElement.lang = lang;
      const L = I18N[lang] || I18N.th;
      $('txtTitle').textContent = L.title; $('txtLang').textContent  = L.language;
      $('btnLeaderboard').textContent = L.leaderboard; $('btnVS').textContent = L.vs; $('btnSettings').textContent = L.settings;
      $('dashTitle').textContent = L.dashTitle; $('lblRank').textContent = L.rank; $('lblLevel').textContent = L.level;
      $('lblSess').textContent = L.sessions; $('lblTotalTime').textContent = L.totalTime; $('lblTotalScore').textContent = L.totalScore; $('lblAvgScore').textContent = L.avgScore;
      $('lblRecent').textContent = L.recent;

      $('progTitle').textContent = L.progTitle; $('progDesc').textContent  = L.progDesc; $('lblProgram').textContent = L.program;
      $('btnProgTxt').textContent = L.progStart; $('progHint').textContent = L.progHint;
      [...$('progSel').options].forEach(opt=>{ const key = opt.value; if (L.prog[key]) opt.textContent = L.prog[key]; });

      $('combatTitle').textContent = L.combatTitle; $('combatDesc').textContent  = L.combatDesc;
      $('lblDiff1').textContent = L.difficulty; $('lblTime1').textContent = L.timeS; $('lblItems1').textContent = L.items; $('lblTimeOrb').textContent = L.timeOrb;
      $('btnCombatTxt').textContent = L.playCombat;

      $('rhythmTitle').textContent = L.rhythmTitle; $('rhythmDesc').textContent  = L.rhythmDesc;
      $('lblDiff2').textContent = L.difficulty; $('lblBpm').textContent = L.bpm; $('lblChart').textContent = L.chart; $('lblUrl').textContent = L.url;
      $('rhythmHint').textContent = L.tipMusic; $('btnRhythmTxt').textContent = L.playRhythm;
      const preset = $('chartPreset'); if (preset) { [...preset.options].forEach(o=>{ if (o.value==='__custom__') o.textContent=L.custom; }); }

      [['combatDiff'],['rhythmDiff'],['dashDiff'],['powerDiff']].forEach(([selId])=>{
        const sel=$(selId); if(sel){ [...sel.options].forEach(o=>{ const v=o.value; if(L.diff[v]) o.textContent=L.diff[v]; }); }
      });

      $('dashGameTitle').textContent = L.dashGameTitle; $('dashGameDesc').textContent  = L.dashGameDesc;
      $('lblDiff3').textContent = L.difficulty; $('lblTime3').textContent = L.timeS; $('btnDashTxt').textContent = L.playDash;

      $('powerTitle').textContent = L.powerTitle; $('powerDesc').textContent  = L.powerDesc;
      $('lblDiff4').textContent = L.difficulty; $('lblTime4').textContent = L.timeS; $('btnPowerTxt').textContent = L.playPower;

      const sel = $('langSel'); if(sel) sel.value = lang;
    }

    document.addEventListener('DOMContentLoaded', ()=> {
      // init language
      const curr = getLang(); setLang(curr);
      $('langSel').addEventListener('change', (e)=>{
        const lang = e.target.value || 'th'; setLang(lang);
        const url = new URL(location.href); url.searchParams.set('lang', lang); history.replaceState({}, '', url.toString());
      });

      // Dashboard
      function fmtSec(s){ const m=Math.floor(s/60), r=s%60; return (m? m+'m ':'')+r+'s'; }
      function refreshDash(){
        try{
          const d = (window.EXO_METRICS && EXO_METRICS.dashboard) ? EXO_METRICS.dashboard() : {
            profile: {rank:'-', level:1, xp:0},
            totals: {sessions:0, time:0, score:0, avgScore:0},
            recent:[]
          };
          $('rank').textContent  = d.profile.rank || '-';
          $('level').textContent = d.profile.level;
          const need = d.profile.level*500;
          const pct = Math.min(100, Math.round(((d.profile.xp||0)/need)*100));
          $('xpbar').style.width = pct+'%';
          $('sess').textContent  = d.totals.sessions||0;
          $('ttime').textContent = fmtSec((d.totals.time|0));
          $('tscore').textContent= d.totals.score|0;
          $('avg').textContent   = d.totals.avgScore|0;
          const recent = $('recent'); recent.innerHTML='';
          (d.recent||[]).slice(0,5).forEach(s=>{
            const li=document.createElement('li');
            const dt=new Date(s.t||Date.now()).toLocaleString();
            const acc = (s.accuracy!=null)? Math.round((s.accuracy)*10)/10 : 0;
            li.textContent = `[${dt}] ${s.module||'?'} (${s.diff||'-'}) ‚Äî Score ${s.score||0}, Acc ${acc}%`;
            recent.appendChild(li);
          });
        }catch(e){}
      }
      refreshDash();

      // Workout Program ‚Üí program.html (‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
      const programs = {
        quick: [
          '../shadow-breaker/play.html?diff=normal&time=60',  // Combat
          '../cardio-sprint/play.html?diff=normal&time=60',   // Dash
          '../rhythm-rider/play.html?diff=normal&bpm=110&chart=../rhythm-rider/charts/normal.json',
          '../sky-squats/play.html?diff=normal&time=60'       // Power
        ],
        rhythm: [
          '../rhythm-rider/play.html?diff=easy&bpm=100&chart=../rhythm-rider/charts/easy.json',
          '../rhythm-rider/play.html?diff=normal&bpm=120&chart=../rhythm-rider/charts/normal.json',
          '../rhythm-rider/play.html?diff=hard&bpm=135&chart=../rhythm-rider/charts/hard.json'
        ],
        lower: [
          '../sky-squats/play.html?diff=easy&time=45',
          '../sky-squats/play.html?diff=normal&time=60',
          '../cardio-sprint/play.html?diff=normal&time=60'
        ]
      };

      const btnProg = $('btnProg');
      btnProg && (btnProg.onclick = () => {
        const key = $('progSel').value;
        const plan = programs[key] || programs.quick;
        (window.EXO && EXO.store) && EXO.store.set('EXO_PLAN', {idx:0, paths:plan});
        location.href = plan[0] + '&next=program.html';
      });

      // Rhythm card (‡πÄ‡∏Å‡∏° 2)
      const preset = $('chartPreset'), customWrap = $('customWrap'), chartUrl = $('chartUrl');
      preset && preset.addEventListener('change', ()=>{ if(customWrap) customWrap.style.display = (preset.value==='__custom__') ? 'flex':'none'; });
      const btnRhythm = $('btnRhythm');
      btnRhythm && (btnRhythm.onclick = () => {
        const diff = $('rhythmDiff').value;
        const bpm  = Math.max(60, Math.min(220, parseInt(($('rhythmBpm').value||'110'),10)));
        let url = '../rhythm-rider/play.html?diff='+encodeURIComponent(diff)+'&bpm='+encodeURIComponent(bpm);
        const p = preset?.value;
        if (p){
          url += '&chart=' + encodeURIComponent(p==='__custom__' ? (chartUrl?.value||'').trim() : p);
        }
        location.href = url;
      });

      // Combat card (‡πÄ‡∏Å‡∏° 1)
      const btnCombat = $('btnCombat');
      btnCombat && (btnCombat.onclick = () => {
        const diff = $('combatDiff').value;
        const t = Math.max(10, Math.min(600, parseInt(($('combatTime').value||'60'),10)));
        let url = `../shadow-breaker/play.html?diff=${encodeURIComponent(diff)}&time=${t}`;
        const itemTime = $('combatItemTime')?.checked;
        if (itemTime) url += '&timeorb=1&timegain=1';
        location.href = url;
      });

      // Dash card (‡πÄ‡∏Å‡∏° 3)
      const btnDash = $('btnDash');
      btnDash && (btnDash.onclick = () => {
        const diff = $('dashDiff').value;
        const t = Math.max(10, Math.min(600, parseInt(($('dashTime').value||'60'),10)));
        location.href = `../cardio-sprint/play.html?diff=${encodeURIComponent(diff)}&time=${t}`;
      });

      // Power card (‡πÄ‡∏Å‡∏° 4)
      const btnPower = $('btnPower');
      btnPower && (btnPower.onclick = () => {
        const diff = $('powerDiff').value;
        const t = Math.max(10, Math.min(600, parseInt(($('powerTime').value||'60'),10)));
        location.href = `../sky-squats/play.html?diff=${encodeURIComponent(diff)}&time=${t}`;
      });
    });
  </script>

  <p style="text-align:center;color:#6d7a8a;font-size:12px;margin-top:10px;">
    Prototype WebXR Fitness System ‚Äì EXO Training Protocol
  </p>
</body>
</html>
