<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO Training Protocol ‚Äî Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="core/exo-ui.css">
  <style>
    .grid{max-width:1040px;margin:84px auto 40px;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .card{background:rgba(14,20,36,.85);border:1px solid #112848;border-radius:12px;padding:14px}
    .card h3{margin:.2rem 0 .6rem 0}
    .row{display:flex;gap:8px;align-items:center;margin:.35rem 0}
    select,input[type="number"],input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #1a315a;background:#0b1325;color:#e6f2ff}
    .muted{color:#7f8ea3;font-size:12px}
    .btn.wide{width:100%;text-align:center}
    .hint{font-size:12px;color:#a7c5ff;margin-top:6px}
    label{min-width:94px}
    .xpbar{height:8px;border-radius:6px;background:#0b1325;border:1px solid #1a315a;overflow:hidden}
    .xpbar>div{height:100%}
    header.hud .box.right{gap:8px}
  </style>
</head>
<body>
  <!-- Header ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° Settings -->
  <header class="hud">
    <div class="box"><strong>EXO TRAINING PROTOCOL</strong></div>
    <div class="box right">
      <a class="btn" href="leaderboard.html">üèÜ Leaderboard</a>
      <a class="btn" href="vs.html">‚öî VS</a>
      <a class="btn" href="settings.html">‚öô Settings</a>
    </div>
  </header>

  <main class="grid">
    <!-- Dashboard -->
    <section class="card" id="cardDashboard">
      <h3>Dashboard</h3>
      <div class="row"><div class="muted">Rank</div><div id="rank" style="margin-left:auto;font-weight:700">-</div></div>
      <div class="row"><div class="muted">Level</div><div id="level" style="margin-left:auto;font-weight:700">1</div></div>
      <div class="xpbar"><div id="xpbar" style="width:0%; background:#3B82F6;"></div></div>
      <div class="row"><div class="muted">Sessions</div><div id="sess" style="margin-left:auto">0</div></div>
      <div class="row"><div class="muted">Total Time</div><div id="ttime" style="margin-left:auto">0s</div></div>
      <div class="row"><div class="muted">Total Score</div><div id="tscore" style="margin-left:auto">0</div></div>
      <div class="row"><div class="muted">Avg Score</div><div id="avg" style="margin-left:auto">0</div></div>
      <div class="hint">Recent Sessions (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</div>
      <ul id="recent" style="margin:.4rem 0 0 1rem; padding:0; list-style:disc; font-size:12px;"></ul>
    </section>

    <!-- Workout Programs -->
    <section class="card" id="cardProg">
      <h3>Workout Program</h3>
      <p class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ù‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏Å‡∏°</p>
      <div class="row">
        <label>Program</label>
        <select id="progSel">
          <option value="quick">Quick Sweat (‚âà6 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
          <option value="rhythm">Rhythm Focus</option>
          <option value="lower">Lower Body Power</option>
        </select>
      </div>
      <div class="row"><button id="btnProg" class="btn wide">‚ñ∂ Start Program</button></div>
      <div class="hint">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Å‡∏° ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
    </section>

    <!-- Combat Reflex -->
    <section class="card" id="cardCombat">
      <h3>Combat Reflex</h3>
      <p class="muted">‡πÄ‡∏Å‡∏° 1 ‚Äî ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Hit Line</p>
      <div class="row"><label>Difficulty</label><select id="combatDiff"><option>easy</option><option selected>normal</option><option>hard</option></select></div>
      <div class="row"><label>Time (s)</label><input id="combatTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row"><button id="btnCombat" class="btn wide">‚ñ∂ Play Combat Reflex</button></div>
    </section>

    <!-- Rhythm Sync -->
    <section class="card" id="cardRhythm">
      <h3>Rhythm Sync</h3>
      <p class="muted">‡πÄ‡∏Å‡∏° 2 ‚Äî ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ BPM + Chart (‡∏à‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï‡∏´‡∏°‡∏î)</p>
      <div class="row"><label>Difficulty</label><select id="rhythmDiff"><option>easy</option><option selected>normal</option><option>hard</option></select></div>
      <div class="row"><label>BPM</label><input id="rhythmBpm" type="number" value="110" min="60" max="220" step="1"></div>
      <div class="row">
        <label>Chart</label>
        <select id="chartPreset">
          <option value="">(default by diff)</option>
          <option value="rhythm-rider/charts/easy.json">charts/easy.json</option>
          <option value="rhythm-rider/charts/normal.json">charts/normal.json</option>
          <option value="rhythm-rider/charts/hard.json">charts/hard.json</option>
          <option value="rhythm-rider/charts/sprint.json">charts/sprint.json</option>
          <option value="rhythm-rider/charts/crossfire.json">charts/crossfire.json</option>
          <option value="rhythm-rider/charts/marathon.json">charts/marathon.json</option>
          <option value="__custom__">Custom URL‚Ä¶</option>
        </select>
      </div>
      <div class="row" id="customWrap" style="display:none"><label>URL</label><input id="chartUrl" type="text" placeholder="https://your.host/chart.json"></div>
      <div class="hint">Tip: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ ?music=assets/track.ogg</div>
      <div class="row"><button id="btnRhythm" class="btn wide">‚ñ∂ Play Rhythm Sync</button></div>
    </section>

    <!-- Mobility Dash -->
    <section class="card" id="cardMobility">
      <h3>Mobility Dash</h3>
      <p class="muted">‡πÄ‡∏Å‡∏° 3 ‚Äî ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏ô‡∏´‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</p>
      <div class="row"><label>Difficulty</label><select id="dashDiff"><option>easy</option><option selected>normal</option><option>hard</option></select></div>
      <div class="row"><label>Time (s)</label><input id="dashTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row"><button id="btnDash" class="btn wide">‚ñ∂ Play Mobility Dash</button></div>
    </section>

    <!-- Power Control -->
    <section class="card" id="cardPower">
      <h3>Power Control</h3>
      <p class="muted">‡πÄ‡∏Å‡∏° 4 ‚Äî ‡∏¢‡πà‡∏≠/‡∏¢‡∏∑‡∏ô ‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</p>
      <div class="row"><label>Difficulty</label><select id="powerDiff"><option>easy</option><option selected>normal</option><option>hard</option></select></div>
      <div class="row"><label>Time (s)</label><input id="powerTime" type="number" value="60" min="10" max="600" step="5"></div>
      <div class="row"><button id="btnPower" class="btn wide">‚ñ∂ Play Power Control</button></div>
    </section>
  </main>

  <script src="core/exo-core.js"></script>
  <script src="core/exo-metrics.js"></script>
  <script src="core/exo-settings.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ---------- cache DOM refs ----------
    const el = (id) => document.getElementById(id);

    const $rank   = el('rank');
    const $level  = el('level');
    const $xpbar  = el('xpbar');
    const $sess   = el('sess');
    const $ttime  = el('ttime');
    const $tscore = el('tscore');
    const $avg    = el('avg');
    const $recent = el('recent');

    const $progSel = el('progSel');
    const $btnProg = el('btnProg');

    const $combatDiff = el('combatDiff');
    const $combatTime = el('combatTime');
    const $btnCombat  = el('btnCombat');

    const $rhythmDiff   = el('rhythmDiff');
    const $rhythmBpm    = el('rhythmBpm');
    const $chartPreset  = el('chartPreset');
    const $customWrap   = el('customWrap');
    const $chartUrl     = el('chartUrl');
    const $btnRhythm    = el('btnRhythm');

    const $dashDiff = el('dashDiff');
    const $dashTime = el('dashTime');
    const $btnDash  = el('btnDash');

    const $powerDiff = el('powerDiff');
    const $powerTime = el('powerTime');
    const $btnPower  = el('btnPower');

    // ---------- Dashboard ----------
    function fmtSec(s){ s = s|0; const m=Math.floor(s/60), r=s%60; return (m? m+'m ':'')+r+'s'; }
    function refreshDash(){
      try{
        const d = (window.EXO_METRICS && EXO_METRICS.dashboard) ? EXO_METRICS.dashboard() : {
          profile:{rank:'-', level:1, xp:0}, totals:{sessions:0,time:0,score:0,avgScore:0}, recent:[]
        };
        if($rank)  $rank.textContent  = d.profile.rank || '-';
        if($level) $level.textContent = d.profile.level ?? 1;
        if($xpbar){
          const need = (d.profile.level||1)*500;
          const pct = Math.min(100, Math.round(((d.profile.xp||0)/need)*100));
          $xpbar.style.width = pct+'%';
        }
        if($sess)   $sess.textContent   = d.totals.sessions|0;
        if($ttime)  $ttime.textContent  = fmtSec(d.totals.time|0);
        if($tscore) $tscore.textContent = d.totals.score|0;
        if($avg)    $avg.textContent    = d.totals.avgScore|0;

        if($recent){
          $recent.innerHTML='';
          (d.recent||[]).slice(0,5).forEach(s=>{
            const li=document.createElement('li');
            const dt=new Date(s.t||Date.now()).toLocaleString();
            li.textContent = `[${dt}] ${s.module||'-'} (${s.diff||'-'}) ‚Äî Score ${s.score||0}, Acc ${Math.round(((s.accuracy||0))*10)/10}%`;
            $recent.appendChild(li);
          });
        }
      }catch(e){ console.warn('[Hub] dashboard error:', e); }
    }
    refreshDash();

    // ---------- Helper: open with fallbacks ----------
    async function goFirstAvailable(urls){
      for (const u of urls){
        try{
          const r = await fetch(u, {method:'HEAD', cache:'no-cache'});
          if (r.ok) { location.href = u; return; }
        }catch(_e){
          // HEAD ‡∏≠‡∏≤‡∏à‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å ‚Üí ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á
          location.href = u; return;
        }
      }
      alert('File not found: '+ urls.join(' | '));
    }

    // ---------- Workout Program ----------
    const programs = {
      quick: [
        ['shadow-breaker/play.html?diff=normal&time=60',
         'shadow-breaker/play.html?game=combat&mode=timed&diff=normal&time=60'],

        ['mobility-dash/play.html?diff=normal&time=60',
         'shadow-breaker/play.html?game=dash&mode=timed&diff=normal&time=60'],

        ['rhythm-rider/play.html?diff=normal&bpm=110&chart=rhythm-rider/charts/normal.json',
         'shadow-breaker/play.html?game=rhythm&mode=chart&diff=normal&bpm=110'],

        ['power-control/play.html?diff=normal&time=60',
         'shadow-breaker/play.html?game=power&mode=timed&diff=normal&time=60']
      ],
      rhythm: [
        ['rhythm-rider/play.html?diff=easy&bpm=100&chart=rhythm-rider/charts/easy.json',
         'shadow-breaker/play.html?game=rhythm&mode=chart&diff=easy&bpm=100'],
        ['rhythm-rider/play.html?diff=normal&bpm=120&chart=rhythm-rider/charts/normal.json',
         'shadow-breaker/play.html?game=rhythm&mode=chart&diff=normal&bpm=120'],
        ['rhythm-rider/play.html?diff=hard&bpm=135&chart=rhythm-rider/charts/hard.json',
         'shadow-breaker/play.html?game=rhythm&mode=chart&diff=hard&bpm=135']
      ],
      lower: [
        ['power-control/play.html?diff=easy&time=45',
         'shadow-breaker/play.html?game=power&mode=timed&diff=easy&time=45'],
        ['power-control/play.html?diff=normal&time=60',
         'shadow-breaker/play.html?game=power&mode=timed&diff=normal&time=60'],
        ['mobility-dash/play.html?diff=normal&time=60',
         'shadow-breaker/play.html?game=dash&mode=timed&diff=normal&time=60']
      ]
    };

    if ($btnProg){
      $btnProg.onclick = async () => {
        const key = ($progSel && $progSel.value) || 'quick';
        const planPairs = programs[key] || programs.quick;
        const resolvedPrimaries = planPairs.map(p=>p[0]);
        EXO.store.set('EXO_PLAN', {idx:0, paths:resolvedPrimaries, fallbacks:planPairs});
        await goFirstAvailable(planPairs[0]);
      };
    }

    // ---------- Rhythm ----------
    if ($chartPreset && $customWrap){
      $chartPreset.addEventListener('change', ()=>{ $customWrap.style.display = ($chartPreset.value==='__custom__') ? 'flex':'none'; });
    }
    if ($btnRhythm){
      $btnRhythm.onclick = () => {
        const diff = ($rhythmDiff && $rhythmDiff.value) || 'normal';
        const bpm  = Math.max(60, Math.min(220, parseInt(($rhythmBpm && $rhythmBpm.value) || '110', 10)));
        let primary = 'rhythm-rider/play.html?diff='+encodeURIComponent(diff)+'&bpm='+encodeURIComponent(bpm);
        const preset = $chartPreset ? $chartPreset.value : '';
        if (preset){
          primary += '&chart=' + encodeURIComponent(preset==='__custom__' ? ($chartUrl?.value.trim() || '') : preset);
        }
        const fallback = 'shadow-breaker/play.html?game=rhythm&mode=chart&diff='+encodeURIComponent(diff)+'&bpm='+encodeURIComponent(bpm);
        goFirstAvailable([primary, fallback]);
      };
    }

    // ---------- Combat ----------
    if ($btnCombat){
      $btnCombat.onclick = () => {
        const diff = ($combatDiff && $combatDiff.value) || 'normal';
        const t = Math.max(10, Math.min(600, parseInt(($combatTime && $combatTime.value) || '60', 10)));
        const primary  = `shadow-breaker/play.html?diff=${diff}&time=${t}`;
        const fallback = `shadow-breaker/play.html?game=combat&mode=timed&diff=${diff}&time=${t}`;
        goFirstAvailable([primary, fallback]);
      };
    }

    // ---------- Dash ----------
    if ($btnDash){
      $btnDash.onclick = () => {
        const diff = ($dashDiff && $dashDiff.value) || 'normal';
        const t = Math.max(10, Math.min(600, parseInt(($dashTime && $dashTime.value) || '60', 10)));
        const primary  = `mobility-dash/play.html?diff=${diff}&time=${t}`;
        const fallback = `shadow-breaker/play.html?game=dash&mode=timed&diff=${diff}&time=${t}`;
        goFirstAvailable([primary, fallback]);
      };
    }

    // ---------- Power ----------
    if ($btnPower){
      $btnPower.onclick = () => {
        const diff = ($powerDiff && $powerDiff.value) || 'normal';
        const t = Math.max(10, Math.min(600, parseInt(($powerTime && $powerTime.value) || '60', 10)));
        const primary  = `power-control/play.html?diff=${diff}&time=${t}`;
        const fallback = `shadow-breaker/play.html?game=power&mode=timed&diff=${diff}&time=${t}`;
        goFirstAvailable([primary, fallback]);
      };
    }
  });
  </script>

  <p style="text-align:center;color:#6d7a8a;font-size:12px;margin-top:10px;">
    Prototype WebXR Fitness System ‚Äì EXO Training Protocol
  </p>
</body>
</html>
