<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EXO · Power Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⟵ Exit</a>
    </div>
  </div>

  <!-- Touch zones (ซ้าย/ขวา) ใช้กดค้าง = ย่อตัว -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="panel" class="panel"></div>
  </div>

  <!-- Scene -->
  <a-scene>
    <a-entity light="type:ambient;intensity:0.7"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- ตัวผู้เล่น (แท่งแสดงความสูงตัว) -->
    <a-box id="player" color="#03a9f4" depth="0.3" height="0.6" width="0.6" position="0 1.6 -0.5"></a-box>

    <!-- Game Controller -->
    <a-entity power-game></a-entity>
  </a-scene>

  <script>
  AFRAME.registerComponent('power-game', {
    init() {
      this.scoreUI = document.getElementById('score');
      this.timeUI  = document.getElementById('time');
      this.overlay = document.getElementById('overlay');
      this.panel   = document.getElementById('panel');
      this.player  = document.getElementById('player');

      this.state = { score: 0, time: 60, running: false };
      this.squatting = false;                // true = ย่อตัว, false = ยืน
      this.speed = 3.6;                      // ความเร็ววงแหวน
      this.spawnEvery = 1200;                // ms ต่อหนึ่งวง
      this.rings = [];

      // เริ่มด้วย overlay ▶ Start
      EXO.startOverlay(() => this.start());

      // ปุ่ม Pause
      document.getElementById('btnPause').onclick = () => this.pause();

      // Touch (กดค้าง = squat)
      const onDown = () => this.setSquat(true);
      const onUp   = () => this.setSquat(false);
      ['mousedown','touchstart'].forEach(ev=>{
        document.getElementById('touchL').addEventListener(ev, onDown, {passive:true});
        document.getElementById('touchR').addEventListener(ev, onDown, {passive:true});
      });
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>{
        document.getElementById('touchL').addEventListener(ev, onUp, {passive:true});
        document.getElementById('touchR').addEventListener(ev, onUp, {passive:true});
      });

      // Keyboard (กด/ปล่อย Space หรือ ArrowDown เพื่อ squat)
      window.addEventListener('keydown', e=>{
        if (e.code === 'Space' || e.key === 'ArrowDown') this.setSquat(true);
        if (e.key === 'Escape') this.pause();
      });
      window.addEventListener('keyup', e=>{
        if (e.code === 'Space' || e.key === 'ArrowDown') this.setSquat(false);
      });

      // สปอนวงแหวนเรื่อย ๆ
      this.loop = setInterval(()=> this.spawn(), this.spawnEvery);

      // นับเวลาถอยหลัง
      this.timer = setInterval(() => {
        if (!this.state.running) return;
        this.state.time--;
        this.timeUI.innerText = this.state.time;
        if (this.state.time <= 0) this.end();
      }, 1000);
    },

    start() {
      this.state.running = true;
    },

    setSquat(flag) {
      this.squatting = !!flag;
      // เปลี่ยนความสูง box ผู้เล่นให้เห็นภาพ
      const y = this.squatting ? 1.0 : 1.6;
      this.player.setAttribute('position', `0 ${y} -0.5`);
    },

    spawn() {
      if (!this.state.running) return;
      const isLow = Math.random() < 0.5;     // true = ต้องย่อตัว, false = ต้องยืน
      const y = isLow ? 1.0 : 1.8;

      const ring = document.createElement('a-torus');
      ring.setAttribute('radius', 0.6);
      ring.setAttribute('radius-tubular', 0.05);
      ring.setAttribute('color', isLow ? '#ffc107' : '#8bc34a'); // สีเหลือง = squat / เขียว = stand
      ring.setAttribute('position', `0 ${y} -5`);
      ring.setAttribute('data-low', isLow ? '1' : '0');

      this.el.sceneEl.appendChild(ring);
      this.rings.push(ring);

      // เคลื่อนที่เข้าหาผู้เล่น
      const interval = setInterval(() => {
        if (!this.state.running || !ring.parentNode) {
          clearInterval(interval);
          return;
        }
        const p = ring.getAttribute('position');
        const zNext = p.z + (this.speed * 0.016);  // ~60 FPS
        ring.setAttribute('position', `0 ${p.y} ${zNext}`);

        // ถึงจุดตัดสิน
        if (zNext >= -0.5) {
          const needLow = ring.getAttribute('data-low') === '1';
          const ok = (needLow && this.squatting) || (!needLow && !this.squatting);
          if (ok) {
            this.state.score += 30;
            EXO.beep(700, 0.05, 0.1);
          } else {
            this.state.score = Math.max(0, this.state.score - 30);
            EXO.beep(220, 0.06, 0.15);
          }
          this.scoreUI.innerText = this.state.score;

          ring.parentNode.removeChild(ring);
          this.rings.splice(this.rings.indexOf(ring), 1);
          clearInterval(interval);
        }
      }, 16);
    },

    pause() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Paused</h3>
        <p>Hold touch/space = Squat · Release = Stand</p>
        <button class="btn" onclick="location.reload()">Restart</button>
      `;
      this.overlay.style.display = 'flex';
    },

    end() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Session Complete</h3>
        <p>Score: ${this.state.score}</p>
        <button class="btn" onclick="location.reload()">Restart</button>
        <a href="../index.html" class="btn">Exit</a>
      `;
      this.overlay.style.display = 'flex';
    }
  });
  </script>

</body>
</html>
