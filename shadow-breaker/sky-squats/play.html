<script>
AFRAME.registerComponent('power-game',{
  init(){
    this.scoreUI=document.getElementById('score');
    this.timeUI =document.getElementById('time');

    const q=new URLSearchParams(location.search);
    this.diff=(q.get('diff')||'normal');
    this.totalTime=Math.max(10,parseInt(q.get('time')||'60',10));

    this.state={running:false,time:this.totalTime,score:0,pose:'stand'};
    this.lastSpawn=0;

    this.dd=new EXO_BOOST.DynamicDifficulty({});
    this.fv=new EXO_BOOST.FeverManager({need:10,dur:8000});

    // ปุ่มกดจำลอง squat/stand
    window.addEventListener('keydown', (e)=>{
      if(e.code==='Space' || e.key==='ArrowDown') this.setPose('squat');
      if(e.key==='ArrowUp') this.setPose('stand');
    });

    EXO_safeStart(()=>this.start(), document.getElementById('overlay'), {
      title:'Power Control',
      note:`Diff: ${this.diff} · Time: ${this.totalTime}s`
    });
  },

  start(){
    this.state.running=true;
    this.state.time=this.totalTime;
    this.state.score=0;
    this.scoreUI.textContent='0';
    this.timeUI.textContent=String(this.totalTime);

    this.timer=setInterval(()=>{
      if(!this.state.running) return;
      this.state.time--;
      this.timeUI.textContent=this.state.time;
      if(this.state.time<=0) this.end();
    },1000);
  },

  setPose(p){
    this.state.pose=p;
    // ใส่เอฟเฟกต์เล็ก ๆ
    EXO.beep(p==='squat'?520:700,0.04,0.10);
  },

  tick(t,dt){
    if(!this.state.running) return;
    this.dd.tickDecay(dt); this.fv.tick(dt);
    const iv = Math.max(420, this.dd.getSpawnIv? this.dd.getSpawnIv():600);
    if (performance.now()-this.lastSpawn >= iv){
      this.spawnRing();
      this.lastSpawn=performance.now();
    }
  },

  spawnRing(){
    const need = (Math.random()<0.5)?'squat':'stand';
    const y = need==='squat'? 0.8 : 1.6;
    const ring = document.createElement('a-torus');
    ring.setAttribute('radius','0.45'); ring.setAttribute('radius-tubular','0.02');
    ring.setAttribute('color', need==='squat'? '#06d6a0' : '#ffd166');
    ring.setAttribute('position', `0 ${y} -3.2`);
    ring.classList.add('ring');
    this.el.sceneEl.appendChild(ring);

    const dur = 1500 / (this.dd.getSpeedMul? this.dd.getSpeedMul():1);
    ring.setAttribute('animation__move',{property:'position', to:`0 ${y} -0.2`, dur, easing:'linear'});

    setTimeout(()=>{
      if(!ring.parentNode) return;
      if (this.state.pose===need){
        this.onPass(need);
      }else{
        this.onFail();
      }
      ring.remove();
    }, dur+40);
  },

  onPass(need){
    const add = need==='squat'? 120 : 100;
    const s = this.fv.mulScore? this.fv.mulScore(add):add;
    this.state.score+=s; this.scoreUI.textContent=this.state.score;
    this.dd.onHit&&this.dd.onHit(); this.fv.hit&&this.fv.hit();
    EXO.beep(900,0.05,0.12);
  },
  onFail(){
    this.dd.onMiss&&this.dd.onMiss(); this.fv.miss&&this.fv.miss();
    this.state.score=Math.max(0,this.state.score-100);
    this.scoreUI.textContent=this.state.score;
    EXO.beep(260,0.06,0.12);
  },

  end(){
    this.state.running=false; clearInterval(this.timer);
    const p=document.getElementById('panel'), o=document.getElementById('overlay');
    o.style.display='flex';
    p.innerHTML=`<div class="title">Result</div>
      <div class="kpi"><div>Score</div><b>${this.state.score}</b></div>
      <div style="text-align:center;margin-top:.6rem">
        <a class="btn" href="../index.html">⟵ Back</a>
        <a class="btn" onclick="location.reload()">↺ Replay</a>
      </div>`;
  },
  remove(){ clearInterval(this.timer); }
});
</script>
