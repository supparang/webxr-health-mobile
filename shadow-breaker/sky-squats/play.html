<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO · Power Control (VS + LB + i18n: central)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- UI & Core -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <!-- ✅ i18n กลาง -->
  <script src="../core/exo-i18n.js"></script>
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>

  <!-- Settings + Leaderboard + VS -->
  <script src="../core/exo-settings.js"></script>
  <script src="../core/exo-leaderboard.js"></script>
  <script src="../core/exo-net.js"></script>

  <style>
    .vsHud{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:9}
    .vsHud .box{background:rgba(14,20,36,.85);border:1px solid #112848}
    .tagwin{color:#7ee787}.taglose{color:#ff7777}.tagtie{color:#ffd166}
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⟵ <span data-i18n="common.hub">Hub</span></a>
    </div>
  </div>

  <!-- Touch Zones (ซ้าย = กดค้างเพื่อ Squat, ขวา = ปล่อย) -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- ✅ VS HUD (เปิดเมื่อ ?vs=1) -->
  <div id="vsHud" class="vsHud" style="display:none">
    <div class="box">
      <span id="lblOpp" data-i18n="common.opponent">Opponent</span> <span id="oppConn">⏳</span> —
      <span id="lblScore" data-i18n="common.score">Score</span> <b id="oppScore">0</b> | <span id="oppCombo">x1.0</span>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="panel" class="panel"></div>
  </div>

  <!-- Scene -->
  <a-scene renderer="antialias:true; colorManagement:true">

    <!-- Lighting -->
    <a-entity light="type:ambient;intensity:.7;color:#88aaff"></a-entity>
    <a-entity light="type:directional;intensity:.9" position="0 3 2"></a-entity>

    <!-- Floor + Hit Line -->
    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4" material="color:#0f1b33;"></a-plane>
    <a-entity geometry="primitive: box; depth:.02; height:.02; width:12" position="0 0.01 -0.5"
              material="color:#3B82F6; emissive:#3B82F6; emissiveIntensity:.8"></a-entity>

    <!-- Player -->
    <a-box id="player" color="#03a9f4" depth="0.3" height="0.6" width="0.6" position="0 1.6 -0.5"></a-box>

    <!-- Game Logic -->
    <a-entity power-game></a-entity>
  </a-scene>

<script>
AFRAME.registerComponent('power-game',{
  init(){
    // ===== i18n ศูนย์กลาง =====
    const lang = EXO_I18N.get();
    const tC   = EXO_I18N.scope('common');
    const tMod = EXO_I18N.scope('power');

    // ===== UI Refs =====
    this.$s=document.getElementById('score');
    this.$c=document.getElementById('combo');
    this.$t=document.getElementById('time');
    this.overlay=document.getElementById('overlay');
    this.panel=document.getElementById('panel');
    this.player=document.getElementById('player');

    // ===== Query Params / VS =====
    const q=new URLSearchParams(location.search);
    const diff=(q.get('diff')||'normal').toLowerCase();
    const music=q.get('music'); // ?music=assets/music.ogg
    const timeParam=Math.max(10, +(q.get('time')||60));
    this.isVS = q.get('vs') === '1';

    // ✅ VS HUD
    if (this.isVS){
      document.getElementById('vsHud').style.display='block';
      this.$oppConn = document.getElementById('oppConn');
      this.$oppScore= document.getElementById('oppScore');
      this.$oppCombo= document.getElementById('oppCombo');
      this.opp = {score:0, combo:1.0, isOver:false};

      EXO_NET.onState(st => { this.$oppConn.textContent = (st==='connected'?'✅':'⏳'); });
      EXO_NET.onMessage(msg => {
        if (msg?.type==='state'){
          this.opp.score = msg.score|0; this.opp.combo = +msg.combo||1.0;
          this.$oppScore.textContent = this.opp.score;
          this.$oppCombo.textContent = 'x' + this.opp.combo.toFixed(1);
        }
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          this.$oppScore.textContent = this.opp.score;
        }
      });
    }

    // ===== Difficulty Presets =====
    const DIFF={
      easy:{ speed:3.2, spawn:1300, bonus:28, penalty:20, squatY:1.0, standY:1.6 },
      normal:{ speed:3.8, spawn:1200, bonus:30, penalty:30, squatY:1.0, standY:1.6 },
      hard:{ speed:4.6, spawn:1000, bonus:34, penalty:36, squatY:0.95, standY:1.65 }
    };
    this.cfg=DIFF[diff]||DIFF.normal;

    // ===== State =====
    this.state={ score:0, combo:1.0, maxCombo:1.0, time:timeParam, running:false, pass:0, fail:0 };
    this.$t.textContent=this.state.time;

    this.squatting=false;
    this.rings=[];
    this.movers=new Set();

    // ===== Tutorial =====
    EXO.startOverlay(()=>this.start(),{
      title: tMod('title') + (this.isVS?' · '+tC('vs'):''),
      howto:[
        {title: lang==='th'?'เป้าหมาย':'Goal', text:tMod('goal')},
        {title: lang==='th'?'การควบคุม':'Controls', html:tMod('ctrl')},
        {title: lang==='th'?'คะแนน':'Scoring', text:tMod('scoreTip')}
      ],
      note:`${tC('diff')}: <b>${diff.toUpperCase()}</b>${music?' · '+tC('music')+': on':''}${this.isVS?' · '+tC('vs'):''}`
    });

    // ===== Control Input =====
    const down=()=>this.setSquat(true);
    const up  =()=>this.setSquat(false);

    ['mousedown','touchstart'].forEach(e=>{
      document.getElementById('touchL').addEventListener(e,down);
    });
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(e=>{
      document.getElementById('touchL').addEventListener(e,up);
    });
    // โซนขวา = ปล่อย
    ['mousedown','touchstart'].forEach(e=>{
      document.getElementById('touchR').addEventListener(e,up);
    });

    window.addEventListener('keydown',e=>{
      if(e.code==='Space' || e.key==='ArrowDown') this.setSquat(true);
      if(e.key==='Escape') this.pause();
    });
    window.addEventListener('keyup',e=>{
      if(e.code==='Space' || e.key==='ArrowDown') this.setSquat(false);
    });

    document.getElementById('btnPause').onclick=()=>this.pause();

    // ===== Music =====
    if(music) try{EXO.audio.playMusic(music,{loop:true,volume:0.35});}catch(e){}

    // ===== Timer =====
    this.timer=setInterval(()=>{
      if(!this.state.running) return;
      this.state.time--; this.$t.textContent=this.state.time;
      if(this.state.time<=0) this.end();
    },1000);
  },

  start(){
    this.state.running=true;
    this.setSquat(false); // เริ่มจากยืน
    this.spawnLoop=setInterval(()=>this.spawn(),this.cfg.spawn);
  },

  setSquat(flag){
    this.squatting=!!flag;
    this.player.object3D.position.y=this.squatting?this.cfg.squatY:this.cfg.standY;
  },

  spawn(){
    if(!this.state.running) return;
    const isLow=Math.random()<0.5;
    const y=isLow?this.cfg.squatY:(this.cfg.standY+0.2);

    const ring=document.createElement('a-torus');
    ring.setAttribute('radius',0.6);
    ring.setAttribute('radius-tubular',0.05);
    ring.setAttribute('color',isLow?'#ffc107':'#8bc34a');
    ring.setAttribute('position',`0 ${y} -5`);
    ring.setAttribute('data-low',isLow?'1':'0');
    this.el.sceneEl.appendChild(ring);
    this.rings.push(ring);

    const mover=setInterval(()=>{
      if(!this.state.running||!ring.parentNode){clearInterval(mover);this.movers.delete(mover);return;}
      const p=ring.getAttribute('position');
      ring.setAttribute('position',`0 ${p.y} ${p.z + this.cfg.speed*0.016}`);

      if(p.z>-0.5){
        const needLow=ring.getAttribute('data-low')==='1';
        const ok=(needLow&&this.squatting)||(!needLow&&!this.squatting);

        if(ok){
          this.state.pass++;
          this.state.score+=Math.round(this.cfg.bonus*this.state.combo);
          this.state.combo=Math.min(5.0,this.state.combo+0.18);
          this.state.maxCombo=Math.max(this.state.maxCombo,this.state.combo);
          EXO.beep(700,0.05,0.1);
        } else {
          this.state.fail++;
          this.state.score=Math.max(0,this.state.score-this.cfg.penalty);
          this.state.combo=1.0;
          EXO.beep(220,0.06,0.15);
        }
        this.$s.textContent=this.state.score;
        this.$c.textContent='x'+this.state.combo.toFixed(1);

        // ✅ ส่งสถานะ VS ทุกครั้งที่มีการเปลี่ยนสกอร์/คอมโบ
        if (this.isVS && EXO_NET.connected()){
          EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
        }

        try{ring.parentNode.removeChild(ring);}catch(e){}
        const i=this.rings.indexOf(ring); if(i>=0) this.rings.splice(i,1);
        clearInterval(mover); this.movers.delete(mover);
      }
    },16);
    this.movers.add(mover);
  },

  pause(){
    if(!this.state.running) return;
    this.state.running=false;
    clearInterval(this.spawnLoop);
    this.movers.forEach(m=>clearInterval(m));

    try{EXO.audio.stopMusic();}catch(e){}

    const tC = EXO_I18N.scope('common');
    this.panel.innerHTML=`
      <div class="title">${tC('paused')}${this.isVS?' · '+tC('vs'):''}</div>
      <p>${tMod('ctrl')}</p>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <a class="btn" onclick="location.reload()">⟲ ${tC('restart')}</a>
        <a class="btn" href="../index.html">⟵ ${tC('hub')}</a>
      </div>`;
    this.overlay.style.display='flex';
  },

  end(){
    const tC = EXO_I18N.scope('common');
    const tP = EXO_I18N.scope('power');

    this.state.running=false;
    clearInterval(this.timer);
    clearInterval(this.spawnLoop);
    this.movers.forEach(m=>clearInterval(m));
    this.movers.clear();

    const total=this.state.pass+this.state.fail;
    const acc=total>0?(this.state.pass/total)*100:0;

    try{
      EXO_METRICS.recordSession({
        module:'Power Control',
        diff:(new URLSearchParams(location.search).get('diff')||'normal'),
        score:this.state.score,
        accuracy:Math.round(acc*10)/10,
        hits:this.state.pass,
        misses:this.state.fail,
        duration:this.state.time
      });
    }catch(e){}

    try{EXO.audio.stopMusic();}catch(e){}

    // ✅ แจ้งผลให้คู่แข่ง
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'over', score:this.state.score|0});
    }

    const makeResult = (oppKnown=false)=>{
      let verdict='';
      if (this.isVS && oppKnown){
        if (this.state.score > (this.opp?.score||0)) verdict = `<div class="tagwin"><b>${tC('youWin')}</b></div>`;
        else if (this.state.score < (this.opp?.score||0)) verdict = `<div class="taglose"><b>${tC('youLose')}</b></div>`;
        else verdict = `<div class="tagtie"><b>${tC('tie')}</b></div>`;
      }
      return `
        <div class="title">${tC('result')} — Power Control ${this.isVS?'· '+tC('vs'):''}</div>
        ${verdict}
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div>${tC('score')}<br><b>${this.state.score}</b></div>
          <div>${tC('maxCombo')}<br><b>${this.state.maxCombo.toFixed(1)}×</b></div>
          <div>${tC('accuracy')}<br><b>${acc.toFixed(1)}%</b></div>
        </div>
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>${tP('pass')}<br><b>${this.state.pass}</b></div>
          <div>${tP('fail')}<br><b>${this.state.fail}</b></div>
        </div>
        ${this.isVS ? `
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>${tC('oppScore')}<br><b id="oppScoreFinal">${this.opp?.score||0}</b></div>
          <div>${tC('oppStatus')}<br><b id="oppStatus">${this.opp?.isOver?tC('finished'):tC('pending')}</b></div>
        </div>`:``}
        <div style="display:flex;gap:.6rem;justify-content:center">
          <a class="btn" onclick="location.reload()">⟲ ${tC('restart')}</a>
          <a class="btn" href="../index.html">⟵ ${tC('hub')}</a>
        </div>`;
    };

    this.panel.innerHTML = makeResult(this.isVS ? this.opp?.isOver : false);
    this.overlay.style.display='flex';

    // ถ้า VS และฝั่งตรงข้ามยังไม่จบ ให้รอฟังผลแล้วอัปเดต verdict
    if (this.isVS && !this.opp?.isOver){
      const handler=(msg)=>{
        if (msg?.type==='over'){
          this.opp.isOver=true; this.opp.score=msg.score|0;
          const sF=document.getElementById('oppScoreFinal'); if(sF) sF.textContent=this.opp.score;
          const sS=document.getElementById('oppStatus'); if(sS) sS.textContent=tC('finished');
          this.panel.innerHTML = makeResult(true);
        }
      };
      EXO_NET.onMessage(handler);
      setTimeout(()=>{ const sS=document.getElementById('oppStatus'); if (sS && !this.opp.isOver) sS.textContent=tC('pending'); }, 5000);
    }

    // ===== Online Leaderboard (Auto Submit: ถามชื่อแล้วส่ง) =====
    setTimeout(async ()=>{
      try{
        const name = prompt(tC('askName'),'');
        if (!name) return;

        await EXO_LB.submit({
          name,
          module: 'Power Control',
          score: this.state.score|0,
          accuracy: Math.round(acc*10)/10,
          diff: (new URLSearchParams(location.search).get('diff')||'normal')
        });

        // แจ้งยืนยัน
        const ok = document.createElement('div');
        ok.className = 'kpi';
        ok.style.cssText = 'margin-top:8px;text-align:center';
        ok.innerHTML = `<div style="grid-column:1/-1"><b>${tC('sent')}</b></div>`;
        this.panel.appendChild(ok);
      }catch(e){ console.warn('LB submit failed', e); }
    }, 350);

    const nextURL=new URLSearchParams(location.search).get('next');
    if(nextURL) setTimeout(()=>location.href=nextURL,1500);
  }
});
</script>

</body>
</html>
