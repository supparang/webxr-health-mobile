<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EXO · Mobility Dash (VS Ready)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Core & Metrics -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
  <!-- ✅ VS / P2P -->
  <script src="../core/exo-net.js"></script>
  <style>
    .vsHud{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:9}
    .vsHud .box{background:rgba(14,20,36,.85);border:1px solid #112848}
    .tagwin{color:#7ee787}.taglose{color:#ff7777}.tagtie{color:#ffd166}
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⏵ Hub</a>
    </div>
  </div>

  <!-- Touch zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- ✅ VS HUD (เปิดเมื่อ ?vs=1) -->
  <div id="vsHud" class="vsHud" style="display:none">
    <div class="box">
      Opponent <span id="oppConn">⏳</span> — Score <b id="oppScore">0</b> | <span id="oppCombo">x1.0</span>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;"><div id="panel" class="panel"></div></div>

  <!-- Scene -->
  <a-scene renderer="antialias:true; colorManagement:true">
    <a-entity light="type:ambient;intensity:.7;color:#88aaff"></a-entity>
    <a-entity light="type:directional;intensity:.9" position="0 3 2"></a-entity>

    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4"
             material="color:#0f1b33; metalness:.35; roughness:.4"></a-plane>
    <!-- เส้น Hit Line -->
    <a-entity geometry="primitive: box; depth: .02; height: .02; width: 12" position="0 0.01 -0.5"
              material="color:#3B82F6; emissive:#3B82F6; emissiveIntensity:.8"></a-entity>

    <!-- Player -->
    <a-box id="player" color="#4caf50" depth="0.3" height="0.3" width="0.3" position="-0.8 1.2 -0.5"></a-box>

    <!-- Game Logic -->
    <a-entity dash-game></a-entity>
  </a-scene>

<script>
AFRAME.registerComponent('dash-game',{
  init(){
    // ===== UI refs =====
    this.$s=document.getElementById('score');
    this.$c=document.getElementById('combo');
    this.$t=document.getElementById('time');
    this.overlay=document.getElementById('overlay');
    this.panel=document.getElementById('panel');
    this.player=document.getElementById('player');

    // ===== Query / Difficulty / Music / VS =====
    const q=new URLSearchParams(location.search);
    const diff=(q.get('diff')||'normal').toLowerCase();
    const music=q.get('music');
    const timeParam=Math.max(10, +(q.get('time')||60));
    this.isVS = q.get('vs')==='1';

    // ✅ VS HUD
    if (this.isVS){
      this.$vsHud   = document.getElementById('vsHud');
      this.$oppConn = document.getElementById('oppConn');
      this.$oppScore= document.getElementById('oppScore');
      this.$oppCombo= document.getElementById('oppCombo');
      this.$vsHud.style.display='block';
      this.opp = {score:0, combo:1.0, isOver:false};

      EXO_NET.onState(st=> this.$oppConn.textContent = (st==='connected'?'✅':'⏳'));
      EXO_NET.onMessage(msg=>{
        if (msg?.type==='state'){
          this.opp.score = msg.score|0; this.opp.combo = +msg.combo||1.0;
          this.$oppScore.textContent = this.opp.score;
          this.$oppCombo.textContent = 'x' + this.opp.combo.toFixed(1);
        }
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          this.$oppScore.textContent = this.opp.score;
        }
      });
    }

    // ค่าพรีเซ็ตความยาก
    const DIFF={
      easy:   { speed:0.045, spawn:950, laneSwapBonus:12, hitPenalty:8 },
      normal: { speed:0.055, spawn:800,  laneSwapBonus:15, hitPenalty:10 },
      hard:   { speed:0.070, spawn:650,  laneSwapBonus:18, hitPenalty:12 }
    };
    this.cfg=DIFF[diff]||DIFF.normal;

    // ===== State =====
    this.state={ score:0, combo:1.0, maxCombo:1.0, time:timeParam, running:false, avoided:0, hit:0 };
    this.$t.textContent=this.state.time;

    // ===== Space / lanes =====
    this.lanes={L:-0.8,R:0.8};
    this.playerLane='L';
    this.obstacles=[];   // active obstacle list
    this.movers=new Set();

    // ===== Tutorial + Start =====
    this.title='Mobility Dash';
    this.tutorialGoal='สลับเลนซ้าย/ขวาเพื่อหลบกล่องสีแดงที่พุ่งเข้ามา';
    this.tutorialCtrlHTML='<ul style="text-align:left;margin:0 auto;max-width:260px"><li>มือถือ/เดสก์ท็อป: แตะซ้าย/ขวา</li><li>คีย์บอร์ด: ←/A และ →/D</li><li>VR: Trigger ซ้าย/ขวา</li></ul>';
    this.tutorialScore='หลบสำเร็จ +คะแนน×คอมโบ • ชน = หักคะแนนและคอมโบตก';

    EXO.startOverlay(()=> this.start(), {
      title: 'EXO — Mobility Dash' + (this.isVS?' · VS':''),
      howto: [
        { title:'เป้าหมาย', text: this.tutorialGoal },
        { title:'การบังคับ', html: this.tutorialCtrlHTML },
        { title:'การได้คะแนน', text: this.tutorialScore }
      ],
      note: `Difficulty: <b>${diff.toUpperCase()}</b>${music?' · Music: on':''}${this.isVS?' · VS Mode':''}`
    });

    // ===== Inputs =====
    EXO.attachBasicInput({ onLeft:()=>this.move('L'), onRight:()=>this.move('R'), onPause:()=>this.pause() });
    document.getElementById('btnPause').onclick=()=>this.pause();

    // ===== Music (optional) =====
    if (music) { try{ EXO.audio.playMusic(music, {loop:true, volume:0.35}); }catch(e){} }

    // ===== Countdown =====
    this.timer=setInterval(()=>{
      if(!this.state.running) return;
      this.state.time--;
      this.$t.textContent=this.state.time;
      if(this.state.time<=0) this.end();
    },1000);
  },

  // ===== Start session =====
  start(){
    this.state.running=true;
    this.spawnLoop=setInterval(()=>this.spawn(), this.cfg.spawn);
  },

  // ===== Player move lane =====
  move(side){
    if(!this.state.running) return;
    this.playerLane=side;
    this.player.setAttribute('position', `${this.lanes[side]} 1.2 -0.5`);
  },

  // ===== Spawn obstacle =====
  spawn(){
    if(!this.state.running) return;
    const side=Math.random()<0.5?'L':'R';
    const box=document.createElement('a-box');
    box.setAttribute('color','#e53935');
    box.setAttribute('depth',0.4); box.setAttribute('height',0.4); box.setAttribute('width',0.4);
    box.setAttribute('position', `${this.lanes[side]} 1.2 -4`);
    box.setAttribute('data-side', side);
    this.el.sceneEl.appendChild(box);
    this.obstacles.push(box);

    const mover=setInterval(()=>{
      if(!this.state.running || !box.parentNode){ clearInterval(mover); this.movers.delete(mover); return; }
      const p=box.getAttribute('position');
      const z=p.z + this.cfg.speed;
      box.setAttribute('position', `${p.x} ${p.y} ${z}`);

      // ถึงเส้น
      if(z>=-0.5){
        if(this.playerLane!==side){
          // หลบได้
          this.state.avoided++;
          this.state.score += Math.round(this.cfg.laneSwapBonus * this.state.combo);
          this.state.combo = Math.min(5.0, this.state.combo+0.15);
          this.state.maxCombo = Math.max(this.state.maxCombo, this.state.combo);
          EXO.beep(720,0.03,0.08);
        }else{
          // ชน
          this.state.hit++;
          this.state.score = Math.max(0, this.state.score - this.cfg.hitPenalty);
          this.state.combo = 1.0;
          EXO.beep(220,0.06,0.15);
        }
        this.$s.textContent=this.state.score;
        this.$c.textContent='x'+this.state.combo.toFixed(1);

        // ✅ ส่งสถานะ VS ทุกครั้งที่มีการเปลี่ยนสกอร์/คอมโบ
        if (this.isVS && EXO_NET.connected()){
          EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
        }

        // cleanup
        try{ box.parentNode.removeChild(box);}catch(e){}
        const i=this.obstacles.indexOf(box); if(i>=0) this.obstacles.splice(i,1);
        clearInterval(mover); this.movers.delete(mover);
      }
    },16);
    this.movers.add(mover);
  },

  // ===== Pause =====
  pause(){
    if(!this.state.running) return;
    this.state.running=false;

    this.movers.forEach(h=>clearInterval(h));
    clearInterval(this.spawnLoop);

    try{ EXO.audio.stopMusic(); }catch(e){}

    this.panel.innerHTML=`
      <div class="title">Paused${this.isVS?' · VS':''}</div>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <a class="btn" onclick="location.reload()">⟲ Restart</a>
        <a class="btn" href="../index.html">⏵ Hub</a>
      </div>`;
    this.overlay.style.display='flex';
  },

  // ===== End session =====
  end(){
    this.state.running=false;
    clearInterval(this.timer);
    clearInterval(this.spawnLoop);
    this.movers.forEach(h=>clearInterval(h));
    this.movers.clear();

    const total=this.state.avoided + this.state.hit;
    const acc = total>0 ? (this.state.avoided/total)*100 : 0;

    // Metrics
    try{
      const duration = +(new URLSearchParams(location.search).get('time')||this.state.time||60);
      EXO_METRICS.recordSession({
        module: 'Mobility Dash',
        diff: (new URLSearchParams(location.search).get('diff')||'normal'),
        score: this.state.score||0,
        accuracy: Math.round(acc*10)/10,
        hits: this.state.avoided||0,
        misses: this.state.hit||0,
        duration
      });
    }catch(e){}

    try{ EXO.audio.stopMusic(); }catch(e){}

    // ✅ แจ้งผลให้คู่แข่ง
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'over', score:this.state.score|0});
    }

    // Result UI (+ VS verdict เมื่อทราบสกอร์คู่แข่ง)
    const makeResultHTML = (oppKnown=false)=>{
      let verdict = '';
      if (this.isVS && oppKnown){
        if (this.state.score > this.opp.score) verdict = `<div class="tagwin"><b>YOU WIN</b></div>`;
        else if (this.state.score < this.opp.score) verdict = `<div class="taglose"><b>YOU LOSE</b></div>`;
        else verdict = `<div class="tagtie"><b>TIE</b></div>`;
      }
      return `
        <div class="title">Result — Mobility Dash ${this.isVS?'· VS':''}</div>
        ${verdict}
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div>Score<br><b>${this.state.score}</b></div>
          <div>MAX Combo<br><b>${this.state.maxCombo.toFixed(1)}×</b></div>
          <div>Accuracy<br><b>${acc.toFixed(1)}%</b></div>
        </div>
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>Avoided<br><b>${this.state.avoided}</b></div>
          <div>Hit<br><b>${this.state.hit}</b></div>
        </div>
        ${this.isVS ? `
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>Opponent Score<br><b id="oppScoreFinal">${this.opp?.score||0}</b></div>
          <div>Opponent Status<br><b id="oppStatus">${this.opp?.isOver?'Finished':'Pending'}</b></div>
        </div>` : ``}
        <div style="display:flex;gap:.6rem;justify-content:center">
          <a class="btn" onclick="location.reload()">⟲ Restart</a>
          <a class="btn" href="../index.html">⏵ Hub</a>
        </div>`;
    };

    this.panel.innerHTML = makeResultHTML(this.isVS ? this.opp?.isOver : false);
    this.overlay.style.display='flex';

    // ถ้า VS และยังไม่รู้ผลคู่แข่ง → รอฟังแล้วอัปเดต verdict
    if (this.isVS && !this.opp.isOver){
      const handler = (msg)=>{
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          const sF=document.getElementById('oppScoreFinal'); if(sF) sF.textContent=this.opp.score;
          const sS=document.getElementById('oppStatus'); if(sS) sS.textContent='Finished';
          this.panel.innerHTML = makeResultHTML(true);
        }
      };
      EXO_NET.onMessage(handler);
      setTimeout(()=>{ // fallback กันเงียบ
        const sS=document.getElementById('oppStatus');
        if (sS && !this.opp.isOver) sS.textContent='Pending…';
      }, 5000);
    }

    // Workout Program: ส่งต่อถ้ามี next=
    const nextURL = new URLSearchParams(location.search).get('next');
    if (nextURL) { setTimeout(()=> location.href = nextURL, 1500); }
  }
});
</script>

</body>
</html>
