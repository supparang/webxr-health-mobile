<script>
AFRAME.registerComponent('dash-game',{
  init(){
    this.scoreUI = document.getElementById('score');
    this.timeUI  = document.getElementById('time');
    this.player  = document.getElementById('player');

    const q = new URLSearchParams(location.search);
    this.diff = (q.get('diff')||'normal');
    this.totalTime = Math.max(10, parseInt(q.get('time')||'60',10));

    this.state = {running:false, time:this.totalTime, score:0, lane:'L'};
    this.lanes = {L:-0.8, R:0.8};
    this.lastSpawn = 0;

    this.dd = new EXO_BOOST.DynamicDifficulty({});
    this.fv = new EXO_BOOST.FeverManager({need:10,dur:8000});

    EXO.attachBasicInput({
      onLeft: ()=> this.move('L'),
      onRight:()=> this.move('R'),
      onPause: ()=>{}
    });

    EXO_safeStart(()=>this.start(), document.getElementById('overlay'), {
      title:'Mobility Dash',
      note:`Diff: ${this.diff} · Time: ${this.totalTime}s`
    });
  },

  start(){
    this.state.running=true;
    this.state.time=this.totalTime;
    this.state.score=0;
    this.scoreUI.textContent='0';
    this.timeUI.textContent=String(this.totalTime);
    this.move('L');
    this.timer=setInterval(()=>{
      if(!this.state.running) return;
      this.state.time--;
      this.timeUI.textContent=this.state.time;
      if(this.state.time<=0) this.end();
    },1000);
  },

  move(side){
    this.state.lane=side;
    const x=this.lanes[side];
    this.player.setAttribute('position', `${x} 1.2 -0.5`);
  },

  tick(t,dt){
    if(!this.state.running) return;
    this.dd.tickDecay(dt); this.fv.tick(dt);
    const iv = Math.max(380, this.dd.getSpawnIv? this.dd.getSpawnIv():600);
    if (performance.now()-this.lastSpawn >= iv){
      this.spawnObstacle();
      this.lastSpawn=performance.now();
    }
  },

  spawnObstacle(){
    const lane = (Math.random()<0.5)?'L':'R';
    const x = this.lanes[lane], zStart=-3.6, y=1.05;
    const o = document.createElement('a-cylinder');
    o.setAttribute('radius','0.22'); o.setAttribute('height','0.42');
    o.setAttribute('color','#ef476f'); o.classList.add('obs');
    o.setAttribute('position', `${x} ${y} ${zStart}`);
    this.el.sceneEl.appendChild(o);

    const dur = 1400 / (this.dd.getSpeedMul? this.dd.getSpeedMul():1);
    o.setAttribute('animation__move',{property:'position', to:`${x} ${y} -0.35`, dur, easing:'linear'});

    // เมื่อถึงเส้น ตรวจชน/หลบ
    setTimeout(()=>{
      if(!o.parentNode) return;
      if (this.state.lane===lane){
        // ชน
        this.onHitObstacle();
      }else{
        // หลบสำเร็จ = ได้คะแนน + fever
        this.addScore(60);
        this.fv.hit&&this.fv.hit();
      }
      o.remove();
    }, dur+40);
  },

  addScore(v){
    const s = this.fv.mulScore? this.fv.mulScore(v):v;
    this.state.score += s;
    this.scoreUI.textContent = this.state.score;
    this.dd.onHit&&this.dd.onHit();
    EXO.beep(680,0.04,0.1);
  },

  onHitObstacle(){
    this.dd.onMiss&&this.dd.onMiss();
    this.fv.miss&&this.fv.miss();
    this.state.score = Math.max(0, this.state.score-120);
    this.scoreUI.textContent=this.state.score;
    EXO.beep(220,0.06,0.12);
  },

  end(){
    this.state.running=false;
    clearInterval(this.timer);
    const p=document.getElementById('panel'), o=document.getElementById('overlay');
    o.style.display='flex';
    p.innerHTML=`<div class="title">Result</div>
      <div class="kpi"><div>Score</div><b>${this.state.score}</b></div>
      <div style="text-align:center;margin-top:.6rem">
        <a class="btn" href="../index.html">⟵ Back</a>
        <a class="btn" onclick="location.reload()">↺ Replay</a>
      </div>`;
  },

  remove(){ clearInterval(this.timer); }
});
</script>
