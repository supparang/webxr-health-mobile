<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO · Mobility Dash (VS + LB + i18n)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Core & UI -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>

  <!-- ✅ Settings + Leaderboard + VS -->
  <script src="../core/exo-settings.js"></script>
  <script src="../core/exo-leaderboard.js"></script>
  <script src="../core/exo-net.js"></script>

  <style>
    .vsHud{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:9}
    .vsHud .box{background:rgba(14,20,36,.85);border:1px solid #112848}
    .tagwin{color:#7ee787}.taglose{color:#ff7777}.tagtie{color:#ffd166}
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⏵ Hub</a>
    </div>
  </div>

  <!-- Touch zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- ✅ VS HUD (เปิดเมื่อ ?vs=1) -->
  <div id="vsHud" class="vsHud" style="display:none">
    <div class="box">
      <span id="lblOpp">Opponent</span> <span id="oppConn">⏳</span> — 
      <span id="lblScore">Score</span> <b id="oppScore">0</b> | <span id="oppCombo">x1.0</span>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;"><div id="panel" class="panel"></div></div>

  <!-- Scene -->
  <a-scene renderer="antialias:true; colorManagement:true">
    <a-entity light="type:ambient;intensity:.7;color:#88aaff"></a-entity>
    <a-entity light="type:directional;intensity:.9" position="0 3 2"></a-entity>

    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4"
             material="color:#0f1b33; metalness:.35; roughness:.4"></a-plane>
    <!-- เส้น Hit Line -->
    <a-entity geometry="primitive: box; depth: .02; height: .02; width: 12" position="0 0.01 -0.5"
              material="color:#3B82F6; emissive:#3B82F6; emissiveIntensity:.8"></a-entity>

    <!-- Player -->
    <a-box id="player" color="#4caf50" depth="0.3" height="0.3" width="0.3" position="-0.8 1.2 -0.5"></a-box>

    <!-- Game Logic -->
    <a-entity dash-game></a-entity>
  </a-scene>

<script>
AFRAME.registerComponent('dash-game',{
  init(){
    // ===== i18n =====
    const lang = (window.EXO_SETTINGS?.get()?.lang)||'th';
    const L = {
      th:{ title:'EXO — Mobility Dash', vs:'โหมดดวล',
           goal:'สลับเลนซ้าย/ขวาเพื่อหลบกล่องสีแดงที่พุ่งเข้ามา',
           ctrl:'<ul style="text-align:left;margin:0 auto;max-width:260px"><li>มือถือ/เดสก์ท็อป: แตะซ้าย/ขวา</li><li>คีย์บอร์ด: ←/A และ →/D</li><li>VR: Trigger ซ้าย/ขวา</li></ul>',
           scoreTip:'หลบสำเร็จได้คะแนน × คอมโบ • ชนจะถูกหักคะแนนและคอมโบตก',
           diff:'ระดับ', music:'เพลง', paused:'พักเกม', restart:'เริ่มใหม่', hub:'กลับ Hub',
           result:'ผลลัพธ์', score:'คะแนน', maxCombo:'คอมโบสูงสุด', accuracy:'ความแม่นยำ',
           avoided:'หลบสำเร็จ', hit:'ชน', opp:'คู่แข่ง', oppScore:'คะแนนคู่แข่ง', oppStatus:'สถานะคู่แข่ง',
           finished:'จบแล้ว', pending:'รอผล...', askName:'ชื่อสำหรับ Leaderboard (เว้นว่างเพื่อข้าม):',
           sent:'✓ ส่งคะแนนขึ้น Leaderboard แล้ว', youWin:'YOU WIN', youLose:'YOU LOSE', tie:'TIE'
      },
      en:{ title:'EXO — Mobility Dash', vs:'VS Mode',
           goal:'Switch lanes (L/R) to avoid incoming red boxes.',
           ctrl:'<ul style="text-align:left;margin:0 auto;max-width:260px"><li>Mobile/Desktop: Tap Left/Right</li><li>Keyboard: ←/A and →/D</li><li>VR: Left/Right Trigger</li></ul>',
           scoreTip:'Avoid = score × combo • Hit = penalty & combo reset',
           diff:'Difficulty', music:'Music', paused:'Paused', restart:'Restart', hub:'Hub',
           result:'Result', score:'Score', maxCombo:'Max Combo', accuracy:'Accuracy',
           avoided:'Avoided', hit:'Hit', opp:'Opponent', oppScore:'Opponent Score', oppStatus:'Opponent Status',
           finished:'Finished', pending:'Pending…', askName:'Name for Leaderboard (leave blank to skip):',
           sent:'✓ Submitted to Leaderboard', youWin:'YOU WIN', youLose:'YOU LOSE', tie:'TIE'
      }
    }[lang]; const t=k=>L[k]||k;

    // ===== UI refs =====
    this.$s=document.getElementById('score');
    this.$c=document.getElementById('combo');
    this.$t=document.getElementById('time');
    this.overlay=document.getElementById('overlay');
    this.panel=document.getElementById('panel');
    this.player=document.getElementById('player');

    // ===== Query / Difficulty / Music / VS =====
    const q=new URLSearchParams(location.search);
    const diff=(q.get('diff')||'normal').toLowerCase();
    const music=q.get('music');
    const timeParam=Math.max(10, +(q.get('time')||60));
    this.isVS = q.get('vs')==='1';

    // ✅ VS HUD
    if (this.isVS){
      this.$vsHud   = document.getElementById('vsHud');
      this.$oppConn = document.getElementById('oppConn');
      this.$oppScore= document.getElementById('oppScore');
      this.$oppCombo= document.getElementById('oppCombo');
      document.getElementById('lblOpp').textContent = t('opp');
      document.getElementById('lblScore').textContent = (lang==='th'?'คะแนน':'Score');
      this.$vsHud.style.display='block';
      this.opp = {score:0, combo:1.0, isOver:false};

      EXO_NET.onState(st=> this.$oppConn.textContent = (st==='connected'?'✅':'⏳'));
      EXO_NET.onMessage(msg=>{
        if (msg?.type==='state'){
          this.opp.score = msg.score|0; this.opp.combo = +msg.combo||1.0;
          this.$oppScore.textContent = this.opp.score;
          this.$oppCombo.textContent = 'x' + this.opp.combo.toFixed(1);
        }
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          this.$oppScore.textContent = this.opp.score;
        }
      });
    }

    // ค่าพรีเซ็ตความยาก
    const DIFF={
      easy:   { speed:0.045, spawn:950, laneSwapBonus:12, hitPenalty:8 },
      normal: { speed:0.055, spawn:800,  laneSwapBonus:15, hitPenalty:10 },
      hard:   { speed:0.070, spawn:650,  laneSwapBonus:18, hitPenalty:12 }
    };
    this.cfg=DIFF[diff]||DIFF.normal;

    // ===== State =====
    this.state={ score:0, combo:1.0, maxCombo:1.0, time:timeParam, running:false, avoided:0, hit:0 };
    this.$t.textContent=this.state.time;

    // ===== Space / lanes =====
    this.lanes={L:-0.8,R:0.8};
    this.playerLane='L';
    this.obstacles=[];   // active obstacle list
    this.movers=new Set();

    // ===== Tutorial + Start =====
    EXO.startOverlay(()=> this.start(), {
      title: L.title + (this.isVS?' · '+L.vs:''),
      howto: [
        { title: lang==='th'?'เป้าหมาย':'Goal',         text: L.goal },
        { title: lang==='th'?'การบังคับ':'Controls',     html: L.ctrl },
        { title: lang==='th'?'การได้คะแนน':'Scoring',    text: L.scoreTip }
      ],
      note: `${L.diff}: <b>${diff.toUpperCase()}</b>${music?' · '+L.music+': on':''}${this.isVS?' · '+L.vs:''}`
    });

    // ===== Inputs =====
    EXO.attachBasicInput({ onLeft:()=>this.move('L'), onRight:()=>this.move('R'), onPause:()=>this.pause() });
    document.getElementById('btnPause').onclick=()=>this.pause();

    // ===== Music (optional) =====
    if (music) { try{ EXO.audio.playMusic(music, {loop:true, volume:0.35}); }catch(e){} }

    // ===== Countdown =====
    this.timer=setInterval(()=>{
      if(!this.state.running) return;
      this.state.time--;
      this.$t.textContent=this.state.time;
      if(this.state.time<=0) this.end();
    },1000);
  },

  // ===== Start session =====
  start(){
    this.state.running=true;
    this.spawnLoop=setInterval(()=>this.spawn(), this.cfg.spawn);
  },

  // ===== Player move lane =====
  move(side){
    if(!this.state.running) return;
    this.playerLane=side;
    this.player.setAttribute('position', `${this.lanes[side]} 1.2 -0.5`);
  },

  // ===== Spawn obstacle =====
  spawn(){
    if(!this.state.running) return;
    const side=Math.random()<0.5?'L':'R';
    const box=document.createElement('a-box');
    box.setAttribute('color','#e53935');
    box.setAttribute('depth',0.4); box.setAttribute('height',0.4); box.setAttribute('width',0.4);
    box.setAttribute('position', `${this.lanes[side]} 1.2 -4`);
    box.setAttribute('data-side', side);
    this.el.sceneEl.appendChild(box);
    this.obstacles.push(box);

    const mover=setInterval(()=>{
      if(!this.state.running || !box.parentNode){ clearInterval(mover); this.movers.delete(mover); return; }
      const p=box.getAttribute('position');
      const z=p.z + this.cfg.speed;
      box.setAttribute('position', `${p.x} ${p.y} ${z}`);

      // ถึงเส้น
      if(z>=-0.5){
        if(this.playerLane!==side){
          // หลบได้
          this.state.avoided++;
          this.state.score += Math.round(this.cfg.laneSwapBonus * this.state.combo);
          this.state.combo = Math.min(5.0, this.state.combo+0.15);
          this.state.maxCombo = Math.max(this.state.maxCombo, this.state.combo);
          EXO.beep(720,0.03,0.08);
        }else{
          // ชน
          this.state.hit++;
          this.state.score = Math.max(0, this.state.score - this.cfg.hitPenalty);
          this.state.combo = 1.0;
          EXO.beep(220,0.06,0.15);
        }
        this.$s.textContent=this.state.score;
        this.$c.textContent='x'+this.state.combo.toFixed(1);

        // ✅ ส่งสถานะ VS ทุกครั้งที่มีการเปลี่ยนสกอร์/คอมโบ
        if (this.isVS && EXO_NET.connected()){
          EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
        }

        // cleanup
        try{ box.parentNode.removeChild(box);}catch(e){}
        const i=this.obstacles.indexOf(box); if(i>=0) this.obstacles.splice(i,1);
        clearInterval(mover); this.movers.delete(mover);
      }
    },16);
    this.movers.add(mover);
  },

  // ===== Pause =====
  pause(){
    if(!this.state.running) return;
    this.state.running=false;

    this.movers.forEach(h=>clearInterval(h));
    clearInterval(this.spawnLoop);

    try{ EXO.audio.stopMusic(); }catch(e){}

    this.panel.innerHTML=`
      <div class="title">${L.paused}${this.isVS?' · '+L.vs:''}</div>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <a class="btn" onclick="location.reload()">⟲ ${L.restart}</a>
        <a class="btn" href="../index.html">⏵ ${L.hub}</a>
      </div>`;
    this.overlay.style.display='flex';
  },

  // ===== End session =====
  end(){
    this.state.running=false;
    clearInterval(this.timer);
    clearInterval(this.spawnLoop);
    this.movers.forEach(h=>clearInterval(h));
    this.movers.clear();

    const total=this.state.avoided + this.state.hit;
    const acc = total>0 ? (this.state.avoided/total)*100 : 0;

    // Metrics
    try{
      const duration = +(new URLSearchParams(location.search).get('time')||this.state.time||60);
      EXO_METRICS.recordSession({
        module: 'Mobility Dash',
        diff: (new URLSearchParams(location.search).get('diff')||'normal'),
        score: this.state.score||0,
        accuracy: Math.round(acc*10)/10,
        hits: this.state.avoided||0,
        misses: this.state.hit||0,
        duration
      });
    }catch(e){}

    try{ EXO.audio.stopMusic(); }catch(e){}

    // ✅ แจ้งผลให้คู่แข่ง
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'over', score:this.state.score|0});
    }

    // Result UI (+ VS verdict เมื่อทราบสกอร์คู่แข่ง)
    const makeResultHTML = (oppKnown=false)=>{
      let verdict = '';
      if (this.isVS && oppKnown){
        if (this.state.score > (this.opp?.score||0)) verdict = `<div class="tagwin"><b>${L.youWin}</b></div>`;
        else if (this.state.score < (this.opp?.score||0)) verdict = `<div class="taglose"><b>${L.youLose}</b></div>`;
        else verdict = `<div class="tagtie"><b>${L.tie}</b></div>`;
      }
      return `
        <div class="title">${L.result} — Mobility Dash ${this.isVS?'· '+L.vs:''}</div>
        ${verdict}
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div>${L.score}<br><b>${this.state.score}</b></div>
          <div>${L.maxCombo}<br><b>${this.state.maxCombo.toFixed(1)}×</b></div>
          <div>${L.accuracy}<br><b>${acc.toFixed(1)}%</b></div>
        </div>
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>${L.avoided}<br><b>${this.state.avoided}</b></div>
          <div>${L.hit}<br><b>${this.state.hit}</b></div>
        </div>
        ${this.isVS ? `
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>${L.oppScore}<br><b id="oppScoreFinal">${this.opp?.score||0}</b></div>
          <div>${L.oppStatus}<br><b id="oppStatus">${this.opp?.isOver?L.finished:L.pending}</b></div>
        </div>` : ``}
        <div style="display:flex;gap:.6rem;justify-content:center">
          <a class="btn" onclick="location.reload()">⟲ ${L.restart}</a>
          <a class="btn" href="../index.html">⏵ ${L.hub}</a>
        </div>`;
    };

    this.panel.innerHTML = makeResultHTML(this.isVS ? this.opp?.isOver : false);
    this.overlay.style.display='flex';

    // ถ้า VS และยังไม่รู้ผลคู่แข่ง → รอฟังแล้วอัปเดต verdict
    if (this.isVS && !this.opp?.isOver){
      const handler = (msg)=>{
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          const sF=document.getElementById('oppScoreFinal'); if(sF) sF.textContent=this.opp.score;
          const sS=document.getElementById('oppStatus'); if(sS) sS.textContent=L.finished;
          this.panel.innerHTML = makeResultHTML(true);
        }
      };
      EXO_NET.onMessage(handler);
      setTimeout(()=>{ const sS=document.getElementById('oppStatus'); if (sS && !this.opp.isOver) sS.textContent=L.pending; }, 5000);
    }

    // ===== Online Leaderboard (Auto Submit: ถามชื่อแล้วส่ง) =====
    setTimeout(async ()=>{
      try{
        const name = prompt(L.askName,'');
        if (!name) return;

        await EXO_LB.submit({
          name,
          module: 'Mobility Dash',
          score: this.state.score|0,
          accuracy: Math.round(acc*10)/10,
          diff: (new URLSearchParams(location.search).get('diff')||'normal')
        });

        // แจ้งยืนยัน
        const ok = document.createElement('div');
        ok.className = 'kpi';
        ok.style.cssText = 'margin-top:8px;text-align:center';
        ok.innerHTML = `<div style="grid-column:1/-1"><b>${L.sent}</b></div>`;
        this.panel.appendChild(ok);
      }catch(e){ console.warn('LB submit failed', e); }
    }, 350);

    // Workout Program: ส่งต่อถ้ามี next=
    const nextURL = new URLSearchParams(location.search).get('next');
    if (nextURL) { setTimeout(()=> location.href = nextURL, 1500); }
  }
});
</script>

</body>
</html>
