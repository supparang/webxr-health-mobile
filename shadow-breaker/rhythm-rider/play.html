<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EXO · Rhythm Sync (VS Ready)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Core & Metrics -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
  <!-- ✅ VS / P2P -->
  <script src="../core/exo-net.js"></script>

  <style>
    .beatRail { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; color:#9ecbff; font-size:12px; opacity:.8 }
    #fb { position:fixed; left:50%; top:30%; transform:translateX(-50%); pointer-events:none; z-index:30; }
    .tag { font: 700 28px/1 system-ui,Segoe UI,Roboto; padding:6px 10px; margin-top:10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
           background:rgba(10,20,36,.55); color:#e6f2ff; text-shadow:0 0 6px rgba(255,255,255,.15); opacity:0; transform:translateY(16px);
           animation: rise .7s ease-out forwards; }
    .tag.perfect { color:#7ee787; border-color:#2b8a3e; }
    .tag.good    { color:#9ecbff; border-color:#2a6fb5; }
    .tag.okay    { color:#ffd166; border-color:#a77418; }
    .tag.miss    { color:#ff7777; border-color:#8a2b2b; }
    @keyframes rise { to { opacity:1; transform:translateY(-6px); } }

    .grade { display:inline-flex; align-items:center; justify-content:center; width:64px; height:64px; border-radius:50%;
             font:800 28px/1 system-ui; background:linear-gradient(180deg,#0b1325,#0f1b33); border:2px solid #284c92; color:#e6f2ff;
             box-shadow:0 0 18px rgba(59,130,246,.35) inset, 0 0 12px rgba(59,130,246,.25); }
    .grade.s   { border-color:#28a745; box-shadow:0 0 18px rgba(40,167,69,.35) inset, 0 0 12px rgba(40,167,69,.25); }
    .grade.ss  { border-color:#ffd166; box-shadow:0 0 18px rgba(255,209,102,.35) inset, 0 0 12px rgba(255,209,102,.25); color:#0a0a0a; }

    .legend { display:flex; gap:10px; justify-content:center; font-size:12px; color:#a7c5ff; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .p { background:#7ee787; } .g { background:#9ecbff; } .o{background:#ffd166;} .m{background:#ff7777;}

    /* ✅ VS HUD */
    .vsHud{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:9}
    .vsHud .box{background:rgba(14,20,36,.85);border:1px solid #112848}
    .tagwin{color:#7ee787}.taglose{color:#ff7777}.tagtie{color:#ffd166}
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⟵ Hub</a>
    </div>
  </div>

  <!-- Touch Zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- ✅ VS HUD (จะถูกเปิดเมื่อ ?vs=1) -->
  <div id="vsHud" class="vsHud" style="display:none">
    <div class="box">
      Opponent <span id="oppConn">⏳</span> — Score <b id="oppScore">0</b> | <span id="oppCombo">x1.0</span>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;"><div id="panel" class="panel"></div></div>

  <!-- Feedback container -->
  <div id="fb"></div>

  <!-- Beat Rail hint -->
  <div class="beatRail">Hit on the line ↓</div>

  <!-- Scene -->
  <a-scene renderer="antialias:true; colorManagement:true">
    <a-entity light="type:ambient;intensity:0.7;color:#88aaff"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- ห้อง + พื้น + เส้น Hit Line -->
    <a-entity geometry="primitive: box; depth: 22; height: 6; width: 12" position="0 3 -7"
              material="color: #0c1428; side: back; metalness:0.1; roughness:0.9"></a-entity>
    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4"
             material="color:#0f1b33; metalness:.35; roughness:.4"></a-plane>
    <a-entity geometry="primitive: box; depth: .02; height: .02; width: 12" position="0 0.01 -0.5"
              material="color:#3B82F6; emissive:#3B82F6; emissiveIntensity:.8"></a-entity>

    <!-- Camera -->
    <a-entity id="rig"><a-entity camera position="0 1.6 0"></a-entity></a-entity>

    <!-- Game Logic -->
    <a-entity rhythm-game></a-entity>
  </a-scene>

<script>
AFRAME.registerComponent('rhythm-game', {
  async init() {
    // ===== UI refs =====
    this.$s = document.getElementById('score');
    this.$c = document.getElementById('combo');
    this.$t = document.getElementById('time');
    this.overlay = document.getElementById('overlay');
    this.panel   = document.getElementById('panel');
    this.$fb     = document.getElementById('fb');

    // ===== VS Mode? =====
    const q = new URLSearchParams(location.search);
    this.isVS = q.get('vs') === '1';
    if (this.isVS){
      this.$vsHud   = document.getElementById('vsHud');
      this.$oppConn = document.getElementById('oppConn');
      this.$oppScore= document.getElementById('oppScore');
      this.$oppCombo= document.getElementById('oppCombo');
      this.$vsHud.style.display = 'block';
      this.opp = {score:0, combo:1.0, isOver:false};

      EXO_NET.onState(st => { this.$oppConn.textContent = (st==='connected'?'✅':'⏳'); });
      EXO_NET.onMessage(msg => {
        if (msg?.type==='state'){
          this.opp.score = msg.score|0; this.opp.combo = +msg.combo||1.0;
          this.$oppScore.textContent = this.opp.score;
          this.$oppCombo.textContent = 'x' + this.opp.combo.toFixed(1);
        }
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          this.$oppScore.textContent = this.opp.score;
        }
      });
    }

    // ===== State =====
    this.state = { 
      score: 0, combo: 1.0, maxCombo: 1.0,
      time: 60, running: false,
      cntPerfect:0, cntGood:0, cntOkay:0, cntMiss:0
    };

    // ===== Query params =====
    const diff = (q.get('diff')||'normal').toLowerCase(); // easy|normal|hard
    this.bpm   = +(q.get('bpm') || 110);
    const chartUrl = q.get('chart');
    const music = q.get('music');

    // ===== Difficulty presets =====
    const DIFF = {
      easy:   { windows: {perfect: 90, good: 150, okay: 220}, scoreMul: 1.0 },
      normal: { windows: {perfect: 50, good: 110, okay: 170}, scoreMul: 1.1 },
      hard:   { windows: {perfect: 30, good: 70,  okay: 110}, scoreMul: 1.25 },
    };
    this.dcfg = DIFF[diff] || DIFF.normal;

    // ===== rhythm / lanes =====
    this.beat = 60 / this.bpm;
    this.spawnZ = -5; this.hitZ = -0.5; this.laneX = {L:-0.8, R:0.8};

    // pool
    this.pool = []; for (let i=0;i<32;i++) this.pool.push(this.mkNote(this.el.sceneEl));

    // windows
    this.winPerfect = this.dcfg.windows.perfect;
    this.winGood    = this.dcfg.windows.good;
    this.winOkay    = this.dcfg.windows.okay;

    // ===== Load chart =====
    this.chart = null;
    try { if (chartUrl){ const res=await fetch(chartUrl,{cache:'no-store'}); this.chart = await res.json(); } } catch(e){}
    if (!Array.isArray(this.chart)) this.chart = this.defaultChart(diff);

    // ===== Tutorial + Start Overlay =====
    this.title = 'Rhythm Sync';
    this.tutorialGoal = 'ตีตามจังหวะ BPM ให้โน้ตชนเส้นพอดี · Hold ต้องกดค้างจนจบแท่ง';
    this.tutorialCtrlHTML = '<ul style="text-align:left;margin:0 auto;max-width:260px"><li>มือถือ: แตะซ้าย/ขวา</li><li>คีย์บอร์ด: ←/A และ →/D</li><li>VR: Trigger ซ้าย/ขวา</li></ul>';
    this.tutorialScore = 'PERFECT/GOOD/OKAY/MISS ตามความตรงเวลา · คอมโบยิ่งสูงคะแนนยิ่งพุ่ง';
    EXO.startOverlay(()=> { this.overlay.style.display='none'; this.start(); }, {
      title: 'EXO — Rhythm Sync' + (this.isVS?' · VS':''),
      howto: [
        { title:'เป้าหมาย', text: this.tutorialGoal },
        { title:'การบังคับ', html: this.tutorialCtrlHTML },
        { title:'การได้คะแนน', text: this.tutorialScore }
      ],
      note: `BPM: <b>${this.bpm}</b> · Difficulty: <b>${diff.toUpperCase()}</b>${music?' · Music: on':''}${this.isVS?' · VS Mode':''}`
    });

    // ===== Inputs =====
    EXO.attachBasicInput({
      onLeft:  () => this.tryHit('L'),
      onRight: () => this.tryHit('R'),
      onPause: () => this.pause()
    });
    document.getElementById('btnPause').onclick = () => this.pause();

    // ===== Timer (แสดงผล) =====
    this.timer = setInterval(()=>{ if(this.state.running){ this.state.time--; this.$t.textContent=this.state.time; if(this.state.time<=0) this.end(); }},1000);

    // ===== Music (optional) =====
    if (music) { try{ EXO.audio.playMusic(music, {loop:true, volume:0.35}); }catch(e){} }

    // ===== RAF + schedule =====
    this._tick = this._tick.bind(this);
    requestAnimationFrame(this._tick);
    this.lookAhead = 2.0; // sec
    this.spawnedIdx = -1;

    // Hit error log
    this.errors = []; // {tIdx, ms, tier}
  },

  mkNote(scene){
    const e=document.createElement('a-entity');
    e.setAttribute('visible', false);
    e.userData = {alive:false, side:'L', hitAt:0, type:'tap', holdEndAt:0, spawned:false, idx:-1};
    const inner=document.createElement('a-entity');
    inner.setAttribute('geometry','primitive:sphere; radius:.22');
    inner.setAttribute('material','color:#ff6ef0; emissive:#6a2a8a; emissiveIntensity:.35');
    e.appendChild(inner);
    scene.appendChild(e); return e;
  },

  defaultChart(diff){
    const base = [
      {t:0, side:'L', type:'tap'},
      {t:1, side:'R', type:'tap'},
      {t:2, side:'L', type:'tap'},
      {t:3, side:'R', type:'tap'},
      {t:4, side:'L', type:'hold', len:2},
      {t:7, side:'R', type:'tap'},
      {t:7.5, side:'L', type:'tap'},
      {t:8, side:'R', type:'tap'},
      {t:9, side:'R', type:'hold', len:1.5},
      {t:11, side:'L', type:'tap'},
      {t:12, side:'R', type:'tap'},
      {t:12.5, side:'L', type:'tap'},
      {t:13, side:'R', type:'tap'}
    ];
    if (diff==='easy')  return base;
    if (diff==='hard')  return base.concat([{t:13.25, side:'L', type:'tap'},{t:13.5, side:'L', type:'tap'},{t:14, side:'R', type:'tap'},{t:14.5, side:'L', type:'tap'},{t:15, side:'R', type:'hold', len:2}]);
    return base.concat([{t:13.25, side:'L', type:'tap'}]);
  },

  start(){
    this.t0 = EXO.now();
    this.state.running = true;
    this.lastBeatIdx = -1;
  },

  flash(label, cls){
    const s = document.createElement('div');
    s.className = `tag ${cls}`;
    s.textContent = label;
    this.$fb.appendChild(s);
    setTimeout(()=> s.remove(), 750);
  },

  metronome(){
    const tRel = EXO.now() - this.t0;
    const beatIdx = Math.floor(tRel / this.beat);
    if (beatIdx !== this.lastBeatIdx) {
      this.lastBeatIdx = beatIdx;
      EXO.beep(900, 0.03, 0.06);
    }
  },

  schedule(){
    const tNow = EXO.now() - this.t0;
    for (let i=this.spawnedIdx+1; i<this.chart.length; i++){
      const n=this.chart[i]; const noteTime = n.t * this.beat;
      if (noteTime - tNow <= this.lookAhead){
        const e = this.pool.find(o=>!o.userData.alive); if (!e) break;
        e.userData.alive=true; e.userData.side=n.side; e.userData.type=n.type; e.userData.idx=i;
        e.userData.hitAt=noteTime; e.userData.holdEndAt = (n.type==='hold') ? (noteTime + (n.len||1)*this.beat) : 0;
        e.object3D.position.set(this.laneX[n.side], 1.4, this.spawnZ);
        const inner=e.children[0];
        if (n.type==='hold'){
          inner.setAttribute('geometry','primitive:cylinder; radius:.17; height:.5');
          inner.setAttribute('material','color:#7ee787; emissive:#2b8a3e; emissiveIntensity:.35');
        } else {
          inner.setAttribute('geometry','primitive:sphere; radius:.22');
          inner.setAttribute('material','color:#ff6ef0; emissive:#6a2a8a; emissiveIntensity:.35');
        }
        e.setAttribute('visible',true);
        const travelTime = Math.max(0.1, noteTime - tNow);
        e.userData.vz = (this.hitZ - this.spawnZ) / travelTime;
        this.spawnedIdx = i;
      } else break;
    }
  },

  scoreGain(tier){
    const base = {perfect:120, good:80, okay:40, miss:0}[tier] || 0;
    return Math.round(base * this.dcfg.scoreMul * this.state.combo);
  },

  registerHitTier(tier){
    if (tier==='perfect') this.state.cntPerfect++;
    else if (tier==='good') this.state.cntGood++;
    else if (tier==='okay') this.state.cntOkay++;
    else if (tier==='miss') this.state.cntMiss++;
  },

  tryHit(side){
    if (!this.state.running) return;
    const t = EXO.now() - this.t0;
    let cand=null, bestErr=1e9;
    for (const e of this.pool){
      if (!e.userData.alive) continue;
      if (e.userData.side!==side) continue;
      const errMs = (t - e.userData.hitAt)*1000;
      const absv = Math.abs(errMs);
      if (e.userData.type==='tap' || (e.userData.type==='hold' && t <= e.userData.holdEndAt + 0.2)){
        if (absv<Math.abs(bestErr)){bestErr=errMs; cand=e;}
      }
    }
    if (!cand) return;

    let tier='miss';
    if (Math.abs(bestErr)<=this.winPerfect) tier='perfect';
    else if (Math.abs(bestErr)<=this.winGood) tier='good';
    else if (Math.abs(bestErr)<=this.winOkay) tier='okay';

    if (tier==='miss'){ this.miss(cand, bestErr); return; }

    this.state.score += this.scoreGain(tier);
    this.state.combo = Math.min(5.0, this.state.combo + (tier==='perfect'?0.2:0.15));
    this.state.maxCombo = Math.max(this.state.maxCombo, this.state.combo);
    this.$s.textContent = this.state.score;
    this.$c.textContent = 'x' + this.state.combo.toFixed(1);
    this.flash(tier.toUpperCase(), tier);
    this.registerHitTier(tier);
    this.errors.push({tIdx: cand.userData.idx, ms: Math.round(bestErr), tier});
    EXO.beep(760, 0.03, 0.08);

    const inner=cand.children[0];
    if (cand.userData.type==='tap'){
      cand.setAttribute('visible',false); cand.userData.alive=false;
    } else {
      inner.setAttribute('material','color:#b6f7c8; emissive:#3bbf5a; emissiveIntensity:.5');
      cand.userData.holding=true;
    }

    // ✅ ส่งสถานะ VS
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
    }
  },

  miss(e, errMs=NaN){
    this.state.combo = 1.0;
    this.$c.textContent = 'x1.0';
    this.flash('MISS','miss');
    this.registerHitTier('miss');
    const inner=e.children[0];
    inner.setAttribute('material','color:#ff5252; emissive:#8a2b2b; emissiveIntensity:.4');
    this.errors.push({tIdx: e.userData.idx, ms: isNaN(errMs)? null : Math.round(errMs), tier:'miss'});

    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
    }
  },

  pause(){
    if (!this.state.running) return;
    this.state.running=false;
    this.panel.innerHTML = `
      <div class="title">Paused${this.isVS?' · VS':''}</div>
      <p>BPM <b>${this.bpm}</b> · PERFECT ≤ ${this.winPerfect}ms</p>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <a class="btn" onclick="location.reload()">⟲ Restart</a>
        <a class="btn" href="../index.html">⟵ Hub</a>
      </div>`;
    this.overlay.style.display='flex';
  },

  computeStats(){
    const totalNotes = this.chart.length;
    const hits = this.state.cntPerfect + this.state.cntGood + this.state.cntOkay;
    const hitRate = totalNotes > 0 ? (hits / totalNotes) * 100 : 0;
    const weighted = (this.state.cntPerfect*1) + (this.state.cntGood*0.7) + (this.state.cntOkay*0.4);
    const accuracy = totalNotes > 0 ? (weighted / totalNotes) * 100 : 0;

    let grade='C';
    if (accuracy>=92) grade='S';
    if (accuracy>=98 && this.state.cntMiss===0) grade='SS';
    else if (accuracy>=85 && grade==='C') grade='A';
    else if (accuracy>=75 && grade==='C') grade='B';

    return {
      totalNotes, hits,
      hitRate: Math.round(hitRate * 10) / 10,
      accuracy: Math.round(accuracy * 10) / 10,
      maxCombo: Math.round(this.state.maxCombo*10)/10,
      grade
    };
  },

  renderGraphSVG(width, height){
    const pad=24, w=width, h=height;
    const svgNS='http://www.w3.org/2000/svg';
    const svg = document.createElementNS(svgNS,'svg');
    svg.setAttribute('width', w); svg.setAttribute('height', h);
    svg.style.background='rgba(8,14,28,.6)'; svg.style.border='1px solid #112848'; svg.style.borderRadius='8px';

    const data=this.errors.filter(e=>e.ms!==null && !isNaN(e.ms)).sort((a,b)=>a.tIdx-b.tIdx);
    const N=(data.length||1);
    const x = i=> pad + ( (w-2*pad) * (i/(N-1||1)) );
    const range = Math.max(this.winOkay, 220);
    const y = ms => (h/2) - ( (h/2-pad) * (ms/range) );

    const mkLine=(yv,color)=>{ const L=document.createElementNS(svgNS,'line'); L.setAttribute('x1',pad);L.setAttribute('x2',w-pad);L.setAttribute('y1',yv);L.setAttribute('y2',yv);L.setAttribute('stroke',color);L.setAttribute('stroke-dasharray','4 4');L.setAttribute('stroke-width','1'); svg.appendChild(L);};
    mkLine(h/2,'#2b4b86'); mkLine(h/2 - (h/2-pad)*( this.winPerfect/Math.max(this.winOkay,220)),'#2b8a3e'); mkLine(h/2 + (h/2-pad)*( this.winPerfect/Math.max(this.winOkay,220)),'#2b8a3e');
    mkLine(h/2 - (h/2-pad)*( this.winGood/Math.max(this.winOkay,220)),'#2a6fb5'); mkLine(h/2 + (h/2-pad)*( this.winGood/Math.max(this.winOkay,220)),'#2a6fb5');
    mkLine(h/2 - (h/2-pad)*( this.winOkay/Math.max(this.winOkay,220)),'#a77418'); mkLine(h/2 + (h/2-pad)*( this.winOkay/Math.max(this.winOkay,220)),'#a77418');

    const colorMap={perfect:'#7ee787', good:'#9ecbff', okay:'#ffd166', miss:'#ff7777'};
    data.forEach((d,i)=>{ const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx', pad + ((w-2*pad)*(i/(N-1||1)))); c.setAttribute('cy', y(d.ms)); c.setAttribute('r', 3.5); c.setAttribute('fill', colorMap[d.tier] || '#e6f2ff'); svg.appendChild(c); });
    return svg;
  },

  end(){
    this.state.running=false;
    clearInterval(this.timer);

    const stats = this.computeStats();

    try{
      EXO_METRICS.recordSession({
        module: 'Rhythm Sync',
        diff: (new URLSearchParams(location.search).get('diff')||'normal'),
        score: this.state.score,
        accuracy: stats.accuracy,
        hits: this.state.cntPerfect + this.state.cntGood + this.state.cntOkay,
        misses: this.state.cntMiss,
        duration: this.state.time
      });
    }catch(e){}

    try{ EXO.audio.stopMusic(); }catch(e){}

    // ✅ แจ้งผลให้คู่แข่ง
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'over', score:this.state.score|0});
    }

    const gradeClass = stats.grade==='SS' ? 'grade ss' : (stats.grade==='S'?'grade s':'grade');
    const makeResult = (oppKnown=false)=>`
      <div class="title">Result — Rhythm Sync ${this.isVS?'· VS':''}</div>
      <div style="display:flex; gap:16px; align-items:center; justify-content:center; margin-bottom:8px">
        <div class="${gradeClass}">${stats.grade}</div>
        <div class="kpi" style="grid-template-columns:repeat(3,1fr); min-width:320px">
          <div>Score<br><b>${this.state.score}</b></div>
          <div>Max Combo<br><b>${stats.maxCombo}×</b></div>
          <div>Accuracy<br><b>${stats.accuracy}%</b></div>
          <div>Perfect<br><b>${this.state.cntPerfect}</b></div>
          <div>Good<br><b>${this.state.cntGood}</b></div>
          <div>Okay<br><b>${this.state.cntOkay}</b></div>
          <div>Miss<br><b>${this.state.cntMiss}</b></div>
          <div>BPM<br><b>${this.bpm}</b></div>
          <div>Notes<br><b>${stats.totalNotes}</b></div>
        </div>
      </div>
      ${this.isVS ? `
      <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
        <div>Opponent Score<br><b id="oppScoreFinal">${this.opp?.score||0}</b></div>
        <div>Opponent Status<br><b id="oppStatus">${this.opp?.isOver?'Finished':'Pending'}</b></div>
      </div>
      <div id="vsVerdict" style="text-align:center;margin-top:6px"></div>` : ``}
      <div id="graphWrap" style="display:flex; flex-direction:column; align-items:center; gap:6px; margin:8px 0 6px;">
        <div class="legend"><span><i class="dot p"></i> Perfect</span><span><i class="dot g"></i> Good</span><span><i class="dot o"></i> Okay</span><span><i class="dot m"></i> Miss</span></div>
      </div>
      <div style="display:flex;gap:.6rem;justify-content:center;margin-top:8px">
        <a class="btn" onclick="location.reload()">⟲ Restart</a>
        <a class="btn" href="../index.html">⟵ Hub</a>
      </div>`;

    this.panel.innerHTML = makeResult(this.isVS ? this.opp?.isOver : false);
    const wrap = document.getElementById('graphWrap');
    wrap.appendChild(this.renderGraphSVG(560, 180));
    this.overlay.style.display='flex';

    // ถ้า VS: สรุปผลชนะ/แพ้/เสมอ เมื่อมีสกอร์คู่แข่ง
    const renderVerdict = ()=>{
      const box=document.getElementById('vsVerdict'); if(!box) return;
      const a=this.state.score|0, b=this.opp.score|0;
      if (a>b) box.innerHTML = `<div class="tagwin"><b>YOU WIN</b></div>`;
      else if (a<b) box.innerHTML = `<div class="taglose"><b>YOU LOSE</b></div>`;
      else box.innerHTML = `<div class="tagtie"><b>TIE</b></div>`;
    };

    if (this.isVS){
      if (this.opp.isOver) renderVerdict();
      else {
        const handler=(msg)=>{
          if (msg?.type==='over'){
            this.opp.isOver=true; this.opp.score=msg.score|0;
            const sF=document.getElementById('oppScoreFinal'); if(sF) sF.textContent=this.opp.score;
            const sS=document.getElementById('oppStatus'); if(sS) sS.textContent='Finished';
            renderVerdict();
          }
        };
        EXO_NET.onMessage(handler);
        setTimeout(()=>{ // fallback
          const sS=document.getElementById('oppStatus');
          if (sS && !this.opp.isOver) sS.textContent='Pending…';
        }, 3000);
      }
    }

    const nextURL = new URLSearchParams(location.search).get('next');
    if (nextURL) { setTimeout(()=> location.href = nextURL, 1500); }
  },

  _tick(){
    if (!this.state.running){ requestAnimationFrame(this._tick); return; }
    this.schedule(); this.metronome();

    const tRel = EXO.now() - this.t0;
    for (const e of this.pool){
      if (!e.userData.alive) continue;
      const p=e.object3D.position; p.z += e.userData.vz*(1/60);
      if (p.z >= this.hitZ + 0.05){
        if (e.userData.type==='hold'){
          const ok = (e.userData.holding && tRel >= e.userData.holdEndAt - 0.05);
          if (ok){
            this.state.score += this.scoreGain('good');
            this.state.combo = Math.min(5.0, this.state.combo + 0.15);
            this.state.maxCombo = Math.max(this.state.maxCombo, this.state.combo);
            this.$s.textContent=this.state.score; this.$c.textContent='x'+this.state.combo.toFixed(1);
            this.flash('HOLD','good'); EXO.beep(680,0.05,0.1);
            this.state.cntGood++;
          } else {
            this.miss(e);
          }
        } else {
          this.miss(e);
        }
        e.setAttribute('visible',false); e.userData.alive=false;

        // ส่งสถานะหลังจบโน้ตหนึ่งตัว (VS)
        if (this.isVS && EXO_NET.connected()){
          EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
        }
      }
    }

    // จบเมื่อโน้ตหมด
    const allSpawned = this.spawnedIdx >= this.chart.length - 1;
    const anyAlive   = this.pool.some(e => e.userData.alive);
    if (allSpawned && !anyAlive) { this.end(); return; }

    requestAnimationFrame(this._tick);
  }
});
</script>

</body>
</html>
