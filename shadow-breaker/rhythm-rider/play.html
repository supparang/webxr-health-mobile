<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EXO · Rhythm Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⟵ Exit</a>
    </div>
  </div>

  <!-- Touch Zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="panel" class="panel"></div>
  </div>

  <!-- Scene -->
  <a-scene>
    <a-entity light="type:ambient;intensity:0.7"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- Camera -->
    <a-entity id="rig">
      <a-entity camera position="0 1.6 0"></a-entity>
    </a-entity>

    <!-- Game Logic -->
    <a-entity rhythm-game></a-entity>
  </a-scene>

  <script>
  AFRAME.registerComponent('rhythm-game', {
    init() {
      this.scoreUI = document.getElementById('score');
      this.comboUI = document.getElementById('combo');
      this.timeUI  = document.getElementById('time');
      this.overlay = document.getElementById('overlay');
      this.panel   = document.getElementById('panel');

      this.state = { score: 0, combo: 1.0, time: 60, running: false };
      this.beatInterval = 700; 
      this.beatTimer = 0;
      this.targets = [];

      EXO.startOverlay(() => this.start());

      EXO.attachBasicInput({
        onLeft: () => this.hit('L'),
        onRight: () => this.hit('R'),
        onPause: () => this.pause()
      });

      document.getElementById('btnPause').onclick = () => this.pause();

      this.timer = setInterval(() => {
        if (!this.state.running) return;
        this.state.time--;
        this.timeUI.innerText = this.state.time;
        if (this.state.time <= 0) this.end();
      }, 1000);
    },

    start() {
      this.state.running = true;
      this.loop = setInterval(() => this.spawn(), this.beatInterval);
    },

    spawn() {
      const side = Math.random() > 0.5 ? 'L' : 'R';
      const x = side === 'L' ? -0.8 : 0.8;
      const sphere = document.createElement('a-sphere');
      sphere.setAttribute('color', '#ff6ef0');
      sphere.setAttribute('radius', 0.25);
      sphere.setAttribute('position', `${x} 1.5 -4`);
      sphere.setAttribute('data-side', side);
      this.el.sceneEl.appendChild(sphere);
      this.targets.push(sphere);
    },

    hit(side) {
      const target = this.targets.find(t => t.getAttribute('data-side') === side);
      if (target) {
        EXO.beep(800);
        this.state.score += Math.round(80 * this.state.combo);
        this.state.combo += 0.1;
        this.scoreUI.innerText = this.state.score;
        this.comboUI.innerText = "x" + this.state.combo.toFixed(1);
        target.parentNode.removeChild(target);
        this.targets.splice(this.targets.indexOf(target), 1);
      }
    },

    pause() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Paused</h3>
        <button class="btn" onclick="location.reload()">Restart</button>
      `;
      this.overlay.style.display = "flex";
    },

    end() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Session Complete</h3>
        <p>Score: ${this.state.score}</p>
        <button class="btn" onclick="location.reload()">Restart</button>
        <a href="../index.html" class="btn">Exit</a>
      `;
      this.overlay.style.display = "flex";
    }
  });
  </script>

</body>
</html>
