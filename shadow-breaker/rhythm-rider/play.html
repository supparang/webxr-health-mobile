<script>
AFRAME.registerComponent('rhythm-game', {
  init(){
    this.scoreUI = document.getElementById('score');
    this.timeUI  = document.getElementById('time');
    const q = new URLSearchParams(location.search);
    this.diff = (q.get('diff')||'normal');
    this.bpm  = Math.max(60, parseInt(q.get('bpm')||'110',10));
    this.chartUrl = q.get('chart')||'';
    this.state = {running:false, score:0, notesLeft:0, nextBeat:0};
    this.msPerBeat = 60000/this.bpm;

    this.fv = new EXO_BOOST.FeverManager({need:12,dur:8000});
    this.dd = new EXO_BOOST.DynamicDifficulty({});

    EXO_safeStart(()=>this.start(), document.getElementById('overlay'), {
      title:'Rhythm Sync',
      note:`Diff: ${this.diff} · ${this.bpm} BPM`
    });
  },

  async start(){
    this.state.running=true;
    this.scoreUI.textContent='0';
    this.timeUI.textContent='—';

    // โหลด chart ถ้ามี ไม่งั้นสร้างสุ่ม
    let chart = null;
    if (this.chartUrl){
      try{ chart = await (await fetch(this.chartUrl)).json(); }catch(e){ chart=null; }
    }
    this.chart = Array.isArray(chart?.notes) ? chart.notes : this.makeRandomChart();
    this.state.notesLeft = this.chart.length;
    this.state.nextBeat = performance.now();

    // เริ่มเพลงถ้ามี param ?music=
    const music = new URLSearchParams(location.search).get('music');
    if (music && EXO.audio) EXO.audio.playMusic(music, {loop:false, volume:0.40});
  },

  makeRandomChart(){
    // ทำโน้ตแบบ 4 lane (L/R/Up/Down) ตาม BPM ~ 48-64 notes
    const lanes = ['L','R','U','D'];
    const n = {easy:48, normal:64, hard:84}[this.diff]||64;
    const arr=[];
    for(let i=0;i<n;i++){
      arr.push({lane: lanes[Math.floor(Math.random()*lanes.length)], beat:i});
    }
    return arr;
  },

  tick(t, dt){
    if(!this.state.running) return;
    this.fv.tick(dt);
    const now = performance.now();
    // สร้างโน้ตเมื่อถึงเวลา beat ถัดไป
    if (this.state.notesLeft>0 && now >= this.state.nextBeat){
      const idx = this.chart.length - this.state.notesLeft;
      this.spawnNote(this.chart[idx]);
      this.state.notesLeft--;
      this.state.nextBeat += this.msPerBeat * (this.dd.getSpeedMul? (1/this.dd.getSpeedMul()) : 1);
    }
    // ถ้าโน้ตหมด → จบเกมทันที (ตามที่คุย)
    if (this.state.notesLeft<=0 && document.querySelectorAll('.note').length===0){
      this.end();
    }
  },

  spawnNote(n){
    const xmap = {L:-0.9, R:0.9, U:0, D:0};
    const ym  = {L:1.2,  R:1.2, U:1.8, D:0.7};
    const laneX = xmap[n.lane] ?? 0;
    const laneY = ym[n.lane] ?? 1.2;

    const a = document.createElement('a-sphere');
    a.setAttribute('radius','0.22');
    a.setAttribute('color', n.lane==='U' ? '#ffd166' : n.lane==='D' ? '#06d6a0' : '#4cc9f0');
    a.setAttribute('position', `${laneX} ${laneY} -3.4`);
    a.classList.add('note');
    this.el.sceneEl.appendChild(a);

    const dur = 1400;
    a.setAttribute('animation__move',{property:'position', to:`${laneX} ${laneY} -0.15`, dur, easing:'linear'});

    setTimeout(()=>{ if(a.parentNode){ this.onMiss(); a.remove(); } }, dur+50);
  },

  onHit(quality='good'){
    if(!this.state.running) return;
    const plus = {perfect:200, good:130, okay:80}[quality]||100;
    const s = this.fv.mulScore ? this.fv.mulScore(plus) : plus;
    this.state.score += s;
    this.scoreUI.textContent = this.state.score;
    this.dd.onHit&&this.dd.onHit(); this.fv.hit&&this.fv.hit();
    EXO.beep(quality==='perfect'?1000:820,0.05,0.12);
  },

  onMiss(){
    this.dd.onMiss&&this.dd.onMiss(); this.fv.miss&&this.fv.miss();
    EXO.beep(260,0.06,0.12);
  },

  end(){
    if(!this.state.running) return;
    this.state.running=false;
    const p=document.getElementById('panel'), o=document.getElementById('overlay');
    o.style.display='flex';
    p.innerHTML=`<div class="title">Result</div>
      <div class="kpi"><div>Score</div><b>${this.state.score}</b></div>
      <div style="text-align:center;margin-top:.6rem">
        <a class="btn" href="../index.html">⟵ Back</a>
        <a class="btn" onclick="location.reload()">↺ Replay</a>
      </div>`;
  }
});

AFRAME.registerComponent('rhythm-input',{
  init(){
    const g = document.querySelector('[rhythm-game]').components['rhythm-game'];
    EXO.attachBasicInput({
      onLeft: ()=> g && g.onHit('good'),
      onRight:()=> g && g.onHit('good'),
      onPause: ()=>{}
    });
  }
});
</script>
