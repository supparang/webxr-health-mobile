<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>EXO · Combat Reflex — Elite Punch Protocol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- EXO Core -->
  <link rel="stylesheet" href="../core/exo-ui.css" />
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-boost.js"></script>
  <style>
    .badge{display:inline-block;padding:2px 8px;border:1px solid #1a315a;border-radius:8px;background:#0b1325;color:#cfe1ff;font-size:12px}
    .tut-ctrl{display:flex;gap:.5rem;justify-content:center;margin-top:.6rem;flex-wrap:wrap}
  </style>
</head>
<body>
  <!-- HUD -->
  <header class="hud">
    <div class="box"><span class="badge">COMBAT REFLEX</span></div>
    <div class="box"><span id="score">0</span></div>
    <div class="box"><span id="time">60</span><a class="btn" href="../index.html">⟵ Hub</a></div>
    <div class="box"><span id="combo">Combo 0</span></div>
    <div class="box">
      <div style="width:160px;height:8px;border:1px solid #1a315a;border-radius:8px;overflow:hidden;background:#0b1325">
        <div id="feverBar" style="height:100%;width:0%;background:#f59e0b"></div>
      </div>
    </div>
    <div class="box"><span id="acc">Acc —</span></div>
    <div class="box"><span id="mission" class="badge">Mission: —</span></div>
  </header>

  <!-- Touch zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;"><div id="panel" class="panel"></div></div>

  <!-- Scene -->
  <a-scene>
    <a-entity light="type:ambient;intensity:0.8"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- Hit line -->
    <a-entity position="0 1.25 -0.2"><a-box width="2.2" height="0.02" depth="0.02" color="#4ade80"></a-box></a-entity>

    <!-- Player indicator -->
    <a-box id="player" color="#22c55e" depth="0.3" height="0.3" width="0.3" position="-0.8 1.2 -0.5"></a-box>

    <!-- Game -->
    <a-entity combat-game></a-entity>
    <a-entity combat-input></a-entity>

    <!-- Camera + sky -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity camera look-controls wasd-controls></a-entity>
    </a-entity>
    <a-sky color="#0b1120"></a-sky>
  </a-scene>

  <!-- Start Overlay (Start / Try Hit) -->
  <script>
  (function (w){
    function ensureOverlay(){
      let ov=document.getElementById('overlay'); if(!ov){ov=document.createElement('div'); ov.id='overlay'; ov.className='overlay'; document.body.appendChild(ov);}
      let pn=document.getElementById('panel'); if(!pn){pn=document.createElement('div'); pn.id='panel'; pn.className='panel'; ov.appendChild(pn);}
      return {ov,pn};
    }
    function showStart(opts={}){
      const {ov,pn}=ensureOverlay();
      ov.style.display='flex';
      pn.innerHTML=`
        <div class="title">${opts.title||'EXO TRAINING'}</div>
        ${opts.note?`<div class="muted" style="margin:.4rem 0">${opts.note}</div>`:''}
        <div class="tut-ctrl">
          <a class="btn" id="btnStart">▶ Start</a>
          <a class="btn" id="btnTry">🎯 Try Hit</a>
          <a class="btn" href="../index.html">⟵ Hub</a>
        </div>
        <div style="text-align:center;opacity:.7;margin-top:.4rem">Space/Enter เพื่อเริ่ม</div>`;

      async function unlockAudio(){ try{ await w.EXO?.audio?.ensure?.(); await w.EXO?.audio?.ctx?.resume?.(); }catch(e){} }

      const goStart = async ()=>{
        await unlockAudio();
        ov.style.display='none';
        if (typeof w.__startGame === 'function') w.__startGame();
        else window.dispatchEvent(new CustomEvent('exo-start'));
      };
      const goTry = async ()=>{
        await unlockAudio();
        ov.style.display='none';
        if (typeof w.__startPractice === 'function') w.__startPractice();
        else window.dispatchEvent(new CustomEvent('exo-try'));
      };

      document.getElementById('btnStart')?.addEventListener('click', goStart, {once:true});
      document.getElementById('btnTry')?.addEventListener('click', goTry,   {once:true});
      document.addEventListener('keydown', e=>{ if(e.code==='Space'||e.key==='Enter'){ goStart(); }});
    }

    w.EXO = w.EXO || {};
    w.EXO.startOverlay = w.EXO.startOverlay || function(onStart, opts){
      showStart(opts||{});
      window.addEventListener('exo-start', ()=>{ try{ onStart && onStart(); }catch(e){} }, {once:true});
    };
    w.EXO_safeStart = w.EXO_safeStart || ((onStart,_o,opts)=>{ try{ w.EXO.startOverlay(onStart,opts||{});}catch(e){ try{onStart&&onStart();}catch(_e){} }});

    // auto-show ถ้าไม่มีใครเรียก
    setTimeout(()=>{
      const ov=document.getElementById('overlay');
      if(!ov || ov.style.display==='none' || ov.style.display===''){
        const qs=new URLSearchParams(location.search);
        showStart({title:'Combat Reflex', note:`Diff: ${qs.get('diff')||'normal'} · Time: ${qs.get('time')||60}s`});
      }
    },300);
  })(window);
  </script>

  <!-- Game Script -->
  <script>
  AFRAME.registerComponent('combat-game',{
    init(){
      // รอ scene loaded ให้สมบูรณ์ก่อน
      this.scene = this.el.sceneEl;
      if (!this.scene.hasLoaded) this.scene.addEventListener('loaded', ()=>this._boot(), {once:true});
      else this._boot();
    },

    _boot(){
      // UI refs
      this.ui = {score:score,time:time,combo:combo,acc:acc,fever:feverBar,mission:mission,panel:panel,overlay:overlay};

      // Params
      const q=new URLSearchParams(location.search);
      this.diff=(q.get('diff')||'normal');
      this.totalTime=Math.max(10, parseInt(q.get('time')||'60',10));

      // State
      this.state={
        running:false, practice:false,
        time:this.totalTime, score:0, combo:0, maxCombo:0, hit:0, miss:0,
        fever:0, feverOn:false, lastSpawn:0, hpTap:{},
        spawnIvBase:{easy:780,normal:620,hard:480}[this.diff]||620,
        rush:false, rushUntil:0,
        mission:null, missionOk:false, missionProg:0,
        practiceHits:0
      };
      this.lanes={L:-0.8,R:0.8};

      // Systems
      this.dd=new (window.EXO_BOOST?.DynamicDifficulty||function(){return{tickDecay(){},onHit(){},onMiss(){},getSpeedMul(){return 1},getSpawnIv(){return null}}})();
      this.fv=new (window.EXO_BOOST?.FeverManager||function(){return{tick(){},hit(){},miss(){},mulScore(v){return v}}})({need:10,dur:8000});

      // Patterns
      this.patterns=[
        {n:4,lanes:['L','R','L','R'],jitter:0},
        {n:6,lanes:['L','R'],jitter:80},
        {n:5,lanes:['L'],jitter:60},
        {n:5,lanes:['R'],jitter:60},
        {n:8,lanes:['L','R','L','R','R','L','L','R'],jitter:0},
        {n:6,lanes:['L','L','R','R','L','R'],jitter:40}
      ];
      this._patternQueue=[];

      // Hook ปุ่มจาก overlay
      window.__startGame = ()=>this.start();
      window.__startPractice = ()=>this.startPractice();
      window.addEventListener('exo-try',  ()=> this.startPractice(), { once:false });
      window.addEventListener('exo-start',()=> this.start(),         { once:false });

      // แสดง overlay เริ่ม
      EXO_safeStart(()=>this.start(), this.ui.overlay, {
        title:'Combat Reflex — Elite Punch Protocol',
        note:`Diff: ${this.diff} · Time: ${this.totalTime}s`
      });

      // rAF guard: ถ้าหายเงียบ 800ms ให้ spawn
      const guard = ()=>{
        if (this.state.running || this.state.practice){
          const gap = performance.now() - this.state.lastSpawn;
          if (gap>800 && !document.querySelector('.note')){
            const lane=(Math.random()<0.5)?'L':'R';
            this.spawnTarget(lane,'normal');
            this.state.lastSpawn=performance.now();
          }
        }
        this._rafGuard = requestAnimationFrame(guard);
      };
      this._rafGuard = requestAnimationFrame(guard);
    },

    /* ===== Practice (Try Hit) ===== */
    startPractice(){
      const s=this.state;
      s.practice=true; s.running=false; s.practiceHits=0;
      this.clearTimers();
      this.ui.overlay.style.display='none';

      // Burst ทันที 3 ลูกแรก
      requestAnimationFrame(()=>{
        this.spawnBurst(3, 2400, 'practice');
        // Safety: ถ้า 0.5s ไม่มีเป้า ให้สปอว์นเพิ่ม
        this.practiceTimer = setInterval(()=>{
          if(!s.practice) return;
          if(!document.querySelector('.note')) this.spawnBurst(1, 2200, 'practice');
        }, 500);
      });
    },
    finishPractice(){ this.state.practice=false; this.clearTimers(); document.querySelectorAll('.note').forEach(n=>n.remove()); this.start(); },
    quitPractice(){ this.state.practice=false; this.clearTimers(); document.querySelectorAll('.note').forEach(n=>n.remove()); EXO.startOverlay(()=>this.start(),{title:'Combat Reflex',note:'พร้อมเริ่มแล้ว'}); },

    /* ===== Game ===== */
    start(){
      const s=this.state;
      s.practice=false; s.running=true;
      s.time=this.totalTime; s.score=0; s.combo=0; s.maxCombo=0; s.hit=0; s.miss=0; s.fever=0; s.feverOn=false;
      s.lastSpawn=0;
      this.pickMission(); this.refreshUI(); this.clearTimers();

      // เดินเวลา
      this.timer=setInterval(()=>{ if(!s.running) return; s.time--; this.ui.time.textContent=s.time; if(s.time<=0) this.end(); }, 1000);

      // Rush รอบแรก
      this.nextRushAt=performance.now()+6000;

      // Burst เริ่มเกมทันที 4 ลูก
      this.spawnBurst(4, Math.max(1200, 2000), 'normal');

      // Safety spawner (interval)
      this.spawnGuard=setInterval(()=>{
        if(!s.running) return;
        if (!document.querySelector('.note') && (performance.now()-s.lastSpawn>500)){
          const lane=(Math.random()<0.5)?'L':'R';
          this.spawnTarget(lane, this.rollType());
          s.lastSpawn=performance.now();
        }
      }, 400);
    },

    clearTimers(){ clearInterval(this.timer); clearInterval(this.practiceTimer); clearInterval(this.spawnGuard); },
    remove(){ this.clearTimers(); cancelAnimationFrame(this._rafGuard); },

    tick(t,dt){
      const s=this.state;
      if(s.practice || !s.running) return;

      this.dd.tickDecay(dt); this.fv.tick(dt);
      this.ui.fever.style.width=Math.min(100,s.fever|0)+'%';

      const now=performance.now();

      // Rush windows
      if(!s.rush && now>=this.nextRushAt){ s.rush=true; s.rushUntil=now+7000; }
      if(s.rush && now>=s.rushUntil){ s.rush=false; this.nextRushAt=now+18000; }

      // Spawn cadence
      const dynIv=this.dd.getSpawnIv?this.dd.getSpawnIv():null;
      let baseIv=dynIv||s.spawnIvBase; baseIv -= Math.min(120, s.combo*2); if(s.rush) baseIv*=0.7;
      const spawnIv=Math.max(220, baseIv);

      if(this._patternQueue.length){
        const top=this._patternQueue[0];
        if(now>=top.next){
          this.spawnTarget(top.laneSeq[top.i%top.laneSeq.length], top.type);
          top.i++; if(top.i>=top.n){ this._patternQueue.shift(); }
          else { top.next=now+top.step+(top.jitter?(Math.random()*top.jitter|0):0); }
        }
        this.updateMissionTimer(dt); return;
      }
      if(now - s.lastSpawn >= spawnIv){
        s.lastSpawn = now;
        if(Math.random()<0.35){
          const p=this.patterns[(Math.random()*this.patterns.length)|0];
          const type=this.rollType(); const step=Math.max(160, spawnIv*0.5);
          const lanes=[]; for(let i=0;i<p.n;i++) lanes.push(p.lanes[i%p.lanes.length]);
          this._patternQueue.push({i:0,n:p.n,step,jitter:p.jitter,laneSeq:lanes,type,next:now});
          this.spawnTarget(lanes[0], type);
        }else{
          const lane=(Math.random()<0.5)?'L':'R'; this.spawnTarget(lane, this.rollType());
        }
      }
      this.updateMissionTimer(dt);
    },

    // ---- helpers ----
    spawnBurst(n=3, dur=2000, mode='normal'){
      const lanes=['L','R']; const step=180;
      for(let i=0;i<n;i++){
        setTimeout(()=>{
          const lane=lanes[(i%2)];
          const type = (mode==='practice') ? 'normal' : this.rollType();
          this.spawnTarget(lane, type, dur);
          this.state.lastSpawn=performance.now();
        }, i*step);
      }
    },

    rollType(){ const r=Math.random(); if(r<0.07) return 'armored'; if(r<0.16) return 'bomb'; if(r<0.30) return 'golden'; if(r<0.38) return 'timeorb'; return 'normal'; },

    spawnTarget(lane,type,durOverride){
      const x=(lane==='L')?-0.8:0.8, y=1.25, zStart=-3.8;
      const speedMul=(this.dd.getSpeedMul?this.dd.getSpeedMul():1)*(this.state.rush?1.15:1);
      const dur=Math.max(900, (durOverride||2000)/speedMul);

      const el=document.createElement('a-box');
      el.setAttribute('width','0.35'); el.setAttribute('height','0.35'); el.setAttribute('depth','0.35');
      el.setAttribute('position',`${x} ${y} ${zStart}`); el.classList.add('note'); el.dataset.lane=lane; el.dataset.type=type;
      el.setAttribute('color', type==='golden'?'#fbbf24': type==='bomb'?'#ef4444': type==='armored'?'#60a5fa': type==='timeorb'?'#34d399':'#29b6f6');
      this.el.sceneEl.appendChild(el);
      el.setAttribute('animation__move',{property:'position', to:`${x} ${y} -0.2`, dur, easing:'linear'});

      // miss timeout (เฉพาะโหมดเกม)
      setTimeout(()=>{ if(!el.parentNode) return; if(!this.state.practice){ this.onMiss(); } el.remove(); }, dur+60);
    },

    onHit(){
      const notes=[...document.querySelectorAll('.note')]; let best=null,dist=1e9;
      for(const n of notes){ const p=n.getAttribute('position'); if(!p) continue; const d=Math.abs(p.z-(-0.2)); if(d<dist){best=n;dist=d;} }
      if(!best || dist>0.28){ if(!this.state.practice) this.badTap(); return; }
      const type=best.dataset.type||'normal';

      // Practice: โดนครบ 3 → start เกมจริง
      if(this.state.practice){
        this.state.practiceHits++; best.remove();
        if(this.state.practiceHits>=3){ this.finishPractice(); }
        return;
      }

      // Armored
      if(type==='armored'){
        const id=best.object3D.uuid;
        const hp=(this.state.hpTap[id]||2)-1; this.state.hpTap[id]=hp;
        if(hp>0){ return; }
      }
      // Bomb
      if(type==='bomb'){
        this.addScore(-220); this.breakCombo(); best.remove(); this.updateMissionOn('miss'); return;
      }
      // Time orb
      if(type==='timeorb'){
        this.state.time=Math.min(this.totalTime+30, this.state.time+5);
        this.ui.time.textContent=this.state.time;
        this.addScore(120); this.state.combo++; this.state.hit++; best.remove(); this.updateMissionOn('hit','okay'); this.refreshUI(); return;
      }

      // คุณภาพตามระยะ
      let q='okay'; if(dist<=0.06) q='perfect'; else if(dist<=0.14) q='good';
      const base={perfect:190,good:130,okay:85}[q]; const bonus=(type==='golden')?120:0;
      let plus=base+bonus;
      if(this.state.rush) plus=Math.round(plus*1.1);
      if(!this.state.feverOn){
        this.state.fever=Math.min(100, this.state.fever + (q==='perfect'?3:q==='good'?2:1));
        if(this.state.fever>=100){ this.state.feverOn=true; setTimeout(()=>{ this.state.feverOn=false; this.state.fever=0; },7000); }
      }
      this.addScore(plus);
      this.state.combo++; this.state.maxCombo=Math.max(this.state.maxCombo,this.state.combo);
      this.state.hit++; best.remove(); this.updateMissionOn('hit',q); this.refreshUI();
    },

    badTap(){ this.breakCombo(); this.addScore(-70); this.refreshUI(); },
    onMiss(){ this.state.miss++; this.breakCombo(); this.refreshUI(); },
    breakCombo(){ this.state.combo=0; },
    addScore(v){ if(this.state.feverOn && v>0) v=Math.round(v*1.5); this.state.score=Math.max(0,(this.state.score|0)+v); this.ui.score.textContent=this.state.score; },

    refreshUI(){
      this.ui.combo.textContent='Combo '+this.state.combo;
      const tot=this.state.hit+this.state.miss; const acc=tot?Math.round(this.state.hit*1000/tot)/10:0;
      this.ui.acc.textContent=`Acc ${acc}%`; this.ui.fever.style.width=Math.min(100,this.state.fever)+'%';
      if(this.state.mission){ const m=this.state.mission; const txt=`${m.label} — ${Math.min(m.need,this.state.missionProg)} / ${m.need}`; this.ui.mission.textContent='Mission: '+txt+(this.state.missionOk?' ✅':''); }
    },

    // Missions (ย่อ)
    missionDefs:[
      {id:'combo',    text:(n)=>`Combo ≥ ${n}`,        need:()=>({need: 20})},
      {id:'perfects', text:(n)=>`Perfect ${n} ครั้ง`,  need:()=>({need: 10})},
      {id:'streak',   text:(n)=>`ไม่พลาด ${n}s`,      need:()=>({need: 8, timer:true})},
      {id:'score',    text:(n)=>`ทำคะแนน +${n}`,      need:()=>({need: 1500})}
    ],
    pickMission(){ const def=this.missionDefs[(Math.random()*this.missionDefs.length)|0]; const cfg=def.need(); const label=def.text(cfg.need); this.state.mission={id:def.id,label,need:cfg.need,timer:!!cfg.timer}; this.state.missionProg=0; this.state.missionOk=false; this._streakClock=0; this.ui.mission.textContent='Mission: '+label; },
    updateMissionTimer(dt){ const m=this.state.mission; if(!m) return; if(m.id==='streak'){ if(this.state.combo>0){ this._streakClock += dt/1000; } else { this._streakClock=0; } this.state.missionProg=Math.max(0, Math.min(m.need, Math.floor(this._streakClock))); if(!this.state.missionOk && this.state.missionProg>=m.need){ this.state.missionOk=true; this.addScore(400); } } this.refreshUI(); },

    end(){
      this.state.running=false; this.clearTimers();
      const p=this.ui.panel, o=this.ui.overlay;
      const tot=this.state.hit+this.state.miss; const acc=tot?Math.round(this.state.hit*1000/tot)/10:0;
      const rank=(acc>=95 && this.state.maxCombo>=40)?'SS':(acc>=90 && this.state.maxCombo>=30)?'S':(acc>=80)?'A':(acc>=70)?'B':'C';
      o.style.display='flex';
      p.innerHTML=`
        <div class="title">Result — Elite Punch Protocol</div>
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div><div>Score</div><b>${this.state.score}</b></div>
          <div><div>Max Combo</div><b>${this.state.maxCombo}</b></div>
          <div><div>Accuracy</div><b>${acc}%</b></div>
        </div>
        <div style="text-align:center;margin-top:.6rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap">
          <a class="btn" href="../index.html">⟵ Back</a>
          <a class="btn" onclick="location.reload()">↺ Replay</a>
        </div>`;
    }
  });

  // Input
  AFRAME.registerComponent('combat-input',{
    init(){
      const comp=document.querySelector('[combat-game]').components['combat-game'];
      (window.EXO && EXO.attachBasicInput) ? EXO.attachBasicInput({
        onLeft: ()=> comp && comp.onHit(),
        onRight:()=> comp && comp.onHit(),
        onPause: ()=>{}
      }) : window.addEventListener('keydown', e=>{
        if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') comp && comp.onHit();
        if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'||e.code==='Space') comp && comp.onHit();
      });
    }
  });
  </script>
</body>
</html>
