<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EXO · Combat Reflex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <link rel="stylesheet" href="../core/exo-ui.css">
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn">⏸</button>
      <a href="../index.html" class="btn">⟵ Exit</a>
    </div>
  </div>

  <!-- Touch areas -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="panel" class="panel"></div>
  </div>

  <!-- Scene -->
  <a-scene>
    <a-entity light="type:ambient;intensity:0.7"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- Camera -->
    <a-entity id="rig">
      <a-entity camera position="0 1.6 0"></a-entity>
    </a-entity>

    <!-- Game Manager -->
    <a-entity id="game" combat-game></a-entity>
  </a-scene>

  <script>
  AFRAME.registerComponent('combat-game', {
    init() {
      // DOM refs
      this.scoreUI = document.getElementById('score');
      this.comboUI = document.getElementById('combo');
      this.timeUI  = document.getElementById('time');
      this.overlay = document.getElementById('overlay');
      this.panel   = document.getElementById('panel');

      // Game state
      this.state = { score: 0, combo: 1.0, time: 60, running: false };
      this.targets = [];
      this.spawnTimer = 0.6;

      // Start overlay
      EXO.startOverlay(() => this.start());

      // Input
      EXO.attachBasicInput({
        onLeft:  () => this.hit('L'),
        onRight: () => this.hit('R'),
        onPause: () => this.pause()
      });

      // Pause button
      document.getElementById('btnPause').onclick = () => this.pause();

      // Spawn loop
      this.spawnInterval = setInterval(() => {
        if (!this.state.running) return;
        this.spawn();
      }, 600);

      // Countdown timer
      this.timer = setInterval(() => {
        if (!this.state.running) return;
        this.state.time--;
        this.timeUI.innerText = this.state.time;
        if (this.state.time <= 0) this.end();
      }, 1000);
    },

    start() {
      this.state.running = true;
    },

    spawn() {
      const side = Math.random() < 0.5 ? 'L' : 'R';
      const x = side === 'L' ? -0.8 : 0.8;
      const target = document.createElement('a-box');
      target.setAttribute('color', '#4fc3f7');
      target.setAttribute('depth', 0.3);
      target.setAttribute('height', 0.3);
      target.setAttribute('width', 0.3);
      target.setAttribute('position', `${x} 1.5 -4`);
      target.setAttribute('data-side', side);
      this.el.sceneEl.appendChild(target);
      this.targets.push(target);
    },

    hit(side) {
      if (!this.state.running) return;

      let target = this.targets.find(t => t.getAttribute('data-side') === side);
      if (target) {
        EXO.beep();
        this.state.score += Math.round(100 * this.state.combo);
        this.state.combo += 0.1;
        this.scoreUI.innerText = this.state.score;
        this.comboUI.innerText = "x" + this.state.combo.toFixed(1);
        target.parentNode.removeChild(target);
        this.targets.splice(this.targets.indexOf(target), 1);
      }
    },

    pause() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Paused</h3>
        <button class="btn" onclick="location.reload()">Restart</button>
      `;
      this.overlay.style.display = "flex";
    },

    end() {
      this.state.running = false;
      this.panel.innerHTML = `
        <h3>Session Complete!</h3>
        <p>Score: ${this.state.score}</p>
        <button class="btn" onclick="location.reload()">Restart</button>
        <a href="../index.html" class="btn">Exit</a>
      `;
      this.overlay.style.display = "flex";
    }
  });
  </script>

</body>
</html>
