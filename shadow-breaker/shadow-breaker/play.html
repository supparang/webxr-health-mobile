<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO · Combat Reflex (VS + LB + i18n: central)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- UI & Core -->
  <link rel="stylesheet" href="../core/exo-ui.css">
  <!-- ✅ โหลด i18n กลางก่อนใช้งาน -->
  <script src="../core/exo-i18n.js"></script>
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-metrics.js"></script>

  <!-- Settings + Leaderboard + VS -->
  <script src="../core/exo-settings.js"></script>
  <script src="../core/exo-leaderboard.js"></script>
  <script src="../core/exo-net.js"></script>

  <style>
    .vsHud{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:9}
    .vsHud .box{background:rgba(14,20,36,.85);border:1px solid #112848}
    .tagwin{color:#7ee787}.taglose{color:#ff7777}.tagtie{color:#ffd166}
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <span id="score">0</span>
      <span id="combo">x1.0</span>
    </div>
    <div class="box">
      <span id="time">60</span>
      <button id="btnPause" class="btn" title="Pause">⏸</button>
      <a href="../index.html" class="btn">⟵ <span data-i18n="common.hub">Hub</span></a>
    </div>
  </div>

  <!-- Touch zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- VS HUD (เปิดเมื่อ ?vs=1) -->
  <div id="vsHud" class="vsHud" style="display:none">
    <div class="box">
      <span id="lblOpp" data-i18n="common.opponent">Opponent</span>
      <span id="oppConn">⏳</span> — 
      <span id="lblScore" data-i18n="common.score">Score</span> <b id="oppScore">0</b> |
      <span id="oppCombo">x1.0</span>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div id="panel" class="panel"></div>
  </div>

  <!-- Scene -->
  <a-scene renderer="antialias:true; colorManagement:true">
    <a-entity light="type:ambient;intensity:.7;color:#88aaff"></a-entity>
    <a-entity light="type:directional;intensity:.9" position="0 3 2"></a-entity>

    <!-- ห้อง -->
    <a-entity geometry="primitive: box; depth: 22; height: 6; width: 12" position="0 3 -7"
              material="color: #0c1428; side: back; metalness:0.1; roughness:0.9"></a-entity>
    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4"
             material="color:#0f1b33; metalness:.35; roughness:.4"></a-plane>
    <!-- เส้น Hit Line -->
    <a-entity geometry="primitive: box; depth: .02; height: .02; width: 12" position="0 0.01 -0.5"
              material="color:#3B82F6; emissive:#3B82F6; emissiveIntensity:.8"></a-entity>

    <!-- Director -->
    <a-entity combat-director></a-entity>
  </a-scene>

<script>
AFRAME.registerComponent('combat-director', {
  init(){
    // ===== i18n (ศูนย์กลาง) =====
    const lang = EXO_I18N.get();               // 'th' | 'en'
    const tC   = EXO_I18N.scope('common');     // common texts
    const tMod = EXO_I18N.scope('combat');     // combat-specific

    // ===== Refs =====
    this.$s = document.getElementById('score');
    this.$c = document.getElementById('combo');
    this.$t = document.getElementById('time');
    this.overlay = document.getElementById('overlay');
    this.panel   = document.getElementById('panel');

    // ===== Query & VS =====
    const q = new URLSearchParams(location.search);
    const diff = (q.get('diff')||'normal').toLowerCase();
    const music = q.get('music');
    const timeParam = Math.max(10, +(q.get('time')||60));
    this.isVS = q.get('vs') === '1';

    // ===== VS HUD =====
    if (this.isVS) {
      this.$vsHud   = document.getElementById('vsHud');
      this.$oppConn = document.getElementById('oppConn');
      this.$oppScore= document.getElementById('oppScore');
      this.$oppCombo= document.getElementById('oppCombo');
      this.$vsHud.style.display = 'block';

      this.opp = {score:0, combo:1.0, isOver:false};
      EXO_NET.onState(st => { this.$oppConn.textContent = (st==='connected'?'✅':'⏳'); });
      EXO_NET.onMessage(msg => {
        if (msg?.type==='state') {
          this.opp.score = msg.score|0;
          this.opp.combo = +msg.combo || 1.0;
          this.$oppScore.textContent = this.opp.score;
          this.$oppCombo.textContent = 'x' + this.opp.combo.toFixed(1);
        }
        if (msg?.type==='over') {
          this.opp.isOver = true;
          this.opp.score  = msg.score|0;
          this.$oppScore.textContent = this.opp.score;
        }
      });
    }

    // ===== Difficulty presets =====
    const DIFF = {
      easy:   { speed: 3.8, spawnIv: 650, hitWin: 0.28, decoy: 0.10 },
      normal: { speed: 4.8, spawnIv: 550, hitWin: 0.22, decoy: 0.20 },
      hard:   { speed: 6.0, spawnIv: 430, hitWin: 0.16, decoy: 0.35 }
    };
    this.cfg = DIFF[diff] || DIFF.normal;

    // ===== State =====
    this.state = {
      score: 0, combo: 1.0, maxCombo: 1.0,
      time: timeParam, running: false,
      cntHit: 0, cntMiss: 0
    };
    this.$t.textContent = this.state.time;

    // ===== Gameplay space =====
    this.spawnZ = -4.5;
    this.hitZ   = -0.5;
    this.laneX  = { L:-0.8, R:0.8 };
    this.pool   = [];
    for (let i=0;i<18;i++) this.pool.push(this.mkTarget(this.el.sceneEl));

    // ===== Tutorial + Start =====
    EXO.startOverlay(()=> this.start(), {
      title: tMod('title') + (this.isVS ? ' · ' + tC('vs') : ''),
      howto: [
        { title: lang==='th'?'เป้าหมาย':'Goal',         text: tMod('goal') },
        { title: lang==='th'?'การบังคับ':'Controls',     html: tMod('ctrl') },
        { title: lang==='th'?'การได้คะแนน':'Scoring',    text: tMod('scoreTip') }
      ],
      note: `${tC('diff')}: <b>${diff.toUpperCase()}</b>${music?' · '+tC('music')+': on':''}${this.isVS?' · '+tC('vs'):''}`
    });

    // ===== Input =====
    EXO.attachBasicInput({
      onLeft:  () => this.tryHit('L'),
      onRight: () => this.tryHit('R'),
      onPause: () => this.pause()
    });
    document.getElementById('btnPause').onclick = () => this.pause();

    // ===== Music (optional) =====
    if (music) { try{ EXO.audio.playMusic(music, {loop:true, volume:0.35}); }catch(e){} }

    // ===== Countdown =====
    this.timer = setInterval(()=>{
      if (!this.state.running) return;
      this.state.time--;
      this.$t.textContent = this.state.time;
      if (this.state.time <= 0) this.end();
    }, 1000);
  },

  mkTarget(scene){
    const e=document.createElement('a-entity');
    e.setAttribute('visible', false);
    e.userData = { alive:false, side:'L', vz:0, isDecoy:false };
    const inner=document.createElement('a-entity');
    inner.setAttribute('geometry','primitive: box; depth:0.35; height:0.35; width:0.35');
    inner.setAttribute('material','color:#9ecbff; emissive:#2a6fb5; emissiveIntensity:.25');
    e.appendChild(inner);
    scene.appendChild(e);
    return e;
  },

  start(){
    this.state.running = true;
    this.spawnLoop = setInterval(()=> this.spawn(), this.cfg.spawnIv);
  },

  spawn(){
    if (!this.state.running) return;
    const e = this.pool.find(o=>!o.userData.alive); if (!e) return;

    const side = Math.random()<0.5 ? 'L' : 'R';
    const isDecoy = Math.random()<this.cfg.decoy;

    e.userData.alive   = true;
    e.userData.side    = side;
    e.userData.isDecoy = isDecoy;
    e.userData.vz      = this.cfg.speed + (Math.random()*0.8 - 0.4);
    e.object3D.position.set(this.laneX[side], 1.4, this.spawnZ);

    const inner = e.children[0];
    if (isDecoy){
      inner.setAttribute('material','color:#ff8a80; emissive:#8a2b2b; emissiveIntensity:.35');
    } else {
      inner.setAttribute('material','color:#9ecbff; emissive:#2a6fb5; emissiveIntensity:.25');
    }
    e.setAttribute('visible', true);
  },

  tryHit(side){
    if (!this.state.running) return;
    const best = this.findBest(side);
    if (!best) return;

    const dz = Math.abs(best.object3D.position.z - this.hitZ);

    if (dz <= this.cfg.hitWin){
      if (best.userData.isDecoy){
        this.state.combo = 1.0; this.$c.textContent='x1.0';
        this.state.score = Math.max(0, this.state.score - 100);
        this.$s.textContent = this.state.score;
        EXO.beep(220, 0.06, 0.15);
      } else {
        this.state.cntHit++;
        const quality = dz<=this.cfg.hitWin*0.4 ? 1.0 : dz<=this.cfg.hitWin*0.7 ? 0.7 : 0.4;
        this.state.score += Math.round(120 * quality * this.state.combo);
        this.state.combo = Math.min(5.0, this.state.combo + 0.2);
        this.state.maxCombo = Math.max(this.state.maxCombo, this.state.combo);
        this.$s.textContent = this.state.score;
        this.$c.textContent = 'x' + this.state.combo.toFixed(1);
        EXO.beep(540, 0.04, 0.12);
      }

      best.setAttribute('visible', false);
      best.userData.alive = false;
    } else {
      this.state.combo = 1.0; this.$c.textContent = 'x1.0';
    }

    // ส่งสถานะ VS ทุกครั้งที่มีอัปเดต
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'state', score:this.state.score|0, combo:+this.state.combo});
    }
  },

  findBest(side){
    let best=null, dzBest=1e9;
    for (const e of this.pool){
      if (!e.userData.alive) continue;
      if (e.userData.side !== side) continue;
      const dz = Math.abs(e.object3D.position.z - this.hitZ);
      if (dz < dzBest){ dzBest = dz; best = e; }
    }
    return best;
  },

  pause(){
    if (!this.state.running) return;
    const tC = EXO_I18N.scope('common');
    this.state.running = false;
    try{ EXO.audio.stopMusic(); }catch(e){}

    this.panel.innerHTML = `
      <div class="title">${tC('paused')}${this.isVS?' · '+tC('vs'):''}</div>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <a class="btn" onclick="location.reload()">⟲ ${tC('restart')}</a>
        <a class="btn" href="../index.html">⟵ ${tC('hub')}</a>
      </div>`;
    this.overlay.style.display='flex';
  },

  tick: function(time, dt){
    if (!this.state?.running) return;
    const dtS = dt/1000;
    for (const e of this.pool){
      if (!e.userData.alive) continue;
      const p = e.object3D.position;
      p.z += e.userData.vz * dtS;

      if (p.z > 0.2){
        if (!e.userData.isDecoy){
          this.state.cntMiss++;
          this.state.combo = 1.0; this.$c.textContent = 'x1.0';
        }
        e.setAttribute('visible', false);
        e.userData.alive = false;
      }
    }
  },

  end(){
    const tC = EXO_I18N.scope('common');
    const tMod = EXO_I18N.scope('combat');

    this.state.running = false;
    clearInterval(this.timer);
    clearInterval(this.spawnLoop);

    // Metrics
    try{
      const duration = +(new URLSearchParams(location.search).get('time') || this.state.time || 60);
      const total = (this.state.cntHit||0) + (this.state.cntMiss||0);
      const hitRate = total>0 ? (this.state.cntHit/total)*100 : 0;

      EXO_METRICS.recordSession({
        module: 'Combat Reflex',
        diff: (new URLSearchParams(location.search).get('diff')||'normal'),
        score: this.state.score||0,
        accuracy: Math.round(hitRate*10)/10,
        hits: this.state.cntHit||0,
        misses: this.state.cntMiss||0,
        duration
      });
    }catch(e){}

    try{ EXO.audio.stopMusic(); }catch(e){}

    // ส่งผลให้คู่แข่ง (ถ้า VS)
    if (this.isVS && EXO_NET.connected()){
      EXO_NET.send({type:'over', score:this.state.score|0});
    }

    const total=(this.state.cntHit||0)+(this.state.cntMiss||0);
    const hitRateStr = total>0 ? ((this.state.cntHit/total)*100).toFixed(1) : '0.0';

    // Result UI (+ VS verdict เมื่อทราบสกอร์คู่แข่ง)
    const makeResultHTML = (oppKnown=false)=>{
      let verdict = '';
      if (this.isVS && oppKnown){
        if (this.state.score > (this.opp?.score||0)) verdict = `<div class="tagwin"><b>${tC('youWin')}</b></div>`;
        else if (this.state.score < (this.opp?.score||0)) verdict = `<div class="taglose"><b>${tC('youLose')}</b></div>`;
        else verdict = `<div class="tagtie"><b>${tC('tie')}</b></div>`;
      }
      return `
        <div class="title">${tC('result')} — Combat Reflex ${this.isVS?'· '+tC('vs'):''}</div>
        ${verdict}
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div>${tC('score')}<br><b>${this.state.score}</b></div>
          <div>${tC('maxCombo')}<br><b>${this.state.maxCombo.toFixed(1)}×</b></div>
          <div>${tMod('hitRate')}<br><b>${hitRateStr}%</b></div>
        </div>
        ${this.isVS ? `
        <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
          <div>${tC('oppScore')}<br><b id="oppScoreFinal">${this.opp?.score||0}</b></div>
          <div>${tC('oppStatus')}<br><b id="oppStatus">${this.opp?.isOver?tC('finished'):tC('pending')}</b></div>
        </div>` : ``}
        <div style="display:flex;gap:.6rem;justify-content:center">
          <a class="btn" onclick="location.reload()">⟲ ${tC('restart')}</a>
          <a class="btn" href="../index.html">⟵ ${tC('hub')}</a>
        </div>`;
    };

    this.panel.innerHTML = makeResultHTML(this.isVS ? this.opp?.isOver : false);
    this.overlay.style.display='flex';

    // ถ้า VS: รอฟังผลคู่แข่งหลังจอผล
    if (this.isVS && !this.opp?.isOver){
      const handler = (msg)=>{
        if (msg?.type==='over'){
          this.opp.isOver = true; this.opp.score = msg.score|0;
          const sF=document.getElementById('oppScoreFinal'); if(sF) sF.textContent=this.opp.score;
          const sS=document.getElementById('oppStatus'); if(sS) sS.textContent=tC('finished');
          this.panel.innerHTML = makeResultHTML(true);
        }
      };
      EXO_NET.onMessage(handler);
      setTimeout(()=>{ const sS=document.getElementById('oppStatus'); if (sS && !this.opp.isOver) sS.textContent=tC('pending'); }, 5000);
    }

    // ===== Online Leaderboard (Auto Submit: ถามชื่อแล้วส่ง) =====
    setTimeout(async ()=>{
      try{
        const name = prompt(tC('askName'),'');
        if (!name) return;

        await EXO_LB.submit({
          name,
          module: 'Combat Reflex',
          score: this.state.score|0,
          accuracy: parseFloat(hitRateStr),
          diff: (new URLSearchParams(location.search).get('diff')||'normal')
        });

        // แจ้งยืนยัน
        const ok = document.createElement('div');
        ok.className = 'kpi';
        ok.style.cssText = 'margin-top:8px;text-align:center';
        ok.innerHTML = `<div style="grid-column:1/-1"><b>${tC('sent')}</b></div>`;
        this.panel.appendChild(ok);
      }catch(e){ console.warn('LB submit failed', e); }
    }, 300);

    // Workout Program: ไปต่ออัตโนมัติถ้ามี next=
    const nextURL = new URLSearchParams(location.search).get('next');
    if (nextURL) { setTimeout(()=> location.href = nextURL, 1500); }
  }
});
</script>

</body>
</html>
