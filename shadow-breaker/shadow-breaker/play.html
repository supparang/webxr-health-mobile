<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>EXO ¬∑ Combat Reflex ‚Äî Elite Punch Protocol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- EXO Core -->
  <link rel="stylesheet" href="../core/exo-ui.css" />
  <script src="../core/exo-core.js"></script>
  <script src="../core/exo-boost.js"></script>
  <style>
    .badge{display:inline-block;padding:2px 8px;border:1px solid #1a315a;border-radius:8px;background:#0b1325;color:#cfe1ff;font-size:12px}
    .tut-img{display:flex;justify-content:center;align-items:center;height:140px;border:1px dashed #21406f;border-radius:10px;background:rgba(16,25,46,.6);margin:.5rem 0}
    .tut-ctrl{display:flex;gap:.5rem;justify-content:center;margin-top:.6rem;flex-wrap:wrap}
  </style>
</head>
<body>

  <!-- HUD -->
  <header class="hud">
    <div class="box"><span class="badge">COMBAT REFLEX</span></div>
    <div class="box"><span id="score">0</span></div>
    <div class="box"><span id="time">60</span><a class="btn" href="../index.html">‚üµ Hub</a></div>
    <div class="box"><span id="combo">Combo 0</span></div>
    <div class="box">
      <div style="width:160px;height:8px;border:1px solid #1a315a;border-radius:8px;overflow:hidden;background:#0b1325">
        <div id="feverBar" style="height:100%;width:0%;background:#f59e0b"></div>
      </div>
    </div>
    <div class="box"><span id="acc">Acc ‚Äî</span></div>
    <div class="box"><span id="mission" class="badge">Mission: ‚Äî</span></div>
  </header>

  <!-- Touch zones -->
  <div id="touchL" class="touch"></div>
  <div id="touchR" class="touch"></div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none;"><div id="panel" class="panel"></div></div>

  <!-- Scene -->
  <a-scene>
    <a-entity light="type:ambient;intensity:0.8"></a-entity>
    <a-entity light="type:directional;intensity:1" position="0 3 -2"></a-entity>

    <!-- Arena / Hit line -->
    <a-ring radius-inner="1.15" radius-outer="1.25" color="#1e3a8a" position="0 1.22 -0.2" rotation="-90 0 0" opacity="0.35"></a-ring>
    <a-entity position="0 1.25 -0.2"><a-box width="2.2" height="0.02" depth="0.02" color="#4ade80"></a-box></a-entity>

    <!-- Player indicator -->
    <a-box id="player" color="#22c55e" depth="0.3" height="0.3" width="0.3" position="-0.8 1.2 -0.5"></a-box>

    <!-- Game Entities -->
    <a-entity combat-game></a-entity>
    <a-entity combat-input></a-entity>
  </a-scene>

  <!-- START OVERLAY + TUTORIAL + TRY HIT (fallback) -->
  <script>
  (function (w) {
    w.EXO = w.EXO || {};
    function ensureOverlay(){
      let ov=document.getElementById('overlay'); if(!ov){ov=document.createElement('div');ov.id='overlay';ov.className='overlay';document.body.appendChild(ov);}
      let pn=document.getElementById('panel'); if(!pn){pn=document.createElement('div');pn.id='panel';pn.className='panel';ov.appendChild(pn);}
      return {ov,pn};
    }
    function renderTutorial(steps, onClose){
      const {ov,pn}=ensureOverlay(); let i=0;
      const nav=()=>`
        <div class="tut-ctrl">
          ${i>0?`<a class="btn" id="tutPrev">‚Üê Prev</a>`:''}
          ${i<steps.length-1?`<a class="btn" id="tutNext">Next ‚Üí</a>`:`<a class="btn" id="tutDone">Done</a>`}
        </div>`;
      function draw(){
        const s=steps[i];
        ov.style.display='flex';
        pn.innerHTML = `
          <div class="title" style="margin-bottom:.4rem">${s.title||'Tutorial'}</div>
          <div class="tut-img">${s.img||''}</div>
          <div class="muted">${s.text||''}</div>
          ${nav()}
          <div class="tut-ctrl"><a class="btn" id="tutTry">üéØ Try Hit</a> <a class="btn" id="tutStart">‚ñ∂ Start Game</a></div>
        `;
        pn.querySelector('#tutPrev')?.addEventListener('click', ()=>{i=Math.max(0,i-1);draw();});
        pn.querySelector('#tutNext')?.addEventListener('click', ()=>{i=Math.min(steps.length-1,i+1);draw();});
        pn.querySelector('#tutDone')?.addEventListener('click', ()=>{ov.style.display='none'; onClose&&onClose();});
        pn.querySelector('#tutTry')?.addEventListener('click', ()=>{ov.style.display='none'; w.__startPractice && w.__startPractice();});
        pn.querySelector('#tutStart')?.addEventListener('click', ()=>{ov.style.display='none'; w.__startGame && w.__startGame();});
      }
      draw();
    }
    if (typeof w.EXO.startOverlay!=='function'){
      w.EXO.startOverlay=function(onStart,opts={}){
        const {ov,pn}=ensureOverlay();
        ov.style.display='flex';
        pn.innerHTML=`
          <div class="title">${opts.title||'EXO TRAINING'}</div>
          ${opts.note?`<div class="muted" style="margin:.4rem 0">${opts.note}</div>`:''}
          <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
            <div><b>‡∏ã‡πâ‡∏≤‡∏¢</b><br>‡∏ï‡∏µ/‡∏õ‡∏±‡∏î</div>
            <div><b>‡∏Ç‡∏ß‡∏≤</b><br>‡∏ï‡∏µ/‡∏õ‡∏±‡∏î</div>
            <div><b>Space</b><br>‡∏ï‡∏µ/‡∏õ‡∏±‡∏î</div>
          </div>
          <div class="tut-ctrl">
            <a class="btn" id="__exoStartBtn">‚ñ∂ Start</a>
            <a class="btn" id="__exoHow">üìò How to</a>
            <a class="btn" id="__exoTry">üéØ Try Hit</a>
            <a class="btn" href="../index.html">‚üµ Hub</a>
          </div>
          <div style="text-align:center;opacity:.7;margin-top:.4rem">Tip: Space / Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>`;
        const go=async()=>{ov.style.display='none';try{await w.EXO?.audio?.ensure?.();await w.EXO?.audio?.ctx?.resume?.();}catch(e){} try{onStart&&onStart();}catch(e){}};
        document.getElementById('__exoStartBtn')?.addEventListener('click',go,{once:true});
        document.getElementById('__exoHow')?.addEventListener('click',()=>{
          const steps=[
            {title:'‡∏°‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', img:'<span>üü©</span>', text:'‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Äú‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏µ‚Äù ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πâ‡∏≤ ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ Perfect ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô'},
            {title:'‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ï‡∏µ', img:'<span>‚úä ‚ü∂ üü¶ ‚ü∂ üü©</span>', text:'‡∏ï‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ä‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß'},
            {title:'‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤', img:'<span>üîµüü°üü•üü¢üî∑</span>', text:'‡∏ü‡πâ‡∏≤=‡∏õ‡∏Å‡∏ï‡∏¥, ‡∏ó‡∏≠‡∏á=‡πÇ‡∏ö‡∏ô‡∏±‡∏™, ‡πÅ‡∏î‡∏á=‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏µ, ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß=‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏™=‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏ï‡∏µ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á'},
            {title:'‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/‡∏ü‡∏µ‡πÄ‡∏ß‡∏≠‡∏£‡πå', img:'<span>üî•</span>', text:'‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á ‚Üí ‡πÄ‡∏Å‡∏à‡πÄ‡∏ï‡πá‡∏° ‚Üí Overdrive 7s ‡∏Ñ‡∏π‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}
          ];
          renderTutorial(steps, null);
        });
        document.getElementById('__exoTry')?.addEventListener('click', ()=>{ ov.style.display='none'; w.__startPractice && w.__startPractice(); });
        document.addEventListener('keydown',e=>{ if(e.code==='Space'||e.key==='Enter'){go();} });
        ov.addEventListener('pointerdown',ev=>{ if(ev.target?.classList?.contains('btn')) return; go(); },{once:true,passive:true});
      };
    }
    w.EXO_safeStart = w.EXO_safeStart || function(onStart,_overlay,opts){ try{w.EXO.startOverlay(onStart,opts||{});}catch(e){ try{onStart&&onStart();}catch(_e){} } };
    w.__renderTutorial = renderTutorial;
  })(window);
  </script>

  <!-- GAME SCRIPT (‡∏£‡∏ß‡∏° Tutorial + Try Hit) -->
  <script>
  AFRAME.registerComponent('combat-game',{
    init(){
      // ---------- UI ----------
      this.ui = {
        score: score, time: time, combo: combo, acc: acc,
        fever: feverBar, mission: mission, panel: panel, overlay: overlay
      };

      // ---------- Params ----------
      const q = new URLSearchParams(location.search);
      this.diff = (q.get('diff') || 'normal');
      this.totalTime = Math.max(10, parseInt(q.get('time') || '60', 10));

      // ---------- State ----------
      this.state = {
        running:false, practice:false,
        time:this.totalTime, score:0, combo:0, maxCombo:0, hit:0, miss:0,
        fever:0, feverOn:false, lastSpawn:0, hpTap:{},
        spawnIvBase:{easy:780,normal:620,hard:480}[this.diff]||620,
        rush:false, rushUntil:0,
        mission:null, missionOk:false, missionProg:0, missionNeed:0,
        practiceHits:0
      };
      this.lanes = {L:-0.8, R:0.8};

      // ---------- Systems ----------
      this.dd = new (window.EXO_BOOST?.DynamicDifficulty||function(){return{
        tickDecay(){}, onHit(){}, onMiss(){}, getSpeedMul(){return 1}, getSpawnIv(){return null}
      }})();
      this.fv = new (window.EXO_BOOST?.FeverManager||function(){return{
        tick(){}, hit(){}, miss(){}, mulScore(v){return v}
      }})({need:10, dur:8000});
      this.patterns = [
        {n:4,lanes:['L','R','L','R'],jitter:0},
        {n:6,lanes:['L','R'],jitter:80},
        {n:5,lanes:['L'],jitter:60},
        {n:5,lanes:['R'],jitter:60},
        {n:8,lanes:['L','R','L','R','R','L','L','R'],jitter:0},
        {n:6,lanes:['L','L','R','R','L','R'],jitter:40}
      ];
      this._patternQueue=[];

      // Coach voice
      this.coach=(line)=>{ try{ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(line); u.lang='en-US'; u.rate=1; speechSynthesis.speak(u);} }catch(e){} };

      // expose for overlay buttons
      window.__startGame = ()=>this.start();
      window.__startPractice = ()=>this.startPractice();

      // Start screen
      EXO_safeStart(()=>this.start(), this.ui.overlay, {
        title:'Combat Reflex ‚Äî Elite Punch Protocol',
        note:`Diff: ${this.diff} ¬∑ Time: ${this.totalTime}s`
      });
    },

    /* ======= PRACTICE MODE ======= */
    startPractice(){
      const s=this.state;
      s.practice=true; s.running=false;
      s.practiceHits=0; this.clearTimers();
      this.ui.overlay.style.display='none';

      // ‡∏ä‡∏∏‡∏î‡∏ù‡∏∂‡∏Å: ‡∏™‡∏õ‡∏≠‡∏ß‡πå‡∏ô‡∏ä‡πâ‡∏≤ ‡πÜ ‡πÉ‡∏´‡πâ‡∏ï‡∏µ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      const spawnOnce = ()=>{
        const lane = (Math.random()<0.5)?'L':'R';
        const x=this.lanes[lane], y=1.25, zStart=-3.8;
        const el=document.createElement('a-box');
        el.setAttribute('width','0.35'); el.setAttribute('height','0.35'); el.setAttribute('depth','0.35');
        el.setAttribute('position',`${x} ${y} ${zStart}`);
        el.setAttribute('color','#60a5fa'); el.classList.add('note'); el.dataset.type='practice';
        this.el.sceneEl.appendChild(el);
        el.setAttribute('animation__move',{property:'position', to:`${x} ${y} -0.2`, dur:2400, easing:'linear'});
        setTimeout(()=>{ if(el.parentNode){ el.remove(); /* ‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å */ } }, 2460);
      };
      spawnOnce();
      this.practiceTimer = setInterval(()=>{
        if(!this.state.practice) return;
        const left = document.querySelectorAll('.note').length;
        if (left<1) spawnOnce();
      }, 600);

      // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏á‡∏ù‡∏∂‡∏Å
      const p=this.ui.panel, o=this.ui.overlay;
      o.style.display='flex';
      p.innerHTML = `
        <div class="title">üéØ Try Hit</div>
        <div class="muted">‡∏ï‡∏µ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>
        <div class="kpi" style="grid-template-columns:repeat(1,1fr);margin-top:.4rem">
          <div><div>Hits</div><b id="pHits">0 / 3</b></div>
        </div>
        <div class="tut-ctrl"><a class="btn" id="pQuit">‚üµ Back</a></div>`;
      document.getElementById('pQuit')?.addEventListener('click', ()=>this.quitPractice());
      setTimeout(()=>{ o.style.display='none'; }, 400); // ‡∏õ‡∏¥‡∏î panel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πâ‡∏≤
    },
    quitPractice(){
      this.state.practice=false; this.clearTimers();
      // ‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
      document.querySelectorAll('.note').forEach(n=>n.remove());
      // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
      EXO.startOverlay(()=>this.start(), {
        title:'Combat Reflex',
        note:`‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß`,
      });
    },
    finishPractice(){
      this.state.practice=false; this.clearTimers();
      document.querySelectorAll('.note').forEach(n=>n.remove());
      // ‡πÅ‡∏™‡∏î‡∏á ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢‚Äù
      const p=this.ui.panel, o=this.ui.overlay;
      o.style.display='flex';
      p.innerHTML = `
        <div class="title">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢</div>
        <div class="muted">‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏µ‡πÇ‡∏î‡∏ô‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
        <div class="tut-ctrl"><a class="btn" id="goReal">‚ñ∂ Start Game</a></div>`;
      document.getElementById('goReal')?.addEventListener('click', ()=>{ o.style.display='none'; this.start(); });
    },

    /* ======= GAME MODE ======= */
    start(){
      const s=this.state;
      s.practice=false; s.running=true;
      s.time=this.totalTime; s.score=0; s.combo=0; s.maxCombo=0; s.hit=0; s.miss=0; s.fever=0; s.feverOn=false;
      this.pickMission(); this.refreshUI();
      this.clearTimers();
      this.timer=setInterval(()=>{ if(!s.running) return; s.time--; this.ui.time.textContent=s.time; if(s.time<=0) this.end(); },1000);
      this.nextRushAt = performance.now() + 6000;
    },

    clearTimers(){ clearInterval(this.timer); clearInterval(this.practiceTimer); },

    tick(t, dt){
      const s=this.state;
      if(s.practice){
        // ‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏¥‡∏ô logic ‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô Practice
        return;
      }
      if(!s.running) return;
      this.dd.tickDecay(dt); this.fv.tick(dt);
      this.ui.fever.style.width = Math.min(100, s.fever|0) + '%';

      const now = performance.now();
      // Rush
      if (!s.rush && now >= this.nextRushAt){
        s.rush = true; s.rushUntil = now + 7000; this.flashScreen('#60a5fa'); this.coach('RUSH PHASE!');
      }
      if (s.rush && now >= s.rushUntil){ s.rush=false; this.nextRushAt = now + 18000; }

      // Spawn control
      const dynIv=this.dd.getSpawnIv?this.dd.getSpawnIv():null;
      let baseIv=dynIv||s.spawnIvBase;
      baseIv -= Math.min(120, s.combo*2);
      if (s.rush) baseIv *= 0.7;
      const spawnIv=Math.max(220, baseIv);

      if (this._patternQueue.length){
        const top=this._patternQueue[0], now2=performance.now();
        if (now2>=top.next){
          this.spawnTarget(top.laneSeq[top.i%top.laneSeq.length], top.type);
          top.i++; if(top.i>=top.n) this._patternQueue.shift();
          else top.next = now2 + top.step + (top.jitter? (Math.random()*top.jitter|0):0);
        }
        this.updateMissionTimer(dt);
        return;
      }
      if (performance.now()-s.lastSpawn>=spawnIv){
        s.lastSpawn = performance.now();
        if (Math.random()<0.35){
          const p=this.patterns[(Math.random()*this.patterns.length)|0];
          const type=this.rollType(); const step=Math.max(160, spawnIv*0.5);
          const lanes=[]; for(let i=0;i<p.n;i++) lanes.push(p.lanes[i%p.lanes.length]);
          this._patternQueue.push({i:0,n:p.n,step,jitter:p.jitter,laneSeq:lanes,type,next:performance.now()});
          this.spawnTarget(lanes[0], type);
        } else {
          const lane=(Math.random()<0.5)?'L':'R';
          this.spawnTarget(lane, this.rollType());
        }
      }
      this.updateMissionTimer(dt);
    },

    rollType(){
      const r=Math.random();
      if (r < 0.07) return 'armored';
      if (r < 0.16) return 'bomb';
      if (r < 0.30) return 'golden';
      if (r < 0.38) return 'timeorb';
      return 'normal';
    },

    spawnTarget(lane, type){
      const x=this.lanes[lane], y=1.25, zStart=-3.8;
      const speedMul = (this.dd.getSpeedMul ? this.dd.getSpeedMul() : 1) * (this.state.rush?1.15:1);
      const dur = Math.max(900, 2000 / speedMul);

      const el=document.createElement('a-box');
      el.setAttribute('width','0.35'); el.setAttribute('height','0.35'); el.setAttribute('depth','0.35');
      el.setAttribute('position',`${x} ${y} ${zStart}`);
      el.classList.add('note'); el.dataset.lane=lane; el.dataset.type=type;
      el.setAttribute('color',
        type==='golden' ? '#fbbf24' :
        type==='bomb'   ? '#ef4444' :
        type==='armored'? '#60a5fa' :
        type==='timeorb'? '#34d399' : '#29b6f6'
      );
      this.el.sceneEl.appendChild(el);
      el.setAttribute('animation__move',{property:'position', to:`${x} ${y} -0.2`, dur, easing:'linear'});

      // trail fx
      const trail=document.createElement('a-ring');
      trail.setAttribute('radius-inner','0.02'); trail.setAttribute('radius-outer','0.04');
      trail.setAttribute('color','#93c5fd'); trail.setAttribute('position',`${x} ${y} ${zStart}`);
      this.el.sceneEl.appendChild(trail);
      trail.setAttribute('animation',{property:'position', to:`${x} ${y} -0.2`, dur, easing:'linear'});
      trail.setAttribute('animation__fade',{property:'opacity', to:0, dur:dur, easing:'easeOutQuad'});
      setTimeout(()=>{trail.remove();}, dur+40);

      if (type==='armored') this.state.hpTap[el.object3D.uuid]=2;

      setTimeout(()=>{ if(!el.parentNode) return; if(!this.state.practice){ this.onMiss(); } el.remove(); }, dur+60);
    },

    onHit(){
      // ‡∏´‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏™‡πâ‡∏ô
      const notes=[...document.querySelectorAll('.note')];
      let best=null, dist=1e9;
      for(const n of notes){ const p=n.getAttribute('position'); if(!p) continue; const d=Math.abs(p.z-(-0.2)); if(d<dist){best=n;dist=d;} }
      if(!best || dist>0.28){
        if(!this.state.practice) this.badTap();
        return;
      }

      const type=best.dataset.type||'normal';

      // PRACTICE: ‡∏ô‡∏±‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
      if (this.state.practice){
        this.state.practiceHits++;
        document.getElementById('pHits')?.textContent = `${this.state.practiceHits} / 3`;
        this.hitSpark(best,'#22c55e'); EXO?.beep(900,0.05,0.1);
        best.remove();
        if (this.state.practiceHits>=3){ this.finishPractice(); }
        return;
      }

      // armored
      if (type==='armored'){
        const id=best.object3D.uuid; const hp=(this.state.hpTap[id]||2)-1; this.state.hpTap[id]=hp;
        this.hitSpark(best,'#93c5fd'); EXO?.beep(720,0.03,0.1);
        if (hp>0) return;
      }
      // bomb
      if (type==='bomb'){
        this.shake(1); this.flashScreen('#ef4444'); this.addScore(-220);
        this.breakCombo(); this.dd.onMiss?.(); this.fv.miss?.(); EXO?.beep(220,0.08,0.12);
        best.remove(); this.updateMissionOn('miss'); return;
      }
      // time orb
      if (type==='timeorb'){
        this.state.time = Math.min(this.totalTime+30, this.state.time + 5);
        this.ui.time.textContent = this.state.time;
        this.hitSpark(best,'#34d399'); this.addScore(120);
        this.state.combo++; this.state.hit++; EXO?.beep(990,0.05,0.1);
        best.remove(); this.updateMissionOn('hit','okay'); this.refreshUI(); return;
      }

      // ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û
      let q='okay'; if(dist<=0.06) q='perfect'; else if(dist<=0.14) q='good';
      const base={perfect:190,good:130,okay:85}[q];
      const bonus=(type==='golden')?120:0;
      let plus = base + bonus;
      if (this.state.rush) plus = Math.round(plus*1.1);

      // Fever
      if (!this.state.feverOn){
        this.state.fever = Math.min(100, this.state.fever + (q==='perfect'?3:q==='good'?2:1));
        if (this.state.fever>=100){
          this.state.feverOn=true; this.flashScreen('#fb923c'); this.coach('OVERDRIVE!');
          setTimeout(()=>{ this.state.feverOn=false; this.state.fever=0; }, 7000);
        }
      }

      this.addScore(this.fv.mulScore? this.fv.mulScore(plus) : plus);
      this.state.combo++; this.state.maxCombo=Math.max(this.state.maxCombo,this.state.combo);
      this.state.hit++; this.dd.onHit?.(); this.fv.hit?.();

      if (this.state.combo%10===0){ this.shake(0.9); this.flashScreen('#fde047'); }
      this.hitSpark(best, q==='perfect'?'#22c55e':q==='good'?'#0ea5e9':'#a78bfa');
      EXO?.beep(q==='perfect'?1000:q==='good'?860:700,0.05,0.1);
      best.remove();
      this.updateMissionOn('hit', q);
      this.refreshUI();
    },

    badTap(){ this.breakCombo(); this.dd.onMiss?.(); this.fv.miss?.(); this.addScore(-70); EXO?.beep(260,0.05,0.1); this.refreshUI(); },
    onMiss(){ this.state.miss++; this.breakCombo(); this.dd.onMiss?.(); this.fv.miss?.(); EXO?.beep(240,0.06,0.1); this.updateMissionOn('miss'); this.refreshUI(); },
    breakCombo(){ this.state.combo=0; },
    addScore(v){ if(this.state.feverOn && v>0) v=Math.round(v*1.5); this.state.score=Math.max(0,(this.state.score|0)+v); this.ui.score.textContent=this.state.score; },

    refreshUI(){
      this.ui.combo.textContent='Combo '+this.state.combo;
      const tot=this.state.hit+this.state.miss; const acc=tot?Math.round(this.state.hit*1000/tot)/10:0;
      this.ui.acc.textContent=`Acc ${acc}%`; this.ui.fever.style.width=Math.min(100,this.state.fever)+'%';
      if (this.state.mission){ const m=this.state.mission; const txt=`${m.label} ‚Äî ${Math.min(m.need,this.state.missionProg)} / ${m.need}`; this.ui.mission.textContent='Mission: '+txt+(this.state.missionOk?' ‚úÖ':''); }
    },

    // FX
    shake(mult=0.6){ const s=document.querySelector('a-scene'); if(!s) return; const o=s.object3D.position.clone(); let t=0; const id=setInterval(()=>{ t++; s.object3D.position.x=(Math.random()-0.5)*0.02*mult; s.object3D.position.y=(Math.random()-0.5)*0.02*mult; if(t>10){clearInterval(id); s.object3D.position.copy(o);} },16); },
    hitSpark(el,color='#fff'){ try{ const p=el.getAttribute('position'); const sp=document.createElement('a-sphere'); sp.setAttribute('radius','0.06'); sp.setAttribute('color',color); sp.setAttribute('position',`${p.x} ${p.y} -0.18`); sp.setAttribute('opacity','0.9'); this.el.sceneEl.appendChild(sp); sp.setAttribute('animation__grow',{property:'scale',to:'1.8 1.8 1.8',dur:120,easing:'easeOutCubic'}); sp.setAttribute('animation__fade',{property:'opacity',to:0,dur:160,easing:'linear'}); setTimeout(()=>{sp.remove();},200);}catch(e){} },
    flashScreen(color='#fff'){ const ov=this.ui.overlay, pn=this.ui.panel, prev=pn.innerHTML; ov.style.display='flex'; pn.innerHTML=`<div style="width:220px;height:120px;background:${color};opacity:.22;border-radius:12px"></div>`; setTimeout(()=>{ ov.style.display='none'; pn.innerHTML=prev; }, 90); },

    // Mission
    missionDefs:[
      {id:'combo',    text:(n)=>`Combo ‚â• ${n}`,        need:()=>({need: 20})},
      {id:'perfects', text:(n)=>`Perfect ${n} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,  need:()=>({need: 10})},
      {id:'streak',   text:(n)=>`‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î ${n}s`,      need:()=>({need: 8, timer:true})},
      {id:'score',    text:(n)=>`‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô +${n}`,      need:()=>({need: 1500})}
    ],
    pickMission(){
      const def=this.missionDefs[(Math.random()*this.missionDefs.length)|0];
      const cfg=def.need(); const label=def.text(cfg.need);
      this.state.mission={id:def.id,label,need:cfg.need,timer:!!cfg.timer};
      this.state.missionProg=0; this.state.missionOk=false; this.ui.mission.textContent='Mission: '+label; this._streakClock=0;
    },
    updateMissionTimer(dt){
      const m=this.state.mission; if(!m) return;
      if (m.id==='streak'){ if(this.state.combo>0){ this._streakClock += dt/1000; } else { this._streakClock=0; } this.state.missionProg=Math.max(0, Math.min(m.need, Math.floor(this._streakClock))); if(!this.state.missionOk && this.state.missionProg>=m.need){ this.state.missionOk=true; this.flashScreen('#10b981'); this.addScore(400);} }
      this.refreshUI();
    },
    updateMissionOn(evt,quality){
      const m=this.state.mission; if(!m || this.state.missionOk) return;
      if(m.id==='combo'){ this.state.missionProg=Math.max(this.state.missionProg,this.state.combo); }
      else if(m.id==='perfects'){ if(evt==='hit' && quality==='perfect') this.state.missionProg++; }
      else if(m.id==='score'){ this.state.missionProg=this.state.score; }
      else if(m.id==='streak'){ if(evt==='miss') this._streakClock=0; }
      if(!this.state.missionOk){
        if((m.id==='combo'&&this.state.missionProg>=m.need)||(m.id==='perfects'&&this.state.missionProg>=m.need)||(m.id==='score'&&this.state.missionProg>=m.need)){
          this.state.missionOk=true; this.flashScreen('#10b981'); this.addScore(400);
        }
      }
      this.refreshUI();
    },

    end(){
      this.state.running=false; this.clearTimers();
      const p=this.ui.panel, o=this.ui.overlay;
      const tot=this.state.hit+this.state.miss; const acc=tot?Math.round(this.state.hit*1000/tot)/10:0;
      const rank = (acc>=95 && this.state.maxCombo>=40) ? 'SS' :
                   (acc>=90 && this.state.maxCombo>=30) ? 'S'  :
                   (acc>=80) ? 'A' : (acc>=70) ? 'B' : 'C';
      o.style.display='flex';
      p.innerHTML=`
        <div class="title">Result ‚Äî Elite Punch Protocol</div>
        <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
          <div><div>Score</div><b>${this.state.score}</b></div>
          <div><div>Max Combo</div><b>${this.state.maxCombo}</b></div>
          <div><div>Accuracy</div><b>${acc}%</b></div>
        </div>
        <div class="kpi" style="grid-template-columns:repeat(3,1fr);margin-top:.4rem">
          <div><div>Hit</div><b>${this.state.hit}</b></div>
          <div><div>Miss</div><b>${this.state.miss}</b></div>
          <div><div>Rank</div><b>${rank}</b></div>
        </div>
        <div class="kpi" style="grid-template-columns:repeat(1,1fr);margin-top:.4rem">
          <div><div>Mission</div><b>${this.state.mission? this.state.mission.label : '-'}</b> ‚Äî <b>${this.state.missionOk?'COMPLETED ‚úÖ':'FAILED ‚ùå'}</b></div>
        </div>
        <div style="text-align:center;margin-top:.6rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap">
          <a class="btn" href="../index.html">‚üµ Back</a>
          <a class="btn" onclick="location.reload()">‚Ü∫ Replay</a>
          <a class="btn" onclick="location.href='play.html?diff=${this.diff}&time=${this.totalTime}'">‚ñ∂ Same Settings</a>
          <a class="btn" onclick="location.href='play.html?diff=hard&time=60'">üî• Hard 60s</a>
        </div>`;
      try{
        if (window.EXO_METRICS){
          EXO_METRICS.saveRun?.({ module:'Combat', diff:this.diff, time:this.totalTime, score:this.state.score, accuracy:acc, combo:this.state.maxCombo, mission:this.state.mission?.id||null, missionOk:this.state.missionOk||false });
        }
      }catch(e){}
    },
    remove(){ this.clearTimers(); }
  });

  // INPUT
  AFRAME.registerComponent('combat-input',{
    init(){
      const comp=document.querySelector('[combat-game]').components['combat-game'];
      (window.EXO && EXO.attachBasicInput) ? EXO.attachBasicInput({
        onLeft: ()=> comp && comp.onHit(),
        onRight:()=> comp && comp.onHit(),
        onPause: ()=>{}
      }) : window.addEventListener('keydown', e=>{
        if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') comp && comp.onHit();
        if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'||e.code==='Space') comp && comp.onHit();
      });
    }
  });
  </script>
</body>
</html>
