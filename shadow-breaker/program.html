<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO Training Program</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="core/exo-ui.css">
  <style>
    body{background:#060b18;color:#e8f0ff;}
    .center{max-width:360px;margin:120px auto;padding:20px;text-align:center}
  </style>
</head>
<body>
  <div id="overlay" class="overlay" style="display:flex">
    <div id="panel" class="panel">Loading...</div>
  </div>

  <script src="core/exo-core.js"></script>
  <script>
    // ---------- Fallback helper ----------
    async function goFirstAvailable(urls){
      for (const u of urls){
        try{
          const r = await fetch(u, {method:'HEAD', cache:'no-cache'});
          if (r.ok){ location.href = u; return; }
        }catch(_e){ location.href = u; return; }
      }
      alert('Next game not found: '+urls.join(' | '));
    }

    // ---------- Program runner ----------
    const p = EXO.store.get('EXO_PLAN');
    const panel = document.getElementById('panel');

    if(!p || !Array.isArray(p.paths) || !Array.isArray(p.fallbacks)){
      panel.innerHTML = `
        <div class="title">Program Finished ✅</div>
        <p>คุณทำครบทุกเกมในโปรแกรมแล้ว</p>
        <div style="text-align:center;margin-top:12px">
          <a href="index.html" class="btn">⬅ Back to Hub</a>
        </div>`;
    } else {
      const pairs = p.fallbacks;
      const i = Math.min(p.idx|0, pairs.length - 1);
      const nextIndex = i + 1;
      const hasNext = nextIndex < pairs.length;
      const nextTarget = hasNext ? "program.html" : "index.html";

      EXO.store.set("EXO_PLAN", {idx: nextIndex, paths: p.paths, fallbacks: pairs});

      const display = pairs[i].map(u => `<li>${u}</li>`).join("");

      panel.innerHTML = `
        <div class="title">Program Progress</div>
        <p>Step ${i+1} of ${pairs.length}</p>
        <ul style="text-align:left;margin:10px auto;width:max-content">${display}</ul>
        <div style="margin-top:18px">
          <a id="btnNext" class="btn">▶ Continue</a>
        </div>
      `;

      document.getElementById("btnNext").onclick = () => {
        // สร้าง URL โปรแกรมถัดไป
        const urls = pairs[i].map(u => {
          const sep = u.includes("?") ? "&" : "?";
          return `${u}${sep}next=${encodeURIComponent(nextTarget)}`;
        });
        goFirstAvailable(urls);
      };
    }
  </script>
</body>
</html>
