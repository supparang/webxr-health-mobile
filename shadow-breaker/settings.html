<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>EXO ¬∑ Settings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="core/exo-ui.css">
  <style>
    .wrap{max-width:680px;margin:84px auto 40px;padding:0 16px}
    .card{background:rgba(14,20,36,.85);border:1px solid #112848;border-radius:12px;padding:16px;margin-bottom:14px}
    .row{display:flex;gap:10px;align-items:center;margin:.5rem 0}
    .row label{min-width:140px}
    .muted{color:#7f8ea3;font-size:12px}
    .btnrow{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    input[type="range"]{width:180px}
    .sep{height:1px;background:#112848;margin:10px 0}
  </style>
</head>
<body>
  <header class="hud">
    <div class="box"><strong>EXO SETTINGS</strong></div>
    <div class="box right">
      <a class="btn" href="index.html">‚üµ Hub</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h3>General</h3>
      <div class="row">
        <label for="lang">Language</label>
        <select id="lang">
          <option value="th">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (TH)</option>
          <option value="en">English (EN)</option>
        </select>
      </div>
      <div class="muted">‡∏™‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ</div>
    </section>

    <section class="card">
      <h3>Audio</h3>
      <div class="row">
        <label for="musicOn">Music</label>
        <input id="musicOn" type="checkbox">
        <span class="muted">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
      </div>
      <div class="row">
        <label for="musicVol">Music Volume</label>
        <input id="musicVol" type="range" min="0" max="1" step="0.01">
        <span id="musicVolTxt" class="muted">0.40</span>
      </div>
      <div class="sep"></div>
      <div class="row">
        <label for="sfxOn">SFX</label>
        <input id="sfxOn" type="checkbox">
        <span class="muted">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</span>
      </div>
      <div class="row">
        <label for="sfxVol">SFX Volume</label>
        <input id="sfxVol" type="range" min="0" max="1" step="0.01">
        <span id="sfxVolTxt" class="muted">0.12</span>
      </div>
      <div class="row" style="justify-content:flex-start">
        <button id="btnTestSfx" class="btn">üîä Test SFX</button>
      </div>
    </section>

    <section class="card">
      <h3>Data</h3>
      <div class="row">
        <button id="btnReset" class="btn">üóë Clear Local Data</button>
        <span class="muted">‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥/‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ</span>
      </div>
    </section>

    <div class="btnrow">
      <a href="index.html" class="btn">‚üµ Back</a>
      <button id="btnSave" class="btn">üíæ Save</button>
    </div>
  </main>

  <script src="core/exo-core.js"></script>
  <script src="core/exo-i18n.js"></script>
  <script>
    // ----- settings key / defaults -----
    const KEY = 'EXO_SETTINGS';
    const defaults = { lang:'th', music:true, sfx:true, musicVol:0.40, sfxVol:0.12 };

    // DOM refs
    const lang = document.getElementById('lang');
    const musicOn = document.getElementById('musicOn');
    const sfxOn = document.getElementById('sfxOn');
    const musicVol = document.getElementById('musicVol');
    const sfxVol = document.getElementById('sfxVol');
    const musicVolTxt = document.getElementById('musicVolTxt');
    const sfxVolTxt = document.getElementById('sfxVolTxt');

    // load
    const cur = Object.assign({}, defaults, EXO.store.get(KEY, {}));
    lang.value = cur.lang;
    musicOn.checked = !!cur.music;
    sfxOn.checked = !!cur.sfx;
    musicVol.value = cur.musicVol;
    sfxVol.value = cur.sfxVol;
    musicVolTxt.textContent = (+cur.musicVol).toFixed(2);
    sfxVolTxt.textContent = (+cur.sfxVol).toFixed(2);

    // live preview (SFX only)
    document.getElementById('btnTestSfx').onclick = () => {
      if (!sfxOn.checked) return;
      try {
        // use EXO.audio.beep for preview at chosen sfxVol
        const v = Math.max(0, Math.min(1, parseFloat(sfxVol.value||'0.12')));
        // temporarily set
        EXO.audio.ensure?.();
        if (EXO.audio.sfxGain) EXO.audio.sfxGain.gain.value = v;
        EXO.beep(660, 0.08, v);
        setTimeout(()=>EXO.beep(880, 0.08, v), 110);
      }catch(e){}
    };

    // show % text
    musicVol.addEventListener('input', ()=> musicVolTxt.textContent = (+musicVol.value).toFixed(2));
    sfxVol.addEventListener('input',   ()=> sfxVolTxt.textContent   = (+sfxVol.value).toFixed(2));

    // save
    function save(){
      const next = {
        lang: lang.value || 'th',
        music: !!musicOn.checked,
        sfx: !!sfxOn.checked,
        musicVol: Math.max(0, Math.min(1, parseFloat(musicVol.value||'0.4'))),
        sfxVol:   Math.max(0, Math.min(1, parseFloat(sfxVol.value||'0.12')))
      };
      EXO.store.set(KEY, next);

      // broadcast to any open game tabs
      try { window.dispatchEvent(new CustomEvent('exo:settingsChanged', {detail: next})); } catch(e){}
      // apply immediately in this page (for preview)
      try {
        if (EXO_I18N && typeof EXO_I18N.set === 'function') EXO_I18N.set(next.lang);
        if (EXO.audio){
          EXO.audio.ensure?.();
          if (EXO.audio.musicGain) EXO.audio.musicGain.gain.value = next.music && next.musicVol ? next.musicVol : 0;
          if (EXO.audio.sfxGain)   EXO.audio.sfxGain.gain.value   = next.sfx   && next.sfxVol   ? next.sfxVol   : 0;
          if (!next.music) EXO.audio.stopMusic?.();
        }
      }catch(e){}

      alert('Saved ‚úÖ');
    }
    document.getElementById('btnSave').onclick = save;

    // reset
    document.getElementById('btnReset').onclick = ()=>{
      if (!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ? (settings/metrics/xp)')) return;
      try {
        localStorage.clear();
      } catch(e){}
      alert('Cleared ‚úÖ');
      location.reload();
    };

    // auto-save on change
    [lang, musicOn, sfxOn, musicVol, sfxVol].forEach(el=>{
      el.addEventListener('change', save);
    });
  </script>
</body>
</html>
