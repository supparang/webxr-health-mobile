<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Shadow Breaker — Future Space Training</title>
<!-- A-Frame CDN -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
:root{--bg:#0a0e18;--panel:#0e1424;--line:#112848;--text:#e6f2ff;--muted:#a7c5ff;--accent:#69b3ff;--accent2:#8ad1ff}
html,body{margin:0;padding:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#081022,#0a0e18);color:var(--text)}
#hud{position:fixed;left:0;right:0;top:0;display:flex;justify-content:space-between;align-items:center;padding:.6rem 1rem;background:linear-gradient(180deg,rgba(17,40,72,.55),transparent);z-index:5;pointer-events:none}
.hud-left,.hud-right{display:flex;gap:.6rem;align-items:center}
.btn{pointer-events:auto;border:1px solid var(--line);background:linear-gradient(180deg,rgba(138,209,255,.12),rgba(138,209,255,.05));padding:.35rem .7rem;border-radius:.6rem;color:var(--text)}
#score{font-weight:800;font-size:1.2rem} #time{font-weight:800} #combo{opacity:.9}
.touch-zone{position:fixed;top:0;bottom:0;width:50vw;z-index:4} #touch-left{left:0} #touch-right{right:0}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(8,16,32,.55);backdrop-filter:blur(4px);z-index:10}
.overlay.hidden{display:none}
.panel{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:1rem 1.2rem;border-radius:1rem;min-width:260px;box-shadow:0 0 24px rgba(138,209,255,.35)}
</style>
<script>
// mini i18n (EN/TH)
(function(){
  const STR={en:{paused:"Paused",resume:"Resume",restart:"Restart",back:"Back",tap:"Tap to resume"},
             th:{paused:"พักเกม",resume:"เล่นต่อ",restart:"เริ่มใหม่",back:"กลับเมนู",tap:"แตะเพื่อเล่นต่อ"}};
  window.I18N={lang:localStorage.getItem('lang')||'en',
    t(k){return (STR[this.lang]&&STR[this.lang][k])||k;}, toggle(){this.lang=this.lang==='en'?'th':'en';localStorage.setItem('lang',this.lang);return this.lang;}
  };
})();
</script>
</head>
<body>
  <div id="hud">
    <div class="hud-left"><span id="score">0</span><span id="combo">x1.0</span></div>
    <div class="hud-right"><span id="time">60</span><button id="btnPause" class="btn">⏸</button><a class="btn" href="../index.html">⟵ Menu</a></div>
  </div>
  <div id="touch-left" class="touch-zone"></div>
  <div id="touch-right" class="touch-zone"></div>

  <div id="overlay" class="overlay hidden">
    <div class="panel">
      <h1 id="ov-title">Paused</h1>
      <p id="ov-desc">Tap to resume</p>
      <div style="display:flex;gap:.6rem">
        <button id="btnResume" class="btn">▶ Resume</button>
        <button id="btnRestart" class="btn">⟲ Restart</button>
        <a id="btnBack" class="btn" href="../index.html">⟵ Back</a>
      </div>
    </div>
  </div>

  <a-scene vr-mode-ui="enabled: true" renderer="antialias: true; colorManagement: true">
    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.65; color: #88aaff"></a-entity>
    <a-entity light="type: directional; intensity: 0.9; color: #aee0ff" position="0 3 2"></a-entity>

    <!-- Sci-Fi Room -->
    <a-entity geometry="primitive: box; depth: 22; height: 6; width: 12"
              position="0 3 -7"
              material="color: #0c1428; side: back; metalness:0.1; roughness:0.9"></a-entity>
    <a-plane rotation="-90 0 0" width="14" height="14" position="0 0 -4"
             material="metalness:0.35; roughness:0.4; color:#0f1b33"></a-plane>
    <a-entity geometry="primitive: box; depth: 0.02; height: 0.02; width: 12" position="0 0.01 -3.5"
              material="color: #69b3ff; emissive: #69b3ff; emissiveIntensity: 0.6"></a-entity>

    <!-- Player rig + cursor -->
    <a-entity id="rig">
      <a-entity id="camera" camera wasd-controls="enabled:false" position="0 1.6 0">
        <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable" position="0 0 -0.1"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Lanes + Director -->
    <a-entity id="lanes"></a-entity>
    <a-entity id="director" game-director></a-entity>
  </a-scene>

<script>
// Shadow Breaker – core gameplay (no external assets)
AFRAME.registerComponent('game-director', {
  init(){
    const q=new URLSearchParams(location.search);
    this.state={score:0,combo:1.0,time:60,running:true,diff:q.get('diff')||'normal'};
    this.$s=score; this.$c=combo; this.$t=time;
    btnPause.onclick=()=>this.pause(); btnResume.onclick=()=>this.resume(); btnRestart.onclick=()=>location.reload();

    // Touch: left/right punch
    const punch=(side)=>this.tryPunch(side);
    ['touchstart','mousedown'].forEach(ev=>{
      document.getElementById('touch-left').addEventListener(ev,()=>punch('L'));
      document.getElementById('touch-right').addEventListener(ev,()=>punch('R'));
    });

    this.spawnZ=-4; this.hitZ=-0.5; this.laneX={L:-0.8,R:0.8};
    this.pool=[]; for(let i=0;i<16;i++) this.pool.push(this.makeTarget(this.el.sceneEl));
    this.speed=(this.state.diff==='hard'?6:this.state.diff==='easy'?3.6:4.6);
    this.spawnInterval=(this.state.diff==='hard'?0.35:this.state.diff==='easy'?0.8:0.55);
    this.elapsed=0; this.spawnCooldown=0;
    this.timer=setInterval(()=>{ if(!this.state.running) return; if(this.state.time<=0){this.endRun();return;}
      this.state.time--; this.$t.textContent=this.state.time; },1000);
    this.tick=AFRAME.utils.throttleTick(this.tick.bind(this),16);
    // i18n overlay text
    document.getElementById('ov-title').textContent=I18N.t('paused');
    document.getElementById('ov-desc').textContent=I18N.t('tap');
    btnResume.textContent='▶ '+I18N.t('resume'); btnRestart.textContent='⟲ '+I18N.t('restart'); btnBack.textContent='⟵ '+I18N.t('back');
  },
  pause(){ this.state.running=false; overlay.classList.remove('hidden'); },
  resume(){ this.state.running=true; overlay.classList.add('hidden'); },
  makeTarget(scene){
    const e=document.createElement('a-entity'); e.setAttribute('class','clickable');
    e.setAttribute('geometry','primitive: box; depth:0.35; height:0.35; width:0.35');
    e.setAttribute('material','color:#9ecbff; metalness:0.2; roughness:0.4; emissive:#2a6fb5; emissiveIntensity:0.25');
    e.setAttribute('visible',false); e.object3D.position.set(0,1.4,-4); e.userData={alive:false,side:'L'};
    e.addEventListener('click',()=>this.tryPunch(e.userData.side)); scene.appendChild(e); return e;
  },
  spawn(side){
    const e=this.pool.find(o=>!o.userData.alive); if(!e) return;
    e.userData.alive=true; e.userData.side=side; e.userData.vz=this.speed;
    e.object3D.position.set(this.laneX[side],1.4,this.spawnZ); e.object3D.scale.set(1,1,1);
    e.setAttribute('visible',true);
  },
  tryPunch(side){
    if(!this.state.running) return;
    let best=null, bestDz=999;
    for(const e of this.pool){
      if(!e.userData.alive||e.userData.side!==side) continue;
      const dz=Math.abs(e.object3D.position.z - this.hitZ);
      if(dz<bestDz){best=e;bestDz=dz;}
    }
    if(best && bestDz<=0.25){ this.onHit(best,bestDz); }
    else{ this.state.combo=1.0; this.$c.textContent='x'+this.state.combo.toFixed(1); }
  },
  onHit(e,dz){
    const base=(dz<=0.08?100:dz<=0.18?60:30);
    this.state.score+=Math.round(base*this.state.combo);
    this.$s.textContent=this.state.score;
    this.state.combo=Math.min(this.state.combo+0.2,5);
    this.$c.textContent='x'+this.state.combo.toFixed(1);
    e.setAttribute('animation__pop','property: scale; to: 0.1 0.1 0.1; dur: 80; easing: easeOutQuad');
    setTimeout(()=>{ e.setAttribute('visible',false); e.userData.alive=false; e.removeAttribute('animation__pop'); },90);
  },
  endRun(){ this.state.running=false; clearInterval(this.timer); overlay.classList.remove('hidden'); },
  tick(t,dt){
    if(!this.state.running) return;
    const dtS=dt/1000; this.elapsed+=dtS; this.spawnCooldown-=dtS;
    if(this.spawnCooldown<=0){ this.spawn(Math.random()<0.5?'L':'R'); this.spawnCooldown=this.spawnInterval; }
    for(const e of this.pool){
      if(!e.userData.alive) continue;
      e.object3D.position.z += e.userData.vz*dtS;
      if(e.object3D.position.z>0.3){
        e.setAttribute('visible',false); e.userData.alive=false;
        this.state.combo=1.0; this.$c.textContent='x'+this.state.combo.toFixed(1);
      }
    }
  }
});
</script>
</body>
</html>
