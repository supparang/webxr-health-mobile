<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Beat Map Editor — Fitness Adventure VR</title>
<style>
  body{font-family:system-ui,Arial;margin:0;background:#0e1726;color:#e6eefc}
  header{padding:12px 16px;background:#0b1220;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  header input, header select, header button{padding:8px 12px;border-radius:10px;border:0;background:#1b2a41;color:#e6eefc}
  #wrap{display:grid;grid-template-columns: 280px 1fr;gap:12px;padding:12px}
  #palette{background:#0b1220;border-radius:14px;padding:12px}
  #palette h3{margin:6px 0 8px 0}
  .evt{padding:6px 10px;border-radius:10px;margin:6px 0;background:#23395b;cursor:grab;user-select:none}
  .evt[data-type="punchL"]{background:#246b5c}
  .evt[data-type="punchR"]{background:#246b5c}
  .evt[data-type="duck"]{background:#6b2a2a}
  .evt[data-type="handsUp"]{background:#6b5a24}
  #timeline{background:#0b1220;border-radius:14px;padding:12px}
  #grid{width:100%;height:420px;background:#0f1a2e;border-radius:12px;position:relative;overflow:auto}
  .cell{position:absolute;height:36px;border-bottom:1px solid #1e2a38}
  .barline{position:absolute;top:0;bottom:0;width:2px;background:#2d4164}
  .beatline{position:absolute;top:0;bottom:0;width:1px;background:#1e2a38}
  .note{position:absolute;height:28px;border-radius:8px;color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:grab;user-select:none}
  .note[data-type="punchL"], .note[data-type="punchR"]{background:#28c76f}
  .note[data-type="duck"]{background:#ff6b6b}
  .note[data-type="handsUp"]{background:#ffd166;color:#222}
  #playhead{position:absolute;top:0;bottom:0;width:2px;background:#e8ff86;pointer-events:none}
  .rowLabel{position:absolute;left:6px;color:#9fb3d9;font-size:12px}
  .muted{opacity:.6}
</style>
</head>
<body>
<header>
  <strong>Beat Map Editor</strong>
  <label>BPM <input type="number" id="bpm" value="120" min="40" max="220" style="width:72px"></label>
  <label>Bars <input type="number" id="bars" value="16" min="1" max="128" style="width:72px"></label>
  <label>Beats/Bar 
    <select id="beats"><option>4</option><option>3</option><option>6</option><option>5</option></select>
  </label>
  <label>Snap 
    <select id="snap">
      <option value="1">1/1</option>
      <option value="2">1/2</option>
      <option value="4" selected>1/4</option>
      <option value="8">1/8</option>
      <option value="16">1/16</option>
    </select>
  </label>
  <button id="btnPlay">Preview</button>
  <button id="btnStop">Stop</button>
  <button id="btnExport">Export JSON</button>
  <input type="file" id="btnImport" accept="application/json">
  <label>Metronome <input type="checkbox" id="chkMetro" checked></label>
  <audio id="metro" src="assets/metronome.wav"></audio>
</header>

<div id="wrap">
  <aside id="palette">
    <h3>Events</h3>
    <div class="evt" draggable="true" data-type="punchL">Punch L</div>
    <div class="evt" draggable="true" data-type="punchR">Punch R</div>
    <div class="evt" draggable="true" data-type="duck">Duck</div>
    <div class="evt" draggable="true" data-type="handsUp">Hands Up</div>
    <hr>
    <p style="font-size:12px;color:#9fb3d9">Tip: ลากวางลง Timeline ช่องที่ต้องการ จับขอบเพื่อเลื่อน / ลบด้วยดับเบิลคลิก</p>
  </aside>
  <section id="timeline">
    <div id="grid"></div>
  </section>
</div>

<script>
const grid = document.getElementById('grid');
const bpmEl = document.getElementById('bpm');
const barsEl = document.getElementById('bars');
const beatsEl = document.getElementById('beats');
const snapEl = document.getElementById('snap');
const playBtn = document.getElementById('btnPlay');
const stopBtn = document.getElementById('btnStop');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const chkMetro = document.getElementById('chkMetro');
const metroAudio = document.getElementById('metro');

let notes = []; // {t, type, el}
const rows = [
  { key: 'punchL', label: 'Punch L' },
  { key: 'punchR', label: 'Punch R' },
  { key: 'duck', label: 'Duck' },
  { key: 'handsUp', label: 'Hands Up' },
];

let pxPerBeat = 48;
let rowH = 36;
let playReq = null;
let playStart = 0;

function secPerBeat(){ return 60 / parseFloat(bpmEl.value || 120); }
function totalBeats(){ return parseInt(barsEl.value || 16) * parseInt(beatsEl.value || 4); }
function toX(t){ const b = t/secPerBeat(); return b*pxPerBeat; }
function toT(x){ const b = x/pxPerBeat; const snap = parseInt(snapEl.value||4); const snapped = Math.round(b*snap)/snap; return snapped*secPerBeat(); }

function layoutGrid(){
  grid.innerHTML='';
  grid.style.position='relative';
  const width = toX(totalBeats()*secPerBeat());
  grid.style.width = width+'px';
  grid.style.height = (rows.length*rowH)+'px';

  // rows
  rows.forEach((r, i)=>{
    const y = i*rowH;
    const row = document.createElement('div');
    row.className='cell';
    row.style.left='0px'; row.style.top=y+'px'; row.style.width=width+'px';
    grid.appendChild(row);
    const label = document.createElement('div');
    label.className='rowLabel';
    label.style.top=(y+6)+'px';
    label.textContent=r.label;
    grid.appendChild(label);
  });

  // lines
  for(let beat=0; beat<=totalBeats(); beat++){
    const x = beat*pxPerBeat;
    const ln = document.createElement('div');
    ln.className = (beat % parseInt(beatsEl.value)==0) ? 'barline' : 'beatline';
    ln.style.left = x+'px';
    grid.appendChild(ln);
  }

  // playhead
  const ph = document.createElement('div');
  ph.id='playhead'; ph.style.left='0px';
  grid.appendChild(ph);
}

function addNote(t, type){
  const rowIdx = rows.findIndex(r=>r.key===type);
  if (rowIdx<0) return;
  const el = document.createElement('div');
  el.className='note'; el.dataset.type=type; el.textContent=type;
  el.style.left = toX(t)+'px';
  el.style.top = (rowIdx*rowH + 4) + 'px';
  el.style.width = Math.max(36, pxPerBeat*0.9) + 'px';
  el.draggable = true;
  el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({moveId: notes.indexOf(obj)})); });
  el.addEventListener('dblclick', ()=>{ grid.removeChild(el); notes = notes.filter(n=>n!==obj); });
  grid.appendChild(el);
  const obj = {t, type, el};
  notes.push(obj);
}

function renderNotes(){
  notes.forEach(n=>{
    n.el.style.left = toX(n.t)+'px';
  });
}

function onDropNew(e, type){
  const rect = grid.getBoundingClientRect();
  const x = e.clientX - rect.left + grid.scrollLeft;
  const t = Math.max(0, Math.min(toT(x), totalBeats()*secPerBeat()));
  addNote(t, type);
}

document.querySelectorAll('.evt').forEach(ev=>{
  ev.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', JSON.stringify({type: ev.dataset.type}));
  });
});

grid.addEventListener('dragover', e=>e.preventDefault());
grid.addEventListener('drop', e=>{
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
  if (data.type){ onDropNew(e, data.type); }
  else if (data.moveId!=null){
    const idx = parseInt(data.moveId);
    const rect = grid.getBoundingClientRect();
    const x = e.clientX - rect.left + grid.scrollLeft;
    const t = Math.max(0, Math.min(toT(x), totalBeats()*secPerBeat()));
    notes[idx].t = t; renderNotes();
  }
});

[bpmEl, barsEl, beatsEl, snapEl].forEach(el=> el.addEventListener('change', ()=>{ layoutGrid(); renderNotes(); }));

function exportJSON(){
  const events = notes.map(n=>({t: Math.round(n.t*100)/100, type:n.type})).sort((a,b)=>a.t-b.t);
  const data = { title: "Custom Beat Map", duration: Math.round(totalBeats()*secPerBeat()), bpm: parseInt(bpmEl.value||120), events };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'beatmap_custom.json'; a.click();
}

btnExport.addEventListener('click', exportJSON);

btnImport.addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if (!file) return;
  const txt = await file.text();
  const json = JSON.parse(txt);
  notes = [];
  if (json.bpm) bpmEl.value = json.bpm;
  if (json.duration && json.bpm){
    // derive bars crudely with beats=4
    beatsEl.value = '4';
    barsEl.value = Math.ceil((json.duration / (60/json.bpm))/4);
  }
  layoutGrid();
  (json.events||[]).forEach(ev=> addNote(ev.t, ev.type));
});

function previewStart(){
  if (playReq) cancelAnimationFrame(playReq);
  playStart = performance.now();
  if (chkMetro.checked){ try{ metroAudio.currentTime=0; metroAudio.play(); }catch{} }
  function step(){
    const t = (performance.now()-playStart)/1000;
    const x = toX(t);
    document.getElementById('playhead').style.left = x+'px';
    playReq = requestAnimationFrame(step);
  }
  playReq = requestAnimationFrame(step);
}
function previewStop(){
  if (playReq) cancelAnimationFrame(playReq); playReq = null;
  document.getElementById('playhead').style.left = '0px';
  try{ metroAudio.pause(); }catch{}
}

playBtn.addEventListener('click', previewStart);
stopBtn.addEventListener('click', previewStop);

layoutGrid();
</script>
</body>
</html>
