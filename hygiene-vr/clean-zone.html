<!DOCTYPE html>
<html>
<head>
    <title>Clean Zone - Hero Mission</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-link-control/dist/aframe-link-control.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      .hud-display {
        position: absolute; background-color: rgba(0, 0, 0, 0.7);
        color: white; padding: 10px; border-radius: 5px;
        font-family: monospace; font-size: 1.2em; z-index: 1001;
      }
      #mission-ui { top: 20px; left: 20px; font-size: 1em; }
      #germ-count-display { top: 150px; left: 20px; display: none; /* ซ่อนไว้ก่อน */ }
      #timer-display { top: 150px; right: 20px; display: none; /* ซ่อนไว้ก่อน */ }
      #wash-prompt { bottom: 20px; left: 50%; transform: translateX(-50%); display: none; }
      .mission-item { color: #FFB3B3; /* Red (ยังไม่ทำ) */ }
      .mission-item.complete { color: #B3FFB3; /* Green (ทำแล้ว) */ text-decoration: line-through; }
    </style>
</head>
<body>
    
<div id="mission-ui" class="hud-display">
      <b>Clean Zone Objectives:</b><br>
      <div id="obj-hands" class="mission-item">[ ] Clean Hands (at Sink)</div>
      <div id="obj-bath" class="mission-item">[ ] Bath Time (at Shower)</div>
      <div id="obj-hair" class="mission-item">[ ] Hair Care (at Mirror)</div>
    </div>
    <div id="germ-count-display" class="hud-display">Germs: 100</div>
    <div id="timer-display" class="hud-display">Time: 00:00</div>
    <div id="wash-prompt" class="hud-display">Click/Tap and Hold to Wash!</div>

    <a-scene hero-mission="missionName: clean">
        <a-assets>
            <img id="floorTexture" src="https://cdn.aframe.io/a-saturday-night/images/floor.jpg">
            <img id="wallTexture" src="https://cdn.glitch.global/027329ad-4573-41a3-b0ee-73591c28c614/wall_tiles.jpg?v=1678887467645">
        </a-assets>

        <a-entity
            camera="active: true"
            look-controls="pointerLockEnabled: false"
            position="0 1.6 0"
            wasd-controls="acceleration: 10">
            <a-cursor
                id="cursor"
                raycaster="objects: .clickable"
                fuse="false">
            </a-cursor>
            <a-entity id="leftHand" hand-controls="hand: left; model: true"></a-entity>
            <a-entity id="rightHand" hand-controls="hand: right; model: true"></a-entity>
        </a-entity>

        <a-plane width="10" height="10" rotation="-90 0 0" material="src: #floorTexture; repeat: 5 5"></a-plane>
        <a-box width="10" height="4" depth="0.1" position="0 2 -5" material="src: #wallTexture; repeat: 2 1"></a-box>
        <a-box width="10" height="4" depth="0.1" position="-5 2 0" rotation="0 90 0" material="src: #wallTexture; repeat: 2 1"></a-box>
        <a-box width="10" height="4" depth="0.1" position="5 2 0" rotation="0 -90 0" material="src: #wallTexture; repeat: 2 1"></a-box>
        <a-box width="10" height="4" depth="0.1" position="0 2 5" rotation="0 180 0" material="src: #wallTexture; repeat: 2 1"></a-box>

        <a-entity id="handwash-zone" position="0 0 0">
            <a-text value="Mission 1: Clean Hands" position="0 2.5 -4.8" align="center" width="4"></a-text>
            <a-box width="1.2" height="0.8" depth="0.7" position="0 0.4 -4.5" color="#FFF"></a-box>
            <a-cylinder radius="0.3" height="0.2" position="0 0.85 -4.5" color="#E0FFFF"></a-cylinder>
            <a-cylinder radius="0.05" height="0.3" position="0 1.05 -4.5" color="#888"></a-cylinder>
            <a-box id="soapBottle" class="clickable" width="0.15" height="0.3" depth="0.1" position="0.5 0.95 -4.4" color="#76B947">
                <a-text value="SOAP" color="white" align="center" width="1" position="0 0 0.051"></a-text>
            </a-box>
            <a-entity id="germ-container" position="0 1.3 -4.3"></a-entity>
        </a-entity>
        
        <a-entity id="bath-zone" position="4 0 0">
            <a-text value="Mission 2: Bath Time" position="0 2.5 -4.8" align="center" width="4"></a-text>
            <a-box width="1" height="2.5" depth="1.5" position="0 1.25 -4.5" color="#E0FFFF" opacity="0.8"></a-box>
            <a-box id="showerKnob" class="clickable" width="0.4" height="0.4" depth="0.1" position="0 1.2 -4.0" color="#FFD700">
                 <a-text value="Click to Shower" align="center" position="0 0 0.051" width="1.5" color="black"></a-text>
            </a-box>
        </a-entity>

        <a-entity id="haircare-zone" position="-4 0 0">
            <a-text value="Mission 3: Hair Care" position="0 2.5 -4.8" align="center" width="4"></a-text>
            <a-box width="1.5" height="1" depth="0.1" position="0 1.5 -4.5" color="#CCC"></a-box> <a-box width="1.5" height="0.8" depth="0.7" position="0 0.4 -4.5" color="#FFF"></a-box> <a-cylinder id="comb" class="clickable" radius="0.05" height="0.3" position="0 0.9 -4.2" color="#CD853F" rotation="0 0 90">
                <a-text value="Click to Comb Hair" align="center" position="0 0.2 0" width="1.5" color="black"></a-text>
            </a-cylinder>
        </a-entity>

        <a-box id="return-portal" class="clickable" position="0 1.6 2" color="#8A2BE2" visible="false"
            link="href: index.html; title: Return to Academy; image: #">
            <a-text value="Return to Academy" position="0 0 0.51" align="center"></a-text>
            <a-entity animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear;">
                <a-octahedron radius="0.3" color="#FFF" position="0 0.8 0.5"></a-octahedron>
            </a-entity>
        </a-box>

        <a-light type="ambient" color="#BBB"></a-light>
        <a-light type="directional" position="1 5 1" intensity="0.8"></a-light>
    </a-scene>

    <script>
    AFRAME.registerComponent('hero-mission', {
        schema: {
            missionName: {type: 'string', default: 'clean'},
            germCount: { type: 'int', default: 100 },
            cleanSpeed: { type: 'number', default: 20 }
        },
        init: function () {
            this.missions = {
                hands: false,
                bath: false,
                hair: false
            };
            this.zoneCompleted = false;
            
            // --- Clean Hands Vars ---
            this.germs = [];
            this.initialGermCount = this.data.germCount;
            this.soapBottle = document.getElementById('soapBottle');
            this.germContainer = document.getElementById('germ-container');
            this.hasSoap = false;
            this.rubbingHandsNonVR = false;
            this.gameTimer = 0;

            // --- Bath Time Vars ---
            this.showerKnob = document.getElementById('showerKnob');

            // --- Hair Care Vars ---
            this.comb = document.getElementById('comb');

            // --- UI Elements ---
            this.germCountDisplay = document.getElementById('germ-count-display');
            this.timerDisplay = document.getElementById('timer-display');
            this.washPrompt = document.getElementById('wash-prompt');
            this.objHands = document.getElementById('obj-hands');
            this.objBath = document.getElementById('obj-bath');
            this.objHair = document.getElementById('obj-hair');

            // --- Init Listeners ---
            this.spawnGerms();
            this.onTick = AFRAME.utils.throttleTick(this.onTick, 100, this);

            // Mission 1 Listeners
            this.soapBottle.addEventListener('click', this.getSoap.bind(this));
            const sceneEl = this.el.sceneEl;
            sceneEl.addEventListener('mousedown', () => { this.rubbingHandsNonVR = true; });
            sceneEl.addEventListener('mouseup', () => { this.rubbingHandsNonVR = false; });
            sceneEl.addEventListener('touchstart', () => { this.rubbingHandsNonVR = true; });
            sceneEl.addEventListener('touchend', () => { this.rubbingHandsNonVR = false; });
            
            // Mission 2 Listener
            this.showerKnob.addEventListener('click', this.completeBathMission.bind(this));
            
            // Mission 3 Listener
            this.comb.addEventListener('click', this.completeHairMission.bind(this));
        },

        // --- Mission 1: Clean Hands Logic ---
        getSoap: function () { 
            if (this.hasSoap || this.missions.hands) return; // ถ้ามีสบู่แล้ว หรือทำภารกิจเสร็จแล้ว
            this.hasSoap = true;
            this.soapBottle.setAttribute('visible', false);
            this.washPrompt.style.display = 'block'; 
            this.germCountDisplay.style.display = 'block';
            this.timerDisplay.style.display = 'block';
        },
        spawnGerms: function () { 
            for (let i = 0; i < this.data.germCount; i++) {
                const germ = document.createElement('a-sphere');
                germ.setAttribute('radius', Math.random() * 0.01 + 0.005);
                germ.setAttribute('color', `#${Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0')}`);
                germ.setAttribute('position', { x: (Math.random() - 0.5) * 0.2, y: (Math.random() - 0.5) * 0.2, z: (Math.random() - 0.5) * 0.2 });
                this.germContainer.appendChild(germ);
                this.germs.push(germ);
            }
            this.updateGermCountDisplay();
        },
        onTick: function (time, delta) { 
            if (this.missions.hands) return; // ถ้าภารกิจล้างมือจบแล้ว ก็ไม่ต้อง Tick

            this.gameTimer = time / 1000;
            this.updateGameTimer(this.gameTimer);
            let isWashing = false;
            
            if (this.el.sceneEl.is('vr-mode')) { 
                /* (Logic VR - เช็คมือถู) */
                const leftHandPos = document.getElementById('leftHand').object3D.position;
                const rightHandPos = document.getElementById('rightHand').object3D.position;
                const handsTracked = leftHandPos.length() > 0.1 && rightHandPos.length() > 0.1;
                if (!this.hasSoap && handsTracked) {
                    const soapPos = this.soapBottle.object3D.position;
                    if (leftHandPos.distanceTo(soapPos) < 0.2 || rightHandPos.distanceTo(soapPos) < 0.2) this.getSoap();
                }
                if (this.hasSoap && handsTracked && leftHandPos.distanceTo(rightHandPos) < 0.25) isWashing = true;
            }
            else { if (this.hasSoap && this.rubbingHandsNonVR) { isWashing = true; } }
            
            if (isWashing) {
                this.cleanGerms(this.data.cleanSpeed * (delta / 1000)); 
            }
            
            if (this.germs.length === 0 && this.initialGermCount > 0) {
                this.completeHandsMission();
            }
        },
        cleanGerms: function (amount) { 
            let cleanedCount = Math.ceil(amount);
            for (let i = 0; i < cleanedCount && this.germs.length > 0; i++) {
                const germ = this.germs.pop();
                if (germ.parentNode) { germ.parentNode.removeChild(germ); }
            }
            this.updateGermCountDisplay();
        },
        updateGermCountDisplay: function() { 
            this.germCountDisplay.textContent = `Germs: ${this.germs.length}`;
        },
        updateGameTimer: function(timeInSeconds) { 
            if (this.missions.hands) return;
            this.timerDisplay.textContent = `Time: ${Math.floor(timeInSeconds)}s`;
        },
        
        // --- Mission Completion Logic ---
        
        completeHandsMission: function() {
            if (this.missions.hands) return;
            this.missions.hands = true;
            this.initialGermCount = 0; // หยุดการนับ
            alert("Mission 1: Clean Hands Complete!");
            this.objHands.classList.add('complete');
            this.objHands.textContent = "[X] Clean Hands (Complete)";
            this.washPrompt.style.display = 'none';
            this.germCountDisplay.style.display = 'none';
            this.timerDisplay.style.display = 'none';
            this.checkOverallCompletion();
        },
        
        completeBathMission: function() {
            if (this.missions.bath) return;
            this.missions.bath = true;
            alert("Mission 2: Bath Time Complete!");
            this.objBath.classList.add('complete');
            this.objBath.textContent = "[X] Bath Time (Complete)";
            this.showerKnob.setAttribute('color', 'green'); // เปลี่ยนสีเป็นสีเขียว
            this.showerKnob.querySelector('a-text').setAttribute('value', 'Done!');
            this.checkOverallCompletion();
        },
        
        completeHairMission: function() {
            if (this.missions.hair) return;
            this.missions.hair = true;
            alert("Mission 3: Hair Care Complete!");
            this.objHair.classList.add('complete');
            this.objHair.textContent = "[X] Hair Care (Complete)";
            this.comb.setAttribute('color', 'green'); // เปลี่ยนสีเป็นสีเขียว
            this.comb.querySelector('a-text').setAttribute('value', 'Done!');
            this.checkOverallCompletion();
        },

        // --- Zone Completion Logic ---
        checkOverallCompletion: function() {
            if (this.zoneCompleted) return; // ถ้าจบโซนไปแล้ว ไม่ต้องเช็ค
            
            if (this.missions.hands && this.missions.bath && this.missions.hair) {
                this.zoneCompleted = true;
                const missionName = this.data.missionName; // "clean"

                // 1. บันทึกลงใน localStorage
                localStorage.setItem(`mission_${missionName}`, 'complete');

                // 2. แสดงปุ่มกลับ Hub
                const returnPortal = document.getElementById('return-portal');
                if (returnPortal) returnPortal.setAttribute('visible', 'true');

                // 3. แจ้งเตือนผู้เล่น
                alert(`CLEAN ZONE Complete! พลังฮีโร่ของคุณเพิ่มขึ้นแล้ว! คลิกที่ประตูวาร์ปเพื่อกลับไปยัง Academy`);
            }
        }
    });
    </script>
</body>
</html>
