<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthy Hero VR — ONLINE (ไอคอนภาพจริง)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#F4FBFF}
    #banner{position:fixed;left:0;right:0;top:0;background:#10b981;color:#fff;padding:8px 12px;font-size:13px;z-index:9999}
    #banner.warn{background:#f59e0b} #banner.err{background:#ef4444}
  </style>
</head>
<body>
  <div id="banner" class="warn">กำลังโหลดเกม (ONLINE)… ถ้าค้างเกิน 5 วิ ให้เปิดด้วย Chrome/Edge ตัวเต็ม</div>

  <a-scene renderer="colorManagement:true; antialias:true" background="color:#F4FBFF">
    <a-entity light="type: ambient; intensity:0.85"></a-entity>
    <a-entity light="type: directional; intensity:0.9" position="1 2 0"></a-entity>
    <a-plane position="0 0 -1" rotation="-90 0 0" width="24" height="24" color="#EAF7EF"></a-plane>

    <a-entity id="rig" position="0 1.6 2">
      <a-entity id="cam" camera look-controls>
        <a-entity id="cursor" cursor="fuse:true; fuseTimeout:850" raycaster="objects:.clickable"
          position="0 0 -1" geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.016"
          material="color:#111; shader:flat"></a-entity>
      </a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
    </a-entity>
    <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>

    <a-entity id="hud" position="0 2.6 -1.2">
      <a-plane width="2.6" height="0.78" color="#FFFFFF" opacity="0.96"></a-plane>
      <a-text id="hudText" value="โหมด: A  คะแนน: 0  เวลา: 45s" color="#0a2" width="2.4" align="center" position="0 0 0.01"></a-text>
    </a-entity>

    <a-entity id="splash" position="0 1.8 -1.7">
      <a-plane width="2.9" height="2.0" color="#FFFFFF" opacity="0.98"></a-plane>
      <a-text value="Healthy Hero VR" align="center" width="2.6" color="#10b981" position="0 0.8 0.01"></a-text>
      <a-text value="โภชนาการ ป.5 — โหมด A (ไอคอนภาพ)" align="center" width="2.6" color="#2563eb" position="0 0.6 0.01"></a-text>

      <a-entity class="clickable btn" position="0 0.2 0.01" ui-button="label: เริ่มเล่น; color:#10b981; action:start"></a-entity>
      <a-entity class="clickable btn" position="0 -0.3 0.01" ui-button="label: วิธีเล่น; color:#94a3b8; action:how"></a-entity>
    </a-entity>

    <a-entity id="how" position="0 1.8 -1.7" visible="false">
      <a-plane width="2.9" height="1.8" color="#FFFFFF" opacity="0.98"></a-plane>
      <a-text value="วิธีเล่น: เลือกไอคอน «อาหารสุขภาพ»" align="center" width="2.6" color="#111" position="0 0.6 0.01"></a-text>
      <a-text id="howBody" value="กดเริ่ม → แตะ/ชี้การ์ดสีเขียว (สุขภาพ) = +10 • การ์ดสีแดง (ขยะ) = −5 • เวลา 45 วิ" align="center" width="2.6" color="#334155" position="0 0.25 0.01"></a-text>
      <a-entity class="clickable btn" position="0 -0.4 0.01" ui-button="label: กลับ; color:#f59e0b; action:back"></a-entity>
    </a-entity>

    <a-entity id="stage" position="0 1.25 -2.6" visible="false">
      <a-box width="3.6" height="0.1" depth="2.2" color="#F3F4F6" position="0 0 0"></a-box>
      <a-entity id="spawn" position="0 0.15 0"></a-entity>
    </a-entity>

    <a-entity id="result" position="0 1.8 -1.7" visible="false">
      <a-plane width="2.9" height="1.8" color="#FFFFFF" opacity="0.98"></a-plane>
      <a-text value="จบเกม!" align="center" width="2.6" color="#111" position="0 0.6 0.01"></a-text>
      <a-text id="resBody" value="คะแนน: 0" align="center" width="2.6" color="#334155" position="0 0.2 0.01"></a-text>
      <a-entity class="clickable btn" position="-0.6 -0.4 0.01" ui-button="label: เล่นอีกครั้ง; color:#10b981; action:restart"></a-entity>
      <a-entity class="clickable btn" position="0.6 -0.4 0.01" ui-button="label: กลับเมนู; color:#2563eb; action:back"></a-entity>
    </a-entity>

    <script>
AFRAME.registerComponent('ui-button', {
  schema: { label:{type:'string'}, color:{type:'string', default:'#10b981'}, action:{type:'string'} },
  init: function(){
    const d=this.data, el=this.el;
    const p=document.createElement('a-plane'); p.setAttribute('width','2'); p.setAttribute('height','0.45'); p.setAttribute('color', d.color);
    p.setAttribute('opacity','0.98'); p.setAttribute('material','shader: flat'); p.classList.add('clickable');
    const t=document.createElement('a-text'); t.setAttribute('value', d.label); t.setAttribute('align','center'); t.setAttribute('width','1.9'); t.setAttribute('color','#fff'); t.setAttribute('position','0 0 0.01');
    el.appendChild(p); el.appendChild(t);
    el.addEventListener('click', ()=> el.sceneEl.emit('ui', {action:d.action}));
  }
});

AFRAME.registerComponent('food-card', {
  schema:{ healthy:{default:true}, label:{default:''}, src:{default:''} },
  init: function(){
    const d=this.data, el=this.el;
    const bg=document.createElement('a-plane'); bg.setAttribute('width','1.1'); bg.setAttribute('height','1.1'); bg.setAttribute('color', d.healthy ? '#D1FAE5' : '#FEE2E2'); bg.setAttribute('material','shader: flat');
    const img=document.createElement('a-image'); img.setAttribute('src', d.src); img.setAttribute('width','0.7'); img.setAttribute('height','0.7'); img.setAttribute('position','0 0.15 0.01'); img.setAttribute('crossorigin','anonymous');
    const tx=document.createElement('a-text'); tx.setAttribute('value', d.label || (d.healthy?'อาหารสุขภาพ':'อาหารขยะ')); tx.setAttribute('align','center'); tx.setAttribute('width','1.2'); tx.setAttribute('color', d.healthy? '#065f46':'#7f1d1d'); tx.setAttribute('position','0 -0.3 0.01'); tx.setAttribute('wrap-count','12');
    el.appendChild(bg); el.appendChild(img); el.appendChild(tx);
    el.classList.add('clickable');
    el.addEventListener('click', ()=> el.sceneEl.emit('hit', { healthy:d.healthy, entity:el }));
  }
});

AFRAME.registerComponent('game', {
  init: function(){
    const scene=this.el;
    this.banner=document.getElementById('banner');
    this.hud=document.getElementById('hudText');
    this.splash=document.getElementById('splash');
    this.how=document.getElementById('how');
    this.stage=document.getElementById('stage');
    this.spawn=document.getElementById('spawn');
    this.result=document.getElementById('result');
    this.resBody=document.getElementById('resBody');

    this.score=0; this.time=45;
    this.timer=null; this.spawnInt=null;

    scene.addEventListener('ui', (e)=> this.onUI(e.detail.action));
    scene.addEventListener('hit', (e)=> this.onHit(e.detail));

    setTimeout(()=>{
      if(window.AFRAME){ this.banner.textContent='พร้อมเล่น (ONLINE • ไอคอนภาพ)'; this.banner.className=''; setTimeout(()=> this.banner.style.display='none', 1200); }
      else { this.banner.className='err'; this.banner.textContent='สคริปต์ถูกบล็อก — ใช้ Chrome/Edge และต่ออินเทอร์เน็ต'; }
    }, 1000);
  },

  onUI: function(a){ if(a==='start') return this.start(); if(a==='how') return this.showHow(); if(a==='back') return this.showSplash(); if(a==='restart') return this.start(); },

  showSplash: function(){ this.stopAll(); this.clear(); this.splash.setAttribute('visible', true); this.how.setAttribute('visible', false); this.stage.setAttribute('visible', false); this.result.setAttribute('visible', false); this.updateHUD(); },
  showHow: function(){ this.splash.setAttribute('visible', false); this.how.setAttribute('visible', true); this.stage.setAttribute('visible', false); this.result.setAttribute('visible', false); },

  start: function(){
    this.stopAll(); this.clear(); this.splash.setAttribute('visible', false); this.how.setAttribute('visible', false); this.stage.setAttribute('visible', true); this.result.setAttribute('visible', false);
    this.score=0; this.time=45; this.updateHUD();

    const good=[
      {label:'ผัก', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f966.png'},
      {label:'ผลไม้', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f34e.png'},
      {label:'นมจืด', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f95b.png'},
      {label:'ปลา', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f41f.png'},
      {label:'ข้าวกล้อง', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f35a.png'}
    ];
    const bad=[
      {label:'น้ำอัดลม', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f964.png'},
      {label:'ของทอด', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f35f.png'},
      {label:'ขนมหวาน', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f370.png'},
      {label:'มันฝรั่งแผ่น', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f95f.png'},
      {label:'ชานมหวาน', src:'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9cb.png'}
    ];

    this.timer=setInterval(()=>{ if(this.time<=0){ this.end(); return; } this.time--; this.updateHUD(); }, 1000);
    const once=()=>{
      if(this.time<=0) return;
      const goodPick = Math.random() < 0.6;
      const list = goodPick ? good : bad;
      const data = list[Math.floor(Math.random()*list.length)];
      const ent=document.createElement('a-entity');
      ent.setAttribute('food-card',{healthy:goodPick,label:data.label,src:data.src});
      const p=this.rpos(1.4,0.9); ent.setAttribute('position', `${p.x} 0 ${p.z}`);
      this.spawn.appendChild(ent);
      setTimeout(()=>{ try{ ent.parentNode && ent.parentNode.removeChild(ent);}catch(e){} }, 5200);
    };
    once(); this.spawnInt=setInterval(()=>{ once(); if(Math.random()<0.42) once(); }, 1100);
  },

  end: function(){ this.stopAll(); this.stage.setAttribute('visible', false); this.result.setAttribute('visible', true); this.resBody.setAttribute('value', `คะแนน: ${this.score}`); },
  onHit: function(d){ if(this.time<=0) return; this.score += d.healthy ? 10 : -5; this.updateHUD(); try{ d.entity.parentNode && d.entity.parentNode.removeChild(d.entity);}catch(e){} },
  updateHUD: function(){ this.hud.setAttribute('value', `โหมด: A  คะแนน: ${this.score}  เวลา: ${this.time}s`); },
  stopAll: function(){ if(this.timer){ clearInterval(this.timer); this.timer=null; } if(this.spawnInt){ clearInterval(this.spawnInt); this.spawnInt=null; } },
  clear: function(){ while(this.spawn.firstChild){ this.spawn.removeChild(this.spawn.firstChild); } },
  rpos: function(w,d){ return { x:(Math.random()*(w*2)-w), z:(Math.random()*(d*2)-d)}; }
});

document.addEventListener('DOMContentLoaded', ()=>{ document.querySelector('a-scene').setAttribute('game',''); });
    </script>
  </a-scene>
</body>
</html>
