<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Nutrition VR ‚Äî Diagnostics Build</title>
<style>
  html,body{margin:0;height:100%;background:#061018;overflow:hidden}
  canvas#c{position:fixed;inset:0;display:block;background:#061018;z-index:0}
  .hud,#menuBar,#summary,#dbg,.reticle,#boot,#errors,#clicklog,#vrSlot,#valueTip,#toast,#stat{
    position:fixed; z-index:2147483600; color:#0ff; font-family:system-ui; text-shadow:0 0 8px rgba(0,255,255,.6)
  }
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center;max-width:min(96vw,1100px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
  .btn,.tag{display:inline-block;padding:10px 14px;border:1px solid #0ff;border-radius:12px;background:rgba(0,0,0,.35);color:#0ff;cursor:pointer;user-select:none}
  .tag{border-style:dashed}
  .btn:hover,.tag:hover{background:rgba(0,255,255,.12)}
  #summary{inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
  .card{background:rgba(8,12,20,.96);border:1px solid #0ff;border-radius:16px;padding:18px 20px;color:#0ff;width:min(94vw,680px);text-align:center}
  #dbg{left:8px;bottom:8px;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px}
  #stat{left:8px;bottom:64px;background:rgba(0,12,20,.5);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px}
  #boot{top:8px;left:8px;background:#064;padding:6px 10px;border-radius:8px;border:1px solid #0f8;color:#fff}
  #errors{top:8px;right:8px;max-width:48ch;background:rgba(30,0,0,.85);padding:6px 10px;border:1px solid #f66;border-radius:8px;color:#ffb;display:none}
  #clicklog{right:8px;bottom:8px;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;border:1px solid #0ff;font-size:12px;max-width:46ch;display:block}
  #fever{display:none;margin-left:8px;border:1px solid #ff3;border-radius:999px;padding:2px 10px;color:#ff3;text-shadow:0 0 10px rgba(255,240,0,.85)}
  body.fever .hud{color:#fff8b0}
  body.fever #fever{display:inline-block}
  .reticle{left:50%;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border:2px solid #0ff;border-radius:50%;pointer-events:none;opacity:.9}
  .reticle .dot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:#0ff}
  .reticle.progress{border-color:#ff0}
  #valueTip{left:50%;top:calc(50% + 28px);transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid #0ff;border-radius:10px;padding:6px 10px;display:none}
  #toast{left:50%;top:58px;transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid #0ff;border-radius:10px;padding:6px 10px;display:none}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="reticle" id="ret"><div class="dot"></div></div>
<div id="valueTip">‚Ä¶</div>

<div id="boot">BOOT: JS initialized</div>
<div id="errors">Errors: none</div>
<div id="toast">‚Ä¶</div>

<div class="hud">
  <div><span id="lblScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>: <span id="score">0</span> |
       <span id="lblCombo">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>: <span id="combo">x1</span> |
       <span id="lblTime">‡πÄ‡∏ß‡∏•‡∏≤</span>: <span id="time">60</span>s |
       <span id="lblBest">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>: <span id="best">0</span>
       <span id="fever">FEVER!</span>
  </div>
  <div><span id="lblMode">‡πÇ‡∏´‡∏°‡∏î</span>: <span id="modeName">‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</span> |
       <span id="lblDiff">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</span>: <span id="difficulty">Normal</span></div>
</div>

<div id="menuBar">
  <div class="row" id="modes">
    <button class="tag" data-action="mode" data-value="goodjunk" type="button">ü•ó <span data-i18n="modeGJ">‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</span></button>
    <button class="tag" data-action="mode" data-value="groups" type="button">üçΩÔ∏è <span data-i18n="modeGroups">‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà</span></button>
    <button class="tag" data-action="mode" data-value="hydration" type="button">üíß <span data-i18n="modeHydra">Hydration</span></button>
    <button class="tag" data-action="mode" data-value="plate" type="button">üç± <span data-i18n="modePlate">Build Plate</span></button>
  </div>
  <div class="row" id="diff" style="margin:8px 0">
    <button class="tag" data-action="diff" data-value="Easy" type="button">Easy</button>
    <button class="tag" data-action="diff" data-value="Normal" type="button">Normal</button>
    <button class="tag" data-action="diff" data-value="Hard" type="button">Hard</button>
  </div>
  <div class="row" id="ctrls">
    <button class="btn" data-action="start" type="button">‚ñ∂ <span data-i18n="start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</span></button>
    <button class="btn" data-action="pause" type="button">‚è∏ <span data-i18n="pause">‡∏û‡∏±‡∏Å</span></button>
    <button class="btn" data-action="restart" type="button">‚Üª <span data-i18n="restart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</span></button>
    <button class="btn" data-action="lang" type="button">üåê ‡πÑ‡∏ó‡∏¢/English</button>
    <button class="btn" data-action="logger" type="button">ü™µ Log</button>
    <span id="vrSlot"></span>
  </div>
</div>

<div id="summary">
  <div class="card">
    <div style="font-size:20px;margin-bottom:8px"><b id="sumTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</b></div>
    <div id="sumStars" style="font-size:28px;margin:8px 0 4px">‚òÖ‚òÜ‚òÜ</div>
    <div id="sumBody">Score: 0 ‚Ä¢ Combo Max: x1 ‚Ä¢ Mode: ‚Äî ‚Ä¢ Diff: ‚Äî</div>
    <div style="margin-top:12px"><button class="btn" data-action="restart" type="button">‚Üª <span data-i18n="restart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</span></button></div>
  </div>
</div>

<div id="dbg">STATE: boot</div>
<div id="stat">Spawned: 0 | Active: 0 | Watchdog: 0</div>
<div id="clicklog">clicklog: idle</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.159.0/examples/js/VRButton.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const logEl=$("#clicklog"), errEl=$("#errors"), tip=$("#valueTip");
  const dbg=(m)=>$("#dbg").textContent='STATE: '+m;
  const stat=(s)=>$("#stat").textContent=s;
  const clog=(msg)=>{ logEl.textContent="clicklog: "+msg; };

  window.onerror = (msg, src, line, col)=>{ errEl.style.display='block'; errEl.textContent="Errors: "+msg+" @"+(src||'inline')+":"+line+":"+col; };

  const state={lang: 'th', difficulty: localStorage.getItem('ng_diff')||'Normal', mode: localStorage.getItem('ng_mode')||'goodjunk',
               score:0,timeLeft:60,running:false,paused:false,combo:1,comboMax:1,best:0,fever:false,shield:false};
  function updateHUD(){ $("#score").textContent=state.score; $("#time").textContent=state.timeLeft; $("#best").textContent=state.best; $("#difficulty").textContent=state.difficulty; $("#combo").textContent='x'+state.combo; }

  const canvas=$("#c");
  const renderer=new THREE.WebGLRenderer({canvas, antialias:true}); renderer.setClearColor(0x061018,1); renderer.xr.enabled=true;
  try{ const VRB=window.VRButton||(window.THREE&&window.THREE.VRButton); const vrEl=(VRB&&VRB.createButton)?VRB.createButton(renderer):null; if(vrEl){ $("#vrSlot")?.replaceWith(vrEl); } }catch(e){}

  const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(60,2,0.01,100); camera.position.set(0,1.6,2.8);
  scene.add(new THREE.AmbientLight(0xffffff,1.0)); const group=new THREE.Group(); scene.add(group);
  const raycaster=new THREE.Raycaster();
  function emojiTexture(char){ const s=128, cnv=document.createElement('canvas'); cnv.width=cnv.height=s; const ctx=cnv.getContext('2d'); ctx.font="100px system-ui, Apple Color Emoji, Segoe UI Emoji"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(char,s/2,s/2); const tex=new THREE.CanvasTexture(cnv); tex.needsUpdate=true; return tex; }
  const ACTIVE=new Set();
  function makeEmoji(char){ const tex=emojiTexture(char); const geo=new THREE.PlaneGeometry(0.5,0.5); const mat=new THREE.MeshBasicMaterial({map:tex, transparent:true, side:THREE.DoubleSide, depthWrite:false}); const m=new THREE.Mesh(geo,mat); m.lookAt(camera.position); return m; }

  const LANE_X=[-1.1,-0.55,0,0.55,1.1], LANE_Y=[-0.2,0.0,0.18,0.32], LANE_Z=-2.2;
  const occupied=new Set(), cooldown=new Map(); let lastLane=null; const now=()=>performance.now(); const isAdj=(r,c)=>{ if(!lastLane) return false; const [pr,pc]=lastLane; return Math.abs(pr-r)<=1 && Math.abs(pc-c)<=1; };
  function pickLane(){ const cand=[]; for(let r=0;r<LANE_Y.length;r++){ for(let c=0;c<LANE_X.length;c++){ const k=r+','+c, cd=cooldown.get(k)||0, free=!occupied.has(k)&&now()>cd&&!isAdj(r,c); if(free) cand.push({r,c,k}); }} if(!cand.length) return null; const p=cand[Math.floor(Math.random()*cand.length)]; occupied.add(p.k); lastLane=[p.r,p.c]; return {x:LANE_X[p.c], y:1.6+LANE_Y[p.r], z:LANE_Z-0.1*Math.abs(p.c-2), key:p.k}; }
  function releaseLane(k){ occupied.delete(k); cooldown.set(k, now()+800); }

  // simplified meta: always visible emoji selection
  const LIB=["üçé","ü•¶","üçü","ü•§","üçå","üçï","ü•õ","üçó","üçá","üç∞"];
  function spawn(){ const lane=pickLane(); if(!lane) return; const char=LIB[Math.floor(Math.random()*LIB.length)]; const m=makeEmoji(char); m.position.set(lane.x,lane.y,lane.z); m.userData={lane:lane.key}; group.add(m); ACTIVE.add(m);
    setTimeout(()=>{ if(m.parent){ destroy(m); } }, 3500 + Math.floor(Math.random()*400-200));
  }
  function destroy(o){ if(o.parent) o.parent.remove(o); ACTIVE.delete(o); releaseLane(o.userData.lane); }

  function onClickCanvas(ev){ if(!state.running||state.paused) return; const r=canvas.getBoundingClientRect(); const x=(ev.clientX-r.left)/r.width*2-1; const y=-(ev.clientY-r.top)/r.height*2+1; const m=new THREE.Vector2(x,y); raycaster.setFromCamera(m,camera); const inter=raycaster.intersectObjects(Array.from(ACTIVE)); if(inter.length){ destroy(inter[0].object); } }
  canvas.addEventListener('click', onClickCanvas);

  let spH=null, tmH=null, watchdogH=null, SPAWN_COUNT=0, WD=0;
  function loop(){ if(!state.running||state.paused) return; spawn(); SPAWN_COUNT++; stat(`Spawned: ${SPAWN_COUNT} | Active: ${ACTIVE.size} | Watchdog: ${WD}`); spH=setTimeout(loop, 700); }
  function timer(){ if(!state.running||state.paused) return; tmH=setTimeout(()=>{ state.timeLeft--; updateHUD(); if(state.timeLeft<=0){ endGame(); } else timer(); }, 1000); }

  function start(){
    $("#summary").style.display='none'; state.score=0; state.combo=1; state.comboMax=1; state.timeLeft=60; updateHUD();
    state.running=true; state.paused=false; dbg('running');
    setTimeout(spawn, 200); loop(); timer();
    clearTimeout(watchdogH); let seenT=state.timeLeft, seenS=SPAWN_COUNT;
    (function kick(){ const stuck=(seenT===state.timeLeft)||(seenS===SPAWN_COUNT); if(stuck){ WD++; stat(`Spawned: ${SPAWN_COUNT} | Active: ${ACTIVE.size} | Watchdog: ${WD}`); clearTimeout(spH); clearTimeout(tmH); setTimeout(()=>{ spawn(); loop(); timer(); },150); } seenT=state.timeLeft; seenS=SPAWN_COUNT; watchdogH=setTimeout(kick,1200); })();
  }
  function pause(){ if(!state.running) return; state.paused=!state.paused; dbg(state.paused?'paused':'running'); if(!state.paused){ loop(); timer(); } }

  function endGame(){ state.running=false; state.paused=false; clearTimeout(spH); clearTimeout(tmH); dbg('summary'); $("#summary").style.display='flex'; }

  function resize(){ const w=innerWidth, h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
  addEventListener('resize', resize); resize();
  function renderLoop(){ const q=camera.quaternion; ACTIVE.forEach(m=>{ m.quaternion.copy(q); }); renderer.render(scene,camera); }
  renderer.setAnimationLoop(renderLoop);

  const UI={ start: ()=> start(), pause: ()=> pause(), restart: ()=>{ state.running=false; state.paused=false; clearTimeout(spH); clearTimeout(tmH); SPAWN_COUNT=0; WD=0; dbg('ready'); stat('Spawned: 0 | Active: 0 | Watchdog: 0'); start(); },
             setMode:(m)=>{}, setDiff:(d)=>{ state.difficulty=d; updateHUD(); }, toggleLang:()=>{} };
  window.UI=UI;

  $("#menuBar").addEventListener('click',(e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const act=btn.getAttribute('data-action'); const val=btn.getAttribute('data-value');
    e.preventDefault(); e.stopPropagation();
    const map={start: UI.start, pause: UI.pause, restart: UI.restart, lang: UI.toggleLang, logger: ()=>{ logEl.style.display=(logEl.style.display==='none'?'block':'none'); }};
    if(act in map) map[act](); else if(act==='mode') UI.setMode(val); else if(act==='diff') UI.setDiff(val);
    clog(`menu action=${act} value=${val||'-'}`);
  }, false);

  dbg('ready'); stat('Spawned: 0 | Active: 0 | Watchdog: 0');
})();</script>
</body>
</html>
