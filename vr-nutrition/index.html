<!DOCTYPE html>
<html lang="th"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>EAT TO POWER – HERO ACADEMY (Quad Modes)</title>
<link rel="icon" href="./assets/logo.png"/>
<style>
:root{--bg:#061018;--cy:#0ff;--cy2:rgba(0,255,255,.12);--card:rgba(8,12,20,.96)}
html,body{margin:0;height:100%;overflow:hidden;background:#000}
body::before{content:"";position:fixed;inset:0;background:url('./assets/background.jpg') center/cover no-repeat fixed;filter:saturate(1.1) brightness(1.05);z-index:0;pointer-events:none}
canvas#c{position:fixed;inset:0;display:block;background:transparent;z-index:1}
.brand{position:fixed;left:12px;top:10px;z-index:3;display:flex;gap:8px;align-items:center;color:#aee;font-family:Rajdhani,Exo 2,system-ui;text-shadow:0 0 10px rgba(0,255,255,.55)}
.brand img{height:42px;filter:drop-shadow(0 0 10px rgba(0,255,255,.35))}
.hud,#menuBar,#summary,.reticle,#errors,#valueTip,#toast,#help{position:fixed;z-index:4;color:#0ff;font-family:Rajdhani,Exo 2,system-ui;text-shadow:0 0 8px rgba(0,255,255,.6)}
.hud{left:50%;transform:translateX(-50%);top:10px;text-align:center}
#menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center;max-width:min(96vw,1180px)}
.row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.btn,.tag{display:inline-block;padding:10px 14px;border:1px solid var(--cy);border-radius:12px;background:rgba(0,0,0,.35);color:var(--cy);cursor:pointer;user-select:none}
.btn:hover,.tag:hover{background:var(--cy2)}
#errors{top:8px;right:8px;max-width:48ch;background:rgba(30,0,0,.85);padding:6px 10px;border:1px solid #f66;border-radius:8px;color:#ffb;display:none}
/* click safety */
#menuBar,#menuBar *{pointer-events:auto!important} .reticle,#valueTip,#toast{pointer-events:none!important} canvas#c{pointer-events:none}
#targetWrap{margin-top:6px;display:none}
#plateTracker{display:none;margin-top:6px}
.pills{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--cy);border-radius:12px;background:rgba(0,0,0,.35)}
.pill.done{border-color:#2ecc71;background:rgba(46,204,113,.22);color:#dbfff1;box-shadow:0 0 12px rgba(46,204,113,.25) inset}
.reticle{left:50%;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border:2px solid var(--cy);border-radius:50%}
.reticle .dot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:var(--cy)}
</style>
</head><body>
<div class="brand"><img src="./assets/logo.png" alt="logo"/><div>EAT TO POWER – HERO ACADEMY</div></div>
<canvas id="c"></canvas>
<audio id="sfx-ding" src="./assets/ding.wav"></audio>
<audio id="sfx-thud" src="./assets/thud.wav"></audio>
<audio id="sfx-tick" src="./assets/tick.wav"></audio>

<div class="reticle" id="ret"><div class="dot"></div></div>
<div id="valueTip" style="left:50%;top:calc(50% + 28px);transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid var(--cy);border-radius:10px;padding:6px 10px;display:none">…</div>
<div id="errors">Errors: none</div>
<div id="toast" style="left:50%;top:58px;transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid var(--cy);border-radius:10px;padding:6px 10px;display:none">…</div>

<div class="hud">
  <div><span id="lblScore">คะแนน</span>: <span id="score">0</span> | <span id="lblCombo">คอมโบ</span>: <span id="combo">x1</span> | <span id="lblTime">เวลา</span>: <span id="time">60</span>s | <span id="lblBest">สถิติ</span>: <span id="best">0</span></div>
  <div><span id="lblMode">โหมด</span>: <span id="modeName">ดี vs ขยะ</span> | <span id="lblDiff">ความยาก</span>: <span id="difficulty">ปกติ</span></div>
  <div id="targetWrap">🎯 <span>หมวดเป้าหมาย</span>: <span id="targetBadge" style="border:1px solid #0ff;border-radius:10px;padding:2px 8px;background:rgba(0,0,0,.35)">—</span></div>
  <div id="plateTracker">🍱 โควตา: <div class="pills" id="platePills"></div></div>
</div>

<div id="menuBar">
  <div class="row">
    <button class="tag" data-action="mode" data-value="goodjunk" type="button">🥗 ดี vs ขยะ</button>
    <button class="tag" data-action="mode" data-value="groups" type="button">🍽️ จาน 5 หมู่</button>
    <button class="tag" data-action="mode" data-value="hydration" type="button">💧 สมดุลน้ำ</button>
    <button class="tag" data-action="mode" data-value="plate" type="button">🍱 จัดจานสุขภาพ</button>
  </div>
  <div class="row" style="margin:8px 0">
    <button class="tag" data-action="diff" data-value="Easy" type="button">ง่าย</button>
    <button class="tag" data-action="diff" data-value="Normal" type="button">ปกติ</button>
    <button class="tag" data-action="diff" data-value="Hard" type="button">ยาก</button>
  </div>
  <div class="row">
    <button class="btn" data-action="start" type="button">▶ เริ่มเกม</button>
    <button class="btn" data-action="pause" type="button">⏸ พัก</button>
    <button class="btn" data-action="restart" type="button">↻ เริ่มใหม่</button>
    <button class="btn" data-action="help" type="button">❓ วิธีเล่น</button>
  </div>
</div>

<div id="help" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center">
  <div style="background:rgba(8,12,20,.96);border:1px solid var(--cy);border-radius:16px;padding:18px 20px;color:#0ff;width:min(94vw,760px)">
    <h2>วิธีเล่น</h2>
    <div>คลิก/แตะ หรือจ้องใน VR (~0.7s) เก็บไอคอนตามกติกาโหมด</div>
    <div style="margin-top:10px;text-align:right"><button class="btn" data-action="helpClose" type="button">โอเค</button></div>
  </div>
</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.159.0/examples/js/VRButton.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const canvas=$("#c"); const dingEl=$("#sfx-ding"), thudEl=$("#sfx-thud"), tickEl=$("#sfx-tick");
  let AC=null, master=null, muted=false;
  function audioInit(){ try{AC=AC||new (window.AudioContext||window.webkitAudioContext)(); master=master||AC.createGain(); master.connect(AC.destination); master.gain.value=muted?0:0.22;}catch(e){} }
  function playAudio(el){ try{ if(el){ el.currentTime=0; el.volume= muted?0:0.9; el.play(); return true; } }catch(e){} return false; }
  function ding(){ if(!playAudio(dingEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='sine'; const t=AC.currentTime; o.frequency.setValueAtTime(880,t); o.frequency.exponentialRampToValueAtTime(1320,t+0.08); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.start(t); o.stop(t+0.24);} }
  function thud(){ if(!playAudio(thudEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='triangle'; const t=AC.currentTime; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(110,t+0.12); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.25); o.start(t); o.stop(t+0.27);} }
  function tick(){ if(!playAudio(tickEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='square'; const t=AC.currentTime; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.2,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06); o.start(t); o.stop(t+0.07);} }

  const renderer=new THREE.WebGLRenderer({canvas, antialias:true}); renderer.setClearColor(0x000000,0); renderer.xr.enabled=true;
  try{ const VRB=window.VRButton||(window.THREE&&window.THREE.VRButton); const vrEl=(VRB&&VRB.createButton)?VRB.createButton(renderer):null; if(vrEl){ const slot=document.createElement('div'); slot.style.position='fixed'; slot.style.right='8px'; slot.style.bottom='8px'; slot.style.zIndex=5; slot.appendChild(vrEl); document.body.appendChild(slot); } }catch(e){}
  const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(60,2,0.01,100); camera.position.set(0,1.6,2.8);
  scene.add(new THREE.AmbientLight(0xffffff,1.0)); const group=new THREE.Group(); scene.add(group); const raycaster=new THREE.Raycaster();

  function emojiTexture(char){ const s=128,c=document.createElement('canvas'); c.width=c.height=s; const cx=c.getContext('2d'); cx.font="100px system-ui, 'Apple Color Emoji', 'Segoe UI Emoji'"; cx.textAlign="center"; cx.textBaseline="middle"; cx.fillText(char,s/2,s/2); const tex=new THREE.CanvasTexture(c); tex.needsUpdate=true; return tex; }
  function makeEmoji(char){ const tex=emojiTexture(char); const geo=new THREE.PlaneGeometry(0.5,0.5); const mat=new THREE.MeshBasicMaterial({map:tex, transparent:true, side:THREE.DoubleSide, depthWrite:false}); const m=new THREE.Mesh(geo,mat); m.lookAt(camera.position); return m; }

  const LIB={
    good:["🥦","🍎","🍌","🍅","🥕","🍇","🍗","🥛","🍠","🌽","🥬","🍊"],
    junk:["🍟","🍔","🍕","🌭","🍰","🍩","🧁","🥤","🍫"],
    groups:{grains:["🍞","🍚","🥖","🥨"], protein:["🍗","🥚","🫘","🐟"], veggies:["🥦","🥕","🥬","🍅"], fruits:["🍎","🍌","🍇","🍊"], dairy:["🥛","🧀"]},
    hydra:{water:["💧","🚰"], sugar:["🥤","🧃","🧋"], soda:["🥤"]}
  };
  const groupsArr=['grains','protein','veggies','fruits','dairy'];
  const game={
    state:{mode:'goodjunk', difficulty:'Normal', running:false, paused:false, score:0, timeLeft:60, combo:1, comboMax:1, best:0, hits:0, misses:0},
    ACTIVE:new Set(), currentTarget:'grains', targetHits:0, plateQuota:null, plateTarget:null
  };

  const LANE_X=[-1.1,-0.55,0,0.55,1.1], LANE_Y=[-0.2,0.0,0.18,0.32], LANE_Z=-2.2;
  const occupied=new Set(), cooldown=new Map(); let lastLane=null; const now=()=>performance.now();
  const isAdj=(r,c)=>{ if(!lastLane) return false; const [pr,pc]=lastLane; return Math.abs(pr-r)<=1 && Math.abs(pc-c)<=1; };
  function pickLane(){ const cand=[]; for(let r=0;r<LANE_Y.length;r++){ for(let c=0;c<LANE_X.length;c++){ const k=r+','+c,cd=cooldown.get(k)||0,free=!occupied.has(k)&&now()>cd&&!isAdj(r,c); if(free) cand.push({r,c,k}); }} if(!cand.length) return null; const p=cand[Math.floor(Math.random()*cand.length)]; occupied.add(p.k); lastLane=[p.r,p.c]; return {x:LANE_X[p.c], y:1.6+LANE_Y[p.r], z:LANE_Z-0.1*Math.abs(p.c-2), key:p.k}; }
  function releaseLane(k){ occupied.delete(k); cooldown.set(k, now()+800); }

  function groupIcon(k){ return k==='grains'?'🍞':k==='protein'?'🍗':k==='veggies'?'🥦':k==='fruits'?'🍎':'🥛'; }
  function updateTargetLabel(){ const wrap=$("#targetWrap"), badge=$("#targetBadge"); if(game.state.mode!=='groups'){ wrap.style.display='none'; return; } wrap.style.display='block'; const name={grains:'ธัญพืช',protein:'โปรตีน',veggies:'ผัก',fruits:'ผลไม้',dairy:'นม'}[game.currentTarget]; badge.textContent=groupIcon(game.currentTarget)+" "+name; }
  function resetPlateQuota(){ const base={grains:2,veggies:2,protein:1,fruits:1,dairy:1}; if(game.state.difficulty==='Hard') base.veggies=3; game.plateTarget={...base}; game.plateQuota={...base}; renderPlateTracker(); }
  function renderPlateTracker(){ const wrap=$("#plateTracker"), pills=$("#platePills"); if(game.state.mode!=='plate'){ wrap.style.display='none'; return; } wrap.style.display='block'; const names={grains:'ธัญพืช',protein:'โปรตีน',veggies:'ผัก',fruits:'ผลไม้',dairy:'นม'}; const order=['grains','veggies','protein','fruits','dairy']; pills.innerHTML=order.map(k=>{ const need=game.plateTarget?.[k]||0; const left=game.plateQuota?.[k]||0; const have=Math.max(0,need-left); const done=left<=0; return `<span class="pill ${done?'done':''}" title="${names[k]}"><span>${groupIcon(k)}</span><span>${have}</span>/<span>${need}</span></span>`; }).join(''); }

  function pickMeta(){
    if(game.state.mode==='goodjunk'){ const goodBias=game.state.difficulty==='Easy'?0.72:game.state.difficulty==='Hard'?0.46:0.6; return {type:'gj', good:Math.random()<goodBias}; }
    if(game.state.mode==='groups'){ return {type:'group', group: (Math.random()<0.65?game.currentTarget:groupsArr[Math.floor(Math.random()*groupsArr.length)])}; }
    if(game.state.mode==='hydration'){ const rate=game.state.difficulty==='Easy'?0.78:game.state.difficulty==='Hard'?0.55:0.66; return {type:'hydra', water: Math.random()<rate}; }
    const g=groupsArr[Math.floor(Math.random()*groupsArr.length)]; return {type:'plate', group:g};
  }
  function charFor(m){ if(m.type==='gj') return (m.good? LIB.good[Math.floor(Math.random()*LIB.good.length)] : LIB.junk[Math.floor(Math.random()*LIB.junk.length)]); if(m.type==='group'||m.type==='plate'){ const arr=LIB.groups[m.group]; return arr[Math.floor(Math.random()*arr.length)]; } if(m.type==='hydra'){ return m.water? '💧':'🥤'; } return '🍽️'; }

  function spawn(){ const lane=pickLane(); if(!lane) return; const meta=pickMeta(); const ch=charFor(meta); const m=makeEmoji(ch); m.position.set(lane.x,lane.y,lane.z); m.userData={lane:lane.key, meta}; group.add(m); game.ACTIVE.add(m);
    const life= game.state.difficulty==='Hard'?1900:game.state.difficulty==='Easy'?4200:3000;
    m.userData.timer=setTimeout(()=>{ if(!m.parent) return; if(meta.type==='gj' && meta.good===false){ game.state.score+=1; } if(meta.type==='groups' && meta.group===game.currentTarget){ game.state.combo=1; } if(meta.type==='hydra' && !meta.water){ game.state.score+=1; } updateHUD(); destroy(m); }, life + Math.floor(Math.random()*500-250)); }

  function destroy(obj){ if(obj.parent) obj.parent.remove(obj); game.ACTIVE.delete(obj); releaseLane(obj.userData.lane); }

  function hit(obj){ const m=obj.userData.meta; let delta=0;
    if(m.type==='gj'){ if(m.good){ delta=5*game.state.combo; game.state.combo=Math.min(6,game.state.combo+1); ding(); } else { delta=-2; game.state.combo=1; thud(); } }
    else if(m.type==='group'){ if(m.group===game.currentTarget){ delta=7*game.state.combo; game.state.combo=Math.min(6,game.state.combo+1); ding(); game.targetHits++; if(game.targetHits>=3){ game.targetHits=0; const arr=groupsArr.filter(x=>x!==game.currentTarget); game.currentTarget=arr[Math.floor(Math.random()*arr.length)]; updateTargetLabel(); } } else { delta=-2; game.state.combo=1; thud(); } }
    else if(m.type==='hydra'){ if(m.water){ delta=5*game.state.combo; game.state.combo=Math.min(6,game.state.combo+1); ding(); } else { delta=-3; game.state.combo=1; thud(); } }
    else if(m.type==='plate'){ if(!game.plateQuota) resetPlateQuota(); if(game.plateQuota[m.group]>0){ game.plateQuota[m.group]-=1; renderPlateTracker(); delta=6*game.state.combo; ding(); if(Object.values(game.plateQuota).every(v=>v<=0)){ delta+=14; resetPlateQuota(); } } else { delta=2; ding(); } game.state.combo=Math.min(6,game.state.combo+1); }
    game.state.score=Math.max(0, game.state.score+delta); updateHUD();
  }

  function onClickCanvas(ev){ if(!game.state.running||game.state.paused) return; const r=canvas.getBoundingClientRect(); const x=(ev.clientX-r.left)/r.width*2-1; const y=-(ev.clientY-r.top)/r.height*2+1; const m=new THREE.Vector2(x,y); raycaster.setFromCamera(m,camera); const inter=raycaster.intersectObjects(Array.from(game.ACTIVE)); if(inter.length){ const o=inter[0].object; hit(o); destroy(o); } }

  function updateHUD(){ $("#score").textContent=game.state.score; $("#time").textContent=game.state.timeLeft; $("#difficulty").textContent=game.state.difficulty; $("#combo").textContent='x'+game.state.combo; $("#modeName").textContent=(game.state.mode==='goodjunk'?'ดี vs ขยะ':game.state.mode==='groups'?'จาน 5 หมู่':game.state.mode==='hydration'?'สมดุลน้ำ':'จัดจานสุขภาพ'); renderPlateTracker(); updateTargetLabel(); }

  let spH=null, tmH=null, SPAWN_COUNT=0;
  function loop(){ if(!game.state.running||game.state.paused) return; spawn(); SPAWN_COUNT++; const base=700; const accel=Math.max(0.5,1-(SPAWN_COUNT/120)); const next=Math.max(320,base*accel); spH=setTimeout(loop,next); }
  function timer(){ if(!game.state.running||game.state.paused) return; tmH=setTimeout(()=>{ game.state.timeLeft--; updateHUD(); if(game.state.timeLeft<=0) endGame(); else timer(); },1000); }
  function start(){ $("#help").style.display='none'; game.state.running=true; game.state.paused=false; game.state.score=0; game.state.combo=1; game.state.timeLeft=60; game.targetHits=0; if(game.state.mode==='groups'){ game.currentTarget='grains'; } if(game.state.mode==='plate'){ resetPlateQuota(); } updateHUD(); setTimeout(spawn,200); loop(); timer(); canvas.style.pointerEvents='auto'; }
  function pause(){ if(!game.state.running) return; game.state.paused=!game.state.paused; if(!game.state.paused){ loop(); timer(); } }
  function endGame(){ game.state.running=false; game.state.paused=false; clearTimeout(spH); clearTimeout(tmH); canvas.style.pointerEvents='none'; }

  document.getElementById('menuBar').addEventListener('click',(e)=>{ const btn=e.target.closest('button'); if(!btn) return; const act=btn.getAttribute('data-action'); const val=btn.getAttribute('data-value'); e.preventDefault(); e.stopPropagation();
    if(act==='start') start(); else if(act==='pause') pause(); else if(act==='restart'){ endGame(); start(); } else if(act==='help'){ document.getElementById('help').style.display='flex'; }
    else if(act==='mode'){ game.state.mode=val; if(val!=='plate'){ document.getElementById('plateTracker').style.display='none'; } updateHUD(); }
    else if(act==='diff'){ game.state.difficulty=val; updateHUD(); if(game.state.mode==='plate'){ renderPlateTracker(); } }
  }, false);
  document.getElementById('help').addEventListener('click',(e)=>{ if(e.target.getAttribute('data-action')==='helpClose' || e.target.id==='help') e.currentTarget.style.display='none'; });
  canvas.addEventListener('click', onClickCanvas);
  canvas.addEventListener('touchstart',(e)=>{ if(e.touches&&e.touches[0]) onClickCanvas({clientX:e.touches[0].clientX, clientY:e.touches[0].clientY}); }, {passive:true});
  function resize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); } addEventListener('resize', resize); resize();
  renderer.setAnimationLoop(()=>{ renderer.render(scene,camera); });
  window.onerror=(msg,src,line,col)=>{ const err=document.getElementById('errors'); err.style.display='block'; err.textContent="Errors: "+msg+" @"+(src||'inline')+":"+line+":"+col; };
  canvas.style.pointerEvents='none';
})();</script>
</body></html>
