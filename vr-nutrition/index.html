<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>EAT TO POWER ‚Äì HERO ACADEMY (PRO B4)</title>
<link rel="icon" href="./assets/logo.png"/>
<style>
  :root{ --bg:#061018; --cy:#0ff; --cy2:rgba(0,255,255,.12); --card:rgba(8,12,20,.96); }
  html,body{margin:0;height:100%;overflow:hidden;background:#000}
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:url('./assets/background.jpg') center/cover no-repeat fixed;
    filter:saturate(1.2) brightness(1.05);
    z-index:0;
  }
  canvas#c{position:fixed;inset:0;display:block;background:transparent;z-index:1}
  .brand{position:fixed; left:12px; top:10px; z-index:3; display:flex; gap:8px; align-items:center; color:#aee; font-family:Rajdhani,Exo 2,system-ui; text-shadow:0 0 10px rgba(0,255,255,.55)}
  .brand img{height:42px; filter:drop-shadow(0 0 10px rgba(0,255,255,.35))}
  .hud,#menuBar,#summary,.reticle,#errors,#vrSlot,#valueTip,#toast,#help{position:fixed; z-index:4; color:#0ff; font-family:Rajdhani, Exo 2, system-ui; text-shadow:0 0 8px rgba(0,255,255,.6)}
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center;max-width:min(96vw,1180px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
  .btn,.tag{display:inline-block;padding:10px 14px;border:1px solid var(--cy);border-radius:12px;background:rgba(0,0,0,.35);color:var(--cy);cursor:pointer;user-select:none}
  .btn:hover,.tag:hover{background:var(--cy2)}
  #errors{top:8px;right:8px;max-width:48ch;background:rgba(30,0,0,.85);padding:6px 10px;border:1px solid #f66;border-radius:8px;color:#ffb;display:none}
  /* click fix */
  #menuBar, #menuBar * { pointer-events:auto !important; }
  #help, #summary { pointer-events:auto !important; }
  .reticle, #valueTip, #toast { pointer-events:none !important; }
  canvas#c { pointer-events:none; }
</style>
<link rel="preload" href="./assets/ding.wav" as="audio"/>
<link rel="preload" href="./assets/thud.wav" as="audio"/>
<link rel="preload" href="./assets/tick.wav" as="audio"/>
</head>
<body>
<div class="brand"><img src="./assets/logo.png" alt="logo"/><div>EAT TO POWER ‚Äì HERO ACADEMY</div></div>
<canvas id="c"></canvas>
<audio id="sfx-ding" src="./assets/ding.wav"></audio>
<audio id="sfx-thud" src="./assets/thud.wav"></audio>
<audio id="sfx-tick" src="./assets/tick.wav"></audio>

<div class="reticle" id="ret" style="left:50%;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border:2px solid var(--cy);border-radius:50%"><div class="dot" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:var(--cy)"></div></div>
<div id="valueTip" style="left:50%;top:calc(50% + 28px);transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid var(--cy);border-radius:10px;padding:6px 10px;display:none">‚Ä¶</div>
<div id="errors">Errors: none</div>
<div id="toast" style="left:50%;top:58px;transform:translateX(-50%);background:rgba(0,0,0,.45);border:1px solid var(--cy);border-radius:10px;padding:6px 10px;display:none">‚Ä¶</div>

<div class="hud">
  <div><span id="lblScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>: <span id="score">0</span> |
      <span id="lblCombo">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>: <span id="combo">x1</span> |
      <span id="lblTime">‡πÄ‡∏ß‡∏•‡∏≤</span>: <span id="time">60</span>s |
      <span id="lblBest">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>: <span id="best">0</span>
      <span id="fever" style="display:none;margin-left:8px;border:1px solid #ff3;border-radius:999px;padding:2px 10px;color:#ff3;text-shadow:0 0 10px rgba(255,240,0,.85)">FEVER!</span></div>
  <div><span id="lblMode">‡πÇ‡∏´‡∏°‡∏î</span>: <span id="modeName">‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</span> |
      <span id="lblDiff">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</span>: <span id="difficulty">‡∏õ‡∏Å‡∏ï‡∏¥</span></div>
</div>

<div id="menuBar">
  <div class="row" id="modes">
    <button class="tag" data-action="mode" data-value="goodjunk" type="button">ü•ó ‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</button>
    <button class="tag" data-action="mode" data-value="groups" type="button">üçΩÔ∏è ‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà</button>
    <button class="tag" data-action="mode" data-value="hydration" type="button">üíß ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡πâ‡∏≥</button>
    <button class="tag" data-action="mode" data-value="plate" type="button">üç± ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
  </div>
  <div class="row" id="diff" style="margin:8px 0">
    <button class="tag" data-action="diff" data-value="Easy" type="button">‡∏á‡πà‡∏≤‡∏¢</button>
    <button class="tag" data-action="diff" data-value="Normal" type="button">‡∏õ‡∏Å‡∏ï‡∏¥</button>
    <button class="tag" data-action="diff" data-value="Hard" type="button">‡∏¢‡∏≤‡∏Å</button>
  </div>
  <div class="row" id="ctrls">
    <button class="btn" data-action="start" type="button">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <button class="btn" data-action="pause" type="button">‚è∏ ‡∏û‡∏±‡∏Å</button>
    <button class="btn" data-action="restart" type="button">‚Üª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    <button class="btn" data-action="help" type="button">‚ùì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
  </div>
</div>

<div id="help" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center">
  <div style="background:rgba(8,12,20,.96);border:1px solid var(--cy);border-radius:16px;padding:18px 20px;color:#0ff;width:min(94vw,760px)">
    <h2>‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</h2>
    <div>‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÅ‡∏ï‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡πâ‡∏≠‡∏á‡πÉ‡∏ô VR (~0.7s) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î</div>
    <div style="margin-top:10px;text-align:right"><button class="btn" data-action="helpClose" type="button">‡πÇ‡∏≠‡πÄ‡∏Ñ</button></div>
  </div>
</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.159.0/examples/js/VRButton.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const canvas=$("#c");
  const dingEl=$("#sfx-ding"), thudEl=$("#sfx-thud"), tickEl=$("#sfx-tick");

  let AC=null, master=null, muted=false;
  function audioInit(){ try{AC=AC||new (window.AudioContext||window.webkitAudioContext)(); master=master||AC.createGain(); master.connect(AC.destination); master.gain.value=muted?0:0.22;}catch(e){} }
  function playAudio(el){ try{ if(el){ el.currentTime=0; el.volume= muted?0:0.85; el.play(); return true; } }catch(e){} return false; }
  function ding(){ if(!playAudio(dingEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='sine'; const t=AC.currentTime; o.frequency.setValueAtTime(880,t); o.frequency.exponentialRampToValueAtTime(1320,t+0.08); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.start(t); o.stop(t+0.24);} }
  function thud(){ if(!playAudio(thudEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='triangle'; const t=AC.currentTime; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(110,t+0.12); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.25); o.start(t); o.stop(t+0.27);} }
  function tick(){ if(!playAudio(tickEl)){ if(!AC) audioInit(); if(!AC) return; const o=AC.createOscillator(),g=AC.createGain(); o.connect(g); g.connect(master); o.type='square'; const t=AC.currentTime; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.2,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06); o.start(t); o.stop(t+0.07);} }

  const renderer=new THREE.WebGLRenderer({canvas, antialias:true}); renderer.setClearColor(0x000000,0); renderer.xr.enabled=true;
  try{ const VRB=window.VRButton||(window.THREE&&window.THREE.VRButton); const vrEl=(VRB&&VRB.createButton)?VRB.createButton(renderer):null; if(vrEl){ const slot=document.createElement('div'); slot.style.position='fixed'; slot.style.right='8px'; slot.style.bottom='8px'; slot.style.zIndex=5; slot.appendChild(vrEl); document.body.appendChild(slot); } }catch(e){}
  const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(60,2,0.01,100); camera.position.set(0,1.6,2.8);
  scene.add(new THREE.AmbientLight(0xffffff,1.0)); const group=new THREE.Group(); scene.add(group);
  const raycaster=new THREE.Raycaster();

  function emojiTexture(char){ const s=128, cnv=document.createElement('canvas'); cnv.width=cnv.height=s; const ctx=cnv.getContext('2d'); ctx.font="100px system-ui, 'Apple Color Emoji', 'Segoe UI Emoji'"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(char,s/2,s/2); const tex=new THREE.CanvasTexture(cnv); tex.needsUpdate=true; return tex; }
  function makeEmoji(char){ const tex=emojiTexture(char); const geo=new THREE.PlaneGeometry(0.5,0.5); const mat=new THREE.MeshBasicMaterial({map:tex, transparent:true, side:THREE.DoubleSide, depthWrite:false}); const m=new THREE.Mesh(geo,mat); m.lookAt(camera.position); return m; }

  const game={ state:{mode:'goodjunk', difficulty:'Normal', running:false, paused:false, score:0, timeLeft:60, combo:1, comboMax:1, best:0}, ACTIVE:new Set() };
  const LIB={ good:["ü•¶","üçé","üçå","üçÖ","ü•ï","üçá","üçó","ü•õ","üç†","üåΩ","ü•¨","üçä"], junk:["üçü","üçî","üçï","üå≠","üç∞","üç©","üßÅ","ü•§","üç´"] };

  const LANE_X=[-1.1,-0.55,0,0.55,1.1], LANE_Y=[-0.2,0.0,0.18,0.32], LANE_Z=-2.2;
  const occupied=new Set(), cooldown=new Map(); let lastLane=null; const now=()=>performance.now();
  const isAdj=(r,c)=>{ if(!lastLane) return false; const [pr,pc]=lastLane; return Math.abs(pr-r)<=1 && Math.abs(pc-c)<=1; };
  function pickLane(){ const cand=[]; for(let r=0;r<LANE_Y.length;r++){ for(let c=0;c<LANE_X.length;c++){ const k=r+','+c,cd=cooldown.get(k)||0,free=!occupied.has(k)&&now()>cd&&!isAdj(r,c); if(free) cand.push({r,c,k}); }} if(!cand.length) return null; const p=cand[Math.floor(Math.random()*cand.length)]; occupied.add(p.k); lastLane=[p.r,p.c]; return {x:LANE_X[p.c], y:1.6+LANE_Y[p.r], z:LANE_Z-0.1*Math.abs(p.c-2), key:p.k}; }
  function releaseLane(k){ occupied.delete(k); cooldown.set(k, now()+800); }

  function spawn(){
    const lane=pickLane(); if(!lane) return;
    const goodBias= game.state.difficulty==='Easy'?0.72:game.state.difficulty==='Hard'?0.46:0.6;
    const isGood=Math.random()<goodBias;
    const ch = isGood ? LIB.good[Math.floor(Math.random()*LIB.good.length)] : LIB.junk[Math.floor(Math.random()*LIB.junk.length)];
    const m=makeEmoji(ch); m.position.set(lane.x,lane.y,lane.z); m.userData={lane:lane.key, good:isGood};
    group.add(m); game.ACTIVE.add(m);
    const life= game.state.difficulty==='Hard'?1900:game.state.difficulty==='Easy'?4200:3000;
    m.userData.timer=setTimeout(()=>{ if(!m.parent) return; destroy(m); }, life + Math.floor(Math.random()*500-250));
  }

  function destroy(obj){ if(obj.parent) obj.parent.remove(obj); game.ACTIVE.delete(obj); releaseLane(obj.userData.lane); }

  function onClickCanvas(ev){ if(!game.state.running||game.state.paused) return;
    const r=canvas.getBoundingClientRect(); const x=(ev.clientX-r.left)/r.width*2-1; const y=-(ev.clientY-r.top)/r.height*2+1;
    const m=new THREE.Vector2(x,y); raycaster.setFromCamera(m,camera);
    const inter=raycaster.intersectObjects(Array.from(game.ACTIVE));
    if(inter.length){ const o=inter[0].object; hit(o); destroy(o); }
  }

  function hit(obj){ const g=obj.userData.good===true; if(g){ ding(); game.state.score+=5*game.state.combo; game.state.combo=Math.min(6,game.state.combo+1);} else { thud(); game.state.combo=1; } updateHUD(); }

  function updateHUD(){ document.getElementById('score').textContent=game.state.score; document.getElementById('time').textContent=game.state.timeLeft; document.getElementById('difficulty').textContent=game.state.difficulty; document.getElementById('combo').textContent='x'+game.state.combo; }

  let spH=null, tmH=null, SPAWN_COUNT=0;
  function loop(){ if(!game.state.running||game.state.paused) return; spawn(); SPAWN_COUNT++; const base=700; const accel=Math.max(0.5,1-(SPAWN_COUNT/120)); const next=Math.max(320,base*accel); spH=setTimeout(loop,next); }
  function timer(){ if(!game.state.running||game.state.paused) return; tmH=setTimeout(()=>{ game.state.timeLeft--; updateHUD(); if(game.state.timeLeft<=0) endGame(); else timer(); },1000); }
  function start(){ document.getElementById('help').style.display='none'; game.state.running=true; game.state.paused=false; game.state.score=0; game.state.combo=1; game.state.timeLeft=60; updateHUD(); setTimeout(spawn,200); loop(); timer(); canvas.style.pointerEvents='auto'; }
  function pause(){ if(!game.state.running) return; game.state.paused=!game.state.paused; if(!game.state.paused){ loop(); timer(); } }
  function endGame(){ game.state.running=false; game.state.paused=false; clearTimeout(spH); clearTimeout(tmH); canvas.style.pointerEvents='none'; }

  document.getElementById('menuBar').addEventListener('click', (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const act=btn.getAttribute('data-action'); const val=btn.getAttribute('data-value'); e.preventDefault(); e.stopPropagation();
    if(act==='start') start(); else if(act==='pause') pause(); else if(act==='restart'){ endGame(); start(); } else if(act==='help'){ document.getElementById('help').style.display='flex'; }
    else if(act==='mode'){ game.state.mode=val; } else if(act==='diff'){ game.state.difficulty=val; updateHUD(); }
  }, false);
  document.getElementById('help').addEventListener('click',(e)=>{ if(e.target.getAttribute('data-action')==='helpClose' || e.target.id==='help') e.currentTarget.style.display='none'; });

  canvas.addEventListener('click', onClickCanvas);
  canvas.addEventListener('touchstart',(e)=>{ if(e.touches&&e.touches[0]) onClickCanvas({clientX:e.touches[0].clientX, clientY:e.touches[0].clientY}); }, {passive:true});

  function resize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
  addEventListener('resize', resize); resize();
  renderer.setAnimationLoop(()=>{ renderer.render(scene,camera); });

  window.onerror=(msg,src,line,col)=>{ const err=document.getElementById('errors'); err.style.display='block'; err.textContent="Errors: "+msg+" @"+(src||'inline')+":"+line+":"+col; };
  canvas.style.pointerEvents='none';
})();</script>
</body>
</html>
