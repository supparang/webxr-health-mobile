<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>VR Nutrition ‚Äî ULTRA DIAG</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js" defer></script>
<style>
  html,body{margin:0;height:100%;background:#050910;overflow:hidden}
  a-scene,canvas.a-canvas{position:fixed;inset:0;z-index:0}
  body:not(.game-running) a-scene, body:not(.game-running) canvas.a-canvas, body:not(.game-running) .a-enter-vr{pointer-events:none!important}
  .hud,#menuBar,#dbg,.fallback2d{position:fixed;z-index:2147483647!important;pointer-events:auto!important;font-family:system-ui;color:#0ff}
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center;text-shadow:0 0 8px rgba(0,255,255,.7)}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center}
  .btn{display:inline-block;padding:10px 14px;margin:0 6px;border:1px solid #0ff;border-radius:12px;background:rgba(0,0,0,.35);color:#0ff;cursor:pointer}
  #dbg{left:8px;bottom:8px;background:rgba(0,0,0,.6);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px}
  .fallback2d{inset:auto 0 0 0; height:120px; background:rgba(0,0,0,.35); display:none}
  .sq{position:absolute;width:24px;height:24px;background:#0ff;opacity:0.8}
</style>
</head>
<body>
  <div class="hud">
    Score: <span id="score">0</span> | Combo: <span id="combo">x1</span> | Time: <span id="time">60</span>s
    <div style="font-size:12px;opacity:.9">
      sceneLoaded=<span id="sLoaded">0</span> ‚Ä¢ canvas=<span id="hasCanvas">0</span> ‚Ä¢ children(spawner)=<span id="childCount">0</span>
    </div>
  </div>
  <div id="menuBar">
    <button id="btnStart" class="btn">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <button id="btnSpawn1" class="btn">‚¨ú Spawn 1</button>
    <button id="btnRestart" class="btn">‚Üª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    <button id="btn2d" class="btn">üü¶ 2D Fallback</button>
  </div>
  <div id="dbg">STATE: ready</div>

  <div class="fallback2d" id="fb2d"></div>

  <a-scene id="scene" background="color:#050910" loading-screen="enabled:false" stats
           renderer="antialias:true; highRefreshRate:true; colorManagement:true">
    <a-entity light="type: ambient; color: #BBB"></a-entity>
    <a-entity light="type: hemisphere; color: #fffff0; groundColor: #222; intensity: 0.9"></a-entity>
    <a-sky color="#050910"></a-sky>

    <!-- Camera -->
    <a-entity id="playerCam" position="0 1.6 0" camera look-controls
              raycaster="objects: .clickable; far: 12"
              cursor="rayOrigin: entity; fuse: true; fuseTimeout: 700">
      <a-entity position="0 0 -1" geometry="primitive:ring;radiusInner:0.005;radiusOuter:0.008"
                material="color:#0ff;shader:flat;opacity:0.9"></a-entity>
    </a-entity>

    <!-- Mouse ray -->
    <a-entity id="mouseRig" cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 12"></a-entity>

    <!-- BIG STATIC BOX to confirm 3D render -->
    <a-box id="bigbox" position="0 1.6 -1.4" depth="0.5" height="0.5" width="0.5"
           color="#0ff" material="emissive:#0ff; emissiveIntensity:0.6"
           animation__pulse="property: scale; to: 0.55 0.55 0.55; dir: alternate; loop: true; dur: 800"></a-box>

    <a-entity id="spawnerRoot" position="0 0 0"></a-entity>
  </a-scene>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const dbg=(m)=>{ $("#dbg").textContent="STATE: "+m; };

  const APP={running:false,paused:false,score:0,timeLeft:60,combo:1};
  let spawnH=null,timerH=null,watchdogH=null, SPAWN_COUNT=0;

  function setHUD(){
    $("#score").textContent=APP.score; $("#time").textContent=APP.timeLeft; $("#combo").textContent='x'+APP.combo;
    const canvas=document.querySelector('canvas.a-canvas'); $("#hasCanvas").textContent=canvas?1:0;
    const root=$("#spawnerRoot"); $("#childCount").textContent=root?root.children.length:0;
  }

  function rand(a,b){ return a + Math.random()*(b-a); }
  function spawnOne(){
    const root=$("#spawnerRoot");
    if(!root) return;
    const xs=[-0.8,0,0.8][Math.floor(Math.random()*3)];
    const ys=[-0.1,0.06,0.22][Math.floor(Math.random()*3)];
    const z = -2 + (Math.random()*0.4-0.2);
    const colors=['#39d','#0f9','#fd0','#f55','#9f6','#0ff','#f0f','#fa0','#0fa','#a0f'];
    const c=colors[Math.floor(Math.random()*colors.length)];
    const box=document.createElement('a-box');
    box.setAttribute('depth','0.18'); box.setAttribute('height','0.38'); box.setAttribute('width','0.38');
    box.setAttribute('color', c);
    box.setAttribute('material', 'shader:standard; metalness:0.05; roughness:0.6; emissive:#000');
    box.setAttribute('position',`${xs} ${1.6+ys} ${z}`);
    box.setAttribute('class','clickable');
    box.setAttribute('animation__float',`property: position; dir: alternate; loop: true; dur: 900; to: ${xs} ${1.6+ys+0.08} ${z}`);
    box.addEventListener('click',()=>{ APP.score+=5; setHUD(); if(box.parentNode) box.parentNode.removeChild(box); });
    root.appendChild(box); SPAWN_COUNT++; setHUD();
    setTimeout(()=>{ if(box.parentNode) box.parentNode.removeChild(box); setHUD(); }, 3200);
  }

  function loop(){ if(!APP.running||APP.paused) return; spawnOne(); spawnH=setTimeout(loop, 740); }
  function tick(){ if(!APP.running||APP.paused) return; timerH=setTimeout(()=>{ APP.timeLeft--; setHUD(); if(APP.timeLeft<=0){ stop(); } else tick(); }, 1000); }

  function start(){ APP.running=true; APP.paused=false; document.body.classList.add('game-running'); setHUD();
    setTimeout(()=>spawnOne(), 200); loop(); tick(); dbg('start'); watchdog(); }
  function stop(){ APP.running=false; APP.paused=false; clearTimeout(spawnH); clearTimeout(timerH); clearTimeout(watchdogH); dbg('stopped'); }
  function restart(){ stop(); APP.score=0; APP.timeLeft=60; setHUD(); start(); }

  function watchdog(){
    clearTimeout(watchdogH);
    let seenTime=APP.timeLeft, seenSp=SPAWN_COUNT;
    function pulse(){
      const stuck = (APP.timeLeft===seenTime) || (SPAWN_COUNT===seenSp);
      if(stuck){ clearTimeout(spawnH); clearTimeout(timerH); setTimeout(()=>{ spawnOne(); loop(); tick(); }, 150); dbg('watchdog kick'); }
      seenTime=APP.timeLeft; seenSp=SPAWN_COUNT;
      watchdogH=setTimeout(pulse, 1500);
    }
    pulse();
  }

  // Buttons
  $("#btnStart").addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  $("#btnRestart").addEventListener('click', (e)=>{ e.preventDefault(); restart(); });
  $("#btnSpawn1").addEventListener('click', (e)=>{ e.preventDefault(); spawnOne(); });
  $("#btn2d").addEventListener('click', (e)=>{
    const fb=$("#fb2d"); fb.style.display = (fb.style.display==='block')?'none':'block';
    if(fb.style.display==='block'){ // animate 2D squares as fallback
      fb.innerHTML='';
      const W=window.innerWidth, H=120;
      for(let i=0;i<14;i++){const d=document.createElement('div'); d.className='sq'; d.style.left=Math.floor(Math.random()* (W-24))+'px'; d.style.top=Math.floor(Math.random()*(H-24))+'px'; fb.appendChild(d);}
      function tick2d(){
        if(fb.style.display!=='block') return;
        for(const s of fb.querySelectorAll('.sq')){
          const x=parseFloat(s.style.left); let nx=x + (Math.random()*10-5); if(nx<0) nx=0; if(nx>W-24) nx=W-24; s.style.left=nx+'px';
          const y=parseFloat(s.style.top); let ny=y + (Math.random()*10-5); if(ny<0) ny=0; if(ny>H-24) ny=H-24; s.style.top=ny+'px';
        }
        requestAnimationFrame(tick2d);
      }
      requestAnimationFrame(tick2d);
    }
  });

  // Scene loaded?
  document.getElementById('scene').addEventListener('loaded',()=>{ $("#sLoaded").textContent=1; setHUD(); dbg('scene loaded'); });

  setHUD(); dbg('ready');
})();</script>
</body>
</html>
