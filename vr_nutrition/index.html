<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Nutrition VR ‚Äî Full (A+B+C+D+E)</title>
<style>
  html,body{margin:0;height:100%;background:#061018;overflow:hidden}
  canvas#c{position:fixed;inset:0;display:block;background:#061018;z-index:0}
  .hud,#menuBar,#summary,#dbg,.reticle,#boot,#errors,#clicklog,#vrSlot{
    position:fixed; z-index:2147483600; color:#0ff; font-family:system-ui; text-shadow:0 0 8px rgba(0,255,255,.6)
  }
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center;max-width:min(96vw,1100px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
  .btn,.tag{display:inline-block;padding:10px 14px;border:1px solid #0ff;border-radius:12px;background:rgba(0,0,0,.35);color:#0ff;cursor:pointer;user-select:none}
  .tag{border-style:dashed}
  .btn:hover,.tag:hover{background:rgba(0,255,255,.12)}
  #summary{inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
  .card{background:rgba(8,12,20,.96);border:1px solid #0ff;border-radius:16px;padding:18px 20px;color:#0ff;width:min(94vw,680px);text-align:center}
  #dbg{left:8px;bottom:8px;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px}
  #boot{top:8px;left:8px;background:#064;padding:6px 10px;border-radius:8px;border:1px solid #0f8;color:#fff}
  #errors{top:8px;right:8px;max-width:48ch;background:rgba(30,0,0,.85);padding:6px 10px;border:1px solid #f66;border-radius:8px;color:#ffb;display:none}
  #clicklog{right:8px;bottom:8px;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;border:1px solid #0ff;font-size:12px;max-width:46ch;display:none}
  #fever{display:none;margin-left:8px;border:1px solid #ff3;border-radius:999px;padding:2px 10px;color:#ff3;text-shadow:0 0 10px rgba(255,240,0,.85)}
  body.fever .hud{color:#fff8b0}
  body.fever #fever{display:inline-block}
  /* Reticle for VR */
  .reticle{left:50%;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border:2px solid #0ff;border-radius:50%;pointer-events:none;opacity:.9}
  .reticle .dot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:#0ff}
  .reticle.progress{border-color:#ff0}
  /* Quick toasts */
  #toast{position:fixed;left:50%;top:58px;transform:translateX(-50%);z-index:2147483600;color:#fff;background:rgba(0,0,0,.45);border:1px solid #0ff;border-radius:10px;padding:6px 10px;display:none}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="reticle" id="ret"><div class="dot"></div></div>

<div id="boot">BOOT: JS initialized</div>
<div id="errors">Errors: none</div>
<div id="toast">‚Ä¶</div>

<div class="hud">
  <div><span id="lblScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>: <span id="score">0</span> |
       <span id="lblCombo">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>: <span id="combo">x1</span> |
       <span id="lblTime">‡πÄ‡∏ß‡∏•‡∏≤</span>: <span id="time">60</span>s |
       <span id="lblBest">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>: <span id="best">0</span>
       <span id="fever">FEVER!</span>
  </div>
  <div><span id="lblMode">‡πÇ‡∏´‡∏°‡∏î</span>: <span id="modeName">‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</span> |
       <span id="lblDiff">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</span>: <span id="difficulty">Normal</span></div>
</div>

<div id="menuBar">
  <div class="row" id="modes">
    <button class="tag" data-action="mode" data-value="goodjunk" type="button">ü•ó <span data-i18n="modeGJ">‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞</span></button>
    <button class="tag" data-action="mode" data-value="groups" type="button">üçΩÔ∏è <span data-i18n="modeGroups">‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà</span></button>
    <button class="tag" data-action="mode" data-value="hydration" type="button">üíß <span data-i18n="modeHydra">Hydration</span></button>
    <button class="tag" data-action="mode" data-value="plate" type="button">üç± <span data-i18n="modePlate">Build Plate</span></button>
  </div>
  <div class="row" id="diff" style="margin:8px 0">
    <button class="tag" data-action="diff" data-value="Easy" type="button">Easy</button>
    <button class="tag" data-action="diff" data-value="Normal" type="button">Normal</button>
    <button class="tag" data-action="diff" data-value="Hard" type="button">Hard</button>
  </div>
  <div class="row" id="ctrls">
    <button class="btn" data-action="start" type="button">‚ñ∂ <span data-i18n="start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</span></button>
    <button class="btn" data-action="pause" type="button">‚è∏ <span data-i18n="pause">‡∏û‡∏±‡∏Å</span></button>
    <button class="btn" data-action="restart" type="button">‚Üª <span data-i18n="restart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</span></button>
    <button class="btn" data-action="lang" type="button">üåê ‡πÑ‡∏ó‡∏¢/English</button>
    <button class="btn" data-action="logger" type="button">ü™µ Log</button>
    <span id="vrSlot"></span>
  </div>
</div>

<div id="summary">
  <div class="card">
    <div style="font-size:20px;margin-bottom:8px"><b id="sumTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</b></div>
    <div id="sumStars" style="font-size:28px;margin:8px 0 4px">‚òÖ‚òÜ‚òÜ</div>
    <div id="sumBody">Score: 0 ‚Ä¢ Combo Max: x1 ‚Ä¢ Mode: ‚Äî ‚Ä¢ Diff: ‚Äî</div>
    <div style="margin-top:12px"><button class="btn" data-action="restart" type="button">‚Üª <span data-i18n="restart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</span></button></div>
  </div>
</div>

<div id="dbg">STATE: boot</div>
<div id="clicklog">clicklog: idle</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<!-- Non-module VRButton to ensure global VRButton exists -->
<script src="https://unpkg.com/three@0.159.0/examples/js/VRButton.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const logEl=$("#clicklog"), errEl=$("#errors"), toast=$("#toast");
  const clog=(msg)=>{ if(logEl.style.display!=='none') logEl.textContent="clicklog: "+msg; };
  const dbg=(m)=>$("#dbg").textContent='STATE: '+m;
  const say=(text)=>{ try{ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text);
    u.lang = state.lang==='th' ? 'th-TH' : 'en-US'; u.rate= state.lang==='th'? 1.0 : 1.05; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }catch(e){} };
  const showToast=(msg,ms=1600)=>{ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); };
  window.onerror = (msg, src, line, col)=>{ errEl.style.display='block'; errEl.textContent="Errors: "+msg+" @"+(src||'inline')+":"+line+":"+col; };

  // State / I18N
  const state={
    lang: localStorage.getItem('ng_lang') || 'th',
    difficulty: localStorage.getItem('ng_diff') || 'Normal',
    mode: localStorage.getItem('ng_mode') || 'goodjunk',
    score:0, timeLeft:60, running:false, paused:false, combo:1, comboMax:1, best: parseInt(localStorage.getItem('ng_best')||'0'),
    fever:false, shield:false
  };
  const I18N={ th:{start:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°",pause:"‡∏û‡∏±‡∏Å",restart:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà",score:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",time:"‡πÄ‡∏ß‡∏•‡∏≤",best:"‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥",mode:"‡πÇ‡∏´‡∏°‡∏î",diff:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å",combo:"‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö",
                    modeGJ:"‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞",modeGroups:"‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà",modeHydration:"Hydration",modePlate:"Build Plate",summary:"‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•",
                    rules:{goodjunk:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞",groups:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 3 ‡∏ä‡∏¥‡πâ‡∏ô",hydration:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô",plate:"‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏ô‡∏à‡∏≤‡∏ô"}},
               en:{start:"Start",pause:"Pause",restart:"Restart",score:"Score",time:"Time",best:"Best",mode:"Mode",diff:"Difficulty",combo:"Combo",
                    modeGJ:"Good vs Junk",modeGroups:"Food Groups",modeHydration:"Hydration",modePlate:"Build Plate",summary:"Summary",
                    rules:{goodjunk:"Pick healthy foods; avoid junk.",groups:"Pick the target food group (3 hits).",hydration:"Choose water; avoid sugary drinks.",plate:"Complete plate quotas."}} };
  const t=(k)=> (I18N[state.lang][k]||k);
  function applyLang(){
    $("#lblScore").textContent=t("score"); $("#lblTime").textContent=t("time"); $("#lblBest").textContent=t("best");
    $("#lblMode").textContent=t("mode"); $("#lblDiff").textContent=t("diff"); $("#lblCombo").textContent=t("combo");
    $("#sumTitle").textContent=t("summary");
    $$("[data-i18n=modeGJ]").forEach(e=>e.textContent=t("modeGJ"));
    $$("[data-i18n=modeGroups]").forEach(e=>e.textContent=t("modeGroups"));
    $$("[data-i18n=modeHydra]").forEach(e=>e.textContent=t("modeHydration"));
    $$("[data-i18n=modePlate]").forEach(e=>e.textContent=t("modePlate"));
    $$("[data-i18n=start]").forEach(e=>e.textContent=t("start"));
    $$("[data-i18n=pause]").forEach(e=>e.textContent=t("pause"));
    $$("[data-i18n=restart]").forEach(e=>e.textContent=t("restart"));
    $("#modeName").textContent=
      state.mode==="goodjunk"?t("modeGJ"):state.mode==="groups"?t("modeGroups"):state.mode==="hydration"?t("modeHydration"):t("modePlate");
  }
  function updateHUD(){
    $("#score").textContent=state.score; $("#time").textContent=state.timeLeft; $("#best").textContent=state.best;
    $("#difficulty").textContent=state.difficulty; $("#combo").textContent='x'+state.combo;
  }

  // THREE + WebXR
  const canvas=$("#c");
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false, powerPreference:'high-performance'});
  renderer.setClearColor(0x061018, 1);
  renderer.xr.enabled = true;
  // VR button (non-module global); fall back if not available
  try{
    const VRB = window.VRButton || (window.THREE && window.THREE.VRButton);
    if(VRB && typeof VRB.createButton==='function'){
      const vrEl = VRB.createButton(renderer);
      $("#vrSlot")?.replaceWith(vrEl);
      vrEl.style.zIndex=2147483600;
    } else {
      const warn=document.createElement('button');
      warn.className='btn'; warn.textContent='üï∂Ô∏è VR unavailable';
      $("#vrSlot")?.replaceWith(warn);
    }
  }catch(e){
    const warn=document.createElement('button');
    warn.className='btn'; warn.textContent='üï∂Ô∏è VR unavailable';
    $("#vrSlot")?.replaceWith(warn);
  }

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, 2, 0.01, 100);
  camera.position.set(0, 1.6, 2.8);
  scene.add(new THREE.AmbientLight(0xffffff, 1.0));
  const group = new THREE.Group(); scene.add(group);

  // Helpers: emoji texture + particle burst
  function emojiTexture(char){
    const s=128; const cnv=document.createElement('canvas'); cnv.width=cnv.height=s;
    const ctx=cnv.getContext('2d');
    ctx.fillStyle="#0000"; ctx.fillRect(0,0,s,s);
    ctx.font="100px system-ui, Apple Color Emoji, Segoe UI Emoji";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(char, s/2, s/2);
    const tex=new THREE.CanvasTexture(cnv); tex.anisotropy=8; tex.needsUpdate=true; return tex;
  }
  function burst(pos,color=0xffff66,count=32){
    const g=new THREE.BufferGeometry();
    const verts=new Float32Array(count*3);
    for(let i=0;i<count;i++){ const th=Math.random()*Math.PI*2, r= Math.random()*0.3+0.05;
      verts[i*3+0]=pos.x + Math.cos(th)*r; verts[i*3+1]=pos.y + (Math.random()-0.5)*0.3; verts[i*3+2]=pos.z + Math.sin(th)*r; }
    g.setAttribute('position', new THREE.BufferAttribute(verts,3));
    const m=new THREE.PointsMaterial({color, size:0.02});
    const p=new THREE.Points(g,m); scene.add(p);
    setTimeout(()=>scene.remove(p), 350);
  }

  // Raycaster
  const raycaster=new THREE.Raycaster();

  // Lanes (non-overlap + cooldown)
  const LANE_X=[-1.1,-0.55,0,0.55,1.1], LANE_Y=[-0.2,0.0,0.18,0.32], LANE_Z=-2.2;
  const occupied=new Set(), cooldown=new Map(); let lastLane=null;
  const now=()=>performance.now();
  const isAdj=(r,c)=>{ if(!lastLane) return false; const [pr,pc]=lastLane; return Math.abs(pr-r)<=1 && Math.abs(pc-c)<=1; };
  function pickLane(){
    const cand=[];
    for(let r=0;r<LANE_Y.length;r++){ for(let c=0;c<LANE_X.length;c++){
      const k=r+','+c, cd=cooldown.get(k)||0, free=!occupied.has(k)&&now()>cd&&!isAdj(r,c);
      if(free) cand.push({r,c,k});
    }}
    if(!cand.length) return null;
    const p=cand[Math.floor(Math.random()*cand.length)];
    occupied.add(p.k); lastLane=[p.r,p.c];
    return {x:LANE_X[p.c], y:1.6+LANE_Y[p.r], z:LANE_Z-0.1*Math.abs(p.c-2), key:p.k};
  }
  function releaseLane(k){ occupied.delete(k); cooldown.set(k, now()+800); }

  // Item library (emoji visual)
  const LIB={
    good: ["ü•¶","üçé","üçå","üçÖ","ü•ï","üçá","üçó","ü•õ","üç†","üåΩ","ü•¨","üçä"],
    junk: ["üçü","üçî","üçï","üå≠","üç∞","üç©","üßÅ","ü•§","üç´"],
    groups:{grains:["üçû","üçö","ü•ñ","ü•®"], protein:["üçó","ü•ö","ü´ò","üêü"], veggies:["ü•¶","ü•ï","ü•¨","üçÖ"], fruits:["üçé","üçå","üçá","üçä"], dairy:["ü•õ","üßÄ"]},
    hydra:{water:["üíß","üö∞"], sugar:["ü•§","üßÉ","üßã"], soda:["ü•§","ü•§"]},
    special:{time:"‚è±Ô∏è", fever:"üî•", slow:"üê¢", bomb:"üí£", shield:"üõ°Ô∏è"}
  };

  // Active
  const ACTIVE=new Set();
  function makeItem(meta){
    // plane with emoji texture
    const char = meta.special ? LIB.special[meta.special] : (
      state.mode==='goodjunk' ? (meta.good? LIB.good[Math.floor(Math.random()*LIB.good.length)] : LIB.junk[Math.floor(Math.random()*LIB.junk.length)]) :
      state.mode==='groups' ? LIB.groups[meta.group][Math.floor(Math.random()*LIB.groups[meta.group].length)] :
      state.mode==='hydration' ? (meta.hydra==='water' ? LIB.hydra.water[0] : (Math.random()<0.5?LIB.hydra.sugar[0]:LIB.hydra.soda[0])) :
      "üçΩÔ∏è"
    );
    const tex=emojiTexture(char);
    const geo=new THREE.PlaneGeometry(0.5,0.5);
    const mat=new THREE.MeshBasicMaterial({map:tex, transparent:true});
    const m=new THREE.Mesh(geo,mat);
    return m;
  }

  function spawn(){
    const lane=pickLane(); if(!lane) return;
    const meta=pickMeta();
    const m=makeItem(meta); m.position.set(lane.x, lane.y, lane.z); m.userData={lane:lane.key, meta};
    group.add(m); ACTIVE.add(m);

    // small float animation
    const sway=(amp=0.04)=>{ const t=performance.now()*0.002 + Math.random()*6; m.position.y += Math.sin(t)*amp; };

    // timed remove with penalty/bonus
    const life = state.difficulty==='Hard'?1900:state.difficulty==='Easy'?4200:3000;
    const tm=setTimeout(()=>{
      if(!m.parent) return;
      const d=m.userData.meta;
      if(!d.special){
        if(state.mode==='goodjunk'){ if(d.good===false){ state.score+=1; updateHUD(); } else { missPenalty(); } }
        else if(state.mode==='groups'){ if(d.group===currentTarget){ missPenalty(); } }
        else if(state.mode==='hydration'){ if(d.hydra!=='water'){ state.score+=1; updateHUD(); } }
      }
      destroy(m);
    }, life + Math.floor(Math.random()*500-250));

    m.userData.timer=tm;
  }
  function destroy(obj){ if(obj.parent) obj.parent.remove(obj); ACTIVE.delete(obj); releaseLane(obj.userData.lane); }

  // Meta / modes
  const foods = { groups: ['grains','protein','veggies','fruits','dairy'] };
  function pickMeta(){
    if(Math.random()<0.14){ const sp=['time','fever','slow','bomb','shield']; return {special: sp[Math.floor(Math.random()*sp.length)]}; }
    if(state.mode==='goodjunk'){
      const goodBias=state.difficulty==='Easy'?0.72:state.difficulty==='Hard'?0.46:0.6;
      return {good: Math.random()<goodBias};
    }
    if(state.mode==='groups'){
      const g=foods.groups[Math.floor(Math.random()*foods.groups.length)];
      return {group:g};
    }
    if(state.mode==='hydration'){
      const rate=state.difficulty==='Easy'?0.78:state.difficulty==='Hard'?0.55:0.66;
      const isWater = Math.random()<rate;
      return {hydra: isWater?'water':(Math.random()<0.5?'soda':'sugar')};
    }
    const g=foods.groups[Math.floor(Math.random()*foods.groups.length)];
    return {group:g, plate:true};
  }

  // Targets & plate
  let currentTarget='grains', plateQuota=null, targetHits=0;
  function nextTarget(){ const arr=foods.groups.filter(x=>x!==currentTarget); currentTarget = arr[Math.floor(Math.random()*arr.length)]; say(state.lang==='th'?("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "+labelGroup(currentTarget)):("Pick "+currentTarget)); }
  function resetPlateQuota(){ const base={grains:2,veggies:2,protein:1,fruits:1,dairy:1}; if(state.difficulty==='Hard') base.veggies=3; plateQuota=base; }

  function labelGroup(g){ const map={grains:"‡∏ò‡∏±‡∏ç‡∏û‡∏∑‡∏ä",protein:"‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô",veggies:"‡∏ú‡∏±‡∏Å",fruits:"‡∏ú‡∏•‡πÑ‡∏°‡πâ",dairy:"‡∏ô‡∏°"}; return map[g]||g; }

  // Scoring helpers
  function missPenalty(){ if(state.shield){ state.shield=false; showToast(state.lang==='th'?'‡πÇ‡∏•‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢':'Shield absorbed'); return; } state.combo=1; setFever(false); updateHUD(); }
  const FEVER_MULT=2.0, FEVER_BONUS=1; let feverTimer=null;
  function setFever(on){ state.fever=on; document.body.classList.toggle('fever', on); }
  function enterFever(ms=6500){ if(feverTimer) clearTimeout(feverTimer); setFever(true); feverTimer=setTimeout(()=>setFever(false), ms); }
  function extendFever(extra=1200){ if(!state.fever||!feverTimer) return; clearTimeout(feverTimer); feverTimer=setTimeout(()=>setFever(false), extra); }

  // Input: click/touch
  function onClickCanvas(ev){
    if(!state.running||state.paused) return;
    const rect=canvas.getBoundingClientRect();
    const x=(ev.clientX-rect.left)/rect.width*2-1;
    const y=-(ev.clientY-rect.top)/rect.height*2+1;
    const m=new THREE.Vector2(x,y);
    raycaster.setFromCamera(m, camera);
    const inter=raycaster.intersectObjects(Array.from(ACTIVE));
    if(inter.length>0){ handleHit(inter[0].object); destroy(inter[0].object); }
  }
  canvas.addEventListener('click', onClickCanvas);
  canvas.addEventListener('touchstart', (e)=>{ if(e.touches&&e.touches[0]) onClickCanvas({clientX:e.touches[0].clientX, clientY:e.touches[0].clientY}); }, {passive:true});

  // Gaze dwell (VR)
  let gazeTarget=null, gazeStart=0; const DWELL=700;
  function handleGaze(){
    if(!state.running||state.paused) return;
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
    const inter=raycaster.intersectObjects(Array.from(ACTIVE));
    if(inter.length>0){
      const o=inter[0].object;
      if(gazeTarget!==o){ gazeTarget=o; gazeStart=performance.now(); $("#ret").classList.add('progress'); }
      else if(performance.now()-gazeStart >= DWELL){ handleHit(o); destroy(o); gazeTarget=null; $("#ret").classList.remove('progress'); }
    } else { gazeTarget=null; $("#ret").classList.remove('progress'); }
  }

  function handleHit(obj){
    const m=obj.userData.meta;
    if(m.special){
      if(m.special==='time'){ state.timeLeft=Math.min(99, state.timeLeft+5); showToast(state.lang==='th'?'‡πÄ‡∏ß‡∏•‡∏≤ +5s':'+5s time'); say(state.lang==='th'?'‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≤‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ':'Time bonus'); }
      if(m.special==='fever'){ enterFever(); showToast('FEVER!'); say('Fever!'); }
      if(m.special==='slow'){ const old=state.difficulty; state.difficulty='Easy'; showToast(state.lang==='th'?'‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß':'Slow down'); setTimeout(()=>state.difficulty=old,2600); }
      if(m.special==='bomb'){ missPenalty(); state.score=Math.max(0, state.score-5); showToast('-5'); }
      if(m.special==='shield'){ state.shield=true; showToast(state.lang==='th'?'‡πÑ‡∏î‡πâ‡πÇ‡∏•‡πà‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á':'Shield acquired'); }
      updateHUD(); return;
    }
    let good=false, base=0;
    if(state.mode==='goodjunk'){ good=m.good===true; base=good?6:-3; if(!good) missPenalty(); }
    else if(state.mode==='groups'){ good=m.group===currentTarget; base=good?7:-2; if(good){ targetHits++; if(targetHits>=3){ nextTarget(); targetHits=0; } } else missPenalty(); }
    else if(state.mode==='hydration'){ good=m.hydra==='water'; base=good?5:-4; if(good && state.combo%3===0){ state.timeLeft=Math.min(99, state.timeLeft+2); showToast('+2s'); } else if(!good) missPenalty(); }
    else { // plate
      if(m.group){
        if(!plateQuota) resetPlateQuota();
        if(plateQuota[m.group]>0){ good=true; plateQuota[m.group]-=1; if(Object.values(plateQuota).every(v=>v<=0)){ base+=14; resetPlateQuota(); showToast(state.lang==='th'?'‡∏à‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö!':'Plate complete!'); } }
        else { base+=2; }
      }
    }
    let delta = good ? base*state.combo : base;
    if(state.fever && delta>0){ delta = Math.round(delta*FEVER_MULT) + FEVER_BONUS; }
    state.score=Math.max(0, state.score+delta);
    burst(obj.position.clone());
    if(good){ state.combo=Math.min(6,state.combo+1); state.comboMax=Math.max(state.comboMax,state.combo); if(state.combo>=4 && !state.fever) enterFever(); }
    updateHUD();
  }

  // Loops
  let spH=null, tmH=null, watchdogH=null, SPAWN_COUNT=0;
  function loop(){ if(!state.running||state.paused) return; spawn(); SPAWN_COUNT++; spH=setTimeout(loop, 700); }
  function timer(){ if(!state.running||state.paused) return; tmH=setTimeout(()=>{ state.timeLeft--; updateHUD(); if(state.timeLeft<=0){ endGame(); } else timer(); }, 1000); }

  function start(){
    $("#summary").style.display='none';
    state.score=0; state.combo=1; state.comboMax=1; state.timeLeft=60; state.shield=false; setFever(false); updateHUD();
    if(state.mode==='groups'){ nextTarget(); }
    if(state.mode==='plate'){ resetPlateQuota(); }
    state.running=true; state.paused=false;
    say(state.lang==='th'? I18N.th.rules[state.mode] : I18N.en.rules[state.mode]);
    showToast(state.lang==='th'? I18N.th.rules[state.mode] : I18N.en.rules[state.mode], 2200);
    setTimeout(spawn, 250); loop(); timer();
    clearTimeout(watchdogH); let seenT=state.timeLeft, seenS=SPAWN_COUNT;
    (function kick(){ const stuck=(seenT===state.timeLeft)||(seenS===SPAWN_COUNT); if(stuck){ clearTimeout(spH); clearTimeout(tmH); setTimeout(()=>{ spawn(); loop(); timer(); },180); } seenT=state.timeLeft; seenS=SPAWN_COUNT; watchdogH=setTimeout(kick,1200); })();
  }
  function pause(){ if(!state.running) return; state.paused=!state.paused; if(state.paused){ clearTimeout(spH); clearTimeout(tmH); say(state.lang==='th'?'‡∏û‡∏±‡∏Å‡πÄ‡∏Å‡∏°':'Paused'); } else { loop(); timer(); say(state.lang==='th'?'‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠':'Resume'); } }
  function endGame(){
    state.running=false; state.paused=false; clearTimeout(spH); clearTimeout(tmH);
    if(state.score>state.best){ state.best=state.score; localStorage.setItem('ng_best', String(state.best)); }
    const star=state.score>=240?3:state.score>=160?2:1;
    $("#sumStars").textContent="‚òÖ".repeat(star)+"‚òÜ".repeat(3-star);
    $("#sumBody").textContent=`Score: ${state.score} ‚Ä¢ Combo Max: x${state.comboMax} ‚Ä¢ Mode: ${state.mode} ‚Ä¢ Diff: ${state.difficulty}`;
    $("#summary").style.display='flex';
    say(state.lang==='th'?('‡∏à‡∏ö‡πÄ‡∏Å‡∏° ‡πÑ‡∏î‡πâ '+state.score+' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'):('Finished. Score '+state.score));
  }

  // Resize & render
  function resize(){ const w=innerWidth, h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
  addEventListener('resize', resize); resize();
  function renderLoop(t){ if(renderer.xr.isPresenting) handleGaze(); renderer.render(scene,camera); }
  renderer.setAnimationLoop(renderLoop);

  // UI API
  const UI={
    start: ()=> start(),
    pause: ()=> pause(),
    restart: ()=>{ state.running=false; state.paused=false; clearTimeout(spH); clearTimeout(tmH); SPAWN_COUNT=0; start(); },
    setMode: (m)=>{ state.mode=m; localStorage.setItem('ng_mode',m); applyLang(); },
    setDiff: (d)=>{ state.difficulty=d; localStorage.setItem('ng_diff',d); updateHUD(); },
    toggleLang: ()=>{ state.lang=(state.lang==='th'?'en':'th'); localStorage.setItem('ng_lang',state.lang); applyLang(); showToast(state.lang==='th'?'‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢':'English'); }
  };
  window.UI=UI;

  // Bind menu AFTER UI exists
  $("#menuBar").addEventListener('click',(e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const act=btn.getAttribute('data-action'); const val=btn.getAttribute('data-value');
    e.preventDefault(); e.stopPropagation();
    const map={start: UI.start, pause: UI.pause, restart: UI.restart, lang: UI.toggleLang, logger: ()=>{ logEl.style.display=(logEl.style.display==='none'?'block':'none'); }};
    if(act in map) map[act](); else if(act==='mode') UI.setMode(val); else if(act==='diff') UI.setDiff(val);
    clog(`menu action=${act} value=${val||'-'}`);
  }, false);

  // Diagnostics (optional)
  window.addEventListener('click', (e)=>{ const top=document.elementFromPoint(e.clientX,e.clientY); clog("clicked target="+(e.target.id||e.target.getAttribute('data-action')||e.target.tagName)+" top="+(top && (top.id||top.getAttribute('data-action')||top.tagName))); }, true);

  // Init
  applyLang(); updateHUD(); dbg('ready');
})();</script>
</body>
</html>
