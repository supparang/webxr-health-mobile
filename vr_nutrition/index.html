<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>VR Nutrition ‚Äî Dual Mode (WebGL/Canvas)</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js" defer></script>
<style>
  html,body{margin:0;height:100%;background:#050910;overflow:hidden}
  a-scene,canvas.a-canvas{position:fixed;inset:0;z-index:0}
  /* WebGL mode: only interactive after start */
  body.webgl:not(.game-running) a-scene,
  body.webgl:not(.game-running) canvas.a-canvas,
  body.webgl:not(.game-running) .a-enter-vr{pointer-events:none!important}
  /* UI */
  .hud,#menuBar,#banner,#dbg{position:fixed;z-index:2147483647!important;pointer-events:auto!important;font-family:system-ui;color:#0ff}
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center;text-shadow:0 0 8px rgba(0,255,255,.7)}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center}
  .btn{display:inline-block;padding:10px 14px;margin:0 6px;border:1px solid #0ff;border-radius:12px;background:rgba(0,0,0,.35);color:#0ff;cursor:pointer}
  #banner{top:48px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.5);border:1px solid #0ff;border-radius:10px;padding:6px 10px;font-size:14px}
  #dbg{left:8px;bottom:8px;background:rgba(0,0,0,.6);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px;display:none}
  body.debug #dbg{display:block}
  /* Canvas2D fallback surface */
  #game2d{position:fixed;inset:0;z-index:0;display:none;background:#061018}
</style>
</head>
<body class="webgl">
  <div class="hud">Score: <span id="score">0</span> | Combo: <span id="combo">x1</span> | Time: <span id="time">60</span>s</div>
  <div id="menuBar">
    <button id="btnStart"  class="btn">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <button id="btnPause"  class="btn">‚è∏ ‡∏û‡∏±‡∏Å</button>
    <button id="btnRestart"class="btn">‚Üª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    <button id="btnMode"   class="btn">üîÅ ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î</button>
    <button id="btnDebug"  class="btn">üêõ Debug</button>
  </div>
  <div id="banner">Mode: <b id="modeLabel">WebGL (A‚ÄëFrame)</b></div>
  <div id="dbg">STATE: ready</div>

  <!-- Canvas fallback -->
  <canvas id="game2d" width="1280" height="720"></canvas>

  <!-- WebGL scene (only used in WebGL mode) -->
  <a-scene id="scene" background="color:#050910" loading-screen="enabled:false" stats
           renderer="antialias:true; highRefreshRate:true; colorManagement:true">
    <a-entity light="type: ambient; color: #BBB"></a-entity>
    <a-entity light="type: hemisphere; color: #fffff0; groundColor: #222; intensity: 0.9"></a-entity>
    <a-sky color="#050910"></a-sky>

    <a-entity id="playerCam" position="0 1.6 0" camera look-controls
              raycaster="objects: .clickable; far: 12"
              cursor="rayOrigin: entity; fuse: true; fuseTimeout: 700">
      <a-entity position="0 0 -1" geometry="primitive:ring;radiusInner:0.005;radiusOuter:0.008"
                material="color:#0ff;shader:flat;opacity:0.9"></a-entity>
    </a-entity>

    <a-entity id="mouseRig" cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 12"></a-entity>
    <a-entity id="spawnerRoot" position="0 1.6 -2.0"></a-entity>
  </a-scene>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const dbg=(m)=>{ const d=$("#dbg"); d.textContent="STATE: "+m; };

  // Toggle debug
  $("#btnDebug").addEventListener('click',()=>document.body.classList.toggle('debug'));

  // Mode management
  let mode='webgl'; // 'webgl' or 'canvas'
  function setMode(m){
    mode=m;
    $("#modeLabel").textContent = (mode==='webgl'?'WebGL (A‚ÄëFrame)':'Canvas 2D');
    document.body.classList.toggle('webgl', mode==='webgl');
    document.getElementById('scene').style.display = (mode==='webgl'?'block':'none');
    document.getElementById('game2d').style.display = (mode==='canvas'?'block':'none');
  }

  // WebGL capability test
  function hasWebGL(){
    try{
      const c=document.createElement('canvas');
      const gl = c.getContext('webgl2') || c.getContext('webgl') || c.getContext('experimental-webgl');
      return !!gl;
    }catch(_){ return false; }
  }

  // Canvas 2D game fallback (same loop feel)
  const CApp={running:false,paused:false,score:0,timeLeft:60,combo:1, objs:[]};
  const COLORS=['#39d','#0f9','#fd0','#f55','#9f6','#0ff','#f0f','#fa0','#0fa','#a0f'];
  const cv=$("#game2d"); const ctx=cv.getContext('2d');
  function resizeCanvas(){
    cv.width = window.innerWidth; cv.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  function c_spawn(){
    const size=40+Math.random()*20;
    const x = Math.random()*(cv.width-120)+60;
    const y = Math.random()*(cv.height-220)+120;
    const color = COLORS[Math.floor(Math.random()*COLORS.length)];
    const life = 3000;
    CApp.objs.push({x,y,size,life,color});
  }
  function c_loop(ts){
    if(!CApp.running || CApp.paused) return;
    ctx.clearRect(0,0,cv.width,cv.height);
    // glow bg
    ctx.fillStyle='#061018'; ctx.fillRect(0,0,cv.width,cv.height);
    const now=performance.now();
    for(let i=CApp.objs.length-1;i>=0;i--){
      const o=CApp.objs[i]; o.life -= 16;
      const dy = Math.sin((now/300)+(i))*2;
      ctx.globalAlpha=0.95;
      ctx.fillStyle=o.color;
      ctx.fillRect(o.x- o.size/2, o.y+dy- o.size/2, o.size, o.size);
      if(o.life<=0){ CApp.objs.splice(i,1); CApp.combo=1; updateHUD(); }
    }
    requestAnimationFrame(c_loop);
  }
  cv.addEventListener('click',(e)=>{
    if(!CApp.running) return;
    const rect=cv.getBoundingClientRect();
    const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    for(let i=CApp.objs.length-1;i>=0;i--){
      const o=CApp.objs[i];
      if(mx>=o.x-o.size/2 && mx<=o.x+o.size/2 && my>=o.y-o.size/2 && my<=o.y+o.size/2){
        CApp.score+=5*CApp.combo; CApp.combo=Math.min(5,CApp.combo+1); CApp.objs.splice(i,1); updateHUD(); break;
      }
    }
  });

  function c_start(){
    CApp.running=true; CApp.paused=false; CApp.score=0; CApp.combo=1; CApp.objs=[]; CApp.timeLeft=60; updateHUD();
    document.body.classList.remove('game-running'); // not needed for canvas
    setTimeout(c_spawn, 200);
    // spawn timer
    CApp._spawnT = setInterval(()=>{ if(!CApp.paused) c_spawn(); }, 740);
    // time timer
    CApp._timeT = setInterval(()=>{ if(!CApp.paused){ CApp.timeLeft--; updateHUD(); if(CApp.timeLeft<=0){ c_stop(); } } }, 1000);
    requestAnimationFrame(c_loop);
  }
  function c_pause(){ if(!CApp.running) return; CApp.paused=!CApp.paused; }
  function c_restart(){ clearInterval(CApp._spawnT); clearInterval(CApp._timeT); CApp.running=false; CApp.paused=false; c_start(); }
  function c_stop(){ clearInterval(CApp._spawnT); clearInterval(CApp._timeT); CApp.running=false; }

  // WebGL (A-Frame) minimal loop
  const WApp={running:false,paused:false,score:0,timeLeft:60,combo:1};
  const ACTIVE=new Set(); let spawnH=null,timerH=null,watchdogH=null, SPAWN_COUNT=0;
  function updateHUD(){ $("#score").textContent=(mode==='webgl'?WApp.score:CApp.score); $("#time").textContent=(mode==='webgl'?WApp.timeLeft:CApp.timeLeft); $("#combo").textContent='x'+(mode==='webgl'?WApp.combo:CApp.combo); }
  function spawn3d(){
    const root=$("#spawnerRoot"); if(!root) return;
    const xs=[-0.8,0,0.8][Math.floor(Math.random()*3)];
    const ys=[-0.05,0.12,0.29][Math.floor(Math.random()*3)];
    const z = -2 + (Math.random()*0.4-0.2);
    const c=['#39d','#0f9','#fd0','#f55','#9f6','#0ff','#f0f','#fa0','#0fa','#a0f'][Math.floor(Math.random()*10)];
    const box=document.createElement('a-box');
    box.setAttribute('depth','0.18'); box.setAttribute('height','0.38'); box.setAttribute('width','0.38');
    box.setAttribute('color', c);
    box.setAttribute('material', 'shader:standard; metalness:0.05; roughness:0.6; emissive:#000');
    box.setAttribute('position',`${xs} ${1.6+ys} ${z}`);
    box.setAttribute('class','clickable');
    box.addEventListener('click',()=>{ WApp.score+=5*WApp.combo; WApp.combo=Math.min(5,WApp.combo+1); updateHUD(); if(box.parentNode) box.parentNode.removeChild(box); });
    root.appendChild(box); SPAWN_COUNT++;
    setTimeout(()=>{ if(box.parentNode){ box.parentNode.removeChild(box); WApp.combo=1; updateHUD(); } }, 3200);
  }
  function w_loop(){ if(!WApp.running||WApp.paused) return; spawn3d(); spawnH=setTimeout(w_loop,740); }
  function w_tick(){ if(!WApp.running||WApp.paused) return; timerH=setTimeout(()=>{ WApp.timeLeft--; updateHUD(); if(WApp.timeLeft<=0){ w_stop(); } else w_tick(); },1000); }
  function w_start(){
    WApp.running=true; WApp.paused=false; WApp.score=0; WApp.combo=1; WApp.timeLeft=60; updateHUD();
    document.body.classList.add('game-running'); setTimeout(spawn3d,200); w_loop(); w_tick();
    // watchdog
    clearTimeout(watchdogH); let seenT=WApp.timeLeft, seenS=SPAWN_COUNT;
    (function kick(){
      const stuck = (seenT===WApp.timeLeft) || (seenS===SPAWN_COUNT);
      if(stuck){ clearTimeout(spawnH); clearTimeout(timerH); setTimeout(()=>{ spawn3d(); w_loop(); w_tick(); }, 150); dbg('watchdog kick'); }
      seenT=WApp.timeLeft; seenS=SPAWN_COUNT; watchdogH=setTimeout(kick,1200);
    })();
  }
  function w_pause(){ if(!WApp.running) return; WApp.paused=!WApp.paused; if(WApp.paused){ clearTimeout(spawnH); clearTimeout(timerH);} else { w_loop(); w_tick(); }}
  function w_restart(){ clearTimeout(spawnH); clearTimeout(timerH); clearTimeout(watchdogH); WApp.running=false; WApp.paused=false; w_start(); }
  function w_stop(){ WApp.running=false; WApp.paused=false; clearTimeout(spawnH); clearTimeout(timerH); clearTimeout(watchdogH); document.body.classList.remove('game-running'); }

  // Buttons
  $("#btnStart").addEventListener('click',()=>{ if(mode==='webgl') w_start(); else c_start(); });
  $("#btnPause").addEventListener('click',()=>{ if(mode==='webgl') w_pause(); else c_pause(); });
  $("#btnRestart").addEventListener('click',()=>{ if(mode==='webgl') w_restart(); else c_restart(); });
  $("#btnMode").addEventListener('click',()=>{ if(mode==='webgl'){ w_stop(); setMode('canvas'); } else { c_stop(); setMode('webgl'); } updateHUD(); });

  // Auto decide initial mode
  const glOK = hasWebGL();
  if(!glOK){ setMode('canvas'); dbg('Canvas mode (no WebGL)'); }
  else {
    setMode('webgl');
    // safety timeout: if scene doesn't load in 1.5s, switch to canvas
    const to=setTimeout(()=>{ const canvas=document.querySelector('canvas.a-canvas'); if(!canvas){ setMode('canvas'); dbg('Auto switch to Canvas (scene not ready)'); } }, 1500);
    $("#scene").addEventListener('loaded',()=>{ clearTimeout(to); dbg('WebGL scene loaded'); });
  }

  // Keyboard debug toggle
  window.addEventListener('keydown',e=>{ if(e.key==='`') document.body.classList.toggle('debug'); });

  updateHUD();
})();</script>
</body>
</html>
