<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>WebGL Safe Renderer Fix</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js" defer></script>
<style>
  html,body{margin:0;height:100%;background:#04070d;overflow:hidden}
  /* FORCE the WebGL canvas to be visible */
  canvas.a-canvas{
    position:fixed !important; inset:0 !important; z-index:0 !important;
    opacity:1 !important; visibility:visible !important; display:block !important;
    background:#050910 !important;
  }
  a-scene{position:fixed !important; inset:0 !important; z-index:0 !important; display:block !important;}
  /* UI */
  .hud,#menuBar,#dbg{
    position:fixed; z-index:2147483647 !important; pointer-events:auto !important;
    font-family:system-ui,Segoe UI,Arial,sans-serif; color:#0ff; text-shadow:0 0 8px rgba(0,255,255,.7)
  }
  .hud{left:50%;transform:translateX(-50%);top:10px;text-align:center}
  #menuBar{bottom:12px;left:50%;transform:translateX(-50%);text-align:center}
  .btn{display:inline-block;padding:10px 14px;margin:0 6px;border:1px solid #0ff;border-radius:12px;background:rgba(0,0,0,.35);color:#0ff;cursor:pointer}
  #dbg{left:8px;bottom:8px;background:rgba(0,0,0,.6);padding:6px 8px;border-radius:8px;border:1px solid #0ff;white-space:pre;font-size:12px}
</style>
</head>
<body>
  <div class="hud">Score: <span id="score">0</span> | Time: <span id="time">60</span>s | Draws: <span id="draws">0</span></div>
  <div id="menuBar">
    <button class="btn" id="btnStart">▶ เริ่มเกม</button>
    <button class="btn" id="btnPause">⏸ พัก</button>
    <button class="btn" id="btnRestart">↻ เริ่มใหม่</button>
  </div>
  <div id="dbg">STATE: ready</div>

  <a-scene id="scene" embedded background="color:#050910" loading-screen="enabled:false"
           renderer="alpha:false; physicallyCorrectLights:false; colorManagement:false; precision:mediump; antialias:false; highRefreshRate:true; powerPreference:high-performance">
    <!-- Lights kept simple -->
    <a-entity light="type: ambient; color: #ffffff; intensity: 1.0"></a-entity>
    <!-- Camera with safe near/far -->
    <a-entity id="playerCam" position="0 1.6 2.5" camera="near:0.01; far: 1000"></a-entity>

    <!-- Big emissive test box always visible -->
    <a-box id="bigbox" position="0 1.6 -2" depth="1" height="1" width="1"
           material="shader:flat; color:#00ffff; side:double; opacity:1"></a-box>

    <!-- Axes & grid helpers (procedural via a-entity) -->
    <a-entity id="grid" position="0 0 -2">
      <a-entity geometry="primitive: plane; width:6; height:6" rotation="-90 0 0"
                material="shader:flat; color:#0a1220; wireframe:false"></a-entity>
      <a-entity geometry="primitive: box; width:0.05; height:0.05; depth:2.0" position="0 1.6 -2.5"
                material="shader:flat; color:#ff0066"></a-entity>
    </a-entity>

    <a-entity id="spawnerRoot" position="0 1.6 -2.0"></a-entity>
  </a-scene>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const dbg=(m)=>{ $("#dbg").textContent = "STATE: " + m + "\n" + canvasInfo(); };

  const APP={running:false,paused:false,score:0,timeLeft:60};
  let spH=null, tmH=null, draws=0;

  // Ensure canvas visible & report info
  function canvasInfo(){
    const c=document.querySelector('canvas.a-canvas');
    if(!c) return "canvas: none";
    const cs=getComputedStyle(c);
    return "canvas: "+c.width+"x"+c.height+"  vis="+cs.visibility+"  disp="+cs.display+"  op="+cs.opacity;
  }

  // Force renderer to render a frame periodically (some setups need a poke)
  function forceRender(){
    const sc=document.getElementById('scene');
    if(sc && sc.renderer && sc.renderer.render){
      // schedule a manual render by toggling a dummy attribute
      draws++; document.getElementById('draws').textContent=draws;
    }
  }
  setInterval(forceRender, 250);

  function setHUD(){ $("#score").textContent=APP.score; $("#time").textContent=APP.timeLeft; }

  const COLORS=['#39d','#0f9','#fd0','#f55','#9f6','#0ff','#f0f','#fa0','#0fa','#a0f'];

  function spawn(){
    const root=$("#spawnerRoot"); if(!root) return;
    const xs=[-0.9, -0.45, 0, 0.45, 0.9][Math.floor(Math.random()*5)];
    const ys=[-0.2, -0.05, 0.12, 0.26][Math.floor(Math.random()*4)];
    const z = -2 + (Math.random()*0.3-0.15);
    const c=COLORS[Math.floor(Math.random()*COLORS.length)];
    const box=document.createElement('a-box');
    box.setAttribute('depth','0.18'); box.setAttribute('height','0.38'); box.setAttribute('width','0.38');
    box.setAttribute('material', 'shader:flat; side:double; color:'+c+'; opacity:1');
    box.setAttribute('position',`${xs} ${1.6+ys} ${z}`);
    box.setAttribute('class','clickable');
    box.addEventListener('click',()=>{ APP.score+=5; setHUD(); if(box.parentNode) box.parentNode.removeChild(box); });
    root.appendChild(box);
    setTimeout(()=>{ if(box.parentNode) box.parentNode.removeChild(box); }, 3600);
  }
  function loop(){ if(!APP.running||APP.paused) return; spawn(); spH=setTimeout(loop, 740); }
  function tick(){ if(!APP.running||APP.paused) return; tmH=setTimeout(()=>{ APP.timeLeft--; setHUD(); if(APP.timeLeft<=0){ stop(); } else tick(); }, 1000); }
  function start(){ APP.running=true; APP.paused=false; setHUD(); setTimeout(spawn, 200); loop(); tick(); dbg('start'); }
  function pause(){ if(!APP.running) return; APP.paused=!APP.paused; if(APP.paused){ clearTimeout(spH); clearTimeout(tmH); dbg('paused'); } else { dbg('resumed'); loop(); tick(); } }
  function stop(){ APP.running=false; APP.paused=false; clearTimeout(spH); clearTimeout(tmH); dbg('stopped'); }

  $("#btnStart").addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  $("#btnPause").addEventListener('click', (e)=>{ e.preventDefault(); pause(); });
  $("#btnRestart").addEventListener('click', (e)=>{ e.preventDefault(); stop(); start(); });

  // Unblock any hidden overlays stealing clicks
  window.addEventListener('click',(e)=>{
    const top = document.elementFromPoint(e.clientX, e.clientY);
    if(top && (top.classList.contains('overlay') || top.id==='summary') && top.style.display!=='block'){
      top.style.pointerEvents='none';
      dbg('unblocked overlay');
    }
  }, true);

  const scene=document.getElementById('scene');
  scene.addEventListener('loaded', ()=>{ dbg('scene loaded'); });
  setTimeout(()=>{ dbg('boot'); }, 200);

})();</script>
</body>
</html>
