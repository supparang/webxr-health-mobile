<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>foodsafety</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="../js/app.js"></script>
  <style>.floatingUI{position:fixed;left:50%;transform:translateX(-50%);bottom:10px}</style>
</head>
<body>
<div class="hud">
  <strong data-i18n="foodsafety"></strong>
  <span class="badge" data-i18n="difficulty"></span>:
  <button class="btn small" onclick="setDiff('easy')" data-i18n="easy"></button>
  <button class="btn small" onclick="setDiff('normal')" data-i18n="normal"></button>
  <button class="btn small" onclick="setDiff('hard')" data-i18n="hard"></button>
  <span class="badge" id="hudTime">00:00</span>
  <span class="badge" id="hudScore" data-i18n="score"></span>: <span class="badge" id="scoreVal">0</span>
  <button class="btn small" onclick="APP.setLang('th')" data-i18n="thai"></button>
  <button class="btn small" onclick="APP.setLang('en')" data-i18n="english"></button>
</div>
<div class="panel">
  <button class="btn" onclick="startGame()" data-i18n="timer_mode"></button>
  <button class="btn secondary" onclick="startPractice()" data-i18n="practice_mode"></button>
  <button class="btn secondary" onclick="location.href='../index.html'" data-i18n="back"></button>
</div>

<a-scene renderer="antialias: true; colorManagement: true" background="color: #0a0f1c">
  <a-entity position="0 1.6 0">
    <a-entity camera look-controls></a-entity>
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
  </a-entity>
  <a-entity light="type: ambient; intensity: 0.6"></a-entity>
  <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
  <a-plane position="0 0 -2" rotation="-90 0 0" width="20" height="20" color="#111827"></a-plane>

  <!-- Gameplay root -->
  <a-entity id="gameRoot" position="0 1.4 -1.8"></a-entity>

  <!-- Floating hint -->
  <a-entity position="0 2 -1.5" id="hint" text="value:; align:center; width:3.2; color:#e5e7eb"></a-entity>
</a-scene>

<script>
let state = {
  running:false, practice:false, diff:'normal', time:60, score:0, maxScore:0, step:0, started:false
};
function setDiff(d){ state.diff=d; }
function reset(){
  state.score=0; state.step=0; state.started=false;
  document.getElementById('scoreVal').textContent=state.score;
  document.getElementById('hudTime').textContent=APP.formatTime(state.time);
  document.getElementById('hint').setAttribute('text','value:'+APP.t('select_mode'));
}
function startPractice(){ state.practice=true; start(true); }
function startGame(){ state.practice=false; start(false); }
function start(practice){
  if(state.running) return;
  state.running = true; state.started=true;
  state.time = (state.diff==='easy')?75:(state.diff==='hard'?45:60);
  document.getElementById('hudTime').textContent=APP.formatTime(state.time);
  loop();
  initGame();
}
function loop(){
  if(!state.running) return;
  if(!state.practice){ state.time -= 1/30; document.getElementById('hudTime').textContent = APP.formatTime(state.time); }
  if(state.time<=0 && !state.practice) return end();
  requestAnimationFrame(loop);
}
function addScore(x){ state.score+=x; document.getElementById('scoreVal').textContent=state.score; APP.beep(1200,0.05); }
function addHint(msg){ document.getElementById('hint').setAttribute('text','value:'+msg); }
function end(){
  state.running=false;
  const stars = APP.stars(state.score, Math.max(1,state.maxScore));
  alert(APP.t('summary')+`\n`+APP.t('score')+': '+state.score+`\n`+APP.t('stars')+': ` + '★'.repeat(stars));
}

function spawnButton(x,y,label,cb){
  const root = document.getElementById('gameRoot');
  const id = 'btn_'+Math.random().toString(36).slice(2);
  const p = document.createElement('a-entity');
  p.setAttribute('position', `${x} ${y} 0`);
  const b = document.createElement('a-plane');
  b.setAttribute('width','0.6'); b.setAttribute('height','0.25');
  b.setAttribute('color','#34a1ff'); b.setAttribute('class','clickable');
  b.setAttribute('event-set__enter','_event: mouseenter; material.color: #60a5fa');
  b.setAttribute('event-set__leave','_event: mouseleave; material.color: #34a1ff');
  b.addEventListener('click',()=>cb && cb());
  const t = document.createElement('a-entity');
  t.setAttribute('text', `value:${label}; align:center; width:2; color:#fff`);
  t.setAttribute('position','0 0 0.01');
  p.appendChild(b); p.appendChild(t); root.appendChild(p);
  return id;
}

// Game-specific logic
function initGame(){
  // placeholder; will be replaced per game
  state.maxScore = 10;
  addHint(APP.t('select_diff'));
}


// Food safety — sort items into Clean (green) vs Risky (yellow/red)
let iIndex=0, correct=0;
const items = [
  {label:"Cooked Rice (Hot)", good:true},
  {label:"Raw Chicken", good:false},
  {label:"Fresh Salad Washed", good:true},
  {label:"Expired Milk", good:false},
  {label:"Covered Soup", good:true},
  {label:"Unwashed Apple", good:false}
];
function initGame(){
  state.maxScore = items.length*10;
  addHint(APP.lang==='th' ? "ลาก/กด เลือกวาง: สะอาด (เขียว) / เสี่ยง (เหลือง/แดง)" : "Choose: Clean (green) / Risky (yellow/red)");
  const root = document.getElementById('gameRoot'); root.innerHTML='';

  // bins
  const good = document.createElement('a-entity'); good.setAttribute('position','-0.6 0.3 0');
  const gbin = document.createElement('a-plane'); gbin.setAttribute('width','0.7'); gbin.setAttribute('height','0.6'); gbin.setAttribute('color','#22c55e'); good.appendChild(gbin);
  const gl = document.createElement('a-entity'); gl.setAttribute('text','value:CLEAN; align:center; width:2'); gl.setAttribute('position','0 0 0.01'); good.appendChild(gl);
  document.getElementById('gameRoot').appendChild(good);

  const bad = document.createElement('a-entity'); bad.setAttribute('position','0.6 0.3 0');
  const bbin = document.createElement('a-plane'); bbin.setAttribute('width','0.7'); bbin.setAttribute('height','0.6'); bbin.setAttribute('color','#f59e0b'); bad.appendChild(bbin);
  const bl = document.createElement('a-entity'); bl.setAttribute('text','value:RISKY; align:center; width:2'); bl.setAttribute('position','0 0 0.01'); bad.appendChild(bl);
  document.getElementById('gameRoot').appendChild(bad);

  spawnItem();
}
function spawnItem(){
  const root = document.getElementById('gameRoot');
  // remove previous item
  const prev = document.getElementById('curItem'); if(prev) prev.remove();
  if(iIndex>=items.length){ end(); return; }
  const item = items[iIndex++];

  const p = document.createElement('a-entity'); p.setAttribute('id','curItem'); p.setAttribute('position','0 -0.25 0');
  const btnLeft = document.createElement('a-plane'); btnLeft.setAttribute('width','0.6'); btnLeft.setAttribute('height','0.25'); btnLeft.setAttribute('color','#22c55e'); btnLeft.setAttribute('class','clickable');
  const bl = document.createElement('a-entity'); bl.setAttribute('text','value:✔ CLEAN; align:center; width:1.8; color:#fff'); bl.setAttribute('position','0 0 0.01'); btnLeft.appendChild(bl);
  btnLeft.addEventListener('click',()=>choose(true));

  const btnRight = document.createElement('a-plane'); btnRight.setAttribute('width','0.6'); btnRight.setAttribute('height','0.25'); btnRight.setAttribute('color','#ef4444'); btnRight.setAttribute('class','clickable');
  const br = document.createElement('a-entity'); br.setAttribute('text','value:⚠ RISKY; align:center; width:1.8; color:#fff'); br.setAttribute('position','0 0 0.01'); btnRight.appendChild(br);
  btnRight.addEventListener('click',()=>choose(false));

  const label = document.createElement('a-entity'); label.setAttribute('text',`value:${item.label}; align:center; width:3; color:#e5e7eb`);
  label.setAttribute('position','0 0.45 0.01');
  const left = document.createElement('a-entity'); left.setAttribute('position','-0.7 0 0'); left.appendChild(btnLeft);
  const right = document.createElement('a-entity'); right.setAttribute('position','0.7 0 0'); right.appendChild(btnRight);

  p.appendChild(label); p.appendChild(left); p.appendChild(right);
  root.appendChild(p);

  function choose(good){
    if(!state.running) return;
    const correctPick = (good===item.good);
    if(correctPick){ addScore(10); correct++; } else { APP.beep(220,0.06); }
    spawnItem();
  }
}

reset();
</script>
</body>
</html>
