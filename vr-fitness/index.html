<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Fitness Academy · Sport Tech</title>
  <link rel="stylesheet" href="core/themes/sport-tech.css"/>
</head>
<body>
  <header class="header">
    <div class="brand">VR Fitness Academy</div>
    <div class="toolbar">
      <label class="small" for="langSel" data-i18n="language">Language</label>
      <select id="langSel" class="btn">
        <option value="en">English</option>
        <option value="th">ไทย</option>
      </select>
      <button class="btn" id="muteBtn">🔊</button>
    </div>
  </header>

  <main class="container">
    <h1 style="margin:12px 0 6px" data-i18n="hub_title">Choose your workout</h1>
    <div class="small" data-i18n="hub_sub">4 mini-games • scoring • BGM • results</div>
    <div class="grid" id="gameGrid" aria-live="polite"></div>
  </main>

  <!-- Recent Results (central leaderboard preview) -->
  <section class="container" id="lbSection">
    <h2 style="margin:4px 0 10px">Recent Results</h2>
    <div class="card" id="lbCard"><div class="small">No scores yet</div></div>
  </section>

  <footer class="footer">
    <span>Sport Tech UI · <span class="kbd">ESC</span> to exit VR</span>
  </footer>

  <!-- Core scripts -->
  <script src="core/i18n.js"></script>
  <script src="core/audio.js"></script>
  <script src="core/engine.js"></script>
  <script src="core/ui.js"></script>
  <script src="core/leaderboard.js"></script>

  <!-- Fallback: ถ้า config.json โหลดไม่ได้ ให้เรนเดอร์การ์ดเกมจาก DEFAULT_CFG ที่ฝังไว้ -->
  <script>
    const DEFAULT_CFG = {
      projectName: "VR Fitness Academy",
      theme: "sport-tech",
      languages: ["en","th"],
      defaultLang: "en",
      games: [
        {id:"shadow-breaker", name:{en:"Shadow Breaker", th:"ชาโดว์เบรกเกอร์"}, desc:{en:"Slash or punch targets in time.", th:"ฟาด/ชกเป้าตามจังหวะ"}},
        {id:"rhythm-boxer",  name:{en:"Rhythm Boxer",    th:"ริทึมบ็อกเซอร์"}, desc:{en:"Box to the beat and rack up combos.", th:"ชกตามจังหวะ เก็บคอมโบ"}},
        {id:"jump-duck",     name:{en:"Jump & Duck",      th:"กระโดดและก้ม"}, desc:{en:"Move your body to dodge barriers.", th:"ขยับตัวหลบสิ่งกีดขวาง"}},
        {id:"balance-hold",  name:{en:"Balance Hold",     th:"ทรงตัวค้าง"},    desc:{en:"Hold steady poses for points.", th:"ทรงท่าค้าง รับคะแนน"}}
      ],
      audio: { bgm: "assets/sfx/bgm.wav", click: "assets/sfx/click.wav" }
    };

    // ปุ่มเสียง
    document.getElementById('muteBtn').addEventListener('click', ()=>{ try { AudioBus.mute(true); } catch(e){} });

    // Leaderboard preview
    (function(){
      try {
        const list = Leaderboard.recent(8);
        const card = document.getElementById('lbCard');
        if (!list || list.length === 0) {
          card.innerHTML = '<div class="small">No scores yet</div>';
        } else {
          const rows = list.map(e => {
            const when = new Date(e.ts).toLocaleString();
            const game = e.gameId || 'unknown';
            const acc  = (e.accuracy != null ? (e.accuracy + '%') : '-');
            return `<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #1a2532">
              <div><b>${game}</b> · ${when}</div>
              <div>Score <b>${e.score || 0}</b> · MaxCombo <b>${e.maxCombo || 0}</b> · Acc ${acc}</div>
            </div>`;
          }).join('');
          card.innerHTML = rows;
        }
      } catch (e) {}
    })();

    // Fallback renderer: ถ้าผ่าน 600ms แล้วยังไม่มีการ์ดเกม ให้เรนเดอร์จาก DEFAULT_CFG ทันที
    (function fallbackRender(){
      setTimeout(() => {
        const grid = document.getElementById('gameGrid');
        if (grid && grid.children.length === 0) {
          // กำหนดภาษาเริ่มต้น
          const langSel = document.getElementById('langSel');
          const LANG = (localStorage.getItem('lang') || DEFAULT_CFG.defaultLang || 'en');
          if (langSel) langSel.value = LANG;

          // แสดงการ์ดเกม
          grid.innerHTML = DEFAULT_CFG.games.map(g => `
            <div class="card">
              <h3>${(g.name[LANG] || g.name.en)}</h3>
              <p>${(g.desc[LANG] || g.desc.en)}</p>
              <div style="margin-top:12px; display:flex; gap:8px">
                <button class="btn accent" data-game="${g.id}">${LANG==='th'?'เล่น':'Play'}</button>
                <a class="btn" href="games/${g.id}/index.html" target="_blank">${LANG==='th'?'เปิด':'Open'}</a>
              </div>
            </div>
          `).join('');

          // คลิกปุ่ม Play → ไปที่หน้าเกม
          grid.querySelectorAll('button[data-game]').forEach(btn=>{
            btn.addEventListener('click', e=>{
              try { AudioBus.tap(); } catch(e){}
              const id = e.currentTarget.dataset.game;
              window.location.href = `games/${id}/index.html?mode=timed&diff=normal`;
            });
          });

          // เล่น BGM ถ้ามี
          try { AudioBus.load(DEFAULT_CFG); AudioBus.playBgm(); } catch(e){}
        }
      }, 600);
    })();
  </script>
</body>
</html>
