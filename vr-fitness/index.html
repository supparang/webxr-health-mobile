<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VR Fitness — Hub</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{--bg:#0f1220;--fg:#e9ecf1;--muted:#a9afc1;--card:#171a2b;--accent:#76e1ff}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Inter,Arial}
    .topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #22263a;position:sticky;top:0;background:linear-gradient(180deg,#0f1220 0%,#0f1220ee 100%);z-index:5}
    .brand{margin:0;font-size:20px;letter-spacing:.3px}
    .btn{background:var(--accent);color:#001018;border:0;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer}
    .btn.hidden{display:none}
    .hub{padding:20px;background:var(--bg)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #22263a;border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .card h2{margin:0 0 6px 0;font-size:18px}
    .desc{margin:0 0 10px 0;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .row label{color:var(--muted)}
    select,input[type=number]{width:130px;background:#0f1220;color:var(--fg);border:1px solid #2a2f4a;border-radius:10px;padding:8px}
    .stage{position:fixed;inset:0;background:#000;display:none}
    .stage.show{display:flex}
    .frame{flex:1;width:100%;height:100%;border:0;background:#000}
    .overlay{position:absolute;left:0;right:0;top:12px;display:none;justify-content:center;pointer-events:none}
    .overlay .pill{background:#ffffff1a;color:#fff;padding:6px 12px;border-radius:999px;font-weight:600;backdrop-filter: blur(6px);border:1px solid #ffffff33}
    .err{position:fixed;left:12px;bottom:12px;max-width:min(92vw,680px);background:#2a2f4a;color:#fff;border:1px solid #445;border-radius:12px;padding:10px 12px;font-size:14px;line-height:1.4;display:none}
    .err b{color:#fff}
    .fallback{margin-top:8px;font-size:13px;color:#ddd}
    .links a{color:#bde3ff}
  </style>
</head>
<body>
  <header class="topbar">
    <h1 class="brand">VR Fitness — Hub</h1>
    <button id="btnBack" class="btn hidden" data-action="back">← Back to Hub</button>
  </header>

  <main id="hub" class="hub">
    <section class="grid">
      <article class="card">
        <h2>Shadow Breaker</h2>
        <p class="desc">ชกตามแพทเทิร์น—ฟิตแรง แข่งเวลา</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-sb"><option>easy</option><option selected>normal</option><option>hard</option><option>final</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-sb" type="number" min="30" max="180" step="5" value="90"/></div>
        <div class="row">
          <button class="btn" data-action="play" data-game="shadow-breaker">Play</button>
          <span class="fallback links"><a target="_self" href="/webxr-health-mobile/vr-fitness/shadow-breaker/play.html?game=shadow-breaker&mode=timed&diff=normal&time=90">เปิดตรง</a></span>
        </div>
      </article>

      <article class="card">
        <h2>Rhythm Boxer</h2>
        <p class="desc">ต่อจังหวะ—แม่นจังหวะเพื่อคอมโบ</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-rb"><option>easy</option><option selected>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-rb" type="number" min="45" max="180" step="5" value="85"/></div>
        <div class="row">
          <button class="btn" data-action="play" data-game="rhythm-boxer">Play</button>
          <span class="fallback links"><a target="_self" href="/webxr-health-mobile/vr-fitness/rhythm-boxer/play.html?game=rhythm-boxer&mode=timed&diff=normal&time=85">เปิดตรง</a></span>
        </div>
      </article>

      <article class="card">
        <h2>Jump–Duck</h2>
        <p class="desc">กระโดด–ก้ม หลบสิ่งกีดขวาง</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-jd"><option selected>easy</option><option>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-jd" type="number" min="45" max="180" step="5" value="80"/></div>
        <div class="row">
          <button class="btn" data-action="play" data-game="jump-duck">Play</button>
          <span class="fallback links"><a target="_self" href="/webxr-health-mobile/vr-fitness/jump-duck/play.html?game=jump-duck&mode=timed&diff=easy&time=80">เปิดตรง</a></span>
        </div>
      </article>

      <article class="card">
        <h2>Balance–Hold</h2>
        <p class="desc">ทรงตัว นิ่ง ควบคุมแกนกลาง</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-bh"><option>easy</option><option selected>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-bh" type="number" min="30" max="180" step="5" value="75"/></div>
        <div class="row">
          <button class="btn" data-action="play" data-game="balance-hold">Play</button>
          <span class="fallback links"><a target="_self" href="/webxr-health-mobile/vr-fitness/balance-hold/play.html?game=balance-hold&mode=timed&diff=normal&time=75">เปิดตรง</a></span>
        </div>
      </article>
    </section>
  </main>

  <section id="stage" class="stage" aria-hidden="true">
    <iframe id="gameFrame" class="frame" allow="autoplay; xr-spatial-tracking; fullscreen *; accelerometer; gyroscope;"></iframe>
    <div id="overlay" class="overlay"><div class="pill">Paused</div></div>
  </section>

  <div id="err" class="err"></div>

  <script>
    // ===== Robust launcher: ลองหลายพาธ + เช็ก 200 ก่อนค่อยเปิด (กัน 404) =====
    const $ = s=>document.querySelector(s);
    const hubEl=$("#hub"), stageEl=$("#stage"), frameEl=$("#gameFrame"), backBtn=$("#btnBack");
    const overlay=$("#overlay"), errBox=$("#err");

    const CANDIDATES = (g)=>[
      `/webxr-health-mobile/vr-fitness/${g}/play.html`,
      `/webxr-health-mobile/vr-fitness/games/${g}/play.html`,
      `/vr-fitness/${g}/play.html`,
      `/vr-fitness/games/${g}/play.html`
    ];

    function defaults(g){
      if(g==="shadow-breaker") return {min:30, time:90,  diff:"normal"};
      if(g==="rhythm-boxer")   return {min:45, time:85,  diff:"normal"};
      if(g==="jump-duck")      return {min:45, time:80,  diff:"easy"};
      if(g==="balance-hold")   return {min:30, time:75,  diff:"normal"};
      return {min:30, time:90, diff:"normal"};
    }
    function clamp(n,a,b){ n=+n; if(Number.isNaN(n)) return a; return Math.max(a, Math.min(b,n)); }
    const v  = sel => (document.querySelector(sel)||{}).value || "";
    const vn = sel => +(document.querySelector(sel)||{}).value || 0;

    function getControls(g){
      if(g==="shadow-breaker") return { diff: v('[data-name="diff-sb"]'), time: clamp(vn('[data-name="time-sb"]'),30,180) };
      if(g==="rhythm-boxer")   return { diff: v('[data-name="diff-rb"]'), time: clamp(vn('[data-name="time-rb"]'),45,180) };
      if(g==="jump-duck")      return { diff: v('[data-name="diff-jd"]'), time: clamp(vn('[data-name="time-jd"]'),45,180) };
      if(g==="balance-hold")   return { diff: v('[data-name="diff-bh"]'), time: clamp(vn('[data-name="time-bh"]'),30,180) };
      const d=defaults(g); return { diff:d.diff, time:d.time };
    }

    function showHub(){ hubEl.style.display="block"; stageEl.classList.remove("show"); backBtn.classList.add("hidden"); frameEl.removeAttribute("src"); overlay.style.display="none"; }
    function showStage(){ hubEl.style.display="none"; stageEl.classList.add("show"); backBtn.classList.remove("hidden"); }
    function showErr(msg, tried=[]){
      errBox.style.display="block";
      errBox.innerHTML = "<b>⚠️ Error:</b> "+msg + (tried.length? `<div class='fallback' style="margin-top:6px">Tried: ${tried.map(x=>`<code>${x}</code>`).join(", ")}</div>` : "");
      console.error(msg, tried);
    }

    async function headOK(url){
      try{
        const r = await fetch(url + (url.includes("?")?"&":"?") + "v=live", {method:"HEAD", cache:"no-store"});
        return r.ok;
      }catch(e){ return false; }
    }

    async function resolveGameURL(game, params){
      const tried=[];
      for(const base of CANDIDATES(game)){
        const url = `${base}?${new URLSearchParams(params).toString()}`;
        tried.push(url);
        if(await headOK(base)) return {url, tried};
      }
      // บาง host ไม่ตอบ HEAD กับ html → ลอง GET
      for(const base of CANDIDATES(game)){
        const url = `${base}?${new URLSearchParams(params).toString()}`;
        tried.push(url);
        try{
          const r = await fetch(base + (base.includes("?")?"&":"?") + "v=live", {method:"GET", cache:"no-store"});
          if(r.ok) return {url, tried};
        }catch(e){}
      }
      return {url:null, tried};
    }

    document.addEventListener("click", async (ev)=>{
      const a = ev.target.closest("[data-action]");
      if(!a) return;
      if(a.dataset.action==="play"){
        const game = a.dataset.game;
        const d = defaults(game);
        const c = getControls(game);
        const params = { game, mode:"timed", diff: (c.diff || d.diff), time: String(c.time || d.time) };

        const {url, tried} = await resolveGameURL(game, params);
        if(!url) { showErr("ไม่พบไฟล์ play.html ของเกมนี้ (404)", tried); return; }

        try{ frameEl.src = url; showStage(); }
        catch(e){ showErr("โหลดเกมไม่สำเร็จ: "+e.message, tried); showHub(); }
      }
      if(a.dataset.action==="back"){ showHub(); }
    });

    window.addEventListener("blur", ()=>{ if(frameEl.contentWindow){ overlay.style.display="flex"; frameEl.contentWindow.postMessage({type:"hub:pause",value:true},"*"); } });
    window.addEventListener("focus", ()=>{ if(frameEl.contentWindow){ overlay.style.display="none"; frameEl.contentWindow.postMessage({type:"hub:pause",value:false},"*"); } });

    frameEl.addEventListener("error", ()=>showErr("ไม่สามารถโหลด iFrame ได้ (ตรวจ URL เกม)"));
    window.addEventListener("message",(ev)=>{ if((ev.data||{}).type==="game:ready"){ overlay.style.display="none"; } });

    showHub();
  </script>
</body>
</html>
