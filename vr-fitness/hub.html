<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>VR Fitness — Hub</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{
      --bg:#020617; --panel:rgba(2,6,23,.78); --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18); --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22d3ee; --radius:22px; --pill:999px;
      --sat: env(safe-area-inset-top,0px);
      --sar: env(safe-area-inset-right,0px);
      --sab: env(safe-area-inset-bottom,0px);
      --sal: env(safe-area-inset-left,0px);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;color:var(--text);font:16px/1.5 system-ui,Segoe UI,Inter,Arial}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px calc(18px + var(--sar)) 14px calc(18px + var(--sal));
      border-bottom:1px solid #22263a;
      position:sticky;top:0;background:linear-gradient(180deg,#0f1220 0%,#0f1220ee 100%);z-index:5
    }
    .brand{margin:0;font-size:20px;letter-spacing:.3px}
    .btn{
      background:var(--accent);color:#001018;border:0;padding:10px 14px;border-radius:var(--pill);
      font-weight:700;cursor:pointer
    }
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,.35)}
    .btn.hidden{display:none}
    .hub{padding:20px calc(18px + var(--sar)) calc(22px + var(--sab)) calc(18px + var(--sal));background:#0b1020}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .card{
      background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:16px;
      box-shadow:0 8px 22px rgba(0,0,0,.35)
    }
    .card h2{margin:0 0 6px 0;font-size:18px}
    .desc{margin:0 0 10px 0;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .row label{color:var(--muted);font-size:13px}
    select,input[type=number]{
      width:130px;background:#0f1220;color:var(--text);border:1px solid #2a2f4a;border-radius:12px;padding:8px
    }
    .stage{position:fixed;inset:0;background:#000;display:none}
    .stage.show{display:flex}
    .frame{flex:1;width:100%;height:100%;border:0;background:#000}
    .overlayTop{
      position:absolute;left:0;right:0;top:calc(10px + var(--sat));
      display:flex;justify-content:center;pointer-events:none
    }
    .pill{
      background:#ffffff1a;color:#fff;padding:6px 12px;border-radius:999px;font-weight:700;
      backdrop-filter: blur(6px);border:1px solid #ffffff33;font-size:13px
    }
    .err{
      position:fixed;left:12px;bottom:calc(12px + var(--sab));max-width:min(92vw,680px);
      background:#2a2f4a;color:#fff;border:1px solid #445;border-radius:12px;padding:10px 12px;font-size:14px;
      line-height:1.4;display:none;z-index:9
    }
    .fallback{margin-top:8px;font-size:13px;color:#ddd}
    .links a{color:#bde3ff}
  </style>
</head>
<body>
  <header class="topbar">
    <h1 class="brand">VR Fitness — Hub</h1>
    <button id="btnBack" class="btn secondary hidden" type="button">← Back to Hub</button>
  </header>

  <main id="hub" class="hub">
    <section class="grid">
      <article class="card">
        <h2>Shadow Breaker</h2>
        <p class="desc">ชก/ยิงเป้า — Reaction + Accuracy + Focus (มีบอส 4 ตัว)</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-sb"><option>easy</option><option selected>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-sb" type="number" min="30" max="180" step="5" value="90"/></div>
        <div class="row"><label>Research</label>
          <select data-name="research-sb"><option value="0" selected>Play</option><option value="1">Research</option></select>
        </div>
        <div class="row">
          <button class="btn" data-action="play" data-game="shadow-breaker">Play</button>
          <span class="fallback links">
            <a target="_self" data-direct="shadow-breaker" href="#">เปิดตรง</a>
          </span>
        </div>
      </article>

      <article class="card">
        <h2>Rhythm Boxer</h2>
        <p class="desc">ต่อยตามจังหวะ — Timing + Combo</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-rb"><option>easy</option><option selected>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-rb" type="number" min="45" max="180" step="5" value="85"/></div>
        <div class="row"><label>Research</label>
          <select data-name="research-rb"><option value="0" selected>Play</option><option value="1">Research</option></select>
        </div>
        <div class="row">
          <button class="btn" data-action="play" data-game="rhythm-boxer">Play</button>
          <span class="fallback links"><a target="_self" data-direct="rhythm-boxer" href="#">เปิดตรง</a></span>
        </div>
      </article>

      <article class="card">
        <h2>Jump–Duck</h2>
        <p class="desc">กระโดด–ก้ม — Agility + Balance</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-jd"><option selected>easy</option><option>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-jd" type="number" min="45" max="180" step="5" value="80"/></div>
        <div class="row"><label>Research</label>
          <select data-name="research-jd"><option value="0" selected>Play</option><option value="1">Research</option></select>
        </div>
        <div class="row">
          <button class="btn" data-action="play" data-game="jump-duck">Play</button>
          <span class="fallback links"><a target="_self" data-direct="jump-duck" href="#">เปิดตรง</a></span>
        </div>
      </article>

      <article class="card">
        <h2>Balance–Hold</h2>
        <p class="desc">ทรงตัว/คุมแกนกลาง — Core + Stability</p>
        <div class="row"><label>Difficulty</label>
          <select data-name="diff-bh"><option>easy</option><option selected>normal</option><option>hard</option></select>
        </div>
        <div class="row"><label>Time (sec)</label><input data-name="time-bh" type="number" min="30" max="180" step="5" value="75"/></div>
        <div class="row"><label>Research</label>
          <select data-name="research-bh"><option value="0" selected>Play</option><option value="1">Research</option></select>
        </div>
        <div class="row">
          <button class="btn" data-action="play" data-game="balance-hold">Play</button>
          <span class="fallback links"><a target="_self" data-direct="balance-hold" href="#">เปิดตรง</a></span>
        </div>
      </article>
    </section>
  </main>

  <section id="stage" class="stage" aria-hidden="true">
    <iframe id="gameFrame" class="frame" allow="autoplay; xr-spatial-tracking; fullscreen *; accelerometer; gyroscope;"></iframe>
    <div class="overlayTop"><div id="stagePill" class="pill">Running…</div></div>
  </section>

  <div id="err" class="err"></div>

  <script>
    // ===== HeroHealth-like Hub: passthrough + view detect (no override if exists) =====
    const $ = s=>document.querySelector(s);
    const hubEl=$("#hub"), stageEl=$("#stage"), frameEl=$("#gameFrame"), backBtn=$("#btnBack");
    const errBox=$("#err");

    function qs(k, d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } }
    function clamp(n,a,b){ n=+n; if(!Number.isFinite(n)) return a; return Math.max(a, Math.min(b,n)); }

    // detect view once (pc/mobile/vr/cvr) — but NEVER override if already provided
    function detectView(){
      const v = (qs('view','')||'').toLowerCase();
      if (v) return v;
      const ua = navigator.userAgent || '';
      if (/Quest|Oculus|Vive|VR/i.test(ua)) return 'vr';
      if (/Mobi|Android|iPhone|iPad|iPod/i.test(ua)) return 'mobile';
      return 'pc';
    }

    // shared passthrough keys (HeroHealth style)
    const PASS_KEYS = [
      'hub','run','diff','time','seed','studyId','phase','conditionGroup','ts','log','style','view','research'
    ];

    function buildParams(extra){
      const p = new URLSearchParams();
      // passthrough from hub url
      for (const k of PASS_KEYS){
        const v = qs(k,'');
        if (v !== null && v !== '') p.set(k, v);
      }
      // ensure hub points back here if not given
      if (!p.get('hub')) p.set('hub', location.href.split('#')[0]);
      // ensure view exists (but do not override if already in URL)
      if (!p.get('view')) p.set('view', detectView());
      // apply extra
      Object.entries(extra||{}).forEach(([k,v])=>{
        if (v !== undefined && v !== null && v !== '') p.set(k, String(v));
      });
      // seed default if empty (for later use)
      if (!p.get('seed')) p.set('seed', String(Date.now()));
      return p;
    }

    const GAME_URL = {
      'shadow-breaker': './shadow-breaker/index.html',
      'rhythm-boxer': './rhythm-boxer/index.html',
      'jump-duck': './jump-duck/index.html',
      'balance-hold': './balance-hold/index.html'
    };

    function getControls(game){
      if (game==='shadow-breaker') return {
        diff: ($('[data-name="diff-sb"]')||{}).value || 'normal',
        time: clamp(($('[data-name="time-sb"]')||{}).value, 30, 180),
        research: ($('[data-name="research-sb"]')||{}).value || '0'
      };
      if (game==='rhythm-boxer') return {
        diff: ($('[data-name="diff-rb"]')||{}).value || 'normal',
        time: clamp(($('[data-name="time-rb"]')||{}).value, 45, 180),
        research: ($('[data-name="research-rb"]')||{}).value || '0'
      };
      if (game==='jump-duck') return {
        diff: ($('[data-name="diff-jd"]')||{}).value || 'easy',
        time: clamp(($('[data-name="time-jd"]')||{}).value, 45, 180),
        research: ($('[data-name="research-jd"]')||{}).value || '0'
      };
      if (game==='balance-hold') return {
        diff: ($('[data-name="diff-bh"]')||{}).value || 'normal',
        time: clamp(($('[data-name="time-bh"]')||{}).value, 30, 180),
        research: ($('[data-name="research-bh"]')||{}).value || '0'
      };
      return { diff:'normal', time:90, research:'0' };
    }

    function showHub(){
      hubEl.style.display="block";
      stageEl.classList.remove("show");
      backBtn.classList.add("hidden");
      frameEl.removeAttribute("src");
      errBox.style.display="none";
    }
    function showStage(){
      hubEl.style.display="none";
      stageEl.classList.add("show");
      backBtn.classList.remove("hidden");
    }
    function showErr(msg){
      errBox.style.display="block";
      errBox.innerHTML = "<b>⚠️ Error:</b> " + msg;
      console.error(msg);
    }

    // direct links in cards
    function refreshDirectLinks(){
      document.querySelectorAll('[data-direct]').forEach(a=>{
        const game = a.getAttribute('data-direct');
        const c = getControls(game);
        const base = GAME_URL[game] || '#';
        const params = buildParams({ diff:c.diff, time:c.time, research:c.research });
        a.href = base + "?" + params.toString();
      });
    }
    refreshDirectLinks();

    document.addEventListener("change", (ev)=>{
      if (ev.target && ev.target.closest('.card')) refreshDirectLinks();
    });

    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action]");
      if (!btn) return;

      if (btn.dataset.action === "play"){
        const game = btn.dataset.game;
        const base = GAME_URL[game];
        if (!base){ showErr("ยังไม่มีหน้า index.html ของเกมนี้"); return; }

        const c = getControls(game);
        const params = buildParams({
          run:'play',
          diff:c.diff,
          time:c.time,
          research:c.research
        });

        const url = base + "?" + params.toString();
        try{
          frameEl.src = url;
          showStage();
        }catch(e){
          showErr("โหลดเกมไม่สำเร็จ: " + e.message);
          showHub();
        }
      }

      if (btn.id === "btnBack"){
        showHub();
      }
    });

    // pause hint (best effort)
    window.addEventListener("blur", ()=>{
      try{ frameEl.contentWindow && frameEl.contentWindow.postMessage({type:"hub:pause",value:true},"*"); }catch(_){}
    });
    window.addEventListener("focus", ()=>{
      try{ frameEl.contentWindow && frameEl.contentWindow.postMessage({type:"hub:pause",value:false},"*"); }catch(_){}
    });

    showHub();
  </script>
</body>
</html>