<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Shadow Breaker — Play</title>
  <meta name="color-scheme" content="dark dark"/>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:16px/1.4 system-ui,Segoe UI,Inter,Arial}
    #boot{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(ellipse at top,#0f1220 0%,#000 60%);z-index:10}
    #boot .box{background:#121528;padding:18px 20px;border-radius:14px;border:1px solid #2a2f4a;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:min(92vw,560px)}
    #boot h1{margin:0 0 6px 0;font-size:18px}
    #boot p{margin:6px 0;color:#d7def0}
    #boot .log{margin-top:10px;background:#0a0d1f;border:1px solid #243;min-height:60px;max-height:200px;overflow:auto;border-radius:10px;padding:8px;font-family:ui-monospace,Menlo,Consolas,mono;font-size:12px;white-space:pre-wrap}
    #err{position:fixed;left:12px;bottom:12px;max-width:min(92vw,720px);display:none;background:#2a2f4a;border:1px solid #445;border-radius:12px;padding:10px 12px;font-size:13px;line-height:1.45;z-index:11}
    #err b{color:#fff}
  </style>
</head>
<body>
  <div id="boot">
    <div class="box">
      <h1>Loading Shadow Breaker…</h1>
      <p>กำลังโหลด <code>hub-adapter.js</code> และเริ่มเกมแบบ Inline</p>
      <div class="log" id="bootLog">• start</div>
    </div>
  </div>
  <div id="err"></div>

  <!-- โหลด hub-adapter.js ตามพาธจริง (พร้อม cache-busting) -->
  <script>
    const logEl=document.getElementById('bootLog'); const errEl=document.getElementById('err'); const boot=document.getElementById('boot');
    const log=s=>{logEl.textContent+="\n• "+s; logEl.scrollTop=logEl.scrollHeight;};
    const showErr=m=>{errEl.style.display='block'; errEl.innerHTML="<b>⚠️ Error:</b> "+m; console.error(m);};

    // error guards
    window.addEventListener('error',(e)=>showErr((e.error&&e.error.stack)||e.message||String(e)),true);
    window.addEventListener('unhandledrejection',(e)=>showErr((e.reason&&(e.reason.stack||e.reason.message))||String(e.reason)),true);

    function loadAdapterThenStart(){
      const s=document.createElement('script');
      s.src="/webxr-health-mobile/vr-fitness/hub-adapter.js?v=live";
      s.onload=()=>{ log('hub-adapter.js loaded ✓'); startGameInline(); };
      s.onerror=()=>{ showErr('โหลด hub-adapter.js ไม่สำเร็จ — ตรวจพาธ/ไฟล์'); };
      document.head.appendChild(s);
    }
  </script>

  <!-- โค้ดเกมแบบ Inline (ไม่พึ่ง import ภายนอก ป้องกัน 404 → “<”) -->
  <script type="module">
    function startGameInline(){
      // อ่าน query จาก Hub
      const u=new URL(location.href);
      const L={
        game:u.searchParams.get("game")||"shadow-breaker",
        mode:u.searchParams.get("mode")||"timed",
        diff:u.searchParams.get("diff")||"normal",
        time:Math.max(30,Math.min(180,+(u.searchParams.get("time")||90)))
      };

      // scaffolding UI
      const root=document.createElement("div");
      root.id="sb-root";
      Object.assign(root.style,{position:"fixed",inset:"0",background:"#000",color:"#fff",font:"16px/1.4 system-ui,Segoe UI,Inter,Arial",display:"grid",placeItems:"center",userSelect:"none"});
      root.innerHTML=`
        <div id="sb-ui" style="text-align:center">
          <div style="opacity:.8;font-size:14px;margin-bottom:6px">VR Fitness — <b>Shadow Breaker</b></div>
          <div style="font-size:40px;font-weight:800;margin:6px 0" id="sb-time">--:--</div>
          <div style="font-size:18px;margin:6px 0">Diff: <b id="sb-diff"></b> | Mode: <b id="sb-mode"></b></div>
          <div style="display:flex;gap:18px;justify-content:center;margin-top:10px">
            <div>Score<br><b id="sb-score" style="font-size:22px">0</b></div>
            <div>Combo<br><b id="sb-combo" style="font-size:22px">0</b></div>
            <div>Stars<br><b id="sb-stars" style="font-size:22px">0</b></div>
          </div>
          <div style="margin-top:18px;opacity:.7;font-size:13px">(demo) คลิกปุ่มเพื่อ +คะแนน/คอมโบ — ส่งค่าไป Hub ทุกวินาที</div>
          <button id="sb-add" style="margin-top:12px;padding:8px 12px;border-radius:10px;border:0;background:#76e1ff;color:#001018;font-weight:700;cursor:pointer">+ Hit!</button>
        </div>`;
      document.body.appendChild(root);

      const elTime=document.getElementById("sb-time");
      const elScore=document.getElementById("sb-score");
      const elCombo=document.getElementById("sb-combo");
      const elStars=document.getElementById("sb-stars");
      document.getElementById("sb-diff").textContent=L.diff;
      document.getElementById("sb-mode").textContent=L.mode;

      let score=0, combo=0, bestCombo=0, stars=0;
      let timeLeft=L.time;
      let paused=false, rafId=0, tmo=0;

      const pad=n=>n<10?("0"+n):(""+n);
      const fmt=s=>`${pad((s/60)|0)}:${pad(s%60)}`;
      const render=()=>{ elTime.textContent=fmt(Math.max(0,timeLeft)); elScore.textContent=score; elCombo.textContent=combo; elStars.textContent=stars; };
      const updStars=()=>{ stars = Math.max(stars, score>=100?3: score>=50?2: score>=20?1:0); };

      document.getElementById("sb-add").addEventListener("click", ()=>{
        if(paused||timeLeft<=0) return;
        const mul = L.diff==="easy"?1: L.diff==="hard"?2: L.diff==="final"?3: 1.5;
        const gain = Math.max(1, Math.floor(1*mul + combo*0.2));
        score += gain; combo += 1; bestCombo = Math.max(bestCombo, combo); updStars(); render();
      });

      window.Game = window.Game || {};
      window.Game.setPaused = (f)=>{ paused=!!f; };

      function loop(){ if(!paused && timeLeft>0){ /* anim/vfx here */ } rafId=requestAnimationFrame(loop); }
      function sec(){ if(!paused && timeLeft>0){ timeLeft--; try{ window.HubScoreTick&&HubScoreTick(score,combo,Math.max(0,timeLeft),stars);}catch{}; if(timeLeft<=0) end(); render(); } tmo=setTimeout(sec,1000); }
      function end(){ cancelAnimationFrame(rafId); clearTimeout(tmo); updStars(); try{ window.HubGameEnd&&HubGameEnd({score,maxCombo:bestCombo,stars,time:L.time}); }catch{} }

      render(); loop(); sec();
      try{ window.HubGameReady && HubGameReady(); }catch{}
      document.getElementById('boot').style.display='none';
    }

    // เริ่มโหลดอแดปเตอร์ → แล้วค่อย start เกม
    loadAdapterThenStart();
  </script>
</body>
</html>
