<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Fitness ‚Äî Roster (Auto PID + QR)</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="../herohealth/favicon.ico"/>
  <style>
    :root{
      --bg:#040610;
      --panel: rgba(4,6,16,.78);
      --panel2: rgba(10,16,36,.55);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --cyan:#22d3ee;
      --amber:#f59e0b;
      --red:#ef4444;
      --radius:22px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 10% -10%, rgba(34,211,238,.10), transparent 55%),
                  radial-gradient(900px 700px at 110% 20%, rgba(34,197,94,.10), transparent 55%),
                  linear-gradient(180deg, #050716, #02030a);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: calc(16px + var(--sat)) 16px calc(18px + var(--sab));
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .title{
      font-weight:800; letter-spacing:.2px;
      font-size: 18px;
    }
    .sub{
      color:var(--muted); font-size: 13px; margin-top: 4px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,16,36,.55), rgba(4,6,16,.72));
      border-radius: var(--radius);
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, textarea, select{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
    }
    textarea{ min-height: 170px; resize: vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 560px){
      .row, .row3{ grid-template-columns: 1fr; }
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .btn.primary{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .btn.cyan{ border-color: rgba(34,211,238,.35); background: rgba(34,211,238,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .btn.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .msg{ margin-top: 10px; color: var(--muted); font-size: 13px; }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      font-size: 13px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight:700;
      font-size: 12px;
      padding: 0 8px;
    }
    td{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding: 10px 8px;
    }
    tr td:first-child{ border-radius: 14px 0 0 14px; }
    tr td:last-child{ border-radius: 0 14px 14px 0; }

    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ color: var(--muted); font-size: 12px; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    /* QR grid */
    .qrWrap{ margin-top:12px; }
    .qrControls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .qrGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 1100px){ .qrGrid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 760px){ .qrGrid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 460px){ .qrGrid{ grid-template-columns: 1fr;} }

    .qrCard{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .qrImg{
      width: 86px; height: 86px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .qrMeta{
      min-width:0;
    }
    .qrMeta .name{ font-weight:800; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .qrMeta .pid{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: var(--cyan); font-weight:800; }
    .qrMeta .hint{ color: var(--muted); font-size: 12px; margin-top: 4px; }

    /* Print: make QR cards clean */
    @media print{
      body{ background:white; color:black; }
      .wrap{ padding: 0; max-width: none; }
      .top, .btns, .msg, .small, textarea, input, select, .card:first-child { display:none !important; }
      .card{ border:none; box-shadow:none; background:transparent; }
      .qrCard{ break-inside: avoid; background: white; border:1px solid #ccc; }
      .qrMeta .pid{ color: black; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Roster (Auto PID + QR) ‚Äî ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏õ.5</div>
        <div class="sub">‡∏™‡∏£‡πâ‡∏≤‡∏á PID + ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Planner ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>
      </div>
      <div class="btns">
        <button id="btn-back" class="btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button id="btn-open-planner" class="btn cyan">‡πÄ‡∏õ‡∏¥‡∏î Planner</button>
        <button id="btn-print-qr" class="btn warn">‡∏û‡∏¥‡∏°‡∏û‡πå QR</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="row3">
          <div>
            <label>School</label>
            <input id="schoolName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." />
          </div>
          <div>
            <label>Site</label>
            <input id="siteCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô SCH01" />
          </div>
          <div>
            <label>Teacher</label>
            <input id="teacherId" placeholder="‡πÄ‡∏ä‡πà‡∏ô T001" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Class</label>
            <input id="classRoom" placeholder="‡πÄ‡∏ä‡πà‡∏ô P5/2" />
          </div>
          <div>
            <label>StudyId</label>
            <input id="studyId" placeholder="FIT01" value="FIT01"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Phase</label>
            <select id="phase">
              <option value="pre">pre</option>
              <option value="post">post</option>
            </select>
          </div>
          <div>
            <label>Condition Group</label>
            <select id="conditionGroup">
              <option value="A">A (easy)</option>
              <option value="B" selected>B (normal)</option>
              <option value="C">C (hard)</option>
              <option value="D">D (hard+)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) ‚Äî 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏Ñ‡∏ô</label>
          <textarea id="names" placeholder="‡∏î.‡∏ä. ‡∏Å‡πâ‡∏≠‡∏á\n‡∏î.‡∏ç. ‡∏ü‡πâ‡∏≤\n..."></textarea>
          <div class="small">‡∏ó‡∏¥‡∏õ: ‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú1 ‡∏Å‡πâ‡∏≠‡∏á‚Äù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>PID Prefix</label>
            <input id="pidPrefix" value="P" class="mono"/>
          </div>
          <div>
            <label>Start Number</label>
            <input id="pidStart" value="1" class="mono"/>
          </div>
        </div>

        <div class="btns">
          <button id="btn-generate" class="btn primary">‡∏™‡∏£‡πâ‡∏≤‡∏á PID</button>
          <button id="btn-save" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å roster ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
          <button id="btn-load" class="btn">‡πÇ‡∏´‡∏•‡∏î roster</button>
          <button id="btn-clear" class="btn danger">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>

        <div class="btns">
          <button id="btn-copy-csv" class="btn cyan">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å CSV</button>
          <button id="btn-dl-csv" class="btn cyan">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
          <button id="btn-copy-pids" class="btn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ‚ÄúPID list‚Äù</button>
        </div>

        <div id="msg" class="msg"></div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="split">
          <div>
            <div class="pill">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="count">0</span></div>
            <div class="pill">Selected: <span id="sel">-</span></div>
          </div>
          <div class="btns">
            <button id="btn-play-selected" class="btn primary">‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ PID ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            <button id="btn-build-qr" class="btn cyan">‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                <th>PID</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="qrWrap">
          <div class="qrControls">
            <span class="pill">QR Size:
              <select id="qrSize" style="width:auto; padding:6px 10px; border-radius: 999px;">
                <option value="160">160</option>
                <option value="200" selected>200</option>
                <option value="240">240</option>
              </select>
            </span>
            <span class="pill">Only Selected:
              <input id="qrOnlySelected" type="checkbox" style="width:auto;"/>
            </span>
            <button id="btn-copy-links" class="btn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)</button>
          </div>

          <div id="qrGrid" class="qrGrid"></div>
          <div class="small">QR ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å api.qrserver.com (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ/‡∏û‡∏¥‡∏°‡∏û‡πå)</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const $ = (s)=>document.querySelector(s);
  const msg = $('#msg');
  const tbody = $('#tbody');
  const countEl = $('#count');
  const selEl = $('#sel');
  const qrGrid = $('#qrGrid');

  const KEY = 'HHA_FITNESS_ROSTER_V1';

  function setMsg(t){ msg.textContent = t || ''; }
  function pad3(n){ return String(n).padStart(3,'0'); }
  function escCSV(v){
    const s = String(v ?? '');
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }
  function stamp(){
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
  }
  function download(filename, text){
    const blob = new Blob([text], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function copyText(text, okMsg){
    navigator.clipboard.writeText(text).then(()=>{
      setMsg(okMsg);
    }).catch(()=>{
      prompt('Copy:', text);
      setMsg('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    });
  }

  function readForm(){
    return {
      schoolName: $('#schoolName').value.trim(),
      siteCode: $('#siteCode').value.trim(),
      classRoom: $('#classRoom').value.trim(),
      teacherId: $('#teacherId').value.trim(),
      studyId: ($('#studyId').value.trim() || 'FIT01'),
      phase: $('#phase').value,
      conditionGroup: $('#conditionGroup').value,
      pidPrefix: ($('#pidPrefix').value.trim() || 'P').toUpperCase(),
      pidStart: Math.max(1, Number($('#pidStart').value || 1)),
      names: $('#names').value
    };
  }

  function parseNames(text){
    return String(text||'')
      .split('\n')
      .map(s=>s.trim())
      .filter(Boolean);
  }

  let roster = [];
  let selectedPid = '';

  function render(){
    countEl.textContent = String(roster.length);
    selEl.textContent = selectedPid || '-';

    tbody.innerHTML = roster.map(r=>{
      const checked = (r.pid === selectedPid) ? 'checked' : '';
      return `
        <tr>
          <td style="width:70px;">
            <input type="radio" name="pick" data-pid="${r.pid}" ${checked}/>
          </td>
          <td class="mono">${r.pid}</td>
          <td>${r.name}</td>
        </tr>
      `;
    }).join('');

    tbody.querySelectorAll('input[type="radio"][data-pid]').forEach(el=>{
      el.addEventListener('change', ()=>{
        selectedPid = el.getAttribute('data-pid') || '';
        render();
      });
    });
  }

  function generate(){
    const f = readForm();
    const names = parseNames(f.names);
    if(!names.length){
      setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠');
      return;
    }
    roster = names.map((name, i)=>{
      const num = f.pidStart + i;
      const pid = (num <= 999) ? `${f.pidPrefix}${pad3(num)}` : `${f.pidPrefix}${num}`;
      return {
        pid,
        name,
        schoolName: f.schoolName,
        siteCode: f.siteCode,
        classRoom: f.classRoom,
        teacherId: f.teacherId
      };
    });
    selectedPid = roster[0]?.pid || '';
    setMsg(`‡∏™‡∏£‡πâ‡∏≤‡∏á PID ‡πÅ‡∏•‡πâ‡∏ß ${roster.length} ‡∏Ñ‡∏ô`);
    render();
  }

  function rosterCSV(){
    const f = readForm();
    const header = ['pid','name','schoolName','siteCode','classRoom','teacherId','studyId','phase','conditionGroup'];
    const lines = [header.join(',')];
    for(const r of roster){
      lines.push([
        r.pid, r.name,
        r.schoolName||'', r.siteCode||'', r.classRoom||'', r.teacherId||'',
        f.studyId, f.phase, f.conditionGroup
      ].map(escCSV).join(','));
    }
    return lines.join('\\n');
  }

  function save(){
    const f = readForm();
    const obj = { form: f, roster, selectedPid, savedAt: Date.now() };
    localStorage.setItem(KEY, JSON.stringify(obj));
    setMsg('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å roster ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
  }

  function load(){
    try{
      const obj = JSON.parse(localStorage.getItem(KEY) || 'null');
      if(!obj) { setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ'); return; }

      const f = obj.form || {};
      $('#schoolName').value = f.schoolName || '';
      $('#siteCode').value = f.siteCode || '';
      $('#classRoom').value = f.classRoom || '';
      $('#teacherId').value = f.teacherId || '';
      $('#studyId').value = f.studyId || 'FIT01';
      $('#phase').value = f.phase || 'pre';
      $('#conditionGroup').value = f.conditionGroup || 'B';
      $('#pidPrefix').value = f.pidPrefix || 'P';
      $('#pidStart').value = String(f.pidStart || 1);
      $('#names').value = f.names || '';

      roster = Array.isArray(obj.roster) ? obj.roster : [];
      selectedPid = obj.selectedPid || (roster[0]?.pid || '');
      setMsg('‡πÇ‡∏´‡∏•‡∏î roster ‡πÅ‡∏•‡πâ‡∏ß');
      render();
    }catch(e){
      setMsg('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function clearAll(){
    if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤ roster?')) return;
    roster = [];
    selectedPid = '';
    $('#names').value = '';
    qrGrid.innerHTML = '';
    setMsg('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
    render();
  }

  function buildPlannerURL(pid){
    const f = readForm();
    const seed = Math.floor(Math.random()*90000 + 10000);
    const params = new URLSearchParams();
    params.set('mode','research');
    params.set('seed', String(seed));
    params.set('pid', pid);
    params.set('studyId', f.studyId);
    params.set('phase', f.phase);
    params.set('conditionGroup', f.conditionGroup);

    if(f.schoolName) params.set('schoolName', f.schoolName);
    if(f.siteCode) params.set('siteCode', f.siteCode);
    if(f.classRoom) params.set('classRoom', f.classRoom);
    if(f.teacherId) params.set('teacherId', f.teacherId);

    params.set('hub','../fitness/hub.html');
    params.set('stats','../fitness/stats.html');
    params.set('from','roster');

    return `../herohealth/fitness-planner/planner.html?${params.toString()}`;
  }

  function absoluteURL(relUrl){
    try{ return new URL(relUrl, location.href).toString(); }
    catch{ return relUrl; }
  }

  function qrImgURL(data, size){
    // QR image from qrserver (GET)
    const s = Number(size||200);
    const u = encodeURIComponent(data);
    return `https://api.qrserver.com/v1/create-qr-code/?size=${s}x${s}&data=${u}`;
  }

  function buildQR(){
    if(!roster.length){
      setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster');
      return;
    }
    const onlySel = $('#qrOnlySelected').checked;
    const size = $('#qrSize').value;

    const list = onlySel ? roster.filter(r=>r.pid===selectedPid) : roster.slice();
    if(onlySel && !list.length){
      setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PID');
      return;
    }

    qrGrid.innerHTML = list.map(r=>{
      const url = absoluteURL(buildPlannerURL(r.pid));
      const img = qrImgURL(url, size);
      const name = r.name || '';
      return `
        <div class="qrCard">
          <img class="qrImg" src="${img}" alt="QR ${r.pid}" loading="lazy"/>
          <div class="qrMeta">
            <div class="pid">${r.pid}</div>
            <div class="name">${name}</div>
            <div class="hint">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (Planner)</div>
          </div>
        </div>
      `;
    }).join('');

    setMsg(`‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÅ‡∏•‡πâ‡∏ß: ${list.length} ‡∏Ñ‡∏ô`);
  }

  function copyLinks(){
    if(!roster.length){ setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster'); return; }
    const onlySel = $('#qrOnlySelected').checked;
    const list = onlySel ? roster.filter(r=>r.pid===selectedPid) : roster.slice();
    if(onlySel && !list.length){ setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PID'); return; }

    const lines = list.map(r=>{
      const url = absoluteURL(buildPlannerURL(r.pid));
      return `${r.pid}\t${r.name}\t${url}`;
    }).join('\\n');
    copyText(lines, 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß (pid \\t name \\t url)');
  }

  // buttons
  $('#btn-generate').addEventListener('click', generate);
  $('#btn-copy-csv').addEventListener('click', ()=>{
    if(!roster.length){ setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster'); return; }
    copyText(rosterCSV(), 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß');
  });
  $('#btn-dl-csv').addEventListener('click', ()=>{
    if(!roster.length){ setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster'); return; }
    download(`fitness_roster_${stamp()}.csv`, rosterCSV());
    setMsg('‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÅ‡∏•‡πâ‡∏ß');
  });
  $('#btn-copy-pids').addEventListener('click', ()=>{
    if(!roster.length){ setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ roster'); return; }
    const txt = roster.map(r=>r.pid).join('\\n');
    copyText(txt, 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å PID list ‡πÅ‡∏•‡πâ‡∏ß');
  });

  $('#btn-save').addEventListener('click', save);
  $('#btn-load').addEventListener('click', load);
  $('#btn-clear').addEventListener('click', clearAll);

  $('#btn-back').addEventListener('click', ()=>{
    location.href = '../fitness/hub.html';
  });

  $('#btn-open-planner').addEventListener('click', ()=>{
    const pid = selectedPid || (roster[0]?.pid || 'P001');
    location.href = buildPlannerURL(pid);
  });

  $('#btn-play-selected').addEventListener('click', ()=>{
    if(!selectedPid){
      setMsg('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PID');
      return;
    }
    location.href = buildPlannerURL(selectedPid);
  });

  $('#btn-build-qr').addEventListener('click', buildQR);
  $('#btn-copy-links').addEventListener('click', copyLinks);

  $('#btn-print-qr').addEventListener('click', ()=>{
    if(!qrGrid.innerHTML.trim()){
      // build all first if empty
      $('#qrOnlySelected').checked = false;
      buildQR();
    }
    setTimeout(()=>window.print(), 150);
  });

  // rebuild QR when size changes (if already built)
  $('#qrSize').addEventListener('change', ()=>{
    if(qrGrid.innerHTML.trim()) buildQR();
  });
  $('#qrOnlySelected').addEventListener('change', ()=>{
    if(qrGrid.innerHTML.trim()) buildQR();
  });

  // init
  load();
  render();
})();
</script>
</body>
</html>