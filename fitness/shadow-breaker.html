<!-- === /fitness/shadow-breaker.html ===
Shadow Breaker ‚Äî VR Fitness (PC/Mobile)
‚úÖ Normal/Research
‚úÖ Params: pid, diff, time, hub, run=play|research, mode=normal|research, studyId, phase, conditionGroup, log=1
‚úÖ Uses: /fitness/css/shadow-breaker.css
‚úÖ Engine: /fitness/js/engine.js (ESM)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Shadow Breaker ‚Äî VR Fitness</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="./favicon.ico"/>
  <link rel="stylesheet" href="css/shadow-breaker.css"/>
</head>
<body>
  <!-- fatal overlay (‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ error) -->
  <pre id="sb-fatal" style="
    display:none; position:fixed; inset:12px; z-index:999999;
    padding:12px 14px; border-radius:18px;
    background:rgba(2,6,23,.92); border:1px solid rgba(148,163,184,.25);
    color:#e5e7eb; font: 12px/1.35 system-ui; white-space:pre-wrap;"></pre>

  <div id="sb-wrap" class="sb-wrap">
    <!-- ===== Header ===== -->
    <header class="sb-header">
      <div class="sb-header-left">
        <div class="sb-kicker">VR Fitness ‚Ä¢ Boss Targets</div>
        <div class="sb-title">Shadow Breaker</div>
        <div class="sb-sub">‡πÄ‡∏Å‡∏°‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤ Boss ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ü‡∏™ ‚Ä¢ RT/Combo/FEVER/Shield ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Normal/Research</div>
      </div>
      <div class="sb-header-right">
        <div>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: <b>PC</b> ‚Ä¢ <b>Mobile</b></div>
        <div class="sb-tip">‡∏ó‡∏¥‡∏õ: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î Hard ‡∏à‡∏∞ ‚Äú‡πÄ‡∏î‡∏∑‡∏≠‡∏î‚Äù ‡∏°‡∏≤‡∏Å</div>
        <div class="sb-links">
          <a id="sb-link-hub" class="sb-link" href="./hub.html">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Hub</a>
        </div>
      </div>
    </header>

    <main class="sb-main">
      <!-- ===== VIEW: MENU ===== -->
      <section id="sb-view-menu" class="sb-view sb-panel is-active">
        <div class="sb-mode-row" role="tablist" aria-label="Mode">
          <button id="sb-tab-normal" class="sb-mode-btn is-active" type="button">üéÆ Normal</button>
          <button id="sb-tab-research" class="sb-mode-btn" type="button">üìä Research</button>
        </div>

        <div id="sb-mode-desc" class="sb-mode-desc">
          Normal: ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏ô‡∏∏‡∏Å/‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
        </div>

        <div class="sb-form">
          <div class="sb-field">
            <div class="sb-label">Difficulty</div>
            <select id="sb-sel-diff" class="sb-input">
              <option value="easy">Easy</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">Hard</option>
            </select>
          </div>

          <div class="sb-field">
            <div class="sb-label">Time (sec)</div>
            <select id="sb-sel-time" class="sb-input">
              <option value="60">60</option>
              <option value="70" selected>70</option>
              <option value="80">80</option>
              <option value="90">90</option>
            </select>
          </div>

          <!-- Research-only fields -->
          <div id="sb-research-box" class="sb-research-box">
            <div class="sb-field">
              <div class="sb-label">Participant ID</div>
              <input id="sb-inp-pid" class="sb-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô S05-001"/>
            </div>
            <div class="sb-field">
              <div class="sb-label">Group</div>
              <input id="sb-inp-group" class="sb-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Control/Exp-A"/>
            </div>
            <div class="sb-field">
              <div class="sb-label">Note</div>
              <input id="sb-inp-note" class="sb-input" placeholder="‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"/>
            </div>
          </div>

          <div class="sb-ai-box">
            <div class="sb-ai-title">AI (Play only)</div>
            <div class="sb-ai-chips">
              <span class="sb-chip">DL-lite Predictor</span>
              <span class="sb-chip">Explainable micro-tips</span>
              <span class="sb-chip">Pattern Generator</span>
              <span class="sb-chip">Fair adaptive pacing</span>
            </div>
          </div>

          <div class="sb-actions">
            <button id="sb-btn-play" class="sb-btn sb-btn-primary" type="button">‚ñ∂ Start Game</button>
            <button id="sb-btn-research" class="sb-btn" type="button">üìä Start Research</button>
            <button id="sb-btn-howto" class="sb-btn sb-btn-ghost" type="button">‚ùì How to play</button>
          </div>

          <div id="sb-howto" class="sb-howto">
            <ul>
              <li>‡∏ä‡∏Å/‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤ ‚ÄúNormal‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ö‡∏≠‡∏™ + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>
              <li>‡πÄ‡∏õ‡πâ‡∏≤ ‚ÄúDecoy/Bomb‚Äù ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Shield ‡∏à‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)</li>
              <li>‡πÄ‡∏õ‡πâ‡∏≤ ‚ÄúHeal/Shield‚Äù ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î + ‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</li>
              <li>FEVER ‡πÄ‡∏ï‡πá‡∏° ‚Üí ‡∏Ñ‡∏∞‡πÄ‡πÄ‡∏ô‡∏ô/‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ö‡∏≠‡∏™‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏±‡πâ‡∏ô ‡πÜ</li>
              <li>HP ‡∏ö‡∏≠‡∏™‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ‚Üí ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Boss (Boss Face) ‡πÇ‡∏ú‡∏•‡πà 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- ===== VIEW: PLAY ===== -->
      <section id="sb-view-play" class="sb-view sb-play">
        <div class="sb-hud">
          <div class="sb-hud-left">
            <div class="sb-stat"><span class="k">Time</span> <span id="sb-text-time" class="v">0.0 s</span></div>
            <div class="sb-stat"><span class="k">Score</span> <span id="sb-text-score" class="v">0</span></div>
            <div class="sb-stat"><span class="k">Combo</span> <span id="sb-text-combo" class="v">0</span></div>
          </div>

          <div class="sb-hud-center">
            <div id="sb-current-boss-name" class="sb-boss-name">Boss</div>
          </div>

          <div class="sb-hud-right">
            <div class="sb-stat"><span class="k">Phase</span> <span id="sb-text-phase" class="v">1</span></div>
            <div class="sb-stat"><span class="k">Miss</span> <span id="sb-text-miss" class="v">0</span></div>
            <div class="sb-stat"><span class="k">Shield</span> <span id="sb-text-shield" class="v">0</span></div>
          </div>
        </div>

        <!-- top HP bars -->
        <div class="sb-bars sb-bars-top">
          <div class="sb-bar">
            <div class="sb-bar-label">YOU</div>
            <div class="sb-bar-track"><div id="sb-hp-you-top" class="sb-bar-fill"></div></div>
          </div>
          <div class="sb-bar">
            <div class="sb-bar-label">BOSS</div>
            <div class="sb-bar-track"><div id="sb-hp-boss-top" class="sb-bar-fill boss"></div></div>
          </div>
        </div>

        <div class="sb-stage">
          <div id="sb-target-layer" class="sb-target-layer"></div>

          <div class="sb-center-msg">
            <div id="sb-msg-main" class="sb-msg-main">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start!</div>
          </div>

          <div class="sb-meta">
            <div id="sb-meta-emoji" class="sb-meta-emoji">üëä</div>
            <div id="sb-meta-name" class="sb-meta-name">Boss</div>
            <div id="sb-meta-desc" class="sb-meta-desc">‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ</div>
            <div class="sb-meta-row"><span>Phase</span><b id="sb-boss-phase-label">1</b></div>
            <div class="sb-meta-row"><span>Shield</span><b id="sb-boss-shield-label">0</b></div>
          </div>
        </div>

        <!-- bottom bars: fever + compact bars -->
        <div class="sb-bars sb-bars-bottom">
          <div class="sb-fever">
            <div class="sb-fever-head">
              <div><span class="k">FEVER</span> <span id="sb-label-fever" class="v">0%</span></div>
              <label class="sb-toggle"><input id="sb-btn-pause" type="checkbox"/> Pause</label>
            </div>
            <div class="sb-fever-track"><div id="sb-fever-bar" class="sb-fever-fill"></div></div>
          </div>

          <div class="sb-bars-compact">
            <div class="sb-bar">
              <div class="sb-bar-label">YOU</div>
              <div class="sb-bar-track"><div id="sb-hp-you-bottom" class="sb-bar-fill"></div></div>
            </div>
            <div class="sb-bar">
              <div class="sb-bar-label">BOSS</div>
              <div class="sb-bar-track"><div id="sb-hp-boss-bottom" class="sb-bar-fill boss"></div></div>
            </div>
          </div>
        </div>

        <div class="sb-controls">
          <button id="sb-btn-back-menu" class="sb-btn sb-btn-ghost" type="button">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
      </section>

      <!-- ===== VIEW: RESULT ===== -->
      <section id="sb-view-result" class="sb-view sb-panel">
        <h2 class="sb-result-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>

        <div class="sb-result-grid">
          <div class="sb-result-card"><div class="k">Time</div><div id="sb-res-time" class="v">0.0 s</div></div>
          <div class="sb-result-card"><div class="k">Score</div><div id="sb-res-score" class="v">0</div></div>
          <div class="sb-result-card"><div class="k">Max Combo</div><div id="sb-res-max-combo" class="v">0</div></div>
          <div class="sb-result-card"><div class="k">Miss</div><div id="sb-res-miss" class="v">0</div></div>

          <div class="sb-result-card"><div class="k">Phase</div><div id="sb-res-phase" class="v">1</div></div>
          <div class="sb-result-card"><div class="k">Boss Cleared</div><div id="sb-res-boss-cleared" class="v">0</div></div>
          <div class="sb-result-card"><div class="k">Accuracy</div><div id="sb-res-acc" class="v">0%</div></div>
          <div class="sb-result-card"><div class="k">Grade</div><div id="sb-res-grade" class="v">C</div></div>
        </div>

        <div class="sb-result-actions">
          <button id="sb-btn-result-retry" class="sb-btn sb-btn-primary" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button id="sb-btn-result-menu" class="sb-btn" type="button">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
          <button id="sb-btn-download-events" class="sb-btn sb-btn-ghost" type="button">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î events.csv</button>
          <button id="sb-btn-download-session" class="sb-btn sb-btn-ghost" type="button">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î session.csv</button>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    // --- safe boot helpers ---
    const fatalEl = document.getElementById('sb-fatal');
    function fatal(err){
      console.error(err);
      try{
        fatalEl.style.display = 'block';
        fatalEl.textContent = 'Shadow Breaker ‚Äî ERROR\n\n' + String(err?.stack || err?.message || err);
      }catch{}
    }

    // --- apply URL ‚Üí hub link + preset diff/time + auto-run research ---
    try{
      const QS = new URL(location.href).searchParams;
      const hub = QS.get('hub');
      const pid = QS.get('pid') || '';
      const diff = (QS.get('diff') || 'normal').toLowerCase();
      const time = QS.get('time') || '70';

      const run = (QS.get('run') || '').toLowerCase();
      const mode = (QS.get('mode') || '').toLowerCase();

      const linkHub = document.getElementById('sb-link-hub');
      if(hub && linkHub) linkHub.href = hub;

      // presets
      const selDiff = document.getElementById('sb-sel-diff');
      const selTime = document.getElementById('sb-sel-time');
      if(selDiff && ['easy','normal','hard'].includes(diff)) selDiff.value = diff;
      if(selTime && ['60','70','80','90'].includes(String(time))) selTime.value = String(time);

      // pid for research input (optional)
      const inpPid = document.getElementById('sb-inp-pid');
      if(inpPid && pid) inpPid.value = pid;

      // If run=research OR mode=research: switch tab UI + show research box
      const tabN = document.getElementById('sb-tab-normal');
      const tabR = document.getElementById('sb-tab-research');
      const boxR = document.getElementById('sb-research-box');
      const desc = document.getElementById('sb-mode-desc');

      function setTab(which){
        const isR = which === 'research';
        tabN?.classList.toggle('is-active', !isR);
        tabR?.classList.toggle('is-active', isR);
        boxR?.classList.toggle('is-on', isR);
        if(desc){
          desc.textContent = isR
            ? 'Research: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á (‡∏Å‡∏£‡∏≠‡∏Å Participant/Group ‡πÑ‡∏î‡πâ) ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ URL parameters'
            : 'Normal: ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏ô‡∏∏‡∏Å/‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
        }
      }

      tabN?.addEventListener('click', ()=>setTab('normal'));
      tabR?.addEventListener('click', ()=>setTab('research'));

      if(run === 'research' || mode === 'research') setTab('research');

      // load engine
      await import('./js/engine.js');

      // Auto-start research when run=research (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÇ‡∏ú‡∏•‡πà‚Äù ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°)
      if(run === 'research'){
        // engine.js ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏≤ trigger click ‡πÉ‡∏´‡πâ start ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
        const btnR = document.getElementById('sb-btn-research');
        setTimeout(()=>{ try{ btnR?.click(); }catch{} }, 30);
      }

    }catch(e){
      fatal(e);
    }
  </script>
</body>
</html>