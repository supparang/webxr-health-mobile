// === /fitness/js/rb-ai.js ===
// Rhythm Boxer AI (Prediction-only by default)
// ✅ Research mode = locked (predict/show only, no adaptive changes)
// ✅ Normal mode assist can be enabled with ?ai=1 (still prediction-only in this version)
// ✅ Explainable coach tips + rate-limit friendly
'use strict';

(function(){
  const WIN = window;

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function q(name, def=''){
    try{
      const sp = new URL(location.href).searchParams;
      const v = sp.get(name);
      return (v == null || v === '') ? def : v;
    }catch(_){ return def; }
  }

  const MODE_FROM_URL = String(q('mode','')).toLowerCase();   // normal|play|research
  const AI_Q = String(q('ai','0')).toLowerCase();             // 1=on (normal only)
  const FORCE_LOCK = String(q('ailock','')).toLowerCase();    // optional debug

  function isResearchMode(){
    return MODE_FROM_URL === 'research';
  }

  function isLocked(){
    if (FORCE_LOCK === '1' || FORCE_LOCK === 'true') return true;
    return isResearchMode(); // ✅ lock by default in research
  }

  function isAssistEnabled(){
    // current version: prediction only, no adaptive engine changes yet
    // but expose flag for HUD/logging and future hooks
    return !isLocked() && (AI_Q === '1' || AI_Q === 'true' || AI_Q === 'on');
  }

  function predict(snapshot){
    // snapshot:
    // { accPct, hitMiss, hitPerfect, hitGreat, hitGood, combo, offsetAbsMean, hp, songTime, durationSec }

    const accPct = Number(snapshot?.accPct || 0);
    const miss = Number(snapshot?.hitMiss || 0);
    const p = Number(snapshot?.hitPerfect || 0);
    const g = Number(snapshot?.hitGreat || 0);
    const good = Number(snapshot?.hitGood || 0);
    const combo = Number(snapshot?.combo || 0);
    const hp = Number(snapshot?.hp || 100);
    const t = Number(snapshot?.songTime || 0);
    const dur = Math.max(1, Number(snapshot?.durationSec || 60));
    const prog = clamp(t / dur, 0, 1);

    const offsetAbs = Number.isFinite(snapshot?.offsetAbsMean) ? Number(snapshot.offsetAbsMean) : 0.08; // sec
    const judgedHits = p + g + good;
    const quality = judgedHits > 0 ? ((p*1.0 + g*0.75 + good*0.45) / judgedHits) : 0.5;

    // fatigue risk heuristic (0..1)
    let fatigueRisk = 0;
    fatigueRisk += clamp((100 - hp) / 100, 0, 1) * 0.35;
    fatigueRisk += clamp(miss / 20, 0, 1) * 0.20;
    fatigueRisk += clamp((offsetAbs - 0.05) / 0.15, 0, 1) * 0.20;
    fatigueRisk += clamp((prog - 0.55) / 0.45, 0, 1) * 0.15; // late-song fatigue tendency
    fatigueRisk += (combo >= 12 ? 0 : 0.10); // no combo flow → maybe struggling
    fatigueRisk = clamp(fatigueRisk, 0, 1);

    // skill score heuristic (0..1)
    let skillScore = 0;
    skillScore += clamp(accPct / 100, 0, 1) * 0.45;
    skillScore += clamp(quality, 0, 1) * 0.30;
    skillScore += clamp(combo / 30, 0, 1) * 0.15;
    skillScore += (offsetAbs <= 0.06 ? 0.10 : offsetAbs <= 0.09 ? 0.05 : 0);
    skillScore = clamp(skillScore, 0, 1);

    let suggestedDifficulty = 'normal';
    if (skillScore >= 0.78 && fatigueRisk <= 0.45) suggestedDifficulty = 'hard';
    else if (skillScore <= 0.42 || fatigueRisk >= 0.75) suggestedDifficulty = 'easy';

    // explainable coach tip (short, concrete, rate-limited by engine)
    let tip = '';
    if (hp < 35 && miss >= 4) {
      tip = 'ลดแรงกดดันก่อน: เน้นจังหวะหลัก 1-2-3-4 ไม่ต้องรีบตีทุกโน้ต';
    } else if (offsetAbs > 0.10) {
      tip = 'จังหวะยังแกว่ง: โฟกัสตีให้ตรงเส้น hit line มากกว่าตีเร็ว';
    } else if (accPct >= 85 && combo < 8) {
      tip = 'แม่นแล้ว! ลองโฟกัส “รักษาคอมโบ” ด้วยแรงตีสม่ำเสมอ';
    } else if (p < g && g + p > 8) {
      tip = 'ใกล้ Perfect แล้ว: ขยับจังหวะอีกนิดให้ตรง beat มากขึ้น';
    } else if (fatigueRisk > 0.70) {
      tip = 'เริ่มล้า: หายใจยาว 1 จังหวะ แล้วกลับมานับ beat ในใจ';
    } else if (skillScore > 0.80) {
      tip = 'ฟอร์มดีมาก! เตรียมรับแพทเทิร์นสลับซ้าย-ขวาเร็วขึ้น';
    }

    return {
      fatigueRisk: +fatigueRisk.toFixed(3),
      skillScore: +skillScore.toFixed(3),
      suggestedDifficulty,
      tip,
      explain: {
        accPct: +accPct.toFixed(1),
        offsetAbsMeanMs: Math.round(offsetAbs * 1000),
        hp: Math.round(hp),
        combo,
        progressPct: Math.round(prog * 100)
      }
    };
  }

  WIN.RB_AI = {
    predict,
    isLocked,
    isAssistEnabled
  };
})();