// === js/main-shadow.js — Shadow Breaker Page Controller (2025-12-XX) ===
'use strict';

(function () {
  /** สลับ view ระหว่าง menu / play / result */
  function showView(name) {
    const views = document.querySelectorAll('.sb-view');
    views.forEach((v) => v.classList.remove('is-active'));

    const map = {
      menu: document.getElementById('sb-view-menu'),
      play: document.getElementById('sb-view-play'),
      result: document.getElementById('sb-view-result')
    };
    if (map[name]) {
      map[name].classList.add('is-active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  let lastGameMode = 'play'; // 'play' หรือ 'research'

  /** callback จาก engine ตอนจบเกม (ถ้ามีส่งมา) */
  function handleGameEnd(summary) {
    // summary อาจมี { timeSec, score, maxCombo, miss, phase, mode } ฯลฯ
    if (!summary) {
      showView('menu');
      return;
    }

    // อัปเดตสรุปผลแบบง่าย ๆ
    const setText = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(val);
    };

    setText('sb-res-time', (summary.timeSec || 0).toFixed(1) + ' s');
    setText('sb-res-score', summary.score || 0);
    setText('sb-res-max-combo', summary.maxCombo || 0);
    setText('sb-res-miss', summary.miss || 0);
    setText('sb-res-phase', summary.phase || 1);

    showView('result');
  }

  /** เรียกตอนเริ่มเกมจากปุ่มเมนู */
  function startGame(mode) {
    lastGameMode = mode || 'play';

    const diffSel = document.getElementById('sb-diff');
    const timeSel = document.getElementById('sb-time');

    const diff = (diffSel && diffSel.value) || 'normal';
    const timeSec = parseInt((timeSel && timeSel.value) || '60', 10) || 60;

    showView('play');

    if (typeof initShadowBreaker === 'function') {
      // ให้ engine จัดการทุกอย่าง
      initShadowBreaker({
        mode: lastGameMode, // 'play' หรือ 'research'
        diff,
        timeSec,
        onEnd: handleGameEnd
      });
    } else {
      console.warn('[ShadowBreaker] initShadowBreaker() not found');
    }
  }

  /** ทำลาย instance เกมเวลาออกจากหน้าเล่น */
  function destroyGameIfPossible() {
    if (typeof destroyShadowBreaker === 'function') {
      try {
        destroyShadowBreaker();
      } catch (err) {
        console.warn('[ShadowBreaker] destroy error', err);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ปุ่มในเมนู
    const btnPlay = document.getElementById('sb-btn-play');
    const btnResearch = document.getElementById('sb-btn-research');

    btnPlay &&
      btnPlay.addEventListener('click', () => {
        startGame('play');
      });

    btnResearch &&
      btnResearch.addEventListener('click', () => {
        startGame('research');
      });

    // ปุ่มกลับเมนูใน HUD ด้านล่าง
    const btnBackMenu = document.getElementById('sb-btn-back-menu');
    if (btnBackMenu) {
      btnBackMenu.addEventListener('click', () => {
        destroyGameIfPossible();
        showView('menu');
      });
    }

    // ปุ่มจากหน้า result
    const btnResRetry = document.getElementById('sb-btn-result-retry');
    const btnResMenu = document.getElementById('sb-btn-result-menu');

    btnResRetry &&
      btnResRetry.addEventListener('click', () => {
        startGame(lastGameMode || 'play');
      });

    btnResMenu &&
      btnResMenu.addEventListener('click', () => {
        destroyGameIfPossible();
        showView('menu');
      });

    // เริ่มต้นที่หน้าเมนู
    showView('menu');
  });
})();