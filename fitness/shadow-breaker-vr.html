<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VR Fitness ‚Äî Shadow Breaker (VR)</title>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --accent:#38bdf8;
      --accent-hard:#fb923c;
      --accent-easy:#22c55e;
      --hp-player:#22c55e;
      --hp-boss:#f97316;
      --text:#e5e7eb;
      --muted:#9ca3af;
    }

    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;}

    body{
      margin:0;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%,#020617 100%);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== HUD ===== */
    .hud-wrap{
      position:fixed;
      inset:0;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      padding:8px 14px 16px;
      z-index:10;
    }

    .hud-top{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      pointer-events:auto;
    }

    .hud-card{
      background:linear-gradient(135deg,#020617ee,#020617f7);
      border-radius:16px;
      padding:10px 14px;
      box-shadow:0 16px 40px rgba(15,23,42,.6);
      border:1px solid rgba(148,163,184,.25);
      min-width:0;
    }

    .hud-card.small{
      max-width:260px;
    }

    .hud-title{
      font-size:13px;
      font-weight:600;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
    }

    .hud-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      align-items:center;
      font-size:13px;
    }

    .stat-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:2px;
    }
    .stat-value{
      font-size:15px;
      font-weight:600;
    }

    .hp-bar{
      position:relative;
      width:100%;
      height:7px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
      margin-top:4px;
    }
    .hp-fill{
      position:absolute;
      inset:0;
      transform-origin:left center;
      transform:scaleX(1);
      border-radius:inherit;
    }
    .hp-player-fill{
      background:linear-gradient(90deg,#4ade80,#22c55e);
    }
    .hp-boss-fill{
      background:linear-gradient(90deg,#fb923c,#f97316);
    }

    .hud-boss-name{
      font-weight:600;
      font-size:15px;
      margin-bottom:4px;
    }
    .hud-boss-sub{
      font-size:12px;
      color:var(--muted);
    }

    .boss-emoji{
      width:32px;height:32px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      background:radial-gradient(circle at 30% 20%,#fef3c7,#fbbf24);
      box-shadow:0 0 0 2px rgba(253,224,71,.7),0 12px 30px rgba(15,23,42,.9);
      margin-right:10px;
      flex-shrink:0;
    }

    /* meta row (Score / Combo / Time / Phase / Miss / Fever) */
    .hud-meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      font-size:13px;
      margin-top:6px;
    }
    .meta-item{
      display:flex;
      flex-direction:column;
      min-width:70px;
    }

    .fever-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:4px;
    }
    .fever-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      overflow:hidden;
    }
    .fever-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#38bdf8,#a855f7,#f97316);
      transition:width .15s ease-out;
    }
    .fever-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
    }
    .fever-on{
      color:#f97316;
    }

    /* message bottom */
    .hud-bottom{
      margin-top:auto;
      font-size:13px;
      color:#f9fafb;
      text-align:center;
      text-shadow:0 2px 8px rgba(0,0,0,.8);
    }
    .hud-msg{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.75);
      border:1px solid rgba(148,163,184,.55);
      backdrop-filter:blur(12px);
    }

    /* hit / score FX (DOM, ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠) */
    .fx-score{
      position:fixed;
      left:50%;top:50%;
      transform:translate(-50%,-60%);
      font-size:26px;
      font-weight:700;
      pointer-events:none;
      animation:fx-pop .5s ease-out forwards;
      text-shadow:0 0 16px rgba(15,23,42,.9);
      z-index:12;
    }
    .fx-score.good{color:#4ade80;}
    .fx-score.bad{color:#f97316;}
    .fx-score.miss{color:#ef4444;}

    @keyframes fx-pop{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.3);}
      40%{opacity:1;transform:translate(-50%,-56%) scale(1);}
      100%{opacity:0;transform:translate(-50%,-80%) scale(.8);}
    }

    /* ===== Scene sizing ===== */
    a-scene{
      width:100vw;
      height:100vh;
    }

    @media (max-width:768px){
      .hud-top{
        flex-direction:column;
        align-items:stretch;
      }
      .hud-card.small{
        max-width:none;
      }
    }
  </style>
</head>
<body>

<!-- ===== HUD ===== -->
<div class="hud-wrap">
  <div class="hud-top">
    <!-- left: game stats -->
    <div class="hud-card small">
      <div class="hud-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ</div>
      <div class="hud-row">
        <div>
          <div class="stat-label">Score</div>
          <div class="stat-value" id="hud-score">0</div>
        </div>
        <div>
          <div class="stat-label">Combo</div>
          <div class="stat-value" id="hud-combo">0</div>
        </div>
        <div>
          <div class="stat-label">Miss</div>
          <div class="stat-value" id="hud-miss">0</div>
        </div>
      </div>
    </div>

    <!-- center: HP + meta -->
    <div class="hud-card">
      <div class="hud-title">Shadow Breaker ‚Äî VR</div>
      <div class="hud-row">
        <div style="flex:1;min-width:120px">
          <div class="stat-label">PLAYER HP</div>
          <div class="hp-bar">
            <div class="hp-fill hp-player-fill" id="hud-hp-player"></div>
          </div>
        </div>
        <div style="flex:1;min-width:120px">
          <div class="stat-label">BOSS HP</div>
          <div class="hp-bar">
            <div class="hp-fill hp-boss-fill" id="hud-hp-boss"></div>
          </div>
        </div>
      </div>
      <div class="hud-meta-row">
        <div class="meta-item">
          <span class="stat-label">Time</span>
          <span class="stat-value" id="hud-time">60.0 s</span>
        </div>
        <div class="meta-item">
          <span class="stat-label">Phase</span>
          <span class="stat-value" id="hud-phase">1</span>
        </div>
        <div class="meta-item">
          <span class="stat-label">Fever</span>
          <div class="fever-wrap">
            <span id="hud-fever-label" class="fever-label">READY</span>
            <div class="fever-bar">
              <div id="hud-fever-fill" class="fever-fill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- right: boss info -->
    <div class="hud-card small">
      <div class="hud-title">Boss Info</div>
      <div style="display:flex;align-items:center;margin-bottom:4px;">
        <div class="boss-emoji" id="hud-boss-emoji">üê£</div>
        <div>
          <div class="hud-boss-name" id="hud-boss-name">Bubble Glove</div>
          <div class="hud-boss-sub" id="hud-boss-sub">Phase 1 ‚Ä¢ Shield 0</div>
        </div>
      </div>
      <div class="hud-boss-sub" id="hud-boss-hint">
        ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô
      </div>
    </div>
  </div>

  <div class="hud-bottom">
    <div class="hud-msg" id="hud-msg">
      ‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ / ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ üéØ
    </div>
  </div>
</div>

<!-- ===== A-Frame Scene ===== -->
<a-scene renderer="antialias:true" background="color:#020617">
  <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á + cursor -->
  <a-entity id="rig" position="0 1.6 0">
    <a-camera wasd-controls-enabled="false" look-controls="pointerLockEnabled: true">
      <!-- cursor ‡πÅ‡∏ö‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ -->
      <a-cursor
        fuse="false"
        raycaster="objects: .sbvr-target"
        material="color: #f9fafb; shader: flat; opacity: 0.8"
        geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.008">
      </a-cursor>
    </a-camera>
  </a-entity>

  <!-- ‡πÅ‡∏™‡∏á + ‡∏â‡∏≤‡∏Å -->
  <a-entity light="type:ambient;intensity:0.7;color:#ffffff"></a-entity>
  <a-entity light="type:directional;intensity:0.8;color:#ffffff" position="2 4 1"></a-entity>

  <a-sky color="#020617"></a-sky>

  <a-plane rotation="-90 0 0" width="16" height="16" color="#020617"
           material="shader:flat;opacity:0.9;src:#floorTex"></a-plane>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏á ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô arena -->
  <a-box position="0 1.8 -4" depth="0.3" height="4.2" width="7.5"
         color="#020617"
         material="opacity:0.7;transparent:true;shader:standard;metalness:0;roughness:1;">
  </a-box>

  <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤ -->
  <a-entity id="sbvr-target-root" position="0 1.8 -4"></a-entity>

  <!-- texture ‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô (optional) -->
  <a-assets>
  <!-- emoji textures (‡∏ß‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢ canvas) -->
  <canvas id="tex-normal" width="256" height="256"></canvas>
  <canvas id="tex-bomb"   width="256" height="256"></canvas>
  <canvas id="tex-decoy"  width="256" height="256"></canvas>
  <canvas id="tex-heal"   width="256" height="256"></canvas>
  <canvas id="tex-shield" width="256" height="256"></canvas>

  <!-- floor grid -->
  <canvas id="floorTex" width="256" height="256"></canvas>
</a-assets>

</a-scene>

<script>
(function(){
  'use strict';

  // ====== CONFIG ======
  const ROOT_ID = 'sbvr-target-root';   // <a-entity id="sbvr-target-root"></a-entity>
  const SPAWN_INTERVAL_MIN = 700;       // ms
  const SPAWN_INTERVAL_MAX = 1200;
  const TARGET_LIFETIME = 1600;         // ms ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢
  const BASE_SPREAD_X = 1.6;            // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤
  const BASE_SPREAD_Y = 1.1;            // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á

  const EMOJI = {
    normal: 'ü•ä',
    bomb:   'üí£',
    decoy:  'üé≠',
    heal:   'üíä',
    shield: 'üõ°Ô∏è'
  };

  // ring style ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° type
  const RING_MATERIAL = {
    normal: 'color: #22c55e; metalness:0.2; roughness:0.2; emissive:#16a34a; emissiveIntensity:0.5',
    bomb:   'color: #ef4444; metalness:0.4; roughness:0.2; emissive:#b91c1c; emissiveIntensity:0.8',
    decoy:  'color: #f97316; metalness:0.3; roughness:0.3; emissive:#c2410c; emissiveIntensity:0.7',
    heal:   'color: #0ea5e9; metalness:0.3; roughness:0.2; emissive:#0284c7; emissiveIntensity:0.7',
    shield: 'color: #a855f7; metalness:0.4; roughness:0.2; emissive:#7e22ce; emissiveIntensity:0.8'
  };

  // ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏≤‡∏° difficulty / phase (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏ú‡∏π‡∏Å‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
  const SIZE_BY_DIFF_PHASE = (diff, phase) => {
    let base = 0.7; // meter
    if (diff === 'easy') base = 0.9;
    else if (diff === 'hard') base = 0.6;

    if (phase === 2) base *= 0.85;
    if (phase === 3) base *= 0.72;
    return base;
  };

  // ====== RUNTIME STATE ======
  let root = null;
  let running = false;
  let spawnTimer = null;
  let diff = 'normal';
  let phase = 1;
  let hitCount = 0;
  let missCount = 0;

  // HUD
  const hudScore = document.getElementById('hud-score');
  const hudMiss  = document.getElementById('hud-miss');

  function randRange(min, max){
    return min + Math.random() * (max - min);
  }

  function pickType(){
    // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏° type
    const table = [
      { t: 'normal', w: 70 },
      { t: 'bomb',   w: 8  },
      { t: 'decoy',  w: 8  },
      { t: 'heal',   w: 7  },
      { t: 'shield', w: 7  }
    ];
    const sum = table.reduce((a,c)=>a+c.w,0);
    let r = Math.random()*sum;
    for(const it of table){
      if(r < it.w) return it.t;
      r -= it.w;
    }
    return 'normal';
  }

  function updateHud(){
    if(hudScore) hudScore.textContent = hitCount;
    if(hudMiss)  hudMiss.textContent  = missCount;
  }

  // ====== TARGET SPAWN ======
  function spawnOneTarget(){
    if(!root || !running) return;

    const type = pickType();
    const size = SIZE_BY_DIFF_PHASE(diff, phase);

    // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏≠‡∏ö ‡πÜ ‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏≥‡πÅ‡∏û‡∏á arena
    // root ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 0 1.8 -4 ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ z=0 ‡∏Å‡πá‡∏û‡∏≠
    const x = randRange(-BASE_SPREAD_X, BASE_SPREAD_X);
    const y = randRange(-BASE_SPREAD_Y, BASE_SPREAD_Y);
    const z = 0;

    const wrapper = document.createElement('a-entity');
    const id = 'sbvr-target-' + Date.now() + '-' + Math.floor(Math.random()*9999);
    wrapper.setAttribute('id', id);
    wrapper.setAttribute('class', 'sbvr-target');
    wrapper.setAttribute('position', `${x} ${y} ${z}`);

    // ‡∏ß‡∏á ring
    const ring = document.createElement('a-entity');
    ring.setAttribute(
      'geometry',
      `primitive: torus; radius: ${size*0.55}; radiusTubular: ${size*0.12}`
    );
    ring.setAttribute(
      'material',
      RING_MATERIAL[type] || RING_MATERIAL.normal
    );
    ring.setAttribute('animation__spin',
      'property: rotation; to: 0 360 0; dur: 1400; loop: true; easing: linear'
    );

    // ‡πÅ‡∏ú‡πà‡∏ô emoji ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (‡πÉ‡∏ä‡πâ text component ‡πÅ‡∏ö‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    const face = document.createElement('a-entity');
    face.setAttribute(
      'text',
      `value: ${EMOJI[type] || EMOJI.normal}; align: center; color: #ffffff; width: ${size*3}`
    );
    face.setAttribute('position', '0 0 0.01');
    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ look-at ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á error component ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°

    wrapper.appendChild(ring);
    wrapper.appendChild(face);

    // interaction (click / cursor ‚Äì ‡∏ú‡πà‡∏≤‡∏ô raycaster ‡∏Ç‡∏≠‡∏á <a-cursor>)
    const clicked = (evt) => {
      if(!running) return;
      evt.stopPropagation();
      if (wrapper.parentNode === root) {
        root.removeChild(wrapper);
      }
      hitCount++;
      updateHud();
      console.log('[SBVR] hit', type);
      // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á event ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ engine ‡∏´‡∏•‡∏±‡∏Å:
      // window.dispatchEvent(new CustomEvent('sbvr-hit',{detail:{type}}));
    };
    wrapper.addEventListener('click', clicked);

    root.appendChild(wrapper);

    // ‡∏ï‡∏±‡πâ‡∏á timeout ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÄ‡∏≠‡∏á ‚Üí ‡∏ô‡∏±‡∏ö miss ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ normal
    setTimeout(() => {
      if(!wrapper.parentNode) return;
      try { root.removeChild(wrapper); } catch(e){}
      if(type === 'normal'){
        missCount++;
        updateHud();
        console.log('[SBVR] miss (timeout normal)');
      }
    }, TARGET_LIFETIME);
  }

  function scheduleNextSpawn(){
    if(!running) return;
    const delay = randRange(SPAWN_INTERVAL_MIN, SPAWN_INTERVAL_MAX);
    spawnTimer = setTimeout(() => {
      if(!running) return;
      spawnOneTarget();
      scheduleNextSpawn();
    }, delay);
  }

  function startGame(){
    root = document.getElementById(ROOT_ID);
    if(!root){
      console.warn('[ShadowBreaker VR] ‡πÑ‡∏°‡πà‡∏û‡∏ö #' + ROOT_ID + ' ‡πÉ‡∏ô scene');
      return;
    }
    running   = true;
    hitCount  = 0;
    missCount = 0;
    updateHud();
    scheduleNextSpawn();
    console.log('[ShadowBreaker VR] startGame OK, root=', root);
  }

  function stopGame(){
    running = false;
    if(spawnTimer){
      clearTimeout(spawnTimer);
      spawnTimer = null;
    }
  }

  // ====== BOOT ======
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  if(document.readyState === 'loading'){
    window.addEventListener('load', startGame, {once:true});
  }else{
    startGame();
  }

  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ debug ‡∏à‡∏≤‡∏Å console
  window.SBVR = {
    start: startGame,
    stop:  stopGame,
    setDiff(d){ diff = d || 'normal'; },
    setPhase(p){ phase = p || 1; }
  };
})();
</script>
</body>
</html>
