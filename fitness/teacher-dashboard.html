// === /fitness/teacher-dashboard.js ===
// Teacher Dashboard (local) â€” v20260211g
// âœ… Summary CSV: includes schoolName/siteCode/classRoom/teacherId/deviceType
// âœ… Events CSV: includes same meta columns
// âœ… Archive & Clear downloads filtered CSVs with same headers
(function(){
  'use strict';
  const WIN = window, DOC = document;
  if(!DOC) return;
  const $ = (s)=>DOC.querySelector(s);

  // buttons
  const btnRefresh = $('#td-refresh');
  const btnCopySum = $('#td-copy-sum');
  const btnDLSum   = $('#td-dl-sum');
  const btnCopyEvt = $('#td-copy-evt');
  const btnDLEvt   = $('#td-dl-evt');
  const btnArchiveClear = $('#td-archive-clear');

  // table
  const body = $('#td-body');
  const msg  = $('#td-msg');

  // basic filters (table)
  const fPid = $('#f-pid');
  const fGame = $('#f-game');
  const fPhase = $('#f-phase');
  const fGroup = $('#f-group');
  const fSort = $('#f-sort');
  const fLimit = $('#f-limit');

  // export filters (apply to BOTH)
  const xStudy = $('#x-study');
  const xFrom  = $('#x-from');
  const xTo    = $('#x-to');
  const xToday = $('#x-today');
  const xOnlyFiltered = $('#x-onlyfiltered');
  const xClear = $('#x-clear');

  const STORE_SUM = 'HHA_FITNESS_SUMMARY_LOG_V1';
  const STORE_EVT = 'HHA_FITNESS_EVENTS_LOG_V1';

  const ARCHIVE_KEY = 'HHA_ARCHIVE_INDEX_V1';
  const ARCHIVE_PREFIX = 'HHA_ARCHIVE_';

  function setMsg(t){ if(msg) msg.textContent = t || ''; }

  function readJSON(key, fallback){
    try{ const v = JSON.parse(localStorage.getItem(key) || 'null'); return (v==null ? fallback : v); }
    catch{ return fallback; }
  }

  function readSummary(){
    const a = readJSON(STORE_SUM, []);
    return Array.isArray(a) ? a : [];
  }
  function readEvents(){
    const a = readJSON(STORE_EVT, []);
    return Array.isArray(a) ? a : [];
  }

  function fmtTime(ts){
    if(!ts) return '-';
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const mo = String(d.getMonth()+1).padStart(2,'0');
    return `${dd}/${mo} ${hh}:${mm}:${ss}`;
  }
  function fmtMs(ms){
    if(!ms) return '-';
    const s = Math.round(ms/1000);
    if(s<60) return `${s}s`;
    const m = Math.floor(s/60), r = s%60;
    return `${m}m ${r}s`;
  }

  function esc(v){
    const s = String(v ?? '');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }

  function stamp(){
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = DOC.createElement('a');
    a.href = url;
    a.download = filename;
    DOC.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyText(text, okMsg){
    try{
      await navigator.clipboard.writeText(text);
      setMsg(okMsg);
    }catch(e){
      try{ WIN.prompt('Copy:', text); }catch(_){}
      setMsg('à¹€à¸›à¸´à¸”à¸à¸¥à¹ˆà¸­à¸‡à¹ƒà¸«à¹‰à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¹‰à¸§');
    }
  }

  // -------- filters --------
  function applyBasicFilters(rows){
    const pid = (fPid?.value || '').trim().toUpperCase();
    const game = (fGame?.value || '').trim();
    const phase = (fPhase?.value || '').trim();
    const group = (fGroup?.value || '').trim().toUpperCase();

    let out = rows.slice();
    if(pid) out = out.filter(r => String(r.pid||'').toUpperCase().includes(pid));
    if(game) out = out.filter(r => String(r.game||'') === game);
    if(phase) out = out.filter(r => String(r.phase||'') === phase);
    if(group) out = out.filter(r => String(r.conditionGroup||'') === group);

    const sort = fSort?.value || 'ts_desc';
    out.sort((a,b)=>{
      if(sort==='pid_asc') return String(a.pid||'').localeCompare(String(b.pid||''));
      if(sort==='score_desc') return (Number(b.score||0)-Number(a.score||0));
      if(sort==='ms_desc') return (Number(b.ms||0)-Number(a.ms||0));
      return (Number(b.ts||0)-Number(a.ts||0));
    });

    const lim = Number(fLimit?.value || 0);
    if(Number.isFinite(lim) && lim>0) out = out.slice(0, lim);

    return out;
  }

  function parseYMD(s){
    const m = String(s||'').trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    if(!y || !mo || !d) return null;
    const dt = new Date(y, mo-1, d, 0, 0, 0, 0);
    return Number.isFinite(dt.getTime()) ? dt.getTime() : null;
  }

  function getExportWindowMs(){
    if(xToday?.checked){
      const d = new Date();
      const t0 = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0).getTime();
      const t1 = t0 + 24*3600*1000;
      return { t0, t1 };
    }
    const t0 = parseYMD(xFrom?.value);
    const t1raw = parseYMD(xTo?.value);
    const t1 = (t1raw != null) ? (t1raw + 24*3600*1000) : null;
    return { t0, t1 };
  }

  function applyExportFilters(rows, alsoApplyBasic){
    let out = rows.slice();

    const { t0, t1 } = getExportWindowMs();
    if(t0 != null) out = out.filter(r => Number(r.ts||0) >= t0);
    if(t1 != null) out = out.filter(r => Number(r.ts||0) < t1);

    const study = (xStudy?.value || '').trim();
    if(study) out = out.filter(r => String(r.studyId||'').trim() === study);

    if(alsoApplyBasic){
      const pid = (fPid?.value || '').trim().toUpperCase();
      const game = (fGame?.value || '').trim();
      const phase = (fPhase?.value || '').trim();
      const group = (fGroup?.value || '').trim().toUpperCase();

      if(pid) out = out.filter(r => String(r.pid||'').toUpperCase().includes(pid));
      if(game) out = out.filter(r => String(r.game||'') === game);
      if(phase) out = out.filter(r => String(r.phase||'') === phase);
      if(group) out = out.filter(r => String(r.conditionGroup||'') === group);
    }

    return out;
  }

  // -------- CSV builders --------
  function summaryCSV(rows){
    const header = [
      'ts','pid','studyId','phase','conditionGroup',
      'schoolName','siteCode','classRoom','teacherId','deviceType',
      'game','score','pass','total','maxStreak','ms','seed'
    ];
    const lines = [header.join(',')];
    for(const r of rows){
      const vals = [
        r.ts, r.pid, r.studyId, r.phase, r.conditionGroup,
        r.schoolName||'', r.siteCode||'', r.classRoom||'', r.teacherId||'', r.deviceType||'',
        r.game, r.score, r.pass, r.total, r.maxStreak, r.ms, r.seed
      ].map(esc);
      lines.push(vals.join(','));
    }
    return lines.join('\n');
  }

  function eventsCSV(rows){
    const header = [
      'ts','sid','pid','studyId','phase','conditionGroup',
      'schoolName','siteCode','classRoom','teacherId','deviceType',
      'game','mode','view','seed','type','data_json'
    ];
    const lines = [header.join(',')];
    for(const r of rows){
      const dataJson = JSON.stringify(r.data || {});
      const vals = [
        r.ts, r.sid, r.pid, r.studyId, r.phase, r.conditionGroup,
        r.schoolName||'', r.siteCode||'', r.classRoom||'', r.teacherId||'', r.deviceType||'',
        r.game, r.mode, r.view, r.seed, r.type, dataJson
      ].map(esc);
      lines.push(vals.join(','));
    }
    return lines.join('\n');
  }

  // -------- UI render --------
  function pill(text, cls=''){
    return `<span class="pill ${cls}">${text}</span>`;
  }

  function render(){
    const rows = applyBasicFilters(readSummary());
    if(!body) return;

    body.innerHTML = rows.map(r=>{
      const ratio = `${r.pass||0}/${r.total||0}`;
      const ok = (r.total>0) ? ((r.pass/r.total)>=0.6) : true;
      const cls = ok ? 'ok' : 'warn';
      return `
        <tr>
          <td>${fmtTime(r.ts)}</td>
          <td>${pill(r.pid || '-', cls)}</td>
          <td>${r.studyId || '-'}</td>
          <td>${r.phase || '-'}</td>
          <td>${r.conditionGroup || '-'}</td>
          <td>${r.game || '-'}</td>
          <td>${r.score ?? 0}</td>
          <td>${ratio}</td>
          <td>${r.maxStreak ?? 0}</td>
          <td>${fmtMs(r.ms)}</td>
          <td>${r.seed ?? 0}</td>
        </tr>
      `;
    }).join('');

    const allSum = readSummary().length;
    const allEvt = readEvents().length;
    setMsg(`Table: ${rows.length} à¹à¸–à¸§ | Summary (${allSum}) | Events (${allEvt}) | CSV has school/site/class/teacher/deviceType`);
  }

  // -------- export actions --------
  function getExportRows(){
    const alsoBasic = !!xOnlyFiltered?.checked;
    const sum = applyExportFilters(readSummary(), alsoBasic);
    const evt = applyExportFilters(readEvents(), alsoBasic);
    return { sum, evt, alsoBasic };
  }

  function exportSummaryCopy(){
    const { sum } = getExportRows();
    copyText(summaryCSV(sum), `ðŸ“‹ à¸„à¸±à¸”à¸¥à¸­à¸ Summary CSV (filtered: ${sum.length}) à¹à¸¥à¹‰à¸§`);
  }
  function exportSummaryDownload(){
    const { sum } = getExportRows();
    downloadText(`fitness_summary_${stamp()}.csv`, summaryCSV(sum));
    setMsg(`â¬‡ï¸ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Summary CSV (filtered: ${sum.length}) à¹à¸¥à¹‰à¸§`);
  }
  function exportEventsCopy(){
    const { evt } = getExportRows();
    copyText(eventsCSV(evt), `ðŸ“‹ à¸„à¸±à¸”à¸¥à¸­à¸ Events CSV (filtered: ${evt.length}) à¹à¸¥à¹‰à¸§`);
  }
  function exportEventsDownload(){
    const { evt } = getExportRows();
    downloadText(`fitness_events_${stamp()}.csv`, eventsCSV(evt));
    setMsg(`â¬‡ï¸ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Events CSV (filtered: ${evt.length}) à¹à¸¥à¹‰à¸§`);
  }

  // -------- archive & clear --------
  function archiveId(){
    return `${stamp()}_${Math.floor(Math.random()*1e6)}`;
  }

  function pushArchiveIndex(id){
    const idx = readJSON('HHA_ARCHIVE_INDEX_V1', []);
    const arr = Array.isArray(idx) ? idx : [];
    arr.unshift({ id, ts: Date.now() });
    localStorage.setItem('HHA_ARCHIVE_INDEX_V1', JSON.stringify(arr.slice(0,30)));
  }

  function archiveAndClear(){
    const { sum, evt } = getExportRows();
    if(sum.length===0 && evt.length===0){
      setMsg('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸¡à¸•à¸±à¸§à¸à¸£à¸­à¸‡à¹ƒà¸«à¹‰ archive');
      return;
    }

    const id = archiveId();
    const archiveObj = {
      id,
      ts: Date.now(),
      note: 'Archive & Clear from teacher dashboard',
      filters: {
        xStudy: (xStudy?.value||'').trim(),
        xFrom: (xFrom?.value||'').trim(),
        xTo: (xTo?.value||'').trim(),
        xToday: !!xToday?.checked,
        xOnlyFiltered: !!xOnlyFiltered?.checked,
        pid: (fPid?.value||'').trim(),
        game: (fGame?.value||'').trim(),
        phase: (fPhase?.value||'').trim(),
        group: (fGroup?.value||'').trim(),
      },
      summary: sum,
      events: evt
    };

    // download first (safe)
    downloadText(`ARCHIVE_${id}_summary.csv`, summaryCSV(sum));
    downloadText(`ARCHIVE_${id}_events.csv`, eventsCSV(evt));

    // store snapshot
    try{
      localStorage.setItem(ARCHIVE_PREFIX + id, JSON.stringify(archiveObj));
      pushArchiveIndex(id);
    }catch(e){}

    const clearAll = confirm(
      `à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¹à¸¥à¹‰à¸§ âœ…\n\nà¸à¸” OK à¹€à¸žà¸·à¹ˆà¸­à¸¥à¹‰à¸²à¸‡ "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”" à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸™à¸µà¹‰\nà¸à¸” Cancel à¹€à¸žà¸·à¹ˆà¸­à¸¥à¹‰à¸²à¸‡ "à¹€à¸‰à¸žà¸²à¸°à¸—à¸µà¹ˆ match à¸•à¸±à¸§à¸à¸£à¸­à¸‡ export"`
    );

    if(clearAll){
      localStorage.removeItem(STORE_SUM);
      localStorage.removeItem(STORE_EVT);
      setMsg(`Archive ${id} à¹à¸¥à¹‰à¸§ | à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡`);
      render();
      return;
    }

    const alsoBasic = !!xOnlyFiltered?.checked;
    const sumAll = readSummary();
    const evtAll = readEvents();

    const sumKeep = sumAll.filter(r => !applyExportFilters([r], alsoBasic).length);
    const evtKeep = evtAll.filter(r => !applyExportFilters([r], alsoBasic).length);

    localStorage.setItem(STORE_SUM, JSON.stringify(sumKeep));
    localStorage.setItem(STORE_EVT, JSON.stringify(evtKeep));

    setMsg(`Archive ${id} à¹à¸¥à¹‰à¸§ | à¸¥à¹‰à¸²à¸‡à¹€à¸‰à¸žà¸²à¸°à¸Šà¸¸à¸”à¸•à¸²à¸¡à¸•à¸±à¸§à¸à¸£à¸­à¸‡ (sum-${sum.length}, evt-${evt.length})`);
    render();
  }

  // -------- bind UI --------
  btnRefresh?.addEventListener('click', render);

  btnCopySum?.addEventListener('click', exportSummaryCopy);
  btnDLSum?.addEventListener('click', exportSummaryDownload);
  btnCopyEvt?.addEventListener('click', exportEventsCopy);
  btnDLEvt?.addEventListener('click', exportEventsDownload);

  btnArchiveClear?.addEventListener('click', ()=>{
    if(!confirm('Archive & Clear à¸ˆà¸°à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” 2 à¹„à¸Ÿà¸¥à¹Œ (summary+events) à¹à¸¥à¹‰à¸§à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸\n\nà¸—à¸³à¸•à¹ˆà¸­à¹„à¸«à¸¡?')) return;
    archiveAndClear();
  });

  ;[fPid,fGame,fPhase,fGroup,fSort,fLimit].forEach(el=>{
    el?.addEventListener('input', render);
    el?.addEventListener('change', render);
  });

  function pingExport(){
    const { sum, evt } = getExportRows();
    setMsg(`Export ready | summary:${sum.length} events:${evt.length} | CSV meta: school/site/class/teacher/deviceType`);
  }
  ;[xStudy,xFrom,xTo,xToday,xOnlyFiltered].forEach(el=>{
    el?.addEventListener('input', pingExport);
    el?.addEventListener('change', pingExport);
  });

  xClear?.addEventListener('click', ()=>{
    if(xStudy) xStudy.value = '';
    if(xFrom) xFrom.value = '';
    if(xTo) xTo.value = '';
    if(xToday) xToday.checked = false;
    if(xOnlyFiltered) xOnlyFiltered.checked = true;
    pingExport();
  });

  render();
  pingExport();
})();