<!-- === /herohealth/vr-clean/home-clean.html ===
Clean Objects (Evaluate → Create) — RUN PAGE — v20260228-FULL
A: PC/Mobile Evaluate (fallback time=45, sprays=3)
B: cVR Create (fallback time=60, maxPoints=5)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth — Clean Objects</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{
      color-scheme: dark;
      --bg:#050814;
      --panel: rgba(2,6,23,.72);
      --panel2: rgba(2,6,23,.55);
      --line: rgba(148,163,184,.18);
      --txt: rgba(229,231,235,.94);
      --mut: rgba(148,163,184,.92);

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 800px at 20% 0%, rgba(99,102,241,.18), transparent 55%),
      radial-gradient(900px 700px at 90% 20%, rgba(34,211,238,.14), transparent 60%),
      radial-gradient(700px 500px at 40% 100%, rgba(244,114,182,.10), transparent 55%),
      var(--bg);
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}

    /* --- from previous run page (UI layout) --- */
    .cleanApp{
      height:100%;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      padding: calc(10px + var(--sat)) calc(10px + var(--sar)) calc(10px + var(--sab)) calc(10px + var(--sal));
    }
    .hud{
      grid-column: 1 / -1;
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    .hudRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      font-weight: 900;
      letter-spacing:.02em;
      font-size: 12px;
      opacity:.95;
    }
    .board{
      grid-column: 1 / 2;
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: 18px;
      position:relative;
      overflow:hidden;
      min-height: 360px;
    }
    .grid{
      position:absolute; inset: 10px;
      border-radius: 16px;
      background: rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.12);
      overflow:hidden;
    }
    .overlay{ position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; padding: 12px; }
    .ovHint{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.60);
      border-radius: 16px;
      padding: 10px 12px;
      max-width: 520px;
      text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .ovT{ font-weight: 1000; }
    .ovS{ font-size: 12px; opacity:.85; margin-top:4px; }

    .info{
      grid-column: 2 / 3;
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: 18px;
      padding: 12px;
      overflow:auto;
      min-height: 360px;
    }
    .routePanel{
      grid-column: 1 / -1;
      border:1px solid var(--line);
      background: rgba(2,6,23,.50);
      border-radius: 18px;
      padding: 10px 12px;
      max-height: 220px;
      overflow:auto;
    }

    /* --- POLISH PACK: heat overlay, bars, coach toast --- */
    .heatLayer{ position:absolute; inset:0; pointer-events:none; }
    .heat{
      position:absolute;
      border-radius: 999px;
      filter: blur(1px);
      transform: translateZ(0);
      animation: heatPulse 1.8s ease-in-out infinite;
    }
    .heat.hot{ background: radial-gradient(circle, rgba(239,68,68,.55), rgba(239,68,68,0) 70%); }
    .heat.warm{ background: radial-gradient(circle, rgba(251,191,36,.50), rgba(251,191,36,0) 70%); }
    .heat.cool{ background: radial-gradient(circle, rgba(34,197,94,.35), rgba(34,197,94,0) 70%); }
    @keyframes heatPulse{ 0%,100%{ transform: scale(0.95);} 50%{ transform: scale(1.08);} }

    .bars{ margin-top: 10px; display:flex; flex-direction:column; gap:8px; }
    .barRow{ display:grid; grid-template-columns: 78px 1fr 46px; gap:8px; align-items:center; }
    .barLab{ font-size:12px; opacity:.85; font-weight:900; }
    .barTrack{ height:10px; border-radius:999px; background: rgba(148,163,184,.12); overflow:hidden; border:1px solid rgba(148,163,184,.14); }
    .barFill{ height:100%; background: rgba(59,130,246,.40); border-right:1px solid rgba(59,130,246,.50); }
    .barVal{ font-size:12px; opacity:.85; text-align:right; font-weight:900; }

    .coachToast{
      position: fixed;
      left: 50%;
      bottom: calc(14px + var(--sab));
      transform: translateX(-50%);
      z-index: 120;
      pointer-events: none;
    }
    .ctInner{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.78);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }

    @media (max-width: 980px){
      .cleanApp{ grid-template-columns: 1fr; grid-template-rows: auto 1fr auto auto; }
      .board{ grid-column: 1 / -1; min-height: 340px; }
      .info{ grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { createCleanCore } from './clean.core.js';
    import { mountCleanUI } from './clean.ui.js';
    import { saveSummary } from '../analytics/summary-store.js';

    // Optional: if you want universal VR UI on this run page, uncomment:
    // import '../vr/vr-ui.js';

    const root = document.getElementById('app');

    // UI first (needs core ref)
    let core = null;
    const ui = mountCleanUI(root, {
      snapshot: ()=> core ? core.snapshot() : null,
      toggleRouteB: (id)=> core && core.toggleRouteB(id),
      selectA: (id, reason)=> core && core.selectA(id, reason),
      undoB: ()=> core && core.undoB(),
      clearB: ()=> core && core.clearB(),
      submitB: ()=> core && core.submitB(),
      cfg: null
    });

    core = createCleanCore({}, {
      onState: (S)=> ui.onState(S),
      onTick: (S,dt)=> ui.onTick(S,dt),
      onCoach: (msg)=> ui.onCoach(msg),
      onSummary: (payload)=> {
        try{ saveSummary(payload); }catch(e){}
        ui.onSummary(payload);
      }
    });

    // patch ui core reference
    ui && (ui.core = core);

    core.start();

    function loop(){
      core.tick();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // --- flush-hardened (safe no-op if HHA.flush missing)
    function safeFlush(tag){
      try{
        if(window.HHA && typeof window.HHA.flush === 'function'){
          window.HHA.flush({ reason: tag || 'pagehide', game:'cleanobjects' });
        }
      }catch(e){}
    }
    window.addEventListener('pagehide', ()=> safeFlush('pagehide'));
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'hidden') safeFlush('hidden');
    });
    window.addEventListener('beforeunload', ()=> safeFlush('beforeunload'));

    // --- Backbutton guard (confirm)
    (function(){
      let armed = false;
      function arm(){
        if(armed) return;
        armed = true;
        try{ history.pushState({hha_guard:1}, '', location.href); }catch(e){}
      }
      arm();

      window.addEventListener('popstate', ()=>{
        // if ended, allow back normally
        try{
          const snap = core.snapshot();
          if(snap && snap.ended) return;
        }catch(_){}

        const ok = confirm('ออกจากเกมตอนนี้? ระบบจะพยายามบันทึกข้อมูลก่อนกลับ HUB');
        if(ok){
          safeFlush('back');
          const hub = new URL(location.href).searchParams.get('hub');
          if(hub) location.href = hub;
          else history.back();
        }else{
          // re-arm
          armed = false;
          arm();
        }
      });
    })();
  </script>
</body>
</html>