<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Ä¢ Clean Objects (Home)</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e8eefc; --mut:#9fb0d0; --card:#121b2f; --bd:#243455;
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --ok:#1f8b4c; --warn:#c7a100; --bad:#c54848;
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #app{ position:fixed; inset:0; padding-top:var(--safeT); padding-bottom:var(--safeB); overflow:hidden; }

    /* shared HUD */
    .hud{ position:fixed; left:12px; right:12px; top:calc(12px + var(--safeT)); display:flex; gap:10px; z-index:30; flex-wrap:wrap; }
    .hud .box{ flex:1; min-width:140px; background:rgba(18,27,47,.86); border:1px solid var(--bd); border-radius:14px; padding:10px 12px; }
    .hud .t{ font-size:12px; color:var(--mut); }
    .hud .v{ font-size:16px; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* A renderer container */
    #mapRoot{ position:absolute; inset:0; display:none; }
    .toolbar{
      position:fixed; left:12px; right:12px;
      top:calc(64px + var(--safeT));
      display:flex; gap:8px; z-index:25; flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--bd);
      background:#1a2a4a; color:var(--fg);
      padding:10px 12px; border-radius:12px;
      font-weight:900; cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background:transparent; }
    .btn.danger{ background:#3a1a22; }
    .btn.good{ background:#183a2a; }

    /* grid map layout */
    .mapStage{
      position:absolute; left:12px; right:12px;
      top:calc(114px + var(--safeT));
      bottom:calc(12px + var(--safeB));
      display:grid; gap:10px;
      grid-template-columns: 1.1fr 0.9fr;
      grid-template-rows: 1fr 1fr 1fr;
    }
    .zone{
      background:rgba(18,27,47,.55);
      border:1px solid var(--bd);
      border-radius:18px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
      overflow:hidden;
    }
    .zone.isNext{ outline:2px solid rgba(160,200,255,.45); }
    .zone h3{ margin:0; font-size:14px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
    .zone .sub{ margin:0; color:var(--mut); font-size:12px; }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .chip{
      font-size:11px; color:var(--mut);
      border:1px dashed var(--bd);
      padding:5px 8px; border-radius:999px;
      user-select:none;
    }
    .hotlist{
      display:flex; flex-direction:column; gap:8px;
      overflow:auto; padding-right:4px;
    }
    .hot{
      background:rgba(11,18,32,.55);
      border:1px solid var(--bd);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }
    .hot:active{ transform: translateY(1px); }
    .hot.sel{ outline:2px solid rgba(160,200,255,.45); }
    .hot .name{ font-weight:900; font-size:13px; }
    .meta{ color:var(--mut); font-size:11px; margin-top:3px; line-height:1.25; }
    .right{ margin-left:auto; text-align:right; }
    .value{ font-weight:900; font-size:13px; }
    .stars{ font-size:11px; color:var(--mut); margin-top:3px; }

    /* zone placement */
    #zoneEntry{ grid-column:1; grid-row:1; }
    #zoneLiving{ grid-column:1; grid-row:2; }
    #zoneKitchen{ grid-column:1; grid-row:3; }
    #zoneBath{ grid-column:2; grid-row:1 / span 2; }
    #zoneBed{ grid-column:2; grid-row:3; }

    /* bottom action drawer */
    .drawer{
      position:fixed; left:12px; right:12px;
      bottom:calc(12px + var(--safeB));
      z-index:40;
      background:rgba(18,27,47,.92);
      border:1px solid var(--bd);
      border-radius:18px;
      padding:12px;
      display:none;
    }
    .drawer.on{ display:block; }
    .dTitle{ font-weight:1000; font-size:14px; margin:0 0 4px; }
    .dSub{ margin:0 0 10px; color:var(--mut); font-size:12px; line-height:1.35; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      font-size:11px; border:1px solid var(--bd);
      padding:5px 8px; border-radius:999px; color:var(--mut);
    }
    .btnWide{ flex:1; min-width:150px; }
    .mini{ font-size:11px; color:var(--mut); margin-top:10px; line-height:1.35; }

    /* modal */
    .modalMask{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      z-index:80; display:none; align-items:center; justify-content:center;
      padding:18px 12px;
    }
    .modalMask.on{ display:flex; }
    .modal{
      width:min(780px, 100%);
      max-height:calc(100vh - 24px);
      overflow:auto;
      background:rgba(18,27,47,.96);
      border:1px solid var(--bd);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .mHead{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .mTitle{ margin:0; font-size:15px; font-weight:1000; }
    .mSub{ margin:4px 0 0; color:var(--mut); font-size:12px; line-height:1.35; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .tab{ padding:8px 10px; border:1px solid var(--bd); border-radius:999px; background:transparent; color:var(--fg); font-weight:900; cursor:pointer; }
    .tab.on{ background:#1a2a4a; }
    .panel{ display:none; }
    .panel.on{ display:block; }

    /* wipe mini-action */
    .wipeBox{
      margin-top:12px;
      border:1px solid var(--bd);
      border-radius:16px;
      background:rgba(11,18,32,.55);
      padding:12px;
    }
    .gridWipe{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      user-select:none;
      touch-action:none;
    }
    .cell{
      aspect-ratio: 1 / 1;
      border:1px solid var(--bd);
      border-radius:12px;
      background:rgba(18,27,47,.55);
      position:relative;
      overflow:hidden;
    }
    .cell.on{
      background:rgba(31,139,76,.25);
      border-color:rgba(31,139,76,.55);
    }
    .cell.on::after{
      content:'';
      position:absolute; inset:-20%;
      background: radial-gradient(circle at 30% 30%, rgba(140,220,180,.45), rgba(31,139,76,.08));
      transform: rotate(12deg);
    }
    .progressLine{
      height:10px; border:1px solid var(--bd); border-radius:999px; overflow:hidden; background:rgba(11,18,32,.55);
      margin-top:10px;
    }
    .progressFill{
      height:100%; width:0%;
      background:rgba(160,200,255,.55);
    }

    /* plan lists */
    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:720px){ .twoCol{ grid-template-columns: 1fr; } }
    .list{
      border:1px solid var(--bd);
      border-radius:16px;
      background:rgba(11,18,32,.45);
      padding:10px;
    }
    .list h4{ margin:0 0 8px; font-size:13px; }
    .item{
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--bd);
      border-radius:14px;
      padding:8px 10px;
      margin-bottom:8px;
      background:rgba(18,27,47,.55);
    }
    .item .nm{ font-weight:900; font-size:12px; }
    .item .sm{ color:var(--mut); font-size:11px; }
    .item .sp{ margin-left:auto; display:flex; gap:6px; }
    .tinyBtn{ padding:6px 8px; border-radius:10px; font-weight:900; border:1px solid var(--bd); background:transparent; color:var(--fg); cursor:pointer; }
    .tinyBtn:active{ transform: translateY(1px); }
    .selTag{ font-size:11px; color:rgba(160,200,255,.95); }

    /* B renderer container */
    #vrRoot{ position:absolute; inset:0; display:none; }
    .overlayNote{
      position:fixed; left:12px; right:12px;
      bottom:calc(12px + var(--safeB));
      z-index:30;
      background:rgba(11,18,32,.75);
      border:1px solid var(--bd);
      border-radius:14px;
      padding:10px 12px;
      color:var(--mut);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- Shared HUD -->
  <div class="hud" id="hud">
    <div class="box"><div class="t">TIME</div><div class="v" id="hudTime">--</div></div>
    <div class="box"><div class="t">SPRAY</div><div class="v" id="hudSpray">--</div></div>
    <div class="box"><div class="t">CLOTH</div><div class="v" id="hudCloth">--</div></div>
    <div class="box"><div class="t">PLAN</div><div class="v" id="hudPlan">OFF</div></div>
  </div>

  <!-- A) Map renderer -->
  <div id="mapRoot">
    <div class="toolbar">
      <button class="btn" id="btnSort">Sort by Value</button>
      <button class="btn" id="btnPlan">Plan Builder</button>
      <button class="btn good" id="btnRunPlan" title="‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ">Run Plan</button>
      <button class="btn ghost" id="btnBack">Back HUB</button>
      <button class="btn ghost" id="btnResetPlan" title="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ">Reset Plan</button>
    </div>

    <div class="mapStage" id="mapStage">
      <section class="zone" id="zoneEntry">
        <div>
          <h3><span id="zMark_entry">Entry</span></h3>
          <p class="sub">‡∏à‡∏∏‡∏î‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</p>
          <div class="chips"><span class="chip">Bottleneck</span><span class="chip">Touch ‡∏™‡∏π‡∏á</span></div>
        </div>
        <div class="hotlist" data-zone="entry"></div>
      </section>

      <section class="zone" id="zoneLiving">
        <div>
          <h3><span id="zMark_living">Living Room</span></h3>
          <p class="sub">‡∏£‡∏µ‡πÇ‡∏°‡∏ó/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏•‡∏≤‡∏á</p>
          <div class="chips"><span class="chip">Shared</span><span class="chip">‡πÄ‡∏£‡πá‡∏ß</span></div>
        </div>
        <div class="hotlist" data-zone="living"></div>
      </section>

      <section class="zone" id="zoneKitchen">
        <div>
          <h3><span id="zMark_kitchen">Kitchen</span></h3>
          <p class="sub">‡∏ó‡∏≥‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô</p>
          <div class="chips"><span class="chip">Food</span><span class="chip">Cost ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</span></div>
        </div>
        <div class="hotlist" data-zone="kitchen"></div>
      </section>

      <section class="zone" id="zoneBath">
        <div>
          <h3><span id="zMark_bath">Bathroom</span></h3>
          <p class="sub">Spread ‡∏™‡∏π‡∏á (‡∏Ñ‡∏±‡∏ô‡∏ä‡∏±‡∏Å/‡∏Å‡πä‡∏≠‡∏Å/‡∏ó‡∏µ‡πà‡∏Å‡∏î)</p>
          <div class="chips"><span class="chip">Spread ‡∏™‡∏π‡∏á</span><span class="chip">Priority</span></div>
        </div>
        <div class="hotlist" data-zone="bath"></div>
      </section>

      <section class="zone" id="zoneBed">
        <div>
          <h3><span id="zMark_bed">Bedroom</span></h3>
          <p class="sub">‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á‡∏õ‡πà‡∏ß‡∏¢</p>
          <div class="chips"><span class="chip">Routine</span><span class="chip">Light</span></div>
        </div>
        <div class="hotlist" data-zone="bed"></div>
      </section>
    </div>

    <!-- Action drawer (selected hotspot) -->
    <div class="drawer" id="drawer">
      <div class="dTitle" id="dTitle">--</div>
      <div class="dSub" id="dSub">--</div>
      <div class="row" style="margin-bottom:10px;">
        <span class="badge" id="bTouch">Touch: -</span>
        <span class="badge" id="bSpread">Spread: -</span>
        <span class="badge" id="bCost">Cost: -</span>
        <span class="badge" id="bValue">Value: -</span>
        <span class="badge" id="bPlan">Plan: -</span>
      </div>
      <div class="row">
        <button class="btn btnWide" id="btnClean">CLEAN (wipe)</button>
        <button class="btn btnWide ghost" id="btnClose">Close</button>
      </div>
      <div class="mini">
        Mini-action: ‡∏•‡∏≤‡∏Å‡∏ñ‡∏π‡πÉ‡∏ô‡∏Å‡∏£‡∏¥‡∏î 4√ó4 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° ‚Üí ‡πÑ‡∏î‡πâ coverage% ‚Üí ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∏‡πâ‡∏° (Evaluate)
      </div>
    </div>
  </div>

  <!-- B) WebXR renderer -->
  <div id="vrRoot">
    <div class="overlayNote">
      B Mode (Cardboard): ‡πÉ‡∏ä‡πâ crosshair + tap-to-shoot ‡∏ú‡πà‡∏≤‡∏ô <b>/herohealth/vr/vr-ui.js</b> (event: <code>hha:shoot</code>)<br/>
      ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô skeleton ‚Äî ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏™‡πà hotspot glow + clean progress ‡πÉ‡∏ô 3D
    </div>
    <div id="vrStage" style="position:absolute; inset:0;"></div>
  </div>
</div>

<!-- WIPE MODAL -->
<div class="modalMask" id="wipeMask" aria-hidden="true">
  <div class="modal">
    <div class="mHead">
      <div>
        <h3 class="mTitle" id="wipeTitle">Wipe</h3>
        <p class="mSub" id="wipeSub">‡∏•‡∏≤‡∏Å‡∏ñ‡∏π‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° coverage</p>
      </div>
      <button class="btn ghost" id="wipeClose">Close</button>
    </div>

    <div class="wipeBox">
      <div class="gridWipe" id="wipeGrid"></div>
      <div class="progressLine"><div class="progressFill" id="wipeFill"></div></div>
      <div class="row" style="margin-top:10px;">
        <span class="badge" id="wipeCov">Coverage: 0%</span>
        <span class="badge" id="wipeSpend">Cost: -</span>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn btnWide good" id="wipeDone">DONE</button>
        <button class="btn btnWide danger" id="wipeReset">RESET</button>
      </div>
      <div class="mini">
        Tip: ‡∏¢‡∏¥‡πà‡∏á coverage ‡∏™‡∏π‡∏á ‚Üí ‡∏¢‡∏¥‡πà‡∏á‡∏•‡∏î risk ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏° Cost
      </div>
    </div>
  </div>
</div>

<!-- PLAN MODAL -->
<div class="modalMask" id="planMask" aria-hidden="true">
  <div class="modal">
    <div class="mHead">
      <div>
        <h3 class="mTitle">Plan Builder (Create)</h3>
        <p class="mSub">‡∏™‡∏£‡πâ‡∏≤‡∏á Checklist + Routine + Route ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Use Plan ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏° ‚Äú‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‚Äù ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
      </div>
      <button class="btn ghost" id="planClose">Close</button>
    </div>

    <div class="tabs">
      <button class="tab on" data-tab="chk">Checklist</button>
      <button class="tab" data-tab="rt">Routine</button>
      <button class="tab" data-tab="route">Route</button>
    </div>

    <div class="panel on" id="panel_chk">
      <div class="twoCol">
        <div class="list">
          <h4>All Hotspots</h4>
          <div id="allList"></div>
        </div>
        <div class="list">
          <h4>My Checklist (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‚â• 6 ‡∏à‡∏∏‡∏î)</h4>
          <div id="selList"></div>
          <div class="row">
            <button class="btn btnWide good" id="btnUsePlan">Use Plan</button>
            <button class="btn btnWide" id="btnSavePlan">Save</button>
          </div>
          <div class="mini" id="planHint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        </div>
      </div>
    </div>

    <div class="panel" id="panel_rt">
      <div class="twoCol">
        <div class="list">
          <h4>Morning üåû</h4>
          <div id="rt_morning"></div>
        </div>
        <div class="list">
          <h4>After Home üè†</h4>
          <div id="rt_afterhome"></div>
        </div>
      </div>
      <div class="list" style="margin-top:12px;">
        <h4>Before Bed üåô</h4>
        <div id="rt_bed"></div>
        <div class="mini">‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô: ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î</div>
      </div>
    </div>

    <div class="panel" id="panel_route">
      <div class="list">
        <h4>Route Order (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏ã‡∏ô)</h4>
        <div id="routeList"></div>
        <div class="row">
          <button class="btn btnWide good" id="btnApplyRoute">Apply Route</button>
          <button class="btn btnWide" id="btnAutoRoute">Auto (value)</button>
        </div>
        <div class="mini">Run Plan ‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå ‚Äú‡πÇ‡∏ã‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
'use strict';

const qs = (k, d='') => { try{ const u=new URL(location.href); return u.searchParams.get(k) ?? d; }catch(e){ return d; } };
const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));
const isCVR = String(qs('view','')).toLowerCase() === 'cvr';

const P = {
  view: String(qs('view','')).toLowerCase(),
  run:  String(qs('run','play')).toLowerCase(),
  diff: String(qs('diff','normal')).toLowerCase(),
  time: clamp(Number(qs('time','90')), 20, 300),
  seed: String(qs('seed', String(Date.now()))),
  pid:  String(qs('pid','anon')),
  hub:  String(qs('hub','/herohealth/hub.html')),
  ai:   Number(qs('ai','0'))||0,
  debug:Number(qs('debug','0'))||0,
  api:  String(qs('api',''))
};

// ---------------------- DATA ----------------------
const HOT = [
  { id:'door_knob', zone:'entry',  name:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤',  touch:9, spread:8, cost:3, note:'‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô' },
  { id:'light_switch', zone:'entry',name:'‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏ü',         touch:8, spread:5, cost:1, note:'‡∏Ñ‡∏∏‡πâ‡∏°‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ cost ‡∏ï‡πà‡∏≥' },

  { id:'tv_remote', zone:'living',  name:'‡∏£‡∏µ‡πÇ‡∏°‡∏ó‡∏ó‡∏µ‡∏ß‡∏µ',         touch:7, spread:6, cost:2, note:'‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ö‡πâ‡∏≤‡∏ô' },
  { id:'phone', zone:'living',      name:'‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï',    touch:8, spread:7, cost:2, note:'‡∏à‡∏±‡∏ö‡∏ö‡πà‡∏≠‡∏¢ + ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏ô‡πâ‡∏≤' },
  { id:'drawer_handle', zone:'living', name:'‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å/‡∏ï‡∏π‡πâ', touch:6, spread:6, cost:2, note:'‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏•‡∏∑‡∏°' },

  { id:'fridge_handle', zone:'kitchen', name:'‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô', touch:7, spread:7, cost:3, note:'‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ = ‡∏à‡∏±‡∏ö‡∏ö‡πà‡∏≠‡∏¢' },
  { id:'kitchen_faucet', zone:'kitchen',name:'‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏Ñ‡∏£‡∏±‡∏ß',   touch:6, spread:6, cost:2, note:'‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å/‡∏•‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏≤‡∏∞‡πÑ‡∏î‡πâ' },
  { id:'counter_board', zone:'kitchen', name:'‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏á', touch:6, spread:8, cost:4, note:'‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£' },

  { id:'bath_door', zone:'bath',    name:'‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', touch:6, spread:7, cost:2, note:'‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' },
  { id:'soap_pump', zone:'bath',    name:'‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏™‡∏ö‡∏π‡πà/‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥',  touch:6, spread:7, cost:2, note:'‡πÅ‡∏ï‡∏∞‡∏ã‡πâ‡∏≥ ‡πÜ' },
  { id:'flush', zone:'bath',        name:'‡∏Ñ‡∏±‡∏ô‡∏ä‡∏±‡∏Å/‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏±‡∏Å‡πÇ‡∏Ñ‡∏£‡∏Å', touch:5, spread:9, cost:3, note:'Spread ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å' },

  { id:'bed_door', zone:'bed',      name:'‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô', touch:5, spread:5, cost:2, note:'‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' },
];

const ZONES = [
  { id:'entry',  label:'Entry', el:'zoneEntry' },
  { id:'living', label:'Living', el:'zoneLiving' },
  { id:'kitchen',label:'Kitchen',el:'zoneKitchen' },
  { id:'bath',   label:'Bath', el:'zoneBath' },
  { id:'bed',    label:'Bed', el:'zoneBed' },
];

// ---------------------- STATE ----------------------
const S = {
  timeLeft: P.time,
  spray: 100,
  cloth: 3,

  selectedId: null,
  cleaned: new Map(), // id -> coverage (0..1)

  // plan
  planEnabled: false,
  plan: {
    checklist: [],            // hotspot ids
    routine: { morning:[], afterhome:[], bed:[] }, // hotspot ids
    route: ['entry','living','kitchen','bath','bed'],
  },
  planRun: {
    active: false,
    routeIndex: 0,
  },

  // wipe session
  wipe: {
    id: null,
    cellsOn: new Set(),
    dragging: false,
  }
};

const PLAN_KEY = `HHA_CLEAN_PLAN_HOME::${P.pid}`;

// ---------------------- UTILS ----------------------
const $ = (id)=>document.getElementById(id);
const byId = (id)=> HOT.find(x=>x.id===id);
const valueOf = (h)=> (h.touch * h.spread) / Math.max(1, h.cost);
const fmt = (n)=> (Math.round(n*10)/10).toFixed(1);
const pct = (x)=> Math.round(clamp(x,0,1)*100);

function toast(msg){
  const d = document.createElement('div');
  d.textContent = msg;
  d.style.position='fixed';
  d.style.left='12px'; d.style.right='12px';
  d.style.bottom='12px';
  d.style.zIndex='9999';
  d.style.padding='10px 12px';
  d.style.border='1px solid var(--bd)';
  d.style.borderRadius='14px';
  d.style.background='rgba(18,27,47,.92)';
  d.style.color='var(--fg)';
  document.body.appendChild(d);
  setTimeout(()=>{ d.remove(); }, 1500);
}

// ---------------------- HUD ----------------------
function renderHUD(){
  $('hudTime').textContent  = S.timeLeft + 's';
  $('hudSpray').textContent = String(S.spray);
  $('hudCloth').textContent = String(S.cloth);
  $('hudPlan').textContent  = S.planEnabled ? (S.planRun.active ? 'RUN' : 'ON') : 'OFF';
}
renderHUD();

// ---------------------- MODE MOUNT ----------------------
const mapRoot = $('mapRoot');
const vrRoot  = $('vrRoot');

if (isCVR){
  vrRoot.style.display = 'block';
  mapRoot.style.display = 'none';
  await bootVR();
} else {
  mapRoot.style.display = 'block';
  vrRoot.style.display = 'none';
  bootMap();
}

// ---------------------- MAP MODE ----------------------
function bootMap(){
  // load saved plan if exists
  loadPlanIfAny();

  $('btnSort').onclick = ()=> {
    HOT.sort((a,b)=> valueOf(b)-valueOf(a));
    renderZones();
    toast('Sorted by Value ‚úÖ');
  };

  $('btnPlan').onclick = ()=> openPlan();
  $('btnRunPlan').onclick = ()=> toggleRunPlan();
  $('btnResetPlan').onclick = ()=> resetPlan();
  $('btnBack').onclick = ()=> goHub();

  $('btnClose').onclick = closeDrawer;
  $('btnClean').onclick = ()=> openWipeForSelected();

  renderZones();
  updateNextZoneHighlight();
}

function renderZones(){
  // clear
  document.querySelectorAll('.hotlist').forEach(el=> el.innerHTML='');

  // index by zone
  const byZone = new Map();
  for(const h of HOT){
    if(!byZone.has(h.zone)) byZone.set(h.zone, []);
    byZone.get(h.zone).push(h);
  }

  // optional: in plan-run, order items by checklist + next zone
  const checklistSet = new Set(S.plan.checklist);
  const nextZone = (S.planRun.active) ? S.plan.route[S.planRun.routeIndex] : null;

  for(const el of document.querySelectorAll('.hotlist')){
    const zone = el.getAttribute('data-zone');
    let arr = (byZone.get(zone) || []).slice();

    // if plan-run active: push selected checklist items up
    if(S.planRun.active){
      arr.sort((a,b)=>{
        const aa = checklistSet.has(a.id) ? 0 : 1;
        const bb = checklistSet.has(b.id) ? 0 : 1;
        if(aa!==bb) return aa-bb;
        // within group: higher value first
        return valueOf(b)-valueOf(a);
      });
    }

    for(const h of arr){
      const card = document.createElement('div');
      const cov = S.cleaned.get(h.id) || 0;
      const cleaned = cov >= 0.7;
      const val = valueOf(h);

      const inPlan = checklistSet.has(h.id);
      const planTag = inPlan ? ' <span class="selTag">‚Ä¢ PLAN</span>' : '';
      const covTag  = cov>0 ? ` ‚Ä¢ ${pct(cov)}%` : '';

      card.className = 'hot' + (S.selectedId===h.id ? ' sel':'');

      card.innerHTML = `
        <div>
          <div class="name">${cleaned ? '‚úÖ ' : ''}${h.name}${planTag}</div>
          <div class="meta">${h.note}${covTag}</div>
        </div>
        <div class="right">
          <div class="value">${fmt(val)}</div>
          <div class="stars">T${h.touch} ‚Ä¢ S${h.spread} ‚Ä¢ C${h.cost}</div>
        </div>
      `;
      card.onclick = ()=> openDrawer(h.id);
      el.appendChild(card);
    }

    // zone highlight for plan-run
    const zoneEl = zoneToEl(zone);
    if(zoneEl){
      zoneEl.classList.toggle('isNext', !!nextZone && nextZone===zone);
    }
  }
}

function zoneToEl(zoneId){
  const z = ZONES.find(z=>z.id===zoneId);
  return z ? $(z.el) : null;
}

function openDrawer(id){
  S.selectedId = id;
  const h = byId(id);
  if(!h) return;

  $('drawer').classList.add('on');
  const cov = S.cleaned.get(id) || 0;
  const cleaned = cov >= 0.7;

  $('dTitle').textContent = (cleaned ? '‚úÖ ' : '') + h.name;
  $('dSub').textContent = cleaned
    ? `‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß (coverage ${pct(cov)}%). ‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£`
    : `‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡πâ‡∏°: Value=${fmt(valueOf(h))} (Touch√óSpread/Cost)`;

  $('bTouch').textContent = 'Touch: ' + h.touch;
  $('bSpread').textContent = 'Spread: ' + h.spread;
  $('bCost').textContent = 'Cost: ' + h.cost;
  $('bValue').textContent = 'Value: ' + fmt(valueOf(h));
  $('bPlan').textContent  = 'Plan: ' + (S.plan.checklist.includes(id) ? 'YES' : 'NO');

  renderZones();
}

function closeDrawer(){
  $('drawer').classList.remove('on');
}

function canSpend(timeNeed, sprayNeed, clothNeed){
  if(S.timeLeft < timeNeed){ toast('‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠ ‚è≥'); return false; }
  if(S.spray < sprayNeed){ toast('‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠ üß¥'); return false; }
  if(S.cloth < clothNeed){ toast('‡∏ú‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠ üßª'); return false; }
  return true;
}

// ---------------------- WIPE MINI-ACTION (A) ----------------------
const wipeMask = $('wipeMask');
const wipeGrid = $('wipeGrid');
const wipeFill = $('wipeFill');
const wipeCov  = $('wipeCov');
const wipeSpend= $('wipeSpend');

$('wipeClose').onclick = closeWipe;
$('wipeReset').onclick = resetWipe;
$('wipeDone').onclick = finishWipe;

function openWipeForSelected(){
  const id = S.selectedId;
  const h = byId(id);
  if(!h) return;

  S.wipe.id = id;
  S.wipe.cellsOn.clear();

  $('wipeTitle').textContent = `Wipe: ${h.name}`;
  $('wipeSub').textContent = '‡∏•‡∏≤‡∏Å‡∏ñ‡∏π‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 70% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏∞‡∏≠‡∏≤‡∏î)';

  buildWipeGrid();
  updateWipeUI();

  wipeMask.classList.add('on');
  wipeMask.setAttribute('aria-hidden','false');
}

function closeWipe(){
  wipeMask.classList.remove('on');
  wipeMask.setAttribute('aria-hidden','true');
  S.wipe.dragging = false;
}

function resetWipe(){
  S.wipe.cellsOn.clear();
  updateWipeUI();
  // clear cell class
  wipeGrid.querySelectorAll('.cell').forEach(c=> c.classList.remove('on'));
}

function buildWipeGrid(){
  wipeGrid.innerHTML = '';
  for(let i=0;i<16;i++){
    const c = document.createElement('div');
    c.className = 'cell';
    c.dataset.idx = String(i);

    const markOn = ()=> {
      S.wipe.cellsOn.add(i);
      c.classList.add('on');
      updateWipeUI();
    };

    c.addEventListener('pointerdown', (ev)=>{
      ev.preventDefault();
      S.wipe.dragging = true;
      c.setPointerCapture(ev.pointerId);
      markOn();
    });
    c.addEventListener('pointerenter', (ev)=>{
      if(!S.wipe.dragging) return;
      markOn();
    });
    c.addEventListener('pointerup', ()=>{
      S.wipe.dragging = false;
    });
    c.addEventListener('pointercancel', ()=>{
      S.wipe.dragging = false;
    });

    wipeGrid.appendChild(c);
  }

  // release dragging if pointer leaves modal
  wipeMask.addEventListener('pointerup', ()=>{ S.wipe.dragging=false; }, { once:true });
}

function currentCoverage(){
  return S.wipe.cellsOn.size / 16;
}

function spendForWipe(h, cov){
  // base spend from cost
  // timeNeed scales slightly with cov, sprayNeed scales with cost, clothNeed for high spread
  const baseTime = 3 * h.cost;
  const timeNeed = Math.max(1, Math.round(baseTime * (0.7 + 0.6*cov))); // 0.7..1.3x
  const sprayNeed = Math.round(10 * h.cost * (0.6 + 0.8*cov));         // 0.6..1.4x
  const clothNeed = (h.spread >= 8 && cov >= 0.7) ? 1 : 0;             // only when "really cleaned" on high spread
  return { timeNeed, sprayNeed, clothNeed };
}

function updateWipeUI(){
  const id = S.wipe.id;
  const h = byId(id);
  const cov = currentCoverage();
  const { timeNeed, sprayNeed, clothNeed } = spendForWipe(h, cov);

  wipeFill.style.width = pct(cov) + '%';
  wipeCov.textContent = `Coverage: ${pct(cov)}%`;
  wipeSpend.textContent = `Spend: -${timeNeed}s / -${sprayNeed}spray ${clothNeed?'/ -1cloth':''}`;
}

function finishWipe(){
  const id = S.wipe.id;
  const h = byId(id);
  if(!h) return;

  const cov = currentCoverage();
  const { timeNeed, sprayNeed, clothNeed } = spendForWipe(h, cov);

  if(!canSpend(timeNeed, sprayNeed, clothNeed)) return;

  // spend
  S.timeLeft -= timeNeed;
  S.spray -= sprayNeed;
  S.cloth -= clothNeed;

  // save best coverage
  const prev = S.cleaned.get(id) || 0;
  const best = Math.max(prev, cov);
  S.cleaned.set(id, best);

  renderHUD();
  renderZones();
  openDrawer(id);

  // if plan-run active, advance when cleaned enough
  if(S.planRun.active && best >= 0.7){
    advancePlanIfNeeded(h.zone, id);
  }

  toast(best >= 0.7 ? `Cleaned ‚úÖ (${pct(best)}%)` : `Partial wipe‚Ä¶ (${pct(best)}%)`);
  closeWipe();
}

// ---------------------- PLAN BUILDER (B) ----------------------
const planMask = $('planMask');
$('planClose').onclick = closePlan;
$('btnUsePlan').onclick = ()=> { usePlan(); savePlan(); };
$('btnSavePlan').onclick = savePlan;
$('btnApplyRoute').onclick = ()=> { toast('Route applied ‚úÖ'); savePlan(); updateNextZoneHighlight(); renderZones(); };
$('btnAutoRoute').onclick = ()=> { autoRouteByValue(); renderRoute(); toast('Auto route ‚úÖ'); };

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    const key = t.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
    $('panel_'+key).classList.add('on');
  };
});

function openPlan(){
  planMask.classList.add('on');
  planMask.setAttribute('aria-hidden','false');
  renderPlanAll();
}

function closePlan(){
  planMask.classList.remove('on');
  planMask.setAttribute('aria-hidden','true');
}

function renderPlanAll(){
  renderChecklistLists();
  autoSuggestRoutineIfEmpty();
  renderRoutineLists();
  renderRoute();
  renderPlanHint();
}

function renderPlanHint(){
  const n = S.plan.checklist.length;
  const ok = n >= 6;
  $('planHint').textContent = ok
    ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${n} ‡∏à‡∏∏‡∏î ‚úÖ`
    : `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${n} ‡∏à‡∏∏‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏à‡∏∏‡∏î)`;
}

function renderChecklistLists(){
  const all = $('allList'); all.innerHTML='';
  const sel = $('selList'); sel.innerHTML='';

  const selSet = new Set(S.plan.checklist);

  // sort all by zone then value
  const arrAll = HOT.slice().sort((a,b)=>{
    if(a.zone!==b.zone) return a.zone.localeCompare(b.zone);
    return valueOf(b)-valueOf(a);
  });

  for(const h of arrAll){
    const isSel = selSet.has(h.id);
    all.appendChild(planItem(h, isSel, ()=>{
      if(isSel) return;
      S.plan.checklist.push(h.id);
      renderChecklistLists();
      renderPlanHint();
      renderZones();
    }, 'ADD'));
  }

  const arrSel = S.plan.checklist.map(id=>byId(id)).filter(Boolean);
  for(const h of arrSel){
    sel.appendChild(planItem(h, true, ()=>{
      S.plan.checklist = S.plan.checklist.filter(x=>x!==h.id);
      // also remove from routine buckets
      for(const k of ['morning','afterhome','bed']){
        S.plan.routine[k] = S.plan.routine[k].filter(x=>x!==h.id);
      }
      renderPlanAll();
      renderZones();
    }, 'DEL'));
  }
}

function planItem(h, isSel, onClick, label){
  const div = document.createElement('div');
  div.className = 'item';
  const val = fmt(valueOf(h));
  div.innerHTML = `
    <div>
      <div class="nm">${h.name} ${isSel?'<span class="selTag">‚Ä¢ selected</span>':''}</div>
      <div class="sm">${h.zone.toUpperCase()} ‚Ä¢ Value ${val} ‚Ä¢ T${h.touch} S${h.spread} C${h.cost}</div>
    </div>
    <div class="sp">
      <button class="tinyBtn">${label}</button>
    </div>
  `;
  div.querySelector('button').onclick = onClick;
  return div;
}

function autoSuggestRoutineIfEmpty(){
  // only suggest if routine empty
  const total = S.plan.routine.morning.length + S.plan.routine.afterhome.length + S.plan.routine.bed.length;
  if(total>0) return;

  // simple heuristics:
  // afterhome: entry + phone
  // morning: kitchen_faucet + counter_board
  // bed: tv_remote + bed_door
  const pick = (id)=> S.plan.checklist.includes(id) ? id : null;

  const after = [pick('door_knob'), pick('light_switch'), pick('phone'), pick('fridge_handle')].filter(Boolean);
  const morn  = [pick('kitchen_faucet'), pick('counter_board')].filter(Boolean);
  const bed   = [pick('tv_remote'), pick('bed_door')].filter(Boolean);

  S.plan.routine.afterhome = after;
  S.plan.routine.morning = morn;
  S.plan.routine.bed = bed;
}

function renderRoutineLists(){
  const buckets = [
    ['morning','rt_morning'],
    ['afterhome','rt_afterhome'],
    ['bed','rt_bed'],
  ];
  for(const [k, elId] of buckets){
    const el = $(elId);
    el.innerHTML='';
    const arr = S.plan.routine[k].map(id=>byId(id)).filter(Boolean);

    if(!arr.length){
      const p = document.createElement('div');
      p.style.color='var(--mut)';
      p.style.fontSize='12px';
      p.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Checklist ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î + ‡πÉ‡∏™‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)';
      el.appendChild(p);
    }

    for(const h of arr){
      const it = document.createElement('div');
      it.className = 'item';
      it.innerHTML = `
        <div>
          <div class="nm">${h.name}</div>
          <div class="sm">${h.zone.toUpperCase()} ‚Ä¢ Value ${fmt(valueOf(h))}</div>
        </div>
        <div class="sp">
          <button class="tinyBtn" data-m="up">‚Üë</button>
          <button class="tinyBtn" data-m="dn">‚Üì</button>
          <button class="tinyBtn" data-m="rm">DEL</button>
        </div>
      `;
      const btns = it.querySelectorAll('button');
      btns.forEach(b=>{
        b.onclick = ()=>{
          const mode = b.dataset.m;
          const ids = S.plan.routine[k];
          const idx = ids.indexOf(h.id);
          if(idx<0) return;

          if(mode==='rm'){ ids.splice(idx,1); }
          if(mode==='up' && idx>0){ [ids[idx-1], ids[idx]] = [ids[idx], ids[idx-1]]; }
          if(mode==='dn' && idx<ids.length-1){ [ids[idx+1], ids[idx]] = [ids[idx], ids[idx+1]]; }

          renderRoutineLists();
          savePlan();
        };
      });

      el.appendChild(it);
    }

    // quick add buttons from checklist (small)
    const addWrap = document.createElement('div');
    addWrap.style.marginTop='10px';
    addWrap.style.display='flex';
    addWrap.style.flexWrap='wrap';
    addWrap.style.gap='6px';
    for(const id of S.plan.checklist){
      if(S.plan.routine[k].includes(id)) continue;
      const h = byId(id);
      if(!h) continue;
      const b = document.createElement('button');
      b.className='tinyBtn';
      b.textContent = '+ ' + h.name;
      b.onclick = ()=> { S.plan.routine[k].push(id); renderRoutineLists(); savePlan(); };
      addWrap.appendChild(b);
    }
    el.appendChild(addWrap);
  }
}

function renderRoute(){
  const el = $('routeList');
  el.innerHTML = '';
  for(const zoneId of S.plan.route){
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>
        <div class="nm">${zoneId.toUpperCase()}</div>
        <div class="sm">‡πÇ‡∏ã‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ Run Plan</div>
      </div>
      <div class="sp">
        <button class="tinyBtn" data-m="up">‚Üë</button>
        <button class="tinyBtn" data-m="dn">‚Üì</button>
      </div>
    `;
    const btnUp = row.querySelector('button[data-m="up"]');
    const btnDn = row.querySelector('button[data-m="dn"]');
    btnUp.onclick = ()=>{
      const i = S.plan.route.indexOf(zoneId);
      if(i>0){ [S.plan.route[i-1], S.plan.route[i]] = [S.plan.route[i], S.plan.route[i-1]]; renderRoute(); updateNextZoneHighlight(); savePlan(); }
    };
    btnDn.onclick = ()=>{
      const i = S.plan.route.indexOf(zoneId);
      if(i<S.plan.route.length-1){ [S.plan.route[i+1], S.plan.route[i]] = [S.plan.route[i], S.plan.route[i+1]]; renderRoute(); updateNextZoneHighlight(); savePlan(); }
    };
    el.appendChild(row);
  }
}

function autoRouteByValue(){
  // zone score = sum(value) of checklist items
  const zoneScore = {};
  for(const z of S.plan.route) zoneScore[z] = 0;
  for(const id of S.plan.checklist){
    const h = byId(id);
    if(!h) continue;
    zoneScore[h.zone] += valueOf(h);
  }
  S.plan.route.sort((a,b)=> (zoneScore[b]||0) - (zoneScore[a]||0));
}

// enable plan (Create -> use)
function usePlan(){
  if(S.plan.checklist.length < 6){
    toast('Checklist ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏à‡∏∏‡∏î ‚ùó');
    return;
  }
  S.planEnabled = true;
  S.planRun.active = false;
  S.planRun.routeIndex = 0;
  renderHUD();
  updateNextZoneHighlight();
  renderZones();
  toast('Plan ON ‚úÖ');
}

// Run plan: highlight zone order & ‚Äúadvance‚Äù when zone tasks done
function toggleRunPlan(){
  if(!S.planEnabled){
    toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Use Plan');
    return;
  }
  S.planRun.active = !S.planRun.active;
  if(S.planRun.active){
    S.planRun.routeIndex = 0;
    toast('Run Plan ‚ñ∂Ô∏è');
  } else {
    toast('Run Plan OFF');
  }
  renderHUD();
  updateNextZoneHighlight();
  renderZones();
}

// advance: when current zone has no remaining checklist items to clean
function advancePlanIfNeeded(zoneId, cleanedId){
  if(!S.planRun.active) return;
  const currentZone = S.plan.route[S.planRun.routeIndex];
  if(zoneId !== currentZone) return;

  // remaining in zone?
  const remaining = S.plan.checklist
    .map(id=>byId(id))
    .filter(h=>h && h.zone===currentZone)
    .filter(h=>{
      const cov = S.cleaned.get(h.id) || 0;
      return cov < 0.7;
    });

  if(remaining.length===0){
    S.planRun.routeIndex = Math.min(S.planRun.routeIndex+1, S.plan.route.length-1);
    updateNextZoneHighlight();
    renderZones();
    toast('Next zone ‚ûú ' + S.plan.route[S.planRun.routeIndex].toUpperCase());
  }
}

function updateNextZoneHighlight(){
  // handled in renderZones via class; but ensure no stale
  for(const z of ZONES){
    const el = $(z.el);
    if(el) el.classList.remove('isNext');
  }
  if(S.planRun.active){
    const next = S.plan.route[S.planRun.routeIndex];
    const el = zoneToEl(next);
    if(el) el.classList.add('isNext');
  }
}

function savePlan(){
  try{
    const payload = {
      enabled: S.planEnabled,
      plan: S.plan,
    };
    localStorage.setItem(PLAN_KEY, JSON.stringify(payload));
    toast('Saved ‚úÖ');
    renderHUD();
  }catch(e){
    toast('Save failed');
  }
}

function loadPlanIfAny(){
  try{
    const raw = localStorage.getItem(PLAN_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    if(d && d.plan){
      // shallow validate
      S.plan = d.plan;
      S.planEnabled = !!d.enabled;
      S.planRun.active = false;
      S.planRun.routeIndex = 0;
      renderHUD();
      toast('Loaded plan ‚úÖ');
    }
  }catch(e){}
}

function resetPlan(){
  S.planEnabled = false;
  S.planRun.active = false;
  S.planRun.routeIndex = 0;
  S.plan = {
    checklist: [],
    routine: { morning:[], afterhome:[], bed:[] },
    route: ['entry','living','kitchen','bath','bed'],
  };
  try{ localStorage.removeItem(PLAN_KEY); }catch(e){}
  renderHUD();
  updateNextZoneHighlight();
  renderZones();
  toast('Plan reset');
}

// ---------------------- HUB NAV ----------------------
function goHub(){
  const u = new URL(P.hub, location.href);
  u.searchParams.set('from', 'clean-home');
  u.searchParams.set('pid', P.pid);
  u.searchParams.set('seed', P.seed);
  location.href = u.toString();
}

// ---------------------- VR MODE (B skeleton) ----------------------
async function bootVR(){
  try{
    await import('../vr/vr-ui.js'); // /herohealth/vr/vr-ui.js
  }catch(e){
    console.warn('vr-ui.js missing or failed to load:', e);
    toast('vr-ui.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
  window.addEventListener('hha:shoot', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    if(P.debug) console.log('hha:shoot', d);
    // TODO next: raycast/select hotspot in 3D and clean
  });
}

// ---------------------- PLAN UI extras ----------------------
function zoneToEl(zoneId){
  const z = ZONES.find(z=>z.id===zoneId);
  return z ? $(z.el) : null;
}
</script>
</body>
</html>