<!-- === /herohealth/hygiene-vr.html ===
HygieneVR EPISODE MAP (Launcher)
‚úÖ Shows EP1-EP3 locked/unlocked from localStorage: HHA_HYGIENE_PROGRESS
‚úÖ Shows Best records (stepAcc/combo/miss) per episode
‚úÖ Pass-through: hub, run, diff, time, seed, studyId, phase, conditionGroup, style, log
‚úÖ Click episode -> go ./hygiene-vr/hygiene-vr.html?episode=...
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî HygieneVR Episodes</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --radius:22px;
      --pill:999px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; width:100%; height:100%;
      background:
        radial-gradient(circle at 12% 10%, rgba(34,211,238,.12), transparent 60%),
        radial-gradient(circle at 90% 92%, rgba(167,139,250,.10), transparent 62%),
        radial-gradient(circle at 60% 55%, rgba(34,197,94,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Noto Sans Thai",Segoe UI,Roboto,sans-serif;
    }
    .wrap{
      min-height:100%;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .panel{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.72));
      border:1px solid var(--stroke);
      border-radius: 28px;
      padding: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
    }
    .top{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .title{ font-weight:1100; font-size:26px; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin-top:6px; line-height:1.35; font-weight:850; }
    .hr{ height:1px; background:var(--stroke); margin: 14px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      border-radius: var(--pill);
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:rgba(229,231,235,.92);
      height:38px;
      padding:0 12px;
      font-weight:950;
      cursor:pointer;
    }
    .pill:active{ transform:translateY(1px); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }

    /* Map */
    .map{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:860px){ .map{ grid-template-columns: 1fr; } }

    .card{
      position:relative;
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 14px;
      overflow:hidden;
    }
    .badge{
      position:absolute;
      top:12px; right:12px;
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.65);
      opacity:.95;
    }
    .badge.lock{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
    .badge.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .epTitle{ font-weight:1100; font-size:18px; }
    .epTag{ color:var(--muted); font-weight:900; font-size:13px; margin-top:6px; line-height:1.35; }
    .epStats{
      margin-top:10px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.55);
      border-radius:16px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      line-height:1.35;
      color: rgba(229,231,235,.92);
    }
    .cta{
      margin-top:12px;
      width:100%;
      appearance:none;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.65);
      color: var(--text);
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 1050;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cta:active{ transform: translateY(1px) scale(.99); }
    .cta.primary{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .cta.disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(0.2);
    }

    .footerNote{ color:var(--muted); font-weight:900; font-size:12px; line-height:1.35; }
    .toast{
      position:fixed; left:50%;
      bottom:calc(86px + env(safe-area-inset-bottom,0px));
      transform:translateX(-50%);
      background:rgba(2,6,23,.85);
      color:rgba(229,231,235,.95);
      border:1px solid rgba(148,163,184,.18);
      padding:10px 12px;
      border-radius:999px;
      font: 900 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      box-shadow:0 22px 70px rgba(0,0,0,.45);
      z-index:9999;
      opacity:0;
      transition: opacity .16s ease, transform .16s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div>
          <div class="title">üßº HygieneVR ‚Äî Episode Map</div>
          <div class="sub">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô ‚Ä¢ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡∏ú‡πà‡∏≤‡∏ô‚Äù ‚Ä¢ ‡πÄ‡∏ã‡∏ü Best record ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </div>
        </div>
        <div class="row">
          <button class="pill" id="btnCopyLink" type="button">üìã Copy map link</button>
          <button class="pill" id="btnGoHub" type="button">‚Ü© ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="pill" id="btnResetProg" type="button">üßπ Reset Progress</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="map" id="map"></div>

      <div class="hr"></div>

      <div class="footerNote">
        Pass-through: <span class="mono">hub, run, diff, time, seed, studyId, phase, conditionGroup, style, log</span><br/>
        Tip: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ <span class="mono">run=research&amp;seed=...</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ deterministic
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const LS_PROGRESS = 'HHA_HYGIENE_PROGRESS';

  const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };

  function toast(msg){
    const el = DOC.getElementById('toast');
    if(!el) return;
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove('show'), 900);
  }

  async function copyText(text){
    try{ await navigator.clipboard.writeText(String(text)); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'); return true; }
    catch{
      try{
        const ta = DOC.createElement('textarea');
        ta.value = String(text||'');
        DOC.body.appendChild(ta);
        ta.select(); DOC.execCommand('copy');
        ta.remove();
        toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        return true;
      }catch{ toast('Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return false; }
    }
  }

  function loadProg(){
    try{
      const s = localStorage.getItem(LS_PROGRESS);
      const p = s ? JSON.parse(s) : null;
      return p && typeof p==='object' ? p : { unlockedMax:1, best:{} };
    }catch(_){
      return { unlockedMax:1, best:{} };
    }
  }

  function saveProg(p){
    try{ localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }catch(_){}
  }

  function baseHubUrl(){
    // ‡πÉ‡∏ä‡πâ map ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏±‡∏ö (‡∏£‡∏ß‡∏° query ‡∏î‡πâ‡∏ß‡∏¢)
    return location.href;
  }

  function buildToRun(ep){
    const u = new URL(location.href);
    const out = new URL('./hygiene-vr/hygiene-vr.html', u);

    // passthrough keys
    const pass = ['hub','run','diff','time','seed','studyId','phase','conditionGroup','style','log','view'];
    pass.forEach(k=>{
      const v = u.searchParams.get(k);
      if(v!=null && v!=='') out.searchParams.set(k, v);
    });

    // set episode + back link to map
    out.searchParams.set('episode', String(ep));
    out.searchParams.set('hub', baseHubUrl());

    return out.toString();
  }

  function statLine(best){
    if(!best) return 'Best: ‚Äî (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥)';
    const acc = (Number(best.stepAcc||0)*100).toFixed(0);
    const combo = best.comboMax|0;
    const miss = best.misses|0;
    const loops = best.loopsDone|0;
    const boss = best.bossClear ? ' ‚Ä¢ boss‚úÖ' : '';
    return `Best: acc ${acc}% ‚Ä¢ combo ${combo} ‚Ä¢ miss ${miss} ‚Ä¢ loops ${loops}${boss}`;
  }

  function render(){
    const host = DOC.getElementById('map');
    if(!host) return;

    const prog = loadProg();
    const unlockedMax = Math.max(1, Math.min(3, Number(prog.unlockedMax||1)));

    const eps = [
      { id:1, icon:'ü´ß', name:'Training',   desc:'‡∏ù‡∏∂‡∏Å 7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) ‚Ä¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' },
      { id:2, icon:'üåÄ', name:'Storm Master', desc:'‡πÄ‡∏à‡∏≠ Germ Storm ‚Ä¢ ‡πÉ‡∏ä‡πâ Shield ‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô Goals' },
      { id:3, icon:'üëë', name:'Final Boss', desc:'‡∏ö‡∏≠‡∏™‡∏à‡∏£‡∏¥‡∏á ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÅ‡∏•‡∏∞ Miss ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ä‡∏°‡∏õ‡πå!' }
    ];

    host.innerHTML = eps.map(ep=>{
      const locked = ep.id > unlockedMax;
      const best = (prog.best && prog.best[String(ep.id)]) || null;

      return `
        <div class="card">
          <div class="badge ${locked?'lock':'ok'}">${locked?'üîí LOCKED':'‚úÖ AVAILABLE'}</div>
          <div class="epTitle">${ep.icon} EP${ep.id} ‚Äî ${ep.name}</div>
          <div class="epTag">${ep.desc}</div>

          <div class="epStats">${statLine(best)}</div>

          <button class="cta ${(!locked && ep.id===1)?'primary':''} ${locked?'disabled':''}" data-ep="${ep.id}" ${locked?'disabled':''}>
            <span>${locked?'‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô EP'+(ep.id-1)+' ‡∏Å‡πà‡∏≠‡∏ô':'‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'}</span>
            <span class="mono">${locked?'‚Äî':('episode='+ep.id)}</span>
          </button>
        </div>
      `;
    }).join('');

    host.querySelectorAll('[data-ep]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = Number(btn.getAttribute('data-ep')||0);
        if(!id) return;
        const url = buildToRun(id);
        location.href = url;
      }, { passive:true });
    });

    // actions
    DOC.getElementById('btnCopyLink')?.addEventListener('click', ()=>copyText(baseHubUrl()), { passive:true });

    DOC.getElementById('btnGoHub')?.addEventListener('click', ()=>{
      const hub = qs('hub','');
      if(hub) location.href = hub;
      else location.href = './hub.html';
    }, { passive:true });

    DOC.getElementById('btnResetProg')?.addEventListener('click', ()=>{
      const p = { unlockedMax:1, best:{} };
      saveProg(p);
      toast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Progress ‡πÅ‡∏•‡πâ‡∏ß üßπ');
      render();
    }, { passive:true });
  }

  render();
})();
</script>
</body>
</html>