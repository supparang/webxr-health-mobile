<!-- === /herohealth/groups-vr.html ===
Food Groups VR (PRODUCTION) ‚Äî FIX-ALL
Requires:
  - ./vr/particles.js               (IIFE)
  - ./vr/hha-cloud-logger.js        (IIFE) optional
  - ./vr/ui-fever.js                (IIFE)
  - ./vr/hha-hud.js                 (IIFE)
  - ./vr-groups/groups-quests.js    (IIFE)
  - ./vr-groups/GameEngine.js       (IIFE) exposes window.GroupsVR.GameEngine
  - ./vr-groups/groups.safe.js      (module) boots / starts the game
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (for camera rotation source) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Fever UI + HUD binder + Quest (IIFE) -->
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr-groups/groups-quests.js" defer></script>

  <!-- Game Engine (IIFE) -->
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.76);
      --panel2:rgba(15,23,42,.68);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --gold:#f59e0b;
      --shadow:0 18px 55px rgba(0,0,0,.52);
      --r:18px;
    }

    html,body{
      width:100%;
      height:100%;
      margin:0;
      background: radial-gradient(1200px 900px at 50% 40%, rgba(30,41,59,.35), transparent 60%),
                  radial-gradient(900px 700px at 55% 60%, rgba(15,23,42,.60), transparent 62%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      overflow:hidden;
      touch-action: manipulation;
    }

    /* --- main stage --- */
    .stage{
      position:fixed;
      inset:0;
      overflow:hidden;
    }

    /* DOM spawn layer for targets */
    #fg-layer{
      position:fixed;
      inset:0;
      pointer-events:auto;
      z-index:20;
    }

    /* Targets (GameEngine writes --x/--y/--s) */
    .fg-target{
      position:absolute;
      left:var(--x, 50%);
      top:var(--y, 50%);
      transform: translate3d(-50%,-50%,0) scale(var(--s,1));
      width:132px; height:132px;
      display:grid;
      place-items:center;
      border-radius:999px;
      background:
        radial-gradient( circle at 30% 30%, rgba(255,255,255,.28), rgba(255,255,255,.06) 34%, rgba(0,0,0,.18) 70%),
        rgba(255,255,255,.06);
      box-shadow:
        0 18px 48px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(148,163,184,.20);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      font-size:58px;
      line-height:1;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
      opacity:0;
      will-change: transform, left, top, opacity;
    }
    .fg-target.show{ opacity:1; transition: opacity .18s ease; }
    .fg-target.spawn{ animation: popIn .24s ease both; }
    .fg-target.hit{ animation: popOut .18s ease both; }
    .fg-target.out{ animation: fadeOut .16s ease both; }

    .fg-good{ box-shadow: 0 18px 48px rgba(0,0,0,.55), inset 0 0 0 2px rgba(34,197,94,.32); }
    .fg-junk{ box-shadow: 0 18px 48px rgba(0,0,0,.55), inset 0 0 0 2px rgba(239,68,68,.32); filter:saturate(1.06); }
    .fg-boss{ box-shadow: 0 22px 60px rgba(0,0,0,.62), inset 0 0 0 2px rgba(245,158,11,.42); }

    .fg-decoy{ box-shadow: 0 18px 48px rgba(0,0,0,.55), inset 0 0 0 2px rgba(168,85,247,.40); }
    .fg-target.lock{ outline: 2px solid rgba(34,197,94,.42); }
    .fg-target.rage{ animation: ragePulse .9s ease-in-out infinite; }

    .bossbar{
      position:absolute;
      left:12%;
      right:12%;
      bottom:12%;
      height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.18);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.20);
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(245,158,11,.95), rgba(239,68,68,.95));
    }

    @keyframes popIn{ from{ transform:translate3d(-50%,-50%,0) scale(.78); opacity:.0; } to{ transform:translate3d(-50%,-50%,0) scale(1); opacity:1; } }
    @keyframes popOut{ from{ transform:translate3d(-50%,-50%,0) scale(1); opacity:1; } to{ transform:translate3d(-50%,-50%,0) scale(.86); opacity:0; } }
    @keyframes fadeOut{ from{ opacity:1; } to{ opacity:0; } }
    @keyframes ragePulse{ 0%,100%{ transform:translate3d(-50%,-50%,0) scale(var(--s,1)); } 50%{ transform:translate3d(-50%,-50%,0) scale(calc(var(--s,1) * 1.05)); } }

    /* afterimage (engine adds) */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      z-index:21;
      opacity:.0;
      animation: after .42s ease both;
      filter: blur(.1px);
    }
    .fg-afterimage-inner{
      transform: translate3d(-50%,-50%,0) scale(1);
      font-size:48px;
      text-shadow: 0 14px 32px rgba(0,0,0,.45);
    }
    @keyframes after{
      0%{ opacity:.0; transform: translate3d(var(--x,0),var(--y,0),0) translate(-50%,-50%) scale(.95); }
      20%{ opacity:.65; }
      100%{ opacity:0; transform: translate3d(var(--x,0),var(--y,0),0) translate(-50%,-50%) scale(1.12); }
    }

    /* --- HUD --- */
    .hud{
      position:fixed;
      left:12px; right:12px;
      top:12px;
      z-index:40;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      pointer-events:none;
    }
    .card{
      background: linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.44));
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card h4{
      margin:0 0 6px 0;
      font-size:13px;
      letter-spacing:.2px;
      color:rgba(229,231,235,.92);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color:rgba(229,231,235,.92);
    }
    .muted{ color:rgba(148,163,184,.95); }
    .bar{
      height:8px;
      border-radius:999px;
      background:rgba(148,163,184,.16);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.16);
      margin-top:8px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(16,185,129,.95));
    }

    /* goal/mini blocks */
    #hud-goalLabel, #hud-miniLabel{
      font-weight:700;
      font-size:14px;
      line-height:1.2;
    }
    #hud-goalProg, #hud-miniProg{
      font-size:12px;
      color:rgba(148,163,184,.95);
      white-space:nowrap;
    }
    #hud-miniExtra{
      margin-top:6px;
      font-size:12px;
      color:rgba(148,163,184,.95);
    }

    /* coach bubble */
    .coach{
      position:fixed;
      left:12px;
      right:12px;
      top:124px;
      z-index:41;
      pointer-events:none;
    }
    .coach .bubble{
      background: linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.44));
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .coach img{
      width:44px;
      height:44px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 12px 26px rgba(0,0,0,.45);
      flex:0 0 auto;
    }
    .coach .text{
      font-size:13px;
      line-height:1.25;
      color:rgba(229,231,235,.95);
      min-height:18px;
    }

    /* lower HUD */
    .hud2{
      position:fixed;
      left:12px;
      right:12px;
      bottom:88px;
      z-index:42;
      display:flex;
      gap:10px;
      pointer-events:none;
    }
    .hud2 .pill{
      flex:1;
      background: linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.44));
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:rgba(229,231,235,.92);
      overflow:hidden;
    }
    .pill strong{ font-size:18px; }
    .pill small{ color:rgba(148,163,184,.95); font-size:12px; }

    /* controls */
    .controls{
      position:fixed;
      left:12px;
      right:12px;
      bottom:14px;
      z-index:60;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .btn{
      pointer-events:auto;
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.62);
      color:rgba(229,231,235,.95);
      border-radius:18px;
      padding:12px 14px;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      min-width:96px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(34,197,94,.24); border-color: rgba(34,197,94,.26); }
    .btn.danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.22); }
    .btn.ghost{ background: rgba(148,163,184,.10); }

    /* start overlay */
    #startOverlay{
      position:fixed;
      inset:0;
      z-index:80;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(900px 700px at 50% 40%, rgba(2,6,23,.72), rgba(2,6,23,.90));
    }
    .startCard{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.18);
      background: linear-gradient(180deg, rgba(15,23,42,.66), rgba(2,6,23,.66));
      box-shadow: 0 30px 90px rgba(0,0,0,.68);
      padding:16px 16px 14px;
    }
    .startCard h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .startCard p{
      margin:8px 0 12px 0;
      color:rgba(148,163,184,.95);
      font-size:13px;
      line-height:1.35;
    }
    .startGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .chip{
      border:1px solid rgba(148,163,184,.16);
      border-radius:16px;
      padding:10px 10px;
      background: rgba(2,6,23,.42);
      font-size:12px;
      color:rgba(229,231,235,.92);
    }
    .chip strong{ display:block; font-size:16px; margin-top:4px; }
    .startActions{ display:flex; gap:10px; margin-top:12px; }
    .startActions .btn{ flex:1; }

    /* small debug tag */
    .debugTag{
      position:fixed;
      right:12px;
      bottom:156px;
      z-index:55;
      pointer-events:none;
      font-size:11px;
      color:rgba(148,163,184,.95);
      background: rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.14);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* a-frame scene hidden behind */
    a-scene{
      position:fixed !important;
      inset:0 !important;
      z-index:1 !important;
      pointer-events:none;
      opacity:0;
    }
  </style>
</head>

<body>
  <div class="stage">
    <!-- A-Frame scene (camera rotation source) -->
    <a-scene embedded vr-mode-ui="enabled: false" renderer="antialias: true; alpha: true;">
      <a-entity id="rig">
        <a-camera id="cam" position="0 1.6 0" wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
      </a-entity>
    </a-scene>

    <!-- DOM targets -->
    <div id="fg-layer" aria-label="FoodGroups targets layer"></div>

    <!-- HUD (top) -->
    <div class="hud">
      <div class="card" id="hud-goalCard">
        <h4>üéØ GOAL <span class="muted" id="hud-goalCount">0/0</span></h4>
        <div class="row">
          <div id="hud-goalLabel">‚Äî</div>
          <div id="hud-goalProg" class="muted">0%</div>
        </div>
        <div class="bar"><i id="hud-goalBar"></i></div>
      </div>

      <div class="card" id="hud-miniCard">
        <h4>üß© MINI QUEST <span class="muted" id="hud-miniCount">0/0</span></h4>
        <div class="row">
          <div id="hud-miniLabel">‚Äî</div>
          <div id="hud-miniProg" class="muted">0%</div>
        </div>
        <div class="bar"><i id="hud-miniBar"></i></div>
        <div id="hud-miniExtra"></div>
      </div>
    </div>

    <!-- coach -->
    <div class="coach">
      <div class="bubble">
        <img id="hud-coachImg" src="./img/coach-neutral.png" alt="coach" />
        <div class="text" id="hud-coachText">Tip: Tap-anywhere ‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÉ‡∏´‡πâ</div>
      </div>
    </div>

    <!-- lower HUD -->
    <div class="hud2">
      <div class="pill">
        <div>
          <div class="muted">TIME</div>
          <strong id="hud-time">0</strong>
        </div>
        <div style="text-align:right">
          <div class="muted">SHIELD</div>
          <strong id="hud-shield">0</strong>
        </div>
      </div>

      <div class="pill">
        <div>
          <div class="muted">SCORE</div>
          <strong id="hud-score">0</strong>
        </div>
        <div style="text-align:right">
          <div class="muted">GRADE</div>
          <strong id="hud-grade">C</strong>
        </div>
      </div>
    </div>

    <!-- debug -->
    <div class="debugTag" id="hud-debug">QUEST: ‚Äî</div>

    <!-- controls -->
    <div class="controls">
      <button class="btn ghost" id="btnGaze">Gaze: ON</button>
      <button class="btn danger" id="btnStop">STOP</button>
      <button class="btn" id="btnVR">VR</button>
    </div>

    <!-- start overlay -->
    <div id="startOverlay">
      <div class="startCard">
        <h2>üçΩÔ∏è Food Groups VR</h2>
        <p>
          ‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ GOAL + MINI ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö!<br/>
          <span class="muted">Tip: ‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÉ‡∏´‡πâ</span>
        </p>
        <div class="startGrid">
          <div class="chip">DIFF<strong id="chipDiff">‚Äî</strong></div>
          <div class="chip">TIME<strong id="chipTime">‚Äî</strong></div>
          <div class="chip">MODE<strong id="chipMode">‚Äî</strong></div>
        </div>

        <div class="startActions">
          <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
          <button class="btn" id="btnStartResearch">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Boot module -->
  <script type="module" src="./vr-groups/groups.safe.js"></script>

  <!-- Minimal UI glue for buttons/overlay (no engine logic here) -->
  <script>
    (function(){
      'use strict';

      function qs(k){ try{ return new URLSearchParams(location.search).get(k); }catch{ return null; } }
      function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

      const elOverlay = document.getElementById('startOverlay');
      const chipDiff = document.getElementById('chipDiff');
      const chipTime = document.getElementById('chipTime');
      const chipMode = document.getElementById('chipMode');

      const btnStart = document.getElementById('btnStart');
      const btnStartR = document.getElementById('btnStartResearch');
      const btnGaze = document.getElementById('btnGaze');
      const btnStop = document.getElementById('btnStop');
      const btnVR = document.getElementById('btnVR');
      const debug = document.getElementById('hud-debug');

      // read params
      const diff = (qs('diff') || 'normal').toLowerCase();
      const time = clamp(qs('time') || 70, 10, 999);
      const run = (qs('run') || '').toLowerCase();
      const seed = qs('seed') || '';

      chipDiff.textContent = diff;
      chipTime.textContent = String(time) + 's';
      chipMode.textContent = run === 'research' ? 'research' : 'play';

      // Hook quest:update to show debug status "QUEST: OK/NO"
      window.addEventListener('quest:update', (ev) => {
        try{
          const d = ev.detail || {};
          debug.textContent = 'QUEST: ' + (d.questOk ? 'OK' : 'NO');
        }catch{}
      });

      function startViaBoot(runMode){
        try{
          // groups.safe.js should expose global start helper OR use engine directly.
          // We'll try common patterns safely.

          const layer = document.getElementById('fg-layer');
          const cam = document.getElementById('cam');

          // If engine exists, start directly
          const Engine = window.GroupsVR && window.GroupsVR.GameEngine ? window.GroupsVR.GameEngine : null;
          if (Engine && typeof Engine.setLayerEl === 'function'){
            Engine.setLayerEl(layer);
            Engine.setCameraEl(cam);
            Engine.setTimeLeft(time);

            Engine.start(diff, { runMode: runMode, seed: seed || undefined });
            return true;
          }
        }catch(e){
          console.warn('startViaBoot failed', e);
        }
        return false;
      }

      // buttons
      btnStart.addEventListener('click', () => {
        elOverlay.style.display = 'none';
        startViaBoot('play');
      });

      btnStartR.addEventListener('click', () => {
        elOverlay.style.display = 'none';
        startViaBoot('research');
      });

      btnStop.addEventListener('click', () => {
        try{
          const Engine = window.GroupsVR && window.GroupsVR.GameEngine;
          Engine && Engine.stop && Engine.stop('stop_btn');
        }catch{}
        elOverlay.style.display = 'flex';
      });

      let gazeOn = true;
      btnGaze.addEventListener('click', () => {
        gazeOn = !gazeOn;
        btnGaze.textContent = 'Gaze: ' + (gazeOn ? 'ON' : 'OFF');
        btnGaze.classList.toggle('primary', gazeOn);
        try{
          const Engine = window.GroupsVR && window.GroupsVR.GameEngine;
          Engine && Engine.setGaze && Engine.setGaze(gazeOn);
        }catch{}
      });

      btnVR.addEventListener('click', async () => {
        try{
          const scene = document.querySelector('a-scene');
          if (scene && scene.enterVR) scene.enterVR();
        }catch{}
      });

      // auto-run if query has run=play|research
      if (run === 'play' || run === 'research'){
        // wait a bit for deferred scripts (quests + engine) to attach
        setTimeout(() => {
          elOverlay.style.display = 'none';
          startViaBoot(run === 'research' ? 'research' : 'play');
        }, 220);
      }
    })();
  </script>
</body>
</html>