<!-- === /herohealth/groups-vr.html ===
GroupsVR Launcher ‚Äî AUTO DETECT + TAP-TO-START (PRODUCTION)
‚úÖ Default: auto-detect view then auto-enter run page
‚úÖ Does NOT override explicit ?view=
‚úÖ Tap-to-start gate (mobile/cVR) before redirect
‚úÖ Optional menu: ?menu=1 or tap "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î"
‚úÖ Remembers last selection (localStorage)
‚úÖ Pass-through params: hub, log, run, diff, style, time, seed, ai, practice, studyId, etc.
‚úÖ Run page: ./vr-groups/groups-vr.html
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GroupsVR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --radius:22px;
      --pill:999px;

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{
      width:100%; height:100%;
      margin:0; padding:0;
      overflow:hidden;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(circle at bottom right, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    .wrap{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal));
    }
    .card{
      width:min(560px, 100%);
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.82);
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .title{
      font-weight: 1000;
      font-size: 20px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-weight: 1000;
      font-size: 12px;
      padding:6px 10px;
      border-radius: var(--pill);
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.60);
      color: var(--text);
      white-space:nowrap;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      line-height: 1.35;
    }
    .row{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1 1 160px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.62);
      color: var(--text);
      font-weight: 1000;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-strong{
      background: rgba(34,197,94,.20);
      border-color: rgba(34,197,94,.35);
    }
    .btn-ghost{
      background: rgba(2,6,23,.30);
    }
    .kvs{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      padding:12px;
      border-radius: 18px;
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.16);
    }
    .k{
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
    }
    .v{
      margin-top:4px;
      font-weight: 1000;
      font-size: 14px;
      word-break:break-word;
    }
    .small{
      margin-top: 10px;
      font-weight: 800;
      font-size: 12px;
      color: var(--muted);
    }

    /* Tap overlay */
    .tap{
      position:fixed; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
    }
    .tap.hidden{ display:none; }

    /* Menu section (hidden by default) */
    .menu{ margin-top: 12px; display:none; }
    .menu.on{ display:block; }

    @media (max-width: 480px){
      .kvs{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div>ü•¶ HeroHealth ‚Äî GroupsVR</div>
        <div class="badge" id="badgeMode">AUTO</div>
      </div>

      <div class="sub" id="statusLine">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‚Ä¶ (auto-detect) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
      </div>

      <div class="kvs">
        <div class="kv">
          <div class="k">View</div>
          <div class="v" id="vView">‚Äî</div>
        </div>
        <div class="kv">
          <div class="k">Run / Diff / Time</div>
          <div class="v" id="vParams">‚Äî</div>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-strong" id="btnStart" type="button">‚ñ∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢</button>
        <button class="btn btn-ghost" id="btnMenu" type="button">‚öôÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î</button>
      </div>

      <div class="menu" id="menuBox">
        <div class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏≠‡∏á (‡∏à‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)</div>
        <div class="row">
          <button class="btn" data-view="pc" type="button">üñ•Ô∏è PC</button>
          <button class="btn" data-view="mobile" type="button">üì± Mobile</button>
          <button class="btn" data-view="cvr" type="button">üï∂Ô∏è Cardboard (cVR)</button>
        </div>
        <div class="small">
          Tip: cVR ‡∏à‡∏∞‡∏°‡∏µ Calibration (RECENTER + ‡∏¢‡∏¥‡∏á 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà <b>practice=1</b> ‡∏à‡∏∞‡∏ù‡∏∂‡∏Å 15s ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
        </div>
      </div>

      <div class="small" id="debugLine">
        ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏•‡∏≠‡∏î: ‡πÉ‡∏™‡πà <b>?menu=1</b>
      </div>
    </div>
  </div>

  <!-- Tap-to-start gate -->
  <div class="tap" id="tapGate">
    <div class="card" style="max-width:520px;">
      <div class="title">üü¢ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (Tap-to-start)</div>
      <div class="sub">
        ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ‚Äú‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏™‡∏±‡πà‡∏ô/‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠/‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‚Äù ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      </div>
      <div class="row">
        <button class="btn btn-strong" id="tapGo" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°</button>
        <button class="btn" id="tapSilent" type="button">‚è≠Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö</button>
      </div>
      <div class="small" id="tapInfo">‚Äî</div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const WIN = window;

  const LS_LAST_VIEW = 'HHA_GROUPS_LAST_VIEW';

  const $ = (id)=>DOC.getElementById(id);

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }

  function setText(id, txt){
    const el = $(id);
    if (el) el.textContent = String(txt ?? '');
  }

  function isTouch(){
    return ('ontouchstart' in WIN) || ((navigator.maxTouchPoints|0) > 0);
  }

  function detectViewNoOverride(){
    // ‚úÖ do not override explicit view
    const explicit = String(qs('view','')||'').toLowerCase().trim();
    if (explicit) return explicit;

    // ‚úÖ prefer remembered view if exists
    const remembered = String(localStorage.getItem(LS_LAST_VIEW)||'').toLowerCase().trim();
    if (remembered) return remembered;

    const touch = isTouch();
    const w = Math.max(1, WIN.innerWidth||1);
    const h = Math.max(1, WIN.innerHeight||1);
    const landscape = w >= h;

    if (touch){
      if (landscape && w >= 740) return 'cvr';
      return 'mobile';
    }
    return 'pc';
  }

  function buildRunUrl(view){
    // run page path
    const runUrl = new URL('./vr-groups/groups-vr.html', location.href);

    const sp = new URL(location.href).searchParams;

    // keep all params, but ensure view is set
    sp.forEach((v,k)=>{
      runUrl.searchParams.set(k,v);
    });
    runUrl.searchParams.set('view', view);

    // defaults if missing
    if (!runUrl.searchParams.get('run'))  runUrl.searchParams.set('run', 'play');
    if (!runUrl.searchParams.get('diff')) runUrl.searchParams.set('diff', 'easy');
    if (!runUrl.searchParams.get('time')) runUrl.searchParams.set('time', '90');
    if (!runUrl.searchParams.get('style')) runUrl.searchParams.set('style', 'feel');

    if (!runUrl.searchParams.get('seed')){
      runUrl.searchParams.set('seed', String(Date.now()));
    }

    return runUrl;
  }

  function needsTapGate(view){
    // safest: any touch device requires tap gate
    if (isTouch()) return true;
    // also gate cvr even on some desktops (rare)
    if (String(view||'') === 'cvr') return true;
    return false;
  }

  function showTapGate(on, info){
    const el = $('tapGate');
    if (!el) return;
    el.classList.toggle('hidden', !on);
    setText('tapInfo', info || '');
  }

  function go(view){
    try{ localStorage.setItem(LS_LAST_VIEW, String(view||'')); }catch(_){}
    const u = buildRunUrl(view).toString();
    location.href = u;
  }

  // UI init
  const view = String(detectViewNoOverride()||'mobile').toLowerCase();
  const run  = String(qs('run','play')||'play').toLowerCase();
  const diff = String(qs('diff','easy')||'easy').toLowerCase();
  const time = String(qs('time','90')||'90');
  const style= String(qs('style','feel')||'feel').toLowerCase();

  setText('vView', view.toUpperCase());
  setText('vParams', `${run.toUpperCase()} ‚Ä¢ ${diff.toUpperCase()} ‚Ä¢ ${time}s ‚Ä¢ ${style}`);
  setText('badgeMode', (qs('view','') ? 'EXPLICIT' : 'AUTO'));

  const menuForced = String(qs('menu','0')||'0');
  const showMenuNow = (menuForced === '1' || menuForced === 'true');

  const menuBox = $('menuBox');
  if (menuBox && showMenuNow) menuBox.classList.add('on');

  $('btnMenu') && $('btnMenu').addEventListener('click', ()=>{
    if (!menuBox) return;
    menuBox.classList.toggle('on');
  });

  // manual view buttons
  DOC.querySelectorAll('[data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const v = String(btn.getAttribute('data-view')||'mobile').toLowerCase();
      try{ localStorage.setItem(LS_LAST_VIEW, v); }catch(_){}
      setText('vView', v.toUpperCase());
      setText('badgeMode', 'MANUAL');
    }, {passive:true});
  });

  // Start button uses current vView label (from text) OR last stored
  $('btnStart') && $('btnStart').addEventListener('click', ()=>{
    const cur = String($('vView')?.textContent||view).toLowerCase();
    const chosen = (cur.includes('cvr') ? 'cvr' : (cur.includes('pc') ? 'pc' : 'mobile'));
    if (needsTapGate(chosen)){
      showTapGate(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î ${chosen.toUpperCase()}‚Ä¶`);
      return;
    }
    go(chosen);
  }, {passive:true});

  // Tap gate buttons
  $('tapGo') && $('tapGo').addEventListener('click', ()=>{
    const cur = String($('vView')?.textContent||view).toLowerCase();
    const chosen = (cur.includes('cvr') ? 'cvr' : (cur.includes('pc') ? 'pc' : 'mobile'));
    showTapGate(false);
    go(chosen);
  }, {passive:true});

  $('tapSilent') && $('tapSilent').addEventListener('click', ()=>{
    const cur = String($('vView')?.textContent||view).toLowerCase();
    const chosen = (cur.includes('cvr') ? 'cvr' : (cur.includes('pc') ? 'pc' : 'mobile'));
    showTapGate(false);
    go(chosen);
  }, {passive:true});

  // Auto-enter (unless menu forced)
  if (!showMenuNow){
    const auto = String(qs('auto','1')||'1');
    if (auto === '1' || auto === 'true'){
      // show tap gate if needed, else go immediately
      if (needsTapGate(view)){
        showTapGate(true, `Auto-detect: ${view.toUpperCase()} ‚Ä¢ ‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°`);
        // Also allow tapping anywhere on gate
        $('tapGate') && $('tapGate').addEventListener('click', (e)=>{
          const id = (e && e.target && e.target.id) ? e.target.id : '';
          if (id === 'tapGo' || id === 'tapSilent') return;
          showTapGate(false);
          go(view);
        }, {passive:true});
      }else{
        // desktop: go now
        go(view);
      }
    }
  }else{
    // menu mode: hide tap gate until user presses start
    showTapGate(false);
    setText('statusLine', '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (menu=1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢‚Äù');
  }

})();
</script>
</body>
</html>