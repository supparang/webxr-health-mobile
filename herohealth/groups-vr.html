<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION Entry (PC/Mobile/VR/cVR) + Universal VR UI
‚úÖ Choice entry: PC / Mobile / VR / Cardboard (cVR)
‚úÖ Includes ../vr/vr-ui.js => ENTER VR/EXIT/RECENTER + crosshair + hha:shoot
‚úÖ Works with: ./audio.js + ./GameEngine.js + ./groups.quest.js (createGroupsQuest)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />

  <!-- A-Frame (needed for Enter VR button to work) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Universal VR UI (ENTER VR/EXIT/RECENTER + crosshair + emits hha:shoot) -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- SFX + Quest + Engine -->
  <script src="./audio.js" defer></script>
  <script src="./groups.quest.js" defer></script>
  <script src="./GameEngine.js" defer></script>

  <link rel="stylesheet" href="./groups-vr.css" />
</head>

<body class="view-pc">
  <!-- Minimal A-Frame scene behind (for WebXR Enter VR) -->
  <a-scene
    class="xr-scene"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    renderer="colorManagement:true; physicallyCorrectLights:false"
  >
    <a-entity position="0 1.6 0">
      <a-camera wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
    </a-entity>

    <a-sky color="#061225"></a-sky>
    <a-entity light="type:ambient; intensity:1.0"></a-entity>
  </a-scene>

  <!-- ===== Start Overlay (choose entry) ===== -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <div class="title">üçΩÔ∏è Food Groups VR</div>
      <div class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (PC / Mobile / VR / Cardboard)</div>

      <div class="row">
        <button class="btn" data-view="pc">üñ•Ô∏è PC</button>
        <button class="btn" data-view="mobile">üì± Mobile</button>
        <button class="btn" data-view="vr">üï∂Ô∏è VR</button>
        <button class="btn btn-strong" data-view="cvr">üì¶ Cardboard</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="kv">
          <div class="k">Difficulty</div>
          <div class="v">
            <button class="chip" data-diff="easy">Easy</button>
            <button class="chip chip-on" data-diff="normal">Normal</button>
            <button class="chip" data-diff="hard">Hard</button>
          </div>
        </div>

        <div class="kv">
          <div class="k">Mode</div>
          <div class="v">
            <button class="chip chip-on" data-run="play">Play (Adaptive)</button>
            <button class="chip" data-run="research">Research (Seeded)</button>
          </div>
        </div>

        <div class="kv">
          <div class="k">Style</div>
          <div class="v">
            <button class="chip chip-on" data-style="mix">Mix</button>
            <button class="chip" data-style="feel">Feel</button>
            <button class="chip" data-style="hard">Hard</button>
          </div>
        </div>

        <div class="kv">
          <div class="k">Time</div>
          <div class="v">
            <input id="timeInput" class="input" type="number" min="30" max="180" step="5" value="90" />
            <span class="hint">sec</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="note">
        ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î <b>Cardboard</b> (cVR) ‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡∏Ñ‡∏£‡∏≠‡∏™‡πÅ‡∏Æ‡∏£‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‚Äù (tap-to-shoot) <br/>
        ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î <b>VR</b> ‡πÉ‡∏´‡πâ‡∏Å‡∏î ENTER VR (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å vr-ui.js) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      </div>

      <div class="row row2">
        <button id="btnStart" class="btn btn-strong">‚ñ∂Ô∏è Start</button>
        <button id="btnClose" class="btn btn-ghost">‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏°</button>
      </div>
    </div>
  </div>

  <!-- ===== HUD / UI ===== -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">TIME</span><span id="hudTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">SCORE</span><span id="hudScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span id="hudCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">MISS</span><span id="hudMiss" class="val">0</span></div>
    </div>

    <div class="hudRight">
      <div class="pill"><span class="lbl">RANK</span><span id="hudRank" class="val">C</span></div>
      <div class="pill pill-fever">
        <span class="lbl">FEVER</span>
        <span id="hudFever" class="val">0%</span>
        <span id="hudShield" class="tag">üõ°Ô∏è0</span>
      </div>
    </div>
  </div>

  <!-- Quest / Goal -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle"><span id="goalTitle">GOAL</span></div>
      <div class="bar"><div id="goalFill" class="fill" style="width:0%"></div></div>
      <div class="qSub"><span id="goalText">‚Äî</span></div>
    </div>

    <div class="questCard">
      <div class="qTitle"><span id="miniTitle">MINI</span> <span id="miniTime" class="miniTime"></span></div>
      <div class="bar"><div id="miniFill" class="fill" style="width:0%"></div></div>
      <div class="qSub"><span id="miniText">‚Äî</span></div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° POWER (‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°)</div>
      <div class="bar powerBar"><div id="powerFill" class="fill" style="width:0%"></div></div>
      <div class="pFoot"><span id="powerText">0 / 8</span></div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div id="coachText" class="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</div>
      </div>
    </div>
  </div>

  <!-- Targets Layer -->
  <div id="fg-layer" class="playLayer" aria-label="targets layer"></div>

  <!-- End Overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnBack" class="btn btn-ghost">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î</button>
      </div>
    </div>
  </div>

  <!-- ===== Boot Script ===== -->
  <script>
    (function(){
      'use strict';
      const $ = (id)=>document.getElementById(id);

      function qs(k, def=null){
        try { return new URL(location.href).searchParams.get(k) ?? def; }
        catch { return def; }
      }
      function clamp(v,a,b){
        v = Number(v); if (!isFinite(v)) v = a;
        return v<a?a:(v>b?b:v);
      }
      function setView(view){
        const b = document.body;
        b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
        b.classList.add('view-'+view);
      }

      // state from query
      let view = String(qs('view','pc')).toLowerCase();
      if (!['pc','mobile','vr','cvr'].includes(view)) view = 'pc';

      let diff = String(qs('diff','normal')).toLowerCase();
      if (!['easy','normal','hard'].includes(diff)) diff = 'normal';

      let runMode = String(qs('run','play')).toLowerCase() === 'research' ? 'research' : 'play';
      let style = String(qs('style','mix')).toLowerCase();
      if (!['mix','feel','hard'].includes(style)) style = 'mix';

      let time = clamp(qs('time', 90), 30, 180);
      let seed = String(qs('seed', Date.now()));

      // init UI
      setView(view);
      $('timeInput').value = String(time);

      // chips
      function syncChips(){
        document.querySelectorAll('[data-view]').forEach(btn=>{
          btn.classList.toggle('chip-on', btn.dataset.view === view);
        });
        document.querySelectorAll('[data-diff]').forEach(btn=>{
          btn.classList.toggle('chip-on', btn.dataset.diff === diff);
        });
        document.querySelectorAll('[data-run]').forEach(btn=>{
          btn.classList.toggle('chip-on', btn.dataset.run === runMode);
        });
        document.querySelectorAll('[data-style]').forEach(btn=>{
          btn.classList.toggle('chip-on', btn.dataset.style === style);
        });
      }
      syncChips();

      // view buttons
      document.querySelectorAll('[data-view]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          view = btn.dataset.view;
          setView(view);
          syncChips();
        });
      });

      // diff/run/style
      document.querySelectorAll('[data-diff]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ diff = btn.dataset.diff; syncChips(); });
      });
      document.querySelectorAll('[data-run]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ runMode = btn.dataset.run; syncChips(); });
      });
      document.querySelectorAll('[data-style]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ style = btn.dataset.style; syncChips(); });
      });

      $('btnClose').addEventListener('click', ()=> $('startOverlay').classList.add('hidden'));

      // bind engine once ready
      function boot(){
        const NS = window.GroupsVR || {};
        const GE = NS.GameEngine;
        if (!GE || typeof GE.start !== 'function') return;

        GE.setLayerEl($('fg-layer'));

        // HUD listeners (keep independent from any global binder)
        window.addEventListener('hha:time', (ev)=>{
          const d = ev.detail||{};
          $('hudTime').textContent = String(d.left ?? 0);
        }, {passive:true});

        window.addEventListener('hha:score', (ev)=>{
          const d = ev.detail||{};
          $('hudScore').textContent = String(d.score ?? 0);
          $('hudCombo').textContent = String(d.combo ?? 0);
          $('hudMiss').textContent  = String(d.misses ?? 0);
        }, {passive:true});

        window.addEventListener('hha:rank', (ev)=>{
          const d = ev.detail||{};
          $('hudRank').textContent = String(d.grade ?? 'C');
        }, {passive:true});

        window.addEventListener('hha:fever', (ev)=>{
          const d = ev.detail||{};
          $('hudFever').textContent = String((d.feverPct ?? 0) + '%');
          $('hudShield').textContent = 'üõ°Ô∏è' + String(d.shield ?? 0);
        }, {passive:true});

        window.addEventListener('hha:coach', (ev)=>{
          const d = ev.detail||{};
          $('coachText').textContent = String(d.text || '');
          const mood = String(d.mood||'neutral');
          const img = $('coachImg');
          if (mood === 'happy') img.src = '../img/coach-happy.png';
          else if (mood === 'sad') img.src = '../img/coach-sad.png';
          else if (mood === 'fever') img.src = '../img/coach-fever.png';
          else img.src = '../img/coach-neutral.png';
        }, {passive:true});

        window.addEventListener('groups:power', (ev)=>{
          const d = ev.detail||{};
          const c = Number(d.charge||0);
          const t = Math.max(1, Number(d.threshold||8));
          const pct = Math.round((c/t)*100);
          $('powerFill').style.width = pct + '%';
          $('powerText').textContent = c + ' / ' + t;
        }, {passive:true});

        // quest update (if quest emits it)
        window.addEventListener('quest:update', (ev)=>{
          const d = ev.detail||{};
          // goal
          if (d.goalTitle != null) $('goalTitle').textContent = String(d.goalTitle);
          if (d.goalText  != null) $('goalText').textContent  = String(d.goalText);
          if (d.goalPct   != null) $('goalFill').style.width  = clamp(d.goalPct,0,100) + '%';

          // mini
          if (d.miniTitle != null) $('miniTitle').textContent = String(d.miniTitle);
          if (d.miniText  != null) $('miniText').textContent  = String(d.miniText);
          if (d.miniPct   != null) $('miniFill').style.width  = clamp(d.miniPct,0,100) + '%';
          if (d.miniTimeLeftSec != null){
            const s = Math.max(0, Math.round(Number(d.miniTimeLeftSec)||0));
            $('miniTime').textContent = s ? ('‚è≥ ' + s + 's') : '';
          }
        }, {passive:true});

        // end
        window.addEventListener('hha:end', (ev)=>{
          const d = ev.detail||{};
          $('endOverlay').classList.remove('hidden');
          $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');

          $('endScore').textContent = String(d.scoreFinal ?? 0);
          $('endRank').textContent  = String(d.grade ?? 'C');
          $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
          $('endMiss').textContent  = String(d.misses ?? 0);
        }, {passive:true});

        function doStart(){
          time = clamp($('timeInput').value, 30, 180);
          seed = String(qs('seed', Date.now())); // keep query seed if given
          $('startOverlay').classList.add('hidden');
          $('endOverlay').classList.add('hidden');

          // if user chose cVR: targets should not be clickable (css handles)
          setView(view);

          // unlock audio
          try{ NS.Audio && NS.Audio.unlock && NS.Audio.unlock(); }catch{}

          GE.start(diff, { runMode, diff, style, time, seed });
        }

        $('btnStart').addEventListener('click', doStart);
        $('btnRestart').addEventListener('click', doStart);
        $('btnBack').addEventListener('click', ()=> {
          $('endOverlay').classList.add('hidden');
          $('startOverlay').classList.remove('hidden');
        });

        // auto-start if ?autostart=1
        const auto = String(qs('autostart','0'));
        if (auto === '1') doStart();
      }

      // wait scripts
      const it = setInterval(()=>{
        if (window.GroupsVR && window.GroupsVR.GameEngine){
          clearInterval(it);
          boot();
        }
      }, 60);

    })();
  </script>
</body>
</html>