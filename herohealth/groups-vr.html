<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.20);
      --danger:#f97373;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --radius-lg:18px;
      --radius-pill:999px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.24), transparent 55%),
        #020617;
      color:var(--text-main);
    }

    /* PANIC visuals */
    body.panic::before{
      content:"";
      position:fixed; inset:-20px;
      background:
        radial-gradient(circle at center, transparent 55%, rgba(248,113,113,0.28) 75%, rgba(248,113,113,0.42) 100%);
      pointer-events:none;
      z-index:175;
      animation:panicPulse .45s ease-in-out infinite;
      mix-blend-mode:screen;
    }
    @keyframes panicPulse { 0%,100%{opacity:.45} 50%{opacity:.95} }

    body.panic{
      animation:panicShake .22s ease-in-out infinite;
    }
    @keyframes panicShake{
      0%{ transform:translate(0,0) }
      25%{ transform:translate(1px,-1px) }
      50%{ transform:translate(-1px,1px) }
      75%{ transform:translate(1px,1px) }
      100%{ transform:translate(0,0) }
    }

    /* A-Frame = background only */
    a-scene{ position:fixed; inset:0; z-index:0; }
    a-scene, a-scene canvas{ pointer-events:none !important; }

    /* HUD */
    .hud-root{ position:fixed; inset:0; pointer-events:none; z-index:60; }
    .hud-top{
      position:absolute; top:0; left:0; right:0;
      padding:10px;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px;
      pointer-events:none;
    }
    .hud-card{
      pointer-events:auto;
      background:radial-gradient(circle at top, #0f172a, #020617);
      border-radius:var(--radius-lg);
      padding:10px 14px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 18px 40px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,1);
      min-width:260px; max-width:360px;
    }
    .hud-main-title{ font-size:11px; letter-spacing:.18em; text-transform:uppercase; color:var(--text-soft); margin-bottom:2px; }
    .hud-main-mode{ font-size:18px; font-weight:600; }
    .hud-pill{
      margin-top:4px;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-soft);
      display:inline-flex; align-items:center; gap:6px;
    }
    .hud-metrics{ margin-top:8px; display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
    .metric{ display:flex; flex-direction:column; gap:2px; min-width:88px; }
    .metric-label{ font-size:11px; color:var(--text-soft); }
    .metric-value{ font-size:18px; font-weight:700; }
    .metric-value.accent{ color:#bbf7d0; }
    .metric-sub{ font-size:11px; color:var(--text-soft); min-height:14px; }

    .rank-pill{ margin-left:auto; display:flex; flex-direction:column; gap:4px; align-items:flex-end; min-width:92px; }
    .rank-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:74px;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.08em;
      font-size:14px;
      color:#0b1220;
      background:linear-gradient(90deg,#facc15,#22c55e,#38bdf8);
      box-shadow:0 14px 28px rgba(0,0,0,0.55);
      transform:translateY(0) scale(1);
      transition:transform .16s ease-out;
    }
    .rank-badge.pop{ transform:translateY(-1px) scale(1.08); }

    .fg-quest-panel{
      pointer-events:auto;
      min-width:260px; max-width:360px;
      padding:10px 14px;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top, #0f172a, #020617);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 18px 40px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,1);
      max-height:40vh; overflow-y:auto;
    }
    .fg-quest-title{ font-size:11px; letter-spacing:.16em; text-transform:uppercase; color:var(--text-soft); margin-bottom:4px; }
    .fg-quest-row{ display:flex; align-items:flex-start; gap:6px; font-size:13px; padding:2px 0; }
    .fg-quest-label{ font-size:11px; text-transform:uppercase; letter-spacing:.12em; color:var(--text-soft); margin-top:2px; white-space:nowrap; }
    .fg-quest-main{ flex:1; opacity:.92; }
    .fg-quest-progress{ font-variant-numeric:tabular-nums; font-size:12px; color:#bbf7d0; white-space:nowrap; }

    .hud-bottom{
      position:absolute; left:0; right:0; bottom:64px;
      display:flex; justify-content:center; align-items:center;
      pointer-events:none;
    }
    .coach-bubble{
      min-width:60%; max-width:640px;
      background:rgba(15,23,42,0.95);
      border-radius:var(--radius-pill);
      padding:8px 14px;
      border:1px solid rgba(52,211,153,0.5);
      font-size:13px;
      display:none;
      align-items:center; gap:8px;
      pointer-events:auto;
    }
    .coach-bubble.show{ display:flex; }
    .coach-label{ font-size:11px; text-transform:uppercase; letter-spacing:.16em; color:#6ee7b7; font-weight:600; }
    .coach-avatar{
      width:28px; height:28px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fef3c7, #f97316);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:18px;
      box-shadow:0 0 0 2px rgba(15,23,42,0.9);
    }

    @media (max-width:640px){
      .hud-top{ flex-direction:column; align-items:stretch; }
      .hud-card,.fg-quest-panel{ min-width:0; width:100%; max-width:none; }
      .fg-quest-panel{ margin-top:6px; max-height:34vh; }
      .coach-bubble{ min-width:0; width:calc(100% - 32px); font-size:12px; }
      .rank-pill{ align-items:flex-start; margin-left:0; }
    }

    /* DOM targets */
    #fg-layer{
      position:fixed; inset:0;
      z-index:40;
      pointer-events:auto !important;
      touch-action:manipulation;
    }
    .fg-target{
      position:absolute;
      width:132px; height:132px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      pointer-events:auto;
      cursor:pointer;
      user-select:none; -webkit-user-select:none;
      touch-action:manipulation;
      box-shadow:0 12px 32px rgba(15,23,42,0.85), 0 0 0 4px rgba(15,23,42,0.9);
      transform:translate(-50%,-50%) scale(0.92);
      transition:transform .14s ease-out, opacity .14s ease-out;
      opacity:0; /* fade-in base */
      will-change:transform,left,top,opacity;
    }
    .fg-target.spawn{ opacity:0; transform:translate(-50%,-50%) scale(0.86); }
    .fg-target.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
    .fg-target.fade{ opacity:0; transform:translate(-50%,-50%) scale(0.78); }
    .fg-good{ background:radial-gradient(circle at 30% 30%, #22c55e, #15803d); }
    .fg-junk{ background:radial-gradient(circle at 30% 30%, #f97316, #c2410c); }

    /* boss junk look */
    .fg-boss{
      background:radial-gradient(circle at 30% 30%, #ef4444, #7f1d1d) !important;
      box-shadow:
        0 16px 36px rgba(0,0,0,0.75),
        0 0 0 5px rgba(15,23,42,0.9),
        0 0 28px rgba(239,68,68,0.65);
      animation:bossPulse .55s ease-in-out infinite;
    }
    @keyframes bossPulse { 0%,100%{ filter:saturate(1) } 50%{ filter:saturate(1.5) } }

    .fg-target::before{
      content:attr(data-emoji);
      display:block;
      font-size:clamp(40px,7vmin,64px);
      line-height:1;
      color:#fefce8;
      text-shadow:0 2px 4px rgba(15,23,42,0.9), 0 0 10px rgba(15,23,42,0.9);
    }
    .fg-target.hit{ transform:translate(-50%,-50%) scale(0.6); opacity:0; }

    /* Fever gauge */
    .hha-fever-wrap{
      position:fixed !important;
      left:10px; bottom:10px;
      transform:none;
      z-index:80 !important;
    }

    /* Countdown */
    .countdown-overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:200;
      font-size:clamp(3rem,10vw,5rem);
      font-weight:800;
      color:#fbbf24;
      text-shadow:0 0 40px rgba(0,0,0,0.85);
      pointer-events:none;
      opacity:0;
      transform:scale(0.8);
      transition:opacity .2s ease-out, transform .2s ease-out;
    }
    .countdown-overlay.show{ opacity:1; transform:scale(1); }

    /* RUSH overlay */
    .rush-overlay{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) scale(.88);
      z-index:185;
      pointer-events:none;
      opacity:0;
      transition:opacity .16s ease-out, transform .16s ease-out;
      filter:drop-shadow(0 18px 40px rgba(0,0,0,0.65));
    }
    .rush-overlay.show{
      opacity:1;
      transform:translate(-50%,-50%) scale(1);
    }
    .rush-badge{
      padding:12px 22px;
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.10em;
      color:#04101f;
      background:linear-gradient(90deg,#facc15,#22c55e,#38bdf8);
      font-size:clamp(18px,4vw,26px);
    }
    .rush-sub{
      margin-top:6px;
      text-align:center;
      font-size:12px;
      letter-spacing:.14em;
      color:#e0f2fe;
      opacity:.9;
    }

    /* VR button */
    .vr-btn{
      position:fixed;
      right:12px; bottom:16px;
      z-index:653;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      padding:8px 14px;
      font-size:12px; font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 55%),
                 rgba(15,23,42,0.96);
      color:#e0f2fe;
      display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 14px 30px rgba(15,23,42,0.9);
      pointer-events:auto;
    }
    .vr-btn span{ font-size:16px; }

    /* Celebrate overlay */
    .celebrate-overlay{ position:fixed; inset:0; z-index:190; display:none; align-items:center; justify-content:center; pointer-events:none; }
    .celebrate-overlay.show{ display:flex; }
    .celebrate-content{
      padding:12px 22px; border-radius:999px;
      background:radial-gradient(circle at top, rgba(34,197,94,0.9), rgba(21,128,61,0.95));
      box-shadow:0 20px 60px rgba(0,0,0,0.9), 0 0 0 1px rgba(15,23,42,1);
      font-size:clamp(18px,4vw,24px); font-weight:800; letter-spacing:.06em; text-transform:uppercase;
      color:#ecfdf5; text-align:center;
      transform:scale(.86) translateY(10px);
      opacity:0;
      transition:opacity .18s ease-out, transform .18s ease-out, background .18s ease-out;
    }
    .celebrate-overlay.show .celebrate-content{ opacity:1; transform:scale(1) translateY(0); }
    .celebrate-sub{ display:block; margin-top:4px; font-size:clamp(11px,2.5vw,13px); letter-spacing:.18em; opacity:.9; }
    .celebrate--mini .celebrate-content{ background:radial-gradient(circle at top, rgba(250,204,21,0.95), rgba(217,119,6,0.98)); color:#022c22; }
    .celebrate--all .celebrate-content{ background:radial-gradient(circle at top, rgba(56,189,248,0.98), rgba(30,64,175,0.98)); }

    /* Result overlay */
    .result-overlay{
      position:fixed; inset:0; z-index:220;
      display:none; align-items:center; justify-content:center;
      background:radial-gradient(circle at top,#020617ee,#020617f5);
      backdrop-filter:blur(10px);
      pointer-events:auto;
    }
    .result-overlay.show{ display:flex; }
    .result-card{
      width:90%; max-width:420px;
      padding:18px 18px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#0f172a,#020617);
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 22px 55px rgba(0,0,0,0.85), 0 0 0 1px rgba(15,23,42,1);
      color:var(--text-main);
      font-size:14px;
    }
    .result-card h2{ margin:0 0 8px; font-size:16px; }
    .result-card p{ margin:4px 0; font-size:13px; }
    .result-card hr{ border:none; border-top:1px solid rgba(148,163,184,0.5); margin:10px 0; }
    .result-actions{ margin-top:10px; display:flex; justify-content:flex-end; gap:8px; }
    .result-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      padding:6px 12px;
      font-size:13px; font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
    }
    .result-btn.primary{
      background:linear-gradient(90deg,#22c55e,#4ade80);
      color:#022c22;
      border:none;
    }
  </style>
</head>

<body>
  <!-- VR background -->
  <a-scene vr-mode-ui="enabled: true"
           renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
           background="color: #020617">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="fg-camera" wasd-controls-enabled="false" look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9"></a-entity>
      </a-camera>
    </a-entity>
    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-plane position="0 0 0" rotation="-90 0 0" width="16" height="16"
             material="color: #020617; metalness: 0; roughness: 1"></a-plane>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- DOM targets -->
  <div id="fg-layer" aria-label="targets layer"></div>

  <!-- RUSH overlay -->
  <div id="rush-overlay" class="rush-overlay">
    <div class="rush-badge">üöÄ RUSH MODE!</div>
    <div class="rush-sub">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ x2 ‚Ä¢ ‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡πÑ‡∏ß!</div>
  </div>

  <!-- HUD -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card">
        <div class="hud-main-title">HERO HEALTH ‚Ä¢ NUTRITION VR</div>
        <div class="hud-main-mode">Food Groups</div>
        <div class="hud-pill">
          <span id="hud-diff-label">NORMAL</span>
          <span>‚Ä¢</span>
          <span id="hud-time-label">60s</span>
        </div>

        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="metric-value accent" id="hud-score">0</div>
            <div class="metric-sub" id="hud-judge">&nbsp;</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="metric-value" id="hud-combo">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏û‡∏•‡∏≤‡∏î</div>
            <div class="metric-value" id="hud-miss">0</div>
          </div>

          <div class="rank-pill">
            <div class="metric-label">GRADE</div>
            <div class="rank-badge" id="hud-rank">C</div>
          </div>
        </div>
      </div>

      <div class="fg-quest-panel">
        <div class="fg-quest-title" id="fg-quest-title">Quest</div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Goal</div>
          <div class="fg-quest-main" id="fg-quest-main">‚Äî</div>
          <div class="fg-quest-progress" id="fg-quest-main-progress">0 / 0</div>
        </div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Mini</div>
          <div class="fg-quest-main" id="fg-quest-mini">‚Äî</div>
          <div class="fg-quest-progress" id="fg-quest-mini-progress">0 / 0</div>
        </div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div class="coach-avatar" id="coach-avatar">ü•¶</div>
        <div>
          <div class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div id="coach-text">‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚ú®</div>
        </div>
      </div>
    </div>
  </div>

  <button id="btn-vr" class="vr-btn"><span>üï∂Ô∏è</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</button>
  <div id="start-countdown" class="countdown-overlay">3</div>

  <!-- Celebrate overlay -->
  <div id="celebrate-overlay" class="celebrate-overlay">
    <div class="celebrate-content">
      <span id="celebrate-main">GOAL COMPLETE!</span>
      <span class="celebrate-sub" id="celebrate-sub">FOOD GROUPS VR</span>
    </div>
  </div>

  <!-- Result overlay -->
  <div class="result-overlay" id="result-overlay">
    <div class="result-card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups</h2>
      <p>‡πÄ‡∏Å‡∏£‡∏î: <strong id="res-grade">C</strong></p>
      <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <strong id="res-score">0</strong></p>
      <p>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong id="res-combo">0</strong></p>
      <p>‡∏û‡∏•‡∏≤‡∏î: <strong id="res-miss">0</strong></p>
      <p>Goals: <strong id="res-goal">0 / 0</strong></p>
      <p>Mini quests: <strong id="res-mini">0 / 0</strong></p>
      <hr>
      <div class="result-actions">
        <button class="result-btn" id="res-back">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="result-btn primary" id="res-replay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Fever UI + particles -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <!-- Quest + Engine -->
  <script src="./vr-groups/quest-manager.js"></script>
  <script src="./vr-groups/GameEngine.js"></script>

  <!-- Logger (IIFE) -->
  <script src="./vr/hha-cloud-logger.js"></script>

  <!-- Boot -->
  <script type="module">
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';

    const fgLayer = document.getElementById('fg-layer');

    const elScore = document.getElementById('hud-score');
    const elCombo = document.getElementById('hud-combo');
    const elMiss  = document.getElementById('hud-miss');
    const elJudge = document.getElementById('hud-judge');
    const elDiff  = document.getElementById('hud-diff-label');
    const elTime  = document.getElementById('hud-time-label');

    const elRank = document.getElementById('hud-rank');
    let currentGrade = 'C';
    let rankPopT = null;

    const elQuestTitle = document.getElementById('fg-quest-title');
    const elQuestMain  = document.getElementById('fg-quest-main');
    const elQuestMini  = document.getElementById('fg-quest-mini');
    const elQuestMainP = document.getElementById('fg-quest-main-progress');
    const elQuestMiniP = document.getElementById('fg-quest-mini-progress');

    const elCoachBubble = document.getElementById('coach-bubble');
    const elCoachText   = document.getElementById('coach-text');

    const btnVR = document.getElementById('btn-vr');
    const elCountdown = document.getElementById('start-countdown');

    const elCelebrateOverlay = document.getElementById('celebrate-overlay');
    const elCelebrateMain = document.getElementById('celebrate-main');
    const elCelebrateSub  = document.getElementById('celebrate-sub');

    const elRush = document.getElementById('rush-overlay');

    const elResult   = document.getElementById('result-overlay');
    const elResGrade = document.getElementById('res-grade');
    const elResScore = document.getElementById('res-score');
    const elResCombo = document.getElementById('res-combo');
    const elResMiss  = document.getElementById('res-miss');
    const elResGoal  = document.getElementById('res-goal');
    const elResMini  = document.getElementById('res-mini');

    document.getElementById('res-replay').addEventListener('click', () => location.reload());
    document.getElementById('res-back').addEventListener('click', () => location.href = './hub.html');

    function getParam(name, fallback){
      const url = new URL(location.href);
      const v = url.searchParams.get(name);
      return (v !== null && v !== '') ? v : fallback;
    }

    function setCoach(text){
      if (!text) return;
      elCoachText.textContent = text;
      elCoachBubble.classList.add('show');
      setTimeout(() => elCoachBubble.classList.remove('show'), 3200);
    }

    // simple tick sound (WebAudio) for PANIC
    let audioCtx = null;
    function beep(freq=880, dur=0.06, gain=0.06){
      try{
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + dur);
      }catch{}
    }

    // Celebrate
    let celebTimer = null;
    window.addEventListener('hha:celebrate', (e) => {
      const d = e.detail || {};
      const type = d.type || d.kind || 'goal';

      elCelebrateOverlay.classList.remove('celebrate--mini','celebrate--all');

      if (type === 'goal') {
        elCelebrateMain.textContent = `GOAL ${d.index||1}/${d.total||2} COMPLETE üéØ`;
        elCelebrateSub.textContent  = '‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
      } else if (type === 'mini') {
        elCelebrateOverlay.classList.add('celebrate--mini');
        elCelebrateMain.textContent = `MINI QUEST ${d.index||1}/${d.total||3} CLEAR ‚≠ê`;
        elCelebrateSub.textContent  = '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!';
      } else {
        elCelebrateOverlay.classList.add('celebrate--all');
        elCelebrateMain.textContent = 'ALL QUESTS CLEARED üéâ';
        elCelebrateSub.textContent  = '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á Goal ‡πÅ‡∏•‡∏∞ Mini ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';
      }

      elCelebrateOverlay.classList.add('show');
      clearTimeout(celebTimer);
      celebTimer = setTimeout(() => elCelebrateOverlay.classList.remove('show'), type === 'all' ? 2600 : 2000);
    });

    // HUD updates
    window.addEventListener('hha:score', (e) => {
      const d = e.detail || {};
      if (typeof d.score === 'number') elScore.textContent = String(d.score);
      if (typeof d.misses === 'number') elMiss.textContent = String(d.misses);
      if (typeof d.combo === 'number') {
        const cur = parseInt(elCombo.textContent || '0', 10) || 0;
        elCombo.textContent = String(Math.max(cur, d.combo|0));
      }
    });

    window.addEventListener('hha:judge', (e) => {
      elJudge.textContent = (e.detail && e.detail.label) ? e.detail.label : '';
    });

    window.addEventListener('hha:coach', (e) => {
      const d = e.detail || {};
      if (d.text) setCoach(d.text);
    });

    // Grade realtime
    window.addEventListener('hha:rank', (e) => {
      const d = e.detail || {};
      const g = String(d.grade || 'C').toUpperCase().trim();
      const safe = (['SSS','SS','S','A','B','C'].includes(g)) ? g : 'C';
      currentGrade = safe;
      elRank.textContent = safe;

      clearTimeout(rankPopT);
      elRank.classList.add('pop');
      rankPopT = setTimeout(() => elRank.classList.remove('pop'), 180);
    });

    // PANIC listener
    let panicTickTimer = null;
    window.addEventListener('hha:panic', (e) => {
      const d = e.detail || {};
      const on = !!d.on;
      document.body.classList.toggle('panic', on);

      clearInterval(panicTickTimer);
      if (on){
        panicTickTimer = setInterval(() => {
          const left = parseInt(elTime.textContent||'0',10) || 0;
          const freq = left <= 3 ? 1100 : (left <= 6 ? 980 : 880);
          beep(freq, 0.05, 0.055);
        }, 520);
      }
    });

    // RUSH listener
    let rushTimer = null;
    window.addEventListener('hha:rush', (e) => {
      const d = e.detail || {};
      if (d.on){
        elRush.classList.add('show');
        clearTimeout(rushTimer);
        rushTimer = setTimeout(() => elRush.classList.remove('show'), 1400);
        beep(660,0.06,0.06); setTimeout(()=>beep(880,0.06,0.06),80); setTimeout(()=>beep(990,0.06,0.06),160);
      } else {
        elRush.classList.remove('show');
      }
    });

    window.addEventListener('quest:update', (e) => {
      const d = e.detail || {};
      const goal = d.goal || null;
      const mini = d.mini || null;

      if (d.groupLabel) elQuestTitle.textContent = `Quest ‚Ä¢ ${d.groupLabel}`;

      if (goal) {
        elQuestMain.textContent = goal.label || 'Goal';
        elQuestMainP.textContent = `${goal.prog|0} / ${goal.target|0}`;
      } else {
        elQuestMain.textContent = 'Goal ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéâ';
        elQuestMainP.textContent = '';
      }

      if (mini) {
        elQuestMini.textContent = mini.label || 'Mini';
        elQuestMiniP.textContent = `${mini.prog|0} / ${mini.target|0}`;
      } else {
        elQuestMini.textContent = 'Mini ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
        elQuestMiniP.textContent = '';
      }
    });

    window.addEventListener('hha:end', (e) => {
      const d = e.detail || {};
      elResGrade.textContent = String(d.grade || currentGrade || 'C');
      elResScore.textContent = String(d.scoreFinal ?? 0);
      elResCombo.textContent = String(d.comboMax ?? 0);
      elResMiss.textContent  = String(d.misses ?? 0);
      elResGoal.textContent  = `${d.goalsCleared ?? 0} / ${d.goalsTotal ?? 0}`;
      elResMini.textContent  = `${d.miniCleared ?? 0} / ${d.miniTotal ?? 0}`;
      elResult.classList.add('show');
    });

    // VR
    btnVR.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) { try { scene.enterVR(); } catch {} }
    });

    // Touch look
    const cam = document.querySelector('#fg-camera');
    if (cam) attachTouchLook(cam, { sensitivity: 0.25, areaEl: document.body });

    // Logger (IIFE) ‚Äî FIX: no named export, use window.HHACloudLogger.init
    function initLogger(){
      const endpoint = 'https://script.google.com/macros/s/AKfycby7IBVmpmEydNDp5BR3CMaSAjvF7ljptaDwvow_L781iDLsbtpuiFmKviGUnugFerDtQg/exec';
      try{
        window.HHACloudLogger && window.HHACloudLogger.init && window.HHACloudLogger.init({
          endpoint,
          debug: false
        });
      }catch{}
    }

    function runCountdown(onDone){
      const steps = ['3','2','1','Go!'];
      let idx = 0;
      elCountdown.textContent = steps[0];
      elCountdown.classList.add('show');

      const t = setInterval(() => {
        idx++;
        if (idx >= steps.length){
          clearInterval(t);
          elCountdown.classList.remove('show');
          onDone && onDone();
        } else {
          elCountdown.textContent = steps[idx];
        }
      }, 800);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const diff = String(getParam('diff','normal')).toLowerCase();
      const runParam = String(getParam('run','play')).toLowerCase();
      const runMode = (runParam === 'research') ? 'research' : 'play';

      elDiff.textContent = diff.toUpperCase();

      let dur = (diff === 'easy') ? 88 : (diff === 'hard' ? 55 : 70);
      const timeParam = getParam('time','');
      if (timeParam){
        const parsed = parseInt(timeParam,10);
        if (!isNaN(parsed) && parsed >= 20 && parsed <= 180) dur = parsed;
      }
      elTime.textContent = dur + 's';

      initLogger();
      setCoach('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö Goal + Mini ‚ú®');

      const Engine = window.GroupsVR?.GameEngine;
      if (!Engine || typeof Engine.start !== 'function'){
        console.error('[FoodGroupsVR] GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏ö');
        return;
      }
      Engine.setLayerEl && Engine.setLayerEl(fgLayer);

      runCountdown(() => {
        let timeLeft = dur;

        Engine.setTimeLeft && Engine.setTimeLeft(timeLeft);

        const timerId = setInterval(() => {
          timeLeft -= 1;
          if (timeLeft < 0) return;

          elTime.textContent = timeLeft + 's';
          Engine.setTimeLeft && Engine.setTimeLeft(timeLeft);

          if (timeLeft === 0){
            clearInterval(timerId);
            Engine.stop && Engine.stop('time-up');
          }
        }, 1000);

        Engine.start(diff, { layerEl: fgLayer, runMode });
      });
    });
  </script>
</body>
</html>
