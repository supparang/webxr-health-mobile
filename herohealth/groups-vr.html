<!doctype html> 
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS layout (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô GoodJunk) -->
  <link rel="stylesheet" href="./css/groups-vr.css" />
</head>
<body>
  <!-- ===== A-Frame Scene (‡∏â‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á VR) ===== -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true"
    background="color: #020617"
  >
    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á + cursor ‡πÄ‡∏•‡πá‡∏á (‡πÉ‡∏ä‡πâ rayOrigin: mouse ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á PC/Mobile) -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera wasd-controls-enabled="false">
        <a-entity
          id="cursor"
          cursor="fuse: false; rayOrigin: mouse"
          raycaster="objects: [data-hha-tgt]"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
          material="shader: flat; color: #ffffff"
          position="0 0 -0.9"
        ></a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡πÅ‡∏™‡∏á + ‡∏û‡∏∑‡πâ‡∏ô -->
    <a-entity
      light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"
    ></a-entity>
    <a-entity
      light="type: directional; intensity: 0.7"
      position="1 2 0.5"
    ></a-entity>
    <a-plane
      position="0 0 0"
      rotation="-90 0 0"
      width="16"
      height="16"
      material="color: #020617;"
    ></a-plane>

    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏°: A-Frame component food-groups-game ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    <a-entity id="fg-root" food-groups-game></a-entity>
  </a-scene>

  <!-- ===== HUD ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô GoodJunk ===== -->
  <div class="hud-root">
    <div class="hud-top">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô: ‡πÇ‡∏´‡∏°‡∏î + ‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
      <div class="hud-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
          "
        >
          <div>
            <div class="hud-main-title">Hero Health ‚Ä¢ Nutrition VR</div>
            <div class="hud-main-mode">Food Groups</div>
          </div>
          <div class="hud-pill">
            <span id="hud-diff-label">NORMAL</span>
            <span>‚Ä¢</span>
            <span id="hud-time-label">60s</span>
          </div>
        </div>

        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="metric-value accent" id="hud-score">0</div>
          </div>
          <!-- ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ô‡∏±‡∏ö miss ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° metric ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô:
          <div class="metric">
            <div class="metric-label">Miss</div>
            <div class="metric-value" id="hud-miss">0</div>
          </div>
          -->
        </div>
      </div>

      <!-- ‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô: Goal + Mini quest -->
      <div class="fg-quest-panel">
        <div class="fg-quest-title">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

        <div class="fg-quest-row">
          <span class="fg-quest-label">GOAL</span>
          <span class="fg-quest-main" id="hud-goal-main">
            -
          </span>
          <span class="fg-quest-progress" id="hud-goal-progress">
            0 / -
          </span>
        </div>

        <div class="fg-quest-row">
          <span class="fg-quest-label">MINI QUEST</span>
          <span class="fg-quest-main" id="hud-mini-main">
            -
          </span>
          <span class="fg-quest-progress" id="hud-mini-progress">
            0 / -
          </span>
        </div>
      </div>
    </div>

    <!-- ‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á: ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏û‡∏π‡∏î -->
    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <span class="coach-avatar">ü•¶</span>
        <span class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
        <span id="coach-text">‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞!</span>
      </div>
    </div>
  </div>

  <!-- ‡∏ä‡∏±‡πâ‡∏ô DOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤ emoji -->
  <div id="fg-layer"></div>

  <!-- ===== Toast ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á) ===== -->
  <div class="end-toast" id="fg-end">
    <div class="end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups VR</div>

    <div class="end-row">
      <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
      <strong id="fg-res-score">0</strong>
    </div>
    <div class="end-row">
      <span>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
      <strong id="fg-res-quest">0 / 2</strong>
    </div>
    <div class="end-row">
      <span>Goal</span>
      <strong id="fg-res-goal">-</strong>
    </div>
    <div class="end-row">
      <span>Mini quest</span>
      <strong id="fg-res-mini">-</strong>
    </div>

    <div class="end-actions">
      <button class="end-btn ghost" id="fg-btn-retry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button class="end-btn primary" id="fg-btn-hub">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
    </div>
  </div>

  <!-- ===== ‡∏£‡∏∞‡∏ö‡∏ö Fever + FX ===== -->
  <!-- Fever gauge + ‡πÑ‡∏ü‡∏ó‡πà‡∏ß‡∏°‡∏à‡∏≠ (script ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á FeverUI global) -->
  <script type="module" src="./vr/ui-fever.js"></script>
  <!-- FX ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡πâ‡∏á / ‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å (‡∏™‡∏£‡πâ‡∏≤‡∏á HHA_PARTICLES global) -->
  <script src="./vr/particles.js"></script>

  <!-- ===== ‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Food Groups ===== -->
  <script src="./vr-groups/emoji-image.js"></script>
  <script src="./vr-groups/difficulty.js"></script>
  <script src="./vr-groups/logger-cloud.js"></script>
  <!-- GameEngine ‡πÉ‡∏ä‡πâ AFRAME.registerComponent + FeverUI + HHA_PARTICLES -->
  <script type="module" src="./vr-groups/GameEngine.js"></script>

  <!-- ===== HTML-side glue: HUD + Summary + Hub ===== -->
  <script>
    (function () {
      // helper ‡∏≠‡πà‡∏≤‡∏ô query string
      function getParam(name, fallback) {
        const url = new URL(window.location.href);
        const v = url.searchParams.get(name);
        return v !== null && v !== '' ? v : fallback;
      }

      const diffParam = String(getParam('diff', 'normal')).toLowerCase();
      let timeParam = parseInt(getParam('time', '60'), 10);
      if (isNaN(timeParam) || timeParam <= 0) timeParam = 60;
      if (timeParam < 20) timeParam = 20;
      if (timeParam > 180) timeParam = 180;

      const elScore     = document.getElementById('hud-score');
      const elDiff      = document.getElementById('hud-diff-label');
      const elTime      = document.getElementById('hud-time-label');
      const elCoach     = document.getElementById('coach-bubble');
      const elCoachText = document.getElementById('coach-text');

      // Toast ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
      const endToast = document.getElementById('fg-end');
      const resScore = document.getElementById('fg-res-score');
      const resQuest = document.getElementById('fg-res-quest');
      const resGoal  = document.getElementById('fg-res-goal');
      const resMini  = document.getElementById('fg-res-mini');
      const btnRetry = document.getElementById('fg-btn-retry');
      const btnHub   = document.getElementById('fg-btn-hub');

      elDiff.textContent = diffParam.toUpperCase();
      elTime.textContent = timeParam + 's';
      elScore.textContent = '0';

      // coach helper (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö mood: good / bad / hype)
      function setCoach(text, mood) {
        if (!text) return;
        elCoachText.textContent = text;
        elCoach.classList.add('show');

        // ‡∏•‡πâ‡∏≤‡∏á class mood ‡πÄ‡∏Å‡πà‡∏≤
        elCoach.classList.remove('coach-good', 'coach-bad', 'coach-hype');
        const avatar = elCoach.querySelector('.coach-avatar');
        if (avatar) {
          avatar.classList.remove(
            'coach-avatar-good',
            'coach-avatar-bad',
            'coach-avatar-hype'
          );
        }

        if (mood === 'good') {
          elCoach.classList.add('coach-good');
          if (avatar) avatar.classList.add('coach-avatar-good');
        } else if (mood === 'bad') {
          elCoach.classList.add('coach-bad');
          if (avatar) avatar.classList.add('coach-avatar-bad');
        } else if (mood === 'hype') {
          elCoach.classList.add('coach-hype');
          if (avatar) avatar.classList.add('coach-avatar-hype');
        }
      }

      // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      setCoach('‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ô‡πâ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏∞! ü•¶');

      const scene = document.querySelector('a-scene');

      // ‡∏£‡∏±‡∏ö event ‡∏à‡∏≤‡∏Å GameEngine ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏° ‚Üí ‡πÅ‡∏™‡∏î‡∏á toast
      scene.addEventListener('fg-game-over', function (e) {
        const d = e.detail || {};
        resScore.textContent = d.score != null ? d.score : 0;

        if (d.questsCleared != null) {
          const total = d.questsTotal != null ? d.questsTotal : 2;
          resQuest.textContent = d.questsCleared + ' / ' + total;
        } else {
          resQuest.textContent = '- / -';
        }

        resGoal.textContent = d.goal || '-';
        resMini.textContent = d.miniQuest || '-';

        if (endToast) {
          endToast.classList.add('show');
        }
      });

      // GameEngine ‡∏¢‡∏¥‡∏á event ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏û‡∏π‡∏î + ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå
      window.addEventListener('fg-coach', function (e) {
        const d = e.detail || {};
        if (d.text) {
          setCoach(d.text, d.mood);
        }
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° diff/time ‡πÄ‡∏î‡∏¥‡∏°
      if (btnRetry) {
        btnRetry.addEventListener('click', function () {
          const url = new URL(window.location.href);
          url.searchParams.set('diff', diffParam);
          url.searchParams.set('time', String(timeParam));
          window.location.href = url.toString();
        });
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö Hub (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á)
      if (btnHub) {
        btnHub.addEventListener('click', function () {
          window.location.href = './hub.html';
        });
      }

      // ‡πÅ‡∏à‡πâ‡∏á GameEngine ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ scene ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
      scene.addEventListener('loaded', function () {
        console.log('[GroupsVR] scene loaded ‚Üí emit fg-start');
        scene.emit('fg-start', { diff: diffParam, duration: timeParam });
      });
    })();
  </script>
</body>
</html>
