<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (FIX-ALL)
‚úÖ HUD quest/update ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (hha-hud.js)
‚úÖ FeverUI ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (ui-fever.js) + Engine emits hha:fever ‡πÅ‡∏•‡πâ‡∏ß
‚úÖ Logger ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö School (hha-cloud-logger.js) + setContext ‡∏à‡∏≤‡∏Å Start Overlay
‚úÖ Start overlay ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö play/research + diff/time + seed (research)
‚úÖ Target layer + lock/charge reticle UI ‡∏Ñ‡∏£‡∏ö (groups:lock / groups:reticle / groups:charge)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- (Optional) endpoint via meta (or set window.HHA_LOG_ENDPOINT before logger loads) -->
  <!-- <meta name="hha-log-endpoint" content="https://script.google.com/macros/s/XXXX/exec" /> -->

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + Logger + HUD + Fever UI -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Quest + Engine -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.76);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.20);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --junk:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --shadow:0 18px 55px rgba(0,0,0,.50);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;}
    *{box-sizing:border-box;}
    a{color:inherit}

    /* A-Frame canvas always behind */
    .a-canvas, canvas{position:fixed !important; inset:0 !important; z-index:0 !important;}

    /* Gameplay overlay root */
    .overlay{
      position:fixed; inset:0; z-index:10;
      pointer-events:none;
    }

    /* Targets layer (DOM) */
    #fg-layer{
      position:fixed; inset:0;
      pointer-events:auto; /* targets clickable */
      touch-action:manipulation;
    }

    /* Target element driven by CSS vars */
    .fg-target{
      position:absolute;
      left:var(--x, 50%);
      top:var(--y, 52%);
      transform:translate(-50%,-50%) scale(var(--s,1));
      will-change:transform,left,top;
      display:flex; align-items:center; justify-content:center;
      border-radius:999px;
      user-select:none;
      -webkit-user-select:none;
      font-size:64px;
      line-height:1;
      text-shadow: 0 10px 25px rgba(0,0,0,.45);
      filter: drop-shadow(0 14px 30px rgba(0,0,0,.45));
      transition: transform .12s ease, opacity .18s ease;
      opacity:0;
    }
    .fg-target.show{opacity:1;}
    .fg-target.spawn{animation: fgPop .18s ease-out both;}
    @keyframes fgPop{
      from{transform:translate(-50%,-50%) scale(.6); opacity:.2}
      to{transform:translate(-50%,-50%) scale(var(--s,1)); opacity:1}
    }
    .fg-target.hit{opacity:0; transform:translate(-50%,-50%) scale(.65) rotate(-8deg);}
    .fg-target.out{opacity:.0; transform:translate(-50%,-50%) scale(.88);}

    /* Types */
    .fg-good{
      background: radial-gradient(120px 120px at 30% 30%, rgba(34,197,94,.22), rgba(2,6,23,.02));
      border:1px solid rgba(34,197,94,.18);
      box-shadow: 0 0 0 2px rgba(34,197,94,.08) inset;
    }
    .fg-junk{
      background: radial-gradient(120px 120px at 30% 30%, rgba(239,68,68,.20), rgba(2,6,23,.02));
      border:1px solid rgba(239,68,68,.18);
      box-shadow: 0 0 0 2px rgba(239,68,68,.08) inset;
    }
    .fg-boss{
      border:1px solid rgba(245,158,11,.24);
      box-shadow: 0 0 0 2px rgba(245,158,11,.12) inset;
    }
    .fg-decoy{
      border:1px dashed rgba(34,211,238,.40);
      box-shadow: 0 0 0 2px rgba(34,211,238,.10) inset;
    }
    .fg-target.lock{
      outline: 2px solid rgba(34,211,238,.35);
      outline-offset: 4px;
      animation: lockPulse .55s ease-in-out infinite;
    }
    @keyframes lockPulse{
      0%,100%{transform:translate(-50%,-50%) scale(var(--s,1))}
      50%{transform:translate(-50%,-50%) scale(calc(var(--s,1) * 1.04))}
    }
    .fg-target.rage{
      animation: rageGlow .25s ease-in-out infinite alternate;
    }
    @keyframes rageGlow{
      from{filter: drop-shadow(0 16px 34px rgba(245,158,11,.35));}
      to{filter: drop-shadow(0 20px 44px rgba(245,158,11,.55));}
    }

    /* Boss bar */
    .bossbar{
      position:absolute;
      left:50%; bottom:-12px;
      transform:translateX(-50%);
      width:68%;
      height:8px;
      border-radius:99px;
      background:rgba(148,163,184,.18);
      border:1px solid rgba(148,163,184,.20);
      overflow:hidden;
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg, rgba(245,158,11,.95), rgba(34,197,94,.85));
    }

    /* HUD panels */
    .hud{
      position:fixed; inset:0; z-index:20;
      pointer-events:none;
    }
    .topbar{
      position:fixed; left:10px; right:10px; top:10px;
      display:flex; gap:10px; align-items:stretch;
    }
    .card{
      pointer-events:none;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      backdrop-filter:blur(10px);
      min-width: 0;
    }
    .card h4{
      margin:0 0 6px 0;
      font-size:12px;
      letter-spacing:.2px;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:14px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.55);
      font-weight:700;
      white-space:nowrap;
    }
    .pill b{font-weight:900}
    .pill.good{border-color:rgba(34,197,94,.22)}
    .pill.warn{border-color:rgba(245,158,11,.25)}
    .pill.bad{border-color:rgba(239,68,68,.25)}
    .pill.cyan{border-color:rgba(34,211,238,.25)}
    .muted{color:var(--muted); font-weight:600}

    /* Quest panel */
    .quest{
      position:fixed;
      left:10px; bottom:12px;
      width:min(520px, calc(100% - 20px));
      pointer-events:none;
    }
    .qline{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:6px 0;
      font-size:14px;
      font-weight:800;
    }
    .qprog{
      display:flex; align-items:center; gap:8px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(148,163,184,.12);
      overflow:hidden;
      margin-top:8px;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.88));
    }
    .subbar > i{
      background:linear-gradient(90deg, rgba(245,158,11,.95), rgba(239,68,68,.88));
    }
    .qtag{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
    }

    /* Coach bubble */
    .coach{
      position:fixed;
      right:10px; bottom:12px;
      width:min(520px, calc(100% - 20px));
      display:flex; gap:10px; align-items:flex-end;
      pointer-events:none;
    }
    .coach .avatar{
      width:62px; height:62px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      box-shadow:var(--shadow);
      overflow:hidden;
      flex:0 0 auto;
    }
    .coach .avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .coach .bubble{
      flex:1 1 auto;
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      font-weight:900;
      font-size:14px;
    }

    /* Reticle + lock/charge ring */
    .reticle{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:25;
      pointer-events:none;
    }
    .ret{
      width:86px; height:86px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: radial-gradient(closest-side, rgba(2,6,23,.12), rgba(2,6,23,.0));
      box-shadow: 0 0 0 2px rgba(148,163,184,.10) inset;
      display:grid; place-items:center;
      transform:translateZ(0);
    }
    .ret:before, .ret:after{
      content:'';
      position:absolute;
      width:2px; height:18px;
      background:rgba(148,163,184,.38);
      border-radius:2px;
    }
    .ret:after{transform:rotate(90deg)}
    .ret.ok{border-color:rgba(34,197,94,.28); box-shadow:0 0 0 2px rgba(34,197,94,.14) inset;}
    .ret.miss{border-color:rgba(239,68,68,.30); box-shadow:0 0 0 2px rgba(239,68,68,.14) inset; animation: missShake .25s ease;}
    @keyframes missShake{
      0%{transform:translate(0,0)}
      25%{transform:translate(-2px,1px)}
      55%{transform:translate(2px,-1px)}
      100%{transform:translate(0,0)}
    }

    .lockRing{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:104px; height:104px;
      border-radius:999px;
      border:2px solid rgba(34,211,238,.26);
      box-shadow: 0 0 0 2px rgba(34,211,238,.10) inset;
      opacity:0;
      pointer-events:none;
      z-index:26;
    }
    .lockRing.on{opacity:1;}
    .lockRing .prog, .lockRing .charge{
      position:absolute; inset:10px;
      border-radius:999px;
      border:3px solid transparent;
      border-top-color: rgba(34,211,238,.85);
      transform:rotate(-90deg);
      opacity:.92;
    }
    .lockRing .charge{
      inset:18px;
      border-top-color: rgba(245,158,11,.95);
      opacity:.88;
    }

    /* Start overlay */
    .start{
      position:fixed; inset:0;
      z-index:50;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: radial-gradient(900px 500px at 40% 20%, rgba(34,211,238,.08), rgba(2,6,23,.92));
    }
    .startCard{
      width:min(780px, 100%);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.78);
      box-shadow:0 30px 90px rgba(0,0,0,.62);
      backdrop-filter:blur(14px);
      padding:16px;
    }
    .startHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .startHead h1{
      margin:0;
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .startHead p{
      margin:6px 0 0 0;
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:6px;
    }
    .field input, .field select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.70);
      color:var(--text);
      padding:10px 10px;
      font-size:14px;
      font-weight:800;
      outline:none;
    }
    .actions{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(15,23,42,.65);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.22);
      background:linear-gradient(180deg, rgba(34,197,94,.22), rgba(15,23,42,.75));
    }
    .btn.warn{
      border-color:rgba(245,158,11,.25);
      background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(15,23,42,.75));
    }
    .small{
      font-size:12px; color:var(--muted); font-weight:750;
      margin-top:8px;
    }

    /* End overlay */
    .end{
      position:fixed; inset:0;
      z-index:60;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      background: radial-gradient(900px 500px at 40% 20%, rgba(34,197,94,.10), rgba(2,6,23,.92));
    }
    .end.show{display:flex;}
    .endCard{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.80);
      box-shadow:0 30px 90px rgba(0,0,0,.62);
      backdrop-filter:blur(14px);
      padding:16px;
    }
    .endCard h2{margin:0 0 8px 0; font-size:18px; font-weight:950;}
    .endGrid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;}
    .stat{
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:10px;
    }
    .stat .k{color:var(--muted); font-size:12px; font-weight:900; margin-bottom:6px;}
    .stat .v{font-size:18px; font-weight:950;}
    .rankBig{
      display:flex; align-items:center; justify-content:space-between;
      margin-top:10px; gap:10px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      padding:12px;
    }
    .rankBig .g{font-size:28px; font-weight:1000; letter-spacing:.6px;}
    .rankBig .m{color:var(--muted); font-weight:850; font-size:12px; text-align:right;}
  </style>
</head>

<body>

  <!-- A-Frame scene -->
  <a-scene embedded renderer="antialias: true; alpha: true" vr-mode-ui="enabled: true">
    <a-entity id="rig">
      <a-camera id="cam" position="0 1.6 0" look-controls="enabled:true"></a-camera>
    </a-entity>

    <!-- simple sky -->
    <a-sky color="#061027"></a-sky>
  </a-scene>

  <!-- Overlay root -->
  <div class="overlay">
    <!-- Targets layer -->
    <div id="fg-layer"></div>

    <!-- HUD -->
    <div class="hud">
      <div class="topbar">
        <div class="card" style="flex:1 1 auto">
          <h4>Food Groups VR</h4>
          <div class="row">
            <span class="pill good">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b id="hud-score">0</b></span>
            <span class="pill warn">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: <b id="hud-combo">0</b></span>
            <span class="pill bad">Miss: <b id="hud-miss">0</b></span>
            <span class="pill cyan">‡πÄ‡∏ß‡∏•‡∏≤: <b id="hud-time">0</b>s</span>
            <span class="pill">‡πÇ‡∏•‡πà: <b id="hud-shield">0</b></span>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="muted">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
            <b id="hud-group" style="font-weight:1000">‚Äî</b>
          </div>
        </div>

        <div class="card" style="width:220px; flex:0 0 auto">
          <h4>Rank</h4>
          <div class="row" style="justify-content:space-between">
            <span class="pill"><b id="hud-rank">C</b></span>
            <span class="muted" style="font-size:12px" id="hud-rank-meta">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="quest">
        <div class="card">
          <h4>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h4>

          <div class="qline">
            <div id="hud-goal-label">Goal: ‚Äî</div>
            <div class="qprog"><span id="hud-goal-prog">0</span>/<span id="hud-goal-target">0</span></div>
          </div>
          <div class="bar"><i id="hud-goal-bar"></i></div>

          <div class="qline" style="margin-top:10px">
            <div id="hud-mini-label">Mini: ‚Äî</div>
            <div class="qprog">
              <span id="hud-mini-prog">0</span>/<span id="hud-mini-target">0</span>
              <span id="hud-mini-time" class="pill warn" style="display:none; padding:4px 8px; font-size:12px">‚è± <b id="hud-mini-tleft">0</b>s</span>
            </div>
          </div>
          <div class="bar subbar"><i id="hud-mini-bar"></i></div>

          <div class="qtag" style="margin-top:8px">
            <span id="hud-quest-ok">quest: ?</span>
            <span>‚Ä¢</span>
            <span id="hud-mode">mode: ‚Äî</span>
            <span>‚Ä¢</span>
            <span id="hud-diff">diff: ‚Äî</span>
          </div>
        </div>
      </div>

      <div class="coach">
        <div class="avatar">
          <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡πâ‡∏ä‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏≤‡∏° memory: coach-*.png) -->
          <img id="coach-img" src="./img/coach-neutral.png" alt="coach" />
        </div>
        <div class="bubble" id="coach-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏∞ ‚ú®</div>
      </div>
    </div>

    <!-- Reticle + lock ring -->
    <div class="reticle">
      <div id="ret" class="ret"></div>
    </div>
    <div id="lockRing" class="lockRing">
      <div id="lockProg" class="prog"></div>
      <div id="chargeProg" class="charge"></div>
    </div>
  </div>

  <!-- START overlay -->
  <div id="start" class="start">
    <div class="startCard">
      <div class="startHead">
        <div>
          <h1>üç± Food Groups VR ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</h1>
          <p>‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏à‡∏∞ Fix seed (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö School ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Logger</p>
        </div>
        <button id="btn-hide-ui" class="btn warn" type="button">üßº ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏•‡πà‡∏á (‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)</button>
      </div>

      <div class="grid">
        <div class="field">
          <label>‡πÇ‡∏´‡∏°‡∏î (run)</label>
          <select id="inp-run">
            <option value="play">play (‡∏™‡∏ô‡∏∏‡∏Å/‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô)</option>
            <option value="research">research (‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ç‡πâ‡∏°)</option>
          </select>
        </div>

        <div class="field">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å (diff)</label>
          <select id="inp-diff">
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
          </select>
        </div>

        <div class="field">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input id="inp-time" type="number" min="20" step="10" value="90" />
        </div>

        <div class="field">
          <label>Seed (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ research)</label>
          <input id="inp-seed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô CRU-P5-A-2025" />
        </div>

        <div class="field">
          <label>School</label>
          <input id="inp-school" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ)" />
        </div>

        <div class="field">
          <label>District</label>
          <select id="inp-district">
            <option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
            <option value="‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£">‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£</option>
            <option value="‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á">‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
            <option value="‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß">‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß</option>
            <option value="‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ">‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</option>
            <option value="‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å">‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å</option>
          </select>
        </div>

        <div class="field">
          <label>Class / Room</label>
          <input id="inp-class" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.5/1" />
        </div>

        <div class="field">
          <label>Student ID</label>
          <input id="inp-student" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô S001" />
        </div>
      </div>

      <div class="actions">
        <button id="btn-start" class="btn primary" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂</button>
        <button id="btn-vr" class="btn" type="button">‡πÄ‡∏Ç‡πâ‡∏≤ VR Mode ü•Ω</button>
      </div>

      <div class="small">
        ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÄ‡∏õ‡∏¥‡∏î debug logger ‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ <b>&amp;log=1</b> ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ endpoint ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á <b>window.HHA_LOG_ENDPOINT</b> ‡∏´‡∏£‡∏∑‡∏≠ meta <b>hha-log-endpoint</b>
      </div>
    </div>
  </div>

  <!-- END overlay -->
  <div id="end" class="end">
    <div class="endCard">
      <h2>üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <div class="endGrid">
        <div class="stat"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="end-score">0</div></div>
        <div class="stat"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="end-combo">0</div></div>
        <div class="stat"><div class="k">Miss</div><div class="v" id="end-miss">0</div></div>
      </div>

      <div class="rankBig">
        <div class="g" id="end-rank">C</div>
        <div class="m" id="end-meta">‚Äî</div>
      </div>

      <div class="actions" style="justify-content:space-between">
        <button id="btn-retry" class="btn primary" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üª</button>
        <button id="btn-close-end" class="btn" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const sp = new URLSearchParams(location.search);

      // ---------- dom ----------
      const elStart = document.getElementById('start');
      const elEnd   = document.getElementById('end');
      const layer   = document.getElementById('fg-layer');
      const cam     = document.getElementById('cam');

      const ret     = document.getElementById('ret');
      const lockRing= document.getElementById('lockRing');
      const lockProg= document.getElementById('lockProg');
      const chargeP = document.getElementById('chargeProg');

      const coachText = document.getElementById('coach-text');
      const coachImg  = document.getElementById('coach-img');

      // HUD ids (match hha-hud.js binder)
      const hudScore  = document.getElementById('hud-score');
      const hudCombo  = document.getElementById('hud-combo');
      const hudMiss   = document.getElementById('hud-miss');
      const hudTime   = document.getElementById('hud-time');
      const hudShield = document.getElementById('hud-shield');
      const hudGroup  = document.getElementById('hud-group');
      const hudRank   = document.getElementById('hud-rank');
      const hudRankMeta = document.getElementById('hud-rank-meta');

      const hudGoalLabel  = document.getElementById('hud-goal-label');
      const hudGoalProg   = document.getElementById('hud-goal-prog');
      const hudGoalTarget = document.getElementById('hud-goal-target');
      const hudGoalBar    = document.getElementById('hud-goal-bar');

      const hudMiniLabel  = document.getElementById('hud-mini-label');
      const hudMiniProg   = document.getElementById('hud-mini-prog');
      const hudMiniTarget = document.getElementById('hud-mini-target');
      const hudMiniBar    = document.getElementById('hud-mini-bar');
      const hudMiniTime   = document.getElementById('hud-mini-time');
      const hudMiniTLeft  = document.getElementById('hud-mini-tleft');

      const hudQuestOk = document.getElementById('hud-quest-ok');
      const hudMode    = document.getElementById('hud-mode');
      const hudDiff    = document.getElementById('hud-diff');

      // end
      const endScore = document.getElementById('end-score');
      const endCombo = document.getElementById('end-combo');
      const endMiss  = document.getElementById('end-miss');
      const endRank  = document.getElementById('end-rank');
      const endMeta  = document.getElementById('end-meta');

      // inputs
      const inpRun = document.getElementById('inp-run');
      const inpDiff= document.getElementById('inp-diff');
      const inpTime= document.getElementById('inp-time');
      const inpSeed= document.getElementById('inp-seed');
      const inpSchool = document.getElementById('inp-school');
      const inpDistrict = document.getElementById('inp-district');
      const inpClass = document.getElementById('inp-class');
      const inpStudent = document.getElementById('inp-student');

      // buttons
      const btnStart = document.getElementById('btn-start');
      const btnVR = document.getElementById('btn-vr');
      const btnRetry = document.getElementById('btn-retry');
      const btnCloseEnd = document.getElementById('btn-close-end');
      const btnHideUI = document.getElementById('btn-hide-ui');

      // ---------- init from URL ----------
      function pickParam(k, fallback){
        const v = sp.get(k);
        return (v != null && String(v).trim() !== '') ? String(v).trim() : (fallback || '');
      }
      const urlRun  = pickParam('run', 'play');
      const urlDiff = pickParam('diff', 'normal');
      const urlTime = Number(pickParam('time', '90')) || 90;
      const urlSeed = pickParam('seed', '');

      inpRun.value = (urlRun === 'research') ? 'research' : 'play';
      inpDiff.value = (['easy','normal','hard'].includes(urlDiff) ? urlDiff : 'normal');
      inpTime.value = String(Math.max(20, urlTime|0));
      inpSeed.value = urlSeed;

      // load last context from localStorage (optional)
      try{
        const j = JSON.parse(localStorage.getItem('HHA_LAST_CTX_V1')||'{}');
        if (j.school && !inpSchool.value) inpSchool.value = j.school;
        if (j.district && !inpDistrict.value) inpDistrict.value = j.district;
        if (j.className && !inpClass.value) inpClass.value = j.className;
        if (j.studentId && !inpStudent.value) inpStudent.value = j.studentId;
      }catch{}

      // ---------- bind Engine ----------
      function engine(){
        return (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
      }

      function setLoggerContext(){
        const ctx = {
          school: (inpSchool.value||'').trim(),
          district: (inpDistrict.value||'').trim(),
          className: (inpClass.value||'').trim(),
          studentId: (inpStudent.value||'').trim()
        };
        try{
          localStorage.setItem('HHA_LAST_CTX_V1', JSON.stringify(ctx));
        }catch{}

        try{
          if (window.HHA_Logger && typeof window.HHA_Logger.setContext === 'function'){
            window.HHA_Logger.setContext(ctx);
          }
        }catch{}
      }

      function startGame(){
        const eng = engine();
        if (!eng) {
          alert('GameEngine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå ./vr-groups/GameEngine.js)');
          return;
        }

        setLoggerContext();

        const runMode = (inpRun.value === 'research') ? 'research' : 'play';
        const diff = inpDiff.value || 'normal';
        const time = Math.max(20, Number(inpTime.value)||90);

        // bind layer/camera
        try{ eng.setLayerEl(layer); }catch{}
        try{ eng.setCameraEl(cam); }catch{}
        try{ eng.setTimeLeft(time); }catch{}
        try{ eng.setGaze(true); }catch{}

        // start (pass seed for research)
        const seed = (inpSeed.value||'').trim();
        const opts = { runMode };
        if (runMode === 'research' && seed) opts.seed = seed;

        hudMode.textContent = 'mode: ' + runMode;
        hudDiff.textContent = 'diff: ' + diff;

        // hide start overlay
        elStart.style.display = 'none';

        try{
          eng.start(diff, opts);
        }catch(e){
          console.error(e);
          alert('Start error: ' + (e && e.message ? e.message : e));
          elStart.style.display = '';
        }
      }

      // ---------- UI events ----------
      btnStart.addEventListener('click', startGame);
      btnVR.addEventListener('click', () => {
        const sc = document.querySelector('a-scene');
        if (sc && sc.enterVR) sc.enterVR();
      });

      btnRetry.addEventListener('click', () => {
        elEnd.classList.remove('show');
        elStart.style.display = '';
      });
      btnCloseEnd.addEventListener('click', () => {
        elEnd.classList.remove('show');
      });

      btnHideUI.addEventListener('click', ()=>{
        // hides helper texts only (light)
        const p = document.querySelector('.startHead p');
        if (p) p.style.display = (p.style.display === 'none') ? '' : 'none';
      });

      // ---------- live listeners (HUD independent) ----------
      // Coach
      window.addEventListener('hha:coach', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        if (d.text != null) coachText.textContent = String(d.text);

        // optional mood -> swap images if provided
        // mood: happy/neutral/sad/fever (optional)
        const mood = (d.mood||'').toLowerCase();
        const map = {
          happy:'./img/coach-happy.png',
          neutral:'./img/coach-neutral.png',
          sad:'./img/coach-sad.png',
          fever:'./img/coach-fever.png'
        };
        if (map[mood]) coachImg.src = map[mood];
      });

      // Score quick mirror (hha-hud.js ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
      window.addEventListener('hha:score', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        if (hudScore)  hudScore.textContent = String(d.score ?? 0);
        if (hudCombo)  hudCombo.textContent = String(d.combo ?? 0);
        if (hudMiss)   hudMiss.textContent  = String(d.misses ?? 0);
        if (hudShield) hudShield.textContent= String(d.shield ?? 0);
        if (d.fever != null) { /* Fever bar handled by FeverUI */ }
      });

      window.addEventListener('hha:time', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        if (hudTime) hudTime.textContent = String(d.left ?? 0);
      });

      // Quest update (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ HUD binder ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ element)
      window.addEventListener('quest:update', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        const ok = !!d.questOk;
        hudQuestOk.textContent = 'quest: ' + (ok ? 'OK' : 'NO');
        hudQuestOk.style.color = ok ? 'rgba(34,197,94,.92)' : 'rgba(239,68,68,.92)';

        if (d.groupLabel != null && hudGroup) hudGroup.textContent = String(d.groupLabel||'‚Äî');

        // goal
        const g = d.goal;
        if (!g){
          hudGoalLabel.textContent = 'Goal: ‚Äî';
          hudGoalProg.textContent = '0';
          hudGoalTarget.textContent = '0';
          hudGoalBar.style.width = '0%';
        } else {
          hudGoalLabel.textContent = 'Goal: ' + String(g.label||'');
          hudGoalProg.textContent = String(g.prog ?? 0);
          hudGoalTarget.textContent = String(g.target ?? 0);
          const pct = (g.target>0) ? Math.max(0, Math.min(1, (g.prog||0)/(g.target||1))) : 0;
          hudGoalBar.style.width = Math.round(pct*100) + '%';
        }

        // mini
        const m = d.mini;
        if (!m){
          hudMiniLabel.textContent = 'Mini: ‚Äî';
          hudMiniProg.textContent = '0';
          hudMiniTarget.textContent = '0';
          hudMiniBar.style.width = '0%';
          hudMiniTime.style.display = 'none';
        } else {
          hudMiniLabel.textContent = 'Mini: ' + String(m.label||'');
          hudMiniProg.textContent = String(m.prog ?? 0);
          hudMiniTarget.textContent = String(m.target ?? 0);
          const pct = (m.target>0) ? Math.max(0, Math.min(1, (m.prog||0)/(m.target||1))) : 0;
          hudMiniBar.style.width = Math.round(pct*100) + '%';

          if (m.tLeft != null && m.windowSec != null){
            hudMiniTime.style.display = '';
            hudMiniTLeft.textContent = String(m.tLeft ?? 0);
          } else {
            hudMiniTime.style.display = 'none';
          }
        }
      });

      // Rank
      window.addEventListener('hha:rank', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        const g = d.grade || 'C';
        hudRank.textContent = String(g);
        hudRankMeta.textContent = `${d.accuracy ?? 0}% ‚Ä¢ Q${d.questsPct ?? 0}% ‚Ä¢ SPS ${d.scorePerSec ?? 0}`;
      });

      // Reticle feedback
      window.addEventListener('groups:reticle', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        const st = String(d.state||'');
        ret.classList.remove('ok','miss');
        if (st === 'ok' || st === 'perfect') ret.classList.add('ok');
        if (st === 'miss') ret.classList.add('miss');
      });

      // Lock ring (progress/charge)
      window.addEventListener('groups:lock', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        if (!d.on){
          lockRing.classList.remove('on');
          lockRing.style.left = '50%';
          lockRing.style.top  = '50%';
          lockProg.style.transform = 'rotate(-90deg)';
          chargeP.style.transform  = 'rotate(-90deg)';
          return;
        }
        lockRing.classList.add('on');

        // place near target
        const x = (typeof d.x === 'number') ? d.x : (innerWidth/2);
        const y = (typeof d.y === 'number') ? d.y : (innerHeight/2);
        lockRing.style.left = Math.round(x) + 'px';
        lockRing.style.top  = Math.round(y) + 'px';

        const prog = Math.max(0, Math.min(1, Number(d.prog)||0));
        const chg  = Math.max(0, Math.min(1, Number(d.charge)||0));

        // rotate to show progress (simple)
        lockProg.style.transform = `rotate(${(-90 + prog*360)}deg)`;
        chargeP.style.transform  = `rotate(${(-90 + chg*360)}deg)`;
      });

      // Charge flash (optional)
      window.addEventListener('groups:charge', (ev)=>{
        // could add extra FX later
      });

      // End summary
      window.addEventListener('hha:end', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        endScore.textContent = String(d.scoreFinal ?? 0);
        endCombo.textContent = String(d.comboMax ?? 0);
        endMiss.textContent  = String(d.misses ?? 0);
        endRank.textContent  = String(d.grade ?? 'C');

        const g = `${d.goalsCleared ?? 0}/${d.goalsTotal ?? 0}`;
        const m = `${d.miniCleared ?? 0}/${d.miniTotal ?? 0}`;
        endMeta.textContent = `Goal ${g} ‚Ä¢ Mini ${m} ‚Ä¢ reason=${d.reason || 'end'}`;

        elEnd.classList.add('show');
      });

      // If user presses Esc / back etc: allow stop
      window.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape'){
          const eng = engine();
          try{ eng && eng.stop && eng.stop('esc'); }catch{}
          elStart.style.display = '';
        }
      });

    })();
  </script>

</body>
</html>