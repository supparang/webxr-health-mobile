<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (for camera rotation) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‚úÖ CSS ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <!-- ‚úÖ Script order (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- ‚úÖ Quest HUD binder (‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà) -->
  <script src="./vr/hha-hud-quest.js" defer></script>

  <!-- ‚úÖ Quest manager + Engine -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
</head>

<body>
  <!-- A-Frame scene (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà camera rotation) -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true; alpha: true">
    <a-entity id="camera" camera look-controls="enabled: true" position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- Main layer -->
  <div id="fg-root" class="fg-root">
    <div id="fg-layer" class="fg-layer" aria-label="playfield"></div>

    <!-- Reticle -->
    <div class="fg-reticle" id="fg-reticle" aria-hidden="true"></div>

    <!-- Top-left stats -->
    <div class="hud hud-left">
      <div class="hud-chip"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="hudScore">0</div></div>
      <div class="hud-chip"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div><div class="v" id="hudCombo">0</div></div>
      <div class="hud-chip"><div class="k">Miss</div><div class="v" id="hudMiss">0</div></div>
      <div class="hud-chip"><div class="k">‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="hudTime">0</div></div>
    </div>

    <!-- Top-right -->
    <div class="hud hud-right">
      <div class="hud-card">
        <div class="k">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        <div class="v" id="hudGroup">‚Äî</div>
      </div>

      <div class="hud-card">
        <div class="k">‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="v grade" id="hudGrade">C</div>
      </div>

      <!-- Fever UI ‡∏Ç‡∏≠‡∏á ui-fever.js ‡∏à‡∏∞‡∏°‡∏≤ bind ‡πÄ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ container ‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô) -->
      <div class="fever-wrap">
        <div id="feverBarHost"></div>
      </div>
    </div>

    <!-- Bottom-left Quest panel -->
    <div class="quest-panel">
      <div class="quest-title">
        <div class="q-head">GOAL</div>
        <div class="q-meta" id="qGoalMeta">0/0</div>
      </div>
      <div class="q-row">
        <div class="q-label" id="qGoalLabel">‚Äî</div>
        <div class="q-right" id="qGoalProg">0%</div>
      </div>
      <div class="q-bar"><div class="q-bar-fill" id="qGoalBar"></div></div>

      <div class="quest-title mt">
        <div class="q-head">üß© MINI</div>
        <div class="q-meta" id="qMiniMeta">0/0</div>
      </div>
      <div class="q-row">
        <div class="q-label" id="qMiniLabel">‚Äî</div>
        <div class="q-right" id="qMiniProg">0%</div>
      </div>
      <div class="q-bar"><div class="q-bar-fill" id="qMiniBar"></div></div>

      <div class="q-warn" id="qWarn" style="display:none;">‚ö†Ô∏è QUEST ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ groups-quests.js / hha-hud-quest.js)</div>
    </div>

    <!-- Coach / tips -->
    <div class="coach" id="hudCoach">
      <div class="coach-title">Coach</div>
      <div class="coach-text" id="hudCoachText">‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ ‚ú®</div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn ghost" id="btnGaze">Gaze: ON</button>
      <button class="btn danger" id="btnStop">STOP</button>
      <button class="btn" id="btnVR">VR</button>
    </div>

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay">
      <div class="overlay-card">
        <div class="overlay-title">Food Groups VR</div>
        <div class="overlay-sub" id="startSub">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>

        <div class="overlay-grid">
          <div class="row">
            <span class="pill" id="pillMode">MODE: PLAY</span>
            <span class="pill" id="pillDiff">DIFF: EASY</span>
            <span class="pill" id="pillTime">TIME: 90s</span>
          </div>

          <div class="row btnrow">
            <button class="btn big" id="btnStartPlay">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô (Play)</button>
            <button class="btn big ghost" id="btnStartResearch">üß™ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (Research)</button>
          </div>

          <div class="overlay-note">
            Tip: ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß ‚Ä¢ ‡∏à‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ Lock ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î + Charge + Chain
          </div>
        </div>
      </div>
    </div>

    <!-- End overlay (‡∏Ç‡∏≠‡∏á Groups ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÑ‡∏°‡πà‡∏õ‡∏ô Water) -->
    <div class="overlay" id="endOverlay" style="display:none;">
      <div class="overlay-card end">
        <div class="overlay-title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
        <div class="overlay-sub" id="endReason">‚Äî</div>

        <div class="end-grid">
          <div class="end-card"><div class="k">Score</div><div class="v" id="endScore">0</div></div>
          <div class="end-card"><div class="k">Combo Best</div><div class="v" id="endCombo">0</div></div>
          <div class="end-card"><div class="k">Miss</div><div class="v" id="endMiss">0</div></div>
          <div class="end-card"><div class="k">Quests</div><div class="v" id="endQuest">0%</div></div>
          <div class="end-card"><div class="k">Accuracy</div><div class="v" id="endAcc">0%</div></div>
          <div class="end-card"><div class="k">Grade</div><div class="v grade" id="endGrade">C</div></div>
        </div>

        <div class="row btnrow">
          <button class="btn big ghost" id="btnCloseEnd">‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ</button>
          <button class="btn big" id="btnReplay">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Boot -->
  <script>
  (function(){
    'use strict';

    const $ = (id)=>document.getElementById(id);
    const sp = new URLSearchParams(location.search);

    const diff = (sp.get('diff')||'easy').toLowerCase();
    const timeSec = Math.max(10, parseInt(sp.get('time')||'90',10)||90);
    const run = (sp.get('run')||'play').toLowerCase();

    const startOverlay = $('startOverlay');
    const endOverlay = $('endOverlay');

    $('pillMode').textContent = 'MODE: ' + (run==='research'?'RESEARCH':'PLAY');
    $('pillDiff').textContent = 'DIFF: ' + diff.toUpperCase();
    $('pillTime').textContent = 'TIME: ' + timeSec + 's';

    const engine = (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
    const layerEl = $('fg-layer');
    const camEl = $('camera');

    if (engine){
      engine.setLayerEl(layerEl);
      engine.setCameraEl(camEl);
      engine.setTimeLeft(timeSec);
    }

    // HUD basic bindings (score/time/coach/rank)
    window.addEventListener('hha:score', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if ($('hudScore')) $('hudScore').textContent = (d.score|0);
      if ($('hudCombo')) $('hudCombo').textContent = (d.combo|0);
      if ($('hudMiss')) $('hudMiss').textContent  = (d.misses|0);
    });

    window.addEventListener('hha:time', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if ($('hudTime')) $('hudTime').textContent = (d.left|0);
    });

    window.addEventListener('hha:coach', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      const t = String(d.text||'');
      if (t && $('hudCoachText')) $('hudCoachText').textContent = t;
    });

    window.addEventListener('hha:rank', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if ($('hudGrade')) $('hudGrade').textContent = String(d.grade||'C');
    });

    window.addEventListener('quest:update', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if ($('hudGroup')) $('hudGroup').textContent = d.groupLabel ? String(d.groupLabel) : '‚Äî';
    });

    // Reticle feedback
    const ret = $('fg-reticle');
    function pulse(cls){
      if (!ret) return;
      ret.classList.remove('ok','miss','perfect');
      ret.classList.add(cls);
      setTimeout(()=>{ try{ ret.classList.remove(cls); }catch{} }, 140);
    }
    window.addEventListener('groups:reticle', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if (d.state==='miss') pulse('miss');
      else if (d.state==='perfect') pulse('perfect');
      else pulse('ok');
    });

    // Controls
    let gazeOn = true;
    $('btnGaze').addEventListener('click', ()=>{
      gazeOn = !gazeOn;
      $('btnGaze').textContent = 'Gaze: ' + (gazeOn?'ON':'OFF');
      try{ engine && engine.setGaze(gazeOn); }catch{}
    });

    $('btnStop').addEventListener('click', ()=>{
      try{ engine && engine.stop('stop'); }catch{}
    });

    $('btnVR').addEventListener('click', ()=>{
      try{
        const scene = document.querySelector('a-scene');
        if (scene && scene.enterVR) scene.enterVR();
      }catch{}
    });

    function startGame(mode){
      if (!engine) return;
      $('startOverlay').style.display = 'none';
      $('endOverlay').style.display = 'none';

      // seed: research fixed; play ignore
      const seed = sp.get('seed') || ('school|' + diff + '|' + timeSec);

      engine.setTimeLeft(timeSec);
      engine.start(diff, {
        runMode: mode,
        seed: seed
      });
    }

    $('btnStartPlay').addEventListener('click', ()=>startGame('play'));
    $('btnStartResearch').addEventListener('click', ()=>startGame('research'));

    // Auto start if url says run=play/research and autostart=1
    if ((sp.get('autostart')||'0')==='1'){
      startGame(run==='research'?'research':'play');
    }

    // End overlay
    function pct(n){ n=Number(n)||0; return Math.max(0,Math.min(100,Math.round(n)))+'%'; }
    window.addEventListener('hha:end', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('endOverlay').style.display = '';
      $('endReason').textContent = (d.reason==='time_up') ? '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°';

      $('endScore').textContent = (d.scoreFinal|0);
      $('endCombo').textContent = (d.comboMax|0);
      $('endMiss').textContent  = (d.misses|0);
      $('endGrade').textContent = String(d.grade||'C');

      // pull latest rank metrics if available
      // (GameEngine emits hha:rank each second, so values should exist)
      let lastRank = null;
      window.addEventListener('hha:rank', (e)=>{ lastRank = (e && e.detail) ? e.detail : null; }, { once:true });

      // fallback compute from detail if present
      const qp  = (typeof d.questsPct === 'number') ? d.questsPct : null;
      const acc = (typeof d.accuracy === 'number') ? d.accuracy : null;

      $('endQuest').textContent = qp!=null ? pct(qp*100) : '‚Äî';
      $('endAcc').textContent   = acc!=null ? pct(acc*100) : '‚Äî';
    });

    $('btnCloseEnd').addEventListener('click', ()=>{ $('endOverlay').style.display='none'; });
    $('btnReplay').addEventListener('click', ()=>{
      $('endOverlay').style.display='none';
      $('startOverlay').style.display='';
    });

  })();
  </script>
</body>
</html>
