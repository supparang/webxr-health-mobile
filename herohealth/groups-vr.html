<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION FULL HTML (FIX-ALL)
‚úÖ Loads: A-Frame + Particles + FeverUI + HUD + GroupsQuest + GameEngine
‚úÖ Correct DOM: #fg-layer (targets), #hud-*, #endSummary
‚úÖ Supports URL params: diff, time, run(play|research), seed
‚úÖ Start overlay + tap to start (mobile-friendly) + VR ready
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX (IIFE) -->
  <script src="./vr/particles.js" defer></script>

  <!-- Fever UI (IIFE) -->
  <script src="./vr/ui-fever.js" defer></script>

  <!-- Global HUD binder (IIFE) -->
  <script src="./vr/hha-hud.js" defer></script>

  <!-- (optional) Cloud logger -->
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.76);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --junk:#ef4444;
      --accent:#60a5fa;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;

      /* targets */
      --target-font: 64px;
      --target-blur: 10px;
      --target-glow: 0 0 22px rgba(34,197,94,.38);
      --target-glow-junk: 0 0 22px rgba(239,68,68,.28);
    }

    html,body{ height:100%; background:var(--bg); color:var(--text); margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    /* A-Frame full screen */
    #sceneWrap{ position:fixed; inset:0; z-index:0; }
    a-scene{ width:100%; height:100%; }

    /* Gameplay layer (DOM targets) */
    #fg-layer{
      position:fixed; inset:0;
      z-index:4;
      pointer-events:auto;
      touch-action: manipulation;
      overflow:hidden;
    }

    /* Targets: positioned via CSS vars --x/--y/--s */
    .fg-target{
      position:absolute;
      left: var(--x, 50%);
      top:  var(--y, 52%);
      transform: translate(-50%,-50%) scale(var(--s,1));
      width: 132px; height:132px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.10), rgba(2,6,23,.10));
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      filter: drop-shadow(0 0 var(--target-blur) rgba(0,0,0,.35));
      user-select:none;
      cursor:pointer;
      will-change: transform, left, top;
      transition: transform .12s ease, opacity .12s ease;
      font-size: var(--target-font);
      line-height:1;
    }
    .fg-target::after{
      content:'';
      position:absolute; inset:-8px;
      border-radius:999px;
      background: radial-gradient(closest-side, rgba(255,255,255,.10), transparent 70%);
      opacity:.7;
      pointer-events:none;
    }
    .fg-good{ box-shadow: var(--shadow), var(--target-glow); border-color: rgba(34,197,94,.35); }
    .fg-junk{ box-shadow: var(--shadow), var(--target-glow-junk); border-color: rgba(239,68,68,.28); }
    .fg-boss{ border-width:2px; }
    .fg-decoy{ border-color: rgba(245,158,11,.40) !important; box-shadow: var(--shadow), 0 0 22px rgba(245,158,11,.22); }
    .fg-target.spawn{ opacity:0; transform: translate(-50%,-50%) scale(.65); }
    .fg-target.show{ opacity:1; transform: translate(-50%,-50%) scale(var(--s,1)); }
    .fg-target.hit{ opacity:0; transform: translate(-50%,-50%) scale(.82); }
    .fg-target.out{ opacity:.0; transform: translate(-50%,-50%) scale(.82); }

    /* boss hp bar */
    .bossbar{
      position:absolute; left:10px; right:10px; bottom:10px;
      height:10px; border-radius:999px;
      background: rgba(148,163,184,.14);
      overflow:hidden;
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(245,158,11,.9));
    }

    /* Afterimage */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      opacity:.0;
      animation: ai .42s ease forwards;
      z-index:5;
    }
    .fg-afterimage-inner{
      font-size: 56px;
      filter: blur(0px);
      transform: translate(-50%,-50%);
      opacity:.9;
    }
    .fg-afterimage.a1 .fg-afterimage-inner{ opacity:.75; filter: blur(.2px); }
    .fg-afterimage.a2 .fg-afterimage-inner{ opacity:.55; filter: blur(.6px); }
    @keyframes ai{
      0%{ opacity:.0; }
      10%{ opacity:.9; }
      100%{ opacity:0; transform: translate3d(0,-10px,0); }
    }

    /* HUD */
    #hud{
      position:fixed; inset:0;
      z-index:6;
      pointer-events:none;
    }

    .hud-top{
      position:absolute; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:stretch; justify-content:space-between;
    }
    .hud-card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      min-width: 122px;
    }
    .hud-row{ display:flex; gap:10px; align-items:center; }
    .hud-k{ font-size:12px; color:var(--muted); }
    .hud-v{ font-weight:800; font-size:18px; }

    .hud-mid{
      position:absolute; left:12px; right:12px; top:86px;
      display:flex; gap:10px;
    }
    .hud-wide{ flex: 1; }

    #hudGroupLabel{ font-weight:900; font-size:14px; letter-spacing:.2px; }
    #hudGoal{ font-size:13px; color:var(--text); margin-top:6px; }
    #hudMini{ font-size:13px; color:var(--text); margin-top:6px; }
    .mini-timer{ color:#fbbf24; font-weight:800; }

    /* Reticle hint */
    #reticle{
      position:fixed;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index:5;
      pointer-events:none;
      opacity:.55;
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,.38);
      box-shadow: 0 0 18px rgba(96,165,250,.15);
    }
    .ret-ok{ animation: popok .16s ease; }
    .ret-miss{ animation: popmiss .22s ease; }
    .ret-perfect{ animation: popperf .20s ease; }
    @keyframes popok{ 0%{ transform:translate(-50%,-50%) scale(1); } 100%{ transform:translate(-50%,-50%) scale(1.25); } }
    @keyframes popmiss{ 0%{ transform:translate(-50%,-50%) scale(1); } 100%{ transform:translate(-50%,-50%) scale(1.5); opacity:.35; } }
    @keyframes popperf{ 0%{ transform:translate(-50%,-50%) scale(1); } 100%{ transform:translate(-50%,-50%) scale(1.7); opacity:.75; } }

    /* Start overlay */
    #startOverlay{
      position:fixed; inset:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      background: radial-gradient(900px 700px at 50% 35%, rgba(96,165,250,.18), rgba(2,6,23,.92) 58%, rgba(2,6,23,.98));
    }
    .start-card{
      width:min(540px, 96vw);
      border-radius: 26px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.74);
      box-shadow: 0 24px 90px rgba(0,0,0,.55);
      padding: 18px 16px 16px;
      backdrop-filter: blur(10px);
    }
    .start-title{ font-size:20px; font-weight:900; margin:0 0 6px; }
    .start-sub{ color:var(--muted); margin:0 0 14px; font-size:13px; line-height:1.45; }
    .pill-row{ display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 14px; }
    .pill{
      font-size:12px; color: var(--text);
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      padding:6px 10px; border-radius:999px;
    }
    .btn-row{ display:flex; gap:10px; }
    .btn{
      pointer-events:auto;
      flex:1;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(96,165,250,.16);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.secondary{ background: rgba(148,163,184,.10); }
    .hint{ margin-top:10px; font-size:12px; color: var(--muted); }

    /* End summary */
    #endSummary{
      position:fixed; inset:0;
      z-index:12;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      background: rgba(2,6,23,.86);
      backdrop-filter: blur(10px);
    }
    .end-card{
      width:min(520px, 96vw);
      border-radius: 26px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.80);
      box-shadow: 0 24px 90px rgba(0,0,0,.55);
      padding: 18px 16px 16px;
    }
    .end-title{ font-size:20px; font-weight:900; margin:0 0 6px; }
    .end-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    .end-item{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.58);
      border-radius: 16px;
      padding:10px 12px;
    }
    .end-k{ font-size:12px; color:var(--muted); }
    .end-v{ font-size:18px; font-weight:900; margin-top:4px; }
    .end-actions{ display:flex; gap:10px; margin-top:12px; }
    .end-actions .btn{ flex:1; }

    /* small */
    @media (max-width:420px){
      :root{ --target-font: 56px; }
      .hud-v{ font-size:16px; }
      .hud-card{ padding:9px 10px; }
      .hud-mid{ top:84px; }
    }
  </style>
</head>

<body>

  <!-- A-Frame background (simple sky) -->
  <div id="sceneWrap">
    <a-scene embedded vr-mode-ui="enabled: true" renderer="colorManagement:true">
      <a-sky color="#050b18"></a-sky>
      <a-entity id="rig" position="0 1.6 0">
        <a-camera id="cam" wasd-controls-enabled="false" look-controls="enabled: true"></a-camera>
      </a-entity>
    </a-scene>
  </div>

  <!-- DOM target layer -->
  <div id="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- Reticle -->
  <div id="reticle"></div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-top">
      <div class="hud-card">
        <div class="hud-k">‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="hud-v"><span id="hudTime">--</span>s</div>
      </div>
      <div class="hud-card">
        <div class="hud-k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div class="hud-v" id="hudScore">0</div>
      </div>
      <div class="hud-card">
        <div class="hud-k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
        <div class="hud-v" id="hudCombo">0</div>
      </div>
      <div class="hud-card">
        <div class="hud-k">Miss</div>
        <div class="hud-v" id="hudMiss">0</div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="hud-card hud-wide">
        <div id="hudGroupLabel">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: --</div>
        <div id="hudGoal">Goal: --</div>
        <div id="hudMini">Mini: --</div>
      </div>
      <div class="hud-card" style="min-width:120px;">
        <div class="hud-k">‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="hud-v" id="hudGrade">C</div>
      </div>
    </div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay">
    <div class="start-card">
      <h1 class="start-title">üçΩÔ∏è Food Groups VR</h1>
      <p class="start-sub">
        ‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Äú‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà ‚Äî ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏¢‡∏∞/‡∏ö‡∏≠‡∏™/Decoy!<br/>
        ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô: ‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à + ‡∏°‡∏µ Rush/Wave/Chain/Charge<br/>
        ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢: ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà + ‡πÉ‡∏ä‡πâ Seed ‡πÑ‡∏î‡πâ
      </p>
      <div class="pill-row">
        <div class="pill">diff: <b id="pillDiff">normal</b></div>
        <div class="pill">time: <b id="pillTime">60</b>s</div>
        <div class="pill">run: <b id="pillRun">play</b></div>
        <div class="pill">seed: <b id="pillSeed">-</b></div>
      </div>
      <div class="btn-row">
        <button class="btn" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn secondary" id="btnStartResearch">‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢)</button>
      </div>
      <div class="hint">Tip: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÉ‡∏Å‡∏•‡πâ ‡πÜ / ‡∏à‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ Lock-on + Burst</div>
    </div>
  </div>

  <!-- End summary -->
  <div id="endSummary">
    <div class="end-card">
      <div class="end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚ú®</div>
      <div class="end-grid">
        <div class="end-item"><div class="end-k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="end-v" id="endScore">0</div></div>
        <div class="end-item"><div class="end-k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="end-v" id="endComboMax">0</div></div>
        <div class="end-item"><div class="end-k">Miss</div><div class="end-v" id="endMiss">0</div></div>
        <div class="end-item"><div class="end-k">‡πÄ‡∏Å‡∏£‡∏î</div><div class="end-v" id="endGrade">C</div></div>
        <div class="end-item"><div class="end-k">Goals</div><div class="end-v" id="endGoals">0/0</div></div>
        <div class="end-item"><div class="end-k">Minis</div><div class="end-v" id="endMinis">0/0</div></div>
      </div>
      <div class="end-actions">
        <button class="btn" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn secondary" id="btnCloseEnd">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Quest Manager (IIFE) -->
  <script src="./vr-groups/groups-quests.js"></script>

  <!-- ‚úÖ Engine (IIFE) -->
  <script src="./vr-groups/GameEngine.js"></script>

  <!-- Boot -->
  <script>
    (function(){
      'use strict';

      const qs = new URLSearchParams(location.search);
      const diff = (qs.get('diff') || 'normal').toLowerCase();
      const time = Math.max(10, parseInt(qs.get('time') || '60', 10) || 60);
      const run = (qs.get('run') || 'play').toLowerCase();
      const seed = qs.get('seed') || '';

      const $ = (id)=>document.getElementById(id);

      // pills
      $('pillDiff').textContent = diff;
      $('pillTime').textContent = String(time);
      $('pillRun').textContent  = run;
      $('pillSeed').textContent = seed ? seed : '-';

      // layer/cam
      const layer = $('fg-layer');
      const camEl = document.querySelector('#cam');

      // sanity: engine present?
      if (!window.GroupsVR || !window.GroupsVR.GameEngine){
        console.error('[FoodGroupsVR] GameEngine not found. Check ./vr-groups/GameEngine.js path');
      } else {
        window.GroupsVR.GameEngine.setLayerEl(layer);
        window.GroupsVR.GameEngine.setCameraEl(camEl);
        window.GroupsVR.GameEngine.setTimeLeft(time);
        window.GroupsVR.GameEngine.setGaze(true);
      }

      // minimal HUD fallback (in case global hha-hud.js not present)
      function bindFallbackHud(){
        window.addEventListener('hha:time', (e)=>{
          const left = (e.detail && e.detail.left) | 0;
          $('hudTime').textContent = String(left);
        });
        window.addEventListener('hha:score', (e)=>{
          const d = e.detail || {};
          $('hudScore').textContent = String(d.score|0);
          $('hudCombo').textContent = String(d.combo|0);
          $('hudMiss').textContent  = String(d.misses|0);
        });
        window.addEventListener('quest:update', (e)=>{
          const d = e.detail || {};
          $('hudGroupLabel').textContent = d.groupLabel ? ('‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + d.groupLabel) : '‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: --';
          $('hudGoal').textContent = d.goal ? (`Goal: ${d.goal.label} (${d.goal.prog||0}/${d.goal.target||0})`) : 'Goal: --';
          if (d.mini){
            const tleft = (d.mini.tLeft != null) ? ` <span class="mini-timer">(${d.mini.tLeft}s)</span>` : '';
            $('hudMini').innerHTML = `Mini: ${d.mini.label} (${d.mini.prog||0}/${d.mini.target||0})${tleft}`;
          } else {
            $('hudMini').textContent = 'Mini: --';
          }
        });
        window.addEventListener('hha:rank', (e)=>{
          const d = e.detail || {};
          $('hudGrade').textContent = d.grade || 'C';
        });
        window.addEventListener('groups:reticle', (e)=>{
          const st = (e.detail && e.detail.state) || '';
          const r = $('reticle');
          r.classList.remove('ret-ok','ret-miss','ret-perfect');
          if (st==='ok') r.classList.add('ret-ok');
          if (st==='miss') r.classList.add('ret-miss');
          if (st==='perfect') r.classList.add('ret-perfect');
        });
      }
      bindFallbackHud();

      // end summary
      function showEnd(d){
        $('endScore').textContent = String(d.scoreFinal|0);
        $('endComboMax').textContent = String(d.comboMax|0);
        $('endMiss').textContent = String(d.misses|0);
        $('endGrade').textContent = String(d.grade||'C');

        $('endGoals').textContent = `${d.goalsCleared||0}/${d.goalsTotal||0}`;
        $('endMinis').textContent = `${d.miniCleared||0}/${d.miniTotal||0}`;

        $('endSummary').style.display = 'flex';
      }
      window.addEventListener('hha:end', (e)=>{
        showEnd(e.detail || {});
      });

      function hideStart(){
        $('startOverlay').style.display = 'none';
      }
      function startGame(mode){
        if (!window.GroupsVR || !window.GroupsVR.GameEngine) return;

        hideStart();

        // set time again (in case user clicked after some delay)
        window.GroupsVR.GameEngine.setTimeLeft(time);

        const runMode = (mode === 'research') ? 'research' : 'play';
        const useSeed = seed || '';

        window.GroupsVR.GameEngine.start(diff, {
          runMode,
          seed: useSeed,
          layerEl: layer
        });
      }

      // buttons
      $('btnStart').addEventListener('click', ()=> startGame('play'));
      $('btnStartResearch').addEventListener('click', ()=> startGame('research'));

      $('btnReplay').addEventListener('click', ()=>{
        $('endSummary').style.display = 'none';
        // restart same mode (use URL run if set)
        startGame(run === 'research' ? 'research' : 'play');
      });
      $('btnCloseEnd').addEventListener('click', ()=>{
        $('endSummary').style.display = 'none';
      });

      // allow tap anywhere on overlay to start (mobile)
      $('startOverlay').addEventListener('click', (ev)=>{
        // ignore if clicked a button (buttons already handle)
        const t = ev.target;
        if (t && t.closest && t.closest('button')) return;
        startGame(run === 'research' ? 'research' : 'play');
      });

    })();
  </script>

</body>
</html>