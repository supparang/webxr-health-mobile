<!-- === C: /herohealth/groups-vr.html ===
GroupsVR Launcher ‚Äî AUTO DETECT + TAP TO START
‚úÖ Auto decide view: pc / mobile / vr / cvr (best-effort)
‚úÖ One tap required (policy) then redirect to /vr-groups/groups-vr.html
‚úÖ Preserves query: run/diff/style/time/seed/ai/hub/log + research ctx passthrough
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GroupsVR</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#020617; --text:#e5e7eb; --muted:#94a3b8;
      --panel: rgba(2,6,23,.78); --stroke: rgba(148,163,184,.18);
      --accent:#22c55e; --radius:22px;
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui; }
    .wrap{ height:100%; display:flex; align-items:center; justify-content:center; padding:18px; }
    .card{
      width:min(560px, 100%);
      border-radius: var(--radius);
      background: var(--panel);
      border:1px solid var(--stroke);
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      padding:16px;
    }
    .title{ font-size:22px; font-weight:1000; }
    .sub{ margin-top:8px; color:var(--muted); font-weight:800; font-size:13px; line-height:1.35; }
    .grid2{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .stat{ padding:12px; border-radius:18px; background: rgba(15,23,42,.62); border:1px solid rgba(148,163,184,.14); }
    .k{ font-weight:900; font-size:12px; color:var(--muted); }
    .v{ margin-top:4px; font-weight:1000; font-size:18px; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .btn{
      flex:1 1 auto;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.65);
      color:var(--text);
      font-weight:1000;
      padding:12px;
      cursor:pointer;
    }
    .btnStrong{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.35); }
    .note{ margin-top:10px; font-size:12px; color:var(--muted); font-weight:800; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">ü•¶ Food Groups VR</div>
      <div class="sub">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á/VR ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
      </div>

      <div class="grid2">
        <div class="stat"><div class="k">VIEW (auto)</div><div class="v" id="vView">‚Ä¶</div></div>
        <div class="stat"><div class="k">MODE</div><div class="v" id="vMode">‚Ä¶</div></div>
        <div class="stat"><div class="k">DIFF</div><div class="v" id="vDiff">‚Ä¶</div></div>
        <div class="stat"><div class="k">TIME</div><div class="v" id="vTime">‚Ä¶</div></div>
      </div>

      <div class="row">
        <button class="btn btnStrong" id="btnStart" type="button">‚ñ∂ TAP TO START</button>
        <button class="btn" id="btnHub" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" id="note">Tip: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Cardboard ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö ...?cardboard=1 ‡∏à‡∏≤‡∏Å HUB</div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const WIN = window;
  const $ = (id)=>DOC.getElementById(id);
  const qs=(k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } };

  function isMobile(){
    const ua = navigator.userAgent || '';
    const touch = ('ontouchstart' in WIN) || (navigator.maxTouchPoints>0);
    return touch && /Android|iPhone|iPad|Mobile/i.test(ua);
  }

  async function xrVrSupported(){
    try{
      if (!navigator.xr || !navigator.xr.isSessionSupported) return false;
      return await navigator.xr.isSessionSupported('immersive-vr');
    }catch(_){ return false; }
  }

  // best-effort detect:
  // - if ?cardboard=1 on mobile => cvr
  // - else if xr immersive-vr supported => vr
  // - else if mobile => mobile
  // - else => pc
  async function detectView(){
    const cb = String(qs('cardboard','0')||'0');
    if (cb==='1' || cb==='true') return 'cvr';

    const mob = isMobile();
    const xr = await xrVrSupported();
    if (xr) return 'vr';
    if (mob) return 'mobile';
    return 'pc';
  }

  function buildRunUrl(view){
    // ‚úÖ RUN is under /herohealth/vr-groups/groups-vr.html
    const u = new URL('./vr-groups/groups-vr.html', location.href);

    // required params
    u.searchParams.set('view', view);

    // passthrough common params (if any)
    const pass = ['run','diff','style','time','seed','ai','hub','log','studyId','phase','conditionGroup','sessionOrder','blockLabel','siteCode','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel'];
    const sp = new URL(location.href).searchParams;
    pass.forEach((k)=>{
      const v = sp.get(k);
      if (v!=null && v!=='') u.searchParams.set(k, v);
    });

    // defaults if missing
    if (!u.searchParams.get('run'))  u.searchParams.set('run','play');
    if (!u.searchParams.get('diff')) u.searchParams.set('diff','easy');
    if (!u.searchParams.get('time')) u.searchParams.set('time','90');
    if (!u.searchParams.get('style'))u.searchParams.set('style','feel');
    if (!u.searchParams.get('seed')) u.searchParams.set('seed', String(Date.now()));

    return u.toString();
  }

  function goHub(){
    const hub = String(qs('hub','')||'').trim();
    if (hub) location.href = hub;
    else history.back();
  }

  function tryUnlock(){
    try{
      const a = DOC.createElement('audio');
      a.src = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA';
      a.volume = 0;
      a.play().then(()=>{ try{ a.pause(); }catch(_){} }).catch(()=>{});
    }catch(_){}
    try{
      const AC = WIN.AudioContext || WIN.webkitAudioContext;
      if (AC){
        const ctx = new AC();
        ctx.resume && ctx.resume().catch(()=>{});
      }
    }catch(_){}
  }

  // init labels
  (async function init(){
    const view = await detectView();
    const run  = String(qs('run','play')||'play').toUpperCase();
    const diff = String(qs('diff','easy')||'easy').toUpperCase();
    const time = String(qs('time','90')||'90');

    $('vView').textContent = view.toUpperCase();
    $('vMode').textContent = run;
    $('vDiff').textContent = diff;
    $('vTime').textContent = time;

    $('btnStart').addEventListener('click', ()=>{
      tryUnlock();
      location.href = buildRunUrl(view);
    });

    $('btnHub').addEventListener('click', goHub);
  })();
})();
</script>
</body>
</html>