<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run (PC/Mobile/Cardboard)
‚úÖ HHA Standard layers + playLayer
‚úÖ vr-ui.js (Enter VR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot)
‚úÖ PATCH: lockPx tuned for mobile/cVR (aim assist radius)
‚úÖ PATCH: effects-pack restored (groups:hit)
‚úÖ Tap-to-start (no menu) for mobile autoplay restrictions
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame: minimal scene for WebXR Enter VR reliability (kept behind DOM) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    /* Tap overlay (super light) */
    #tapToStart{
      position: fixed;
      inset: 0;
      z-index: 80;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--sat) + 20px) calc(var(--sar) + 16px) calc(var(--sab) + 20px) calc(var(--sal) + 16px);
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(8px);
    }
    #tapToStart.hidden{ display:none; }
    #tapToStart .box{
      width: min(720px, 100%);
      border-radius: 22px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.82);
      box-shadow: 0 18px 60px rgba(0,0,0,.42);
      padding: 14px;
      text-align:center;
    }
    #tapToStart .h1{
      font-weight: 1200;
      font-size: 18px;
      margin: 2px 0 6px;
    }
    #tapToStart .p{
      font-weight: 950;
      font-size: 13px;
      line-height: 1.35;
      color: rgba(229,231,235,.86);
      margin: 0 0 12px;
    }
    #tapToStart .btn{
      appearance:none;
      width: 100%;
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.16);
      color: #e5e7eb;
      font-weight: 1100;
      cursor:pointer;
      user-select:none;
    }
    #tapToStart .note{
      margin-top: 10px;
      font-weight: 900;
      font-size: 12px;
      color: rgba(229,231,235,.75);
      line-height: 1.35;
    }
  </style>
</head>

<body class="view-mobile">

  <!-- XR scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled:false" renderer="colorManagement:true; physicallyCorrectLights:true;">
    <a-entity position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- ===== HUD ===== -->
  <header class="hud" aria-hidden="true">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">SCORE</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span class="val" id="hudCombo">0</span></div>
      <div class="pill"><span class="lbl">MISS</span><span class="val" id="hudMiss">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">TIME</span><span class="val" id="hudTime">90</span></div>
      <div class="pill"><span class="lbl">ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">RANK</span><span class="val" id="hudRank">D</span></div>
    </div>
  </header>

  <!-- ===== Quest ===== -->
  <section class="questTop" aria-hidden="true">
    <article class="questCard">
      <div class="qTitle">
        <div id="goalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: ‡∏´‡∏°‡∏π‡πà 1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</div>
        <div class="tag" id="goalTag">GOAL</div>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">0 / 12</div>
    </article>

    <article class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI: ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        <div class="tag" id="miniTag">MINI</div>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">0 / 5</div>
    </article>
  </section>

  <!-- ===== Big Banner ===== -->
  <div class="bigBanner hidden tone-neutral" id="bigBanner" aria-hidden="true">
    <div class="bigBannerText" id="bigBannerText">‡∏û‡∏£‡πâ‡∏≠‡∏°!</div>
  </div>

  <!-- ===== Play Layer (targets spawn here) ===== -->
  <main class="playLayer" id="playLayer" aria-label="play layer"></main>

  <!-- ===== Power ===== -->
  <section class="powerWrap" aria-hidden="true">
    <div class="powerCard">
      <div class="pHead" id="powerTitle">POWER: ‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerSub">0 / 8</div>
    </div>
  </section>

  <!-- ===== Coach ===== -->
  <section class="coachWrap" aria-hidden="true">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" src="../img/coach-neutral.png" alt="coach"/>
      <div class="coachBubble">
        <div class="coachName" id="coachName">Coach</div>
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üéØ</div>
      </div>
    </div>
  </section>

  <!-- ===== End/Calibration overlays (optional placeholders) ===== -->
  <section class="overlay hidden" id="overlayEnd" aria-hidden="true">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>
      <div class="grid2" id="endGrid"></div>
      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div class="note" style="margin-top:10px;" id="endNote">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </section>

  <!-- ===== Tap to Start (NO menu) ===== -->
  <section id="tapToStart">
    <div class="box">
      <div class="h1">Food Groups VR</div>
      <div class="p">‡πÅ‡∏ï‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ gesture ‡∏Å‡πà‡∏≠‡∏ô)</div>
      <button class="btn" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢</button>
      <div class="note">
        ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á<br/>
        Aim Assist ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ
      </div>
    </div>
  </section>

  <script>
  (function(){
    'use strict';
    const WIN = window, DOC = document;

    const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
    const clamp = (v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));

    // ---- View detect (pc / mobile / vr / cvr) ----
    function detectView(){
      const v = String(qs('view','')||'').toLowerCase().trim();
      if(v) return v;

      // If WebXR & running in headset, pages often have "immersive" later; keep simple UA fallback
      const ua = (navigator.userAgent||'').toLowerCase();
      const isMobile = /android|iphone|ipad|ipod/.test(ua);
      return isMobile ? 'mobile' : 'pc';
    }

    function applyViewClass(view){
      DOC.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      const v = (view==='cvr') ? 'view-cvr'
              : (view==='vr')  ? 'view-vr'
              : (view==='pc')  ? 'view-pc' : 'view-mobile';
      DOC.body.classList.add(v);
    }

    const VIEW = detectView();
    applyViewClass(VIEW);

    // ---- PATCH: lockPx tuned (mobile/cVR stronger) ----
    // You can override by URL: ?lockPx=48
    function tunedLockPx(view){
      // "‡∏™‡∏∏‡∏î" ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏ô‡∏î‡∏π‡∏î‡∏ú‡∏¥‡∏î‡πÄ‡∏õ‡πâ‡∏≤:
      // mobile: 44  | cvr: 52 | vr: 34 | pc: 28
      if(view === 'cvr') return 52;
      if(view === 'mobile') return 44;
      if(view === 'vr') return 34;
      return 28;
    }
    const lockOverride = qs('lockPx', null);
    const LOCKPX = clamp(lockOverride != null ? Number(lockOverride) : tunedLockPx(VIEW), 0, 96);

    // vr-ui.js reads this config
    WIN.HHA_VRUI_CONFIG = Object.assign({}, WIN.HHA_VRUI_CONFIG||{}, {
      lockPx: LOCKPX,
      cooldownMs: 90
    });

    // ---- (Optional) show banner helper ----
    const bannerEl = DOC.getElementById('bigBanner');
    const bannerText = DOC.getElementById('bigBannerText');
    let _bannerTimer = 0;
    function showBanner(text, tone){
      try{
        bannerEl.classList.remove('hidden','tone-neutral','tone-good','tone-warn','tone-bad','show');
        bannerEl.classList.add('tone-' + (tone||'neutral'));
        bannerText.textContent = String(text||'');
        bannerEl.classList.add('show');
        clearTimeout(_bannerTimer);
        _bannerTimer = setTimeout(()=>{
          try{ bannerEl.classList.add('hidden'); bannerEl.classList.remove('show'); }catch(_){}
        }, 900);
      }catch(_){}
    }

    // ---- DOM bindings ----
    const $ = (id)=>DOC.getElementById(id);

    function setFill(el, pct){
      pct = clamp(pct,0,100);
      if(el) el.style.width = pct + '%';
    }

    WIN.addEventListener('hha:score', (ev)=>{
      const d = ev.detail||{};
      $('hudScore').textContent = String(d.score ?? 0);
      $('hudCombo').textContent = String(d.combo ?? 0);
      $('hudMiss').textContent = String(d.misses ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:time', (ev)=>{
      const d = ev.detail||{};
      $('hudTime').textContent = String(d.left ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail||{};
      $('hudAcc').textContent = String((d.accuracy ?? 0)) + '%';
      $('hudRank').textContent = String(d.grade ?? 'D');
    }, { passive:true });

    WIN.addEventListener('quest:update', (ev)=>{
      const d = ev.detail||{};
      $('goalTitle').textContent = d.goalTitle || 'GOAL';
      $('goalSub').textContent = `${d.goalNow||0} / ${d.goalTotal||0}`;
      setFill($('goalFill'), d.goalPct||0);

      $('miniTitle').textContent = d.miniTitle || 'MINI';
      $('miniSub').textContent = `${d.miniNow||0} / ${d.miniTotal||0}` + (d.miniTimeLeftSec ? ` ‚Ä¢ ${d.miniTimeLeftSec}s` : '');
      setFill($('miniFill'), d.miniPct||0);

      // urgent mini glow
      if((d.miniTimeLeftSec||0) > 0 && (d.miniTimeLeftSec||0) <= 3) DOC.body.classList.add('mini-urgent');
      else DOC.body.classList.remove('mini-urgent');
    }, { passive:true });

    WIN.addEventListener('groups:power', (ev)=>{
      const d = ev.detail||{};
      const cur = Number(d.charge||0), thr = Number(d.threshold||1);
      $('powerSub').textContent = `${cur} / ${thr}`;
      setFill($('powerFill'), Math.round((cur/Math.max(1,thr))*100));
    }, { passive:true });

    WIN.addEventListener('hha:coach', (ev)=>{
      const d = ev.detail||{};
      $('coachText').textContent = d.text || '';
      const mood = String(d.mood||'neutral');
      const map = {
        happy: '../img/coach-happy.png',
        fever: '../img/coach-fever.png',
        sad: '../img/coach-sad.png',
        neutral: '../img/coach-neutral.png'
      };
      $('coachImg').src = map[mood] || map.neutral;
      if(mood==='happy') showBanner('üëç ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!', 'good');
      else if(mood==='fever') showBanner('‚ö° ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤!', 'warn');
    }, { passive:true });

    // ---- End summary (optional basic) ----
    function showEnd(summary){
      const o = $('overlayEnd');
      if(!o) return;
      const sub = $('endSub');
      const grid = $('endGrid');
      try{
        const s = summary || {};
        sub.textContent = `Score: ${s.scoreFinal||0} ‚Ä¢ Acc: ${s.accuracyGoodPct||0}% ‚Ä¢ Rank: ${s.grade||'D'} ‚Ä¢ Miss: ${s.misses||0}`;
        grid.innerHTML = '';
        const items = [
          ['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', s.scoreFinal||0],
          ['‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô (‡∏Ç‡∏≠‡∏á‡∏ñ‡∏π‡∏Å)', (s.accuracyGoodPct||0) + '%'],
          ['‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', s.shots||0],
          ['‡∏¢‡∏¥‡∏á‡∏ñ‡∏π‡∏Å', s.goodShots||0],
          ['MISS', s.misses||0],
          ['Seed', s.seed||'']
        ];
        items.forEach(([k,v])=>{
          const box = DOC.createElement('div');
          box.className = 'stat';
          box.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
          grid.appendChild(box);
        });
        o.classList.remove('hidden');
      }catch(_){}
    }

    WIN.addEventListener('hha:end', (ev)=>{
      showEnd(ev.detail||{});
    }, { passive:true });

    // ---- Hub param passthrough ----
    const HUB = qs('hub','') || '../hub.html';
    $('btnBackHub')?.addEventListener('click', ()=>{
      location.href = HUB;
    });

    // ---- Start flow (tap-to-start) ----
    let started = false;
    function startGame(){
      if(started) return;
      started = true;
      $('tapToStart')?.classList.add('hidden');

      // Start engine
      try{
        const GE = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
        if(GE && GE.setLayerEl) GE.setLayerEl(DOC.getElementById('playLayer'));
        const diff = qs('diff','normal') || 'normal';
        const ctx = {
          seed: qs('seed','') || Date.now(),
          time: Number(qs('time', 90)),
          runMode: qs('run','play') || 'play'
        };
        GE && GE.start && GE.start(diff, ctx);
        showBanner(`LOCKPX ${LOCKPX}`, 'neutral');
      }catch(e){
        console.error(e);
        alert('Start failed: ' + (e && e.message ? e.message : e));
      }
    }

    $('btnStart')?.addEventListener('click', startGame);
    DOC.addEventListener('pointerdown', (e)=>{
      // allow first gesture anywhere
      if(!started) startGame();
    }, { passive:true });

    // Replay
    $('btnReplay')?.addEventListener('click', ()=>{
      try{
        const GE = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
        GE && GE.stop && GE.stop();
      }catch(_){}
      $('overlayEnd')?.classList.add('hidden');
      started = false;
      startGame();
    });

    // ---- Load scripts in correct order ----
    function loadScript(src){
      return new Promise((res, rej)=>{
        const s = DOC.createElement('script');
        s.src = src;
        s.defer = true;
        s.onload = ()=>res(true);
        s.onerror = ()=>rej(new Error('Failed to load: ' + src));
        DOC.head.appendChild(s);
      });
    }

    (async function boot(){
      // OPTIONAL particles (if you use it in your repo)
      // await loadScript('../vr/particles.js').catch(()=>{});

      // vr-ui: must load early (it emits hha:shoot, has crosshair)
      await loadScript('../vr/vr-ui.js');

      // Effects pack: listens to groups:hit
      await loadScript('./effects-pack.js');

      // Engine (PATCH version you just pasted)
      await loadScript('./groups.safe.js');

      // kick init of EffectsPack (safe even if already init)
      try{
        const FX = WIN.GroupsVR && WIN.GroupsVR.EffectsPack;
        FX && FX.init && FX.init({ layerEl: DOC.getElementById('playLayer') });
      }catch(_){}

      // show small hint
      showBanner('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô ‚úÖ', 'good');
    })();

  })();
  </script>

</body>
</html>