<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame background only -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.20);
      --danger:#f97373;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.24), transparent 55%),
        #020617;
      color:var(--text-main);
    }

    /* A-Frame = ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å */
    a-scene{ position:fixed; inset:0; z-index:0; }
    a-scene, a-scene canvas{ pointer-events:none !important; }

    /* ===== HUD root ===== */
    .hud-root{ position:fixed; inset:0; pointer-events:none; z-index:60; }
    .hud-top{
      position:absolute; top:0; left:0; right:0;
      padding:10px;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; pointer-events:none;
    }

    .hud-card{
      pointer-events:auto;
      background:radial-gradient(circle at top, #0f172a, #020617);
      border-radius:var(--radius-lg);
      padding:10px 14px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,1);
      min-width:260px; max-width:360px;
    }
    .hud-main-title{ font-size:11px; letter-spacing:.18em; text-transform:uppercase; color:var(--text-soft); margin-bottom:2px; }
    .hud-main-mode{ font-size:18px; font-weight:600; }
    .hud-pill{
      margin-top:4px;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-soft);
      display:inline-flex; align-items:center; gap:6px;
    }
    .hud-metrics{ margin-top:8px; display:flex; gap:14px; flex-wrap:wrap; }
    .metric{ display:flex; flex-direction:column; gap:2px; }
    .metric-label{ font-size:11px; color:var(--text-soft); }
    .metric-value{ font-size:18px; font-weight:700; }
    .metric-value.accent{ color:#bbf7d0; }
    .metric-sub{ font-size:11px; color:var(--text-soft); min-height:14px; }

    .fg-quest-panel{
      pointer-events:auto;
      min-width:260px; max-width:360px;
      padding:10px 14px;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top, #0f172a, #020617);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,1);
      max-height:40vh; overflow-y:auto;
    }
    .fg-quest-title{ font-size:11px; letter-spacing:.16em; text-transform:uppercase; color:var(--text-soft); margin-bottom:4px; }
    .fg-quest-row{ display:flex; align-items:flex-start; gap:6px; font-size:13px; padding:2px 0; }
    .fg-quest-label{ font-size:11px; text-transform:uppercase; letter-spacing:.12em; color:var(--text-soft); margin-top:2px; white-space:nowrap; }
    .fg-quest-main{ flex:1; opacity:.92; }
    .fg-quest-progress{ font-variant-numeric:tabular-nums; font-size:12px; color:#bbf7d0; white-space:nowrap; }

    .hud-bottom{
      position:absolute; left:0; right:0; bottom:64px;
      display:flex; justify-content:center; align-items:center;
      pointer-events:none;
    }
    .coach-bubble{
      min-width:60%; max-width:640px;
      background:rgba(15,23,42,0.95);
      border-radius:var(--radius-pill);
      padding:8px 14px;
      border:1px solid rgba(52,211,153,0.5);
      font-size:13px;
      display:none;
      align-items:center; gap:8px;
      pointer-events:auto;
    }
    .coach-bubble.show{ display:flex; }
    .coach-label{ font-size:11px; text-transform:uppercase; letter-spacing:.16em; color:#6ee7b7; font-weight:600; }
    .coach-avatar{
      width:28px; height:28px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fef3c7, #f97316);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:18px;
      box-shadow:0 0 0 2px rgba(15,23,42,0.9);
    }

    @media (max-width:640px){
      .hud-top{ flex-direction:column; align-items:stretch; }
      .hud-card,.fg-quest-panel{ min-width:0; width:100%; max-width:none; }
      .fg-quest-panel{ margin-top:6px; max-height:34vh; }
      .coach-bubble{ min-width:0; width:calc(100% - 32px); font-size:12px; }
    }

    /* ===== Target Layer (DOM) ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ ===== */
    #fg-layer{
      position:fixed;
      inset:0;
      z-index:40;                       /* ‡πÉ‡∏ï‡πâ HUD (60) ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏â‡∏≤‡∏Å */
      pointer-events:auto !important;   /* ‚òÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ï‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */
      touch-action:manipulation;
    }

    .fg-target{
      position:absolute;
      width:132px; height:132px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      pointer-events:auto;
      cursor:pointer;
      user-select:none; -webkit-user-select:none;
      touch-action:manipulation;
      box-shadow: 0 12px 32px rgba(15,23,42,0.85), 0 0 0 4px rgba(15,23,42,0.9);
      transform:translate(-50%, -50%) scale(1);
      transition: transform .12s ease-out, opacity .12s ease-out;
      opacity:1;
      will-change: transform, left, top, opacity;
    }
    .fg-good{ background:radial-gradient(circle at 30% 30%, #22c55e, #15803d); }
    .fg-junk{ background:radial-gradient(circle at 30% 30%, #f97316, #c2410c); }
    .fg-target::before{
      content:attr(data-emoji);
      display:block;
      font-size:clamp(40px, 7vmin, 64px);
      line-height:1;
      color:#fefce8;
      text-shadow: 0 2px 4px rgba(15,23,42,0.9), 0 0 10px rgba(15,23,42,0.9);
    }
    .fg-target.hit{
      transform:translate(-50%, -50%) scale(0.6);
      opacity:0;
    }

    /* ===== Fever gauge ===== */
    .hha-fever-wrap {
      position:fixed !important;
      left:10px;
      bottom:10px;
      right:auto;
      transform:none;
      z-index:80 !important;
    }

    /* ===== Countdown ===== */
    .countdown-overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:200;
      font-size:clamp(3rem, 10vw, 5rem);
      font-weight:800;
      color:#fbbf24;
      text-shadow:0 0 40px rgba(0,0,0,0.85);
      pointer-events:none;
      opacity:0;
      transform:scale(0.8);
      transition:opacity .2s ease-out, transform .2s ease-out;
    }
    .countdown-overlay.show{ opacity:1; transform:scale(1); }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ VR */
    .vr-btn{
      position:fixed;
      right:12px;
      bottom:16px;
      z-index:653;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      padding:8px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 55%),
                 rgba(15,23,42,0.96);
      color:#e0f2fe;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 14px 30px rgba(15,23,42,0.9);
      pointer-events:auto;
    }
    .vr-btn span{ font-size:16px; }
  </style>
</head>

<body>
  <!-- VR background -->
  <a-scene vr-mode-ui="enabled: true"
           renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
           background="color: #020617">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="fg-camera" wasd-controls-enabled="false" look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9"></a-entity>
      </a-camera>
    </a-entity>
    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-plane position="0 0 0" rotation="-90 0 0" width="16" height="16"
             material="color: #020617; metalness: 0; roughness: 1"></a-plane>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- DOM targets -->
  <div id="fg-layer" aria-label="Food Groups Targets"></div>

  <!-- HUD -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card">
        <div class="hud-main-title">HERO HEALTH ‚Ä¢ NUTRITION VR</div>
        <div class="hud-main-mode">Food Groups</div>
        <div class="hud-pill">
          <span id="hud-diff-label">NORMAL</span>
          <span>‚Ä¢</span>
          <span id="hud-time-label">60s</span>
        </div>

        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="metric-value accent" id="hud-score">0</div>
            <div class="metric-sub" id="hud-judge">&nbsp;</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="metric-value" id="hud-combo">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏û‡∏•‡∏≤‡∏î</div>
            <div class="metric-value" id="hud-miss">0</div>
          </div>
        </div>
      </div>

      <div class="fg-quest-panel">
        <div class="fg-quest-title">Quest</div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Goal</div>
          <div class="fg-quest-main" id="fg-quest-main">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
          <div class="fg-quest-progress" id="fg-quest-main-progress">0 / 0</div>
        </div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Mini</div>
          <div class="fg-quest-main" id="fg-quest-mini">Mini quest ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
          <div class="fg-quest-progress" id="fg-quest-mini-progress">0 / 0</div>
        </div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div class="coach-avatar" id="coach-avatar">ü•¶</div>
        <div>
          <div class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div id="coach-text">‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏∞</div>
        </div>
      </div>
    </div>
  </div>

  <button id="btn-vr" class="vr-btn"><span>üï∂Ô∏è</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</button>
  <div id="start-countdown" class="countdown-overlay">3</div>

  <!-- Fever UI + particles -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <!-- Engine ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
  <script src="./vr-groups/GameEngine.js"></script>

  <!-- Boot -->
  <script type="module">
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';

    const fgLayer = document.getElementById('fg-layer');

    const elScore   = document.getElementById('hud-score');
    const elCombo   = document.getElementById('hud-combo');
    const elMiss    = document.getElementById('hud-miss');
    const elJudge   = document.getElementById('hud-judge');
    const elDiff    = document.getElementById('hud-diff-label');
    const elTime    = document.getElementById('hud-time-label');

    const elQuestMain  = document.getElementById('fg-quest-main');
    const elQuestMini  = document.getElementById('fg-quest-mini');
    const elQuestMainP = document.getElementById('fg-quest-main-progress');
    const elQuestMiniP = document.getElementById('fg-quest-mini-progress');

    const elCoachBubble = document.getElementById('coach-bubble');
    const elCoachText   = document.getElementById('coach-text');

    const btnVR       = document.getElementById('btn-vr');
    const elCountdown = document.getElementById('start-countdown');

    function getParam(name, fallback){
      const url = new URL(window.location.href);
      const v = url.searchParams.get(name);
      return v !== null && v !== '' ? v : fallback;
    }

    function setCoach(text){
      if (!text) return;
      elCoachText.textContent = text;
      elCoachBubble.classList.add('show');
      setTimeout(() => elCoachBubble.classList.remove('show'), 3200);
    }

    // ===== Hook events from engine =====
    let score = 0, combo = 0, comboMax = 0, misses = 0;

    function emitScore(){
      window.dispatchEvent(new CustomEvent('hha:score', { detail:{ score, combo, misses }}));
      window.dispatchEvent(new CustomEvent('hha:judge', { detail:{ label: combo >= 3 ? 'PERFECT!' : 'GOOD' }}));
    }

    window.addEventListener('groups:hit', (e) => {
      const d = e.detail || {};
      if (d.good) {
        combo += 1;
        score += 10 + Math.min(15, combo); // ‡πÄ‡∏î‡πâ‡∏á‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏´‡∏ô‡πà‡∏≠‡∏¢
      } else {
        // junk
        combo = 0;
        misses += 1;
        score = Math.max(0, score - 5);
        setCoach('‡πÇ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞‡πÅ‡∏•‡πâ‡∏ß üòÖ ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞');
      }
      comboMax = Math.max(comboMax, combo);
      elCombo.textContent = String(comboMax);
      elMiss.textContent  = String(misses);
      elScore.textContent = String(score);
      emitScore();
    });

    window.addEventListener('groups:expire', (e) => {
      const d = e.detail || {};
      // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢ GOOD ‡∏´‡∏•‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ miss (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ)
      if (d.good) {
        combo = 0;
        misses += 1;
        elMiss.textContent = String(misses);
        window.dispatchEvent(new CustomEvent('hha:score', { detail:{ score, combo, misses }}));
        window.dispatchEvent(new CustomEvent('hha:judge', { detail:{ label:'MISS' }}));
      }
    });

    // VR Button
    btnVR.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) { try { scene.enterVR(); } catch(e) {} }
    });

    // Touch look
    const cam = document.querySelector('#fg-camera');
    if (cam) attachTouchLook(cam, { sensitivity: 0.25, areaEl: document.body });

    // Logger (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ)
    function initLogger(diff, dur, runMode){
      initCloudLogger({
        endpoint: 'https://script.google.com/macros/s/AKfycby7IBVmpmEydNDp5BR3CMaSAjvF7ljptaDwvow_L781iDLsbtpuiFmKviGUnugFerDtQg/exec',
        projectTag: 'HeroHealth-FoodGroupsVR',
        mode: 'FoodGroupsVR',
        runMode,
        diff,
        durationSec: dur,
        debug: false
      });
    }

    function runCountdown(onDone){
      const steps = ['3','2','1','Go!'];
      let idx = 0;
      elCountdown.textContent = steps[0];
      elCountdown.classList.add('show');

      const t = setInterval(() => {
        idx++;
        if (idx >= steps.length){
          clearInterval(t);
          elCountdown.classList.remove('show');
          onDone && onDone();
        } else {
          elCountdown.textContent = steps[idx];
        }
      }, 800);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const diff = String(getParam('diff','easy')).toLowerCase();
      const runParam = String(getParam('run','play')).toLowerCase();
      const runMode = (runParam === 'research') ? 'research' : 'play';

      elDiff.textContent = diff.toUpperCase();

      let dur = diff === 'easy' ? 88 : (diff === 'hard' ? 55 : 70);
      const timeParam = getParam('time','');
      if (timeParam){
        const parsed = parseInt(timeParam,10);
        if (!isNaN(parsed) && parsed >= 20 && parsed <= 180) dur = parsed;
      }
      elTime.textContent = dur + 's';

      initLogger(diff, dur, runMode);
      setCoach('‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏ß! (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‚Äú‡∏ï‡∏µ‡πÑ‡∏î‡πâ 100%‚Äù ‡πÅ‡∏•‡πâ‡∏ß) ‚ú®');

      const Engine = window.GroupsVR?.GameEngine;
      if (!Engine || typeof Engine.start !== 'function'){
        console.error('[FoodGroupsVR] GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏ö');
        return;
      }

      Engine.setLayerEl && Engine.setLayerEl(fgLayer);

      runCountdown(() => {
        let timeLeft = dur;
        window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));

        const timerId = setInterval(() => {
          timeLeft -= 1;
          if (timeLeft < 0) return;
          window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));
          if (timeLeft === 0){
            clearInterval(timerId);
            Engine.stop && Engine.stop('time-up');
            setCoach('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üéâ');
          }
        }, 1000);

        Engine.start(diff, { layerEl: fgLayer, runMode });
      });
    });
  </script>
</body>
</html>
