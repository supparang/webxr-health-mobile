<!-- === /herohealth/groups-vr.html ===
Food Groups VR (PRODUCTION) ‚Äî HTML FULL (Fix start/quest/hud)
Requires:
- ./vr/particles.js (IIFE)
- ./vr/hha-hud.js (IIFE)
- ./vr/ui-fever.js (IIFE)
- ./vr/hha-cloud-logger.js (optional, IIFE)
- ./vr-groups/groups-quests.js (IIFE)  ‚úÖ must load BEFORE GameEngine.js
- ./vr-groups/GameEngine.js (IIFE)     ‚úÖ exposes window.GroupsVR.GameEngine
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + HUD binders -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 40%, #0b1226 0%, #020617 55%, #020617 100%); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden;}
    .app{position:fixed; inset:0; display:block;}

    /* A-Frame canvas behind */
    a-scene{position:fixed; inset:0; z-index:0;}
    .ui{position:fixed; inset:0; z-index:5; pointer-events:none;}

    /* TOP HUD (goal/mini) */
    .topbar{position:fixed; left:10px; right:10px; top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px; pointer-events:none;}
    .card{
      background:linear-gradient(180deg, rgba(2,6,23,.82), rgba(2,6,23,.62));
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }
    .card h4{margin:0 0 6px 0; font-size:13px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; color:var(--muted);}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .big{font-size:15px; font-weight:800;}
    .sub{font-size:12px;color:var(--muted);}
    .bar{height:8px;border-radius:999px;background:rgba(148,163,184,.12); overflow:hidden; border:1px solid rgba(148,163,184,.14);}
    .bar > i{display:block;height:100%; width:0%; background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,197,94,.55));}
    .bar.warn > i{background:linear-gradient(90deg, rgba(245,158,11,.95), rgba(245,158,11,.55));}
    .bar.bad > i{background:linear-gradient(90deg, rgba(239,68,68,.95), rgba(239,68,68,.55));}

    /* MID HUD left */
    .mid{
      position:fixed; left:12px; top:160px;
      width:min(320px, 72vw);
      pointer-events:none;
    }
    .statgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .stat{padding:10px 12px;}
    .stat .k{font-size:12px;color:var(--muted);}
    .stat .v{font-size:28px; font-weight:900; margin-top:2px;}
    .coach{margin-top:10px; padding:12px; display:flex; gap:12px; align-items:flex-start;}
    .coach img{width:56px;height:56px;border-radius:16px; background:rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.16); object-fit:cover;}
    .coach .msg{font-size:13px; color:var(--text); line-height:1.35;}
    .coach .tip{margin-top:6px; font-size:12px; color:var(--muted);}

    /* bottom controls */
    .bottom{
      position:fixed; left:12px; right:12px; bottom:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      pointer-events:auto;
    }
    .btnrow{display:flex; gap:10px; align-items:center;}
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.72);
      color:var(--text);
      padding:12px 16px;
      border-radius:16px;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.green{background:rgba(34,197,94,.18); border-color: rgba(34,197,94,.30);}
    .btn.red{background:rgba(239,68,68,.16); border-color: rgba(239,68,68,.30);}
    .btn.gray{background:rgba(148,163,184,.10);}

    /* Start overlay */
    .overlay{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      background:radial-gradient(800px 600px at 50% 35%, rgba(15,23,42,.78), rgba(2,6,23,.90));
      pointer-events:auto;
    }
    .panel{
      width:min(640px, 92vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      box-shadow: var(--shadow);
      padding:18px;
    }
    .title{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .title h2{margin:0; font-size:18px;}
    .pill{font-size:12px; color:var(--muted); border:1px solid rgba(148,163,184,.18); padding:6px 10px; border-radius:999px;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    .opt{padding:12px 12px;}
    .opt label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    select,input{
      width:100%; box-sizing:border-box;
      border-radius:14px; border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.55);
      color:var(--text);
      padding:12px;
      font-weight:800;
      outline:none;
    }
    .hint{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45;}
    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px;}

    /* Gameplay layer (DOM targets) */
    #fg-layer{
      position:fixed; inset:0;
      z-index:3;
      pointer-events:auto;
      touch-action: manipulation;
    }

    /* Target style (emoji bubble) */
    .fg-target{
      position:absolute;
      left:var(--x, 50%);
      top:var(--y, 50%);
      transform: translate3d(-50%,-50%,0) scale(var(--s,1));
      width:132px; height:132px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:56px;
      line-height:1;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background: radial-gradient(circle at 30% 28%, rgba(255,255,255,.18), rgba(255,255,255,.05) 55%, rgba(255,255,255,.03) 75%),
                  rgba(2,6,23,.35);
      box-shadow: 0 18px 55px rgba(0,0,0,.50);
      filter: saturate(1.08);
      backdrop-filter: blur(8px);
      transition: transform .12s ease, opacity .18s ease;
    }
    .fg-good{outline:2px solid rgba(34,197,94,.28);}
    .fg-junk{outline:2px solid rgba(239,68,68,.24);}
    .fg-boss{outline:2px solid rgba(245,158,11,.28);}
    .fg-decoy{outline:2px solid rgba(147,197,253,.26);}

    .fg-target.spawn{opacity:0; transform: translate3d(-50%,-50%,0) scale(.72);}
    .fg-target.show{opacity:1; transform: translate3d(-50%,-50%,0) scale(var(--s,1));}
    .fg-target.hit{opacity:0; transform: translate3d(-50%,-50%,0) scale(.55);}
    .fg-target.out{opacity:.0;}
    .fg-target.lock{box-shadow: 0 0 0 8px rgba(34,197,94,.10), 0 18px 55px rgba(0,0,0,.52);}

    .bossbar{
      position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
      width:70%; height:8px; border-radius:999px;
      background:rgba(148,163,184,.14);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
    }
    .bossbar-fill{
      height:100%; width:100%;
      background:linear-gradient(90deg, rgba(245,158,11,.95), rgba(245,158,11,.45));
    }

    /* end summary */
    .end{
      position:fixed; inset:0; z-index:20;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.86);
      pointer-events:auto;
    }
    .end.show{display:flex;}
    .end .panel{width:min(640px,92vw);}
    .endgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    .endcard{padding:12px;}
    .endcard .k{font-size:12px;color:var(--muted);}
    .endcard .v{font-size:26px;font-weight:900;margin-top:4px;}

    /* responsive */
    @media (max-width: 420px){
      .mid{top:140px; width:min(320px, 84vw);}
      .stat .v{font-size:26px;}
      .fg-target{font-size:52px;}
    }
  </style>
</head>

<body>
<div class="app">

  <!-- A-Frame scene (for camera orientation only) -->
  <a-scene embedded vr-mode-ui="enabled:false">
    <a-entity id="rig">
      <a-camera id="rigCam" position="0 1.6 0" look-controls="enabled:true"></a-camera>
    </a-entity>
  </a-scene>

  <!-- DOM gameplay layer -->
  <div id="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- UI -->
  <div class="ui">

    <!-- Top goal/mini -->
    <div class="topbar">
      <div class="card" id="hud-goal">
        <h4>üéØ GOAL <span class="pill" id="hud-goal-count">0/0</span></h4>
        <div class="row">
          <div class="big" id="hud-goal-title">‚Äî</div>
          <div class="sub" id="hud-goal-pct">0%</div>
        </div>
        <div class="bar" id="hud-goal-bar"><i></i></div>
      </div>

      <div class="card" id="hud-mini">
        <h4>üß© MINI QUEST</h4>
        <div class="row">
          <div class="big" id="hud-mini-title">‚Äî</div>
          <div class="sub" id="hud-mini-pct">0%</div>
        </div>
        <div class="bar warn" id="hud-mini-bar"><i></i></div>
        <div class="sub" id="hud-mini-extra" style="margin-top:6px;">‚Äî</div>
      </div>
    </div>

    <!-- Mid stats + coach -->
    <div class="mid">
      <div class="statgrid">
        <div class="card stat">
          <div class="k">TIME</div>
          <div class="v" id="hud-time">90</div>
        </div>
        <div class="card stat">
          <div class="k">SHIELD</div>
          <div class="v" id="hud-shield">0</div>
        </div>
        <div class="card stat">
          <div class="k">GRADE</div>
          <div class="v" id="hud-grade">C</div>
        </div>
        <div class="card stat">
          <div class="k">GROUP</div>
          <div class="v" id="hud-group" style="font-size:16px;font-weight:900;">‚Äî</div>
        </div>
      </div>

      <div class="card coach">
        <img id="hud-coach-img" src="./img/coach-neutral.png" alt="Coach" />
        <div>
          <div class="msg" id="hud-coach-text">‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î! ü•¶</div>
          <div class="tip" id="hud-tip">Tip: Tap-anywhere ‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÉ‡∏´‡πâ</div>
        </div>
      </div>
    </div>

    <!-- bottom buttons -->
    <div class="bottom">
      <div class="btnrow">
        <button class="btn gray" id="btn-gaze">Gaze: ON</button>
        <button class="btn red" id="btn-stop">STOP</button>
      </div>
      <div class="btnrow">
        <button class="btn gray" id="btn-vr">VR</button>
      </div>
    </div>

  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <div class="title">
        <h2>üçΩÔ∏è Food Groups VR</h2>
        <div class="pill" id="pill-url">params</div>
      </div>

      <div class="grid2">
        <div class="card opt">
          <label>Difficulty</label>
          <select id="selDiff">
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
          </select>
        </div>

        <div class="card opt">
          <label>Time (sec)</label>
          <input id="inpTime" type="number" min="10" max="300" step="5" value="90" />
        </div>

        <div class="card opt">
          <label>Run mode</label>
          <select id="selRun">
            <option value="play" selected>play</option>
            <option value="research">research</option>
          </select>
        </div>

        <div class="card opt">
          <label>Seed (research)</label>
          <input id="inpSeed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô schoolA-class5-01" />
        </div>
      </div>

      <div class="hint">
        - ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‚Äúemoji bubble‚Äù ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ ‚úÖ<br/>
        - Quest/HUD ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå <code>./vr-groups/groups-quests.js</code> ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ<br/>
        - ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚Äúfix seed‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (‡πÉ‡∏™‡πà seed ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
      </div>

      <div class="actions">
        <button class="btn gray" id="btn-closeOverlay">‡∏õ‡∏¥‡∏î</button>
        <button class="btn green" id="btn-start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- End summary -->
  <div class="end" id="endOverlay">
    <div class="panel">
      <div class="title">
        <h2>üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</h2>
        <div class="pill" id="end-zone">ZONE -</div>
      </div>

      <div class="endgrid">
        <div class="card endcard">
          <div class="k">Score</div>
          <div class="v" id="end-score">0</div>
        </div>
        <div class="card endcard">
          <div class="k">Combo Best</div>
          <div class="v" id="end-combo">0</div>
        </div>
        <div class="card endcard">
          <div class="k">Miss</div>
          <div class="v" id="end-miss">0</div>
        </div>
        <div class="card endcard">
          <div class="k">Quests</div>
          <div class="v" id="end-quests">0%</div>
        </div>
      </div>

      <div class="actions" style="margin-top:14px;">
        <button class="btn gray" id="btn-end-close">‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ</button>
        <button class="btn green" id="btn-end-retry">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

</div>

<!-- IMPORTANT: Quest manager BEFORE engine -->
<script src="./vr-groups/groups-quests.js"></script>
<script src="./vr-groups/GameEngine.js"></script>

<script>
(function(){
  'use strict';

  const qs = new URLSearchParams(location.search);
  const byId = (id)=>document.getElementById(id);

  const layer = byId('fg-layer');
  const camEl = document.querySelector('#rigCam');

  const overlay = byId('startOverlay');
  const endOverlay = byId('endOverlay');

  const selDiff = byId('selDiff');
  const selRun  = byId('selRun');
  const inpTime = byId('inpTime');
  const inpSeed = byId('inpSeed');
  const pillUrl = byId('pill-url');

  const btnStart = byId('btn-start');
  const btnCloseOverlay = byId('btn-closeOverlay');
  const btnStop = byId('btn-stop');
  const btnGaze = byId('btn-gaze');
  const btnVR = byId('btn-vr');

  const hudTime = byId('hud-time');
  const hudShield = byId('hud-shield');
  const hudGrade = byId('hud-grade');
  const hudGroup = byId('hud-group');

  const gTitle = byId('hud-goal-title');
  const gPct   = byId('hud-goal-pct');
  const gCount = byId('hud-goal-count');
  const gBar   = byId('hud-goal-bar').querySelector('i');

  const mTitle = byId('hud-mini-title');
  const mPct   = byId('hud-mini-pct');
  const mBar   = byId('hud-mini-bar').querySelector('i');
  const mExtra = byId('hud-mini-extra');

  const coachText = byId('hud-coach-text');

  const endScore = byId('end-score');
  const endCombo = byId('end-combo');
  const endMiss  = byId('end-miss');
  const endQuests= byId('end-quests');
  const endZone  = byId('end-zone');

  const btnEndClose = byId('btn-end-close');
  const btnEndRetry = byId('btn-end-retry');

  function safeEngine(){
    return (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
  }

  function readParams(){
    const diff = (qs.get('diff') || 'normal').toLowerCase();
    const time = Math.max(10, Number(qs.get('time') || 90) || 90);
    const run  = (qs.get('run') || 'play').toLowerCase();
    const seed = (qs.get('seed') || '');
    return { diff, time, run, seed };
  }

  function setOverlayFromParams(){
    const p = readParams();
    selDiff.value = (p.diff==='easy'||p.diff==='hard'||p.diff==='normal') ? p.diff : 'normal';
    selRun.value = (p.run==='research') ? 'research' : 'play';
    inpTime.value = String(p.time);
    inpSeed.value = String(p.seed || '');
    pillUrl.textContent = `diff=${selDiff.value} | time=${inpTime.value} | run=${selRun.value}`;
    hudTime.textContent = String(p.time);
  }

  function pct(prog, target){
    const a = Number(prog)||0, b = Math.max(1, Number(target)||1);
    return Math.max(0, Math.min(1, a/b));
  }

  // ---- Event bindings from engine/hud ----
  window.addEventListener('hha:time', (e)=>{
    const left = (e && e.detail && typeof e.detail.left==='number') ? e.detail.left : null;
    if (left!=null) hudTime.textContent = String(left|0);
  });

  window.addEventListener('hha:score', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    if (typeof d.shield === 'number') hudShield.textContent = String(d.shield);
  });

  window.addEventListener('hha:rank', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    if (d.grade) hudGrade.textContent = String(d.grade);
  });

  window.addEventListener('hha:coach', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    if (d.text) coachText.textContent = String(d.text);
  });

  // QUEST UPDATE (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å groups-quests.js ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠ engine ‡πÑ‡∏°‡πà start)
  window.addEventListener('quest:update', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    const ok = !!d.questOk;

    if (!ok){
      gTitle.textContent = '‚Äî';
      gPct.textContent = '0%';
      gCount.textContent = '0/0';
      gBar.style.width = '0%';

      mTitle.textContent = '‚Äî';
      mPct.textContent = '0%';
      mBar.style.width = '0%';
      mExtra.textContent = '‚ö†Ô∏è QUEST ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ ./vr-groups/groups-quests.js)';
      hudGroup.textContent = '‚Äî';
      return;
    }

    const goal = d.goal || null;
    const mini = d.mini || null;

    if (goal){
      const p = pct(goal.prog, goal.target);
      gTitle.textContent = goal.label || 'GOAL';
      gPct.textContent = Math.round(p*100) + '%';
      gBar.style.width = Math.round(p*100) + '%';
    } else {
      gTitle.textContent = 'GOAL ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      gPct.textContent = '100%';
      gBar.style.width = '100%';
    }

    const goalsAll = Array.isArray(d.goalsAll) ? d.goalsAll : [];
    const clearedG = goalsAll.filter(x=>x && x.done).length;
    gCount.textContent = `${clearedG}/${goalsAll.length||0}`;

    if (mini){
      const p = pct(mini.prog, mini.target);
      mTitle.textContent = mini.label || 'MINI';
      mPct.textContent = Math.round(p*100) + '%';
      mBar.style.width = Math.round(p*100) + '%';

      if (typeof mini.tLeft === 'number' && typeof mini.windowSec === 'number'){
        mExtra.textContent = `‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${mini.tLeft|0} ‡∏ß‡∏¥ / ${mini.windowSec|0} ‡∏ß‡∏¥`;
      } else {
        mExtra.textContent = '‚Äî';
      }
    } else {
      mTitle.textContent = 'MINI ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚≠ê';
      mPct.textContent = '100%';
      mBar.style.width = '100%';
      mExtra.textContent = '‚Äî';
    }

    hudGroup.textContent = d.groupLabel ? String(d.groupLabel) : '‚Äî';
  });

  window.addEventListener('hha:end', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    endScore.textContent = String(d.scoreFinal || 0);
    endCombo.textContent = String(d.comboMax || 0);
    endMiss.textContent  = String(d.misses || 0);

    const qTotal = (d.goalsTotal||0) + (d.miniTotal||0);
    const qCleared = (d.goalsCleared||0) + (d.miniCleared||0);
    const qp = (qTotal>0) ? Math.round((qCleared/qTotal)*100) : 0;
    endQuests.textContent = qp + '%';

    endZone.textContent = 'ZONE -';
    endOverlay.classList.add('show');
  });

  // ---- Buttons ----
  btnCloseOverlay.addEventListener('click', ()=> overlay.style.display='none');
  btnEndClose.addEventListener('click', ()=> endOverlay.classList.remove('show'));
  btnEndRetry.addEventListener('click', ()=>{
    endOverlay.classList.remove('show');
    overlay.style.display='flex';
  });

  let gazeOn = true;
  btnGaze.addEventListener('click', ()=>{
    gazeOn = !gazeOn;
    btnGaze.textContent = 'Gaze: ' + (gazeOn ? 'ON' : 'OFF');
    const eng = safeEngine();
    eng && eng.setGaze && eng.setGaze(gazeOn);
  });

  btnStop.addEventListener('click', ()=>{
    const eng = safeEngine();
    eng && eng.stop && eng.stop('user_stop');
  });

  btnVR.addEventListener('click', async ()=>{
    try{
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) scene.enterVR();
    }catch{}
  });

  btnStart.addEventListener('click', ()=>{
    const eng = safeEngine();
    if (!eng){
      alert('GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ ./vr-groups/GameEngine.js)');
      return;
    }

    const diff = (selDiff.value||'normal').toLowerCase();
    const runMode = (selRun.value||'play').toLowerCase();
    const tsec = Math.max(10, Number(inpTime.value||90)||90);
    const seed = String(inpSeed.value||'').trim();

    // ‚úÖ IMPORTANT: set layer/camera/time BEFORE start
    eng.setLayerEl && eng.setLayerEl(layer);
    eng.setCameraEl && eng.setCameraEl(camEl);
    eng.setTimeLeft && eng.setTimeLeft(tsec);
    eng.setGaze && eng.setGaze(gazeOn);

    overlay.style.display = 'none';
    endOverlay.classList.remove('show');

    // Start!
    eng.start(diff, {
      layerEl: layer,
      runMode,
      seed: seed || undefined
    });
  });

  // init from url params
  setOverlayFromParams();
  overlay.style.display = 'flex';

})();
</script>

</body>
</html>