<!-- === /herohealth/groups-vr.html ===
Food Groups VR (PRODUCTION) ‚Äî FIX-ALL Full HTML
‚úÖ DOM emoji targets (append in #fg-layer)
‚úÖ Fever UI (ui-fever.js) always visible
‚úÖ HUD binder (hha-hud.js) for score/quest/coach/time/end
‚úÖ Quest manager (vr-groups/groups-quests.js) Goals(2)+Minis(7)+rotate group
‚úÖ Engine (vr-groups/GameEngine.js) FIX-ALL (fever emit + quest emit + fun systems)
‚úÖ Start overlay + End summary overlay
‚úÖ Safe zones clamp not to overlap HUD (engine uses CFG.safeTop/bottom/left/right)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (scene/camera only) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.68);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --junk:#ef4444;
      --gold:#facc15;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      --hudTop: 74px;       /* ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ui-fever.js top=84px ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô */
      --hudBottom: 120px;
      --hudSide: 14px;

      --targetGlow: rgba(34,197,94,.28);
      --junkGlow: rgba(239,68,68,.22);
      --bossGlow: rgba(250,204,21,.22);

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(30,41,59,.35), rgba(2,6,23,1));
      color:var(--text);
      font-family:var(--font);
      overflow:hidden;
      touch-action: none;
    }

    /* ====== Scene wrapper ====== */
    .app{
      position:fixed;
      inset:0;
      overflow:hidden;
    }

    /* A-Frame canvas behind DOM layers */
    a-scene{
      position:absolute !important;
      inset:0 !important;
      z-index: 0;
    }

    /* ====== DOM Gameplay Layer ====== */
    #fg-layer{
      position:absolute;
      inset:0;
      z-index: 2;
      pointer-events: auto;
      /* allow tap anywhere shooting */
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Targets from GameEngine: uses --x/--y/--s */
    .fg-target{
      position:absolute;
      left: var(--x);
      top:  var(--y);
      transform: translate(-50%,-50%) scale(var(--s,1));
      width: 132px;
      height: 132px;
      border-radius: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 64px;
      line-height: 1;
      letter-spacing: 0;
      will-change: transform, filter;
      pointer-events:auto;

      /* emoji crisp */
      text-shadow:
        0 10px 26px rgba(0,0,0,.45),
        0 0 18px rgba(255,255,255,.08);

      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 16px 36px rgba(0,0,0,.35);
    }

    .fg-target.spawn{ animation: fgPop .14s ease-out 1; }
    .fg-target.show{ }
    .fg-target.hit{ animation: fgHit .16s ease-out 1; opacity:.0; }
    .fg-target.out{ animation: fgOut .18s ease-in 1; opacity:.0; }

    @keyframes fgPop{
      from{ transform: translate(-50%,-50%) scale(.82); filter: blur(.6px); }
      to{ transform: translate(-50%,-50%) scale(1); filter: blur(0); }
    }
    @keyframes fgHit{
      from{ transform: translate(-50%,-50%) scale(1); }
      to{ transform: translate(-50%,-50%) scale(1.22); }
    }
    @keyframes fgOut{
      from{ transform: translate(-50%,-50%) scale(1); }
      to{ transform: translate(-50%,-50%) scale(.78); filter: blur(.9px); }
    }

    .fg-good{
      border-color: rgba(34,197,94,.28);
      box-shadow:
        0 18px 42px rgba(0,0,0,.35),
        0 0 28px var(--targetGlow);
    }
    .fg-junk{
      border-color: rgba(239,68,68,.26);
      box-shadow:
        0 18px 42px rgba(0,0,0,.35),
        0 0 28px var(--junkGlow);
    }
    .fg-boss{
      border-color: rgba(250,204,21,.30);
      box-shadow:
        0 18px 42px rgba(0,0,0,.35),
        0 0 30px var(--bossGlow);
    }
    .fg-decoy{
      outline: 2px dashed rgba(167,139,250,.65);
      outline-offset: 3px;
      filter: saturate(1.05);
    }
    .fg-target.lock{
      transform: translate(-50%,-50%) scale(calc(var(--s,1) * 1.06));
      border-color: rgba(34,211,238,.40);
      box-shadow:
        0 18px 42px rgba(0,0,0,.35),
        0 0 34px rgba(34,211,238,.22);
    }
    .fg-target.rage{
      animation: fgRage 520ms ease-in-out infinite;
    }
    @keyframes fgRage{
      0%{ filter: drop-shadow(0 0 0 rgba(250,204,21,0)); }
      50%{ filter: drop-shadow(0 0 16px rgba(250,204,21,.22)); }
      100%{ filter: drop-shadow(0 0 0 rgba(250,204,21,0)); }
    }

    /* Boss HP bar injected by engine */
    .bossbar{
      position:absolute;
      left: 10%;
      right:10%;
      bottom: 10px;
      height: 8px;
      border-radius: 999px;
      background: rgba(148,163,184,.14);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.16);
    }
    .bossbar-fill{
      height:100%;
      width: 100%;
      background: linear-gradient(90deg, rgba(250,204,21,.95), rgba(249,115,22,.92));
    }

    /* afterimage used by engine */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      z-index: 3;
      opacity:.0;
      animation: fgAfter .42s ease-out 1;
      filter: blur(.15px);
    }
    .fg-afterimage-inner{
      font-size: 58px;
      text-shadow: 0 18px 30px rgba(0,0,0,.35);
      transform: translate(-50%,-50%);
    }
    @keyframes fgAfter{
      0%{ opacity:.62; transform: translate3d(var(--ax,0),var(--ay,0),0) scale(.96); }
      100%{ opacity:0; transform: translate3d(var(--ax,0),var(--ay,0),0) scale(1.10); }
    }

    /* ====== Reticle / Lock ring overlay ====== */
    .reticle{
      position:fixed;
      left:50%;
      top:52%;
      transform: translate(-50%,-50%);
      width: 86px;
      height: 86px;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,.25);
      box-shadow: 0 0 18px rgba(0,0,0,.25);
      z-index: 4;
      pointer-events:none;
    }
    .reticle::after{
      content:'';
      position:absolute;
      inset: 50%;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(226,232,240,.86);
      transform: translate(-50%,-50%);
      opacity: .85;
    }
    .reticle.ok{ border-color: rgba(34,197,94,.45); }
    .reticle.miss{ border-color: rgba(239,68,68,.45); }
    .reticle.perfect{ border-color: rgba(250,204,21,.55); }

    .lockhud{
      position:fixed;
      inset:0;
      z-index: 5;
      pointer-events:none;
    }
    .lockring{
      position:absolute;
      width: 80px;
      height: 80px;
      border-radius: 999px;
      border: 2px solid rgba(34,211,238,.42);
      box-shadow: 0 0 22px rgba(34,211,238,.16);
      transform: translate(-50%,-50%);
      opacity: 0;
      transition: opacity 90ms linear;
    }
    .lockring.on{ opacity: 1; }
    .lockring .prog{
      position:absolute;
      inset: -2px;
      border-radius: 999px;
      background: conic-gradient(rgba(34,211,238,.78) var(--p,0deg), rgba(255,255,255,0) 0);
      -webkit-mask: radial-gradient(circle at center, transparent 57%, #000 58%);
              mask: radial-gradient(circle at center, transparent 57%, #000 58%);
      filter: drop-shadow(0 0 8px rgba(34,211,238,.18));
    }
    .lockring .charge{
      position:absolute;
      inset: 8px;
      border-radius: 999px;
      background: conic-gradient(rgba(250,204,21,.82) var(--c,0deg), rgba(255,255,255,0) 0);
      -webkit-mask: radial-gradient(circle at center, transparent 62%, #000 63%);
              mask: radial-gradient(circle at center, transparent 62%, #000 63%);
      opacity: .0;
      transition: opacity 90ms linear;
    }
    .lockring.charging .charge{ opacity: .9; }

    /* ====== HUD panels ====== */
    .hud{
      position:fixed;
      inset:0;
      z-index: 6;
      pointer-events:none;
      font-family:var(--font);
    }

    .hud-top{
      position:absolute;
      left: var(--hudSide);
      right: var(--hudSide);
      top: 10px;
      display:flex;
      gap: 10px;
      align-items:stretch;
      justify-content:space-between;
    }

    .card{
      pointer-events:none;
      border: 1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      overflow:hidden;
    }

    .scorecard{
      flex: 1.2;
      padding: 10px 12px;
      min-width: 220px;
    }
    .scoregrid{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .big{
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .muted{ color: var(--muted); font-weight: 800; font-size: 12px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.52);
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }

    .rightstack{
      display:flex;
      gap: 10px;
      align-items:stretch;
    }
    .timecard{ width: 128px; padding: 10px 12px; text-align:center; }
    .questcard{ width: min(420px, 56vw); padding: 10px 12px; }

    .qtitle{ font-weight: 950; font-size: 12px; color: rgba(226,232,240,.92); }
    .qline{
      margin-top: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      font-weight: 900;
    }
    .qline .lbl{
      color: rgba(226,232,240,.92);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 78%;
    }
    .qline .val{
      color: rgba(226,232,240,.92);
      opacity:.95;
    }
    .subtle{ color: rgba(148,163,184,.95); font-weight: 800; font-size: 11px; margin-top: 6px; }

    /* Coach bubble */
    .hud-bottom{
      position:absolute;
      left: var(--hudSide);
      right: var(--hudSide);
      bottom: 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
    }
    .coach{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      max-width: 70vw;
      pointer-events:none;
    }
    .coach .avatar{
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.55);
      overflow:hidden;
      box-shadow: 0 14px 26px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .coach .avatar img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .coach .bubble{
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 28px rgba(0,0,0,.30);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.25;
      color: rgba(226,232,240,.96);
      max-width: 58vw;
      overflow-wrap: anywhere;
    }

    .miniBadges{
      display:flex;
      align-items:center;
      gap: 8px;
      pointer-events:none;
    }
    .badge{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.55);
      font-weight: 950;
      font-size: 12px;
      box-shadow: 0 14px 26px rgba(0,0,0,.20);
      white-space: nowrap;
    }
    .badge.warn{ border-color: rgba(239,68,68,.25); }
    .badge.gold{ border-color: rgba(250,204,21,.28); }
    .badge.cyan{ border-color: rgba(34,211,238,.25); }

    /* ====== Start overlay ====== */
    .overlay{
      position:fixed;
      inset:0;
      z-index: 20;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1100px 680px at 50% 25%, rgba(30,41,59,.62), rgba(2,6,23,.92));
      padding: 18px;
    }
    .panel{
      width: min(680px, 92vw);
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 46px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .panel .head{
      padding: 16px 18px 12px 18px;
      border-bottom: 1px solid rgba(148,163,184,.14);
    }
    .panel .head h1{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .panel .head .desc{
      margin-top: 6px;
      color: rgba(148,163,184,.95);
      font-weight: 850;
      font-size: 12px;
      line-height: 1.35;
    }
    .panel .body{
      padding: 14px 18px 16px 18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .panel .body{ grid-template-columns: 1fr; }
    }
    .row{
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.45);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .row .lab{ font-weight: 950; font-size: 12px; color: rgba(226,232,240,.95); }
    .row .val{ margin-top: 6px; font-weight: 900; font-size: 12px; color: rgba(148,163,184,.95); }

    .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 12px 18px 16px 18px;
      border-top: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.55);
    }
    .btn{
      pointer-events:auto;
      cursor:pointer;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.70);
      color: rgba(226,232,240,.96);
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 950;
      font-size: 13px;
      box-shadow: 0 14px 26px rgba(0,0,0,.25);
      user-select:none;
      -webkit-user-select:none;
    }
    .btn.primary{
      border-color: rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
    }
    .btn:active{ transform: translateY(1px); }

    /* ====== End overlay ====== */
    .end{
      position:fixed;
      inset:0;
      z-index: 30;
      display:none;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1100px 680px at 50% 25%, rgba(30,41,59,.62), rgba(2,6,23,.92));
      padding: 18px;
    }
    .end.show{ display:flex; }
    .end .panel .body{ grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 720px){
      .end .panel .body{ grid-template-columns: 1fr; }
    }

    .kpi{
      font-weight: 1000;
      font-size: 22px;
      margin-top: 6px;
      letter-spacing:.2px;
    }
    .grade{
      font-size: 34px;
      font-weight: 1100;
      letter-spacing:.5px;
    }
    .grade.sss{ color: rgba(250,204,21,.95); text-shadow: 0 0 18px rgba(250,204,21,.18); }
    .grade.ss{ color: rgba(34,211,238,.95); text-shadow: 0 0 18px rgba(34,211,238,.14); }
    .grade.s{ color: rgba(34,197,94,.95); text-shadow: 0 0 18px rgba(34,197,94,.14); }
    .grade.a{ color: rgba(167,139,250,.95); }
    .grade.b{ color: rgba(226,232,240,.92); opacity:.92; }
    .grade.c{ color: rgba(148,163,184,.95); opacity:.92; }
  </style>

  <!-- ‚úÖ IMPORTANT: Load global FX + UI + HUD BEFORE engine -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- Quest manager + Engine (IIFE) -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
</head>

<body>
  <div class="app">

    <!-- A-Frame scene (background only) -->
    <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true; colorManagement: true">
      <a-entity id="rig">
        <a-camera id="cam" position="0 1.6 0" look-controls="enabled:true" wasd-controls="enabled:false"></a-camera>
      </a-entity>

      <!-- subtle background -->
      <a-sky color="#050b1a"></a-sky>

      <!-- tiny stars -->
      <a-entity position="0 1.6 -4">
        <a-entity geometry="primitive:sphere; radius:0.03" material="color:#93c5fd; opacity:0.35" position="-1.6 1.1 -2.2"></a-entity>
        <a-entity geometry="primitive:sphere; radius:0.02" material="color:#e2e8f0; opacity:0.25" position="1.2 0.8 -2.6"></a-entity>
        <a-entity geometry="primitive:sphere; radius:0.02" material="color:#fbbf24; opacity:0.22" position="0.2 1.4 -2.0"></a-entity>
      </a-entity>
    </a-scene>

    <!-- DOM playfield -->
    <div id="fg-layer" aria-label="Food Groups VR playfield"></div>

    <!-- crosshair -->
    <div id="reticle" class="reticle"></div>

    <!-- lock ring -->
    <div class="lockhud">
      <div id="lockring" class="lockring">
        <div class="prog" id="lockprog"></div>
        <div class="charge" id="chargeprog"></div>
      </div>
    </div>

    <!-- HUD (hha-hud.js will fill from events) -->
    <div class="hud">
      <div class="hud-top">
        <div class="card scorecard">
          <div class="scoregrid">
            <div>
              <div class="muted">SCORE</div>
              <div class="big"><span id="hud-score">0</span></div>
            </div>
            <div class="pill">üî• COMBO <span id="hud-combo">0</span></div>
            <div class="pill">üíî MISS <span id="hud-miss">0</span></div>
            <div class="pill">üõ°Ô∏è <span id="hud-shield">0</span></div>
          </div>
        </div>

        <div class="rightstack">
          <div class="card timecard">
            <div class="muted">TIME</div>
            <div class="big"><span id="hud-time">0</span>s</div>
            <div class="subtle" id="hud-rank">Grade: C</div>
          </div>

          <div class="card questcard">
            <div class="qtitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
            <div class="qline">
              <div class="lbl" id="hud-goal">‚Äî</div>
              <div class="val" id="hud-goal-prog">0/0</div>
            </div>
            <div class="qline">
              <div class="lbl" id="hud-mini">‚Äî</div>
              <div class="val" id="hud-mini-prog">0/0</div>
            </div>
            <div class="subtle">
              ‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="hud-group">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <div class="hud-bottom">
        <div class="coach">
          <div class="avatar">
            <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡πâ‡∏ä‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ -->
            <img id="hud-coach-img" src="./img/coach-neutral.png" alt="coach" />
          </div>
          <div class="bubble" id="hud-coach">‡πÅ‡∏ï‡∏∞ Start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô ‚ú®</div>
        </div>

        <div class="miniBadges">
          <div class="badge cyan" id="badge-mode">PLAY</div>
          <div class="badge" id="badge-diff">NORMAL</div>
          <div class="badge warn" id="badge-panic" style="display:none;">‚è∞ PANIC</div>
          <div class="badge gold" id="badge-rush" style="display:none;">üöÄ RUSH</div>
          <div class="badge warn" id="badge-wave" style="display:none;">‚ö†Ô∏è WAVE</div>
        </div>
      </div>
    </div>

    <!-- START OVERLAY -->
    <div id="startOverlay" class="overlay">
      <div class="panel">
        <div class="head">
          <h1>Food Groups VR ü•ó</h1>
          <div class="desc">
            ‡πÄ‡∏Å‡∏°‡∏ù‡∏∂‡∏Å ‚Äú5 ‡∏´‡∏°‡∏π‡πà‚Äù ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à: ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏à‡∏£‡∏¥‡∏á / ‡∏à‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î / ‡∏°‡∏µ RUSH + WAVE + DECOY + ‡∏ö‡∏≠‡∏™‡∏Ç‡∏¢‡∏∞ üß®<br/>
            ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ (seeded random) ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô
          </div>
        </div>

        <div class="body">
          <div class="row">
            <div class="lab">Difficulty</div>
            <div class="val" id="uiDiff">‚Äî</div>
          </div>
          <div class="row">
            <div class="lab">Time</div>
            <div class="val" id="uiTime">‚Äî</div>
          </div>
          <div class="row">
            <div class="lab">Run mode</div>
            <div class="val" id="uiMode">‚Äî</div>
          </div>
          <div class="row">
            <div class="lab">Seed (research)</div>
            <div class="val" id="uiSeed">‚Äî</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnGaze">Toggle GAZE: ON</button>
          <button class="btn primary" id="btnStart">START ‚ñ∂</button>
        </div>
      </div>
    </div>

    <!-- END OVERLAY -->
    <div id="endOverlay" class="end">
      <div class="panel">
        <div class="head">
          <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô üéâ</h1>
          <div class="desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡πà‡∏≤‡∏ô event `hha:end` ‡πÅ‡∏•‡∏∞ logger (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ) ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        </div>
        <div class="body">
          <div class="row">
            <div class="lab">GRADE</div>
            <div class="kpi grade c" id="endGrade">C</div>
          </div>
          <div class="row">
            <div class="lab">SCORE</div>
            <div class="kpi" id="endScore">0</div>
          </div>
          <div class="row">
            <div class="lab">MAX COMBO</div>
            <div class="kpi" id="endComboMax">0</div>
          </div>
          <div class="row">
            <div class="lab">MISS</div>
            <div class="kpi" id="endMiss">0</div>
          </div>
          <div class="row">
            <div class="lab">GOALS</div>
            <div class="kpi" id="endGoals">0/0</div>
          </div>
          <div class="row">
            <div class="lab">MINIS</div>
            <div class="kpi" id="endMinis">0/0</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btnRestart">RESTART ‚Üª</button>
          <button class="btn primary" id="btnCloseEnd">CLOSE</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ===== boot glue (no modules) =====
    (function(){
      'use strict';

      function qs(sel){ return document.querySelector(sel); }
      function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

      const sp = new URLSearchParams(location.search);
      const diff = (sp.get('diff') || 'normal').toLowerCase();
      const time = clamp(sp.get('time') || 70, 20, 600);
      const run  = (sp.get('run') || 'play').toLowerCase(); // play | research
      const seed = sp.get('seed') || '';

      const startOverlay = qs('#startOverlay');
      const endOverlay   = qs('#endOverlay');

      const uiDiff = qs('#uiDiff');
      const uiTime = qs('#uiTime');
      const uiMode = qs('#uiMode');
      const uiSeed = qs('#uiSeed');

      const badgeMode  = qs('#badge-mode');
      const badgeDiff  = qs('#badge-diff');
      const badgePanic = qs('#badge-panic');
      const badgeRush  = qs('#badge-rush');
      const badgeWave  = qs('#badge-wave');

      const reticle = qs('#reticle');
      const lockring = qs('#lockring');
      const lockprog = qs('#lockprog');
      const chargeprog = qs('#chargeprog');

      const btnStart = qs('#btnStart');
      const btnGaze  = qs('#btnGaze');

      const btnRestart = qs('#btnRestart');
      const btnCloseEnd = qs('#btnCloseEnd');

      // start UI
      uiDiff.textContent = diff.toUpperCase();
      uiTime.textContent = time + 's';
      uiMode.textContent = run.toUpperCase();
      uiSeed.textContent = (run === 'research') ? (seed ? seed : '(auto)') : '‚Äî';

      badgeMode.textContent = run.toUpperCase();
      badgeDiff.textContent = diff.toUpperCase();

      // Wait scripts ready
      function whenReady(fn){
        const t0 = Date.now();
        const tick = () => {
          const ok = window.GroupsVR && window.GroupsVR.GameEngine && typeof window.GroupsVR.GameEngine.start === 'function';
          if (ok) return fn();
          if (Date.now() - t0 > 8000){
            console.error('[groups-vr] Engine not ready: check script paths');
            // still show fever bar for debugging
            try{ window.FeverUI && window.FeverUI.ensureFeverBar && window.FeverUI.ensureFeverBar(); }catch{}
            return;
          }
          setTimeout(tick, 60);
        };
        tick();
      }

      let gazeOn = true;

      function bindGameSignals(){
        // Reticle feedback
        window.addEventListener('groups:reticle', (ev)=>{
          const st = ev && ev.detail ? ev.detail.state : '';
          reticle.classList.remove('ok','miss','perfect');
          if (st === 'ok') reticle.classList.add('ok');
          else if (st === 'miss') reticle.classList.add('miss');
          else if (st === 'perfect') reticle.classList.add('perfect');

          setTimeout(()=>{ reticle.classList.remove('ok','miss','perfect'); }, 160);
        });

        // Lock ring feedback
        window.addEventListener('groups:lock', (ev)=>{
          const d = ev && ev.detail ? ev.detail : {};
          if (!d.on){
            lockring.classList.remove('on','charging');
            lockring.style.left = '-9999px';
            lockring.style.top  = '-9999px';
            lockprog.style.setProperty('--p', '0deg');
            chargeprog.style.setProperty('--c', '0deg');
            return;
          }
          lockring.classList.add('on');
          lockring.style.left = (d.x||window.innerWidth/2) + 'px';
          lockring.style.top  = (d.y||window.innerHeight*0.52) + 'px';

          const pdeg = Math.round(clamp(d.prog||0,0,1) * 360);
          const cdeg = Math.round(clamp(d.charge||0,0,1) * 360);

          lockprog.style.setProperty('--p', pdeg + 'deg');
          chargeprog.style.setProperty('--c', cdeg + 'deg');

          if ((d.charge||0) > 0.01) lockring.classList.add('charging');
          else lockring.classList.remove('charging');
        });

        // Panic / Rush / Wave badges
        window.addEventListener('hha:panic', (ev)=>{
          const on = !!(ev && ev.detail && ev.detail.on);
          badgePanic.style.display = on ? 'inline-flex' : 'none';
        });
        window.addEventListener('hha:rush', (ev)=>{
          const on = !!(ev && ev.detail && ev.detail.on);
          badgeRush.style.display = on ? 'inline-flex' : 'none';
        });
        window.addEventListener('groups:danger', (ev)=>{
          const on = !!(ev && ev.detail && ev.detail.on);
          badgeWave.style.display = on ? 'inline-flex' : 'none';
          if (!on) return;
          setTimeout(()=>{ badgeWave.style.display = 'none'; }, 900);
        });

        // End overlay
        window.addEventListener('hha:end', (ev)=>{
          const d = ev && ev.detail ? ev.detail : {};
          const grade = String(d.grade||'C').toUpperCase();

          const endGrade = qs('#endGrade');
          const endScore = qs('#endScore');
          const endComboMax = qs('#endComboMax');
          const endMiss = qs('#endMiss');
          const endGoals = qs('#endGoals');
          const endMinis = qs('#endMinis');

          endGrade.textContent = grade;
          endGrade.className = 'kpi grade ' + grade.toLowerCase();
          endScore.textContent = String(d.scoreFinal||0);
          endComboMax.textContent = String(d.comboMax||0);
          endMiss.textContent = String(d.misses||0);
          endGoals.textContent = String(d.goalsCleared||0) + '/' + String(d.goalsTotal||0);
          endMinis.textContent = String(d.miniCleared||0) + '/' + String(d.miniTotal||0);

          endOverlay.classList.add('show');
        });
      }

      function startGame(){
        whenReady(() => {
          const layer = qs('#fg-layer');
          const cam   = qs('#cam');

          // ensure UI exists
          try{ window.FeverUI && window.FeverUI.ensureFeverBar && window.FeverUI.ensureFeverBar(); }catch{}

          // wire engine
          window.GroupsVR.GameEngine.setLayerEl(layer);
          window.GroupsVR.GameEngine.setCameraEl(cam);
          window.GroupsVR.GameEngine.setTimeLeft(time);
          window.GroupsVR.GameEngine.setGaze(gazeOn);

          // start!
          window.GroupsVR.GameEngine.start(diff, {
            runMode: run,
            seed: seed || undefined
          });

          startOverlay.style.display = 'none';
        });
      }

      function stopGame(reason){
        try{ window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.stop && window.GroupsVR.GameEngine.stop(reason||'stop'); }catch{}
      }

      // buttons
      btnGaze.addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        btnGaze.textContent = 'Toggle GAZE: ' + (gazeOn ? 'ON' : 'OFF');
        try{ window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.setGaze && window.GroupsVR.GameEngine.setGaze(gazeOn); }catch{}
      });

      btnStart.addEventListener('click', ()=>{
        bindGameSignals();
        startGame();
      });

      btnRestart.addEventListener('click', ()=>{
        endOverlay.classList.remove('show');
        stopGame('restart');
        startOverlay.style.display = 'flex';
        // auto start again quickly
        setTimeout(()=>{ btnStart.click(); }, 120);
      });

      btnCloseEnd.addEventListener('click', ()=>{
        endOverlay.classList.remove('show');
        startOverlay.style.display = 'flex';
      });

      // keyboard fallback
      window.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape'){
          stopGame('escape');
          startOverlay.style.display = 'flex';
        }
      });

      // Prime HUD text for first load
      try{
        window.dispatchEvent(new CustomEvent('hha:coach', { detail:{ text:'‡πÅ‡∏ï‡∏∞ START ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà + ‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡∏Ç‡∏¢‡∏∞ üòµ' } }));
      }catch{}
    })();
  </script>
</body>
</html>