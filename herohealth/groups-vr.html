<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION FIX-ALL
‚úÖ DOM emoji targets (#fg-layer)
‚úÖ Quest + Fever + HUD + Lock/Reticle via groups-ui.js (auto-create)
‚úÖ GameEngine IIFE: window.GroupsVR.GameEngine
‚úÖ Quest IIFE: window.GroupsQuest.createFoodGroupsQuest(diff)
‚úÖ Params: ?diff=easy|normal|hard&time=90&run=play|research&seed=xxx
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (for camera rotation only) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX (shared) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>

  <!-- Groups: Quest + Engine + UI (IIFE) -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
  <script src="./vr-groups/groups-ui.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.74);
      --stroke: rgba(148,163,184,.22);
      --text: rgba(229,231,235,.95);
      --muted: rgba(148,163,184,.85);

      /* safe zone (match engine clamp) */
      --safe-top: 118px;
      --safe-bot: 150px;
      --safe-l: 28px;
      --safe-r: 28px;
    }
    html,body{
      height:100%;
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", Arial;
      overflow:hidden;
      touch-action: manipulation;
    }

    /* ===== A-Frame canvas behind ===== */
    a-scene, canvas{
      position: fixed !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 0 !important;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(30,41,59,.45), rgba(2,6,23,1) 70%);
    }

    /* ===== Targets layer ===== */
    #fg-layer{
      position: fixed;
      inset: 0;
      z-index: 20;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    /* base target */
    .fg-target{
      position: absolute;
      left: var(--x, 50%);
      top: var(--y, 52%);
      transform: translate(-50%, -50%) scale(var(--s, 1));
      width: 132px;
      height: 132px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 54px;
      line-height: 1;
      cursor: pointer;
      will-change: transform, left, top, opacity, filter;

      /* feel */
      filter: drop-shadow(0 14px 34px rgba(0,0,0,.45));
      transition: transform .10s ease, opacity .16s ease, filter .16s ease;
      pointer-events: auto;
    }

    /* ring + glass */
    .fg-target::before{
      content:'';
      position:absolute;
      inset: 8px;
      border-radius: 999px;
      background:
        radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.20), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.22);
      pointer-events:none;
    }
    .fg-target::after{
      content:'';
      position:absolute;
      inset:-6px;
      border-radius:999px;
      border: 2px solid rgba(148,163,184,.16);
      pointer-events:none;
      opacity:.65;
    }

    /* Good vs Junk */
    .fg-good{
      background: radial-gradient(120px 90px at 30% 30%, rgba(34,197,94,.22), rgba(34,197,94,.06) 55%, rgba(2,6,23,.00) 70%);
    }
    .fg-junk{
      background: radial-gradient(120px 90px at 30% 30%, rgba(239,68,68,.22), rgba(239,68,68,.06) 55%, rgba(2,6,23,.00) 70%);
    }
    .fg-boss{
      filter: drop-shadow(0 16px 40px rgba(239,68,68,.28)) drop-shadow(0 14px 34px rgba(0,0,0,.45));
    }
    .fg-decoy{
      /* subtle purple tint for ‚Äúinvert trap‚Äù */
      background: radial-gradient(120px 90px at 30% 30%, rgba(168,85,247,.22), rgba(168,85,247,.06) 55%, rgba(2,6,23,.00) 70%);
    }

    /* spawn/exit */
    .fg-target.spawn{ opacity: 0; transform: translate(-50%,-50%) scale(.70); }
    .fg-target.show { opacity: 1; transform: translate(-50%,-50%) scale(var(--s,1)); }
    .fg-target.hit  { opacity: 0; transform: translate(-50%,-50%) scale(.82); filter: blur(.2px); }
    .fg-target.out  { opacity: 0; transform: translate(-50%,-50%) scale(.92); }

    /* lock highlight */
    .fg-target.lock::after{
      border-color: rgba(59,130,246,.60);
      opacity: 1;
      box-shadow: 0 0 0 3px rgba(59,130,246,.14), 0 0 26px rgba(59,130,246,.22);
    }

    /* boss rage hint */
    .fg-target.rage::after{
      border-color: rgba(251,113,133,.55);
      box-shadow: 0 0 0 4px rgba(239,68,68,.12), 0 0 28px rgba(239,68,68,.22);
      animation: ragePulse .8s ease-in-out infinite;
    }
    @keyframes ragePulse{
      0%,100%{ opacity:.75; }
      50%{ opacity:1; }
    }

    /* boss HP bar */
    .bossbar{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 14px;
      height: 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      pointer-events:none;
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(251,146,60,.90));
      border-radius: 999px;
      box-shadow: 0 8px 22px rgba(239,68,68,.22);
    }

    /* ===== UI visuals created by groups-ui.js ===== */
    .fg-reticle{
      position: fixed;
      left: 50%;
      top: 50%;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      border: 2px solid rgba(229,231,235,.35);
      box-shadow: 0 0 0 6px rgba(2,6,23,.35);
      z-index: 34;
      pointer-events: none;
      opacity: .9;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .fg-reticle.ok{
      border-color: rgba(34,197,94,.75);
      box-shadow: 0 0 0 7px rgba(34,197,94,.14);
      transform: translate(-50%,-50%) scale(1.06);
    }
    .fg-reticle.miss{
      border-color: rgba(239,68,68,.78);
      box-shadow: 0 0 0 10px rgba(239,68,68,.16);
      transform: translate(-50%,-50%) scale(1.10);
    }
    .fg-reticle.perfect{
      border-color: rgba(59,130,246,.85);
      box-shadow: 0 0 0 10px rgba(59,130,246,.16);
      transform: translate(-50%,-50%) scale(1.12);
    }

    .fg-edgePulse{
      position: fixed;
      inset: 0;
      z-index: 33;
      pointer-events:none;
      opacity: 0;
      transition: opacity .18s ease;
      box-shadow:
        inset 0 0 0 0 rgba(0,0,0,0),
        inset 0 0 0 3px rgba(239,68,68,.00);
    }
    .fg-edgePulse.on{ opacity: 1; }
    .fg-edgePulse.beat{
      animation: edgeBeat .26s ease-out;
    }
    @keyframes edgeBeat{
      0%{
        box-shadow:
          inset 0 0 0 0 rgba(0,0,0,0),
          inset 0 0 0 2px rgba(239,68,68,.00),
          0 0 0 0 rgba(0,0,0,0);
        opacity: .7;
      }
      100%{
        box-shadow:
          inset 0 0 0 0 rgba(0,0,0,0),
          inset 0 0 0 7px rgba(239,68,68,.18),
          0 0 40px rgba(239,68,68,.10);
        opacity: 1;
      }
    }

    .fg-lockUI{
      position: fixed;
      left: 0;
      top: 0;
      width: 120px;
      height: 120px;
      z-index: 36;
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.40));
    }
    .fg-lockUI.on{ opacity: 1; }
    .fg-lockUI svg{ display:block; }
    .fg-lockUI .ringBack{
      fill: transparent;
      stroke: rgba(148,163,184,.18);
      stroke-width: 8;
    }
    .fg-lockUI .ringProg{
      fill: transparent;
      stroke: rgba(59,130,246,.85);
      stroke-width: 8;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 60px 60px;
    }
    .fg-lockUI .ringCharge{
      fill: transparent;
      stroke: rgba(34,197,94,.88);
      stroke-width: 8;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 60px 60px;
    }

    /* afterimage (engine spawns) */
    .fg-afterimage{
      position: fixed;
      left: 0;
      top: 0;
      z-index: 19;
      pointer-events:none;
      opacity: .0;
      animation: afterPop .42s ease-out forwards;
    }
    .fg-afterimage-inner{
      font-size: 54px;
      filter: blur(.1px);
      opacity: .8;
      transform: translate(-50%,-50%) scale(.92);
    }
    @keyframes afterPop{
      0%{ opacity: 0; }
      20%{ opacity: .65; }
      100%{ opacity: 0; transform: translateY(8px); }
    }

    /* ===== Start Overlay ===== */
    #startOverlay{
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: radial-gradient(1200px 900px at 50% 30%, rgba(30,41,59,.55), rgba(2,6,23,.92));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #startCard{
      width: min(780px, 92vw);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.76);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding: 16px 16px 14px;
    }
    #startCard h1{
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    #startMeta{
      margin-top: 8px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      opacity: .88;
      font-size: 13px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
    }
    #startHint{
      margin-top: 12px;
      font-size: 13px;
      opacity: .85;
      line-height: 1.45;
    }
    #startActions{
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    button{
      pointer-events: auto;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.65);
      color: rgba(229,231,235,.95);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 900;
      font-size: 14px;
    }
    button.primary{
      background: rgba(34,197,94,.20);
      border-color: rgba(34,197,94,.35);
    }
  </style>
</head>

<body>

  <!-- A-Frame scene (camera orientation only) -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; precision: mediump; alpha: true"
  >
    <a-entity id="rig" position="0 1.6 0">
      <a-camera
        id="camera"
        wasd-controls-enabled="false"
        look-controls="pointerLockEnabled: false"
        position="0 0 0"
      ></a-camera>
    </a-entity>

    <a-sky color="#0b1220"></a-sky>
  </a-scene>

  <!-- Targets -->
  <div id="fg-layer" aria-label="Food Groups targets layer"></div>

  <!-- Start overlay -->
  <div id="startOverlay">
    <div id="startCard">
      <h1>üçΩÔ∏è Food Groups VR ‚Äî ‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 5 ‡∏´‡∏°‡∏π‡πà</h1>

      <div id="startMeta">
        <div class="pill">Diff: <b id="mDiff">-</b></div>
        <div class="pill">Time: <b id="mTime">-</b>s</div>
        <div class="pill">Mode: <b id="mMode">-</b></div>
      </div>

      <div id="startHint">
        ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô: ‚Äú‡∏à‡πâ‡∏≠‡∏á‚Äù ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏£‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î + ‚Äú‡πÅ‡∏ï‡∏∞‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡πÅ‡∏ï‡∏∞ (Aim Assist)<br/>
        üéØ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ GOAL/MINI ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö<br/>
        üî• FEVER ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ß + ‡πÑ‡∏î‡πâ üõ°Ô∏è Shield ‡∏Å‡∏±‡∏ô‡∏Ç‡∏¢‡∏∞
      </div>

      <div id="startActions">
        <button id="btnResearch">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button>
        <button id="btnStart" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      function qp(name, fallback){
        try{
          const sp = new URLSearchParams(location.search);
          const v = sp.get(name);
          return (v == null || v === '') ? fallback : v;
        }catch{
          return fallback;
        }
      }
      function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

      const diff = String(qp('diff','normal')).toLowerCase();
      const time = clamp(qp('time','90'), 20, 900) | 0;
      const run  = String(qp('run','play')).toLowerCase(); // play | research
      const seed = String(qp('seed',''));

      const mDiff = document.getElementById('mDiff');
      const mTime = document.getElementById('mTime');
      const mMode = document.getElementById('mMode');

      if (mDiff) mDiff.textContent = diff;
      if (mTime) mTime.textContent = String(time);
      if (mMode) mMode.textContent = (run === 'research') ? 'research' : 'play';

      const overlay = document.getElementById('startOverlay');
      const btnStart = document.getElementById('btnStart');
      const btnResearch = document.getElementById('btnResearch');

      function startEngine(runMode){
        runMode = (runMode === 'research') ? 'research' : 'play';

        // UI ping if available
        try { window.GroupsUI && window.GroupsUI.ping && window.GroupsUI.ping(); } catch {}

        const layerEl = document.getElementById('fg-layer');
        const camEl   = document.getElementById('camera');

        if (!window.GroupsVR || !window.GroupsVR.GameEngine){
          console.error('[GroupsVR] GameEngine not found');
          alert('GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå ./vr-groups/GameEngine.js');
          return;
        }
        if (!layerEl){
          console.error('[GroupsVR] fg-layer missing');
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö #fg-layer');
          return;
        }

        // bind
        try { window.GroupsVR.GameEngine.setLayerEl(layerEl); } catch(e){ console.warn(e); }
        try { window.GroupsVR.GameEngine.setCameraEl(camEl); } catch(e){ console.warn(e); }
        try { window.GroupsVR.GameEngine.setTimeLeft(time); } catch(e){ console.warn(e); }

        // hide overlay
        if (overlay) overlay.style.display = 'none';

        // start
        try{
          window.GroupsVR.GameEngine.start(diff, {
            runMode: runMode,
            seed: seed || undefined
          });
        }catch(e){
          console.error(e);
          alert('Start error: ' + (e && e.message ? e.message : e));
        }
      }

      // Buttons
      if (btnStart) btnStart.addEventListener('click', () => startEngine('play'));
      if (btnResearch) btnResearch.addEventListener('click', () => startEngine('research'));

      // Auto start only when run=play and user likely wants instant
      // (still safe if scripts not ready yet ‚Üí wait a bit)
      if (run === 'play'){
        setTimeout(() => {
          // only auto start if overlay still visible (not clicked)
          if (overlay && overlay.style.display !== 'none'){
            startEngine('play');
          }
        }, 450);
      } else if (run === 'research'){
        // keep overlay; user chooses start (or you can auto-start research by uncomment)
        // setTimeout(() => startEngine('research'), 450);
      }
    })();
  </script>

</body>
</html>