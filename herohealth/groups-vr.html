<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (DOM Targets + Lock Ring)
‚úÖ ‡πÉ‡∏ä‡πâ GameEngine.js + groups-quests.js + groups-hud-quest.js
‚úÖ HUD / Group banner / Start overlay / Stun overlay
‚úÖ Lock ring UI (‡∏ü‡∏±‡∏á groups:lock)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (scene background only) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./vr-groups/groups-vr.css" />

  <!-- Optional global FX (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ /vr/particles.js ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) -->
  <script src="./vr/particles.js" defer></script>

  <!-- Game scripts (ORDER ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/groups-hud-quest.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* ‡∏Å‡∏±‡∏ô flash ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î */
    body { background:#020617; }
  </style>
</head>

<body>

  <!-- A-Frame scene (‡πÄ‡∏õ‡πá‡∏ô‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á) -->
  <a-scene embedded vr-mode-ui="enabled:true" renderer="antialias:true">
    <a-entity position="0 1.6 0">
      <a-camera wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
    </a-entity>

    <!-- simple ambient -->
    <a-entity light="type:ambient;intensity:0.9"></a-entity>
    <a-entity light="type:directional;intensity:0.6" position="1 2 1"></a-entity>

    <a-sky color="#081022"></a-sky>
  </a-scene>

  <!-- GAMEPLAY LAYER -->
  <div id="fg-layer" class="fg-layer"></div>

  <!-- HUD TOP -->
  <div class="hud-top">
    <!-- LEFT: Score/Combo/Miss -->
    <div class="hud-card hud-left">
      <div class="hud-row">
        <div class="hud-title">SCORE</div>
        <div id="hud-score" class="hud-val">0</div>
      </div>
      <div class="hud-row">
        <div class="hud-title">COMBO</div>
        <div id="hud-combo" class="hud-val">0</div>
      </div>
      <div class="hud-row">
        <div class="hud-title">MISS</div>
        <div id="hud-miss" class="hud-val">0</div>
      </div>
    </div>

    <!-- MID: Group + Timer + Power -->
    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div id="hud-group" class="hud-group">‡∏´‡∏°‡∏π‡πà 1</div>
        <div id="hud-time" class="hud-timer">90s</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <div>POWER</div>
          <div id="hud-powerText">0/7</div>
        </div>
        <div class="power-bar">
          <div id="hud-powerFill" class="power-fill"></div>
        </div>
      </div>

      <div class="quest-wrap">
        <div class="quest-line">
          <div class="q-badge">GOAL</div>
          <div id="hud-goal-title" class="q-text">‚Äî</div>
          <div id="hud-goal-val" class="q-num">0/0</div>
        </div>
        <div class="quest-line">
          <div class="q-badge mini">MINI</div>
          <div id="hud-mini-title" class="q-text">‚Äî</div>
          <div id="hud-mini-val" class="q-num">0/0</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Rank -->
    <div class="hud-card hud-right">
      <div class="rank-box">
        <div class="rank-title">RANK</div>
        <div id="hud-rank" class="rank-grade">C</div>
      </div>
      <div class="rank-sub">
        <div>ACC</div>
        <div id="hud-acc">0%</div>
      </div>
      <div class="rank-sub">
        <div>QUEST</div>
        <div id="hud-qpct">0%</div>
      </div>
    </div>
  </div>

  <!-- GROUP BANNER -->
  <div id="groupBanner" class="group-banner" style="display:none">
    <div id="groupBannerText" class="group-banner-text">‡∏´‡∏°‡∏π‡πà 1</div>
    <div id="groupBannerSub" class="group-banner-sub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà!</div>
  </div>

  <!-- LOCK RING -->
  <div id="lockRing" class="lock-ring" style="display:none">
    <div class="lock-core"></div>
    <div id="lockProg" class="lock-prog"></div>
    <div id="lockCharge" class="lock-charge"></div>
  </div>

  <!-- STUN OVERLAY -->
  <div id="stunOverlay" class="stun-overlay" style="display:none">
    <div class="stun-card">
      <div class="stun-title">STUN!</div>
      <div class="stun-sub">‡πÇ‡∏î‡∏ô junk ‚Äî ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</div>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å! ‡∏£‡∏∞‡∏ß‡∏±‡∏á Junk üö´ ‡πÅ‡∏•‡∏∞ Decoy ‚ùì<br/>
        ‡πÅ‡∏ï‡∏∞‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ / ‡πÅ‡∏ï‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>

      <div class="start-grid">
        <div class="pill">üéØ Correct = ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô+‡∏ä‡∏≤‡∏£‡πå‡∏à</div>
        <div class="pill">‚ùå Wrong = ‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô+miss</div>
        <div class="pill">üö´ Junk = Stun 0.8s</div>
        <div class="pill">üß† Boss = ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ</div>
      </div>

      <div class="start-actions">
        <button id="btnPlay" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (PLAY)</button>
        <button id="btnResearch" class="btn ghost">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (RESEARCH)</button>
      </div>

      <div class="start-note">
        diff/time ‡πÉ‡∏ä‡πâ query ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô <b>?diff=easy&time=80&run=play</b>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function q(name, def){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? def;
    }
    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

    // ===== UI refs =====
    const $ = (id)=>document.getElementById(id);
    const hudScore = $('hud-score');
    const hudCombo = $('hud-combo');
    const hudMiss  = $('hud-miss');
    const hudGroup = $('hud-group');
    const hudTime  = $('hud-time');
    const hudRank  = $('hud-rank');
    const hudAcc   = $('hud-acc');
    const hudQPct  = $('hud-qpct');

    const hudPowerText = $('hud-powerText');
    const hudPowerFill = $('hud-powerFill');

    const groupBanner = $('groupBanner');
    const groupBannerText = $('groupBannerText');
    const groupBannerSub  = $('groupBannerSub');

    const lockRing = $('lockRing');
    const lockProg = $('lockProg');
    const lockCharge = $('lockCharge');

    const stunOverlay = $('stunOverlay');
    const startOverlay = $('startOverlay');
    const btnPlay = $('btnPlay');
    const btnResearch = $('btnResearch');

    // ===== Engine boot =====
    function boot(runMode){
      const diff = String(q('diff','normal')).toLowerCase();
      const time = parseInt(q('time','90'),10) || 90;

      const seed = q('seed', '');
      const opts = { runMode, seed };

      const layer = $('fg-layer');

      if (!window.GroupsVR || !window.GroupsVR.GameEngine){
        alert('GroupsVR.GameEngine not loaded');
        return;
      }

      window.GroupsVR.GameEngine.setLayerEl(layer);
      window.GroupsVR.GameEngine.setTimeLeft(time);
      window.GroupsVR.GameEngine.start(diff, opts);

      startOverlay.style.display = 'none';
    }

    btnPlay.addEventListener('click', ()=>boot(String(q('run','play')).toLowerCase() || 'play'));
    btnResearch.addEventListener('click', ()=>boot('research'));

    // ===== Events binding =====
    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail||{};
      if (hudScore) hudScore.textContent = String(d.score|0);
      if (hudCombo) hudCombo.textContent = String(d.combo|0);
      if (hudMiss)  hudMiss.textContent  = String(d.misses|0);
    }, {passive:true});

    window.addEventListener('hha:time', (ev)=>{
      const d = ev.detail||{};
      if (hudTime) hudTime.textContent = String(d.left|0) + 's';

      // panic blink ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢
      const left = d.left|0;
      document.documentElement.classList.toggle('panic', left>0 && left<=10);
    }, {passive:true});

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail||{};
      if (typeof d.grade === 'string' && hudRank) hudRank.textContent = d.grade;
      if (typeof d.accuracy === 'number' && hudAcc) hudAcc.textContent = (d.accuracy|0) + '%';
      if (typeof d.questsPct === 'number' && hudQPct) hudQPct.textContent = (d.questsPct|0) + '%';
    }, {passive:true});

    window.addEventListener('groups:power', (ev)=>{
      const d = ev.detail||{};
      const c = d.charge|0;
      const th = Math.max(1, d.threshold|0);
      if (hudGroup && d.groupName) hudGroup.textContent = d.groupName;
      if (hudPowerText) hudPowerText.textContent = `${c}/${th}`;
      if (hudPowerFill){
        hudPowerFill.style.width = Math.round(clamp(c/th,0,1)*100) + '%';
        hudPowerFill.classList.add('pulse');
        setTimeout(()=>hudPowerFill.classList.remove('pulse'), 160);
      }
    }, {passive:true});

    window.addEventListener('groups:group_change', (ev)=>{
      const d = ev.detail||{};
      const label = d.label || '';
      if (hudGroup && label) hudGroup.textContent = label;

      // banner pop
      if (groupBanner){
        groupBannerText.textContent = label || '‚Äî';
        groupBannerSub.textContent = '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà!';
        groupBanner.style.display = '';
        groupBanner.classList.remove('pop');
        void groupBanner.offsetWidth;
        groupBanner.classList.add('pop');
        setTimeout(()=>{ groupBanner.style.display='none'; }, 900);
      }
    }, {passive:true});

    window.addEventListener('groups:stun', (ev)=>{
      const d = ev.detail||{};
      const on = !!d.on;
      if (!stunOverlay) return;
      stunOverlay.style.display = on ? '' : 'none';
      if (on){
        stunOverlay.classList.remove('pop');
        void stunOverlay.offsetWidth;
        stunOverlay.classList.add('pop');
        setTimeout(()=>{ stunOverlay.style.display='none'; }, (d.ms|0) || 800);
      }
    }, {passive:true});

    window.addEventListener('groups:lock', (ev)=>{
      const d = ev.detail||{};
      const on = !!d.on;
      if (!lockRing) return;

      if (!on){
        lockRing.style.display = 'none';
        return;
      }
      lockRing.style.display = '';

      // position ring to target center (px)
      const x = Number(d.x)|| (window.innerWidth/2);
      const y = Number(d.y)|| (window.innerHeight/2);
      lockRing.style.transform = `translate(-50%,-50%) translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;

      // progress vars
      const prog = clamp(d.prog,0,1);
      const charge = clamp(d.charge,0,1);

      lockRing.style.setProperty('--p', String(prog));
      lockRing.style.setProperty('--c', String(charge));
    }, {passive:true});

    // End
    window.addEventListener('hha:end', (ev)=>{
      // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà start overlay
      startOverlay.style.display = '';
    }, {passive:true});
  </script>

</body>
</html>