<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --danger:#f97316;
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Prompt", sans-serif;
      background:#000;
      color:var(--text-main);
      overflow:hidden;
    }

    /* ===== Layout overlay ===== */
    .hud-root{
      position:fixed;
      inset:0;
      pointer-events:none;
      font-size:14px;
    }

    .hud-card{
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(17,24,39,0.96));
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 18px 45px rgba(15,23,42,0.85);
      padding:14px 18px;
    }

    .hud-title{
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin:0 0 4px;
    }
    .hud-game{
      font-weight:600;
      font-size:16px;
      margin:0 0 8px;
    }

    .hud-top-left{
      position:absolute;
      top:14px;
      left:14px;
      width:260px;
    }

    .hud-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
    }
    .hud-label{
      font-size:11px;
      color:var(--text-soft);
    }
    .hud-value{
      font-size:14px;
      font-weight:600;
    }
    .hud-value--bad{ color:var(--danger); }

    .hud-mode-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.25);
      font-size:11px;
      margin-left:auto;
    }
    .hud-mode-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
    }

    .hud-grade-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.25);
      font-size:11px;
      margin-left:4px;
    }

    /* Quest panel */
    .hud-top-right{
      position:absolute;
      top:14px;
      right:14px;
      width:280px;
    }
    .quest-title{
      font-size:13px;
      font-weight:600;
      margin:0 0 4px;
    }
    .quest-mini{
      font-size:12px;
      color:var(--text-soft);
      margin:0 0 6px;
    }
    .quest-progress{
      font-size:11px;
      color:var(--text-soft);
      margin-top:4px;
    }
    .quest-bar{
      margin-top:4px;
      width:100%;
      height:4px;
      border-radius:999px;
      background:rgba(15,23,42,0.85);
      overflow:hidden;
    }
    .quest-bar-inner{
      height:100%;
      width:0;
      border-radius:inherit;
      background:var(--accent);
      transition:width .25s ease-out;
    }

    /* Fever gauge bottom-left */
    .hud-bottom-left{
      position:absolute;
      left:14px;
      bottom:14px;
      width:230px;
    }
    .fever-root{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.35);
    }
    .fever-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--text-soft);
    }
    .fever-bar-wrap{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
    }
    .fever-bar{
      height:100%;
      width:0;
      border-radius:inherit;
      background:var(--accent);
      transition:width .2s ease-out;
    }
    .fever-percent{
      font-size:12px;
      min-width:32px;
      text-align:right;
    }

    /* VR button */
    .hud-bottom-right{
      position:absolute;
      right:14px;
      bottom:14px;
    }
    .vr-btn{
      pointer-events:auto;
      padding:10px 20px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0b1120;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 12px 35px rgba(15,23,42,0.9);
    }

    /* Crosshair */
    .crosshair{
      position:absolute;
      top:50%;
      left:50%;
      width:16px;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(226,232,240,0.9);
      transform:translate(-50%,-50%);
      pointer-events:none;
    }

    /* Result modal */
    .result-wrap{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) scale(.96);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
    }
    .result-wrap.active{
      opacity:1;
      transform:translate(-50%,-50%) scale(1);
      pointer-events:auto;
    }
    .result-card{
      width:340px;
      background:linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 24px 60px rgba(15,23,42,0.95);
      padding:20px 22px 18px;
    }
    .result-title{
      font-size:16px;
      font-weight:600;
      margin:0 0 12px;
    }
    .result-row{
      display:flex;
      justify-content:space-between;
      margin:2px 0;
      font-size:13px;
    }
    .result-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    .btn-ghost,
    .btn-primary{
      pointer-events:auto;
      cursor:pointer;
      border-radius:999px;
      padding:8px 16px;
      font-size:13px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text-main);
    }
    .btn-ghost{
      border-color:rgba(148,163,184,0.6);
    }
    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#022c22;
      font-weight:600;
    }

    /* A-Frame canvas fill screen */
    a-scene{
      width:100vw;
      height:100vh;
    }
  </style>
</head>
<body>

  <!-- ======== HUD Overlay ======== -->
  <div class="hud-root">
    <!-- Top-left: Score -->
    <div class="hud-top-left hud-card">
      <div class="hud-row" style="align-items:flex-start;">
        <div>
          <p class="hud-title">HERO HEALTH ‚Ä¢ NUTRITION VR</p>
          <p class="hud-game">Food Groups</p>
        </div>
        <div class="hud-mode-pill">
          <span class="hud-mode-dot"></span>
          <span id="hud-mode-text">EASY ‚Ä¢ 80s</span>
        </div>
      </div>

      <div class="hud-row">
        <span class="hud-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
        <span id="hud-score" class="hud-value">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
        <span id="hud-combo" class="hud-value">0</span>
      </div>
      <div class="hud-row">
        <span class="hud-label">‡∏û‡∏•‡∏≤‡∏î</span>
        <span id="hud-miss" class="hud-value hud-value--bad">0</span>
      </div>
      <div class="hud-row" style="margin-top:6px;">
        <span class="hud-label">‡πÄ‡∏Å‡∏£‡∏î (REAL-TIME)</span>
        <span class="hud-grade-pill">
          <span id="hud-grade">C</span>
          <span style="font-size:11px;color:var(--text-soft);">C‚ÄìSSS</span>
        </span>
      </div>
    </div>

    <!-- Top-right: Quest -->
    <div class="hud-top-right hud-card">
      <p class="hud-title">QUEST</p>
      <p id="quest-main" class="quest-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
      <p id="quest-mini" class="quest-mini">Mini: ‚Äî</p>
      <div class="quest-progress" id="quest-progress-text">0 / 0</div>
      <div class="quest-progress" id="quest-mini-progress-text">Mini 0 / 0</div>
      <div class="quest-progress" id="quest-hint">‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î</div>
      <div class="quest-bar">
        <div id="quest-bar-main" class="quest-bar-inner"></div>
      </div>
      <div class="quest-bar" style="margin-top:3px;">
        <div id="quest-bar-mini" class="quest-bar-inner"></div>
      </div>
    </div>

    <!-- Bottom-left: Fever gauge -->
    <div class="hud-bottom-left">
      <div class="fever-root">
        <div style="font-size:18px;">üî•</div>
        <div>
          <div class="fever-label">Fever Gauge</div>
          <div class="fever-bar-wrap">
            <div id="fever-bar" class="fever-bar"></div>
          </div>
        </div>
        <div id="fever-percent" class="fever-percent">0%</div>
      </div>
    </div>

    <!-- Bottom-right: VR button -->
    <div class="hud-bottom-right">
      <button class="vr-btn" id="btn-enter-vr">
        <span>üï∂Ô∏è</span>
        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</span>
      </button>
    </div>

    <!-- Center crosshair -->
    <div class="crosshair"></div>

    <!-- Result modal -->
    <div class="result-wrap" id="result-wrap">
      <div class="result-card">
        <p class="result-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups</p>
        <div class="result-row">
          <span>‡πÇ‡∏´‡∏°‡∏î</span>
          <span id="res-mode">Easy</span>
        </div>
        <div class="result-row">
          <span>‡πÄ‡∏Å‡∏£‡∏î</span>
          <span id="res-grade">C</span>
        </div>
        <div class="result-row">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
          <span id="res-score">0</span>
        </div>
        <div class="result-row">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
          <span id="res-combo">0</span>
        </div>
        <div class="result-row">
          <span>‡∏û‡∏•‡∏≤‡∏î</span>
          <span id="res-miss">0</span>
        </div>
        <div class="result-row">
          <span>Goals</span>
          <span id="res-goals">0 / 0</span>
        </div>
        <div class="result-row">
          <span>Mini quests</span>
          <span id="res-minis">0 / 0</span>
        </div>

        <div class="result-actions">
          <button class="btn-ghost" id="btn-retry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button class="btn-primary" id="btn-back-hub">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== A-Frame Scene ======== -->
  <a-scene background="color: #020617" renderer="antialias: true">
    <a-assets>
      <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ skybox / floor texture ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    </a-assets>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô -->
    <a-entity geometry="primitive: plane; width: 16; height: 16"
              rotation="-90 0 0"
              position="0 0 -4"
              material="color: #020617; roughness: 1; metalness: 0">
    </a-entity>

    <!-- ‡πÅ‡∏™‡∏á -->
    <a-entity light="type: ambient; intensity: 0.45; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.8; color: #ffffff"
              position="0 4 -2"></a-entity>

    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á + cursor mouse -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="gj-camera"
                wasd-controls-enabled="false"
                look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  raycaster="objects: [data-hha-tgt]"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9">
        </a-entity>
      </a-camera>
    </a-entity>
  </a-scene>

  <!-- ======== Game scripts (non-module) ======== -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>
  <script src="./vr/hha-cloud-logger.js"></script>
  <script src="./vr/emoji-image.js"></script>

  <script src="./vr-groups/difficulty.foodgroups.js"></script>
  <script src="./vr-groups/quest-manager.js"></script>

  <!-- ======== Main module: start engine + HUD bindings ======== -->
  <script type="module">
    import { GameEngine } from './vr-groups/GameEngine.js';

    const ROOT = window;

    // ---------- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL ----------
    const url = new URL(window.location.href);
    let diff = (url.searchParams.get('diff') || 'easy').toLowerCase();
    if (!['easy','normal','hard'].includes(diff)) diff = 'easy';

    let timeParam = parseInt(url.searchParams.get('time'), 10);
    if (!Number.isFinite(timeParam) || timeParam <= 0) timeParam = 80;
    if (timeParam < 20) timeParam = 20;
    if (timeParam > 180) timeParam = 180;

    let remain = timeParam;

    const hudMode    = document.getElementById('hud-mode-text');
    const hudScore   = document.getElementById('hud-score');
    const hudCombo   = document.getElementById('hud-combo');
    const hudMiss    = document.getElementById('hud-miss');
    const hudGrade   = document.getElementById('hud-grade');

    const feverBar      = document.getElementById('fever-bar');
    const feverPercent  = document.getElementById('fever-percent');

    const questMain  = document.getElementById('quest-main');
    const questMini  = document.getElementById('quest-mini');
    const questProg  = document.getElementById('quest-progress-text');
    const questMiniProg = document.getElementById('quest-mini-progress-text');
    const questHint  = document.getElementById('quest-hint');
    const questBarMain = document.getElementById('quest-bar-main');
    const questBarMini = document.getElementById('quest-bar-mini');

    const resWrap   = document.getElementById('result-wrap');
    const resMode   = document.getElementById('res-mode');
    const resGrade  = document.getElementById('res-grade');
    const resScore  = document.getElementById('res-score');
    const resCombo  = document.getElementById('res-combo');
    const resMiss   = document.getElementById('res-miss');
    const resGoals  = document.getElementById('res-goals');
    const resMinis  = document.getElementById('res-minis');

    const btnEnterVR = document.getElementById('btn-enter-vr');
    const btnRetry   = document.getElementById('btn-retry');
    const btnBackHub = document.getElementById('btn-back-hub');

    function updateModeLabel () {
      hudMode.textContent = diff.toUpperCase() + ' ‚Ä¢ ' + remain + 's';
    }

    function setFeverHUD (percent) {
      const p = Math.max(0, Math.min(100, percent || 0));
      feverBar.style.width = p + '%';
      feverPercent.textContent = Math.round(p) + '%';
    }

    // ---------- HUD event bindings ----------
    window.addEventListener('hha:stat', (ev) => {
      const d = ev.detail || {};
      if (typeof d.score === 'number') {
        hudScore.textContent = d.score.toString();
      }
      if (typeof d.comboMax === 'number') {
        hudCombo.textContent = d.comboMax.toString();
      }
      if (typeof d.misses === 'number') {
        hudMiss.textContent = d.misses.toString();
      }
      if (typeof d.grade === 'string') {
        hudGrade.textContent = d.grade;
      }
      if (typeof d.fever === 'number') {
        setFeverHUD(d.fever);
      }
    });

    // Quest update ‡∏à‡∏≤‡∏Å quest-manager.js
    window.addEventListener('quest:update', (ev) => {
      const d = ev.detail || {};
      const goal = d.goal || null;
      const mini = d.mini || null;

      if (goal) {
        questMain.textContent = goal.label || '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å';
        const gp = goal.prog || 0;
        const gt = goal.target || 0;
        questProg.textContent = `${gp} / ${gt}`;
        const ratio = gt > 0 ? (gp / gt) * 100 : 0;
        questBarMain.style.width = Math.max(0, Math.min(100, ratio)) + '%';
      } else {
        questMain.textContent = '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
        questProg.textContent = '0 / 0';
        questBarMain.style.width = '0%';
      }

      if (mini) {
        questMini.textContent = 'Mini: ' + (mini.label || '');
        const mp = mini.prog || 0;
        const mt = mini.target || 0;
        questMiniProg.textContent = `Mini ${mp} / ${mt}`;
        const mratio = mt > 0 ? (mp / mt) * 100 : 0;
        questBarMini.style.width = Math.max(0, Math.min(100, mratio)) + '%';
      } else {
        questMini.textContent = 'Mini: ‚Äî';
        questMiniProg.textContent = 'Mini 0 / 0';
        questBarMini.style.width = '0%';
      }

      questHint.textContent = d.hint || '';
    });

    // ---------- END event ----------
    window.addEventListener('hha:end', (ev) => {
      const d = ev.detail || {};
      resMode.textContent  = d.difficulty ? d.difficulty.toUpperCase() : diff.toUpperCase();
      resGrade.textContent = d.grade || 'C';
      resScore.textContent = (d.score || 0).toString();
      resCombo.textContent = (d.comboMax || 0).toString();
      resMiss.textContent  = (d.misses || 0).toString();
      const gCleared = d.goalsCleared || d.goalCleared || 0;
      const gTotal   = d.goalsTotal || 0;
      const mCleared = d.questsCleared || 0;
      const mTotal   = d.questsTotal || 0;
      resGoals.textContent = `${gCleared} / ${gTotal}`;
      resMinis.textContent = `${mCleared} / ${mTotal}`;

      resWrap.classList.add('active');
    });

    // ---------- Countdown -> hha:time ----------
    let countdownTimer = null;
    function runCountdown () {
      const start = Date.now();
      function tick () {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const left = Math.max(0, timeParam - elapsed);
        if (left !== remain) {
          remain = left;
          updateModeLabel();
          window.dispatchEvent(new CustomEvent('hha:time', {
            detail: { sec: left }
          }));
        }
        if (left <= 0 && countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    // ---------- VR button ----------
    btnEnterVR?.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) {
        scene.enterVR();
      }
    });

    btnRetry?.addEventListener('click', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('run', 'play');
      window.location.href = url.toString();
    });

    btnBackHub?.addEventListener('click', () => {
      window.location.href = './hub.html';
    });

    // ---------- Boot engine ----------
    window.addEventListener('load', () => {
      updateModeLabel();
      setFeverHUD(0);

      const engine = new GameEngine({
        difficulty: diff,
        duration: timeParam
      });
      engine.start();

      runCountdown();
    });
  </script>
</body>
</html>