<!-- === /herohealth/groups-vr.html ===
Food Groups VR (PRODUCTION) ‚Äî FIX-ALL HTML
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö IIFE: /vr/particles.js, /vr/ui-fever.js, /vr/hha-hud.js
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö IIFE: /vr-groups/groups-quests.js, /vr-groups/GameEngine.js (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏õ‡∏∞‡∏°‡∏≤)
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö URL params: ?diff=easy|normal|hard &time=90 &run=play|research (‡∏´‡∏£‡∏∑‡∏≠ mode=...) &seed=...
‚úÖ HUD ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (quest:update) + Fever (hha:fever) + Score/Time/Rank (hha:score/hha:time/hha:rank)
‚úÖ ‡πÄ‡∏õ‡πâ‡∏≤ emoji ‚Äú‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á‚Äù (textContent + font emoji) + CSS vars --x/--y/--s ‡∏ï‡∏≤‡∏° engine
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á/VR toggle) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --txt:rgba(226,232,240,.95);
      --muted:rgba(226,232,240,.70);
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#fbbf24;

      --hudTop:120px;   /* ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á safeTopPx ‡πÉ‡∏ô engine */
      --hudBottom:150px;/* safeBottomPx */
    }
    html,body{height:100%; background:var(--bg); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans Thai,sans-serif;}
    *{box-sizing:border-box}
    .stage{position:fixed; inset:0; overflow:hidden; background:radial-gradient(1200px 800px at 50% 35%, rgba(56,189,248,.08), transparent 60%),
                                          radial-gradient(900px 700px at 20% 80%, rgba(34,197,94,.07), transparent 60%),
                                          radial-gradient(900px 700px at 90% 85%, rgba(244,63,94,.06), transparent 60%);}

    /* ===== A-Frame scene behind DOM ===== */
    a-scene{position:fixed; inset:0; z-index:0;}
    /* ===== DOM gameplay layer ===== */
    #fg-layer{
      position:fixed; inset:0;
      z-index:10;
      pointer-events:auto;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
    }

    /* ===== HUD ===== */
    #hud{
      position:fixed; inset:0;
      z-index:30;
      pointer-events:none;
      padding: calc(env(safe-area-inset-top) + 10px) 12px calc(env(safe-area-inset-bottom) + 12px);
      color:var(--txt);
    }
    .hud-top{
      display:flex; gap:10px;
      align-items:stretch;
      justify-content:space-between;
      pointer-events:none;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius:18px;
      padding:10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      min-width: 0;
    }
    .statRow{display:flex; gap:10px; flex-wrap:wrap}
    .stat{
      min-width:72px;
    }
    .k{font-size:12px; letter-spacing:.08em; opacity:.72}
    .v{font-size:22px; font-weight:800; line-height:1.05; margin-top:2px}
    .v.small{font-size:18px}
    .mono{font-variant-numeric:tabular-nums}

    .questCard{
      width:min(52vw, 520px);
      max-width:520px;
    }
    .questHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .questTitle{
      font-weight:900;
      letter-spacing:.02em;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .questPct{font-size:12px; opacity:.75; white-space:nowrap}
    .bar{
      height:10px; border-radius:999px;
      background:rgba(148,163,184,.16);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.14);
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.9), rgba(56,189,248,.9));
      border-radius:999px;
      transition: width .18s ease;
    }
    .qline{margin-top:8px; font-size:14px; color:var(--muted)}
    .qline b{color:var(--txt)}
    .warn{color:rgba(251,191,36,.95)}

    /* ===== Coach tip ===== */
    #coach{
      position:fixed;
      left:12px;
      right:12px;
      top: calc(env(safe-area-inset-top) + 92px);
      z-index:28;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    #coach .bubble{
      max-width:min(720px, 92vw);
      background:rgba(2,6,23,.62);
      border:1px solid rgba(148,163,184,.16);
      backdrop-filter: blur(10px);
      border-radius:20px;
      padding:10px 14px;
      color:rgba(226,232,240,.92);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      font-size:14px;
      line-height:1.25;
    }

    /* ===== Bottom controls ===== */
    #controls{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(env(safe-area-inset-bottom) + 10px);
      z-index:40;
      display:flex;
      gap:10px;
      justify-content:center;
      pointer-events:auto;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.62);
      color:var(--txt);
      padding:10px 14px;
      border-radius:16px;
      font-weight:800;
      letter-spacing:.02em;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      user-select:none;
    }
    .btn.primary{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.28)}
    .btn.danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.22)}
    .btn.ghost{background:rgba(148,163,184,.08)}

    /* ===== Targets ===== */
    .fg-target{
      position:absolute;
      left:var(--x, 50%);
      top:var(--y, 52%);
      transform: translate(-50%,-50%) scale(var(--s,1));
      width:132px; height:132px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-size:64px;
      line-height:1;
      cursor:pointer;
      user-select:none;

      /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: emoji font */
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", system-ui, sans-serif;

      background:
        radial-gradient(90px 90px at 28% 22%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(110px 110px at 70% 78%, rgba(0,0,0,.18), transparent 58%),
        rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.22);
      box-shadow:
        0 18px 45px rgba(0,0,0,.42),
        inset 0 0 0 2px rgba(255,255,255,.06);
      backdrop-filter: blur(10px);

      transition: transform .10s ease, filter .10s ease;
      will-change: transform, left, top;
    }
    .fg-target.fg-good{
      border-color: rgba(34,197,94,.28);
      box-shadow:
        0 18px 45px rgba(0,0,0,.42),
        0 0 0 6px rgba(34,197,94,.08),
        inset 0 0 0 2px rgba(255,255,255,.06);
    }
    .fg-target.fg-junk{
      border-color: rgba(239,68,68,.28);
      box-shadow:
        0 18px 45px rgba(0,0,0,.42),
        0 0 0 6px rgba(239,68,68,.07),
        inset 0 0 0 2px rgba(255,255,255,.06);
      filter:saturate(1.05);
    }
    .fg-target.fg-boss{
      box-shadow:
        0 22px 60px rgba(0,0,0,.5),
        0 0 0 7px rgba(251,191,36,.10),
        inset 0 0 0 2px rgba(255,255,255,.06);
      border-color: rgba(251,191,36,.35);
    }
    .fg-target.fg-decoy{
      box-shadow:
        0 18px 45px rgba(0,0,0,.42),
        0 0 0 6px rgba(59,130,246,.08),
        inset 0 0 0 2px rgba(255,255,255,.06);
      border-color: rgba(59,130,246,.28);
      filter: hue-rotate(12deg);
    }
    .fg-target.spawn{transform:translate(-50%,-50%) scale(.85); opacity:.0}
    .fg-target.show{opacity:1; transform:translate(-50%,-50%) scale(var(--s,1))}
    .fg-target.lock{filter:brightness(1.06) saturate(1.06)}
    .fg-target.hit{opacity:.0; transform:translate(-50%,-50%) scale(.65); filter: blur(1px)}
    .fg-target.out{opacity:.0; transform:translate(-50%,-50%) scale(.78)}

    /* boss bar */
    .bossbar{
      position:absolute;
      left:14%;
      right:14%;
      bottom:10%;
      height:10px;
      border-radius:999px;
      background:rgba(15,23,42,.65);
      border:1px solid rgba(148,163,184,.22);
      overflow:hidden;
      box-shadow: 0 8px 16px rgba(0,0,0,.25);
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg, rgba(251,191,36,.95), rgba(239,68,68,.9));
      border-radius:999px;
      transition: width .10s ease;
    }

    /* afterimage */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      transform: translate3d(0,0,0);
      pointer-events:none;
      z-index:9;
      opacity:.0;
      animation: ai .42s ease forwards;
    }
    .fg-afterimage-inner{
      transform: translate(-50%,-50%) scale(1.0);
      font-size:58px;
      filter: blur(.2px);
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", system-ui, sans-serif;
      text-shadow: 0 14px 35px rgba(0,0,0,.5);
    }
    .fg-afterimage.a1{opacity:.7}
    .fg-afterimage.a2{opacity:.45}
    @keyframes ai{
      0%{opacity:.0}
      15%{opacity:.65}
      100%{opacity:0; transform: translate3d(0,0,0) translateY(10px) scale(.98)}
    }

    /* lock ring UI */
    #lockUI{
      position:fixed; inset:0;
      z-index:25;
      pointer-events:none;
    }
    #lockRing{
      position:absolute;
      left:50%; top:52%;
      transform: translate(-50%,-50%);
      width:120px; height:120px;
      border-radius:999px;
      opacity:0;
      transition: opacity .08s ease;
      filter: drop-shadow(0 18px 36px rgba(0,0,0,.45));
    }
    #lockRing.on{opacity:1}
    #lockRing svg{width:100%; height:100%}
    #lockLabel{
      position:absolute;
      left:50%; top:calc(52% + 78px);
      transform:translate(-50%,-50%);
      font-weight:900;
      font-size:12px;
      letter-spacing:.12em;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(2,6,23,.52);
      border:1px solid rgba(148,163,184,.18);
      opacity:0;
      transition:opacity .08s ease;
      color:rgba(226,232,240,.9);
    }
    #lockLabel.on{opacity:1}

    /* Start overlay */
    #startOverlay{
      position:fixed; inset:0;
      z-index:60;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 12px calc(env(safe-area-inset-bottom) + 18px);
      background: radial-gradient(900px 700px at 50% 40%, rgba(30,41,59,.40), rgba(2,6,23,.88));
      backdrop-filter: blur(10px);
    }
    #startCard{
      width:min(720px, 94vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.72);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px 14px 12px;
      color:var(--txt);
    }
    #startCard h1{margin:0 0 6px; font-size:18px}
    #startCard p{margin:0 0 10px; color:rgba(226,232,240,.75); font-size:13px; line-height:1.25}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .field{
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.16);
      border-radius:16px;
      padding:10px 10px;
    }
    .field label{display:block; font-size:12px; opacity:.75; margin-bottom:6px}
    select,input{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:rgba(226,232,240,.92);
      padding:10px 10px;
      font-weight:800;
      outline:none;
    }
    .row{
      display:flex; gap:10px; margin-top:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .smallNote{margin-top:10px; font-size:12px; color:rgba(226,232,240,.72)}
    .smallNote b{color:rgba(251,191,36,.95)}
  </style>

  <!-- ===== Shared IIFE modules (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô engine) ===== -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- ===== Groups scripts (IIFE) ===== -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
</head>

<body>
  <div class="stage"></div>

  <!-- A-Frame background (optional ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢ VR toggle/gyro) -->
  <a-scene embedded xr-mode-ui="enabled: true">
    <a-sky color="#020617"></a-sky>
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" look-controls="magicWindowTrackingEnabled: true; touchEnabled: true" wasd-controls-enabled="false"></a-camera>
    </a-entity>
  </a-scene>

  <!-- DOM targets -->
  <div id="fg-layer" aria-label="Food Groups Targets Layer"></div>

  <!-- Lock UI -->
  <div id="lockUI">
    <div id="lockRing">
      <svg viewBox="0 0 100 100">
        <defs>
          <linearGradient id="lg" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="rgba(34,197,94,.95)"></stop>
            <stop offset="1" stop-color="rgba(56,189,248,.95)"></stop>
          </linearGradient>
        </defs>
        <circle cx="50" cy="50" r="44" fill="rgba(2,6,23,.25)" stroke="rgba(148,163,184,.18)" stroke-width="6"></circle>
        <circle id="lockProg" cx="50" cy="50" r="44"
                fill="transparent" stroke="url(#lg)" stroke-width="7"
                stroke-linecap="round"
                stroke-dasharray="276.46" stroke-dashoffset="276.46"
                transform="rotate(-90 50 50)"></circle>
        <circle id="chargeProg" cx="50" cy="50" r="36"
                fill="transparent" stroke="rgba(251,191,36,.92)" stroke-width="6"
                stroke-linecap="round"
                stroke-dasharray="226.19" stroke-dashoffset="226.19"
                transform="rotate(-90 50 50)"></circle>
      </svg>
    </div>
    <div id="lockLabel">LOCK</div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-top">
      <div class="card" style="flex:1; min-width: 220px;">
        <div class="statRow">
          <div class="stat">
            <div class="k">SCORE</div>
            <div id="hudScore" class="v mono">0</div>
          </div>
          <div class="stat">
            <div class="k">COMBO</div>
            <div id="hudCombo" class="v mono">0</div>
          </div>
          <div class="stat">
            <div class="k">MISS</div>
            <div id="hudMiss" class="v mono">0</div>
          </div>
          <div class="stat">
            <div class="k">TIME</div>
            <div id="hudTime" class="v mono">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">SHIELD</div>
            <div id="hudShield" class="v mono">0</div>
          </div>
          <div class="stat">
            <div class="k">GRADE</div>
            <div id="hudGrade" class="v mono">C</div>
          </div>
        </div>
      </div>

      <div class="card questCard">
        <div class="questHead">
          <div class="questTitle">üß© <span>GOAL / MINI</span></div>
          <div id="questPct" class="questPct mono">0%</div>
        </div>
        <div class="bar"><i id="questBar"></i></div>
        <div class="qline"><b>GOAL:</b> <span id="questGoal">‚Äî</span></div>
        <div class="qline"><b>MINI:</b> <span id="questMini">‚Äî</span></div>
        <div class="qline"><b>GROUP:</b> <span id="questGroup">‚Äî</span> <span id="questWarn" class="warn" style="display:none">‚ö†Ô∏è QUEST NOT READY</span></div>
      </div>
    </div>

    <div id="coach">
      <div class="bubble">
        <span id="coachText">‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ ‚ú®</span><br/>
        <span style="opacity:.72">Tip: Tap-anywhere ‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÉ‡∏´‡πâ</span><br/>
        <span style="opacity:.72">LOCK ‡∏à‡πâ‡∏≠‡∏á‡∏à‡∏ô‡∏ß‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏ï‡πá‡∏° ‚Üí ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î</span><br/>
        <span style="opacity:.72">CHARGE ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏¢‡∏¥‡∏á‡πÅ‡∏£‡∏á + ‡∏•‡∏≤‡∏° (Chain)</span>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="btnGaze" class="btn primary" type="button">Gaze: ON</button>
    <button id="btnStop" class="btn danger" type="button">STOP</button>
    <button id="btnVR" class="btn ghost" type="button">VR</button>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay">
    <div id="startCard">
      <h1>Food Groups VR ‚Äî Ready</h1>
      <p>Play = ‡πÇ‡∏´‡∏î/‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ ‚Ä¢ Research = FIX (seeded) ‡∏Ñ‡∏∏‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏õ‡πä‡∏∞<br/>
      <span style="opacity:.8">* ‡∏ñ‡πâ‡∏≤ Quest ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå ‚Äú‚ö†Ô∏è QUEST NOT READY‚Äù</span></p>

      <div class="grid">
        <div class="field">
          <label>Difficulty</label>
          <select id="selDiff">
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
          </select>
        </div>
        <div class="field">
          <label>Mode</label>
          <select id="selMode">
            <option value="play" selected>play</option>
            <option value="research">research</option>
          </select>
        </div>
        <div class="field">
          <label>Time (sec)</label>
          <input id="inpTime" type="number" min="10" max="999" value="90" />
        </div>
        <div class="field">
          <label>Seed (research optional)</label>
          <input id="inpSeed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô class5-A|round1" />
        </div>
      </div>

      <div class="row">
        <button id="btnStart" class="btn primary" type="button">START</button>
      </div>

      <div class="smallNote">
        ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <b>?diff=easy&time=90&run=play</b> ‡∏à‡∏∞ auto-start ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const $ = (q)=>document.querySelector(q);

      const fgLayer = $('#fg-layer');
      const camEl = document.getElementById('cam');

      const hudScore = $('#hudScore');
      const hudCombo = $('#hudCombo');
      const hudMiss  = $('#hudMiss');
      const hudTime  = $('#hudTime');
      const hudShield= $('#hudShield');
      const hudGrade = $('#hudGrade');

      const questGoal = $('#questGoal');
      const questMini = $('#questMini');
      const questGroup= $('#questGroup');
      const questPct  = $('#questPct');
      const questBar  = $('#questBar');
      const questWarn = $('#questWarn');

      const coachText = $('#coachText');

      const lockRing = $('#lockRing');
      const lockLabel= $('#lockLabel');
      const lockProg = document.getElementById('lockProg');
      const chargeProg = document.getElementById('chargeProg');

      const btnGaze = $('#btnGaze');
      const btnStop = $('#btnStop');
      const btnVR   = $('#btnVR');

      const startOverlay = $('#startOverlay');
      const selDiff = $('#selDiff');
      const selMode = $('#selMode');
      const inpTime = $('#inpTime');
      const inpSeed = $('#inpSeed');
      const btnStart= $('#btnStart');

      // ---- URL params ----
      const sp = new URLSearchParams(location.search);
      const qDiff = (sp.get('diff') || 'normal').toLowerCase();
      const qTime = parseInt(sp.get('time') || '90', 10);
      // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö run=play (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) + mode=play (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
      const qRun  = (sp.get('run')  || '').toLowerCase();
      const qMode = (sp.get('mode') || '').toLowerCase();
      const autoMode = (qRun || qMode || '').toLowerCase(); // play|research
      const qSeed = sp.get('seed') || '';

      if (['easy','normal','hard'].includes(qDiff)) selDiff.value = qDiff;
      if (!Number.isNaN(qTime) && qTime > 0) inpTime.value = String(qTime);
      if (qSeed) inpSeed.value = qSeed;
      if (autoMode === 'research') selMode.value = 'research';
      if (autoMode === 'play') selMode.value = 'play';

      // ---- engine bootstrap ----
      function engine(){
        return (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
      }

      function setGazeUI(on){
        btnGaze.textContent = on ? 'Gaze: ON' : 'Gaze: OFF';
        btnGaze.classList.toggle('primary', !!on);
        try { engine() && engine().setGaze(on); } catch {}
      }

      let gazeOn = true;

      // ---- Events: HUD ----
      window.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) || {};
        if (hudScore) hudScore.textContent = String(d.score ?? 0);
        if (hudCombo) hudCombo.textContent = String(d.combo ?? 0);
        if (hudMiss)  hudMiss.textContent  = String(d.misses ?? 0);
        if (hudShield)hudShield.textContent= String(d.shield ?? 0);
      });

      window.addEventListener('hha:time', (ev)=>{
        const d = (ev && ev.detail) || {};
        const left = (d.left ?? '‚Äî');
        if (hudTime) hudTime.textContent = String(left);
      });

      window.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) || {};
        if (hudGrade) hudGrade.textContent = String(d.grade || 'C');
      });

      window.addEventListener('hha:coach', (ev)=>{
        const d = (ev && ev.detail) || {};
        const t = String(d.text || '').trim();
        if (t && coachText) coachText.textContent = t;
      });

      // ---- Events: Quest ----
      function fmtLine(obj){
        if (!obj) return '‚Äî';
        const label = obj.label || '‚Äî';
        const prog = (obj.prog ?? 0);
        const target = (obj.target ?? 0);
        if (target > 0) return `${label} (${prog}/${target})`;
        return `${label}`;
      }
      window.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) || {};
        const ok = !!d.questOk;

        if (questWarn) questWarn.style.display = ok ? 'none' : 'inline';

        // goal/mini
        if (questGoal) questGoal.textContent = ok ? fmtLine(d.goal) : '‚Äî';
        if (questMini){
          let t = ok ? fmtLine(d.mini) : '‚Äî';
          // rush window timer
          if (ok && d.mini && typeof d.mini.tLeft === 'number' && d.mini.windowSec){
            t += ` ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Math.max(0, d.mini.tLeft|0)} ‡∏ß‡∏¥`;
          }
          questMini.textContent = t;
        }
        if (questGroup) questGroup.textContent = ok ? String(d.groupLabel || '‚Äî') : '‚Äî';

        // pct
        const goalsAll = Array.isArray(d.goalsAll) ? d.goalsAll : [];
        const minisAll = Array.isArray(d.minisAll) ? d.minisAll : [];
        const doneG = goalsAll.filter(x=>x && x.done).length;
        const doneM = minisAll.filter(x=>x && x.done).length;
        const tot = (goalsAll.length||0) + (minisAll.length||0);
        const pct = tot > 0 ? Math.round(((doneG+doneM)/tot)*100) : 0;
        if (questPct) questPct.textContent = pct + '%';
        if (questBar) questBar.style.width = pct + '%';
      });

      // ---- Events: Lock UI ----
      function setCircle(circleEl, radius, pct){
        // dasharray values already set in SVG, just change offset
        const c = 2 * Math.PI * radius;
        const p = Math.max(0, Math.min(1, pct||0));
        const off = c * (1 - p);
        circleEl.style.strokeDasharray = String(c);
        circleEl.style.strokeDashoffset = String(off);
      }
      window.addEventListener('groups:lock', (ev)=>{
        const d = (ev && ev.detail) || {};
        const on = !!d.on;
        const x = (typeof d.x === 'number') ? d.x : (window.innerWidth/2);
        const y = (typeof d.y === 'number') ? d.y : (window.innerHeight/2);
        const prog = (typeof d.prog === 'number') ? d.prog : 0;
        const charge = (typeof d.charge === 'number') ? d.charge : 0;

        lockRing.classList.toggle('on', on);
        lockLabel.classList.toggle('on', on);

        lockRing.style.left = x + 'px';
        lockRing.style.top  = y + 'px';
        lockLabel.style.left= x + 'px';
        lockLabel.style.top = (y + 78) + 'px';

        setCircle(lockProg, 44, prog);
        setCircle(chargeProg, 36, charge);

        lockLabel.textContent = (charge > 0.15) ? 'CHARGE' : 'LOCK';
      });

      // ---- Buttons ----
      btnGaze.addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        setGazeUI(gazeOn);
      });

      btnStop.addEventListener('click', ()=>{
        try { engine() && engine().stop('stop_btn'); } catch {}
        startOverlay.style.display = 'flex';
      });

      btnVR.addEventListener('click', ()=>{
        try{
          const scene = document.querySelector('a-scene');
          if (scene && scene.enterVR) scene.enterVR();
        }catch{}
      });

      function startGame(){
        const eng = engine();
        if (!eng){
          alert('GameEngine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ path ./vr-groups/GameEngine.js)');
          return;
        }

        // bind layer + camera
        try{ eng.setLayerEl(fgLayer); }catch{}
        try{ eng.setCameraEl(camEl); }catch{}

        const diff = (selDiff.value || 'normal').toLowerCase();
        const mode = (selMode.value || 'play').toLowerCase();
        const timeLeft = Math.max(10, parseInt(inpTime.value || '90', 10) || 90);

        startOverlay.style.display = 'none';

        try{ eng.setTimeLeft(timeLeft); }catch{}
        try{ eng.setGaze(gazeOn); }catch{}

        // start
        const seed = String(inpSeed.value || '').trim();
        try{
          eng.start(diff, {
            runMode: mode,
            seed: seed || undefined,
            layerEl: fgLayer
          });
        }catch(e){
          console.error(e);
          alert('Start error ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î console ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
          startOverlay.style.display = 'flex';
        }
      }

      btnStart.addEventListener('click', startGame);

      // ---- default gaze ----
      setGazeUI(true);

      // ---- Auto-start when URL has run/mode ----
      if (autoMode === 'play' || autoMode === 'research'){
        // ‡∏ã‡πà‡∏≠‡∏ô overlay ‡πÅ‡∏•‡πâ‡∏ß start ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        setTimeout(()=>startGame(), 50);
      }
    })();
  </script>
</body>
</html>