<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-hud-quest.js" defer></script>

  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
</head>

<body>
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true; alpha: true">
    <a-entity id="camera" camera look-controls="enabled: true" position="0 1.6 0"></a-entity>
  </a-scene>

  <div id="fg-root" class="fg-root">
    <div id="fg-layer" class="fg-layer" aria-label="playfield"></div>

    <!-- Reticle -->
    <div class="fg-reticle" id="fg-reticle" aria-hidden="true"></div>

    <!-- ‚úÖ Lock/Charge Ring (NEW) -->
    <div class="lock-ring" id="lockRing" aria-hidden="true">
      <svg viewBox="0 0 120 120" class="ring">
        <!-- outer track -->
        <circle class="track" cx="60" cy="60" r="44"></circle>
        <!-- outer progress -->
        <circle class="prog"  cx="60" cy="60" r="44"></circle>

        <!-- inner track (charge) -->
        <circle class="track2" cx="60" cy="60" r="33"></circle>
        <!-- inner progress (charge) -->
        <circle class="prog2"  cx="60" cy="60" r="33"></circle>
      </svg>
      <div class="lock-label" id="lockLabel">LOCK</div>
    </div>

    <!-- Top-left stats -->
    <div class="hud hud-left">
      <div class="hud-chip"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="hudScore">0</div></div>
      <div class="hud-chip"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div><div class="v" id="hudCombo">0</div></div>
      <div class="hud-chip"><div class="k">Miss</div><div class="v" id="hudMiss">0</div></div>
      <div class="hud-chip"><div class="k">‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="hudTime">0</div></div>
    </div>

    <!-- Top-right -->
    <div class="hud hud-right">
      <div class="hud-card">
        <div class="k">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        <div class="v" id="hudGroup">‚Äî</div>
      </div>

      <div class="hud-card">
        <div class="k">‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="v grade" id="hudGrade">C</div>
      </div>

      <div class="fever-wrap">
        <div id="feverBarHost"></div>
      </div>
    </div>

    <!-- Bottom-left Quest panel -->
    <div class="quest-panel">
      <div class="quest-title">
        <div class="q-head">GOAL</div>
        <div class="q-meta" id="qGoalMeta">0/0</div>
      </div>
      <div class="q-row">
        <div class="q-label" id="qGoalLabel">‚Äî</div>
        <div class="q-right" id="qGoalProg">0%</div>
      </div>
      <div class="q-bar"><div class="q-bar-fill" id="qGoalBar"></div></div>

      <div class="quest-title mt">
        <div class="q-head">üß© MINI</div>
        <div class="q-meta" id="qMiniMeta">0/0</div>
      </div>
      <div class="q-row">
        <div class="q-label" id="qMiniLabel">‚Äî</div>
        <div class="q-right" id="qMiniProg">0%</div>
      </div>
      <div class="q-bar"><div class="q-bar-fill" id="qMiniBar"></div></div>

      <div class="q-warn" id="qWarn" style="display:none;">‚ö†Ô∏è QUEST ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ groups-quests.js / hha-hud-quest.js)</div>
    </div>

    <!-- Coach -->
    <div class="coach" id="hudCoach">
      <div class="coach-title">Coach</div>
      <div class="coach-text" id="hudCoachText">‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ ‚ú®</div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn ghost" id="btnGaze">Gaze: ON</button>
      <button class="btn danger" id="btnStop">STOP</button>
      <button class="btn" id="btnVR">VR</button>
    </div>

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay">
      <div class="overlay-card">
        <div class="overlay-title">Food Groups VR</div>
        <div class="overlay-sub" id="startSub">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>

        <div class="overlay-grid">
          <div class="row">
            <span class="pill" id="pillMode">MODE: PLAY</span>
            <span class="pill" id="pillDiff">DIFF: EASY</span>
            <span class="pill" id="pillTime">TIME: 90s</span>
          </div>

          <div class="row btnrow">
            <button class="btn big" id="btnStartPlay">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô (Play)</button>
            <button class="btn big ghost" id="btnStartResearch">üß™ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (Research)</button>
          </div>

          <div class="overlay-note">
            Tip: ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ô‡∏¥‡πâ‡∏ß ‚Ä¢ ‡∏à‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ Lock ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î + Charge + Chain
          </div>
        </div>
      </div>
    </div>

    <!-- End overlay -->
    <div class="overlay" id="endOverlay" style="display:none;">
      <div class="overlay-card end">
        <div class="overlay-title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
        <div class="overlay-sub" id="endReason">‚Äî</div>

        <div class="end-grid">
          <div class="end-card"><div class="k">Score</div><div class="v" id="endScore">0</div></div>
          <div class="end-card"><div class="k">Combo Best</div><div class="v" id="endCombo">0</div></div>
          <div class="end-card"><div class="k">Miss</div><div class="v" id="endMiss">0</div></div>
          <div class="end-card"><div class="k">Quests</div><div class="v" id="endQuest">0%</div></div>
          <div class="end-card"><div class="k">Accuracy</div><div class="v" id="endAcc">0%</div></div>
          <div class="end-card"><div class="k">Grade</div><div class="v grade" id="endGrade">C</div></div>
        </div>

        <div class="row btnrow">
          <button class="btn big ghost" id="btnCloseEnd">‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ</button>
          <button class="btn big" id="btnReplay">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const $ = (id)=>document.getElementById(id);
    const sp = new URLSearchParams(location.search);

    const diff = (sp.get('diff')||'easy').toLowerCase();
    const timeSec = Math.max(10, parseInt(sp.get('time')||'90',10)||90);
    const run = (sp.get('run')||'play').toLowerCase();

    $('pillMode').textContent = 'MODE: ' + (run==='research'?'RESEARCH':'PLAY');
    $('pillDiff').textContent = 'DIFF: ' + diff.toUpperCase();
    $('pillTime').textContent = 'TIME: ' + timeSec + 's';

    const engine = (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
    if (engine){
      engine.setLayerEl($('fg-layer'));
      engine.setCameraEl($('camera'));
      engine.setTimeLeft(timeSec);
    }

    // ------- basic HUD -------
    window.addEventListener('hha:score', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('hudScore').textContent = (d.score|0);
      $('hudCombo').textContent = (d.combo|0);
      $('hudMiss').textContent  = (d.misses|0);
    });

    window.addEventListener('hha:time', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('hudTime').textContent = (d.left|0);
    });

    window.addEventListener('hha:coach', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if (d.text) $('hudCoachText').textContent = String(d.text);
    });

    window.addEventListener('hha:rank', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('hudGrade').textContent = String(d.grade||'C');
    });

    window.addEventListener('quest:update', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('hudGroup').textContent = d.groupLabel ? String(d.groupLabel) : '‚Äî';
    });

    // ------- reticle feedback -------
    const ret = $('fg-reticle');
    function pulse(cls){
      ret.classList.remove('ok','miss','perfect');
      ret.classList.add(cls);
      setTimeout(()=>{ try{ ret.classList.remove(cls); }catch{} }, 140);
    }
    window.addEventListener('groups:reticle', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if (d.state==='miss') pulse('miss');
      else if (d.state==='perfect') pulse('perfect');
      else pulse('ok');
    });

    // ------- Controls -------
    let gazeOn = true;
    $('btnGaze').addEventListener('click', ()=>{
      gazeOn = !gazeOn;
      $('btnGaze').textContent = 'Gaze: ' + (gazeOn?'ON':'OFF');
      try{ engine && engine.setGaze(gazeOn); }catch{}
    });
    $('btnStop').addEventListener('click', ()=>{ try{ engine && engine.stop('stop'); }catch{} });
    $('btnVR').addEventListener('click', ()=>{
      try{
        const scene = document.querySelector('a-scene');
        if (scene && scene.enterVR) scene.enterVR();
      }catch{}
    });

    function startGame(mode){
      if (!engine) return;
      $('startOverlay').style.display = 'none';
      $('endOverlay').style.display = 'none';

      const seed = sp.get('seed') || ('school|' + diff + '|' + timeSec);
      engine.setTimeLeft(timeSec);
      engine.start(diff, { runMode: mode, seed });
    }

    $('btnStartPlay').addEventListener('click', ()=>startGame('play'));
    $('btnStartResearch').addEventListener('click', ()=>startGame('research'));

    if ((sp.get('autostart')||'0')==='1'){
      startGame(run==='research'?'research':'play');
    }

    // ------- End overlay -------
    function pct(n){ n=Number(n)||0; return Math.max(0,Math.min(100,Math.round(n)))+'%'; }
    window.addEventListener('hha:end', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      $('endOverlay').style.display = '';
      $('endReason').textContent = (d.reason==='time_up') ? '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°';

      $('endScore').textContent = (d.scoreFinal|0);
      $('endCombo').textContent = (d.comboMax|0);
      $('endMiss').textContent  = (d.misses|0);
      $('endGrade').textContent = String(d.grade||'C');

      $('endQuest').textContent = (typeof d.questsPct === 'number') ? pct(d.questsPct*100) : '‚Äî';
      $('endAcc').textContent   = (typeof d.accuracy === 'number') ? pct(d.accuracy*100) : '‚Äî';
    });
    $('btnCloseEnd').addEventListener('click', ()=>{ $('endOverlay').style.display='none'; });
    $('btnReplay').addEventListener('click', ()=>{
      $('endOverlay').style.display='none';
      $('startOverlay').style.display='';
    });

    // ==========================================================
    // ‚úÖ 1) Rush mini panic: tick + flash + slight shake
    // ==========================================================
    let audioCtx = null;
    function tickBeep(){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const ctx = audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = 980;
        g.gain.value = 0.03;
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + 0.05);
      }catch{}
      try{ navigator.vibrate && navigator.vibrate(12); }catch{}
    }

    const root = $('fg-root');
    let lastPanicSec = -1;

    window.addEventListener('quest:panic', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      const sec = (d.secLeft|0);

      if (sec <= 0){
        root.classList.remove('panic');
        lastPanicSec = -1;
        return;
      }

      root.classList.add('panic');

      // beep only when sec changes (no spam)
      if (sec !== lastPanicSec){
        tickBeep();
        lastPanicSec = sec;
      }
    });

    // ==========================================================
    // ‚úÖ 2) Lock/Charge ring UI (listen groups:lock)
    // ==========================================================
    const ring = $('lockRing');
    const label = $('lockLabel');

    const outer = ring.querySelector('.prog');
    const inner = ring.querySelector('.prog2');

    function setCircle(circle, p){
      p = Math.max(0, Math.min(1, Number(p)||0));
      const r = Number(circle.getAttribute('r')) || 44;
      const C = 2 * Math.PI * r;
      circle.style.strokeDasharray = String(C);
      circle.style.strokeDashoffset = String(C * (1 - p));
    }

    // init
    setCircle(outer, 0);
    setCircle(inner, 0);
    ring.classList.remove('on');

    window.addEventListener('groups:lock', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if (!d.on){
        ring.classList.remove('on');
        setCircle(outer, 0);
        setCircle(inner, 0);
        label.textContent = 'LOCK';
        return;
      }

      ring.classList.add('on');
      setCircle(outer, d.prog || 0);
      setCircle(inner, d.charge || 0);

      if ((d.charge||0) > 0) label.textContent = 'CHARGE';
      else if ((d.prog||0) > 0.92) label.textContent = 'FIRE';
      else label.textContent = (d.boss ? 'BOSS' : 'LOCK');
    });

  })();
  </script>
</body>
</html>
