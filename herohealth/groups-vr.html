<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (FIX-ALL)
‚úÖ UI always shows (via vr-groups/groups-ui.js)
‚úÖ Quest updates show (quest:update) if groups-quests.js loaded OK
‚úÖ Fever UI compatibility (hha:fever) supported by your GameEngine
‚úÖ Correct script order + robust boot (query params diff/time/run/seed)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- (optional) FX + logger if you use them elsewhere -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- CSS (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ) -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <!-- ‚úÖ UI Binder must load BEFORE engine starts -->
  <script src="./vr-groups/groups-ui.js" defer></script>

  <!-- ‚úÖ Quest manager must load BEFORE GameEngine.js -->
  <script src="./vr-groups/groups-quests.js" defer></script>

  <!-- ‚úÖ Game engine (your big FIX-ALL) -->
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ css ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤ ‚Äî ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô layer ‡πÅ‡∏ô‡πà */
    html, body { margin:0; height:100%; background:#020617; overflow:hidden; touch-action:manipulation; }
    .stage { position:fixed; inset:0; }
    #fg-layer{
      position:fixed; inset:0;
      pointer-events:auto;
      user-select:none; -webkit-user-select:none;
      transform: translateZ(0);
    }

    /* start overlay (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÅ‡∏ï‡πà‡∏ä‡∏±‡∏î) */
    .start{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 45%, rgba(15,23,42,.70), rgba(2,6,23,.92));
      z-index: 30;
    }
    .start.hidden{ display:none; }
    .startCard{
      width:min(560px, 92vw);
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.78);
      border-radius:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:16px 16px 14px;
      color:#e5e7eb;
    }
    .startCard h1{ margin:0 0 6px; font-size:20px; }
    .startCard .muted{ color:#94a3b8; font-size:13px; line-height:1.35; }
    .startGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .chip{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.55);
      border-radius:14px;
      padding:10px 10px;
      font-size:13px;
      color:#e5e7eb;
    }
    .chip b{ color:#fff; }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      color:#0b1120;
    }
    .btn.primary{ background:#22c55e; }
    .btn.ghost{
      background: rgba(148,163,184,.12);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.22);
    }
    .smallNote{ margin-top:10px; font-size:12px; color:#94a3b8; }
  </style>
</head>

<body>
  <div class="stage">
    <!-- A-Frame scene (camera rotation source) -->
    <a-scene
      embedded
      vr-mode-ui="enabled: true"
      renderer="antialias: true; alpha: true"
      background="color: #020617">

      <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á: GameEngine ‡∏≠‡πà‡∏≤‡∏ô rotation ‡∏à‡∏≤‡∏Å #fg-cam -->
      <a-entity id="rig" position="0 1.6 0">
        <a-camera id="fg-cam" look-controls="enabled: true" wasd-controls-enabled="false">
        </a-camera>
      </a-entity>

    </a-scene>

    <!-- DOM targets layer (GameEngine appends .fg-target here) -->
    <div id="fg-layer" aria-label="targets layer"></div>

    <!-- Start overlay -->
    <div class="start" id="fg-start">
      <div class="startCard">
        <h1>üçΩÔ∏è Food Groups VR</h1>
        <div class="muted">
          ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢!<br>
          - ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏¢‡∏¥‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πá‡∏á<br>
          - ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠/‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Lock + Burst + Charge (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)
        </div>

        <div class="startGrid" style="margin-top:12px">
          <div class="chip">Difficulty: <b id="fg-ui-diff">‚Äî</b></div>
          <div class="chip">Time: <b id="fg-ui-time">‚Äî</b>s</div>
          <div class="chip">Mode: <b id="fg-ui-run">‚Äî</b></div>
          <div class="chip">Seed: <b id="fg-ui-seed">‚Äî</b></div>
        </div>

        <div class="actions">
          <button class="btn primary" id="fg-btn-start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô ‚ñ∂</button>
          <button class="btn ghost" id="fg-btn-start-vr">‡πÄ‡∏Ç‡πâ‡∏≤ VR ‚ñ∂</button>
          <button class="btn ghost" id="fg-btn-gaze">‡∏™‡∏•‡∏±‡∏ö Gaze</button>
          <button class="btn ghost" id="fg-btn-stop">‡∏´‡∏¢‡∏∏‡∏î</button>
        </div>

        <div class="smallNote">
          ‡∏ñ‡πâ‡∏≤ ‚ÄúQUEST ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ <b>./vr-groups/groups-quests.js</b> ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà 404) ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô GameEngine.js
        </div>
      </div>
    </div>
  </div>

  <!-- Boot (no module required; works with IIFE GameEngine) -->
  <script>
    (function(){
      'use strict';

      function $(id){ return document.getElementById(id); }
      function safeInt(v, d){ v = parseInt(v,10); return Number.isFinite(v) ? v : d; }

      const sp = new URLSearchParams(location.search);
      const diff = (sp.get('diff') || 'normal').toLowerCase();
      const timeSec = safeInt(sp.get('time'), 90);
      const run = (sp.get('run') || 'play').toLowerCase();   // play | research
      const seed = (sp.get('seed') || '').trim();

      const startEl = $('fg-start');
      const layerEl = $('fg-layer');
      const camEl = $('fg-cam');

      // UI preview
      $('fg-ui-diff').textContent = diff;
      $('fg-ui-time').textContent = String(timeSec);
      $('fg-ui-run').textContent  = run;
      $('fg-ui-seed').textContent = seed ? seed : '‚Äî';

      // buttons
      let gazeOn = true;

      function ensureEngineReady(){
        const eng = window.GroupsVR && window.GroupsVR.GameEngine;
        if (!eng) return null;
        eng.setLayerEl(layerEl);
        eng.setCameraEl(camEl);
        eng.setTimeLeft(timeSec);
        eng.setGaze(gazeOn);
        return eng;
      }

      function startGame(requestVR){
        const eng = ensureEngineReady();
        if (!eng){
          console.error('[groups-vr] GameEngine not ready');
          return;
        }

        // hide start overlay
        startEl.classList.add('hidden');

        // enter VR if requested
        if (requestVR){
          try{
            const scene = document.querySelector('a-scene');
            if (scene && scene.enterVR) scene.enterVR();
          }catch{}
        }

        // start
        eng.start(diff, {
          runMode: run,
          layerEl: layerEl,
          seed: seed || undefined
        });
      }

      $('fg-btn-start').addEventListener('click', function(){
        startGame(false);
      }, { passive:true });

      $('fg-btn-start-vr').addEventListener('click', function(){
        startGame(true);
      }, { passive:true });

      $('fg-btn-gaze').addEventListener('click', function(){
        gazeOn = !gazeOn;
        const eng = window.GroupsVR && window.GroupsVR.GameEngine;
        if (eng) eng.setGaze(gazeOn);
        this.textContent = 'Gaze: ' + (gazeOn ? 'ON' : 'OFF');
      }, { passive:true });

      $('fg-btn-stop').addEventListener('click', function(){
        const eng = window.GroupsVR && window.GroupsVR.GameEngine;
        if (eng) eng.stop('user_stop');
        startEl.classList.remove('hidden');
      }, { passive:true });

      // auto-start option (optional): add &autostart=1
      const autostart = sp.get('autostart');
      if (autostart === '1' || autostart === 'true'){
        // wait a bit for scripts
        setTimeout(()=>startGame(false), 250);
      }

      // show gaze status label initial
      $('fg-btn-gaze').textContent = 'Gaze: ' + (gazeOn ? 'ON' : 'OFF');

      // Safety: if end event fired, show start again (your UI binder shows end card too)
      window.addEventListener('hha:end', function(){
        try{ startEl.classList.remove('hidden'); }catch{}
      });

    })();
  </script>
</body>
</html>