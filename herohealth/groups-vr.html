<!-- === /herohealth/vr-groups/groups-vr.html ==============================
Food Groups VR ‚Äî PRODUCTION HTML (Latest)
‚úÖ DOM gameplay layer (#fg-layer)
‚úÖ HUD top + Group banner + Lock ring + Start overlay
‚úÖ Loads: particles.js + groups-hud-quest.js + groups-quests.js + GameEngine.js
========================================================================= -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (scene only, gameplay is DOM on top) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- FX / Global particles (shared) -->
  <script src="../vr/particles.js" defer></script>

  <!-- Quest HUD binder (ensures panel exists even if HTML missing) -->
  <script src="./groups-hud-quest.js" defer></script>

  <!-- Quest system -->
  <script src="./groups-quests.js" defer></script>

  <!-- Engine -->
  <script src="./GameEngine.js" defer></script>

</head>

<body>
  <!-- A-Frame scene (background world) -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias:true; colorManagement:true">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="camera" wasd-controls-enabled="false"></a-camera>
    </a-entity>

    <!-- simple ambience -->
    <a-sky color="#071024"></a-sky>
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-entity light="type:directional; intensity:0.8" position="1 2 1"></a-entity>
  </a-scene>

  <!-- Gameplay DOM layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- ===== HUD TOP ===== -->
  <div class="hud-top">
    <!-- Left: score/combo/miss -->
    <div class="hud-card hud-left">
      <div class="hud-row"><div class="hud-title">SCORE</div><div class="hud-val" id="hud-score">0</div></div>
      <div class="hud-row"><div class="hud-title">COMBO</div><div class="hud-val" id="hud-combo">0</div></div>
      <div class="hud-row"><div class="hud-title">MISS</div><div class="hud-val" id="hud-miss">0</div></div>
    </div>

    <!-- Mid: group + timer + power -->
    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div class="hud-group" id="hud-group">‡∏´‡∏°‡∏π‡πà 1</div>
        <div class="hud-timer" id="hud-time">90</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <div>POWER</div>
          <div id="hud-powerText">0/7</div>
        </div>
        <div class="power-bar">
          <div class="power-fill" id="hud-powerFill"></div>
        </div>
      </div>

      <!-- Quest mini panel (compat ids ‚Äî groups-hud-quest.js will also update) -->
      <div class="quest-wrap">
        <div class="quest-line">
          <div class="q-badge">GOAL</div>
          <div class="q-text" id="hud-goal-title">‚Äî</div>
          <div class="q-num" id="hud-goal-val">0/0</div>
        </div>
        <div class="quest-line">
          <div class="q-badge mini">MINI</div>
          <div class="q-text" id="hud-mini-title">‚Äî</div>
          <div class="q-num" id="hud-mini-val">0/0</div>
        </div>
      </div>
    </div>

    <!-- Right: Rank -->
    <div class="hud-card hud-right">
      <div class="rank-box">
        <div>
          <div class="rank-title">RANK</div>
          <div class="rank-grade" id="hud-rank">A</div>
        </div>
        <div style="text-align:right">
          <div class="rank-title">ACC</div>
          <div class="rank-grade" style="font-size:20px" id="hud-acc">0%</div>
        </div>
      </div>
      <div class="rank-sub">
        <div>Shots: <span id="hud-shots">0</span></div>
        <div>Hits: <span id="hud-hits">0</span></div>
      </div>
    </div>
  </div>

  <!-- Group banner -->
  <div id="groupBanner" class="group-banner" style="display:none">
    <div class="group-banner-text" id="groupBannerText">‡∏´‡∏°‡∏π‡πà 1</div>
    <div class="group-banner-sub" id="groupBannerSub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô!</div>
  </div>

  <!-- Lock ring (visual only; driven by groups:lock event) -->
  <div id="lockRing" class="lock-ring" style="display:none">
    <div class="lock-core"></div>
    <div class="lock-prog" id="lockProg"></div>
    <div class="lock-charge" id="lockCharge"></div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô üéØ<br>
        ‡∏£‡∏∞‡∏ß‡∏±‡∏á <b>Junk</b> ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ <b>Stun</b> ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>
        ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‚Äù = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Ä¢ ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ = Lock ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á
      </div>

      <div class="start-grid">
        <div class="pill">üéØ Correct = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
        <div class="pill">üö´ Junk = Stun 0.8s</div>
        <div class="pill">üåÄ Decoy = ‡∏´‡∏•‡∏≠‡∏Å‡∏ï‡∏≤</div>
        <div class="pill">üß† Boss = ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ</div>
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStartPlay">‚ñ∂Ô∏è Start (Play)</button>
        <button class="btn ghost" id="btnStartResearch">üß™ Start (Research)</button>
      </div>

      <div class="start-note">
        URL params: <code>?diff=easy|normal|hard&time=90&run=play|research&seed=xxx</code>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // --- helpers ---
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function byId(id){ return document.getElementById(id); }
    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

    // --- elements ---
    const layer = byId('fg-layer');
    const startOverlay = byId('startOverlay');

    const elScore = byId('hud-score');
    const elCombo = byId('hud-combo');
    const elMiss  = byId('hud-miss');
    const elTime  = byId('hud-time');
    const elGroup = byId('hud-group');

    const elPowerFill = byId('hud-powerFill');
    const elPowerText = byId('hud-powerText');

    const elRank = byId('hud-rank');
    const elAcc  = byId('hud-acc');
    const elShots= byId('hud-shots');
    const elHits = byId('hud-hits');

    const groupBanner = byId('groupBanner');
    const groupBannerText = byId('groupBannerText');

    const lockRing = byId('lockRing');

    // --- params defaults ---
    const diff = (qs('diff') || 'normal').toLowerCase();
    const time = parseInt(qs('time') || '90', 10) || 90;
    const run  = (qs('run') || 'play').toLowerCase();
    const seed = qs('seed') || undefined;

    function startGame(runMode){
      // hide overlay
      startOverlay.style.display = 'none';

      // set engine targets layer
      if (window.GroupsVR && window.GroupsVR.GameEngine){
        window.GroupsVR.GameEngine.setLayerEl(layer);
        window.GroupsVR.GameEngine.setTimeLeft(time);
        window.GroupsVR.GameEngine.start(diff, { runMode, seed });
      } else {
        alert('GameEngine not loaded');
      }
    }

    // buttons
    byId('btnStartPlay').addEventListener('click', ()=>startGame('play'));
    byId('btnStartResearch').addEventListener('click', ()=>startGame('research'));

    // also auto start if run param exists and overlay should be skipped
    if (qs('autostart') === '1'){
      startGame(run);
    }

    // --- events wiring ---
    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail || {};
      elScore.textContent = (d.score|0);
      elCombo.textContent = (d.combo|0);
      elMiss.textContent  = (d.misses|0);
    }, { passive:true });

    window.addEventListener('hha:time', (ev)=>{
      const d = ev.detail || {};
      // engine sends {left}
      elTime.textContent = (d.left!=null ? (d.left|0) : '‚Äî');
      // panic css
      const left = (d.left|0);
      if (left <= 10) document.documentElement.classList.add('panic');
      else document.documentElement.classList.remove('panic');
    }, { passive:true });

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail || {};
      if (d.grade) elRank.textContent = d.grade;
      if (typeof d.accuracy === 'number') elAcc.textContent = (d.accuracy|0) + '%';
      if (typeof d.shots === 'number') elShots.textContent = (d.shots|0);
      if (typeof d.hits === 'number') elHits.textContent = (d.hits|0);
    }, { passive:true });

    window.addEventListener('groups:power', (ev)=>{
      const d = ev.detail || {};
      if (d.groupName) elGroup.textContent = d.groupName;

      const th = Math.max(1, d.threshold|0);
      const c  = clamp(d.charge|0, 0, th);
      elPowerText.textContent = c + '/' + th;
      elPowerFill.style.width = Math.round((c/th)*100) + '%';

      // tiny pulse
      elPowerFill.classList.remove('pulse');
      requestAnimationFrame(()=>elPowerFill.classList.add('pulse'));
    }, { passive:true });

    window.addEventListener('groups:group_change', (ev)=>{
      const d = ev.detail || {};
      const label = d.label || '‡∏´‡∏°‡∏π‡πà ?';
      elGroup.textContent = label;

      // banner pop
      groupBannerText.textContent = label;
      groupBanner.style.display = '';
      groupBanner.classList.remove('pop');
      requestAnimationFrame(()=>groupBanner.classList.add('pop'));
      setTimeout(()=>{ groupBanner.style.display = 'none'; }, 900);
    }, { passive:true });

    window.addEventListener('groups:lock', (ev)=>{
      const d = ev.detail || {};
      if (!d.on){
        lockRing.style.display = 'none';
        return;
      }
      lockRing.style.display = '';
      // place ring at x/y
      const x = (d.x!=null ? d.x : window.innerWidth/2);
      const y = (d.y!=null ? d.y : window.innerHeight/2);
      lockRing.style.transform = `translate(-50%,-50%) translate3d(${x}px, ${y}px, 0)`;

      // set progress vars
      lockRing.style.setProperty('--p', String(clamp(d.prog,0,1)));
      lockRing.style.setProperty('--c', String(clamp(d.charge,0,1)));
    }, { passive:true });

    window.addEventListener('groups:stun', (ev)=>{
      const d = ev.detail || {};
      // visual flash is done in engine via html.stunflash, but keep a hook
      // (‡πÑ‡∏ß‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏ï‡∏¥‡πä‡∏Å‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
    }, { passive:true });

    window.addEventListener('hha:end', (ev)=>{
      // show overlay again (simple end)
      startOverlay.style.display = '';
      // optionally could show summary modal here
    }, { passive:true });

  })();
  </script>
</body>
</html>