<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GroupsVR Launcher</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    html,body{height:100%;margin:0;background:#020617;color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;}
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(820px,100%);border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.72);border-radius:18px;padding:18px}
    .muted{color:#94a3b8;font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;word-break:break-all}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:1px solid rgba(148,163,184,.22);background:rgba(2,6,23,.62);
      color:#e5e7eb;padding:10px 12px;border-radius:14px;cursor:pointer}
    button:hover{background:rgba(2,6,23,.78)}
    .primary{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="font-weight:1000;font-size:16px">üß© GroupsVR</div>
    <div class="muted" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‚Ä¶</div>
    <div class="mono" id="dbg" style="margin-top:10px;opacity:.9"></div>
    <div class="row">
      <button class="primary" id="btn-go">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
      <button id="btn-hub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      <button id="btn-force-warmup">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Warmup (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)</button>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  // --------------------------
  // helpers: QS + url
  // --------------------------
  function getQS(){
    try{ return new URL(location.href).searchParams; }
    catch{ return new URLSearchParams(); }
  }
  const QS = getQS();
  const q = (k, def='') => (QS.get(k) ?? def);

  function buildUrl(base, add){
    if(!base) return '';
    const add2 = add || {};
    try{
      const u = new URL(base, location.href);
      Object.entries(add2).forEach(([k,v])=>{
        if(v === undefined || v === null || v === '') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }catch(_){
      const join = String(base).includes('?') ? '&' : '?';
      const qs2 = Object.entries(add2)
        .filter(([,v])=>!(v===undefined||v===null||v===''))
        .map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(String(v))).join('&');
      return qs2 ? (String(base) + join + qs2) : String(base);
    }
  }

  // passthrough (‡∏´‡πâ‡∏≤‡∏° override view ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  function getPassthrough(){
    const deny = new Set([
      'hub','next','phase','dur','cdur','autonext','preset','wmode','games',
      'gate','gateOnce','gateKey','gateUrl','run','warmup'
    ]);
    const out = {};
    QS.forEach((v,k)=>{ if(!deny.has(k)) out[k]=v; });
    return out;
  }

  // --------------------------
  // config
  // --------------------------
  const HUB = q('hub',''); // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏™‡∏°‡∏≠
  const RUN = q('run','./vr-groups/groups-vr.html'); // ‡∏ï‡∏±‡∏ß run ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°
  const WARMUP_URL = q('gateUrl','https://supparang.github.io/herohealth/warmup-gate.html');

  // warmup policy
  const GATE_ONCE = String(q('gateOnce','1')||'1') === '1';  // default ON
  const FORCE_WARMUP = String(q('warmup','0')||'0') === '1'; // manual test
  const PRESET = (q('preset','hype')||'hype').toLowerCase(); // fast|hype
  const DUR = Math.max(10, Math.min(60, Number(q('dur','20')||20)));
  const CDUR = Math.max(10, Math.min(60, Number(q('cdur','20')||20)));

  // --------------------------
  // pid/device & once/day key (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö warmup-gate.html patched)
  // --------------------------
  function getOrMakeDeviceId(){
    try{
      let id = localStorage.getItem('HHA_DEVICE_ID') || '';
      if(!id){
        id = 'dev_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
        localStorage.setItem('HHA_DEVICE_ID', id);
      }
      return id;
    }catch(_){ return 'dev_fallback'; }
  }

  function getPidLike(){
    // 1) pid ‡∏à‡∏≤‡∏Å query (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const qp = (q('pid','')||'').trim();
    if(qp) return qp;

    // 2) pid ‡∏à‡∏≤‡∏Å badges (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    try{
      const B = window.HHA_Badges;
      const pid = (B && B.getPid) ? String(B.getPid()||'').trim() : '';
      if(pid) return pid;
    }catch(_){}

    // 3) device id
    return getOrMakeDeviceId();
  }

  function dayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function warmupDoneTodayKey(){
    const pid = getPidLike();
    return `HHA_WARMUP_DONE_groups_${pid}_${dayKey()}`;
  }

  function isWarmupDoneToday(){
    if(!GATE_ONCE) return false;
    try{ return localStorage.getItem(warmupDoneTodayKey()) === '1'; }
    catch(_){ return false; }
  }

  // --------------------------
  // routing
  // --------------------------
  const $ = (s)=>document.querySelector(s);
  const statusEl = $('#status');
  const dbgEl = $('#dbg');

  function goHub(){
    if(HUB){ location.href = HUB; return; }
    history.length ? history.back() : (location.href = './');
  }

  function goRun(){
    const url = buildUrl(RUN, {
      ...getPassthrough(),
      hub: HUB || undefined,
      gate: '0',
      cdur: String(CDUR)
    });
    location.href = url;
  }

  function goWarmup(){
    // next = run url (encode ‡∏ú‡πà‡∏≤‡∏ô buildUrl ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
    const nextRun = buildUrl(RUN, {
      ...getPassthrough(),
      hub: HUB || undefined,
      gate: '0',
      cdur: String(CDUR)
    });

    const gate = buildUrl(WARMUP_URL, {
      phase: 'warmup',
      dur: String(DUR),
      hub: HUB || undefined,
      next: nextRun,
      autonext: '1',
      preset: PRESET
    });

    // ‡πÉ‡∏ä‡πâ replace ‡∏Å‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡∏ô
    location.replace(gate);
  }

  function decide(){
    const done = isWarmupDoneToday();
    const pid = getPidLike();
    const k = warmupDoneTodayKey();

    dbgEl.textContent =
      `pid/device=${pid}\n` +
      `once/day=${GATE_ONCE?1:0}  doneToday=${done?1:0}\n` +
      `key=${k}\n` +
      `preset=${PRESET} dur=${DUR} cdur=${CDUR}\n` +
      `warmupUrl=${WARMUP_URL}\n` +
      `run=${RUN}\n` +
      `hub=${HUB||'(none)'}`;

    // ‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö warmup
    if(FORCE_WARMUP){
      statusEl.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Warmup‚Ä¶';
      goWarmup();
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢
    if(done){
      statusEl.textContent = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° Groups‚Ä¶';
      goRun();
      return;
    }

    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ -> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ (‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
    if(GATE_ONCE){
      statusEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤ Warmup Gate‚Ä¶';
      goWarmup();
      return;
    }

    // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö -> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°
    statusEl.textContent = '‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Warmup ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° Groups‚Ä¶';
    goRun();
  }

  // UI buttons
  $('#btn-go').addEventListener('click', decide);
  $('#btn-hub').addEventListener('click', goHub);
  $('#btn-force-warmup').addEventListener('click', ()=>{
    const u = new URL(location.href);
    u.searchParams.set('warmup','1');
    location.href = u.toString();
  });

  // auto
  decide();

})();
</script>
</body>
</html>