<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (classic scripts) + VR-feel
‚úÖ CSS: groups.css alias -> groups-vr.css
‚úÖ HUD root wrapper fixed
‚úÖ Start overlay includes ‚ÄúEnable Motion‚Äù (iOS)
‚úÖ Boot binds HUD + engine + end summary overlay
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‚úÖ IMPORTANT: alias loader (keep your alias mapping groups.css -> groups-vr.css) -->
  <link rel="stylesheet" href="./groups.css" />
</head>

<body>
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true">
    <a-sky color="#06101f"></a-sky>
    <a-entity position="0 1.6 0" camera look-controls></a-entity>
  </a-scene>

  <!-- Gameplay layer -->
  <div class="fg-layer" id="fg-layer"></div>

  <!-- ‚úÖ HUD root -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card hud-left">
        <div class="hud-row">
          <div class="hud-title">SCORE</div>
          <div class="hud-val" id="hud-score">0</div>
        </div>
        <div class="hud-row">
          <div class="hud-title">COMBO</div>
          <div class="hud-val" id="hud-combo">0</div>
        </div>
        <div class="hud-row">
          <div class="hud-title">MISS</div>
          <div class="hud-val" id="hud-miss">0</div>
        </div>
      </div>

      <div class="hud-card hud-mid">
        <div class="hud-group-row">
          <div class="hud-group" id="hud-group">‡∏´‡∏°‡∏π‡πà ?</div>
          <div class="hud-timer" id="hud-time">90</div>
        </div>

        <div class="power-wrap">
          <div class="power-label">
            <div>POWER</div>
            <div id="fg-powerText" style="font-weight:900;opacity:.9">0/0</div>
          </div>
          <div class="power-bar">
            <div class="power-fill" id="hud-powerFill"></div>
          </div>
        </div>

        <div class="quest-wrap">
          <div class="quest-line">
            <div class="q-badge">GOAL</div>
            <div class="q-text" id="hud-goal-title">‚Äî</div>
            <div class="q-num" id="hud-goal-val">0/0</div>
          </div>
          <div class="qbar">
            <div class="qbar-track">
              <div class="qbar-fill goal" id="hud-goal-bar"></div>
            </div>
          </div>

          <div class="quest-line">
            <div class="q-badge mini">MINI</div>
            <div class="q-text" id="hud-mini-title">‚Äî</div>
            <div class="q-num" id="hud-mini-val">0/0</div>
          </div>
          <div class="qbar">
            <div class="qbar-track">
              <div class="qbar-fill mini" id="hud-mini-bar"></div>
            </div>
            <div class="qbar-timer" id="hud-mini-timer"></div>
          </div>
        </div>
      </div>

      <div class="hud-card hud-right">
        <div class="rank-box">
          <div>
            <div class="rank-title">RANK</div>
            <div class="rank-sub">
              <span>ACC</span>
              <span id="hud-acc">0%</span>
            </div>
          </div>
          <div class="rank-grade" id="hud-rank">C</div>
        </div>
        <div class="rank-sub">
          <span>BEST</span>
          <span id="hud-comboMax">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div class="start-overlay" id="startOverlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù üéØ ‡∏™‡∏∞‡∏™‡∏°‡∏û‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà ‚ú®<br/>
        ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏¢‡∏∞ (STUN) üö´ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å (decoy) ‚ùì
      </div>

      <div class="start-grid">
        <div class="pill" id="pill-diff">DIFF: normal</div>
        <div class="pill" id="pill-time">TIME: 90s</div>
        <div class="pill" id="pill-mode">MODE: play</div>
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn ghost" id="btnRestart">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        <button class="btn ghost" id="btnMotion" style="display:none">Enable Motion üéØ</button>
      </div>

      <div class="start-note">
        Tip: ‡πÅ‡∏ï‡∏∞ = ‡∏¢‡∏¥‡∏á / ‡∏•‡∏≤‡∏Å‡∏à‡∏≠ = ‡∏°‡∏≠‡∏á‡∏£‡∏≠‡∏ö ‡πÜ (VR-feel) / ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>
    </div>
  </div>

  <!-- Result overlay (simple) -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</h2>
      <p>Score: <b id="r-score">0</b></p>
      <p>Rank: <b id="r-rank">C</b> ¬∑ ACC <b id="r-acc">0%</b></p>
      <p>ComboMax: <b id="r-combo">0</b> ¬∑ Miss: <b id="r-miss">0</b></p>
      <hr/>
      <button id="r-retry">RETRY</button>
      <button id="r-close">CLOSE</button>
    </div>
  </div>

  <!-- ===== Scripts ===== -->
  <script src="./groups-hud-quest.js"></script>
  <script src="./groups-quests.js"></script>
  <script src="./groups-fx.js"></script>
  <script src="./GameEngine.js"></script>

  <!-- Boot -->
  <script>
  (function(){
    'use strict';

    function qs(name, def){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? def;
    }
    function int(name, def){
      const v = parseInt(qs(name, def), 10);
      return Number.isFinite(v) ? v : def;
    }

    const diff = String(qs('diff','normal')).toLowerCase();
    const time = int('time', 90);
    const run  = String(qs('run','play')).toLowerCase();
    const seed = qs('seed', '') || (qs('sessionId','') || '') || (qs('studentKey','') || '');

    document.getElementById('pill-diff').textContent = 'DIFF: ' + diff;
    document.getElementById('pill-time').textContent = 'TIME: ' + time + 's';
    document.getElementById('pill-mode').textContent = 'MODE: ' + run;

    // HUD binders
    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail || {};
      const score = (d.score|0);
      const combo = (d.combo|0);
      const miss  = (d.misses|0);
      const comboMax = (d.comboMax|0);

      const sEl = document.getElementById('hud-score'); if (sEl) sEl.textContent = score;
      const cEl = document.getElementById('hud-combo'); if (cEl) cEl.textContent = combo;
      const mEl = document.getElementById('hud-miss');  if (mEl) mEl.textContent = miss;
      const bEl = document.getElementById('hud-comboMax'); if (bEl) bEl.textContent = comboMax;
    }, { passive:true });

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail || {};
      if (d.grade){
        const rEl = document.getElementById('hud-rank'); if (rEl) rEl.textContent = d.grade;
      }
      if (typeof d.accuracy === 'number'){
        const aEl = document.getElementById('hud-acc'); if (aEl) aEl.textContent = (d.accuracy|0) + '%';
      }
    }, { passive:true });

    window.addEventListener('hha:time', (ev)=>{
      const d = ev.detail || {};
      const left = (d.left|0);
      const tEl = document.getElementById('hud-time'); if (tEl) tEl.textContent = left;
    }, { passive:true });

    window.addEventListener('groups:group_change', (ev)=>{
      const d = ev.detail || {};
      const gEl = document.getElementById('hud-group'); if (gEl) gEl.textContent = d.label || '‡∏´‡∏°‡∏π‡πà ?';
    }, { passive:true });

    window.addEventListener('groups:power', (ev)=>{
      const d = ev.detail || {};
      const th = Math.max(1, d.threshold|0);
      const ch = Math.max(0, d.charge|0);
      const p = Math.min(100, (ch/th)*100);

      const fill = document.getElementById('hud-powerFill');
      if (fill) fill.style.width = p.toFixed(1) + '%';

      const txt = document.getElementById('fg-powerText');
      if (txt) txt.textContent = `${ch}/${th}`;
    }, { passive:true });

    // End overlay
    const resultOverlay = document.getElementById('resultOverlay');
    window.addEventListener('hha:end', (ev)=>{
      const d = ev.detail || {};
      document.getElementById('r-score').textContent = (d.scoreFinal|0);
      document.getElementById('r-rank').textContent = d.grade || 'C';
      document.getElementById('r-acc').textContent = (d.accuracyGoodPct|0) + '%';
      document.getElementById('r-combo').textContent = (d.comboMax|0);
      document.getElementById('r-miss').textContent = (d.misses|0);
      resultOverlay.classList.add('show');
    }, { passive:true });

    document.getElementById('r-retry').addEventListener('click', ()=>location.reload());
    document.getElementById('r-close').addEventListener('click', ()=>resultOverlay.classList.remove('show'));

    // Start controls
    const overlay = document.getElementById('startOverlay');
    const btnStart = document.getElementById('btnStart');
    const btnRestart = document.getElementById('btnRestart');
    const btnMotion = document.getElementById('btnMotion');

    function engineRef(){
      return (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
    }

    function boot(enableGyro){
      const engine = engineRef();
      if (!engine){
        alert('GroupsVR.GameEngine not found');
        return;
      }
      engine.setLayerEl(document.getElementById('fg-layer'));
      engine.setTimeLeft(time);
      engine.start(diff, { runMode: run, seed: seed, enableGyro: !!enableGyro });
    }

    // iOS motion permission
    (function setupMotionButton(){
      try{
        const needs =
          (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function');
        if (needs) btnMotion.style.display = 'inline-block';
      }catch(e){}
    })();

    btnMotion.addEventListener('click', async ()=>{
      try{
        if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function'){
          const res = await window.DeviceOrientationEvent.requestPermission();
          if (res === 'granted'){
            const engine = engineRef();
            if (engine && engine.enableGyro) engine.enableGyro();
            btnMotion.style.display = 'none';
          }
        }
      }catch(e){}
    });

    btnStart.addEventListener('click', ()=>{
      overlay.style.display = 'none';
      boot(false);
    });

    btnRestart.addEventListener('click', ()=> location.reload());

    if (qs('autostart','0') === '1'){
      overlay.style.display = 'none';
      boot(false);
    }
  })();
  </script>
</body>
</html>
