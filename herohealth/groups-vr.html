<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî FULL HTML (Split CSS + FIX-ALL)
‚úÖ Uses ./vr-groups/groups.css
‚úÖ Loads IIFE libs before GameEngine (modules)
‚úÖ Works with window.GroupsVR.GameEngine + window.GroupsQuest.createFoodGroupsQuest
‚úÖ HUD/Quest/Fever/Rank/End compatible (hha:* events)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- ‚úÖ Split CSS -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ===== IIFE libs (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô engine) ===== -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Groups Quest (IIFE) -->
  <script src="./vr-groups/groups-quests.js" defer></script>

  <!-- (optional) UI helper for reticle/lock overlay if you have it -->
  <!-- <script src="./vr-groups/groups-ui.js" defer></script> -->

  <!-- ===== Engine (IIFE) ===== -->
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* minimal safety (keep tiny only) */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>

<body>
  <!-- ===== A-Frame scene (background / camera rotation source) ===== -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="colorManagement: true; physicallyCorrectLights: false">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false" look-controls="reverseMouseDrag: false"></a-camera>
    </a-entity>

    <!-- soft ambient -->
    <a-entity light="type: ambient; intensity: 0.85"></a-entity>
    <a-entity light="type: directional; intensity: 0.55" position="0 2 1"></a-entity>
  </a-scene>

  <!-- ===== Targets layer ===== -->
  <div id="fg-layer" aria-label="Food Groups targets layer"></div>

  <!-- ===== FX edge pulse (panic / wave) ===== -->
  <div id="fg-edgePulse" class="fg-edgePulse" aria-hidden="true"></div>

  <!-- ===== Reticle ===== -->
  <div id="fg-reticle" class="fg-reticle" aria-hidden="true"></div>

  <!-- ===== Lock UI (SVG ring) ===== -->
  <div id="fg-lockUI" class="fg-lockUI" aria-hidden="true">
    <svg width="120" height="120" viewBox="0 0 120 120">
      <circle class="ringBack"  cx="60" cy="60" r="44"></circle>
      <circle class="ringProg"  cx="60" cy="60" r="44" stroke-dasharray="276.46" stroke-dashoffset="276.46"></circle>
      <circle class="ringCharge" cx="60" cy="60" r="32" stroke-dasharray="201.06" stroke-dashoffset="201.06"></circle>
    </svg>
  </div>

  <!-- ===== HUD (must match hha-hud.js ids) ===== -->
  <div id="hha-hud" style="position:fixed; inset:0; z-index:40; pointer-events:none;">
    <!-- top bar -->
    <div style="position:fixed; left:12px; right:12px; top:10px; display:flex; gap:10px; justify-content:space-between; align-items:flex-start;">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px;">
          <div style="font-size:12px; opacity:.85;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          <div id="hudScore" style="font-size:18px; font-weight:900;">0</div>
        </div>
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px;">
          <div style="font-size:12px; opacity:.85;">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
          <div id="hudCombo" style="font-size:18px; font-weight:900;">0</div>
        </div>
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px;">
          <div style="font-size:12px; opacity:.85;">Miss</div>
          <div id="hudMiss" style="font-size:18px; font-weight:900;">0</div>
        </div>
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px;">
          <div style="font-size:12px; opacity:.85;">‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div id="hudTime" style="font-size:18px; font-weight:900;">0</div>
        </div>
      </div>

      <!-- right: current group + rank -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px; text-align:right;">
          <div style="font-size:12px; opacity:.85;">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
          <div id="hudGroup" style="font-size:14px; font-weight:900;">‚Äî</div>
        </div>
        <div style="background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:10px 12px; text-align:right;">
          <div style="font-size:12px; opacity:.85;">‡πÄ‡∏Å‡∏£‡∏î</div>
          <div id="hudGrade" style="font-size:18px; font-weight:1000;">C</div>
        </div>
      </div>
    </div>

    <!-- quest box -->
    <div style="position:fixed; left:12px; right:12px; bottom:14px; display:flex; gap:12px; justify-content:space-between; align-items:flex-end;">
      <div style="flex:1; max-width:720px; background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:12px 12px;">
        <div style="font-size:12px; opacity:.85;">GOAL</div>
        <div id="hudGoal" style="font-size:14px; font-weight:900;">‚Äî</div>
        <div id="hudGoalProg" style="font-size:12px; opacity:.85; margin-top:2px;">0/0</div>
        <div style="height:8px; background:rgba(148,163,184,.12); border-radius:999px; overflow:hidden; margin-top:8px;">
          <div id="hudGoalBar" style="height:100%; width:0%; background:rgba(34,197,94,.75);"></div>
        </div>

        <div style="height:10px;"></div>

        <div style="font-size:12px; opacity:.85;">MINI</div>
        <div id="hudMini" style="font-size:14px; font-weight:900;">‚Äî</div>
        <div id="hudMiniProg" style="font-size:12px; opacity:.85; margin-top:2px;">0/0</div>
        <div style="height:8px; background:rgba(148,163,184,.12); border-radius:999px; overflow:hidden; margin-top:8px;">
          <div id="hudMiniBar" style="height:100%; width:0%; background:rgba(59,130,246,.70);"></div>
        </div>

        <div id="hudMiniTimer" style="font-size:12px; opacity:.85; margin-top:6px; display:none;">‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 0 ‡∏ß‡∏¥</div>
      </div>

      <!-- coach bubble -->
      <div style="width:min(360px, 44vw); background:rgba(2,6,23,.62); border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:12px 12px;">
        <div style="font-size:12px; opacity:.85;">Coach</div>
        <div id="hudCoach" style="font-size:14px; font-weight:900; line-height:1.35;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‚ú®</div>
      </div>
    </div>

    <!-- end screen -->
    <div id="hudEnd" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; background:rgba(2,6,23,.82); backdrop-filter:blur(10px); z-index:60; pointer-events:auto;">
      <div style="width:min(780px, 92vw); border-radius:22px; border:1px solid rgba(148,163,184,.22); background:rgba(2,6,23,.76); box-shadow:0 30px 90px rgba(0,0,0,.55); padding:16px;">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <div style="font-size:12px; opacity:.85;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
            <div style="font-size:22px; font-weight:1000;">Food Groups VR</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px; opacity:.85;">Grade</div>
            <div id="endGrade" style="font-size:28px; font-weight:1000;">C</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <div class="pill">Score: <b id="endScore">0</b></div>
          <div class="pill">ComboMax: <b id="endComboMax">0</b></div>
          <div class="pill">Miss: <b id="endMiss">0</b></div>
          <div class="pill">Goal: <b id="endGoal">0</b></div>
          <div class="pill">Mini: <b id="endMini">0</b></div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="btnRestart" class="primary">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button id="btnCloseEnd">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Start overlay ===== -->
  <div id="startOverlay">
    <div id="startCard">
      <h1>Food Groups VR üçΩÔ∏è</h1>
      <div id="startMeta">
        <div class="pill">Mode: <b id="mRun">play</b></div>
        <div class="pill">Diff: <b id="mDiff">normal</b></div>
        <div class="pill">Time: <b id="mTime">60</b> s</div>
      </div>
      <div id="startHint">
        ‚úÖ ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î<br/>
        ‚úÖ ‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î (burst) + ‡∏°‡∏µ CHARGE/CHAIN ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à<br/>
        ‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≤‡∏° ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô!
      </div>
      <div id="startActions">
        <button id="btnEnterVR">‡πÄ‡∏Ç‡πâ‡∏≤ VR</button>
        <button id="btnStart" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    function $(id){ return document.getElementById(id); }
    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }
    function pct(p,t){
      const P = clamp(p,0,(t||0));
      const T = Math.max(1,(t||0));
      return clamp(Math.round((P/T)*100), 0, 100);
    }
    function qs(){
      try{ return new URLSearchParams(location.search); }catch{ return new URLSearchParams(); }
    }

    // ----- read params -----
    const sp = qs();
    const diff = String(sp.get('diff') || 'normal').toLowerCase();
    const time = Math.max(10, parseInt(sp.get('time')||'60',10)||60);
    const run  = String(sp.get('run') || 'play').toLowerCase(); // play | research

    $('mDiff').textContent = diff;
    $('mTime').textContent = String(time);
    $('mRun').textContent  = (run==='research') ? 'research' : 'play';

    // ----- bind engine after scripts ready -----
    function ensureEngine(){
      return window.GroupsVR && window.GroupsVR.GameEngine;
    }

    function ensureUILayer(){
      const layer = $('fg-layer');
      const ret = $('fg-reticle');
      const edge = $('fg-edgePulse');
      const lockUI = $('fg-lockUI');

      // basic reticle pulses via custom events (from engine)
      window.addEventListener('groups:reticle', (ev)=>{
        const st = ev && ev.detail ? String(ev.detail.state||'') : '';
        if (!ret) return;
        ret.classList.remove('ok','miss','perfect');
        if (st==='ok') ret.classList.add('ok');
        else if (st==='miss') ret.classList.add('miss');
        else if (st==='perfect') ret.classList.add('perfect');
      });

      // edge pulse (panic / wave)
      window.addEventListener('hha:panic', (ev)=>{
        if (!edge) return;
        const on = !!(ev && ev.detail && ev.detail.on);
        edge.classList.toggle('on', on);
        if (on){
          edge.classList.remove('beat');
          void edge.offsetWidth;
          edge.classList.add('beat');
        }
      });
      window.addEventListener('groups:danger', (ev)=>{
        if (!edge) return;
        const on = !!(ev && ev.detail && ev.detail.on);
        if (on){
          edge.classList.add('on');
          edge.classList.remove('beat');
          void edge.offsetWidth;
          edge.classList.add('beat');
        }
      });

      // lock UI ring
      const progCircle = lockUI ? lockUI.querySelector('.ringProg') : null;
      const chgCircle  = lockUI ? lockUI.querySelector('.ringCharge') : null;
      const progLen = 276.46; // 2*pi*44
      const chgLen  = 201.06; // 2*pi*32

      window.addEventListener('groups:lock', (ev)=>{
        if (!lockUI) return;
        const d = (ev && ev.detail) ? ev.detail : {};
        const on = !!d.on;
        lockUI.classList.toggle('on', on);
        if (!on) return;

        const x = Number(d.x)||window.innerWidth/2;
        const y = Number(d.y)||window.innerHeight/2;
        lockUI.style.transform = `translate3d(${Math.round(x)}px,${Math.round(y)}px,0) translate(-50%,-50%)`;

        const p = clamp(d.prog,0,1);
        const c = clamp(d.charge,0,1);
        if (progCircle) progCircle.style.strokeDashoffset = String(progLen * (1 - p));
        if (chgCircle)  chgCircle.style.strokeDashoffset  = String(chgLen  * (1 - c));
      });

      return layer;
    }

    // ----- HUD bindings (minimal; hha-hud.js also listens, but we ensure critical ones) -----
    window.addEventListener('hha:score', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if ($('hudScore')) $('hudScore').textContent = String(d.score ?? 0);
      if ($('hudCombo')) $('hudCombo').textContent = String(d.combo ?? 0);
      if ($('hudMiss'))  $('hudMiss').textContent  = String(d.misses ?? 0);
    });

    window.addEventListener('hha:time', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if ($('hudTime')) $('hudTime').textContent = String(d.left ?? 0);
    });

    window.addEventListener('hha:coach', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if ($('hudCoach')) $('hudCoach').textContent = String(d.text || '');
    });

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if ($('hudGrade')) $('hudGrade').textContent = String(d.grade || 'C');
    });

    window.addEventListener('quest:update', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if ($('hudGroup')) $('hudGroup').textContent = d.groupLabel ? String(d.groupLabel) : '‚Äî';

      const g = d.goal || null;
      if ($('hudGoal')) $('hudGoal').textContent = g ? String(g.label) : '‚Äî';
      if ($('hudGoalProg')) $('hudGoalProg').textContent = g ? `${g.prog||0}/${g.target||0}` : '0/0';
      if ($('hudGoalBar')) $('hudGoalBar').style.width = g ? (pct(g.prog||0,g.target||0) + '%') : '0%';

      const m = d.mini || null;
      if ($('hudMini')) $('hudMini').textContent = m ? String(m.label) : '‚Äî';
      if ($('hudMiniProg')) $('hudMiniProg').textContent = m ? `${m.prog||0}/${m.target||0}` : '0/0';
      if ($('hudMiniBar')) $('hudMiniBar').style.width = m ? (pct(m.prog||0,m.target||0) + '%') : '0%';

      if ($('hudMiniTimer')){
        if (m && typeof m.tLeft === 'number' && m.windowSec){
          $('hudMiniTimer').style.display = '';
          $('hudMiniTimer').textContent = `‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${Math.max(0,m.tLeft|0)} ‡∏ß‡∏¥`;
        } else {
          $('hudMiniTimer').style.display = 'none';
        }
      }
    });

    window.addEventListener('hha:end', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      const end = $('hudEnd');
      if (!end) return;

      $('endGrade').textContent = String(d.grade || 'C');
      $('endScore').textContent = String(d.scoreFinal ?? 0);
      $('endComboMax').textContent = String(d.comboMax ?? 0);
      $('endMiss').textContent = String(d.misses ?? 0);
      $('endGoal').textContent = `${d.goalsCleared ?? 0}/${d.goalsTotal ?? 0}`;
      $('endMini').textContent = `${d.miniCleared ?? 0}/${d.miniTotal ?? 0}`;

      end.style.display = 'flex';
    });

    $('btnCloseEnd').addEventListener('click', ()=>{
      $('hudEnd').style.display = 'none';
    });

    $('btnRestart').addEventListener('click', ()=>{
      $('hudEnd').style.display = 'none';
      startGame();
    });

    $('btnEnterVR').addEventListener('click', async ()=>{
      try{
        const scene = document.querySelector('a-scene');
        if (scene && scene.enterVR) scene.enterVR();
      }catch{}
    });

    function startGame(){
      const engine = ensureEngine();
      if (!engine) {
        alert('Engine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ ./vr-groups/GameEngine.js)');
        return;
      }

      const layer = ensureUILayer();
      engine.setLayerEl(layer);

      const cam = document.getElementById('cam');
      if (cam) engine.setCameraEl(cam);

      engine.setTimeLeft(time);
      engine.setGaze(true);

      $('startOverlay').style.display = 'none';

      engine.start(diff, { runMode: run });
    }

    $('btnStart').addEventListener('click', startGame);

    // Auto-start if run=play&autostart=1
    if (String(sp.get('autostart')||'') === '1'){
      setTimeout(()=>{ try{ startGame(); }catch{} }, 250);
    }
  })();
  </script>
</body>
</html>