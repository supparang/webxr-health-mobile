<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION HTML (ALL-IN)
‚úÖ DOM gameplay targets on #fg-layer
‚úÖ HUD + Quest + Lock ring + Banner + Start overlay
‚úÖ Scripts (order ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç): particles -> quests -> questHud -> engine -> boot
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./vr-groups/groups-vr.css" />

  <!-- FX (MUST be before gameplay boot if possible) -->
  <script src="./vr/particles.js" defer></script>

  <!-- Quest system (classic script) -->
  <script src="./vr-groups/groups-quests.js" defer></script>

  <!-- Quest HUD binder (IIFE) -->
  <script src="./vr-groups/groups-hud-quest.js" defer></script>

  <!-- Engine (classic script) -->
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* ‡∏Å‡∏±‡∏ô HTML ‡πÇ‡∏•‡πà‡∏á‡∏ï‡∏≠‡∏ô CSS ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤ */
    .fg-layer{ background: transparent; }
  </style>
</head>

<body>

  <!-- A-Frame Scene (‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô background) -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="colorManagement: true">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false"></a-camera>
    </a-entity>

    <a-sky color="#020617"></a-sky>
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0 3 1"></a-entity>
  </a-scene>

  <!-- Gameplay Layer -->
  <div id="fg-layer" class="fg-layer" aria-label="gameplay"></div>

  <!-- HUD -->
  <div class="hud-top">
    <div class="hud-card hud-left">
      <div class="hud-row"><div class="hud-title">SCORE</div><div id="hud-score" class="hud-val">0</div></div>
      <div class="hud-row"><div class="hud-title">COMBO</div><div id="hud-combo" class="hud-val">0</div></div>
      <div class="hud-row"><div class="hud-title">MISS</div><div id="hud-miss" class="hud-val">0</div></div>
    </div>

    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div id="hud-group" class="hud-group">‡∏´‡∏°‡∏π‡πà ?</div>
        <div id="hud-time" class="hud-timer">90</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <div>POWER</div>
          <div id="hud-powerText">0/0</div>
        </div>
        <div class="power-bar"><div id="hud-powerFill" class="power-fill"></div></div>
      </div>

      <div class="quest-wrap">
        <div class="quest-line">
          <div class="q-badge">GOAL</div>
          <div id="hud-goalTitle" class="q-text">‚Äî</div>
          <div id="hud-goalVal" class="q-num">0/0</div>
        </div>
        <div class="quest-line">
          <div class="q-badge mini">MINI</div>
          <div id="hud-miniTitle" class="q-text">‚Äî</div>
          <div id="hud-miniVal" class="q-num">0/0</div>
        </div>
      </div>
    </div>

    <div class="hud-card hud-right">
      <div class="rank-box">
        <div>
          <div class="rank-title">RANK</div>
          <div id="hud-grade" class="rank-grade">C</div>
        </div>
        <div style="text-align:right">
          <div class="rank-title">ACC</div>
          <div id="hud-acc" class="rank-grade" style="font-size:22px">0%</div>
        </div>
      </div>
      <div class="rank-sub">
        <div>ComboMax: <span id="hud-comboMax">0</span></div>
        <div>Quests: <span id="hud-questsPct">0</span>%</div>
      </div>
    </div>
  </div>

  <!-- Lock Ring (position controlled by JS) -->
  <div id="lockRing" class="lock-ring" style="display:none">
    <div class="lock-core"></div>
    <div id="lockProg" class="lock-prog"></div>
    <div id="lockCharge" class="lock-charge"></div>
  </div>

  <!-- Group Banner -->
  <div id="groupBanner" class="group-banner" style="display:none">
    <div id="groupBannerText" class="group-banner-text">‡∏´‡∏°‡∏π‡πà ?</div>
    <div id="groupBannerSub" class="group-banner-sub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô!</div>
  </div>

  <!-- Stun overlay -->
  <div id="stunOverlay" class="stun-overlay" style="display:none">
    <div class="stun-card">
      <div class="stun-title">STUN!</div>
      <div class="stun-sub">‡πÇ‡∏î‡∏ô junk ‚Äî ‡∏û‡∏±‡∏Å‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
    </div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å <b>‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</b> üéØ<br/>
        ‡∏£‡∏∞‡∏ß‡∏±‡∏á <b>junk</b> üçü = STUN ‡πÅ‡∏•‡∏∞ <b>decoy</b> ‚ùì = ‡∏´‡∏•‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÅ‡∏ï‡πâ‡∏°
      </div>

      <div class="start-grid">
        <div class="pill">Lock ‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        <div class="pill">Power ‡πÄ‡∏ï‡πá‡∏° = ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏π‡πà</div>
        <div class="pill">Boss üß† ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Æ‡∏¥‡∏ï</div>
        <div class="pill">Quest: Goal + Mini</div>
      </div>

      <div class="start-actions">
        <button id="btnStart" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnStartVR" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö VR</button>
        <button id="btnReload" class="btn ghost">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
      </div>

      <div class="start-note">
        URL params: <code>?diff=easy|normal|hard&time=80&run=play|research&seed=xxx</code>
      </div>
    </div>
  </div>

  <!-- Boot (bind events) -->
  <script>
    (function(){
      'use strict';

      function qs(k){ return new URL(location.href).searchParams.get(k); }
      function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

      const diff = (qs('diff') || 'normal').toLowerCase();
      const time = parseInt(qs('time') || '90', 10) || 90;
      const runMode = (qs('run') || 'play').toLowerCase();
      const seed = qs('seed') || undefined;

      const layer = document.getElementById('fg-layer');
      const startOverlay = document.getElementById('startOverlay');

      // HUD refs
      const $ = (id)=>document.getElementById(id);
      const hud = {
        score: $('hud-score'),
        combo: $('hud-combo'),
        miss: $('hud-miss'),
        group: $('hud-group'),
        time: $('hud-time'),
        powerText: $('hud-powerText'),
        powerFill: $('hud-powerFill'),
        goalTitle: $('hud-goalTitle'),
        goalVal: $('hud-goalVal'),
        miniTitle: $('hud-miniTitle'),
        miniVal: $('hud-miniVal'),
        grade: $('hud-grade'),
        acc: $('hud-acc'),
        comboMax: $('hud-comboMax'),
        questsPct: $('hud-questsPct')
      };

      // Lock ring
      const lockRing = $('lockRing');
      const lockProg = $('lockProg');
      const lockCharge = $('lockCharge');

      // Overlays
      const banner = $('groupBanner');
      const bannerText = $('groupBannerText');
      const stunOverlay = $('stunOverlay');

      // ---------- bind engine ----------
      function startGame(vr){
        try{ startOverlay.style.display = 'none'; }catch(_){}

        if (!window.GroupsVR || !window.GroupsVR.GameEngine){
          alert('[GroupsVR] GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
          return;
        }

        const E = window.GroupsVR.GameEngine;
        E.setLayerEl(layer);
        E.setTimeLeft(time);
        E.start(diff, { runMode: runMode, seed: seed });

        // Enter VR if requested
        if (vr){
          const scene = document.querySelector('a-scene');
          try{ scene && scene.enterVR && scene.enterVR(); }catch(_){}
        }
      }

      // Buttons
      $('btnStart').addEventListener('click', ()=>startGame(false));
      $('btnStartVR').addEventListener('click', ()=>startGame(true));
      $('btnReload').addEventListener('click', ()=>location.reload());

      // ---------- event listeners ----------
      window.addEventListener('hha:score', (ev)=>{
        const d = ev.detail || {};
        hud.score.textContent = (d.score|0);
        hud.combo.textContent = (d.combo|0);
        hud.miss.textContent  = (d.misses|0);
        hud.comboMax.textContent = (d.comboMax|0);
      }, { passive:true });

      window.addEventListener('hha:time', (ev)=>{
        const d = ev.detail || {};
        const left = (d.left|0);
        hud.time.textContent = left;

        // Panic hint
        if (left <= 10) document.documentElement.classList.add('panic');
        else document.documentElement.classList.remove('panic');
      }, { passive:true });

      window.addEventListener('groups:group_change', (ev)=>{
        const d = ev.detail || {};
        const label = d.label || '‡∏´‡∏°‡∏π‡πà ?';
        hud.group.textContent = label;

        // banner pop
        bannerText.textContent = label;
        banner.style.display = '';
        banner.classList.remove('pop');
        void banner.offsetWidth;
        banner.classList.add('pop');
        setTimeout(()=>{ try{ banner.style.display='none'; }catch(_){} }, 900);
      }, { passive:true });

      window.addEventListener('groups:power', (ev)=>{
        const d = ev.detail || {};
        const c = (d.charge|0), th = Math.max(1, (d.threshold|0));
        hud.powerText.textContent = c + '/' + th;
        const p = clamp(c / th, 0, 1);
        hud.powerFill.style.width = Math.round(p*100) + '%';
        hud.powerFill.classList.remove('pulse');
        void hud.powerFill.offsetWidth;
        hud.powerFill.classList.add('pulse');
      }, { passive:true });

      window.addEventListener('quest:update', (ev)=>{
        const d = ev.detail || {};
        const g = d.goal || null;
        const m = d.mini || null;

        if (g){
          hud.goalTitle.textContent = g.label || '‚Äî';
          hud.goalVal.textContent = (g.prog|0) + '/' + (g.target|0);
        }
        if (m){
          const tLeft = (typeof m.tLeft === 'number') ? (' ‚è±Ô∏è'+(m.tLeft|0)+'s') : '';
          hud.miniTitle.textContent = (m.label || '‚Äî') + tLeft;
          hud.miniVal.textContent = (m.prog|0) + '/' + (m.target|0);
        }
      }, { passive:true });

      window.addEventListener('hha:rank', (ev)=>{
        const d = ev.detail || {};
        if (d.grade) hud.grade.textContent = d.grade;
        if (typeof d.accuracy === 'number') hud.acc.textContent = (d.accuracy|0) + '%';
        if (typeof d.questsPct === 'number') hud.questsPct.textContent = (d.questsPct|0);
      }, { passive:true });

      window.addEventListener('groups:lock', (ev)=>{
        const d = ev.detail || {};
        if (!d.on){
          lockRing.style.display = 'none';
          return;
        }

        lockRing.style.display = '';
        lockRing.style.left = (d.x|0) + 'px';
        lockRing.style.top  = (d.y|0) + 'px';

        const p = clamp(d.prog || 0, 0, 1);
        const c = clamp(d.charge || 0, 0, 1);
        lockRing.style.setProperty('--p', String(p));
        lockRing.style.setProperty('--c', String(c));
      }, { passive:true });

      window.addEventListener('groups:stun', (ev)=>{
        const d = ev.detail || {};
        if (!d.on){
          stunOverlay.style.display = 'none';
          return;
        }
        stunOverlay.style.display = '';
        stunOverlay.classList.remove('pop');
        void stunOverlay.offsetWidth;
        stunOverlay.classList.add('pop');
        setTimeout(()=>{ try{ stunOverlay.style.display='none'; }catch(_){} }, Math.max(200, d.ms|0));
      }, { passive:true });

      // Optional: show overlay until user starts
    })();
  </script>

</body>
</html>