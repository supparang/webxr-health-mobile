<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‡πÉ‡∏ä‡πâ CSS groups-vr.css ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
  <link rel="stylesheet" href="./css/groups-vr.css" />
</head>
<body>

  <!-- ===== A-Frame Scene ===== -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    background="color: #020617">

    <!-- rig + camera + cursor -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="groups-camera"
                wasd-controls-enabled="false"
                look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  raycaster="objects: [data-hha-tgt]"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9">
        </a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô + ‡πÅ‡∏™‡∏á + sky -->
    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-plane position="0 0 0" rotation="-90 0 0" width="16" height="16"
             material="color: #020617; metalness: 0; roughness: 1"></a-plane>
    <a-sky color="#020617"></a-sky>

    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏°: component food-groups-game ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á -->
    <a-entity id="fg-root" food-groups-game></a-entity>
  </a-scene>

  <!-- ===== HUD (‡πÉ‡∏ä‡πâ groups-vr.css ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ===== -->
  <div class="hud-root">
    <div class="hud-top">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: title + score + miss -->
      <div class="hud-card" style="flex:1;max-width:380px;">
        <div class="hud-main">
          <div>
            <div class="hud-main-title">Hero Health ‚Ä¢ Nutrition VR</div>
            <div class="hud-main-mode">Food Groups VR</div>
          </div>
          <div class="hud-pill">
            <span id="hud-diff-label">NORMAL</span>
            <span>‚Ä¢</span>
            <span id="hud-time-label">60s</span>
          </div>
        </div>

        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="metric-value accent" id="hud-score">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">MISS</div>
            <div class="metric-value danger" id="hud-miss">0</div>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡∏ß‡∏≤: Goal + Mini quest ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ -->
      <div class="fg-quest-panel">
        <div class="fg-quest-title">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

        <div class="fg-quest-row">
          <span class="fg-quest-label">GOAL</span>
          <span class="fg-quest-main" id="hud-goal-main">
            ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤
          </span>
          <span class="fg-quest-progress" id="hud-goal-progress">
            0 / -
          </span>
        </div>

        <div class="fg-quest-row">
          <span class="fg-quest-label">MINI QUEST</span>
          <span class="fg-quest-main" id="hud-mini-main">
            ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
          </span>
          <span class="fg-quest-progress" id="hud-mini-progress">
            0 / -
          </span>
        </div>
      </div>
    </div>

    <!-- ‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á: ‡πÇ‡∏Ñ‡πâ‡∏ä -->
    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <span class="coach-avatar">ü•¶</span>
        <span class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
        <span id="coach-text">‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞!</span>
      </div>
    </div>
  </div>

  <!-- ‡∏ä‡∏±‡πâ‡∏ô DOM ‡πÄ‡∏õ‡πâ‡∏≤ emoji -->
  <div id="fg-layer"></div>

  <!-- Overlay ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
  <div class="result-overlay" id="fg-result">
    <div class="result-card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups VR</h2>
      <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <strong id="fg-res-score">0</strong></p>
      <p>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong id="fg-res-quest">0 / 2</strong></p>
      <p>Goal: <span id="fg-res-goal">-</span></p>
      <p>Mini quest: <span id="fg-res-mini">-</span></p>
      <hr />
      <button id="fg-btn-retry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button id="fg-btn-hub"
              style="margin-left:8px;background:linear-gradient(90deg,#38bdf8,#22c55e);">
        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Hub
      </button>
    </div>
  </div>

  <!-- ===== Fever + FX + ‡πÇ‡∏°‡∏î‡∏π‡∏• Groups ===== -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <script src="./vr-groups/emoji-image.js"></script>
  <script src="./vr-groups/difficulty.js"></script>
  <script src="./vr-groups/logger-cloud.js"></script>
  <!-- GameEngine: A-Frame component food-groups-game -->
  <script type="module" src="./vr-groups/GameEngine.js"></script>

  <!-- ===== Boot script: HUD + coach + touch-look ===== -->
  <script type="module">
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';

    (function () {
      function getParam(name, fallback) {
        const url = new URL(window.location.href);
        const v = url.searchParams.get(name);
        return v !== null && v !== '' ? v : fallback;
      }

      const diffParam = String(getParam('diff', 'normal')).toLowerCase();
      let   timeParam = parseInt(getParam('time', '60'), 10);
      if (isNaN(timeParam) || timeParam <= 0) timeParam = 60;
      if (timeParam < 20)  timeParam = 20;
      if (timeParam > 180) timeParam = 180;

      const elScore  = document.getElementById('hud-score');
      const elDiff   = document.getElementById('hud-diff-label');
      const elTime   = document.getElementById('hud-time-label');
      const elMiss   = document.getElementById('hud-miss');
      const elCoach  = document.getElementById('coach-bubble');
      const elCoachText = document.getElementById('coach-text');

      const resOverlay = document.getElementById('fg-result');
      const resScore   = document.getElementById('fg-res-score');
      const resQuest   = document.getElementById('fg-res-quest');
      const resGoal    = document.getElementById('fg-res-goal');
      const resMini    = document.getElementById('fg-res-mini');
      const btnRetry   = document.getElementById('fg-btn-retry');
      const btnHub     = document.getElementById('fg-btn-hub');

      elDiff.textContent = diffParam.toUpperCase();
      elTime.textContent = timeParam + 's';
      elScore.textContent = '0';
      elMiss.textContent  = '0';

      function setCoach(text) {
        if (!text) return;
        elCoachText.textContent = text;
        elCoach.classList.add('show');
      }

      setCoach('‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞ ü•¶üçö');

      const scene = document.querySelector('a-scene');

      // event ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏à‡∏≤‡∏Å GameEngine (food-groups-game)
      scene.addEventListener('fg-game-over', function (e) {
        const d = e.detail || {};
        resScore.textContent = d.score != null ? d.score : 0;

        if (d.questsCleared != null) {
          const total = d.questsTotal != null ? d.questsTotal : 2;
          resQuest.textContent = d.questsCleared + ' / ' + total;
        } else {
          resQuest.textContent = '- / -';
        }

        resGoal.textContent = d.goal || '-';
        resMini.textContent = d.miniQuest || '-';

        resOverlay.classList.add('show');
      });

      // ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏Å GameEngine (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å coachSay ‚Üí fg-coach)
      window.addEventListener('fg-coach', function (e) {
        const msg = e.detail && e.detail.text;
        if (msg) setCoach(msg);
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
      if (btnRetry) {
        btnRetry.addEventListener('click', function () {
          const url = new URL(window.location.href);
          url.searchParams.set('diff', diffParam);
          url.searchParams.set('time', String(timeParam));
          window.location.href = url.toString();
        });
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö Hub
      if (btnHub) {
        btnHub.addEventListener('click', function () {
          window.location.href = './hub.html';
        });
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ scene ‡πÇ‡∏´‡∏•‡∏î
      scene.addEventListener('loaded', function () {
        console.log('[GroupsVR] scene loaded ‚Üí emit fg-start');
        scene.emit('fg-start', { diff: diffParam, duration: timeParam });

        // ‡∏ú‡∏π‡∏Å touch-look ‡πÅ‡∏ö‡∏ö goodjunk
        const cam =
          (scene.camera && scene.camera.el) ||
          scene.querySelector('a-camera');
        if (cam) {
          attachTouchLook(cam, {
            areaEl: document.body,
            sensitivity: 0.25
          });
          console.log('[GroupsVR] touch-look attached');
        }
      });
    })();
  </script>
</body>
</html>
