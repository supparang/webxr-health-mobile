<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
  <link rel="stylesheet" href="./css/groups-vr.css" />
</head>
<body>
  <!-- ===== A-Frame Scene ===== -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true"
    background="color: #020617"
  >
    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á + cursor ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤ -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera wasd-controls-enabled="false">
        <a-entity
          id="cursor"
          cursor="fuse: false; rayOrigin: mouse"
          raycaster="objects: [data-hha-tgt]"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
          material="shader: flat; color: #ffffff"
          position="0 0 -0.9"
        ></a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡πÅ‡∏™‡∏á + ‡∏û‡∏∑‡πâ‡∏ô -->
    <a-entity
      light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"
    ></a-entity>
    <a-entity
      light="type: directional; intensity: 0.7"
      position="1 2 0.5"
    ></a-entity>
    <a-plane
      position="0 0 0"
      rotation="-90 0 0"
      width="16"
      height="16"
      material="color: #020617;"
    ></a-plane>

    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏° -->
    <a-entity id="fg-root" food-groups-game></a-entity>
  </a-scene>

  <!-- ===== HUD ===== -->
  <div class="hud-root">
    <!-- ‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô: ‡πÇ‡∏´‡∏°‡∏î + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
    <div class="hud-card hud-score">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
        "
      >
        <div>
          <div class="hud-main-title">Hero Health ‚Ä¢ Nutrition VR</div>
          <div class="hud-main-mode">Food Groups</div>
        </div>
        <div class="hud-pill">
          <span id="hud-diff-label">NORMAL</span>
          <span>‚Ä¢</span>
          <span id="hud-time-label">60s</span>
        </div>
      </div>
      <div class="hud-metrics">
        <div class="metric">
          <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          <div class="metric-value accent" id="hud-score">0</div>
        </div>
      </div>
    </div>

    <!-- ‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô: Goal + Mini quest -->
    <div class="hud-card hud-goal">
      <div class="goal-title">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

      <div class="goal-row">
        <span class="goal-label">GOAL</span>
        <span class="goal-value" id="hud-goal-progress">
          0 / 150
        </span>
      </div>

      <div class="goal-row">
        <span class="goal-label">MINI QUEST</span>
        <span class="goal-value" id="hud-mini-progress">
          0 / 12
        </span>
      </div>
    </div>

    <!-- ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏û‡∏π‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á) -->
    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <span class="coach-avatar">ü•¶</span>
        <span class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
        <span id="coach-text">‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞!</span>
      </div>
    </div>
  </div>

  <!-- End summary -->
  <div class="end-toast" id="end-toast">
    <div class="end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups VR</div>
    <div class="end-row">
      <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span><strong id="end-score">0</strong>
    </div>
    <div class="end-row">
      <span>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span><strong id="end-quest">0 / -</strong>
    </div>
    <div class="end-row">
      <span>Goal</span><span id="end-goal-text">-</span>
    </div>
    <div class="end-row">
      <span>Mini quest</span><span id="end-mini-text">-</span>
    </div>
  </div>

  <!-- ===== ‡πÄ‡∏Å‡∏° + ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á ‡πÜ ===== -->
  <!-- Fever bar (non-module) -->
  <script src="./vr/ui-fever.js"></script>

  <script src="./vr-groups/emoji-image.js"></script>
  <script src="./vr-groups/difficulty.js"></script>
  <script src="./vr-groups/logger-cloud.js"></script>
  <script src="./vr-groups/GameEngine.js"></script>

  <script>
    (function () {
      function getParam(name, fallback) {
        const url = new URL(window.location.href);
        const v = url.searchParams.get(name);
        return v !== null && v !== "" ? v : fallback;
      }

      const diff = String(getParam("diff", "normal")).toLowerCase();

      const elScore     = document.getElementById("hud-score");
      const elDiff      = document.getElementById("hud-diff-label");
      const elTime      = document.getElementById("hud-time-label");
      const elCoach     = document.getElementById("coach-bubble");
      const elCoachText = document.getElementById("coach-text");
      const elEndToast  = document.getElementById("end-toast");
      const elEndScore  = document.getElementById("end-score");
      const elEndQuest  = document.getElementById("end-quest");
      const elEndGoal   = document.getElementById("end-goal-text");
      const elEndMini   = document.getElementById("end-mini-text");

      elDiff.textContent  = diff.toUpperCase();
      elTime.textContent  = "60s";
      elScore.textContent = "0";

      // Cloud logger
      if (window.GAME_MODULES && GAME_MODULES.foodGroupsCloudLogger) {
        GAME_MODULES.foodGroupsCloudLogger.init({
          endpoint:
            "https://script.google.com/macros/s/AKfycbywOHz1nHrybbLwuVCWHW1XyJLoNio2BF5ugchDk0q0qfcgZ2z7ZSIYGQuxguyTDBU/exec",
          projectTag: "HeroHealth-GroupsVR",
          debug: false
        });
      }

      function setCoach(text) {
        if (!text) return;
        elCoachText.textContent = text;
        elCoach.classList.add("show");
      }
      setCoach("‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏∞!");

      const scene = document.querySelector("a-scene");

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏£‡∏±‡∏ö event ‡∏à‡∏≤‡∏Å GameEngine)
      scene.addEventListener("fg-game-over", function (e) {
        const d = e.detail || {};
        elEndScore.textContent = d.score != null ? d.score : 0;

        if (d.questsCleared != null) {
          const total = d.questsTotal != null ? d.questsTotal : "-";
          elEndQuest.textContent = d.questsCleared + " / " + total;
        } else {
          elEndQuest.textContent = "- / -";
        }

        if (d.goal)      elEndGoal.textContent = d.goal;
        if (d.miniQuest) elEndMini.textContent = d.miniQuest;

        elEndToast.classList.add("show");
      });

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ scene ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
      scene.addEventListener("loaded", function () {
        console.log("[GroupsVR] scene loaded ‚Üí emit fg-start");
        scene.emit("fg-start", { diff: diff });
      });
    })();
  </script>
</body>
</html>
