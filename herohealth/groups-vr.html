<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --junk:#ef4444;
      --gold:#fbbf24;
    }
    html,body{ height:100%; background:var(--bg); color:var(--text); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
    *{ box-sizing:border-box; }
    a-scene{ position:fixed; inset:0; z-index:0; }

    /* ===== HUD ===== */
    .hud{
      position:fixed; inset:0; z-index:6;
      pointer-events:none;
    }
    .topbar{
      position:absolute; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:stretch; justify-content:space-between;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 18px 55px rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .scorebox{ display:flex; gap:12px; align-items:center; min-width:260px; }
    .k{ font-size:12px; color:var(--muted); }
    .v{ font-size:18px; font-weight:800; letter-spacing:.3px; }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      min-width:210px;
    }
    .big{ font-size:14px; font-weight:800; }
    .small{ font-size:12px; color:var(--muted); margin-top:2px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .dot{
      width:10px; height:10px; border-radius:99px;
      background:var(--muted);
      box-shadow:0 0 0 3px rgba(255,255,255,.04);
    }

    /* Fever bar (IIFE UI) ‡∏à‡∏∞‡∏ß‡∏≤‡∏á‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á */
    .feverwrap{
      min-width:240px;
      display:flex; flex-direction:column; gap:6px;
    }

    /* Quest box */
    .quest{
      position:absolute; left:12px; right:12px; bottom:14px;
      display:flex; gap:10px; justify-content:space-between; align-items:stretch;
    }
    .quest .card{ flex:1; }
    .questTitle{ font-size:12px; color:var(--muted); }
    .questMain{ margin-top:6px; font-size:14px; font-weight:800; }
    .questSub{ margin-top:6px; font-size:12px; color:var(--muted); }
    .progline{
      margin-top:8px;
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .progfill{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.9), rgba(59,130,246,.9));
      transition:width .18s ease;
    }

    /* Coach bubble */
    .coach{
      min-width:260px;
      max-width:360px;
    }
    .coachText{ font-size:13px; line-height:1.35; }

    /* ===== Start overlay ===== */
    .overlay{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      background:radial-gradient(1200px 700px at 50% 35%, rgba(99,102,241,.18), transparent 60%),
                 radial-gradient(900px 600px at 30% 90%, rgba(34,197,94,.14), transparent 60%),
                 rgba(2,6,23,.82);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .panel{
      width:min(720px, 92vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.86);
      box-shadow:0 28px 80px rgba(0,0,0,.55);
      padding:18px 18px 16px;
    }
    .title{ font-size:20px; font-weight:900; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:6px; line-height:1.35; }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .btn{
      pointer-events:auto;
      user-select:none;
      cursor:pointer;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.75);
      padding:12px 12px;
      color:var(--text);
      font-weight:900;
      display:flex; align-items:center; justify-content:center;
      transition: transform .10s ease, background .15s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background:rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.34);
    }
    .btn.warn{
      background:rgba(251,191,36,.14);
      border-color: rgba(251,191,36,.34);
    }

    .minirow{
      margin-top:12px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      flex-wrap:wrap;
    }
    .tag{
      border:1px solid rgba(148,163,184,.2);
      background:rgba(15,23,42,.55);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== Targets layer ===== */
    #fg-layer{
      position:fixed;
      inset:0;
      z-index:5;
      pointer-events:auto;
      touch-action: manipulation;
    }
    .fg-target{
      position:absolute;
      left:0; top:0;
      transform: translate3d(var(--x, 50vw), var(--y, 52vh), 0) translate(-50%,-50%) scale(var(--s,1));
      width:132px; height:132px;
      border-radius:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      line-height:1;
      user-select:none;
      -webkit-user-select:none;
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", system-ui;
      background:rgba(15,23,42,.62);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
      opacity:0;
      transition: opacity .12s ease, transform .12s ease, filter .12s ease;
    }
    .fg-target.show{ opacity:1; }
    .fg-target.spawn{ filter:saturate(1.05) brightness(1.02); }
    .fg-target.hit{ opacity:.0; transform: translate3d(var(--x), var(--y), 0) translate(-50%,-50%) scale(.85); }
    .fg-target.out{ opacity:.0; transform: translate3d(var(--x), var(--y), 0) translate(-50%,-50%) scale(.92); }
    .fg-good{
      border-color: rgba(34,197,94,.28);
      box-shadow: 0 22px 60px rgba(0,0,0,.45), 0 0 0 6px rgba(34,197,94,.10), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .fg-junk{
      border-color: rgba(239,68,68,.30);
      box-shadow: 0 22px 60px rgba(0,0,0,.45), 0 0 0 6px rgba(239,68,68,.10), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .fg-boss{
      border-radius:26px;
      filter: saturate(1.08) contrast(1.02);
    }

    /* GOLD */
    .fg-target.fg-gold{
      border-color: rgba(251,191,36,.42);
      box-shadow:
        0 22px 60px rgba(0,0,0,.50),
        0 0 0 7px rgba(251,191,36,.14),
        inset 0 0 0 2px rgba(255,255,255,.06);
      filter: saturate(1.10) brightness(1.03);
    }

    /* Decoy subtle */
    .fg-decoy{
      filter: saturate(0.92) brightness(0.98);
    }

    /* Boss bar */
    .bossbar{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      height:10px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg, rgba(239,68,68,.95), rgba(251,191,36,.9));
      transition: width .12s ease;
    }

    /* Afterimage */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      opacity:.0;
      animation: ai .42s ease forwards;
      z-index:4;
    }
    .fg-afterimage-inner{
      font-size:56px;
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", system-ui;
      filter: blur(.2px);
    }
    @keyframes ai{
      0%{ opacity:.0; transform: translate3d(var(--x),var(--y),0) translate(-50%,-50%) scale(.9); }
      18%{ opacity:.55; }
      100%{ opacity:0; transform: translate3d(var(--x),var(--y),0) translate(-50%,-50%) scale(1.18); }
    }

    /* Lock/Charge reticle */
    .reticle{
      position:fixed; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:52px; height:52px;
      border-radius:99px;
      border:2px solid rgba(255,255,255,.24);
      box-shadow:0 0 0 10px rgba(255,255,255,.05);
      z-index:7;
      pointer-events:none;
      opacity:.75;
    }
    .reticle.ok{ border-color: rgba(34,197,94,.45); box-shadow:0 0 0 12px rgba(34,197,94,.10); }
    .reticle.miss{ border-color: rgba(239,68,68,.55); box-shadow:0 0 0 12px rgba(239,68,68,.12); animation: shake .18s linear 2; }
    .reticle.perfect{ border-color: rgba(251,191,36,.65); box-shadow:0 0 0 14px rgba(251,191,36,.14); }

    @keyframes shake{
      0%{ transform: translate(-50%,-50%) rotate(0deg); }
      25%{ transform: translate(calc(-50% + 3px), calc(-50% - 2px)) rotate(-2deg); }
      50%{ transform: translate(calc(-50% - 3px), calc(-50% + 2px)) rotate(2deg); }
      100%{ transform: translate(-50%,-50%) rotate(0deg); }
    }

    .lockring{
      position:fixed;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:120px; height:120px;
      border-radius:999px;
      border:2px solid rgba(59,130,246,.22);
      box-shadow:0 0 0 12px rgba(59,130,246,.08);
      z-index:7;
      pointer-events:none;
      opacity:0;
      transition: opacity .08s ease;
    }
    .lockring.on{ opacity:1; }
    .lockring .fill{
      position:absolute; inset:0;
      border-radius:999px;
      background: conic-gradient(rgba(59,130,246,.85) calc(var(--p,0)*1turn), rgba(255,255,255,0) 0);
      mask: radial-gradient(circle at center, transparent 58%, #000 60%);
      -webkit-mask: radial-gradient(circle at center, transparent 58%, #000 60%);
      opacity:.85;
    }
    .lockring .charge{
      position:absolute; inset:10px;
      border-radius:999px;
      background: conic-gradient(rgba(251,191,36,.92) calc(var(--c,0)*1turn), rgba(255,255,255,0) 0);
      mask: radial-gradient(circle at center, transparent 58%, #000 60%);
      -webkit-mask: radial-gradient(circle at center, transparent 58%, #000 60%);
      opacity:.85;
      filter: drop-shadow(0 0 10px rgba(251,191,36,.22));
    }

    /* End overlay */
    .end{
      position:fixed; inset:0; z-index:12;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .end.show{ display:flex; }
    .end .panel{ width:min(720px,92vw); }
    .endgrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .stat{ background:rgba(15,23,42,.6); border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:12px; }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:22px; font-weight:900; margin-top:6px; }
    .end .actions{ margin-top:12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  </style>

  <!-- Global FX + Logger + Fever UI + HUD Binder -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- Groups Quest + Engine -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
</head>

<body>
  <!-- A-Frame scene (‡πÉ‡∏ä‡πâ rotation ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ worldToScreen) -->
  <a-scene embedded vr-mode-ui="enabled: true">
    <a-entity id="fg-cam" camera look-controls="enabled:true" position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- Targets -->
  <div id="fg-layer"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="topbar">
      <div class="card scorebox">
        <div>
          <div class="k">SCORE</div>
          <div class="v" id="hud-score">0</div>
        </div>
        <div>
          <div class="k">COMBO</div>
          <div class="v" id="hud-combo">0</div>
        </div>
        <div>
          <div class="k">MISS</div>
          <div class="v" id="hud-miss">0</div>
        </div>
        <div>
          <div class="k">SHIELD</div>
          <div class="v" id="hud-shield">0</div>
        </div>
      </div>

      <div class="card pill feverwrap">
        <div class="row">
          <span class="dot" id="dot-mode"></span>
          <div>
            <div class="big" id="hud-group">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‚Äî</div>
            <div class="small">
              ‡πÄ‡∏ß‡∏•‡∏≤: <span id="hud-time">0</span>s ‚Ä¢ ‡πÄ‡∏Å‡∏£‡∏î: <span id="hud-grade">C</span>
              ‚Ä¢ <span id="hud-storm" style="display:none;">üå™Ô∏è STORM</span>
            </div>
          </div>
        </div>
        <!-- FeverUI ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á bar ‡πÄ‡∏≠‡∏á (safeTop/bottom ‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö) -->
      </div>

      <div class="card coach">
        <div class="k">COACH</div>
        <div class="coachText" id="hud-coach">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏•‡∏∏‡∏¢! ‚ú®</div>
      </div>
    </div>

    <div class="quest">
      <div class="card">
        <div class="questTitle">GOAL</div>
        <div class="questMain" id="quest-goal">‚Äî</div>
        <div class="questSub" id="quest-goal-sub">0 / 0</div>
        <div class="progline"><div class="progfill" id="quest-goal-fill"></div></div>
      </div>
      <div class="card">
        <div class="questTitle">MINI</div>
        <div class="questMain" id="quest-mini">‚Äî</div>
        <div class="questSub" id="quest-mini-sub">0 / 0</div>
        <div class="progline"><div class="progfill" id="quest-mini-fill"></div></div>
      </div>
    </div>

    <div class="reticle" id="reticle"></div>

    <div class="lockring" id="lockring">
      <div class="fill"></div>
      <div class="charge"></div>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <div class="title">Food Groups VR üçΩÔ∏è ‚Äî ‡∏•‡πà‡∏≤‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å!</div>
      <div class="sub">
        ‚Ä¢ ‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà ‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏î‡∏ô‡∏Ç‡∏¢‡∏∞ ‚Ä¢ ‡∏°‡∏µ <b>GOLD ‚ú®</b> ‡πÅ‡∏•‡∏∞ <b>STORM üå™Ô∏è</b> ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô
      </div>

      <div class="minirow">
        <div class="tag" id="tag-diff">diff: normal</div>
        <div class="tag" id="tag-time">time: 60s</div>
        <div class="tag" id="tag-run">run: play</div>
      </div>

      <div class="grid">
        <div class="btn primary" id="btnStart">START ‚ñ∂Ô∏è</div>
        <div class="btn warn" id="btnStartResearch">RESEARCH üß™</div>
        <div class="btn" id="btnToggleGaze">GAZE: ON üëÅÔ∏è</div>
      </div>

      <div class="sub" style="margin-top:12px;">
        Tip: ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÑ‡∏ß‡πâ‚Äî‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ lock + ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î / ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ üî•
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div class="end" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</div>
      <div class="sub" id="endReason">‚Äî</div>

      <div class="endgrid">
        <div class="stat"><div class="k">GRADE</div><div class="v" id="endGrade">C</div></div>
        <div class="stat"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">COMBO MAX</div><div class="v" id="endCombo">0</div></div>
      </div>

      <div class="endgrid" style="grid-template-columns:1fr 1fr;">
        <div class="stat"><div class="k">GOALS</div><div class="v" id="endGoals">0/0</div></div>
        <div class="stat"><div class="k">MINIS</div><div class="v" id="endMinis">0/0</div></div>
      </div>

      <div class="actions">
        <div class="btn primary" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üîÅ</div>
        <div class="btn" id="btnCloseEnd">‡∏õ‡∏¥‡∏î</div>
      </div>
    </div>
  </div>

  <!-- Boot -->
  <script>
    (function(){
      'use strict';

      function qs(sel){ return document.querySelector(sel); }
      function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

      const sp = new URLSearchParams(location.search);
      const diff = (sp.get('diff')||'normal').toLowerCase();
      const time = clamp(sp.get('time')||60, 10, 600);
      const run  = (sp.get('run')||'play').toLowerCase();

      const startOverlay = qs('#startOverlay');
      const endOverlay   = qs('#endOverlay');

      qs('#tag-diff').textContent = 'diff: ' + diff;
      qs('#tag-time').textContent = 'time: ' + time + 's';
      qs('#tag-run').textContent  = 'run: ' + run;

      const layer = qs('#fg-layer');
      const cam   = qs('#fg-cam');

      let gazeOn = true;

      function setDot(){
        const d = qs('#dot-mode');
        if (!d) return;
        d.style.background = (run === 'research') ? 'rgba(251,191,36,.9)' : 'rgba(34,197,94,.9)';
      }
      setDot();

      function startGame(mode){
        const engine = window.GroupsVR && window.GroupsVR.GameEngine;
        if (!engine) { console.error('GameEngine missing'); return; }

        engine.setLayerEl(layer);
        engine.setCameraEl(cam);
        engine.setTimeLeft(time);
        engine.setGaze(gazeOn);

        const runMode = (mode === 'research') ? 'research' : 'play';
        engine.start(diff, { layerEl: layer, runMode });

        startOverlay.style.display = 'none';
      }

      // UI buttons
      qs('#btnStart').addEventListener('click', ()=> startGame('play'));
      qs('#btnStartResearch').addEventListener('click', ()=> startGame('research'));
      qs('#btnToggleGaze').addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        qs('#btnToggleGaze').textContent = 'GAZE: ' + (gazeOn ? 'ON üëÅÔ∏è' : 'OFF üôà');
        try{
          const engine = window.GroupsVR && window.GroupsVR.GameEngine;
          engine && engine.setGaze && engine.setGaze(gazeOn);
        }catch{}
      });

      // HUD listeners (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô ‚Äú‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‚Äù)
      window.addEventListener('hha:score', (e)=>{
        const d = (e && e.detail) || {};
        if (qs('#hud-score')) qs('#hud-score').textContent = String(d.score ?? 0);
        if (qs('#hud-combo')) qs('#hud-combo').textContent = String(d.combo ?? 0);
        if (qs('#hud-miss'))  qs('#hud-miss').textContent  = String(d.misses ?? 0);
        if (qs('#hud-shield'))qs('#hud-shield').textContent= String(d.shield ?? 0);
      });

      window.addEventListener('hha:time', (e)=>{
        const d = (e && e.detail) || {};
        if (qs('#hud-time')) qs('#hud-time').textContent = String(d.left ?? 0);
      });

      window.addEventListener('hha:coach', (e)=>{
        const d = (e && e.detail) || {};
        if (qs('#hud-coach')) qs('#hud-coach').textContent = String(d.text || '');
      });

      window.addEventListener('quest:update', (e)=>{
        const d = (e && e.detail) || {};
        if (qs('#hud-group')) qs('#hud-group').textContent = d.groupLabel ? ('‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + d.groupLabel) : '‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‚Äî';

        // goal
        const g = d.goal;
        if (qs('#quest-goal')) qs('#quest-goal').textContent = g ? g.label : '‚Äî';
        if (qs('#quest-goal-sub')) qs('#quest-goal-sub').textContent = g ? ((g.prog||0) + ' / ' + (g.target||0)) : '0 / 0';
        if (qs('#quest-goal-fill')){
          const pct = g && g.target ? Math.max(0, Math.min(1, (g.prog||0)/(g.target||1))) : 0;
          qs('#quest-goal-fill').style.width = Math.round(pct*100) + '%';
        }

        // mini
        const m = d.mini;
        if (qs('#quest-mini')) qs('#quest-mini').textContent = m ? m.label : '‚Äî';
        let miniSub = '0 / 0';
        if (m){
          miniSub = (m.prog||0) + ' / ' + (m.target||0);
          if (typeof m.tLeft === 'number') miniSub += ' ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + m.tLeft + 's';
        }
        if (qs('#quest-mini-sub')) qs('#quest-mini-sub').textContent = miniSub;
        if (qs('#quest-mini-fill')){
          const pct2 = m && m.target ? Math.max(0, Math.min(1, (m.prog||0)/(m.target||1))) : 0;
          qs('#quest-mini-fill').style.width = Math.round(pct2*100) + '%';
        }
      });

      window.addEventListener('hha:rank', (e)=>{
        const d = (e && e.detail) || {};
        if (qs('#hud-grade')) qs('#hud-grade').textContent = String(d.grade || 'C');
      });

      // reticle state
      window.addEventListener('groups:reticle', (e)=>{
        const d = (e && e.detail) || {};
        const r = qs('#reticle');
        if (!r) return;
        r.classList.remove('ok','miss','perfect');
        if (d.state) r.classList.add(String(d.state));
      });

      // lock ring state
      window.addEventListener('groups:lock', (e)=>{
        const d = (e && e.detail) || {};
        const ring = qs('#lockring');
        if (!ring) return;

        if (!d.on){
          ring.classList.remove('on');
          ring.style.setProperty('--p', 0);
          ring.style.setProperty('--c', 0);
          return;
        }

        ring.classList.add('on');
        ring.style.setProperty('--p', Number(d.prog||0));
        ring.style.setProperty('--c', Number(d.charge||0));
      });

      // storm indicator
      window.addEventListener('groups:storm', (e)=>{
        const d = (e && e.detail) || {};
        const s = qs('#hud-storm');
        if (!s) return;
        s.style.display = d.on ? 'inline' : 'none';
      });

      // end summary
      window.addEventListener('hha:end', (e)=>{
        const d = (e && e.detail) || {};
        qs('#endReason').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'stop');
        qs('#endGrade').textContent  = String(d.grade || 'C');
        qs('#endScore').textContent  = String(d.scoreFinal ?? 0);
        qs('#endCombo').textContent  = String(d.comboMax ?? 0);
        qs('#endGoals').textContent  = String(d.goalsCleared ?? 0) + '/' + String(d.goalsTotal ?? 0);
        qs('#endMinis').textContent  = String(d.miniCleared ?? 0) + '/' + String(d.miniTotal ?? 0);
        endOverlay.classList.add('show');
      });

      qs('#btnReplay').addEventListener('click', ()=>{
        try{
          endOverlay.classList.remove('show');
          startOverlay.style.display = 'flex';
          const engine = window.GroupsVR && window.GroupsVR.GameEngine;
          engine && engine.stop && engine.stop('replay');
        }catch{}
      });

      qs('#btnCloseEnd').addEventListener('click', ()=>{
        endOverlay.classList.remove('show');
      });

      // Auto start by URL
      if (run === 'play'){
        // ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô overlay ‡πÅ‡∏ß‡πâ‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ start
        setTimeout(()=> startGame('play'), 120);
      } else if (run === 'research'){
        setTimeout(()=> startGame('research'), 120);
      }
    })();
  </script>
</body>
</html>