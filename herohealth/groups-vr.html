<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî FULL HTML (LATEST)
‚úÖ ‡πÉ‡∏ä‡πâ CSS alias: /vr-groups/groups.css -> @import groups-vr.css
‚úÖ Quest+Mini ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡πà: ‡∏°‡∏µ HUD ‡∏ö‡∏ô + ‡∏°‡∏µ fallback panel (groups-hud-quest.js)
‚úÖ Power HUD + Group swap banner + Stun overlay + Lock ring
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: run=play/research, diff=easy/normal/hard, time=90, seed=...
‚úÖ Load order ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á: quests -> hud quest binder -> engine
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + Fever + Global HUD (IIFE) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- ‚úÖ IMPORTANT: CSS alias (backward compatible) -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />
</head>

<body>

  <!-- ===== A-Frame Scene ===== -->
  <a-scene
    embedded
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true;"
    background="color: #020617">

    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="hhaCam" camera look-controls="pointerLockEnabled: false"></a-entity>
    </a-entity>

    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- ===== Gameplay DOM Layer ===== -->
  <div id="fg-layer" class="fg-layer" aria-label="FoodGroups Targets Layer"></div>

  <!-- ===== Top HUD ===== -->
  <div class="hud-top">
    <div class="hud-card hud-left">
      <div class="hud-row">
        <div class="hud-title">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div id="hudScore" class="hud-val">0</div>
      </div>
      <div class="hud-row">
        <div class="hud-title">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
        <div id="hudCombo" class="hud-val">0</div>
      </div>
      <div class="hud-row">
        <div class="hud-title">‡∏û‡∏•‡∏≤‡∏î</div>
        <div id="hudMiss" class="hud-val">0</div>
      </div>
    </div>

    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div id="hudGroup" class="hud-group">‡∏´‡∏°‡∏π‡πà ?</div>
        <div id="hudTimer" class="hud-timer">90s</div>
      </div>

      <!-- ‚úÖ Power HUD -->
      <div class="power-wrap">
        <div class="power-label">
          <span id="hudPowerName">POWER</span>
          <span id="hudPowerNum">0/6</span>
        </div>
        <div class="power-bar">
          <div id="hudPowerFill" class="power-fill" style="width:0%"></div>
        </div>
      </div>

      <!-- ‚úÖ Quest HUD (TOP) -->
      <div class="quest-wrap">
        <div class="quest-line">
          <div class="q-badge">GOAL</div>
          <div id="hudGoal" class="q-text">‚Äî</div>
          <div id="hudGoalNum" class="q-num">0/0</div>
        </div>
        <div class="quest-line">
          <div class="q-badge mini">MINI</div>
          <div id="hudMini" class="q-text">‚Äî</div>
          <div id="hudMiniNum" class="q-num">0/0</div>
        </div>
      </div>
    </div>

    <div class="hud-card hud-right">
      <div class="rank-box">
        <div class="rank-title">GRADE</div>
        <div id="hudGrade" class="rank-grade">C</div>
      </div>
      <div class="rank-sub">
        <div><span id="hudAcc">0</span>% ACC</div>
        <div><span id="hudQp">0</span>% Q</div>
      </div>
    </div>
  </div>

  <!-- ===== Center Lock Ring ===== -->
  <div id="lockRing" class="lock-ring" style="display:none">
    <div class="lock-core"></div>
    <div class="lock-prog"></div>
    <div class="lock-charge"></div>
  </div>

  <!-- ===== Group Swap Banner ===== -->
  <div id="groupBanner" class="group-banner" style="display:none">
    <div id="groupBannerText" class="group-banner-text">‡∏´‡∏°‡∏π‡πà ?</div>
    <div class="group-banner-sub">‡∏¢‡∏¥‡∏á‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà = ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏Å‡∏¥‡∏• ‚ö°</div>
  </div>

  <!-- ===== Stun Overlay ===== -->
  <div id="stunOverlay" class="stun-overlay" style="display:none">
    <div class="stun-card">
      <div class="stun-title">STUN!</div>
      <div class="stun-sub">‡∏û‡∏±‡∏Å 0.8 ‡∏ß‡∏¥ üòµ</div>
    </div>
  </div>

  <!-- ===== Start Overlay ===== -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR</div>
      <div class="start-sub">
        ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (tap hit) <br/>
        ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏¢‡∏¥‡∏á‡πÄ‡∏≠‡∏á‚Äù (lock ring) <br/>
        ‡∏¢‡∏¥‡∏á‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‚Üí ‡∏ä‡∏≤‡∏£‡πå‡∏à POWER ‚ö° (‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏π‡πà)
      </div>

      <div class="start-grid">
        <div class="pill"><b>School</b> Mode</div>
        <div class="pill">SSS / SS / S / A / B / C</div>
        <div class="pill"><span id="pillDiff">diff</span></div>
        <div class="pill"><span id="pillMode">mode</span></div>
      </div>

      <div class="start-actions">
        <button id="btnStart" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnRestart" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        <button id="btnExit" class="btn ghost">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="start-note">
        * ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (run=research) ‡∏à‡∏∞ fix seed ‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°/‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
      </div>
    </div>
  </div>

  <!-- =======================================================
       ‚úÖ Script Load Order (‡∏Å‡∏±‡∏ô quest/update ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
       1) groups-quests.js (‡∏™‡∏£‡πâ‡∏≤‡∏á GroupsVR.createGroupsQuest)
       2) groups-hud-quest.js (‡∏ü‡∏±‡∏á quest:update + fallback panel)
       3) GameEngine.js (GroupsVR.GameEngine ‡πÉ‡∏ä‡πâ quest factory)
     ======================================================= -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/groups-hud-quest.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>

  <!-- ===== Page binder ===== -->
  <script>
  (function(){
    'use strict';

    const $ = (id)=>document.getElementById(id);

    const layerEl = $('fg-layer');
    const camEl = document.querySelector('#hhaCam');

    const hudScore = $('hudScore');
    const hudCombo = $('hudCombo');
    const hudMiss  = $('hudMiss');
    const hudTimer = $('hudTimer');
    const hudGroup = $('hudGroup');

    const hudGoal = $('hudGoal');
    const hudMini = $('hudMini');
    const hudGoalNum = $('hudGoalNum');
    const hudMiniNum = $('hudMiniNum');

    const hudPowerName = $('hudPowerName');
    const hudPowerNum  = $('hudPowerNum');
    const hudPowerFill = $('hudPowerFill');

    const hudGrade = $('hudGrade');
    const hudAcc = $('hudAcc');
    const hudQp  = $('hudQp');

    const lockRing = $('lockRing');
    const groupBanner = $('groupBanner');
    const groupBannerText = $('groupBannerText');
    const stunOverlay = $('stunOverlay');

    const startOverlay = $('startOverlay');
    const btnStart = $('btnStart');
    const btnRestart = $('btnRestart');
    const btnExit = $('btnExit');

    const pillDiff = $('pillDiff');
    const pillMode = $('pillMode');

    function sp(){
      try { return new URLSearchParams(location.search); }
      catch { return new URLSearchParams(); }
    }
    function getParam(name, def){
      const v = sp().get(name);
      return (v == null || v === '') ? def : v;
    }
    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

    const diff = String(getParam('diff','normal')).toLowerCase();
    const timeSec = Math.max(10, parseInt(getParam('time','90'),10)||90);
    const run = String(getParam('run','play')).toLowerCase();
    const seed = String(getParam('seed','')||'');

    pillDiff.textContent = 'diff=' + diff;
    pillMode.textContent = 'run=' + run;

    // ===== UI Helpers =====
    function flashBanner(text){
      if (!groupBanner || !groupBannerText) return;
      groupBannerText.textContent = String(text||'');
      groupBanner.style.display = '';
      groupBanner.classList.remove('pop');
      void groupBanner.offsetWidth;
      groupBanner.classList.add('pop');
      setTimeout(()=>{ try{ groupBanner.style.display='none'; }catch{} }, 1100);
    }

    function showStun(ms){
      if (!stunOverlay) return;
      stunOverlay.style.display = '';
      stunOverlay.classList.remove('pop');
      void stunOverlay.offsetWidth;
      stunOverlay.classList.add('pop');
      setTimeout(()=>{ try{ stunOverlay.style.display='none'; }catch{} }, Math.max(520, ms|0));
    }

    function showLock(on, x, y, prog, charge){
      if (!lockRing) return;
      if (!on){
        lockRing.style.display = 'none';
        return;
      }
      const w = window.innerWidth || 360;
      const h = window.innerHeight || 640;
      const px = clamp(x, 0, w);
      const py = clamp(y, 0, h);

      lockRing.style.display = '';
      lockRing.style.transform =
        `translate3d(${Math.round(px)}px,${Math.round(py)}px,0) translate(-50%,-50%)`;

      lockRing.style.setProperty('--p', String(clamp(prog,0,1)));
      lockRing.style.setProperty('--c', String(clamp(charge,0,1)));
    }

    // ===== Bind Events =====
    window.addEventListener('hha:score', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      if (hudScore) hudScore.textContent = String(d.score ?? 0);
      if (hudCombo) hudCombo.textContent = String(d.combo ?? 0);
      if (hudMiss)  hudMiss.textContent  = String(d.misses ?? 0);
    }, { passive:true });

    window.addEventListener('hha:time', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const left = Math.max(0, d.left|0);
      if (hudTimer) hudTimer.textContent = left + 's';
      if (left <= 10) document.documentElement.classList.add('panic');
      else document.documentElement.classList.remove('panic');
    }, { passive:true });

    window.addEventListener('quest:update', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const gLabel = d.groupLabel || '';
      if (hudGroup) hudGroup.textContent = gLabel ? gLabel : '‡∏´‡∏°‡∏π‡πà ?';

      if (!d.questOk){
        if (hudGoal) hudGoal.textContent = '‚ö†Ô∏è QUEST ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°';
        if (hudMini) hudMini.textContent = '‡πÄ‡∏ä‡πá‡∏Ñ groups-quests.js';
        if (hudGoalNum) hudGoalNum.textContent = '';
        if (hudMiniNum) hudMiniNum.textContent = '';
        return;
      }

      const goal = d.goal || null;
      const mini = d.mini || null;

      if (hudGoal) hudGoal.textContent = goal ? goal.label : '‚Äî';
      if (hudMini) hudMini.textContent = mini ? mini.label : '‚Äî';

      if (hudGoalNum) hudGoalNum.textContent =
        goal ? `${goal.prog|0}/${goal.target|0}` : '0/0';

      if (hudMiniNum){
        if (!mini) hudMiniNum.textContent = '0/0';
        else {
          const t = `${mini.prog|0}/${mini.target|0}`;
          const tl = (mini.tLeft != null) ? ` ‚è±${mini.tLeft|0}s` : '';
          hudMiniNum.textContent = t + tl;
        }
      }
    }, { passive:true });

    window.addEventListener('groups:power', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const name = d.groupName || 'POWER';
      const c = d.charge|0;
      const th = Math.max(1, d.threshold|0);
      const pct = clamp(c / th, 0, 1);

      if (hudPowerName) hudPowerName.textContent = name;
      if (hudPowerNum)  hudPowerNum.textContent  = `${c}/${th}`;
      if (hudPowerFill) hudPowerFill.style.width = Math.round(pct * 100) + '%';

      if (hudPowerFill){
        hudPowerFill.classList.remove('pulse');
        void hudPowerFill.offsetWidth;
        hudPowerFill.classList.add('pulse');
      }
    }, { passive:true });

    window.addEventListener('groups:group_change', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const text = d.label || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏π‡πà!';
      flashBanner(text);
      document.documentElement.classList.add('swapflash');
      setTimeout(()=>document.documentElement.classList.remove('swapflash'), 240);
    }, { passive:true });

    window.addEventListener('groups:stun', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      if (d.on) showStun(d.ms|0);
      document.documentElement.classList.add('stunflash');
      setTimeout(()=>document.documentElement.classList.remove('stunflash'), 220);
    }, { passive:true });

    window.addEventListener('groups:lock', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      showLock(!!d.on, d.x, d.y, d.prog, d.charge);
    }, { passive:true });

    window.addEventListener('hha:rank', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      if (hudGrade && d.grade) hudGrade.textContent = String(d.grade || 'C');
      if (hudAcc  && (d.accuracy != null)) hudAcc.textContent = String(d.accuracy ?? 0);
      if (hudQp   && (d.questsPct != null)) hudQp.textContent  = String(d.questsPct ?? 0);
    }, { passive:true });

    function getEngine(){
      return (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
    }

    function startGame(){
      const engine = getEngine();
      if (!engine) {
        alert('GameEngine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏ä‡πá‡∏Ñ ./vr-groups/GameEngine.js)');
        return;
      }
      engine.setLayerEl(layerEl);
      engine.setCameraEl(camEl);
      engine.setTimeLeft(timeSec);

      engine.start(diff, {
        layerEl,
        runMode: run,
        seed: seed || undefined
      });

      startOverlay.style.display = 'none';
    }

    btnStart && btnStart.addEventListener('click', startGame);
    btnRestart && btnRestart.addEventListener('click', ()=>{
      const engine = getEngine();
      if (engine) engine.stop('restart');
      startOverlay.style.display = '';
    });
    btnExit && btnExit.addEventListener('click', ()=>{
      startOverlay.style.display = 'none';
    });

    // Auto-run
    const auto = String(getParam('autostart','0')) === '1';
    if (auto) setTimeout(startGame, 220);

  })();
  </script>
</body>
</html>