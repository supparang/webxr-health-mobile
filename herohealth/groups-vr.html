<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏â‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.20);
      --danger:#f97373;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *,
    *::before,
    *::after {
      box-sizing:border-box;
    }

    html, body {
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.24), transparent 55%),
        #020617;
      color:var(--text-main);
    }

    /* A-Frame ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    a-scene {
      position:fixed;
      inset:0;
      z-index:0;
    }

    /* ===== HUD root ===== */

    .hud-root {
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:60;
    }

    .hud-top {
      position:absolute;
      top:0;
      left:0;
      right:0;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      pointer-events:none;
    }

    /* ===== HUD Score (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô) ===== */

    .hud-card {
      pointer-events:auto;
      background:radial-gradient(circle at top, #0f172a, #020617);
      border-radius:var(--radius-lg);
      padding:10px 14px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:
        0 18px 40px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,1);
      color:var(--text-main);
      min-width:260px;
      max-width:360px;
    }

    .hud-main-title {
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:2px;
    }

    .hud-main-mode {
      font-size:18px;
      font-weight:600;
    }

    .hud-pill {
      margin-top:4px;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-soft);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .hud-metrics {
      margin-top:8px;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }

    .metric {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .metric-label {
      font-size:11px;
      color:var(--text-soft);
    }

    .metric-value {
      font-size:18px;
      font-weight:700;
    }

    .metric-value.accent {
      color:#bbf7d0;
    }

    .metric-sub {
      font-size:11px;
      color:var(--text-soft);
      min-height:14px;
    }

    /* ===== HUD Goal + Mini quest (‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) ===== */

    .fg-quest-panel {
      pointer-events:auto;
      min-width:260px;
      max-width:320px;
      padding:10px 14px;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top, #0f172a, #020617);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:
        0 18px 40px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,1);
      color:var(--text-main);
      max-height:40vh;
      overflow-y:auto;
    }

    .fg-quest-title {
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:4px;
    }

    .fg-quest-row {
      display:flex;
      align-items:flex-start;
      gap:6px;
      font-size:13px;
      padding:2px 0;
    }

    .fg-quest-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      margin-top:2px;
      white-space:nowrap;
    }

    .fg-quest-main {
      flex:1;
      color:var(--text-main);
      opacity:.9;
    }

    .fg-quest-progress {
      font-variant-numeric:tabular-nums;
      font-size:12px;
      color:#bbf7d0;
      white-space:nowrap;
    }

    /* ===== Coach bubble ‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á ===== */

    .hud-bottom {
      position:absolute;
      left:0;
      right:0;
      bottom:64px;
      display:flex;
      justify-content:center;
      align-items:center;
      pointer-events:none;
    }

    .coach-bubble {
      min-width:60%;
      max-width:640px;
      background:rgba(15,23,42,0.95);
      border-radius:var(--radius-pill);
      padding:8px 14px;
      border:1px solid rgba(52,211,153,0.5);
      font-size:13px;
      display:none;
      align-items:center;
      gap:8px;
      pointer-events:auto;
      transition:
        transform .20s ease-out,
        box-shadow .20s ease-out,
        background .20s ease-out;
    }

    .coach-bubble.show {
      display:flex;
    }

    .coach-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#6ee7b7;
      font-weight:600;
    }

    .coach-avatar {
      width:28px;
      height:28px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fef3c7, #f97316);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      box-shadow:0 0 0 2px rgba(15,23,42,0.9);
      animation:coach-breathe 2.4s ease-in-out infinite;
    }

    @keyframes coach-breathe {
      0%,100% { transform:scale(1); }
      50%     { transform:scale(1.07); }
    }

    /* ===== Layout ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ===== */
    @media (max-width:640px) {
      .hud-top{
        flex-direction:column;
        align-items:stretch;
      }
      .hud-card,
      .fg-quest-panel{
        min-width:0;
        width:100%;
        max-width:none;
      }
      .fg-quest-panel{
        margin-top:6px;
        max-height:34vh;
      }
      .coach-bubble {
        min-width:0;
        width:calc(100% - 32px);
        font-size:12px;
      }
    }

    /* ===== Target Layer (DOM) ===== */

    #fg-layer {
      position:fixed;
      inset:0;
      z-index:40; /* ‡πÉ‡∏ï‡πâ HUD ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏â‡∏≤‡∏Å */
      pointer-events:none;
    }

    .fg-target {
      position:absolute;
      width:132px;
      height:132px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #f97316, #c2410c);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      cursor:pointer;
      box-shadow:
        0 12px 32px rgba(15,23,42,0.85),
        0 0 0 4px rgba(15,23,42,0.9);
      transform:translate(-50%, -50%) scale(1);
      transition:
        transform .12s ease-out,
        opacity .12s ease-out,
        box-shadow .12s ease-out;
    }

    .fg-good {
      background:radial-gradient(circle at 30% 30%, #22c55e, #15803d);
    }

    .fg-junk {
      background:radial-gradient(circle at 30% 30%, #f97316, #c2410c);
    }

    .fg-target::before {
      content:attr(data-emoji);
      display:block;
      font-size:clamp(40px, 7vmin, 64px);
      line-height:1;
      color:#fefce8;
      text-shadow:
        0 2px 4px rgba(15,23,42,0.9),
        0 0 10px rgba(15,23,42,0.9);
    }

    .fg-target.hit {
      transform:translate(-50%, -50%) scale(0.6);
      opacity:0;
    }

    /* ===== Summary overlay ===== */

    .result-overlay {
      position:fixed;
      inset:0;
      z-index:120;
      display:none;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#020617ee,#020617f5);
      backdrop-filter:blur(10px);
    }

    .result-overlay.show {
      display:flex;
    }

    .result-card {
      width:90%;
      max-width:420px;
      padding:18px 18px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#0f172a,#020617);
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:
        0 22px 55px rgba(0,0,0,0.85),
        0 0 0 1px rgba(15,23,42,1);
      color:var(--text-main);
      font-size:14px;
    }

    .result-card h2 {
      margin:0 0 8px;
      font-size:16px;
    }

    .result-card p {
      margin:4px 0;
      font-size:13px;
    }

    .result-card hr {
      border:none;
      border-top:1px solid rgba(148,163,184,0.5);
      margin:10px 0;
    }

    .result-actions {
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .result-btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      padding:6px 12px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
    }

    .result-btn.primary{
      background:linear-gradient(90deg,#22c55e,#4ade80);
      color:#022c22;
      border:none;
    }

    /* ===== End toast (‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ) ===== */

    .end-toast {
      position:fixed;
      right:12px;
      bottom:12px;
      z-index:120;
      max-width:280px;
      width:calc(100% - 32px);
      padding:12px 14px 10px;
      border-radius:18px;
      background:radial-gradient(circle at top,#0f172a,#020617);
      border:1px solid rgba(148,163,184,0.5);
      box-shadow:
        0 18px 40px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,1);
      font-size:13px;
      color:var(--text-main);
      display:none;
    }

    .end-toast.show{
      display:block;
    }

    .end-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }

    .end-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin:2px 0;
    }

    .end-row strong{
      font-variant-numeric:tabular-nums;
    }

    .end-actions{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .end-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      padding:4px 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
    }

    .end-btn.primary{
      background:linear-gradient(90deg,#22c55e,#4ade80);
      color:#022c22;
      border:none;
    }

    /* ===== Fever gauge ===== */
    .hha-fever-wrap {
      position:fixed !important;
      left:10px;
      bottom:10px;
      right:auto;
      transform:none;
      z-index:80 !important;
    }

    /* ===== Countdown ===== */
    .countdown-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:200;
      font-size:clamp(3rem, 10vw, 5rem);
      font-weight:800;
      color:#fbbf24;
      text-shadow:0 0 40px rgba(0,0,0,0.85);
      pointer-events:none;
      opacity:0;
      transform:scale(0.8);
      transition:opacity .2s ease-out, transform .2s ease-out;
    }
    .countdown-overlay.show{
      opacity:1;
      transform:scale(1);
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ VR */
    .vr-btn{
      position:fixed;
      right:12px;
      bottom:16px;
      z-index:653;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      padding:8px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 55%),
                 rgba(15,23,42,0.96);
      color:#e0f2fe;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 14px 30px rgba(15,23,42,0.9);
    }
    .vr-btn span{
      font-size:16px;
    }

    /* ===== Celebrate Overlay (Goal / Mini / All clear) ===== */
    .celebrate-overlay {
      position:fixed;
      inset:0;
      z-index:190;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .celebrate-overlay.show {
      display:flex;
    }
    .celebrate-content {
      padding:12px 22px;
      border-radius:999px;
      background:radial-gradient(circle at top, rgba(34,197,94,0.9), rgba(21,128,61,0.95));
      box-shadow:
        0 20px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,1);
      font-size:clamp(18px,4vw,24px);
      font-weight:800;
      letter-spacing:0.06em;
      text-transform:uppercase;
      color:#ecfdf5;
      text-align:center;
      transform:scale(0.86) translateY(10px);
      opacity:0;
      transition:
        opacity .18s ease-out,
        transform .18s ease-out,
        background .18s ease-out;
    }
    .celebrate-overlay.show .celebrate-content {
      opacity:1;
      transform:scale(1) translateY(0);
    }
    .celebrate-sub {
      display:block;
      margin-top:4px;
      font-size:clamp(11px,2.5vw,13px);
      letter-spacing:0.18em;
      opacity:0.9;
    }
    .celebrate--mini .celebrate-content {
      background:radial-gradient(circle at top, rgba(250,204,21,0.95), rgba(217,119,6,0.98));
      color:#022c22;
    }
    .celebrate--all .celebrate-content {
      background:radial-gradient(circle at top, rgba(56,189,248,0.98), rgba(30,64,175,0.98));
    }
  </style>
</head>
<body>

  <!-- ‡∏â‡∏≤‡∏Å VR ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    background="color: #020617">

    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="fg-camera"
                wasd-controls-enabled="false"
                look-controls="pointerLockEnabled: false">
        <!-- crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ -->
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9">
        </a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡πÑ‡∏ü + ‡∏û‡∏∑‡πâ‡∏ô -->
    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-plane position="0 0 0" rotation="-90 0 0" width="16" height="16"
             material="color: #020617; metalness: 0; roughness: 1"></a-plane>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå DOM ‡πÄ‡∏õ‡πâ‡∏≤ -->
  <div id="fg-layer"></div>

  <!-- HUD -->
  <div class="hud-root">
    <div class="hud-top">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
      <div class="hud-card">
        <div class="hud-main-title">HERO HEALTH ‚Ä¢ NUTRITION VR</div>
        <div class="hud-main-mode">Food Groups</div>
        <div class="hud-pill">
          <span id="hud-diff-label">NORMAL</span>
          <span>‚Ä¢</span>
          <span id="hud-time-label">60s</span>
        </div>
        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="metric-value accent" id="hud-score">0</div>
            <div class="metric-sub" id="hud-judge">&nbsp;</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="metric-value" id="hud-combo">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">‡∏û‡∏•‡∏≤‡∏î</div>
            <div class="metric-value" id="hud-miss">0</div>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡∏ß‡∏≤: Quest -->
      <div class="fg-quest-panel">
        <div class="fg-quest-title">Quest</div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Goal</div>
          <div class="fg-quest-main" id="fg-quest-main">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
          <div class="fg-quest-progress" id="fg-quest-main-progress">0 / 0</div>
        </div>
        <div class="fg-quest-row">
          <div class="fg-quest-label">Mini</div>
          <div class="fg-quest-main" id="fg-quest-mini">Mini quest ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
          <div class="fg-quest-progress" id="fg-quest-mini-progress">0 / 0</div>
        </div>
      </div>
    </div>

    <!-- ‡∏•‡πà‡∏≤‡∏á: ‡πÇ‡∏Ñ‡πâ‡∏ä -->
    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div class="coach-avatar" id="coach-avatar">ü•¶</div>
        <div>
          <div class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div id="coach-text">‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏∞</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ VR -->
  <button id="btn-vr" class="vr-btn"><span>üï∂Ô∏è</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</button>

  <!-- Countdown -->
  <div id="start-countdown" class="countdown-overlay">3</div>

  <!-- Celebrate overlay -->
  <div id="celebrate-overlay" class="celebrate-overlay">
    <div class="celebrate-content" id="celebrate-content">
      <span id="celebrate-main">GOAL COMPLETE!</span>
      <span class="celebrate-sub" id="celebrate-sub">FOOD GROUPS VR</span>
    </div>
  </div>

  <!-- Summary overlay -->
  <div class="result-overlay" id="result-overlay">
    <div class="result-card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Food Groups</h2>
      <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <strong id="res-score">0</strong></p>
      <p>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong id="res-combo">0</strong></p>
      <p>‡∏û‡∏•‡∏≤‡∏î: <strong id="res-miss">0</strong></p>
      <p>Goals: <strong id="res-goal">0 / 0</strong></p>
      <p>Mini quests: <strong id="res-mini">0 / 0</strong></p>
      <hr>
      <div class="result-actions">
        <button class="result-btn" id="res-back">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="result-btn primary" id="res-replay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Fever UI + particles -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <!-- Game engine (‡πÅ‡∏ô‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window.GroupsVR) -->
  <script src="./vr-groups/difficulty.foodgroups.js"></script>
  <script src="./vr-groups/quest-manager.js"></script>
  <script src="./vr-groups/GameEngine.js"></script>

  <!-- Boot logic (ES module ‡πÅ‡∏¢‡∏Å) -->
  <script type="module">
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';

    const fgLayer = document.getElementById('fg-layer');

    const elScore   = document.getElementById('hud-score');
    const elCombo   = document.getElementById('hud-combo');
    const elMiss    = document.getElementById('hud-miss');
    const elJudge   = document.getElementById('hud-judge');
    const elDiff    = document.getElementById('hud-diff-label');
    const elTime    = document.getElementById('hud-time-label');

    const elQuestMain   = document.getElementById('fg-quest-main');
    const elQuestMini   = document.getElementById('fg-quest-mini');
    const elQuestMainP  = document.getElementById('fg-quest-main-progress');
    const elQuestMiniP  = document.getElementById('fg-quest-mini-progress');

    const elCoachBubble = document.getElementById('coach-bubble');
    const elCoachText   = document.getElementById('coach-text');

    const elResult      = document.getElementById('result-overlay');
    const elResScore    = document.getElementById('res-score');
    const elResCombo    = document.getElementById('res-combo');
    const elResMiss     = document.getElementById('res-miss');
    const elResGoal     = document.getElementById('res-goal');
    const elResMini     = document.getElementById('res-mini');
    const btnResReplay  = document.getElementById('res-replay');
    const btnResBack    = document.getElementById('res-back');

    const btnVR         = document.getElementById('btn-vr');
    const elCountdown   = document.getElementById('start-countdown');

    // Celebrate overlay
    const elCelebrateOverlay = document.getElementById('celebrate-overlay');
    const elCelebrateMain    = document.getElementById('celebrate-main');
    const elCelebrateSub     = document.getElementById('celebrate-sub');
    const elCelebrateContent = document.getElementById('celebrate-content');
    let celebrateTimer = null;

    let hudMissCount = 0;
    let hudComboMax  = 0;
    let hudGoalsTotal = 0;
    let hudGoalsCleared = 0;
    let hudMiniTotal = 0;
    let hudMiniCleared = 0;

    function getParam(name, fallback){
      const url = new URL(window.location.href);
      const v = url.searchParams.get(name);
      return v !== null && v !== '' ? v : fallback;
    }

    function setCoach(text){
      if (!text) return;
      elCoachText.textContent = text;
      elCoachBubble.classList.add('show');
      setTimeout(() => elCoachBubble.classList.remove('show'), 3800);
    }

    // ===== Celebrate banner handler =====
    function showCelebrate(type, detail){
      if (!elCelebrateOverlay || !elCelebrateMain) return;

      const t = type || 'goal';
      const d = detail || {};
      let title = '';
      let sub   = '';

      if (t === 'goal') {
        const idx = d.index || 1;
        const total = d.total || 2;
        title = `GOAL ${idx}/${total} COMPLETE üéØ`;
        sub   = '‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        elCelebrateOverlay.classList.remove('celebrate--mini','celebrate--all');
      } else if (t === 'mini') {
        const idx = d.index || 1;
        const total = d.total || 3;
        title = `MINI QUEST ${idx}/${total} CLEAR ‚≠ê`;
        sub   = '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!';
        elCelebrateOverlay.classList.add('celebrate--mini');
        elCelebrateOverlay.classList.remove('celebrate--all');
      } else {
        title = 'ALL QUESTS CLEARED üéâ';
        sub   = '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á Goal ‡πÅ‡∏•‡∏∞ Mini ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';
        elCelebrateOverlay.classList.add('celebrate--all');
        elCelebrateOverlay.classList.remove('celebrate--mini');
      }

      elCelebrateMain.textContent = title;
      elCelebrateSub.textContent  = sub;

      if (celebrateTimer) {
        clearTimeout(celebrateTimer);
        celebrateTimer = null;
      }

      elCelebrateOverlay.classList.add('show');

      celebrateTimer = setTimeout(() => {
        elCelebrateOverlay.classList.remove('show');
      }, t === 'all' ? 2600 : 2000);
    }

    window.addEventListener('hha:celebrate', (e) => {
      const d = e.detail || {};
      showCelebrate(d.type || 'goal', d);
    });

    // HUD events from Engine
    window.addEventListener('hha:time', e => {
      const d = e.detail || {};
      const sec = (d.sec | 0);
      if (sec < 0) return;
      elTime.textContent = sec + 's';
    });

    window.addEventListener('hha:score', e => {
      const d = e.detail || {};
      if (typeof d.score === 'number') elScore.textContent = d.score;
      if (typeof d.combo === 'number') {
        hudComboMax = Math.max(hudComboMax, d.combo|0);
        elCombo.textContent = hudComboMax;
      }
      if (typeof d.misses === 'number') {
        hudMissCount = d.misses|0;
        elMiss.textContent = hudMissCount;
      }
    });

    window.addEventListener('hha:miss', (e) => {
      const d = e.detail || {};
      hudMissCount = (typeof d.misses === 'number') ? (d.misses|0) : hudMissCount;
      elMiss.textContent = hudMissCount;
      setCoach('‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏õ‡∏ô‡∏¥‡∏î ‡∏•‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞ üòå');
    });

    window.addEventListener('hha:judge', e => {
      const d = e.detail || {};
      elJudge.textContent = d.label || '';
    });

    window.addEventListener('quest:update', e => {
      const d = e.detail || {};
      const goal = d.goal || null;
      const mini = d.mini || null;

      if (goal){
        elQuestMain.textContent = goal.label || '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å';
        elQuestMainP.textContent = (goal.prog|0) + ' / ' + (goal.target|0);
      } else {
        elQuestMain.textContent = '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéâ';
        elQuestMainP.textContent = '';
      }

      if (mini){
        elQuestMini.textContent = 'Mini: ' + (mini.label || '');
        elQuestMiniP.textContent = (mini.prog|0) + ' / ' + (mini.target|0);
      } else {
        elQuestMini.textContent = 'Mini quest ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
        elQuestMiniP.textContent = '';
      }

      const goalsAll = d.goalsAll || [];
      const minisAll = d.minisAll || [];
      hudGoalsTotal   = goalsAll.length;
      hudGoalsCleared = goalsAll.filter(g => g && g.done).length;
      hudMiniTotal    = minisAll.length;
      hudMiniCleared  = minisAll.filter(m => m && m.done).length;
    });

    window.addEventListener('hha:coach', e => {
      const d = e.detail || {};
      if (d.text) setCoach(d.text);
    });

    window.addEventListener('hha:end', e => {
      const d = e.detail || {};
      const scoreFinal = typeof d.scoreFinal === 'number' ? d.scoreFinal : (d.score || 0);

      elResScore.textContent = scoreFinal;
      elResCombo.textContent = hudComboMax;
      elResMiss.textContent  = hudMissCount;
      elResGoal.textContent  = (d.goalsCleared != null ? d.goalsCleared : hudGoalsCleared) +
        ' / ' + (d.goalsTotal || hudGoalsTotal || 0);
      elResMini.textContent  = (d.miniCleared != null ? d.miniCleared : hudMiniCleared) +
        ' / ' + (d.miniTotal || hudMiniTotal || 0);

      elResult.classList.add('show');
    });

    btnResReplay.addEventListener('click', () => {
      window.location.reload();
    });
    btnResBack.addEventListener('click', () => {
      window.location.href = './hub.html';
    });

    // ‡∏õ‡∏∏‡πà‡∏° VR
    btnVR.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) {
        try { scene.enterVR(); } catch(e) { console.warn(e); }
      }
    });

    // Touch look
    const cam = document.querySelector('#fg-camera');
    if (cam) {
      attachTouchLook(cam, {
        sensitivity: 0.25,
        areaEl: document.body
      });
    }

    // Cloud logger
    function initLogger(diff, dur, runMode){
      let studentProfile = null;
      let studentKey = null;
      try{
        const raw = sessionStorage.getItem('HHA_STUDENT_PROFILE');
        if (raw){
          studentProfile = JSON.parse(raw);
          studentKey = studentProfile.studentKey || null;
        }
      }catch(err){
        console.warn('[FoodGroupsVR] cannot parse student profile:', err);
      }

      initCloudLogger({
        endpoint: 'https://script.google.com/macros/s/AKfycby7IBVmpmEydNDp5BR3CMaSAjvF7ljptaDwvow_L781iDLsbtpuiFmKviGUnugFerDtQg/exec',
        projectTag: 'HeroHealth-FoodGroupsVR',
        mode: 'FoodGroupsVR',
        runMode,
        diff,
        durationSec: dur,
        studentKey,
        profile: studentProfile,
        debug: false
      });
    }

    // Countdown 3-2-1-Go
    function runCountdown(onDone){
      if (!elCountdown) {
        onDone && onDone();
        return;
      }
      const steps = ['3','2','1','Go!'];
      let idx = 0;
      elCountdown.textContent = steps[0];
      elCountdown.classList.add('show');

      const t = setInterval(() => {
        idx++;
        if (idx >= steps.length){
          clearInterval(t);
          elCountdown.classList.remove('show');
          onDone && onDone();
        } else {
          elCountdown.textContent = steps[idx];
        }
      }, 800);
    }

    // ===== Boot =====
    window.addEventListener('DOMContentLoaded', () => {
      const diff = String(getParam('diff','normal')).toLowerCase();
      const runParam = String(getParam('run','play')).toLowerCase();
      const runMode = (runParam === 'research') ? 'research' : 'play';

      elDiff.textContent = diff.toUpperCase();

      let baseDur = 60;
      if (diff === 'easy') baseDur = 80;
      else if (diff === 'hard') baseDur = 45;

      let dur = baseDur;
      const timeParam = getParam('time','');
      if (timeParam){
        const parsed = parseInt(timeParam,10);
        if (!isNaN(parsed) && parsed >= 20 && parsed <= 180){
          dur = parsed;
        }
      }
      elTime.textContent = dur + 's';

      initLogger(diff, dur, runMode);
      setCoach('‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢ ‚ú®');

      const ns = window.GroupsVR || {};
      const Engine = ns.GameEngine;
      if (!Engine || typeof Engine.start !== 'function'){
        console.error('[FoodGroupsVR] GameEngine ‡πÑ‡∏°‡πà‡∏û‡∏ö (window.GroupsVR.GameEngine)');
        return;
      }

      if (Engine.setLayerEl) {
        Engine.setLayerEl(fgLayer);
      }

      runCountdown(() => {
        let timeLeft = dur;
        window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));
        const timerId = setInterval(() => {
          timeLeft -= 1;
          if (timeLeft < 0) {
            clearInterval(timerId);
            if (Engine.stop) Engine.stop('time-up');
            return;
          }
          window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));
          if (timeLeft === 0){
            clearInterval(timerId);
            if (Engine.stop) Engine.stop('time-up');
          }
        },1000);

        Engine.start(diff, {
          layerEl: fgLayer
        });
      });
    });
  </script>
</body>
</html>
