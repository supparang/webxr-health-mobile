<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî FULL HTML (PRODUCTION / FIX-ALL / Split CSS)
‚úÖ Emoji targets = textContent (‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á)
‚úÖ Goal + Mini Quest ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡πà (‡∏°‡∏µ fallback panel + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö hha-hud.js)
‚úÖ Fever/Shield ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (ui-fever.js)
‚úÖ Lock + Charge ring + Danger/Panic overlays ‡∏û‡∏£‡πâ‡∏≠‡∏° (events: groups:lock / groups:charge / groups:danger / hha:panic)
‚úÖ Script order ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: particles ‚Üí fever ‚Üí hud ‚Üí (optional logger) ‚Üí quests ‚Üí engine ‚Üí boot
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (camera rotation source) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Split CSS -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <!-- Global FX / UI (IIFE) ‚Äî MUST load before engine -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- (optional) cloud logger (IIFE) -->
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Groups quests + engine (IIFE) -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å HUD (‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏á‡πà‡∏≤‡∏¢) */
    .hud, .hha-hud, #hud, #hudRoot, #hudTop, #hudBottom, #hudQuest, #questPanel { pointer-events:none; }
    .tap-hint { pointer-events:none; }
    /* ‡∏õ‡∏∏‡πà‡∏° start overlay ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ */
    #startOverlay, #startOverlay *{ pointer-events:auto; }
  </style>
</head>

<body>

  <!-- ===== A-Frame scene (‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á + VR enter) ===== -->
  <a-scene
    embedded
    vr-mode-ui="enabled: true"
    renderer="colorManagement: true; antialias: true"
    background="color: #020617"
  >
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false" look-controls="enabled: true"></a-camera>
    </a-entity>
  </a-scene>

  <!-- ===== DOM gameplay layer (targets spawn here) ===== -->
  <div id="fg-layer" class="fg-layer" aria-label="FoodGroups layer"></div>

  <!-- ===== overlays: danger / panic ===== -->
  <div id="dangerVignette" class="fg-danger" aria-hidden="true"></div>
  <div id="panicPulse" class="fg-panic" aria-hidden="true"></div>

  <!-- ===== lock / charge rings (optional; driven by events) ===== -->
  <div id="lockRing" class="fg-lock-ring" aria-hidden="true"></div>
  <div id="chargeRing" class="fg-charge-ring" aria-hidden="true"></div>

  <!-- ===== Quest Panel fallback (‡∏ñ‡πâ‡∏≤ hha-hud.js ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ element ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ) ===== -->
  <div id="hudQuest" class="hha-quest" style="display:none;">
    <div class="hdr">
      <div>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à üéØ</div>
      <div id="qGroupLabel" style="opacity:.82;"></div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="col">
        <div class="hha-goal-title" id="goalTitle">GOAL: ‚Äî</div>
        <div class="hha-goal-prog"  id="goalProg">0 / 0</div>
        <div class="hha-goal-bar"><div class="fill" id="goalFill"></div></div>
      </div>
      <div class="col">
        <div class="hha-mini-title" id="miniTitle">MINI: ‚Äî</div>
        <div class="hha-mini-prog"  id="miniProg">0 / 0</div>
        <div class="hha-mini-bar"><div class="fill" id="miniFill"></div></div>
        <div class="hha-quest-hint" id="miniHint" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- ===== Start overlay ===== -->
  <div id="startOverlay" style="
    position:fixed; inset:0; z-index:80;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(900px 700px at 50% 30%, rgba(30,41,59,.55), rgba(2,6,23,.92));
    ">
    <div style="
      width:min(760px, calc(100vw - 24px));
      border-radius:22px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.62);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      padding:16px 14px;
      ">
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <div>
          <div style="font-weight:900; font-size:18px;">Food Groups VR üçΩÔ∏è</div>
          <div style="opacity:.85; font-size:13px; margin-top:2px;">
            ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô: ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏à‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‚Äù ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î üî•
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label style="display:flex; gap:8px; align-items:center; font-size:13px; opacity:.92;">
            ‡∏£‡∏∞‡∏î‡∏±‡∏ö
            <select id="diffSel" style="
              background: rgba(15,23,42,.70);
              color:#e5e7eb; border:1px solid rgba(148,163,184,.22);
              border-radius:12px; padding:8px 10px;">
              <option value="easy">‡∏á‡πà‡∏≤‡∏¢</option>
              <option value="normal" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
              <option value="hard">‡∏¢‡∏≤‡∏Å</option>
            </select>
          </label>

          <label style="display:flex; gap:8px; align-items:center; font-size:13px; opacity:.92;">
            ‡πÇ‡∏´‡∏°‡∏î
            <select id="modeSel" style="
              background: rgba(15,23,42,.70);
              color:#e5e7eb; border:1px solid rgba(148,163,184,.22);
              border-radius:12px; padding:8px 10px;">
              <option value="play" selected>‡πÄ‡∏•‡πà‡∏ô</option>
              <option value="research">‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (Seeded)</option>
            </select>
          </label>

          <label style="display:flex; gap:8px; align-items:center; font-size:13px; opacity:.92;">
            ‡πÄ‡∏ß‡∏•‡∏≤
            <select id="timeSel" style="
              background: rgba(15,23,42,.70);
              color:#e5e7eb; border:1px solid rgba(148,163,184,.22);
              border-radius:12px; padding:8px 10px;">
              <option value="60">60 ‡∏ß‡∏¥</option>
              <option value="90" selected>90 ‡∏ß‡∏¥</option>
              <option value="120">120 ‡∏ß‡∏¥</option>
            </select>
          </label>

          <button id="btnStart" style="
            background: rgba(34,197,94,.92);
            color:#052e16; border:0;
            font-weight:900;
            border-radius:14px;
            padding:10px 14px;
            box-shadow: 0 18px 40px rgba(34,197,94,.18);
            ">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂
          </button>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; opacity:.92; font-size:12px;">
        <div style="padding:8px 10px; border:1px solid rgba(148,163,184,.16); border-radius:14px; background: rgba(15,23,42,.40);">
          üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ = ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö + ‡πÄ‡∏ï‡∏¥‡∏° FEVER
        </div>
        <div style="padding:8px 10px; border:1px solid rgba(148,163,184,.16); border-radius:14px; background: rgba(15,23,42,.40);">
          üòà ‡∏Ç‡∏¢‡∏∞/‡∏ö‡∏≠‡∏™ = MISS (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏•‡πà) / ‡∏°‡∏µ‡πÇ‡∏•‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
        </div>
        <div style="padding:8px 10px; border:1px solid rgba(148,163,184,.16); border-radius:14px; background: rgba(15,23,42,.40);">
          üöÄ RUSH/WAVE/DECOY/RAGE ‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô (‡∏™‡∏ô‡∏∏‡∏Å+‡πÇ‡∏´‡∏î)
        </div>
      </div>

      <div id="bootWarn" style="margin-top:10px; font-size:12px; opacity:.86; display:none; color:#fde68a;">
        ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö groups-quests.js / GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      </div>
    </div>
  </div>

  <!-- ===== Boot (module) ===== -->
  <script type="module">
    // --- URL params override ---
    const sp = new URLSearchParams(location.search);

    function $(id){ return document.getElementById(id); }

    // read params
    const urlDiff = (sp.get('diff') || '').toLowerCase();
    const urlTime = parseInt(sp.get('time') || '0', 10) || 0;
    const urlRun  = (sp.get('run')  || '').toLowerCase();

    // UI default from url
    if (urlDiff && ['easy','normal','hard'].includes(urlDiff)) $('diffSel').value = urlDiff;
    if (urlTime && [60,90,120].includes(urlTime)) $('timeSel').value = String(urlTime);
    if (urlRun && ['play','research'].includes(urlRun)) $('modeSel').value = urlRun;

    const layerEl = $('fg-layer');
    const camEl   = document.querySelector('#cam');

    // Link engine to layer/camera (safe)
    function bindEngine(){
      const eng = (window.GroupsVR && window.GroupsVR.GameEngine) ? window.GroupsVR.GameEngine : null;
      if (!eng) return null;
      try{ eng.setLayerEl(layerEl); }catch{}
      try{ eng.setCameraEl(camEl); }catch{}
      return eng;
    }

    // ===== Quest Panel fallback binder =====
    function showQuestPanel(on){
      const el = $('hudQuest');
      if (!el) return;
      el.style.display = on ? '' : 'none';
    }
    function setFill(id, pct){
      const el = $(id);
      if (!el) return;
      const p = Math.max(0, Math.min(100, Math.round(pct)));
      el.style.width = p + '%';
    }
    window.addEventListener('quest:update', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      // ‡∏ñ‡πâ‡∏≤ HUD global ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏°‡∏µ UI ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á
      // ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î fallback panel ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô"
      showQuestPanel(true);

      const goal = d.goal || null;
      const mini = d.mini || null;

      $('qGroupLabel').textContent = d.groupLabel ? String(d.groupLabel) : '';

      if (goal){
        $('goalTitle').textContent = String(goal.label || 'GOAL');
        $('goalProg').textContent  = `${goal.prog|0} / ${goal.target|0}`;
        const pct = (goal.target>0) ? (goal.prog/goal.target*100) : 0;
        setFill('goalFill', pct);
      } else {
        $('goalTitle').textContent = 'GOAL: ‚Äî';
        $('goalProg').textContent  = '0 / 0';
        setFill('goalFill', 0);
      }

      if (mini){
        $('miniTitle').textContent = String(mini.label || 'MINI');
        $('miniProg').textContent  = `${mini.prog|0} / ${mini.target|0}`;
        const pct = (mini.target>0) ? (mini.prog/mini.target*100) : 0;
        setFill('miniFill', pct);

        // rush window hint
        if (typeof mini.tLeft === 'number' && mini.tLeft >= 0){
          $('miniHint').style.display = '';
          $('miniHint').textContent = `‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${mini.tLeft|0} ‡∏ß‡∏¥`;
        } else {
          $('miniHint').style.display = 'none';
          $('miniHint').textContent = '';
        }
      } else {
        $('miniTitle').textContent = 'MINI: ‚Äî';
        $('miniProg').textContent  = '0 / 0';
        setFill('miniFill', 0);
        $('miniHint').style.display = 'none';
      }

      // warn if quest missing
      if (d.questOk === false){
        $('bootWarn').style.display = '';
      } else {
        $('bootWarn').style.display = 'none';
      }
    });

    // ===== Danger / Panic / Lock / Charge overlays =====
    window.addEventListener('groups:danger', (ev)=>{
      const on = !!(ev && ev.detail && ev.detail.on);
      $('dangerVignette')?.classList.toggle('on', on);
      if (!on) $('dangerVignette')?.classList.remove('on');
    });

    window.addEventListener('hha:panic', (ev)=>{
      const on = !!(ev && ev.detail && ev.detail.on);
      $('panicPulse')?.classList.toggle('on', on);
    });

    window.addEventListener('groups:lock', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      const ring = $('lockRing');
      if (!ring) return;

      if (!d.on){
        ring.classList.remove('on');
        return;
      }
      ring.classList.add('on');
      const x = (typeof d.x === 'number') ? d.x : window.innerWidth/2;
      const y = (typeof d.y === 'number') ? d.y : window.innerHeight/2;
      ring.style.left = Math.round(x) + 'px';
      ring.style.top  = Math.round(y) + 'px';

      // color by type
      const boss = !!d.boss;
      const good = !!d.good;
      const decoy = !!d.decoy;
      ring.style.borderColor =
        boss ? 'rgba(249,115,22,.60)' :
        decoy ? 'rgba(59,130,246,.62)' :
        (good ? 'rgba(34,197,94,.60)' : 'rgba(239,68,68,.60)');
    });

    window.addEventListener('groups:charge', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      const ring = $('chargeRing');
      if (!ring) return;
      ring.classList.toggle('on', !!d.on);
      ring.classList.toggle('spin', !!d.on);
    });

    // ===== Start/Stop =====
    function startFromUI(){
      const eng = bindEngine();
      if (!eng){
        $('bootWarn').style.display = '';
        return;
      }

      const diff = $('diffSel').value;
      const runMode = $('modeSel').value;
      const timeLeft = parseInt($('timeSel').value, 10) || 90;

      // set time first
      eng.setTimeLeft(timeLeft);

      // optional: url seed (research)
      const seed = sp.get('seed') ? String(sp.get('seed')) : '';

      // start
      eng.start(diff, { runMode, seed, layerEl });

      $('startOverlay').style.display = 'none';
    }

    $('btnStart').addEventListener('click', startFromUI);

    // auto-run via url (run=play/research)
    if (urlRun === 'play' || urlRun === 'research'){
      // wait scripts load (defer) + next frame
      window.addEventListener('load', () => {
        requestAnimationFrame(() => {
          const eng = bindEngine();
          if (!eng) { $('bootWarn').style.display = ''; return; }

          const diff = ['easy','normal','hard'].includes(urlDiff) ? urlDiff : $('diffSel').value;
          const runMode = urlRun;
          const timeLeft = urlTime || (parseInt($('timeSel').value,10)||90);

          eng.setTimeLeft(timeLeft);
          const seed = sp.get('seed') ? String(sp.get('seed')) : '';
          eng.start(diff, { runMode, seed, layerEl });

          $('startOverlay').style.display = 'none';
        });
      });
    }
  </script>
</body>
</html>
