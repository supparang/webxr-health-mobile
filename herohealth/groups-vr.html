<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Modules -->
  <script type="module" src="./vr-groups/GameEngine.js"></script>
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/aframe-particles.js"></script>

  <style>
    :root {
      --bg-main:#020617;
      --text-main:#e5e7eb;
      --accent:#22c55e;
      --radius-lg:18px;
      --radius-pill:999px;
    }
    body {
      margin:0;
      background:var(--bg-main);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:var(--text-main);
      overflow:hidden;
    }

    #hud {
      position:fixed;
      top:10px;
      left:10px;
      z-index:900;
      font-size:14px;
      backdrop-filter:blur(8px);
      background:rgba(2,6,23,0.6);
      padding:10px 14px;
      border-radius:var(--radius-lg);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
    }
    #hud b { color:var(--accent); }

    #coach {
      position:fixed;
      bottom:90px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(255,255,255,0.25);
      border-radius:var(--radius-pill);
      padding:8px 20px;
      font-size:15px;
      color:#f8fafc;
      text-align:center;
      opacity:0;
      transition:opacity .4s ease-out;
      z-index:950;
    }
    #coach.on { opacity:1; }

    #celebrate {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(6px);
      font-size:40px;
      color:#fbbf24;
      text-shadow:0 0 30px rgba(255,255,255,0.8);
      z-index:980;
      opacity:0;
      pointer-events:none;
      transition:opacity .5s ease-out;
    }
    #celebrate.on { opacity:1; }

    #summary {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.95);
      color:#f1f5f9;
      z-index:999;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    #summary h1 { font-size:28px; color:#22c55e; margin-bottom:10px; }
    #summary p { font-size:18px; line-height:1.5; }

    .floatScore {
      position:fixed;
      font-size:22px;
      font-weight:700;
      pointer-events:none;
      user-select:none;
      animation:floatUp 0.9s ease-out forwards;
      z-index:990;
    }
    @keyframes floatUp {
      0% { transform:translateY(0); opacity:1; }
      100% { transform:translateY(-50px); opacity:0; }
    }
  </style>
</head>

<body>
  <div id="hud">
    üßÆ <b id="score">0</b> pts |
    üî• <b id="combo">0</b>x |
    üí¢ Miss: <b id="miss">0</b>
  </div>

  <div id="coach"></div>
  <div id="celebrate">üéâ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! üéâ</div>

  <div id="summary">
    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h1>
    <p id="sumtext">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
  </div>

  <!-- A-Frame Scene -->
  <a-scene embedded>
    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" look-controls="pointerLockEnabled:false" wasd-controls-enabled="false">
        <a-entity id="cursor" cursor="fuse:false; rayOrigin:mouse"
                  raycaster="objects: [data-hha-tgt]"
                  geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.016"
                  material="shader:flat; color:#fff"
                  position="0 0 -0.9"></a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡πÅ‡∏™‡∏á / ‡∏û‡∏∑‡πâ‡∏ô -->
    <a-entity light="type:hemisphere; color:#fff; groundColor:#4b5563; intensity:0.9"></a-entity>
    <a-entity light="type:directional; intensity:0.6" position="1 2 0.5"></a-entity>
    <a-plane rotation="-90 0 0" width="16" height="16" material="color:#020617; roughness:1;"></a-plane>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <script type="module">
    import { GameEngine } from './vr-groups/GameEngine.js';

    const hudScore = document.getElementById('score');
    const hudCombo = document.getElementById('combo');
    const hudMiss  = document.getElementById('miss');
    const coachEl  = document.getElementById('coach');
    const celebEl  = document.getElementById('celebrate');
    const sumEl    = document.getElementById('summary');
    const sumTxt   = document.getElementById('sumtext');

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡πâ‡∏ä/‡∏â‡∏•‡∏≠‡∏á
    function toastCoach(msg) {
      coachEl.textContent = msg;
      coachEl.classList.add('on');
      setTimeout(()=>coachEl.classList.remove('on'), 2600);
    }
    function celebrate(text='üéâ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! üéâ', dur=1500) {
      celebEl.textContent = text;
      celebEl.classList.add('on');
      setTimeout(()=>celebEl.classList.remove('on'), dur);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡πâ‡∏á
    function floatScoreText(x,y,txt,color='#fff') {
      const el = document.createElement('div');
      el.className = 'floatScore';
      el.textContent = txt;
      el.style.left = x+'px';
      el.style.top  = y+'px';
      el.style.color = color;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),900);
    }

    // Event listeners
    window.addEventListener('hha:coach', e => toastCoach(e.detail.text));
    window.addEventListener('hha:quest-clear', e => celebrate('‚úÖ '+e.detail.label));
    window.addEventListener('hha:grand-clear', e => celebrate('üèÜ '+e.detail.text,2000));
    window.addEventListener('hha:judge', e => {
      const label = e.detail.label || '';
      const color =
        label.includes('PERFECT') ? '#22c55e' :
        label.includes('GOOD')    ? '#3b82f6' :
        label.includes('OK')      ? '#facc15' :
        '#ef4444';
      floatScoreText(window.innerWidth/2, window.innerHeight/2, label, color);
    });
    window.addEventListener('hha:score', e => {
      hudScore.textContent = e.detail.score;
      hudCombo.textContent = e.detail.combo;
      hudMiss.textContent  = e.detail.misses;
    });
    window.addEventListener('hha:end', e => {
      const d = e.detail;
      sumTxt.innerHTML =
        `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <b>${d.scoreFinal}</b><br>` +
        `‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b>${d.comboMax}</b><br>` +
        `‡∏û‡∏•‡∏≤‡∏î: <b>${d.misses}</b><br>` +
        `Goal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${d.goalsCleared}/${d.goalsTotal} | Mini ${d.miniCleared}/${d.miniTotal}`;
      sumEl.style.display='flex';
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    window.addEventListener('load',()=>{
      const url=new URL(window.location.href);
      const diff=url.searchParams.get('diff')||'normal';
      GameEngine.start(diff);
    });
  </script>
</body>
</html>