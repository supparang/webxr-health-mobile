<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (PLAY/RESEARCH)
‚úÖ FIX: groups-quests.js ‡πÄ‡∏õ‡πá‡∏ô IIFE (no import) -> window.GroupsQuest.createFoodGroupsQuest
‚úÖ FIX: ‡∏Å‡∏±‡∏ô cache ‡∏î‡πâ‡∏ß‡∏¢ ?v=...
‚úÖ VR-look: drag-to-look + deviceorientation-to-look + inertia ‡πÄ‡∏ö‡∏≤ ‡πÜ
‚úÖ DOM world-anchored targets (#fg-layer) + lock ring + charge ring + reticle
‚úÖ afterimage CSS (2 shadows, scale ‡πÇ‡∏ï‡∏ï‡∏≠‡∏ô‡∏´‡∏≤‡∏¢)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#020617" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --junk:#ef4444;
      --warn:#f59e0b;
      --accent:#38bdf8;
      --radius:18px;
      --pill:999px;
      --shadow:0 18px 40px rgba(0,0,0,.35);
    }

    html,body{
      margin:0; padding:0;
      width:100%; height:100%;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(56,189,248,.12), transparent 55%),
                  radial-gradient(1000px 700px at 80% 90%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      overflow:hidden;
    }

    /* --- A-Frame fill --- */
    .sceneWrap{
      position:fixed; inset:0;
      z-index:0;
    }
    a-scene{ width:100%; height:100%; }

    /* --- overlay --- */
    .ui{
      position:fixed; inset:0;
      z-index:5;
      pointer-events:none;
    }

    /* layer for targets */
    #fg-layer{
      position:fixed; inset:0;
      z-index:6;
      pointer-events:auto;              /* allow direct hits + tap-anywhere binding */
      touch-action: manipulation;
    }

    /* ===== TARGET: emoji sticker ===== */
    .fg-target{
      position:absolute;
      left:0; top:0;
      transform: translate3d(50vw,50vh,0) translate(-50%,-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;

      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,.72) 35%, rgba(255,255,255,.20) 70%, rgba(255,255,255,.08)),
        radial-gradient(circle at 70% 75%, rgba(56,189,248,.18), transparent 60%);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        0 18px 40px rgba(0,0,0,.35),
        0 0 0 6px rgba(56,189,248,.07);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);

      transition: filter .12s ease, transform .12s ease, opacity .12s ease;
      opacity:0;

      /* emoji look */
      font-size:54px;
      line-height:1;
      text-shadow: 0 8px 18px rgba(0,0,0,.25);
    }

    .fg-target::before{
      content:'';
      position:absolute; inset:-10px;
      border-radius:999px;
      background: radial-gradient(circle at 40% 35%, rgba(56,189,248,.25), transparent 55%);
      filter: blur(8px);
      opacity:.55;
      z-index:-1;
      pointer-events:none;
      transition: opacity .15s ease;
    }

    .fg-target.fg-good::before{
      background: radial-gradient(circle at 40% 35%, rgba(34,197,94,.22), transparent 55%);
    }
    .fg-target.fg-junk::before{
      background: radial-gradient(circle at 40% 35%, rgba(239,68,68,.22), transparent 55%);
    }

    .fg-target.spawn{ opacity:0; transform: translate3d(50vw,50vh,0) translate(-50%,-50%) scale(.78); }
    .fg-target.show{ opacity:1; transform: translate3d(var(--x,50vw),var(--y,50vh),0) translate(-50%,-50%) scale(1); }
    .fg-target.out{ opacity:0; filter: blur(1px); transform: translate3d(var(--x,50vw),var(--y,50vh),0) translate(-50%,-50%) scale(1.08); }
    .fg-target.hit{ opacity:0; filter: blur(1px); transform: translate3d(var(--x,50vw),var(--y,50vh),0) translate(-50%,-50%) scale(1.20); }

    /* lock highlight on target */
    .fg-target.lock{
      filter: saturate(1.05) brightness(1.05);
      box-shadow:
        0 18px 40px rgba(0,0,0,.35),
        0 0 0 8px rgba(56,189,248,.16),
        0 0 0 14px rgba(56,189,248,.08);
    }

    /* boss styling */
    .fg-target.fg-boss{
      border:1px solid rgba(245,158,11,.35);
      box-shadow:
        0 20px 44px rgba(0,0,0,.42),
        0 0 0 8px rgba(245,158,11,.12);
    }
    .fg-target.fg-boss::before{
      background: radial-gradient(circle at 40% 35%, rgba(245,158,11,.22), transparent 60%);
    }

    .fg-target.rage{
      animation: ragePulse .55s ease-in-out infinite alternate;
    }
    @keyframes ragePulse{
      from{ transform: translate3d(var(--x,50vw),var(--y,50vh),0) translate(-50%,-50%) scale(1); }
      to  { transform: translate3d(var(--x,50vw),var(--y,50vh),0) translate(-50%,-50%) scale(1.06); }
    }

    /* boss bar */
    .bossbar{
      position:absolute;
      left:10%; right:10%;
      bottom:-8px;
      height:8px;
      border-radius:999px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .bossbar-fill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(245,158,11,.95), rgba(239,68,68,.95));
    }

    /* ===== RETICLE + LOCK RING + CHARGE RING ===== */
    .reticle{
      position:fixed;
      left:50%; top:52%;
      transform: translate(-50%,-50%);
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.55);
      box-shadow: 0 0 0 8px rgba(56,189,248,.08);
      pointer-events:none;
      z-index:10;
      opacity:.9;
    }

    .lockRing{
      position:fixed;
      width:84px; height:84px;
      left:50%; top:52%;
      transform: translate(-50%,-50%);
      border-radius:999px;
      pointer-events:none;
      z-index:11;
      opacity:0;
      transition: opacity .08s ease;
    }
    .lockRing.on{ opacity:1; }

    .lockRing::before{
      content:'';
      position:absolute; inset:0;
      border-radius:999px;
      background: conic-gradient(rgba(56,189,248,.95) var(--p,0%), rgba(255,255,255,.10) 0);
      mask: radial-gradient(circle, transparent 58%, #000 60%);
      -webkit-mask: radial-gradient(circle, transparent 58%, #000 60%);
      filter: drop-shadow(0 0 10px rgba(56,189,248,.25));
    }

    .chargeRing{
      position:fixed;
      width:108px; height:108px;
      left:50%; top:52%;
      transform: translate(-50%,-50%);
      border-radius:999px;
      pointer-events:none;
      z-index:11;
      opacity:0;
      transition: opacity .08s ease;
    }
    .chargeRing.on{ opacity:1; }

    .chargeRing::before{
      content:'';
      position:absolute; inset:0;
      border-radius:999px;
      background: conic-gradient(rgba(34,197,94,.95) var(--c,0%), rgba(255,255,255,.08) 0);
      mask: radial-gradient(circle, transparent 66%, #000 68%);
      -webkit-mask: radial-gradient(circle, transparent 66%, #000 68%);
      filter: drop-shadow(0 0 10px rgba(34,197,94,.22));
    }

    /* panic border */
    .panicBorder{
      position:fixed; inset:10px;
      border-radius:24px;
      border:2px solid rgba(239,68,68,.0);
      box-shadow: 0 0 0 0 rgba(239,68,68,.0);
      pointer-events:none;
      z-index:9;
      opacity:0;
    }
    .panicBorder.on{
      opacity:1;
      animation: panicFlash .55s ease-in-out infinite;
    }
    @keyframes panicFlash{
      0%{ border-color: rgba(239,68,68,.08); box-shadow: 0 0 0 0 rgba(239,68,68,.0); }
      50%{ border-color: rgba(239,68,68,.35); box-shadow: 0 0 0 8px rgba(239,68,68,.08); }
      100%{ border-color: rgba(239,68,68,.10); box-shadow: 0 0 0 0 rgba(239,68,68,.0); }
    }

    /* ===== AFTERIMAGE (2 SHADOWS) ‚Äî ‡πÇ‡∏ï‡∏ï‡∏≠‡∏ô‡∏´‡∏≤‡∏¢ ===== */
    .fg-afterimage{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      user-select:none;
      z-index: 5;
      transform: translate3d(0,0,0) translate(-50%,-50%);
      mix-blend-mode: screen;
    }
    .fg-afterimage-inner{
      display:inline-block;
      opacity:.42;
      filter: blur(.6px);
      transform: scale(0.92);
      will-change: transform, opacity;
      animation: fgAfterFadeScale 280ms ease-out forwards;
      text-shadow: 0 0 10px rgba(255,90,180,.18);
    }
    .fg-afterimage.a1 .fg-afterimage-inner{
      opacity:.34;
      filter: blur(.8px);
      transform: scale(0.90);
      animation-duration: 300ms;
      text-shadow: 0 0 12px rgba(255,90,180,.22);
    }
    .fg-afterimage.a2 .fg-afterimage-inner{
      opacity:.22;
      filter: blur(1.1px);
      transform: scale(0.88);
      animation-duration: 340ms;
      text-shadow: 0 0 14px rgba(255,90,180,.26);
    }
    @keyframes fgAfterFadeScale{
      0%   { opacity: 1;   transform: scale(0.90); }
      55%  { opacity: .55; transform: scale(1.06); }
      100% { opacity: 0;   transform: scale(1.26); }
    }

    /* ===== HUD ===== */
    .hud{
      position:fixed;
      left:14px; right:14px;
      top:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      z-index:12;
      pointer-events:none;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-width: 210px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .kpi{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    .kpi b{ color:var(--text); font-size:14px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius: var(--pill);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(2,6,23,.35);
      color:var(--text);
      font-size:13px;
    }
    .pill small{ color:var(--muted); }

    /* Coach + Quest */
    .hudRight{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .coachBox{ max-width: 430px; }
    #coachText{
      font-size:14px;
      color:var(--text);
      line-height:1.35;
    }
    #questGoal, #questMini{
      font-size:13px;
      color:var(--muted);
      line-height:1.25;
      margin-top:6px;
    }

    /* bottom controls */
    .bottom{
      position:fixed;
      left:14px; right:14px;
      bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:12;
      pointer-events:none;
    }
    .btnRow{
      display:flex; gap:10px;
      pointer-events:auto;
    }
    button{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 16px 34px rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .08s ease, filter .12s ease;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button.primary{
      background: linear-gradient(180deg, rgba(56,189,248,.35), rgba(56,189,248,.10));
      border:1px solid rgba(56,189,248,.35);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.32), rgba(239,68,68,.10));
      border:1px solid rgba(239,68,68,.35);
    }

    /* start overlay */
    .overlay{
      position:fixed; inset:0;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(900px 600px at 50% 20%, rgba(56,189,248,.16), transparent 60%),
                  rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .card{
      width:min(720px, 96vw);
      border-radius: 24px;
      background: rgba(2,6,23,.72);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 26px 70px rgba(0,0,0,.45);
      padding:18px;
    }
    .title{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0 0 6px 0;
    }
    .sub{
      margin:0 0 12px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .note{
      font-size:12px;
      color:rgba(226,232,240,.82);
      line-height:1.35;
    }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      font-size:13px;
    }
    .chip b{ font-size:14px; }

    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .hud{ flex-direction:column; align-items:stretch; }
      .hudRight{ align-items:stretch; }
      .panel{ min-width: unset; }
      .coachBox{ max-width: unset; }
    }
  </style>

  <!-- Global FX / Fever / HUD / Logger (IIFE) -->
  <script src="./vr/particles.js?v=121" defer></script>
  <script src="./vr/ui-fever.js?v=121" defer></script>
  <script src="./vr/hha-hud.js?v=121" defer></script>
  <script src="./vr/hha-cloud-logger.js?v=121" defer></script>

  <!-- Quest defs (IIFE attach window.GroupsQuest.createFoodGroupsQuest) -->
  <script src="./vr-groups/groups-quests.js?v=121" defer></script>

  <!-- GameEngine (IIFE attach window.GroupsVR.GameEngine) -->
  <script src="./vr-groups/GameEngine.js?v=121" defer></script>

  <!-- VR-look (drag + deviceorientation + inertia) -->
  <script>
  (function(){
    'use strict';
    if (!window.AFRAME) return;

    AFRAME.registerComponent('hha-vrlook', {
      schema: { drag: {default:true}, gyro:{default:true}, inertia:{default:0.86}, speed:{default:0.20} },
      init: function(){
        this.yaw = 0; this.pitch = 0;
        this.vYaw = 0; this.vPitch = 0;

        this.dragging = false;
        this.lastX = 0; this.lastY = 0;

        this._onDown = (e)=>{
          if (!this.data.drag) return;
          this.dragging = true;
          const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
          this.lastX = p.clientX; this.lastY = p.clientY;
        };
        this._onMove = (e)=>{
          if (!this.data.drag || !this.dragging) return;
          const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
          const dx = (p.clientX - this.lastX);
          const dy = (p.clientY - this.lastY);
          this.lastX = p.clientX; this.lastY = p.clientY;

          const s = this.data.speed;
          this.vYaw   += dx * s;
          this.vPitch += dy * s;
        };
        this._onUp = ()=>{ this.dragging = false; };

        window.addEventListener('pointerdown', this._onDown, {passive:true});
        window.addEventListener('pointermove', this._onMove, {passive:true});
        window.addEventListener('pointerup',   this._onUp,   {passive:true});
        window.addEventListener('touchstart',  this._onDown, {passive:true});
        window.addEventListener('touchmove',   this._onMove, {passive:true});
        window.addEventListener('touchend',    this._onUp,   {passive:true});

        this._onOri = (e)=>{
          if (!this.data.gyro) return;
          const a = (e.alpha||0), b = (e.beta||0);
          let yaw = ((a + 180) % 360) - 180;
          let pitch = Math.max(-75, Math.min(75, b - 20));
          this._gyroYaw = yaw;
          this._gyroPitch = pitch;
        };
        window.addEventListener('deviceorientation', this._onOri, true);

        this._gyroYaw = null;
        this._gyroPitch = null;
      },
      tick: function(){
        const inertia = Math.max(0.70, Math.min(0.95, this.data.inertia));
        this.vYaw *= inertia;
        this.vPitch *= inertia;

        this.yaw += this.vYaw * 0.016;
        this.pitch += this.vPitch * 0.016;

        this.pitch = Math.max(-75, Math.min(75, this.pitch));

        if (this.data.gyro && this._gyroYaw !== null){
          this.yaw   = (this.yaw   * 0.94) + (this._gyroYaw   * 0.06);
          this.pitch = (this.pitch * 0.94) + (this._gyroPitch * 0.06);
        }

        this.el.setAttribute('rotation', { x: this.pitch, y: this.yaw, z: 0 });
      },
      remove: function(){
        window.removeEventListener('pointerdown', this._onDown);
        window.removeEventListener('pointermove', this._onMove);
        window.removeEventListener('pointerup',   this._onUp);
        window.removeEventListener('touchstart',  this._onDown);
        window.removeEventListener('touchmove',   this._onMove);
        window.removeEventListener('touchend',    this._onUp);
        window.removeEventListener('deviceorientation', this._onOri, true);
      }
    });
  })();
  </script>
</head>

<body>
  <!-- A-Frame scene (camera rotation used by engine) -->
  <div class="sceneWrap">
    <a-scene
      embedded
      vr-mode-ui="enabled: true"
      renderer="antialias: true; colorManagement: true"
      background="color: #020617">

      <a-sky color="#020617"></a-sky>

      <a-entity id="rig" position="0 1.6 0">
        <a-entity id="cam"
          camera
          look-controls="enabled:false"
          hha-vrlook="drag:true; gyro:true; inertia:0.86; speed:0.22">
        </a-entity>
      </a-entity>
    </a-scene>
  </div>

  <!-- DOM targets layer -->
  <div id="fg-layer" aria-label="targets"></div>

  <!-- overlay UI -->
  <div class="ui">
    <div class="panicBorder" id="panicBorder"></div>
    <div class="reticle" id="reticle"></div>
    <div class="lockRing" id="lockRing" style="--p:0%"></div>
    <div class="chargeRing" id="chargeRing" style="--c:0%"></div>

    <!-- HUD top -->
    <div class="hud">
      <div class="panel">
        <div class="row">
          <div class="pill"><small>‡πÄ‡∏ß‡∏•‡∏≤</small> <b id="hudTime">--</b></div>
          <div class="pill"><small>‡πÄ‡∏Å‡∏£‡∏î</small> <b id="hudGrade">C</b></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <b id="hudScore">0</b></span>
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö <b id="hudCombo">0</b></span>
          <span>MISS <b id="hudMiss">0</b></span>
          <span>‡πÇ‡∏•‡πà <b id="hudShield">0</b></span>
        </div>
      </div>

      <div class="hudRight">
        <div class="panel coachBox">
          <div id="coachText">‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ üí´ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á)</div>
          <div id="questGoal">GOAL: ‚Äî</div>
          <div id="questMini">MINI: ‚Äî</div>
        </div>
      </div>
    </div>

    <!-- bottom controls -->
    <div class="bottom">
      <div class="note">
        <div class="chip"><b>LOCK</b> ‡∏à‡πâ‡∏≠‡∏á‡∏à‡∏ô‡∏ß‡∏á‡∏ü‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° ‚Üí ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î</div>
        <div class="chip"><b>CHARGE</b> ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏¢‡∏¥‡∏á‡πÅ‡∏£‡∏á + Piercing ‡πÅ‡∏ö‡∏ö Cone</div>
      </div>

      <div class="btnRow">
        <button id="btnToggleGaze" class="primary">Gaze: ON</button>
        <button id="btnStop" class="danger">STOP</button>
      </div>
    </div>
  </div>

  <!-- start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <h1 class="title">Food Groups VR ‚Äî ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á üî•</h1>
      <p class="sub">
        ‡πÅ‡∏ï‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà (aim assist) + ‡∏à‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î + ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏¢‡∏¥‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡πÅ‡∏ö‡∏ö Cone<br>
        <b>Rage = Double-Feint</b> (‡∏´‡∏•‡∏≠‡∏Å 2 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‚Ä¢ <b>Decoy = Invert</b> (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß MISS)
      </p>
      <div class="grid">
        <div class="chip">üéöÔ∏è Difficulty: <b id="uiDiff">normal</b></div>
        <div class="chip">‚è±Ô∏è Time: <b id="uiTime">70</b> sec</div>
        <div class="chip">üß™ Run: <b id="uiRun">play</b></div>
        <div class="chip">üìù Log: <b id="uiLog">auto</b></div>
      </div>

      <p class="note" style="margin-top:12px">
        Tips: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Äú‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‚Äù ‡πÑ‡∏î‡πâ (gyro) / ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÑ‡∏î‡πâ (drag). ‡∏ñ‡πâ‡∏≤ iOS ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå motion ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï.
      </p>

      <div class="btnRow" style="margin-top:12px; justify-content:flex-end;">
        <button id="btnStart" class="primary">START</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    function qs(sel){ return document.querySelector(sel); }
    const URLX = new URL(location.href);

    const diff = (URLX.searchParams.get('diff') || 'normal').toLowerCase();
    const time = parseInt(URLX.searchParams.get('time') || '70', 10) || 70;
    const run  = (URLX.searchParams.get('run') || 'play').toLowerCase();
    const log  = (URLX.searchParams.get('log') || (sessionStorage.getItem('HHA_LOGGER_ENDPOINT')||'') || 'auto');

    qs('#uiDiff').textContent = diff;
    qs('#uiTime').textContent = String(time);
    qs('#uiRun').textContent  = run;
    qs('#uiLog').textContent  = log ? (log==='auto'?'auto':'custom') : 'off';

    const layerEl = qs('#fg-layer');
    const camEl = qs('#cam');
    const overlay = qs('#startOverlay');

    // UI hooks
    const lockRing = qs('#lockRing');
    const chargeRing = qs('#chargeRing');
    const panicBorder = qs('#panicBorder');

    window.addEventListener('groups:lock', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const on = !!d.on;
      lockRing.classList.toggle('on', on);
      chargeRing.classList.toggle('on', on);

      const p = Math.max(0, Math.min(1, Number(d.prog||0)));
      const c = Math.max(0, Math.min(1, Number(d.charge||0)));
      lockRing.style.setProperty('--p', Math.round(p*100) + '%');
      chargeRing.style.setProperty('--c', Math.round(c*100) + '%');
    });

    window.addEventListener('hha:panic', (e)=>{
      const d = e && e.detail ? e.detail : {};
      panicBorder.classList.toggle('on', !!d.on);
    });

    window.addEventListener('hha:time', (e)=>{
      const d = e && e.detail ? e.detail : {};
      if (typeof d.left === 'number') qs('#hudTime').textContent = String(d.left);
    });

    window.addEventListener('hha:score', (e)=>{
      const d = e && e.detail ? e.detail : {};
      if (typeof d.score === 'number') qs('#hudScore').textContent = String(d.score);
      if (typeof d.combo === 'number') qs('#hudCombo').textContent = String(d.combo);
      if (typeof d.misses === 'number') qs('#hudMiss').textContent = String(d.misses);
      if (typeof d.shield === 'number') qs('#hudShield').textContent = String(d.shield);
    });

    window.addEventListener('hha:rank', (e)=>{
      const d = e && e.detail ? e.detail : {};
      if (d.grade) qs('#hudGrade').textContent = String(d.grade);
    });

    window.addEventListener('hha:coach', (e)=>{
      const d = e && e.detail ? e.detail : {};
      if (d.text) qs('#coachText').textContent = String(d.text);
    });

    window.addEventListener('quest:update', (e)=>{
      const d = e && e.detail ? e.detail : {};
      const g = d.goal ? (`GOAL: ${d.goal.label} (${d.goal.prog}/${d.goal.target})`) : 'GOAL: ‚Äî';
      const m = d.mini ? (`MINI: ${d.mini.label} (${d.mini.prog}/${d.mini.target})`) : 'MINI: ‚Äî';
      qs('#questGoal').textContent = g;
      qs('#questMini').textContent = m;
    });

    function requestMotionPermissionIfNeeded(){
      // iOS requires permission sometimes
      try{
        const DM = window.DeviceMotionEvent;
        const DO = window.DeviceOrientationEvent;
        const asks = [];
        if (DM && typeof DM.requestPermission === 'function') asks.push(DM.requestPermission());
        if (DO && typeof DO.requestPermission === 'function') asks.push(DO.requestPermission());
        if (!asks.length) return Promise.resolve();
        return Promise.allSettled(asks).then(()=>{});
      }catch{
        return Promise.resolve();
      }
    }

    function safeStart(){
      const eng = window.GroupsVR && window.GroupsVR.GameEngine;
      if (!eng) { alert('GameEngine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î'); return; }

      eng.setLayerEl(layerEl);
      eng.setCameraEl(camEl);
      eng.setTimeLeft(time);

      overlay.style.display = 'none';
      eng.start(diff, { runMode: run });

      qs('#btnToggleGaze').textContent = 'Gaze: ON';
      qs('#btnToggleGaze').dataset.on = '1';
    }

    qs('#btnStart').addEventListener('click', ()=>{
      requestMotionPermissionIfNeeded().finally(()=>safeStart());
    });

    qs('#btnStop').addEventListener('click', ()=>{
      const eng = window.GroupsVR && window.GroupsVR.GameEngine;
      if (eng) eng.stop('user_stop');
      overlay.style.display = 'flex';
    });

    qs('#btnToggleGaze').addEventListener('click', ()=>{
      const eng = window.GroupsVR && window.GroupsVR.GameEngine;
      if (!eng) return;
      const on = (qs('#btnToggleGaze').dataset.on === '1');
      eng.setGaze(!on);
      qs('#btnToggleGaze').dataset.on = on ? '0' : '1';
      qs('#btnToggleGaze').textContent = on ? 'Gaze: OFF' : 'Gaze: ON';
    });
  })();
  </script>
</body>
</html>