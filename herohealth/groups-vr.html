<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (classic scripts) ‚Äî HARD+++
‚úÖ FIX: #fg-layer id ‡∏ï‡∏£‡∏á + pointer-events ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞‡∏ï‡∏¥‡∏î
‚úÖ FIX: End summary + Back HUB + save HHA_LAST_SUMMARY
‚úÖ FIX: Deterministic seed (sessionId/studentKey/ts)
‚úÖ HHA Standard-ish: emits hha:log_session + hha:end + stores last summary
‚úÖ DIFFERENCE: ‚ÄúGOOD ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∑‡πà‡∏ô‚Äù ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (wrong-good) ‚Üí ‡πÄ‡∏Å‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- A-Frame (optional bg) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Optional global logger / fever (safe if missing) -->
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/ui-fever.js" defer></script>

  <!-- ‚úÖ alias css -->
  <link rel="stylesheet" href="./groups.css" />
</head>

<body>
  <!-- Background -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true">
    <a-sky color="#06101f"></a-sky>
    <a-entity position="0 1.6 0" camera look-controls></a-entity>
  </a-scene>

  <!-- Targets layer -->
  <div id="fg-layer"></div>

  <!-- HUD -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card hud-left">
        <div class="hud-row"><div class="hud-title">SCORE</div><div class="hud-val" id="hud-score">0</div></div>
        <div class="hud-row"><div class="hud-title">COMBO</div><div class="hud-val" id="hud-combo">0</div></div>
        <div class="hud-row"><div class="hud-title">MISS</div><div class="hud-val" id="hud-miss">0</div></div>
      </div>

      <div class="hud-card hud-mid">
        <div class="hud-group-row">
          <div class="hud-group" id="hud-group">‡∏´‡∏°‡∏π‡πà ?</div>
          <div class="hud-timer" id="hud-time">90</div>
        </div>

        <div class="power-wrap">
          <div class="power-label">
            <div>POWER</div>
            <div id="fg-powerText" style="font-weight:1000;opacity:.9">0/0</div>
          </div>
          <div class="power-bar"><div class="power-fill" id="hud-powerFill"></div></div>
        </div>

        <div class="quest-wrap">
          <!-- GOAL -->
          <div class="quest-line">
            <div class="q-badge">GOAL</div>
            <div class="q-text" id="hud-goal-title">‚Äî</div>
            <div class="q-num" id="hud-goal-val">0/0</div>
          </div>
          <div class="qbar"><div class="qbar-track"><div class="qbar-fill goal" id="hud-goal-bar"></div></div></div>

          <!-- MINI -->
          <div class="quest-line">
            <div class="q-badge mini">MINI</div>
            <div class="q-text" id="hud-mini-title">‚Äî</div>
            <div class="q-num" id="hud-mini-val">0/0</div>
          </div>
          <div class="qbar">
            <div class="qbar-track"><div class="qbar-fill mini" id="hud-mini-bar"></div></div>
            <div class="qbar-timer" id="hud-mini-timer"></div>
          </div>
        </div>
      </div>

      <div class="hud-card hud-right">
        <div class="rank-box">
          <div>
            <div class="rank-title">RANK</div>
            <div class="rank-sub"><span>ACC</span><span id="hud-acc">0%</span></div>
          </div>
          <div class="rank-grade" id="hud-rank">C</div>
        </div>
        <div class="rank-sub"><span>BEST</span><span id="hud-comboMax">0</span></div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div class="coach-avatar" id="coach-face">ü•¶</div>
        <div>
          <div class="coach-text" id="coach-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô!</div>
          <div class="coach-sub" id="coach-sub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∑‡πà‡∏ô</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div class="start-overlay" id="startOverlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è (‡πÇ‡∏´‡∏î+++)</div>
      <div class="start-sub">
        ‚úÖ ‡∏¢‡∏¥‡∏á ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üéØ<br/>
        ‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∑‡πà‡∏ô ‚Äú‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‚Äù (wrong-good) ‚Üí ‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß COMBO ‡πÅ‡∏ï‡∏Å + MISS ‡πÄ‡∏û‡∏¥‡πà‡∏°<br/>
        üö´ ‡∏Ç‡∏¢‡∏∞ = STUN / ‚ùì decoy = ‡∏´‡∏•‡∏≠‡∏Å / üëπ boss = ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>

      <div class="start-grid">
        <div class="pill" id="pill-diff">DIFF: normal</div>
        <div class="pill" id="pill-time">TIME: 90s</div>
        <div class="pill" id="pill-mode">MODE: play</div>
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn ghost" id="btnRestart">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>

      <div class="start-note">
        Tip: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ / ‡πÅ‡∏ï‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (hold-lock)
      </div>
    </div>
  </div>

  <!-- End Summary -->
  <div class="fg-end" id="fg-end">
    <div class="fg-end-card">
      <h2 class="fg-end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Food Groups VR</h2>
      <div class="fg-end-grid">
        <div class="fg-end-item"><div class="fg-end-k">Score</div><div class="fg-end-v" id="end-score">0</div></div>
        <div class="fg-end-item"><div class="fg-end-k">Rank</div><div class="fg-end-v" id="end-grade">C</div></div>
        <div class="fg-end-item"><div class="fg-end-k">Combo Max</div><div class="fg-end-v" id="end-combo">0</div></div>
        <div class="fg-end-item"><div class="fg-end-k">Miss</div><div class="fg-end-v" id="end-miss">0</div></div>
        <div class="fg-end-item"><div class="fg-end-k">Goals</div><div class="fg-end-v" id="end-goals">0/0</div></div>
        <div class="fg-end-item"><div class="fg-end-k">Mini</div><div class="fg-end-v" id="end-minis">0/0</div></div>
      </div>
      <div class="fg-end-actions">
        <button class="btn primary" id="btn-retry">RETRY</button>
        <button class="btn" id="btn-backhub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== Scripts (classic order) ===== -->
  <script src="./groups-fx.js"></script>
  <script src="./groups-quests.js"></script>
  <script src="./groups-hud-quest.js"></script>
  <script src="./GameEngine.js"></script>

  <!-- Boot -->
  <script>
  (function(){
    'use strict';

    const qs = new URLSearchParams(location.search);
    const get = (k,d='') => qs.has(k) ? String(qs.get(k)??'') : d;
    const int = (k,d) => { const v=parseInt(get(k,d),10); return Number.isFinite(v)?v:d; };

    const diff = String(get('diff','normal')).toLowerCase();
    const time = int('time', 90);
    const run  = String(get('run','play')).toLowerCase();
    const hub  = String(get('hub','../hub.html') || '../hub.html');

    // deterministic seed
    const SEED = (get('sessionId','') || get('studentKey','') || 'anon') + '|' + String(get('ts', Date.now()));

    // pills
    document.getElementById('pill-diff').textContent = 'DIFF: ' + diff;
    document.getElementById('pill-time').textContent = 'TIME: ' + time + 's';
    document.getElementById('pill-mode').textContent = 'MODE: ' + run;

    // Start controls
    const overlay = document.getElementById('startOverlay');
    const btnStart = document.getElementById('btnStart');
    const btnRestart = document.getElementById('btnRestart');

    const endOverlay = document.getElementById('fg-end');
    const btnRetry = document.getElementById('btn-retry');
    const btnBack = document.getElementById('btn-backhub');

    function saveLastSummary(sum){
      try{
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(sum||{}));
        localStorage.setItem('hha_last_summary', JSON.stringify(sum||{}));
      }catch(e){}
    }

    function showEnd(sum){
      if (!sum) sum = {};
      saveLastSummary(sum);

      document.getElementById('end-score').textContent = String(sum.scoreFinal ?? 0);
      document.getElementById('end-grade').textContent = String(sum.grade ?? 'C');
      document.getElementById('end-combo').textContent = String(sum.comboMax ?? 0);
      document.getElementById('end-miss').textContent = String(sum.misses ?? 0);
      document.getElementById('end-goals').textContent = `${sum.goalsCleared ?? 0}/${sum.goalsTotal ?? 0}`;
      document.getElementById('end-minis').textContent = `${sum.miniCleared ?? 0}/${sum.miniTotal ?? 0}`;

      endOverlay.classList.add('show');
    }

    btnRetry.addEventListener('click', ()=> location.reload(), { passive:true });
    btnBack.addEventListener('click', ()=>{
      try{
        const u = new URL(hub, location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }catch(e){
        location.href = hub;
      }
    }, { passive:true });

    window.addEventListener('hha:end', (ev)=>{
      const sum = (ev && ev.detail) ? ev.detail : {};
      showEnd(sum);
    }, { passive:true });

    function boot(){
      const engine = window.GroupsVR && window.GroupsVR.GameEngine;
      if (!engine){ alert('GroupsVR.GameEngine not found'); return; }

      // session markers for logger
      try{
        window.dispatchEvent(new CustomEvent('hha:log_session', { detail: { phase:'start', game:'groups', diff, runMode:run, seed:SEED } }));
      }catch(e){}

      engine.setLayerEl(document.getElementById('fg-layer'));
      engine.setTimeLeft(time);
      engine.start(diff, { runMode: run, seed: SEED });
    }

    btnStart.addEventListener('click', ()=>{
      overlay.style.display = 'none';
      boot();
    }, { passive:true });

    btnRestart.addEventListener('click', ()=> location.reload(), { passive:true });

    if (get('autostart','0') === '1'){
      overlay.style.display = 'none';
      boot();
    }
  })();
  </script>
</body>
</html>
