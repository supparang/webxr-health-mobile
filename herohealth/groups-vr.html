<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION FULL HTML
‚úÖ Uses DOM targets (emoji) on #fg-layer
‚úÖ Loads: particles -> quests -> hudQuest -> engine -> lock ring binder -> basic HUD binder
‚úÖ Start overlay + Safe mobile viewport
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (scene optional; gameplay is DOM overlay) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./vr-groups/groups-vr.css" />

  <!-- FX (global) -->
  <script src="./vr/particles.js" defer></script>

  <!-- Quest + HUD Quest binder -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/groups-hud-quest.js" defer></script>

  <!-- Engine -->
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* ensure layer sits above A-Frame canvas */
    .fg-layer { z-index: 6; }
    .start-overlay { z-index: 30; }
    .lock-ring { display:none; }
    .lock-ring.on { display:block; }
  </style>
</head>

<body>

  <!-- Optional A-Frame scene (kept minimal) -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true">
    <a-entity camera look-controls position="0 1.6 0"></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- Gameplay DOM layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- HUD (top) -->
  <div class="hud-top">
    <div class="hud-card hud-left">
      <div class="hud-row"><div class="hud-title">SCORE</div><div id="hud-score" class="hud-val">0</div></div>
      <div class="hud-row"><div class="hud-title">COMBO</div><div id="hud-combo" class="hud-val">0</div></div>
      <div class="hud-row"><div class="hud-title">MISS</div><div id="hud-miss" class="hud-val">0</div></div>
    </div>

    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div id="hud-group" class="hud-group">‡∏´‡∏°‡∏π‡πà 1</div>
        <div id="hud-time" class="hud-timer">90</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <div id="hud-powerLabel">Power</div>
          <div id="hud-powerNum">0/7</div>
        </div>
        <div class="power-bar"><div id="hud-powerFill" class="power-fill"></div></div>
      </div>

      <div class="quest-wrap">
        <div class="quest-line">
          <div class="q-badge">GOAL</div>
          <div id="hud-goal-title" class="q-text">‚Äî</div>
          <div id="hud-goal-val" class="q-num">0/0</div>
        </div>
        <div class="quest-line">
          <div class="q-badge mini">MINI</div>
          <div id="hud-mini-title" class="q-text">‚Äî</div>
          <div id="hud-mini-val" class="q-num">0/0</div>
        </div>
      </div>
    </div>

    <div class="hud-card hud-right">
      <div class="rank-box">
        <div>
          <div class="rank-title">RANK</div>
          <div id="hud-grade" class="rank-grade">C</div>
        </div>
        <div style="text-align:right">
          <div class="rank-title">ACC</div>
          <div id="hud-acc" class="hud-val">0%</div>
        </div>
      </div>
      <div class="rank-sub">
        <div>Quests</div>
        <div id="hud-questsPct">0%</div>
      </div>
    </div>
  </div>

  <!-- Group banner -->
  <div id="groupBanner" class="group-banner" style="display:none">
    <div id="groupBannerText" class="group-banner-text">‡∏´‡∏°‡∏π‡πà 1</div>
    <div id="groupBannerSub" class="group-banner-sub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
  </div>

  <!-- Lock ring -->
  <div id="lockRing" class="lock-ring">
    <div class="lock-core"></div>
    <div class="lock-prog"></div>
    <div class="lock-charge"></div>
  </div>

  <!-- Stun overlay -->
  <div id="stunOverlay" class="stun-overlay" style="display:none">
    <div class="stun-card">
      <div class="stun-title">STUN!</div>
      <div class="stun-sub">‡πÇ‡∏î‡∏ô‡∏Ç‡∏¢‡∏∞‡πÅ‡∏•‡πâ‡∏ß üòµ‚Äçüí´</div>
    </div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‚ö°<br/>
        ‡∏£‡∏∞‡∏ß‡∏±‡∏á Junk (‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß STUN) ‡πÅ‡∏•‡∏∞ Decoy (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏î‡∏µ‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏≠‡∏Å) üëÄ
      </div>

      <div class="start-grid">
        <div class="pill">üéØ Lock = ‡∏Ñ‡πâ‡∏≤‡∏á/‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤</div>
        <div class="pill">üëÜ Tap = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
        <div class="pill">‚ö° Power ‡πÄ‡∏ï‡πá‡∏° = ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏π‡πà</div>
        <div class="pill">üß† Boss ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>

      <div class="start-actions">
        <button id="btnPlay" class="btn primary" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° (Play)</button>
        <button id="btnResearch" class="btn" type="button">üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏° (Research)</button>
        <button id="btnReset" class="btn ghost" type="button">‚Üª ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>

      <div class="start-note">
        Tip: ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á seed ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πà‡∏ô ?run=research&seed=CRU01
      </div>
    </div>
  </div>

  <script>
  // === inline binders (keep html self-contained) ===
  (function(){
    'use strict';

    function $(id){ return document.getElementById(id); }
    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }

    // ----- Lock ring binder -----
    const ring = $('lockRing');
    function setRing(on, x, y, p, c){
      if (!ring) return;
      if (!on){
        ring.classList.remove('on');
        return;
      }
      ring.classList.add('on');
      ring.style.left = (x|0) + 'px';
      ring.style.top  = (y|0) + 'px';
      ring.style.transform = 'translate(-50%,-50%)';
      ring.style.setProperty('--p', clamp(p,0,1));
      ring.style.setProperty('--c', clamp(c,0,1));
    }

    window.addEventListener('groups:lock', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      setRing(!!d.on, d.x||0, d.y||0, d.prog||0, d.charge||0);
    }, { passive:true });

    // ----- HUD basic binder -----
    const elScore = $('hud-score');
    const elCombo = $('hud-combo');
    const elMiss  = $('hud-miss');
    const elTime  = $('hud-time');
    const elGroup = $('hud-group');

    const elGrade = $('hud-grade');
    const elAcc   = $('hud-acc');
    const elQuestsPct = $('hud-questsPct');

    const elPowerFill = $('hud-powerFill');
    const elPowerNum  = $('hud-powerNum');
    const elPowerLabel= $('hud-powerLabel');

    const banner = $('groupBanner');
    const bannerText = $('groupBannerText');

    const stunOverlay = $('stunOverlay');

    window.addEventListener('hha:score', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if (elScore) elScore.textContent = String(d.score|0);
      if (elCombo) elCombo.textContent = String(d.combo|0);
      if (elMiss)  elMiss.textContent  = String(d.misses|0);
    }, { passive:true });

    window.addEventListener('hha:time', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if (elTime) elTime.textContent = String(d.left|0);

      // panic class when low
      if ((d.left|0) <= 10) document.documentElement.classList.add('panic');
      else document.documentElement.classList.remove('panic');
    }, { passive:true });

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if (d.grade && elGrade) elGrade.textContent = String(d.grade);
      if (typeof d.accuracy === 'number' && elAcc) elAcc.textContent = String(d.accuracy|0) + '%';
      if (typeof d.questsPct === 'number' && elQuestsPct) elQuestsPct.textContent = String(d.questsPct|0) + '%';
    }, { passive:true });

    window.addEventListener('groups:group_change', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      const label = String(d.label || '');
      if (elGroup) elGroup.textContent = label || '‡∏´‡∏°‡∏π‡πà ?';

      if (banner && bannerText){
        bannerText.textContent = label || '‡∏´‡∏°‡∏π‡πà ?';
        banner.style.display = '';
        banner.classList.remove('pop');
        void banner.offsetWidth; // reflow
        banner.classList.add('pop');
        setTimeout(()=>{ try{ banner.style.display='none'; }catch(_){} }, 900);
      }
    }, { passive:true });

    window.addEventListener('groups:power', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      const c = (d.charge|0);
      const th = Math.max(1, d.threshold|0);
      const p = clamp(c / th, 0, 1);

      if (elPowerFill){
        elPowerFill.style.width = Math.round(p*100) + '%';
        elPowerFill.classList.remove('pulse');
        void elPowerFill.offsetWidth;
        elPowerFill.classList.add('pulse');
      }
      if (elPowerNum) elPowerNum.textContent = `${c}/${th}`;
      if (elPowerLabel) elPowerLabel.textContent = d.groupName ? `Power: ${d.groupName}` : 'Power';
    }, { passive:true });

    window.addEventListener('groups:stun', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      if (!stunOverlay) return;
      if (d.on){
        stunOverlay.style.display = '';
        stunOverlay.classList.remove('pop');
        void stunOverlay.offsetWidth;
        stunOverlay.classList.add('pop');
        setTimeout(()=>{ try{ stunOverlay.style.display='none'; }catch(_){} }, (d.ms|0) || 800);
      }
    }, { passive:true });

    // ----- Start overlay actions -----
    function parseQS(){
      const p = new URLSearchParams(location.search);
      return {
        diff: (p.get('diff')||'normal').toLowerCase(),
        time: parseInt(p.get('time')||'90',10) || 90,
        run: (p.get('run')||'play').toLowerCase(),
        seed: p.get('seed') || ''
      };
    }

    function boot(runMode){
      const qs = parseQS();
      const diff = qs.diff;
      const time = qs.time;

      const layer = $('fg-layer');
      if (!layer || !window.GroupsVR || !window.GroupsVR.GameEngine){
        alert('Engine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ path ‡πÑ‡∏ü‡∏•‡πå)');
        return;
      }

      window.GroupsVR.GameEngine.setLayerEl(layer);
      window.GroupsVR.GameEngine.setTimeLeft(time);
      window.GroupsVR.GameEngine.start(diff, {
        runMode: runMode || qs.run,
        seed: qs.seed || ''
      });

      const so = $('startOverlay');
      if (so) so.style.display = 'none';
    }

    const btnPlay = $('btnPlay');
    const btnResearch = $('btnResearch');
    const btnReset = $('btnReset');

    if (btnPlay) btnPlay.addEventListener('click', ()=>boot('play'));
    if (btnResearch) btnResearch.addEventListener('click', ()=>boot('research'));
    if (btnReset) btnReset.addEventListener('click', ()=>location.reload());

  })();
  </script>

</body>
</html>