<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX must be BEFORE boot (IIFE listens events) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- (optional) logger -->
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --gold:#fbbf24;
      --cyan:#22d3ee;
      --purple:#a78bfa;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }

    /* A-Frame canvas behind UI */
    a-scene{ position:fixed; inset:0; z-index:0; }

    /* ======= HUD / UI ======= */
    .ui{ position:fixed; inset:0; z-index:10; pointer-events:none; }
    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      position:fixed; left:10px; right:10px; top:10px;
      display:flex; gap:10px; align-items:stretch;
      pointer-events:none;
    }
    .box{
      padding:10px 12px;
      display:flex; gap:10px; align-items:center;
      min-height:54px;
    }
    .grow{ flex:1; min-width:0; }
    .k{ color:var(--muted); font-size:12px; line-height:1; }
    .v{ font-size:16px; font-weight:800; line-height:1.1; letter-spacing:.2px; }
    .v.small{ font-size:14px; font-weight:750; }
    .mono{ font-variant-numeric: tabular-nums; }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.55);
      font-size:12px; color:var(--muted);
    }
    .chip b{ color:var(--text); }

    .quest{
      flex:1;
      display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .qline{ display:flex; justify-content:space-between; gap:10px; min-width:0; }
    .qname{
      font-size:13px; font-weight:800;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .qprog{ font-size:12px; color:var(--muted); }
    .bar{
      height:10px; border-radius:999px;
      background:rgba(148,163,184,.16);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, var(--good), var(--cyan));
      border-radius:999px;
    }
    .bar.mini > i{ background:linear-gradient(90deg, var(--gold), var(--purple)); }

    /* Bottom summary strip */
    .bottombar{
      position:fixed; left:10px; right:10px; bottom:10px;
      display:flex; gap:10px; align-items:stretch;
      pointer-events:none;
    }
    .coach{
      flex:1; min-width:0;
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
    }
    .coach img{
      width:44px; height:44px; border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      object-fit:cover;
    }
    .coach .msg{
      min-width:0;
      font-size:13px; color:var(--text);
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .rightbox{
      width:220px;
      padding:10px 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .rankRow{ display:flex; justify-content:space-between; gap:10px; }
    .rankBadge{
      display:inline-flex; align-items:center; justify-content:center;
      width:54px; height:32px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.55);
      font-weight:900;
      letter-spacing:.5px;
    }

    /* ======= TARGET LAYER (DOM) ======= */
    #fg-layer{
      position:fixed; inset:0;
      z-index:6;
      pointer-events:auto; /* allow tapping targets */
      touch-action:manipulation;
    }
    .fg-target{
      position:absolute;
      left:var(--x); top:var(--y);
      transform: translate(-50%,-50%) scale(var(--s,1));
      width:132px; height:132px;
      display:flex; align-items:center; justify-content:center;
      font-size:72px; line-height:1;
      user-select:none;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      will-change: transform, left, top;
    }
    .fg-target.fg-good{ text-shadow:0 0 18px rgba(34,197,94,.25); }
    .fg-target.fg-junk{ text-shadow:0 0 18px rgba(239,68,68,.22); }
    .fg-target.fg-boss{ filter: drop-shadow(0 14px 26px rgba(0,0,0,.45)); }

    .fg-target.spawn{ opacity:.0; transform:translate(-50%,-50%) scale(.75); }
    .fg-target.show{ opacity:1; transform:translate(-50%,-50%) scale(var(--s,1)); transition: opacity .12s ease, transform .14s ease; }
    .fg-target.hit{ opacity:.0; transform:translate(-50%,-50%) scale(1.25); transition: opacity .18s ease, transform .18s ease; }
    .fg-target.out{ opacity:.0; transform:translate(-50%,-50%) scale(.70); transition: opacity .22s ease, transform .22s ease; }

    /* boss HP bar */
    .bossbar{
      position:absolute; left:50%; bottom:-10px;
      width:78%; height:10px;
      transform:translateX(-50%);
      background:rgba(148,163,184,.18);
      border:1px solid rgba(148,163,184,.24);
      border-radius:999px;
      overflow:hidden;
    }
    .bossbar-fill{
      width:100%; height:100%;
      background:linear-gradient(90deg, var(--bad), var(--gold));
    }

    /* ======= PANIC EDGE PULSE ======= */
    #edgePulse{
      position:fixed; inset:0;
      z-index:12;
      pointer-events:none;
      opacity:0;
      transition: opacity .18s ease;
      border-radius:18px;
      box-shadow: inset 0 0 0 2px rgba(239,68,68,.0);
    }
    #edgePulse.on{ opacity:1; }
    #edgePulse.on{
      box-shadow:
        inset 0 0 0 2px rgba(239,68,68,.22),
        inset 0 0 18px rgba(239,68,68,.18);
    }
    #edgePulse.beat{
      animation: edgeBeat .35s ease;
    }
    @keyframes edgeBeat{
      0%{ box-shadow: inset 0 0 0 2px rgba(239,68,68,.22), inset 0 0 18px rgba(239,68,68,.18); }
      50%{ box-shadow: inset 0 0 0 2px rgba(251,191,36,.25), inset 0 0 28px rgba(239,68,68,.26); }
      100%{ box-shadow: inset 0 0 0 2px rgba(239,68,68,.22), inset 0 0 18px rgba(239,68,68,.18); }
    }

    /* ======= LOCK RING ======= */
    #lockUI{
      position:fixed; inset:0;
      z-index:11;
      pointer-events:none;
    }
    .lockRing{
      position:absolute;
      left:0; top:0;
      width:78px; height:78px;
      transform: translate(-50%,-50%);
      border-radius:999px;
      border:2px solid rgba(34,197,94,.22);
      box-shadow: 0 0 22px rgba(34,197,94,.16);
      opacity:0;
      transition: opacity .12s ease;
    }
    .lockRing.on{ opacity:1; }
    .lockRing.boss{ border-color: rgba(239,68,68,.24); box-shadow: 0 0 22px rgba(239,68,68,.18); }
    .lockRing.decoy{ border-color: rgba(251,191,36,.26); box-shadow: 0 0 22px rgba(251,191,36,.18); }
    .lockProg{
      position:absolute; inset:6px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,.16);
      overflow:hidden;
    }
    .lockProg > i{
      display:block; height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--good), var(--cyan));
    }
    .chargeBar{
      position:absolute; left:50%; top:calc(100% + 8px);
      transform:translateX(-50%);
      width:94px; height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.16);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
      opacity:.85;
    }
    .chargeBar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, var(--gold), var(--purple));
    }

    /* ======= START OVERLAY ======= */
    #startOverlay{
      position:fixed; inset:0;
      z-index:30;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: radial-gradient(1200px 800px at 50% 30%, rgba(34,211,238,.08), transparent 55%),
                  radial-gradient(1200px 800px at 50% 70%, rgba(34,197,94,.08), transparent 55%),
                  rgba(2,6,23,.86);
      backdrop-filter: blur(14px);
      pointer-events:auto;
    }
    .card{
      width:min(720px, 96vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.24);
      background:rgba(2,6,23,.70);
      box-shadow: 0 24px 60px rgba(0,0,0,.45);
      padding:16px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }
    .h1{ font-size:18px; font-weight:900; margin:0 0 6px; }
    .p{ margin:0 0 12px; color:var(--muted); font-size:13px; }
    label{ font-size:12px; color:var(--muted); display:block; margin:8px 0 6px; }
    input, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.65);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:850;
      cursor:pointer;
    }
    button.primary{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(90deg, rgba(34,197,94,.18), rgba(34,211,238,.14));
    }
    button.danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(90deg, rgba(239,68,68,.18), rgba(251,191,36,.10));
    }
    .hint{ font-size:12px; color:var(--muted); margin-top:10px; }
    .hint code{ color:var(--text); }

    /* small badges */
    .badgeRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.55);
      color:var(--muted);
      font-size:12px;
    }
    .badge.on{ color:var(--text); border-color: rgba(251,191,36,.22); }
  </style>
</head>

<body>
  <!-- A-Frame background -->
  <a-scene embedded renderer="antialias:true; colorManagement:true">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false" look-controls="pointerLockEnabled:false"></a-camera>
    </a-entity>

    <!-- simple sky -->
    <a-sky color="#061021"></a-sky>
  </a-scene>

  <!-- DOM Targets layer -->
  <div id="fg-layer" aria-label="Food Groups targets layer"></div>

  <!-- Edge pulse (panic) -->
  <div id="edgePulse"></div>

  <!-- Lock UI -->
  <div id="lockUI">
    <div id="lockRing" class="lockRing">
      <div class="lockProg"><i id="lockFill"></i></div>
      <div class="chargeBar"><i id="chargeFill"></i></div>
    </div>
  </div>

  <!-- HUD -->
  <div class="ui">
    <div class="topbar">
      <div class="panel box" style="width:240px;">
        <div>
          <div class="k">TIME</div>
          <div class="v mono" id="hud-time">--</div>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div class="k">SCORE</div>
          <div class="v mono" id="hud-score">0</div>
        </div>
      </div>

      <div class="panel box grow">
        <div style="min-width:0">
          <div class="k">GROUP</div>
          <div class="v small" id="hud-group">‚Äî</div>
        </div>
        <div class="chip" style="margin-left:auto;">
          Combo <b class="mono" id="hud-combo">0</b>
          ¬∑ Miss <b class="mono" id="hud-miss">0</b>
          ¬∑ Shield <b class="mono" id="hud-shield">0</b>
        </div>
      </div>

      <div class="panel box" style="width:320px;">
        <div class="quest">
          <div class="qline">
            <div class="qname" id="hud-goal-title">GOAL: ‚Äî</div>
            <div class="qprog mono" id="hud-goal-prog">0/0</div>
          </div>
          <div class="bar"><i id="hud-goal-bar"></i></div>

          <div class="qline" style="margin-top:2px;">
            <div class="qname" id="hud-mini-title">MINI: ‚Äî</div>
            <div class="qprog mono" id="hud-mini-prog">0/0</div>
          </div>
          <div class="bar mini"><i id="hud-mini-bar"></i></div>
        </div>
      </div>
    </div>

    <div class="bottombar">
      <div class="panel coach">
        <img id="hud-coach-img" src="./img/coach-neutral.png" alt="Coach" />
        <div class="msg" id="hud-coach-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÅ‡∏ï‡∏∞/‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ú®</div>
      </div>

      <div class="panel rightbox">
        <div class="rankRow">
          <div>
            <div class="k">RANK</div>
            <div class="v mono" id="hud-rank">C</div>
          </div>
          <div class="rankBadge" id="hud-rank-badge">C</div>
        </div>
        <div class="k">ACC ¬∑ QUEST ¬∑ SPS</div>
        <div class="v small mono" id="hud-metrics">0% ¬∑ 0% ¬∑ 0.00</div>

        <div class="badgeRow" style="margin-top:4px;">
          <span class="badge" id="badge-rush">üöÄ RUSH</span>
          <span class="badge" id="badge-wave">‚ö†Ô∏è WAVE</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div id="startOverlay">
    <div class="card">
      <h2 class="h1">Food Groups VR ‚Äî Start</h2>
      <p class="p">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏ô‡∏∏‡∏Å/‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ + ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (seed ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà). ‡∏ñ‡πâ‡∏≤ HUD ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô = ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ üòÑ</p>

      <div class="row">
        <div class="col">
          <label>Difficulty</label>
          <select id="in-diff">
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
          </select>

          <label>Time (sec)</label>
          <input id="in-time" type="number" min="20" max="600" value="90"/>

          <label>Run mode</label>
          <select id="in-run">
            <option value="play" selected>play</option>
            <option value="research">research</option>
          </select>
        </div>

        <div class="col">
          <label>District code (JJ/DM/LP/MB/NJ)</label>
          <select id="in-district">
            <option value="JJ" selected>JJ (‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£)</option>
            <option value="DM">DM (‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á)</option>
            <option value="LP">LP (‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß)</option>
            <option value="MB">MB (‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ)</option>
            <option value="NJ">NJ (‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å)</option>
          </select>

          <label>School (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πá‡πÉ‡∏™‡πà unknown ‡πÑ‡∏î‡πâ)</label>
          <input id="in-school" placeholder="unknown" value="unknown"/>

          <label>Seed (optional)</label>
          <input id="in-seed" placeholder="JJ-unknown-g5-5/1-001-pre-2025-12-24" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btn-start">‚ñ∂ START</button>
        <button id="btn-start-url">‚öôÔ∏è START (update URL)</button>
        <button class="danger" id="btn-stop">‚ñ† STOP</button>
      </div>

      <div class="hint">
        Tip: ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ seed ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô
        <code>JJ-unknown-g5-5/1-001-pre-2025-12-24</code>
      </div>
    </div>
  </div>

  <!-- Quest manager + Engine + Boot -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>
  <script src="./vr-groups/groups.safe.js" defer></script>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const sp = new URLSearchParams(location.search);

      function setIf(id, v){ const el=$(id); if(el && v!=null) el.value = v; }
      setIf('in-diff', sp.get('diff') || 'normal');
      setIf('in-time', sp.get('time') || '90');
      setIf('in-run',  sp.get('run')  || 'play');

      // best-effort parse seed into district/school
      const seed = sp.get('seed') || '';
      if (seed){
        setIf('in-seed', seed);
        const parts = seed.split('-');
        if (parts[0]) setIf('in-district', parts[0]);
        if (parts[1]) setIf('in-school', parts[1]);
      }

      function buildSeed(){
        const d = ($('in-district').value||'JJ').trim();
        const school = ($('in-school').value||'unknown').trim() || 'unknown';
        const seedIn = ($('in-seed').value||'').trim();
        if (seedIn) return seedIn;

        // fallback template
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        return `${d}-${school}-g5-5/1-001-pre-${yyyy}-${mm}-${dd}`;
      }

      function startNow(updateUrl){
        const diff = ($('in-diff').value||'normal').trim();
        const time = parseInt($('in-time').value||'90',10)||90;
        const run  = ($('in-run').value||'play').trim();
        const seed = buildSeed();

        if (updateUrl){
          const sp2 = new URLSearchParams(location.search);
          sp2.set('diff', diff);
          sp2.set('time', String(time));
          sp2.set('run', run);
          if (seed) sp2.set('seed', seed);
          // keep ts if exists
          if (!sp2.get('ts')) sp2.set('ts', String(Date.now()));
          const newUrl = location.pathname + '?' + sp2.toString();
          history.replaceState({}, '', newUrl);
        }

        // hide overlay
        $('startOverlay').style.display = 'none';

        // start through GroupsBoot (from groups.safe.js)
        if (window.GroupsBoot && window.GroupsBoot.start){
          window.GroupsBoot.start(run, { diff, time, seed });
        }else{
          console.warn('GroupsBoot not ready yet');
        }
      }

      $('btn-start').addEventListener('click', ()=>startNow(false));
      $('btn-start-url').addEventListener('click', ()=>startNow(true));
      $('btn-stop').addEventListener('click', ()=>{
        if (window.GroupsBoot && window.GroupsBoot.stop) window.GroupsBoot.stop('manual_stop');
        $('startOverlay').style.display = 'flex';
      });

      // ===== HUD bindings (minimal, independent from hha-hud.js) =====
      // (hha-hud.js still works, but we make sure THESE ids update no matter what)
      window.addEventListener('hha:time', (e)=>{
        const left = (e && e.detail && typeof e.detail.left==='number') ? e.detail.left : null;
        if (left!=null) $('hud-time').textContent = String(left);
      });
      window.addEventListener('hha:score', (e)=>{
        const d = (e && e.detail)||{};
        if (typeof d.score==='number') $('hud-score').textContent = String(d.score|0);
        if (typeof d.combo==='number') $('hud-combo').textContent = String(d.combo|0);
        if (typeof d.misses==='number') $('hud-miss').textContent = String(d.misses|0);
        if (typeof d.shield==='number') $('hud-shield').textContent = String(d.shield|0);
      });
      window.addEventListener('quest:update', (e)=>{
        const d = (e && e.detail)||{};
        const gLabel = d.groupLabel || '‚Äî';
        $('hud-group').textContent = gLabel;

        // goal
        const goal = d.goal || null;
        const gt = goal ? (goal.label||'') : 'GOAL: ‚Äî';
        const gp = goal ? `${goal.prog|0}/${goal.target|0}` : '0/0';
        $('hud-goal-title').textContent = goal ? gt : 'GOAL: ‚Äî';
        $('hud-goal-prog').textContent = gp;
        const gPct = goal && goal.target ? Math.max(0, Math.min(1, (goal.prog||0)/(goal.target||1))) : 0;
        $('hud-goal-bar').style.width = Math.round(gPct*100)+'%';

        // mini
        const mini = d.mini || null;
        $('hud-mini-title').textContent = mini ? (mini.label||'') : 'MINI: ‚Äî';

        let mp = '0/0';
        if (mini){
          if (typeof mini.tLeft === 'number' && typeof mini.windowSec === 'number'){
            mp = `${mini.prog|0}/${mini.target|0} ¬∑ ${mini.tLeft|0}s`;
          }else{
            mp = `${mini.prog|0}/${mini.target|0}`;
          }
        }
        $('hud-mini-prog').textContent = mp;
        const mPct = mini && mini.target ? Math.max(0, Math.min(1, (mini.prog||0)/(mini.target||1))) : 0;
        $('hud-mini-bar').style.width = Math.round(mPct*100)+'%';
      });
      window.addEventListener('hha:coach', (e)=>{
        const d = (e && e.detail)||{};
        if (d.text) $('hud-coach-text').textContent = String(d.text);
        if (d.mood){
          const mood = String(d.mood);
          // expects your known filenames
          const map = {
            happy:'./img/coach-happy.png',
            sad:'./img/coach-sad.png',
            neutral:'./img/coach-neutral.png',
            fever:'./img/coach-fever.png'
          };
          if (map[mood]) $('hud-coach-img').src = map[mood];
        }
      });
      window.addEventListener('hha:rank', (e)=>{
        const d = (e && e.detail)||{};
        const grade = d.grade || 'C';
        $('hud-rank').textContent = grade;
        $('hud-rank-badge').textContent = grade;
        const acc = (typeof d.accuracy==='number') ? `${d.accuracy|0}%` : '0%';
        const qp  = (typeof d.questsPct==='number') ? `${d.questsPct|0}%` : '0%';
        const sps = (typeof d.scorePerSec==='number') ? Number(d.scorePerSec).toFixed(2) : '0.00';
        $('hud-metrics').textContent = `${acc} ¬∑ ${qp} ¬∑ ${sps}`;
      });

      // ===== RUSH / WAVE badges =====
      window.addEventListener('hha:rush', (e)=>{
        const on = !!(e && e.detail && e.detail.on);
        $('badge-rush').classList.toggle('on', on);
      });
      window.addEventListener('groups:danger', (e)=>{
        const on = !!(e && e.detail && e.detail.on);
        $('badge-wave').classList.toggle('on', on);
      });

      // ===== Lock UI from engine events =====
      const ring = $('lockRing'), lockFill = $('lockFill'), chargeFill = $('chargeFill');
      function ringClass(d){
        ring.classList.remove('boss','decoy');
        if (d && d.boss) ring.classList.add('boss');
        if (d && d.decoy) ring.classList.add('decoy');
      }
      window.addEventListener('groups:lock', (e)=>{
        const d = (e && e.detail)||{};
        if (!d.on){
          ring.classList.remove('on');
          return;
        }
        ring.classList.add('on');
        ringClass(d);
        ring.style.left = (d.x|0)+'px';
        ring.style.top  = (d.y|0)+'px';
        lockFill.style.width = Math.round((d.prog||0)*100)+'%';
        chargeFill.style.width = Math.round((d.charge||0)*100)+'%';
      });

      // keep overlay hidden if autostart via ?run=
      if ((sp.get('run')||'').trim()){
        $('startOverlay').style.display = 'none';
      }
    })();
  </script>
</body>
</html>