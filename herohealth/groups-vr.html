<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — Groups Launcher</title>
  <meta name="color-scheme" content="dark" />
</head>
<body>
<script>
(function(){
  'use strict';

  const u = new URL(location.href);

  const diff = String(u.searchParams.get('diff') || 'normal').toLowerCase();
  const run  = String(u.searchParams.get('run') || u.searchParams.get('runMode') || 'play').toLowerCase();
  const time = Math.max(30, Math.min(180, parseInt(u.searchParams.get('time') || '90', 10) || 90));

  const hub = String(u.searchParams.get('hub') || '../hub.html');

  // deterministic-ish seed: sessionId/studentKey + ts
  const sid = String(u.searchParams.get('sessionId') || u.searchParams.get('studentKey') || '');
  const ts  = String(u.searchParams.get('ts') || Date.now());
  const seed = String(u.searchParams.get('seed') || (sid ? (sid + '|' + ts) : ts));

  const r = new URL('./vr-groups/vr-groups.html', location.href);
  r.searchParams.set('diff', ['easy','normal','hard'].includes(diff) ? diff : 'normal');
  r.searchParams.set('run', (run === 'research') ? 'research' : 'play');
  r.searchParams.set('time', String(time));
  r.searchParams.set('seed', seed);
  r.searchParams.set('hub', hub);
  r.searchParams.set('ts', String(Date.now())); // cache-bust

  // pass-through (ถ้ามี)
  [
    'studyId','phase','conditionGroup','sessionOrder','blockLabel','siteCode','schoolYear','semester',
    'sessionId','studentKey','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age',
    'gradeLevel','heightCm','weightKg','bmi','bmiGroup','vrExperience','gameFrequency','handedness','visionIssue',
    'healthDetail','consentParent'
  ].forEach(k=>{
    const v = u.searchParams.get(k);
    if (v != null && v !== '' && !r.searchParams.has(k)) r.searchParams.set(k, v);
  });

  // optional: allow autostart passthrough
  if (u.searchParams.get('autostart') === '1') r.searchParams.set('autostart','1');

  location.replace(r.toString());
})();
</script>
</body>
</html>