<!-- === /herohealth/groups-vr.html ===
GroupsVR LAUNCHER ‚Äî ROOT (FINAL-3 MIRROR)
‚úÖ Redirect -> ./vr-groups/groups-vr.html
‚úÖ Auto-detect view (pc/mobile) BUT:
   - If URL already has ?view=... -> DO NOT override
‚úÖ Pass-through: hub/run/diff/time/seed/style/studyId/phase/conditionGroup/ts/log/ai/practice
‚úÖ Optional: remembers last view via localStorage (safe) ONLY when view param not provided
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GroupsVR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg:#020617; --panel:rgba(2,6,23,.78); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      overflow:hidden;
    }
    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: calc(18px + var(--sat)) 18px calc(18px + var(--sab));
    }
    .card{
      width:min(720px, 100%);
      border-radius:var(--radius);
      background:var(--panel);
      border:1px solid var(--stroke);
      padding:20px 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.30);
    }
    .title{
      display:flex; gap:12px; align-items:center;
      font-weight:900; letter-spacing:.2px; font-size:18px;
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      background:rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.20);
      color:rgba(229,231,235,.95);
      font-weight:800; font-size:12px;
    }
    .sub{ margin-top:10px; color:var(--muted); line-height:1.35; font-weight:650; font-size:13px; }
    .row{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.55);
      font-weight:800; font-size:12px; color:rgba(229,231,235,.92);
    }
    .hint{ margin-top:14px; color:rgba(229,231,235,.80); font-size:12px; line-height:1.35; }
    .spin{ display:inline-block; animation:spin 1.05s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        ü•¶ Food Groups VR <span class="badge">LAUNCH</span>
      </div>
      <div class="sub">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°‚Ä¶ <span class="spin">‚è≥</span><br/>
        ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ Chrome ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>
      <div class="row" id="metaRow"></div>
      <div class="hint">
        ‡πÇ‡∏´‡∏°‡∏î Cardboard (cVR) ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ <b>?view=cvr</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏™‡∏∏‡∏î üéØ
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;

  const LS_LAST_VIEW = 'HHA_GROUPS_LAST_VIEW';

  function qs(k, def=null){
    try{ return new URL(location.href).searchParams.get(k) ?? def; }
    catch{ return def; }
  }

  function hasParam(k){
    try{ return new URL(location.href).searchParams.has(k); }
    catch{ return false; }
  }

  function setMeta(text){
    try{
      const row = DOC.getElementById('metaRow');
      if (!row) return;
      const el = DOC.createElement('div');
      el.className = 'pill';
      el.textContent = text;
      row.appendChild(el);
    }catch(_){}
  }

  function detectView(){
    // IMPORTANT: do not override if ?view= exists
    const v = String(qs('view','')||'').toLowerCase();
    if (v) return v;

    // try last view (optional)
    try{
      const last = String(localStorage.getItem(LS_LAST_VIEW)||'').toLowerCase();
      if (last === 'pc' || last === 'mobile' || last === 'vr' || last === 'cvr') return last;
    }catch(_){}

    // auto detect
    const ua = navigator.userAgent || '';
    const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
    if (isMobile) return 'mobile';
    return 'pc';
  }

  function normalize(){
    const run = String(qs('run','play')||'play').toLowerCase();
    const diff= String(qs('diff','normal')||'normal').toLowerCase();
    const style=String(qs('style','mix')||'mix').toLowerCase();
    let time = Number(qs('time', 90));
    if (!isFinite(time)) time = 90;
    time = Math.max(30, Math.min(180, time));
    const seed = String(qs('seed','') || Date.now());

    const view = detectView();

    return {
      run: (run === 'research') ? 'research' : 'play',
      diff: (diff==='easy'||diff==='hard'||diff==='normal') ? diff : 'normal',
      style: style || 'mix',
      time,
      seed,
      view
    };
  }

  function rememberView(view){
    // remember only when user didn't explicitly specify view (safe, non-invasive)
    if (hasParam('view')) return;
    try{
      if (view==='pc'||view==='mobile'||view==='vr'||view==='cvr'){
        localStorage.setItem(LS_LAST_VIEW, view);
      }
    }catch(_){}
  }

  function buildRedirectUrl(){
    const base = new URL('./vr-groups/groups-vr.html', location.href);
    const sp = new URL(location.href).searchParams;

    const N = normalize();
    rememberView(N.view);

    // set canonical params (only if absent OR invalid)
    base.searchParams.set('view', N.view);
    base.searchParams.set('run', N.run);
    base.searchParams.set('diff', N.diff);
    base.searchParams.set('style', N.style);
    base.searchParams.set('time', String(N.time));
    base.searchParams.set('seed', String(N.seed));

    // pass-through all remaining params (keep user's extra params)
    sp.forEach((v,k)=>{
      // canonical already set above - but do NOT override if user explicitly provided:
      // (we still set them to same values; harmless)
      if (k === 'view' || k === 'run' || k === 'diff' || k === 'style' || k === 'time' || k === 'seed'){
        // if user provided view, keep it verbatim (no override)
        if (k === 'view' && hasParam('view')){
          base.searchParams.set('view', String(qs('view','mobile')||'mobile'));
        }
        return;
      }
      base.searchParams.set(k, v);
    });

    return base.toString();
  }

  // --- UI meta preview (nice for debugging) ---
  const N = normalize();
  setMeta('view=' + N.view);
  setMeta('run=' + N.run);
  setMeta('diff=' + N.diff);
  setMeta('time=' + N.time);
  setMeta('style=' + N.style);

  const to = buildRedirectUrl();
  // redirect quickly
  setTimeout(()=>{ location.replace(to); }, 120);
})();
</script>
</body>
</html>