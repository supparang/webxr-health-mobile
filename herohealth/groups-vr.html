<!-- === /herohealth/groups-vr.html ===
Food Groups VR ‚Äî FULL HTML (PRODUCTION / FIX-ALL)
‚úÖ Targets = DOM emoji + VR-parallax (via GameEngine CSS vars --x/--y/--s)
‚úÖ GOAL + MINI quest always shows (via hha-hud-quest.js + quest:update emits)
‚úÖ Fever/Shield works (ui-fever.js + hha:fever)
‚úÖ Lock ring / Charge ring / Reticle / Danger vignette ready
‚úÖ URL params:
   ?diff=easy|normal|hard
   &time=90
   &run=play|research
   &seed=abc (optional for research)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (camera rotation source) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="./vr-groups/groups.css" />

  <!-- Global FX + Fever UI + HUD binders -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>

  <!-- HUD: score/coach/time/rank + Quest panel (IMPORTANT) -->
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-hud-quest.js" defer></script>

  <!-- Game scripts (IIFE) -->
  <script src="./vr-groups/groups-quests.js" defer></script>
  <script src="./vr-groups/GameEngine.js" defer></script>

  <style>
    /* minimal layout helpers (core visuals in groups.css) */
    .topbar{
      position:fixed; left:12px; top:12px;
      display:flex; gap:10px; z-index:60;
      pointer-events:none;
    }
    .pill{
      pointer-events:none;
      min-width:90px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(2,6,23,.65);
      border:1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.32);
    }
    .pill .k{ font-size:12px; color:rgba(148,163,184,.9); margin-bottom:4px; }
    .pill .v{ font-size:18px; font-weight:800; }

    .rightbar{
      position:fixed; right:12px; top:12px;
      z-index:60;
      display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .rightbar .pill{ min-width:120px; }

    .bottombar{
      position:fixed; left:12px; right:12px; bottom:12px;
      display:flex; gap:10px; justify-content:center;
      z-index:70;
      pointer-events:auto;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:18px;
      background: rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.18);
      color:#e5e7eb;
      font-weight:900;
      min-width:112px;
      box-shadow: 0 12px 34px rgba(0,0,0,.36);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.green{ border-color: rgba(34,197,94,.25); }
    .btn.red{ border-color: rgba(239,68,68,.20); }
    .btn.gray{ border-color: rgba(148,163,184,.18); }

    /* Start overlay */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:90;
      background: radial-gradient(1000px 650px at 50% 40%, rgba(15,23,42,.55), rgba(2,6,23,.92));
      padding:16px;
    }
    .card{
      width:min(560px, 100%);
      background: rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
    }
    .title{
      font-size:18px; font-weight:1000; letter-spacing:.2px;
      margin:2px 0 10px;
    }
    .sub{
      color:rgba(148,163,184,.95);
      font-size:13px;
      line-height:1.35;
      margin:0 0 12px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      padding:10px 12px;
      border-radius:16px;
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.16);
      color:rgba(226,232,240,.95);
      font-weight:800;
      font-size:13px;
    }
    .row .btn{ flex:1 1 160px; }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:rgba(148,163,184,.95);
      line-height:1.35;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <!-- background vignette + world layer -->
  <div class="fg-vignette"></div>

  <!-- DOM play layer -->
  <div id="fg-layer" class="fg-layer" aria-label="FoodGroups Layer"></div>

  <!-- Reticle -->
  <div class="fg-reticle" aria-hidden="true"></div>

  <!-- Lock ring (driven by groups:lock) -->
  <div id="fg-lockring" class="fg-lockring" aria-hidden="true">
    <div class="fg-lockfill"></div>
    <div class="fg-chargefill"></div>
  </div>

  <!-- Minimal HUD (hha-hud.js will also bind to ids if present) -->
  <div class="topbar">
    <div class="pill"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="hudScore">0</div></div>
    <div class="pill"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div><div class="v" id="hudCombo">0</div></div>
    <div class="pill"><div class="k">Miss</div><div class="v" id="hudMiss">0</div></div>
    <div class="pill"><div class="k">‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="hudTime">0</div></div>
  </div>

  <div class="rightbar">
    <div class="pill"><div class="k">‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div class="v" id="hudGroup">‚Äî</div></div>
    <div class="pill"><div class="k">‡πÄ‡∏Å‡∏£‡∏î</div><div class="v" id="hudGrade">C</div></div>
    <!-- Fever/Shield UI is handled by ui-fever.js + hha-hud.js (it may inject its own bar) -->
  </div>

  <!-- Coach bubble (hha-hud.js will update via hha:coach) -->
  <div class="fg-coach" id="coachBox" style="display:none;">
    <div class="title">Coach</div>
    <div class="msg" id="coachMsg">‚Äî</div>
  </div>

  <!-- Bottom controls -->
  <div class="bottombar">
    <button class="btn green" id="btnGaze">Gaze: ON</button>
    <button class="btn red" id="btnStop">STOP</button>
    <button class="btn gray" id="btnVR">VR</button>
  </div>

  <!-- A-Frame scene (camera rotation source) -->
  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: false"
    vr-mode-ui="enabled: true"
    device-orientation-permission-ui="enabled: true"
    style="position:fixed; inset:0; z-index:1; pointer-events:none; opacity:0.001;">
    <a-entity id="rig">
      <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true" wasd-controls="enabled:false"></a-camera>
    </a-entity>
  </a-scene>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <div class="title">ü•¶ Food Groups VR ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢!</div>
      <p class="sub">
        ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡πÅ‡∏ï‡∏∞‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏á<br/>
        ‡πÇ‡∏´‡∏°‡∏î <b>Research</b> ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Seed ‡πÅ‡∏ö‡∏ö fix ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏£‡∏á
      </p>

      <div class="row" style="margin-bottom:10px;">
        <div class="chip">diff: <span id="chipDiff" class="mono">normal</span></div>
        <div class="chip">time: <span id="chipTime" class="mono">90</span>s</div>
        <div class="chip">run: <span id="chipRun" class="mono">play</span></div>
        <div class="chip">seed: <span id="chipSeed" class="mono">‚Äî</span></div>
      </div>

      <div class="row">
        <button class="btn green" id="btnStart">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn gray" id="btnStartResearch">üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏° (Research)</button>
      </div>

      <div class="hint">
        ‡∏ñ‡πâ‡∏≤ GOAL/MINI ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö:
        <span class="mono">./vr/hha-hud-quest.js</span> ‡πÅ‡∏•‡∏∞‡∏°‡∏µ event <span class="mono">quest:update</span> ‡∏ñ‡∏π‡∏Å‡∏¢‡∏¥‡∏á (Engine ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ)
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const $ = (id)=>document.getElementById(id);

      function sp(){ try{ return new URLSearchParams(location.search); } catch { return new URLSearchParams(); } }
      const q = sp();

      const diff = String(q.get('diff') || 'normal').toLowerCase();
      const timeSec = Math.max(10, parseInt(q.get('time') || '90', 10) || 90);
      const run = String(q.get('run') || 'play').toLowerCase() === 'research' ? 'research' : 'play';
      const seed = String(q.get('seed') || '').trim();

      $('chipDiff').textContent = diff;
      $('chipTime').textContent = String(timeSec);
      $('chipRun').textContent  = run;
      $('chipSeed').textContent = seed ? seed : '‚Äî';

      // Simple coach render (in case hha-hud.js is missing)
      window.addEventListener('hha:coach', (ev)=>{
        const text = ev && ev.detail && ev.detail.text ? String(ev.detail.text) : '';
        if (!text) return;
        $('coachBox').style.display = '';
        $('coachMsg').textContent = text;
      });

      // Minimal HUD mirrors (hha-hud.js can override; this is fallback)
      window.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        if ($('hudScore')) $('hudScore').textContent = String(d.score ?? 0);
        if ($('hudCombo')) $('hudCombo').textContent = String(d.combo ?? 0);
        if ($('hudMiss'))  $('hudMiss').textContent  = String(d.misses ?? 0);
      });
      window.addEventListener('hha:time', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        if ($('hudTime')) $('hudTime').textContent = String(d.left ?? 0);
      });
      window.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        // show active group label in small HUD (quest manager provides)
        if ($('hudGroup')) $('hudGroup').textContent = d.groupLabel ? String(d.groupLabel) : '‚Äî';
      });
      window.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        if ($('hudGrade')) $('hudGrade').textContent = d.grade ? String(d.grade) : 'C';
      });

      // Danger vignette toggle
      window.addEventListener('groups:danger', (ev)=>{
        const on = !!(ev && ev.detail && ev.detail.on);
        document.body.classList.toggle('fg-danger', on);
      });

      // Reticle state (optional)
      window.addEventListener('groups:reticle', (ev)=>{
        const s = (ev && ev.detail && ev.detail.state) ? String(ev.detail.state) : '';
        document.body.classList.toggle('fg-reticle-ok', s === 'ok');
        document.body.classList.toggle('fg-reticle-miss', s === 'miss');
        document.body.classList.toggle('fg-reticle-perfect', s === 'perfect');
        if (s){
          setTimeout(()=>{
            document.body.classList.remove('fg-reticle-ok','fg-reticle-miss','fg-reticle-perfect');
          }, 220);
        }
      });

      // Lock ring (driven by engine)
      window.addEventListener('groups:lock', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const ring = $('fg-lockring');
        if (!ring) return;

        const on = !!d.on;
        ring.classList.toggle('on', on);
        if (!on) return;

        // position
        ring.style.setProperty('--lx', (Math.round(d.x || (innerWidth/2))) + 'px');
        ring.style.setProperty('--ly', (Math.round(d.y || (innerHeight/2))) + 'px');
        ring.style.setProperty('--lp', String(Math.max(0, Math.min(1, Number(d.prog)||0))));
        ring.style.setProperty('--cp', String(Math.max(0, Math.min(1, Number(d.charge)||0))));
      });

      // VR button
      $('btnVR').addEventListener('click', ()=>{
        try{
          const scene = document.querySelector('a-scene');
          if (scene && scene.enterVR) scene.enterVR();
        }catch{}
      });

      // Engine start/stop
      function engine(){
        return window.GroupsVR && window.GroupsVR.GameEngine ? window.GroupsVR.GameEngine : null;
      }

      function startWithMode(mode){
        const ge = engine();
        const layerEl = $('fg-layer');
        const camEl = document.querySelector('#cam');
        if (!ge || !layerEl){
          alert('GameEngine ‡∏´‡∏£‡∏∑‡∏≠ fg-layer ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå ./vr-groups/GameEngine.js ‡πÅ‡∏•‡∏∞ id="fg-layer")');
          return;
        }

        ge.setLayerEl(layerEl);
        ge.setCameraEl(camEl);

        ge.setTimeLeft(timeSec);

        // start
        ge.start(diff, {
          runMode: mode,
          seed: seed || undefined,
          layerEl: layerEl
        });

        $('startOverlay').style.display = 'none';
      }

      $('btnStart').addEventListener('click', ()=> startWithMode('play'));
      $('btnStartResearch').addEventListener('click', ()=> startWithMode('research'));

      $('btnStop').addEventListener('click', ()=>{
        const ge = engine();
        if (ge && ge.stop) ge.stop('stop_btn');
        $('startOverlay').style.display = '';
      });

      // Gaze toggle
      let gazeOn = true;
      $('btnGaze').addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        $('btnGaze').textContent = gazeOn ? 'Gaze: ON' : 'Gaze: OFF';
        const ge = engine();
        if (ge && ge.setGaze) ge.setGaze(gazeOn);
      });

      // If URL asked to auto-run (optional)
      if (q.get('autorun') === '1'){
        setTimeout(()=> startWithMode(run), 250);
      }
    })();
  </script>
</body>
</html>