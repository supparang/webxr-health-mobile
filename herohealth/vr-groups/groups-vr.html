<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- ‚úÖ CSS alias (keep stable links) -->
  <link rel="stylesheet" href="./groups.css?v=20251228" />

  <!-- Minimal base fallback (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ css ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î) -->
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#020617;color:#e5e7eb;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
    .sr-only{position:absolute;left:-9999px}
  </style>

  <!-- A-Frame core (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VR button + sky feel) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Scripts (order matters) -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/ui-fever.js" defer></script>
  <script src="../vr/ui-karaoke.js" defer></script>

  <script src="./groups-hud-quest.js" defer></script>
  <script src="./groups-text.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./groups-fx.js" defer></script>

  <script src="./GameEngine.js" defer></script>
  <script src="./groups.safe.js" defer></script>
</head>

<body>
  <!-- A-Frame scene (‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÅ‡∏Ñ‡πà‡πÉ‡∏´‡πâ VR feel + camera id="cam" ‡πÉ‡∏´‡πâ Boot bind) -->
  <a-scene embedded
           renderer="colorManagement:true; physicallyCorrectLights:false;"
           vr-mode-ui="enabled:true"
           device-orientation-permission-ui="enabled:true">

    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
    </a-entity>

    <a-sky color="#071022"></a-sky>
  </a-scene>

  <!-- DOM Layer for targets -->
  <div id="fg-layer" class="fg-layer" aria-label="groups layer"></div>

  <!-- HUD / Quest -->
  <div class="hha-ui" id="hha-ui">
    <!-- Top Quest bars -->
    <div class="quest-top">
      <div class="quest-card">
        <div class="quest-title" id="goalTitle">GOAL ‚Äî</div>
        <div class="quest-bar">
          <div class="quest-fill" id="goalFill" style="width:0%"></div>
        </div>
        <div class="quest-meta">
          <span id="goalNow">0</span>/<span id="goalNeed">0</span>
          <span class="sep">‚Ä¢</span>
          <span id="goalsCleared">0</span>/<span id="goalsTotal">0</span>
        </div>
      </div>

      <div class="quest-card">
        <div class="quest-title" id="miniTitle">MINI ‚Äî</div>
        <div class="quest-bar mini">
          <div class="quest-fill" id="miniFill" style="width:0%"></div>
        </div>
        <div class="quest-meta">
          <span id="miniNow">0</span>/<span id="miniNeed">0</span>
          <span class="sep">‚Ä¢</span>
          <span id="miniCleared">0</span>/<span id="miniTotal">0</span>
          <span class="sep">‚Ä¢</span>
          <span class="mini-timer" id="miniLeftSec" style="display:none;">0s</span>
        </div>
      </div>
    </div>

    <!-- Main HUD -->
    <div class="hud">
      <div class="hud-left">
        <div class="hud-chip">
          <span class="k">‚è±Ô∏è</span><span id="timeLeft">0</span>s
        </div>
        <div class="hud-chip">
          <span class="k">üèÜ</span><span id="score">0</span>
        </div>
        <div class="hud-chip">
          <span class="k">üî•</span><span id="combo">0</span>
        </div>
        <div class="hud-chip">
          <span class="k">üíî</span><span id="misses">0</span>
        </div>
      </div>

      <div class="hud-right">
        <div class="rank-badge" id="rankBadge">‚Äî</div>
        <div class="power-wrap" aria-label="power">
          <div class="power-label">POWER</div>
          <div class="power-bar"><div class="power-fill" id="powerFill" style="width:0%"></div></div>
          <div class="power-meta"><span id="powerNow">0</span>/<span id="powerThr">0</span></div>
        </div>
      </div>
    </div>

    <!-- Coach / Karaoke area (optional bind by scripts) -->
    <div class="coach" id="coachBox" style="display:none;">
      <div class="coach-emo" id="coachEmoji">ü•¶</div>
      <div class="coach-text" id="coachText">‚Äî</div>
    </div>

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay">
      <div class="overlay-card">
        <div class="overlay-title">Food Groups VR üç≠</div>
        <div class="overlay-sub" id="overlaySub">
          ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ autostart=1 ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á)
        </div>
        <div class="overlay-btns">
          <button class="btn" id="btnPlay">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° (Play)</button>
          <button class="btn secondary" id="btnResearch">üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏° (Research)</button>
          <button class="btn secondary" id="btnVr">üï∂Ô∏è VR Mode</button>
        </div>
        <div class="overlay-hint" id="overlayHint">Tip: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏¥‡πä‡∏Å ‡πÜ ‡∏ï‡∏≠‡∏ô STORM ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</div>
      </div>
    </div>

    <!-- End Summary -->
    <div class="end" id="endModal" style="display:none;">
      <div class="end-card">
        <div class="end-title" id="endTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>

        <div class="end-grid">
          <div class="end-item"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="endScore">0</div></div>
          <div class="end-item"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="endCombo">0</div></div>
          <div class="end-item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
          <div class="end-item"><div class="k">Accuracy</div><div class="v" id="endAcc">0%</div></div>
          <div class="end-item"><div class="k">Grade</div><div class="v" id="endGrade">‚Äî</div></div>
          <div class="end-item"><div class="k">Goals</div><div class="v" id="endGoals">0/0</div></div>
          <div class="end-item"><div class="k">Minis</div><div class="v" id="endMinis">0/0</div></div>
        </div>

        <div class="end-btns">
          <a class="btn secondary" id="btnBackHub" href="../hub.html">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö HUB</a>
          <button class="btn" id="btnReplay">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Small glue script: start buttons + hub back + end modal binding -->
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const sp = new URLSearchParams(location.search);
      const hubEnc = sp.get('hub');
      const hubUrl = hubEnc ? decodeURIComponent(hubEnc) : '../hub.html';

      // back button
      const back = $('btnBackHub');
      if (back) back.href = hubUrl;

      // VR mode button
      $('btnVr')?.addEventListener('click', ()=>{
        const scene = document.querySelector('a-scene');
        try{ scene && scene.enterVR && scene.enterVR(); }catch{}
      });

      function pickSeed(){
        const s = String(sp.get('seed')||'').trim();
        return s ? s : String(Date.now());
      }
      function pickDiff(){
        const d = String(sp.get('diff')||'normal').toLowerCase();
        return (d==='easy'||d==='normal'||d==='hard') ? d : 'normal';
      }
      function pickTime(){
        const t = parseInt(sp.get('time')||'90',10);
        return Number.isFinite(t) ? Math.max(30, Math.min(180, t|0)) : 90;
      }

      function start(mode){
        const runMode = (String(mode||'play').toLowerCase()==='research') ? 'research' : 'play';
        const diff = pickDiff();
        const time = pickTime();
        const seed = pickSeed();
        try{
          window.GroupsBoot && window.GroupsBoot.start && window.GroupsBoot.start(runMode, { diff, time, seed });
        }catch(e){ console.warn('start failed', e); }
        $('startOverlay') && ($('startOverlay').style.display='none');
      }

      $('btnPlay')?.addEventListener('click', ()=>start('play'));
      $('btnResearch')?.addEventListener('click', ()=>start('research'));

      // End modal binding (listen hha:end)
      window.addEventListener('hha:end', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        $('endModal').style.display = '';
        $('endScore').textContent = (d.scoreFinal ?? 0);
        $('endCombo').textContent = (d.comboMax ?? 0);
        $('endMiss').textContent = (d.misses ?? 0);
        $('endAcc').textContent = ((d.accuracyGoodPct ?? 0) + '%');
        $('endGrade').textContent = (d.grade ?? '‚Äî');
        $('endGoals').textContent = (d.goalsCleared ?? 0) + '/' + (d.goalsTotal ?? 0);
        $('endMinis').textContent = (d.miniCleared ?? 0) + '/' + (d.miniTotal ?? 0);
        $('endTitle').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî ' + (d.reason || 'end');
      });

      // Replay: reload without cache
      $('btnReplay')?.addEventListener('click', ()=>{
        const u = new URL(location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      });

      // If autostart=1 -> hide overlay (game will start via groups.safe.js)
      if (String(sp.get('autostart')||'0') === '1'){
        // overlay still shown briefly; hide after a short moment
        setTimeout(()=>{ if ($('startOverlay')) $('startOverlay').style.display='none'; }, 600);
      }
    })();
  </script>
</body>
</html>
