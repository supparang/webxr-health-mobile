<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî RUN (PRODUCTION)
‚úÖ Minimal A-Frame scene (Enter VR reliability)
‚úÖ DOM UI layers (HUD / Quest / Coach / Power / End overlay)
‚úÖ playLayer fullscreen (targets spawn here)
‚úÖ Boot flow handled by ./groups-vr.boot.js (Tap-to-start + detect + calibration + practice + run)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame (XR only; gameplay targets are DOM) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Logger + VR UI -->
  <script src="../vr/particles.js" defer></script>

  <!-- tune crosshair assist for cVR -->
  <script>
    window.HHA_VRUI_CONFIG = { lockPx: 92, cooldownMs: 90 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- optional packs (if you already have these files) -->
  <script src="./audio.js" defer></script>
  <script src="./effects-pack.js" defer></script>
  <script src="./research-ctx.js" defer></script>
  <script src="./flush-log.js" defer></script>
  <script src="./view-helper.js" defer></script>
  <script src="./ai-hooks.js" defer></script>

  <!-- Engine -->
  <script src="./groups.safe.js" defer></script>

  <!-- Boot (Tap-to-start + detect + calibration + practice + real run) -->
  <script src="./groups-vr.boot.js" defer></script>
</head>

<body class="view-mobile">
  <!-- ===== XR scene behind DOM (minimal for Enter VR) ===== -->
  <a-scene class="xr-scene" embedded
           vr-mode-ui="enabled: false"
           renderer="colorManagement:true; physicallyCorrectLights:false; antialias:true"
           device-orientation-permission-ui="enabled: false">
    <a-entity camera look-controls="enabled:true" position="0 1.6 0"></a-entity>
    <a-sky color="#020617"></a-sky>
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
  </a-scene>

  <!-- ===== PLAY LAYER (DOM targets spawn here) ===== -->
  <div id="playLayer" class="playLayer" aria-label="play layer"></div>

  <!-- ===== HUD ===== -->
  <div class="hud" aria-hidden="true">
    <div class="hudLeft">
      <div class="pill">
        <span class="lbl">TIME</span>
        <span id="hudTime" class="val">90</span>
      </div>
      <div class="pill">
        <span class="lbl">SCORE</span>
        <span id="hudScore" class="val">0</span>
      </div>
      <div class="pill">
        <span class="lbl">COMBO</span>
        <span id="hudCombo" class="val">0</span>
      </div>
      <div class="pill">
        <span class="lbl">MISS</span>
        <span id="hudMiss" class="val">0</span>
      </div>
    </div>

    <div class="hudRight">
      <div class="pill">
        <span class="lbl">ACC</span>
        <span id="hudAcc" class="val">0%</span>
      </div>
      <div class="pill">
        <span class="lbl">RANK</span>
        <span id="hudRank" class="val">C</span>
      </div>
      <div class="pill">
        <span class="lbl">MODE</span>
        <span id="vMode" class="val">PLAY</span>
      </div>
    </div>
  </div>

  <!-- ===== QUEST TOP ===== -->
  <div class="questTop" aria-hidden="true">
    <!-- GOAL -->
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">‚Äî</div>
        <div class="tag"><span id="goalNow">0</span>/<span id="goalTotal">0</span></div>
      </div>
      <div class="bar"><div id="goalFill" class="fill" style="width:0%"></div></div>
      <div class="qSub" id="goalSub">GOAL</div>
    </div>

    <!-- MINI -->
    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">‚Äî</div>
        <div class="tag">
          <span id="miniNow">0</span>/<span id="miniTotal">0</span>
          <span id="miniTime" style="margin-left:6px; opacity:.9;"></span>
        </div>
      </div>
      <div class="bar"><div id="miniFill" class="fill" style="width:0%"></div></div>
      <div class="qSub" id="miniSub">MINI</div>
    </div>
  </div>

  <!-- ===== COACH ===== -->
  <div class="coachWrap" aria-hidden="true">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" alt="coach" src="../img/coach-neutral.png" />
      <div class="coachBubble">
        <div class="coachName">Hero Coach</div>
        <div id="coachText" class="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
      </div>
    </div>
  </div>

  <!-- ===== POWER ===== -->
  <div class="powerWrap" aria-hidden="true">
    <div class="powerCard">
      <div class="pHead">POWER ‚Äî ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‚Äù</div>
      <div class="bar powerBar">
        <div id="powerFill" class="fill" style="width:0%"></div>
      </div>
      <div class="pFoot">
        <span id="powerNow">0</span>/<span id="powerThr">0</span>
        <span id="powerNote" style="margin-left:8px;">Perfect Switch</span>
      </div>
    </div>
  </div>

  <!-- ===== END OVERLAY ===== -->
  <div id="endOverlay" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>
      <div id="endSub" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">RANK</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">SCORE</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">ACC</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">MISS</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <div class="note" id="endNote">‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö HUB</div>
      </div>

      <div class="row">
        <button id="btnReplay" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        <button id="btnBackHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== (Optional) Calibration Overlay placeholders
       Boot.js ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡∏Å‡πá OK ===== -->
  <div id="calOverlay" style="display:none;"></div>

  <!-- ===== UI Wiring (small + safe): listen to engine events and update DOM ===== -->
  <script>
  (function(){
    'use strict';
    const $ = (id)=>document.getElementById(id);

    function showEnd(on){
      const el = $('endOverlay');
      if (!el) return;
      el.classList.toggle('hidden', !on);
    }

    function pctFill(el, pct){
      if (!el) return;
      pct = Math.max(0, Math.min(100, Number(pct)||0));
      el.style.width = pct.toFixed(0) + '%';
    }

    // HUD
    window.addEventListener('hha:time', (ev)=>{
      const d = ev.detail||{};
      if ($('hudTime')) $('hudTime').textContent = String(d.left ?? 0);
    }, {passive:true});

    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail||{};
      if ($('hudScore')) $('hudScore').textContent = String(d.score ?? 0);
      if ($('hudCombo')) $('hudCombo').textContent = String(d.combo ?? 0);
      if ($('hudMiss'))  $('hudMiss').textContent  = String(d.misses ?? 0);
    }, {passive:true});

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail||{};
      if ($('hudRank')) $('hudRank').textContent = String(d.grade ?? 'C');
      if ($('hudAcc'))  $('hudAcc').textContent  = String(d.accuracy ?? 0) + '%';
    }, {passive:true});

    // Coach
    window.addEventListener('hha:coach', (ev)=>{
      const d = ev.detail||{};
      if ($('coachText')) $('coachText').textContent = String(d.text || '');
      const mood = String(d.mood||'neutral');
      const img = $('coachImg');
      if (img){
        if (mood==='happy') img.src = '../img/coach-happy.png';
        else if (mood==='sad') img.src = '../img/coach-sad.png';
        else if (mood==='fever') img.src = '../img/coach-fever.png';
        else img.src = '../img/coach-neutral.png';
      }
    }, {passive:true});

    // Quest
    window.addEventListener('quest:update', (ev)=>{
      const d = ev.detail||{};
      if ($('goalTitle')) $('goalTitle').textContent = String(d.goalTitle || '‚Äî');
      if ($('goalNow'))   $('goalNow').textContent   = String(d.goalNow ?? 0);
      if ($('goalTotal')) $('goalTotal').textContent = String(d.goalTotal ?? 0);
      pctFill($('goalFill'), d.goalPct ?? 0);

      if ($('miniTitle')) $('miniTitle').textContent = String(d.miniTitle || '‚Äî');
      if ($('miniNow'))   $('miniNow').textContent   = String(d.miniNow ?? 0);
      if ($('miniTotal')) $('miniTotal').textContent = String(d.miniTotal ?? 0);
      pctFill($('miniFill'), d.miniPct ?? 0);

      const tLeft = Number(d.miniTimeLeftSec)||0;
      const miniTime = $('miniTime');
      if (miniTime){
        miniTime.textContent = (tLeft>0) ? ('‚è±Ô∏è ' + tLeft + 's') : '';
      }

      // urgent classes
      document.body.classList.toggle('mini-urgent', tLeft>0 && tLeft<=3);
    }, {passive:true});

    // Power
    window.addEventListener('groups:power', (ev)=>{
      const d = ev.detail||{};
      if ($('powerNow')) $('powerNow').textContent = String(d.charge ?? 0);
      if ($('powerThr')) $('powerThr').textContent = String(d.threshold ?? 0);
      const pct = (Number(d.threshold)||0) ? (Number(d.charge||0)/Number(d.threshold||1))*100 : 0;
      pctFill($('powerFill'), pct);
    }, {passive:true});

    // Storm/progress UI flags
    window.addEventListener('groups:progress', (ev)=>{
      const d = ev.detail||{};
      const kind = String(d.kind||'');
      if (kind==='storm_on') document.body.classList.add('groups-storm');
      if (kind==='storm_off') document.body.classList.remove('groups-storm');
      if (kind==='pressure') {
        // body classes are already managed by engine; keep optional
      }
    }, {passive:true});

    // End summary
    window.addEventListener('hha:end', (ev)=>{
      const s = ev.detail||{};
      if ($('endRank')) $('endRank').textContent = String(s.grade ?? 'C');
      if ($('endScore')) $('endScore').textContent = String(s.scoreFinal ?? 0);
      if ($('endAcc')) $('endAcc').textContent = String(s.accuracyGoodPct ?? 0) + '%';
      if ($('endMiss')) $('endMiss').textContent = String(s.misses ?? 0);
      if ($('endSub')) $('endSub').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏ö: ${String(s.reason||'end')} ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô ${String(s.durationPlayedSec||0)}s`;
      showEnd(true);
    }, {passive:true});

    // Buttons
    const btnReplay = $('btnReplay');
    if (btnReplay){
      btnReplay.addEventListener('click', ()=>{
        try{
          const u = new URL(location.href);
          // ‡∏£‡∏µ‡πÄ‡∏û‡∏•‡∏¢‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°
          location.href = u.toString();
        }catch{
          location.reload();
        }
      });
    }
    const btnHub = $('btnBackHub');
    if (btnHub){
      btnHub.addEventListener('click', ()=>{
        const hub = (new URL(location.href)).searchParams.get('hub');
        if (hub) location.href = hub;
        else location.href = '../hub.html';
      });
    }
  })();
  </script>
</body>
</html>