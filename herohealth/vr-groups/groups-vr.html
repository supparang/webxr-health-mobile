<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run ‚Äî PRODUCTION (HHA Standard) ‚Äî PATCH LOCKPX + FX
‚úÖ Auto tune lockPx for Mobile/cVR (‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á)
‚úÖ Sets window.HHA_VRUI_CONFIG BEFORE loading vr-ui.js
‚úÖ Fallback tap shooter (emit hha:shoot) if needed
‚úÖ Loads order: vr-ui -> particles -> effects-pack -> groups.safe
‚úÖ Wires HUD/Quest/Power/Coach/Overlays + end summary + back hub
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <style>
    /* tiny helper: keep UI selectable off */
    .noSel{ -webkit-user-select:none; user-select:none; }
    /* debug pill */
    .pill.pillDebug{ opacity:.92; }
    .pill.pillDebug .lbl{ color: rgba(229,231,235,.72); }
    .pill.pillDebug .val{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
  </style>

  <script>
    (function(){
      'use strict';

      const qs = (k, d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
      const clamp = (v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));

      // ---- view detection (do NOT override if view= exists) ----
      function detectView(){
        const v = String(qs('view','')||'').toLowerCase();
        if (v) return v;

        // lightweight detection
        const ua = navigator.userAgent || '';
        const isMobile = /Android|iPhone|iPad|iPod/i.test(ua) || (Math.min(screen.width, screen.height) <= 820);
        // if WebXR present and not mobile -> still default pc
        return isMobile ? 'mobile' : 'pc';
      }

      const view = detectView();

      // ---- lockPx tuning (THE MAIN PATCH) ----
      // Priority:
      // 1) ?lockPx= (manual)
      // 2) per-view default
      // Notes:
      // - mobile: 44‚Äì56 sweet spot
      // - cVR:   52‚Äì68 sweet spot (‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô/‡∏à‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á)
      // - vr:    28‚Äì38 (XR pointer/center aim ‡∏°‡∏±‡∏Å‡∏ô‡∏¥‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤)
      const qLock = Number(qs('lockPx', ''));
      const defaultLock =
        (view === 'cvr') ? 62 :
        (view === 'mobile') ? 52 :
        (view === 'vr') ? 34 :
        28;

      const lockPx = clamp(Number.isFinite(qLock) && qLock>0 ? qLock : defaultLock, 10, 96);

      // expose for vr-ui.js
      window.HHA_VRUI_CONFIG = Object.assign({}, window.HHA_VRUI_CONFIG || {}, {
        lockPx,
        cooldownMs: 90
      });

      // body view class (CSS uses these)
      const b = document.documentElement; // temp
      window.__GROUPS_VIEW__ = view;
      window.__GROUPS_LOCKPX__ = lockPx;
    })();
  </script>

  <!-- Universal VR UI (must read HHA_VRUI_CONFIG) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Optional particles layer (if you have /herohealth/vr/particles.js or similar) -->
  <!-- If you DON'T have it, it's fine: effects-pack will fallback to DOM FX -->
  <script>
    (function(){
      // If your particles file exists, load it safely. If not, ignore.
      // Change path here if your actual particles file differs.
      const path = "../vr/particles.js";
      const s = document.createElement('script');
      s.src = path;
      s.async = true;
      s.onerror = ()=>{ /* ok */ };
      document.head.appendChild(s);
    })();
  </script>

  <!-- FX pack -->
  <script src="./effects-pack.js"></script>

  <!-- Engine (standalone) -->
  <script src="./groups.safe.js"></script>
</head>

<body class="noSel">

  <!-- XR scene behind DOM (optional, keep pointer-events none) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: true" renderer="colorManagement: true" background="color: #000"></a-scene>

  <!-- ===== HUD ===== -->
  <header class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤</span><span id="hudTime" class="val">--</span></div>
      <div class="pill"><span class="lbl">üéØ ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span><span id="hudCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">üí• MISS</span><span id="hudMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÅ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span><span id="hudScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üìä ACC</span><span id="hudAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">üéì ‡πÄ‡∏Å‡∏£‡∏î</span><span id="hudGrade" class="val">-</span></div>

      <!-- DEBUG (lockPx + last source) -->
      <div class="pill pillDebug">
        <span class="lbl">lockPx</span><span id="hudLock" class="val">--</span>
      </div>
      <div class="pill pillDebug">
        <span class="lbl">src</span><span id="hudSrc" class="val">--</span>
      </div>
    </div>
  </header>

  <!-- ===== QUEST ===== -->
  <section class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="qGoalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: --</span>
        <span id="qGroupTag" class="tag">--</span>
      </div>
      <div class="bar"><div id="qGoalFill" class="fill"></div></div>
      <div id="qGoalSub" class="qSub">0 / 0</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="qMiniTitle">MINI: --</span>
        <span id="qMiniTag" class="tag">‚è≥</span>
      </div>
      <div class="bar"><div id="qMiniFill" class="fill"></div></div>
      <div id="qMiniSub" class="qSub">0 / 0</div>
    </div>
  </section>

  <!-- Big banner -->
  <div id="bigBanner" class="bigBanner hidden">
    <div id="bigBannerText" class="bigBannerText">--</div>
  </div>

  <!-- ===== PLAY LAYER (targets) ===== -->
  <main id="playLayer" class="playLayer" aria-label="play area"></main>

  <!-- ===== POWER ===== -->
  <section class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° ‡∏û‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
      <div class="bar powerBar"><div id="powerFill" class="fill"></div></div>
      <div id="powerSub" class="pFoot">0 / 0</div>
    </div>
  </section>

  <!-- ===== COACH ===== -->
  <aside class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" src="../img/coach-neutral.png" alt="coach" id="coachImg"/>
      <div class="coachBubble">
        <div class="coachName">‡πÇ‡∏Ñ‡πâ‡∏ä HeroHealth</div>
        <div class="coachText" id="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! üéÆ</div>
      </div>
    </div>
  </aside>

  <!-- ===== OVERLAY: calibration / start ===== -->
  <section id="overlayStart" class="overlay">
    <div class="panel">
      <div class="title">üçΩÔ∏è Food Groups VR</div>
      <div class="sub">
        ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏î‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß!<br/>
        <b>‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Ñ‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î</b> ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á üéØ (‡∏°‡∏µ Aim Assist ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
      </div>

      <div class="grid2">
        <div class="stat">
          <div class="k">‡πÇ‡∏´‡∏°‡∏î / View</div>
          <div class="v" id="statMode">--</div>
        </div>
        <div class="stat">
          <div class="k">lockPx (‡∏à‡∏π‡∏ô‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î)</div>
          <div class="v" id="statLock">--</div>
        </div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button id="btnStart" class="btn btn-strong">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnBackHub" class="btn btn-ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        ‡∏ó‡∏¥‡∏õ: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏¢‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ <b>&lockPx=62</b> (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/cVR) ‡∏´‡∏£‡∏∑‡∏≠ <b>&lockPx=40</b> (VR)
      </div>
    </div>
  </section>

  <!-- ===== OVERLAY: end ===== -->
  <section id="overlayEnd" class="overlay hidden">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</div>
      <div class="sub" id="endSub">--</div>

      <div class="grid2">
        <div class="stat"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">Accuracy</div><div class="v" id="endAcc">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div class="v" id="endMiss">0</div></div>
        <div class="stat"><div class="k">Grade</div><div class="v" id="endGrade">-</div></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button id="btnReplay" class="btn btn-strong">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnBackHub2" class="btn btn-ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (HHA_LAST_SUMMARY) ‡πÅ‡∏•‡∏∞ flush log ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ?log=
      </div>
    </div>
  </section>

  <script>
    (function(){
      'use strict';

      const WIN = window;
      const DOC = document;

      const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
      const clamp = (v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));
      const nowMs = ()=>{ try{ return performance.now(); }catch(_){ return Date.now(); } };

      // ---- apply body class view-* ----
      const view = String(WIN.__GROUPS_VIEW__ || qs('view','mobile') || 'mobile').toLowerCase();
      DOC.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr','cardboard');
      if (view === 'pc') DOC.body.classList.add('view-pc');
      else if (view === 'vr') DOC.body.classList.add('view-vr');
      else if (view === 'cvr') DOC.body.classList.add('view-cvr','cardboard');
      else DOC.body.classList.add('view-mobile');

      // ---- core params ----
      const hub = String(qs('hub','')||'');
      const diff = String(qs('diff','normal')||'normal').toLowerCase();
      const runMode = String(qs('run','play')||'play').toLowerCase(); // play|research|practice
      const time = clamp(Number(qs('time', 90)), 15, 180);
      const seed = String(qs('seed','')||Date.now());
      const lockPx = clamp(Number(WIN.__GROUPS_LOCKPX__ || (WIN.HHA_VRUI_CONFIG && WIN.HHA_VRUI_CONFIG.lockPx) || 0), 10, 96);

      // UI refs
      const hudTime  = DOC.getElementById('hudTime');
      const hudCombo = DOC.getElementById('hudCombo');
      const hudMiss  = DOC.getElementById('hudMiss');
      const hudScore = DOC.getElementById('hudScore');
      const hudAcc   = DOC.getElementById('hudAcc');
      const hudGrade = DOC.getElementById('hudGrade');
      const hudLock  = DOC.getElementById('hudLock');
      const hudSrc   = DOC.getElementById('hudSrc');

      const qGoalTitle = DOC.getElementById('qGoalTitle');
      const qGroupTag  = DOC.getElementById('qGroupTag');
      const qGoalFill  = DOC.getElementById('qGoalFill');
      const qGoalSub   = DOC.getElementById('qGoalSub');

      const qMiniTitle = DOC.getElementById('qMiniTitle');
      const qMiniTag   = DOC.getElementById('qMiniTag');
      const qMiniFill  = DOC.getElementById('qMiniFill');
      const qMiniSub   = DOC.getElementById('qMiniSub');

      const powerFill  = DOC.getElementById('powerFill');
      const powerSub   = DOC.getElementById('powerSub');

      const coachImg   = DOC.getElementById('coachImg');
      const coachText  = DOC.getElementById('coachText');

      const overlayStart = DOC.getElementById('overlayStart');
      const overlayEnd   = DOC.getElementById('overlayEnd');

      const statMode = DOC.getElementById('statMode');
      const statLock = DOC.getElementById('statLock');

      const btnStart  = DOC.getElementById('btnStart');
      const btnBackHub= DOC.getElementById('btnBackHub');
      const btnReplay = DOC.getElementById('btnReplay');
      const btnBackHub2= DOC.getElementById('btnBackHub2');

      const endSub   = DOC.getElementById('endSub');
      const endScore = DOC.getElementById('endScore');
      const endAcc   = DOC.getElementById('endAcc');
      const endMiss  = DOC.getElementById('endMiss');
      const endGrade = DOC.getElementById('endGrade');

      const bigBanner = DOC.getElementById('bigBanner');
      const bigBannerText = DOC.getElementById('bigBannerText');

      let lastSummary = null;

      // show debug
      hudLock.textContent = String(lockPx);
      hudSrc.textContent = '-';
      statMode.textContent = `${runMode} / ${view} / ${diff} / ${time}s`;
      statLock.textContent = String(lockPx);

      // ---- FX pack init (safe) ----
      try{
        const FX = WIN.GroupsVR && WIN.GroupsVR.EffectsPack;
        FX && FX.init && FX.init({ layerEl: DOC.getElementById('playLayer') });
      }catch(_){}

      // ---- connect engine to playLayer ----
      try{
        const E = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
        E && E.setLayerEl && E.setLayerEl(DOC.getElementById('playLayer'));
      }catch(_){}

      // ---- fallback shooter (CRITICAL for some Androids) ----
      // Emits hha:shoot even if vr-ui.js missed a tap.
      // IMPORTANT: does NOT block vr-ui; it just ensures shots exist.
      let lastFallbackAt = 0;
      function emitShoot(x,y, source){
        try{
          WIN.dispatchEvent(new CustomEvent('hha:shoot', {
            detail: { x, y, lockPx, source: source || 'tap-fallback', t: nowMs() }
          }));
          hudSrc.textContent = String(source || 'tap-fallback');
        }catch(_){}
      }

      function onPointerUp(e){
        // only when game started (overlay hidden)
        if (!overlayStart.classList.contains('hidden')) return;

        const t = nowMs();
        if (t - lastFallbackAt < 85) return; // throttle
        lastFallbackAt = t;

        let x = 0, y = 0;
        try{
          if (e && typeof e.clientX === 'number') { x = e.clientX; y = e.clientY; }
          else return;
        }catch(_){ return; }

        emitShoot(x,y,'pointerup');
      }

      // cVR strict: shoot from center if user taps anywhere (feels right with crosshair)
      function onClickAnywhere(e){
        if (!overlayStart.classList.contains('hidden')) return;

        const isCVR = DOC.body.classList.contains('view-cvr');
        if (!isCVR) return;

        const t = nowMs();
        if (t - lastFallbackAt < 85) return;
        lastFallbackAt = t;

        const x = (WIN.innerWidth||360)/2;
        const y = (WIN.innerHeight||640)/2;
        emitShoot(x,y,'cvr-center');
      }

      DOC.getElementById('playLayer').addEventListener('pointerup', onPointerUp, { passive:true });
      DOC.addEventListener('click', onClickAnywhere, { passive:true });

      // ---- UI events from engine ----
      WIN.addEventListener('hha:time', (ev)=>{
        const left = (ev && ev.detail) ? Number(ev.detail.left||0) : 0;
        hudTime.textContent = `${left}s`;
      }, { passive:true });

      WIN.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudScore.textContent = String(d.score ?? 0);
        hudCombo.textContent = String(d.combo ?? 0);
        hudMiss.textContent  = String(d.misses ?? 0);
      }, { passive:true });

      WIN.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudAcc.textContent = `${Number(d.accuracy||0)}%`;
        hudGrade.textContent = String(d.grade||'-');
      }, { passive:true });

      WIN.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        qGoalTitle.textContent = d.goalTitle || '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
        qGroupTag.textContent  = d.groupName || '--';
        qGoalFill.style.width  = `${clamp(d.goalPct||0,0,100)}%`;
        qGoalSub.textContent   = `${d.goalNow||0} / ${d.goalTotal||0}`;

        qMiniTitle.textContent = d.miniTitle || 'MINI';
        const left = Number(d.miniTimeLeftSec||0);
        qMiniTag.textContent   = left>0 ? `‚è≥ ${left}s` : '‚è≥';
        qMiniFill.style.width  = `${clamp(d.miniPct||0,0,100)}%`;
        qMiniSub.textContent   = `${d.miniNow||0} / ${d.miniTotal||0}`;
        // urgent class for css
        if (left>0 && left<=4) DOC.body.classList.add('mini-urgent');
        else DOC.body.classList.remove('mini-urgent');
      }, { passive:true });

      WIN.addEventListener('groups:power', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const c = Number(d.charge||0);
        const th= Math.max(1, Number(d.threshold||1));
        const pct = Math.round((c/th)*100);
        powerFill.style.width = `${clamp(pct,0,100)}%`;
        powerSub.textContent = `${c} / ${th}`;
      }, { passive:true });

      WIN.addEventListener('hha:coach', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        coachText.textContent = String(d.text||'');
        const mood = String(d.mood||'neutral').toLowerCase();
        const img =
          (mood==='happy') ? '../img/coach-happy.png' :
          (mood==='sad') ? '../img/coach-sad.png' :
          (mood==='fever') ? '../img/coach-fever.png' :
          '../img/coach-neutral.png';
        coachImg.src = img;

        // banner ping
        showBanner(d.text || '');
      }, { passive:true });

      WIN.addEventListener('groups:progress', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const k = String(d.kind||'');
        if (k==='storm_on') showBanner('üå™Ô∏è STORM!');
        if (k==='storm_off') showBanner('‚ú® CLEAR!');
        if (k==='boss_spawn') showBanner('üëä BOSS!');
        if (k==='boss_down') showBanner('üí• BOSS DOWN!');
        if (k==='perfect_switch') showBanner('üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà!');
      }, { passive:true });

      WIN.addEventListener('hha:end', (ev)=>{
        lastSummary = (ev && ev.detail) ? ev.detail : null;

        // store latest summary (HHA Standard)
        try{
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify({
            at: Date.now(),
            game: 'GroupsVR',
            summary: lastSummary
          }));
          const histKey = 'HHA_SUMMARY_HISTORY';
          const arr = JSON.parse(localStorage.getItem(histKey) || '[]');
          arr.unshift({ at: Date.now(), game:'GroupsVR', summary:lastSummary });
          while(arr.length > 50) arr.pop();
          localStorage.setItem(histKey, JSON.stringify(arr));
        }catch(_){}

        // show end overlay
        overlayEnd.classList.remove('hidden');
        endSub.textContent = `‡πÇ‡∏´‡∏°‡∏î: ${lastSummary?.runMode||'-'} / diff: ${lastSummary?.diff||'-'} / seed: ${lastSummary?.seed||'-'}`;
        endScore.textContent = String(lastSummary?.scoreFinal ?? 0);
        endAcc.textContent   = `${Number(lastSummary?.accuracyGoodPct||0)}%`;
        endMiss.textContent  = String(lastSummary?.misses ?? 0);
        endGrade.textContent = String(lastSummary?.grade ?? '-');
      }, { passive:true });

      // banner helper
      let bannerT = 0;
      function showBanner(text){
        text = String(text||'').trim();
        if (!text) return;
        bigBanner.classList.remove('hidden');
        bigBanner.classList.add('show');
        bigBannerText.textContent = text.slice(0, 60);

        clearTimeout(bannerT);
        bannerT = setTimeout(()=>{
          bigBanner.classList.remove('show');
          setTimeout(()=>bigBanner.classList.add('hidden'), 160);
        }, 900);
      }

      // ---- buttons ----
      function goHub(){
        if (hub) location.href = hub;
        else history.back();
      }

      btnBackHub.addEventListener('click', goHub);
      btnBackHub2.addEventListener('click', goHub);

      btnStart.addEventListener('click', ()=>{
        overlayStart.classList.add('hidden');

        // start engine
        try{
          const E = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
          if (!E || !E.start) throw new Error('Engine not ready');

          // flush-harden (if present)
          try{
            WIN.GroupsVR.bindFlushOnLeave && WIN.GroupsVR.bindFlushOnLeave(()=>lastSummary);
          }catch(_){}

          E.start(diff, {
            runMode,
            time,
            seed
          });

          // tiny ping
          showBanner('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! üéØ');
        }catch(err){
          overlayStart.classList.remove('hidden');
          alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
        }
      });

      btnReplay.addEventListener('click', ()=>{
        overlayEnd.classList.add('hidden');
        overlayStart.classList.add('hidden');
        try{
          const E = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
          E && E.stop && E.stop();
          E && E.start && E.start(diff, { runMode, time, seed: String(Date.now()) });
        }catch(_){}
      });

      // ---- show start overlay default ----
      overlayStart.classList.remove('hidden');

      // ---- ensure effects-pack selftest if requested ----
      // (effects-pack.js handles ?selftest=1 itself)

      // ---- keep debug lockPx in HUD always ----
      hudLock.textContent = String(lockPx);
    })();
  </script>

  <!-- A-Frame CDN (keep minimal) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</body>
</html>