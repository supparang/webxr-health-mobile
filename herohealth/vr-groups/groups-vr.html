<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run ‚Äî PRODUCTION (HHA Standard)
‚úÖ Uses /herohealth/vr/vr-ui.js (ENTER VR/EXIT/RECENTER + crosshair + hha:shoot)
‚úÖ PATCH: lockPx tuned for mobile + query override (?lockPx=44)
‚úÖ Fallback tap-to-shoot if vr-ui not emitting
‚úÖ Uses groups.safe.js (standalone) + effects-pack.js
‚úÖ Safe start overlay (user gesture) + robust layer wiring
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark"/>
  <link rel="icon" href="../favicon.ico" type="image/x-icon"/>

  <link rel="stylesheet" href="./groups-vr.css"/>

  <style>
    /* tiny safety for run overlay if css missing */
    .bootOverlay{
      position:fixed; inset:0; z-index:80;
      display:flex; align-items:center; justify-content:center;
      padding: env(safe-area-inset-top, 0px) 14px env(safe-area-inset-bottom, 0px) 14px;
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
    }
    .bootOverlay.hidden{ display:none; }
    .bootPanel{
      width:min(680px, 100%);
      border-radius: 22px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.82);
      box-shadow: 0 22px 66px rgba(0,0,0,.50);
      padding: 14px;
      color:#e5e7eb;
    }
    .bootTitle{ font-weight:1100; font-size:18px; margin:0 0 8px 0; }
    .bootSub{ font-weight:900; font-size:13px; line-height:1.4; opacity:.88; margin:0 0 12px 0; }
    .bootGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .bootGrid{ grid-template-columns:1fr; } }
    .bootBtn{
      appearance:none; width:100%;
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.65);
      color:#e5e7eb;
      font-weight:1100;
      cursor:pointer;
    }
    .bootBtn:active{ transform: translateY(1px); }
    .bootBtnStrong{
      border-color: rgba(34,197,94,.38);
      background: rgba(34,197,94,.16);
    }
    .bootNote{ margin-top:10px; font-size:12px; font-weight:900; opacity:.86; line-height:1.35; }
    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .miniPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      font-weight:1000; font-size:12px;
    }
  </style>

  <script>
    // ---- query helpers ----
    function qs(k, d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }
    function clamp(v,a,b){ v = Number(v)||0; return Math.max(a, Math.min(b, v)); }

    // ---- PATCH: lockPx tuning (mobile-friendly) ----
    // default 42 = "‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢" (‡πÄ‡∏î‡πá‡∏Å ‡∏õ.5 / ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
    // override: ?lockPx=44 (range 18..96)
    (function(){
      const qLock = qs('lockPx', '');
      const lockPx = clamp(qLock ? Number(qLock) : 42, 18, 96);

      // Global config read by /herohealth/vr/vr-ui.js
      window.HHA_VRUI_CONFIG = Object.assign({}, window.HHA_VRUI_CONFIG||{}, {
        lockPx,
        cooldownMs: 90
      });

      // expose for debug/UI
      window.__HHA_LOCKPX__ = lockPx;
    })();
  </script>

  <!-- VR UI (must load early) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Optional particles (if you have it; safe if missing) -->
  <!-- <script src="../vr/particles.js"></script> -->

  <!-- FX pack -->
  <script src="./effects-pack.js"></script>

  <!-- Engine (standalone) -->
  <script src="./groups.safe.js"></script>
</head>

<body class="view-mobile">
  <!-- (Optional) A-Frame scene behind DOM if you use it -->
  <!-- <a-scene class="xr-scene" embedded vr-mode-ui="enabled:false"></a-scene> -->

  <!-- HUD (top) -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">TIME</span><span id="hudTime" class="val">--</span></div>
      <div class="pill"><span class="lbl">SCORE</span><span id="hudScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span id="hudCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">MISS</span><span id="hudMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">ACC</span><span id="hudAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">GRADE</span><span id="hudGrade" class="val">-</span></div>
    </div>
  </div>

  <!-- Quest (top mid) -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="qGoalTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å</span>
        <span id="qGroupTag" class="tag">‚Äî</span>
      </div>
      <div class="bar"><div id="qGoalFill" class="fill"></div></div>
      <div id="qGoalSub" class="qSub">0/0</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="qMiniTitle">MINI</span>
        <span id="qMiniTag" class="tag">‚Äî</span>
      </div>
      <div class="bar"><div id="qMiniFill" class="fill"></div></div>
      <div id="qMiniSub" class="qSub">0/0</div>
    </div>
  </div>

  <!-- Big Banner -->
  <div id="bigBanner" class="bigBanner hidden">
    <div id="bigBannerText" class="bigBannerText">‚Äî</div>
  </div>

  <!-- Play Layer (targets spawn inside #playLayer -> #groupsPlayWrap) -->
  <div id="playLayer" class="playLayer" aria-label="play-layer"></div>

  <!-- Power (bottom mid) -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">POWER</div>
      <div class="bar powerBar"><div id="powerFill" class="fill"></div></div>
      <div id="powerSub" class="pFoot">0/0</div>
    </div>
  </div>

  <!-- Coach (bottom left) -->
  <div class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" src="../img/coach-neutral.png" alt="coach"/>
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div id="coachText" class="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üéÆ</div>
      </div>
    </div>
  </div>

  <!-- End overlay (optional; if you already have another end overlay, keep one) -->
  <div id="endOverlay" class="overlay hidden">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div id="endSub" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">SCORE</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">ACCURACY</div><div id="endAcc" class="v">0%</div></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button id="btnReplay" class="btn btn-strong">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnBackHub" class="btn btn-ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        TIP: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° <b>?lockPx=44</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>?lockPx=48</b>
      </div>
    </div>
  </div>

  <!-- Boot overlay (user gesture) -->
  <div id="bootOverlay" class="bootOverlay">
    <div class="bootPanel">
      <h2 class="bootTitle">üçΩÔ∏è Food Groups VR</h2>
      <p class="bootSub">
        ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß!<br/>
        <b>‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</b> ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Aim Assist (lockPx)
      </p>

      <div class="miniRow">
        <div class="miniPill">lockPx: <span id="bootLockPx">‚Äî</span></div>
        <div class="miniPill">view: <span id="bootView">‚Äî</span></div>
        <div class="miniPill">diff: <span id="bootDiff">‚Äî</span></div>
        <div class="miniPill">run: <span id="bootRun">‚Äî</span></div>
      </div>

      <div class="bootGrid" style="margin-top:12px;">
        <button id="btnStart" class="bootBtn bootBtnStrong">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnTune" class="bootBtn">‡∏à‡∏π‡∏ô‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î (lockPx +6)</button>
      </div>

      <div class="bootNote">
        ‡∏ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏á‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πà‡∏≠‡∏¢: ‡∏Å‡∏î ‚Äú‡∏à‡∏π‡∏ô‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‚Äù 1‚Äì2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà <b>?lockPx=48</b> ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå
      </div>
    </div>
  </div>

  <script>
    // ---------------- view / mode helpers ----------------
    function qs(k, d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }
    function clamp(v,a,b){ v = Number(v)||0; return Math.max(a, Math.min(b, v)); }

    function detectView(){
      // DO NOT override if user provides ?view=
      const vq = String(qs('view','')||'').toLowerCase();
      if (vq) return vq;

      // simple heuristic
      const w = window.innerWidth || 360;
      const h = window.innerHeight || 640;
      const isMobile = Math.min(w,h) <= 520;
      return isMobile ? 'mobile' : 'pc';
    }

    function applyViewClass(view){
      document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      if (view === 'pc') document.body.classList.add('view-pc');
      else if (view === 'vr') document.body.classList.add('view-vr');
      else if (view === 'cvr') document.body.classList.add('view-cvr');
      else document.body.classList.add('view-mobile');
    }

    const view = detectView();
    applyViewClass(view);

    // show debug
    document.getElementById('bootLockPx').textContent = String(window.__HHA_LOCKPX__ ?? 0);
    document.getElementById('bootView').textContent = view;
    document.getElementById('bootDiff').textContent = String(qs('diff','normal')||'normal');
    document.getElementById('bootRun').textContent  = String(qs('run','play')||'play');

    // ---------------- wire UI (HUD/Quest/Coach/Power/End) ----------------
    const elTime = document.getElementById('hudTime');
    const elScore= document.getElementById('hudScore');
    const elCombo= document.getElementById('hudCombo');
    const elMiss = document.getElementById('hudMiss');
    const elAcc  = document.getElementById('hudAcc');
    const elGrade= document.getElementById('hudGrade');

    const qGoalTitle = document.getElementById('qGoalTitle');
    const qGroupTag  = document.getElementById('qGroupTag');
    const qGoalFill  = document.getElementById('qGoalFill');
    const qGoalSub   = document.getElementById('qGoalSub');

    const qMiniTitle = document.getElementById('qMiniTitle');
    const qMiniTag   = document.getElementById('qMiniTag');
    const qMiniFill  = document.getElementById('qMiniFill');
    const qMiniSub   = document.getElementById('qMiniSub');

    const powerFill  = document.getElementById('powerFill');
    const powerSub   = document.getElementById('powerSub');
    const coachText  = document.getElementById('coachText');

    const endOverlay = document.getElementById('endOverlay');
    const endSub     = document.getElementById('endSub');
    const endScore   = document.getElementById('endScore');
    const endAcc     = document.getElementById('endAcc');

    const bigBanner  = document.getElementById('bigBanner');
    const bigBannerText = document.getElementById('bigBannerText');

    function showBanner(text, tone){
      if(!bigBanner || !bigBannerText) return;
      bigBanner.classList.remove('hidden','show','tone-neutral','tone-good','tone-warn','tone-bad');
      bigBanner.classList.add('tone-' + (tone||'neutral'));
      bigBannerText.textContent = text || '';
      bigBanner.classList.add('show');
      setTimeout(()=>{ try{ bigBanner.classList.remove('show'); }catch(_){} }, 900);
      setTimeout(()=>{ try{ bigBanner.classList.add('hidden'); }catch(_){} }, 980);
    }

    window.addEventListener('hha:time', (e)=>{
      const left = (e && e.detail) ? Number(e.detail.left)||0 : 0;
      elTime.textContent = left + 's';
    }, {passive:true});

    window.addEventListener('hha:score', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      elScore.textContent = String(d.score ?? 0);
      elCombo.textContent = String(d.combo ?? 0);
      elMiss.textContent  = String(d.misses ?? 0);
    }, {passive:true});

    window.addEventListener('hha:rank', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      elAcc.textContent = String(d.accuracy ?? 0) + '%';
      elGrade.textContent = String(d.grade ?? '-');
    }, {passive:true});

    window.addEventListener('hha:coach', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      coachText.textContent = String(d.text || '');
      // optional banner pop
      if (d.mood === 'happy') showBanner('‡∏î‡∏µ‡∏°‡∏≤‡∏Å!', 'good');
      else if (d.mood === 'fever') showBanner('‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡πà‡∏á!', 'warn');
    }, {passive:true});

    window.addEventListener('quest:update', (e)=>{
      const d = (e && e.detail) ? e.detail : {};

      qGroupTag.textContent = String(d.groupName || '‚Äî');

      qGoalTitle.textContent = String(d.goalTitle || '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å');
      qGoalSub.textContent = `${d.goalNow ?? 0}/${d.goalTotal ?? 0}`;
      qGoalFill.style.width = clamp(d.goalPct ?? 0, 0, 100) + '%';

      qMiniTitle.textContent = String(d.miniTitle || 'MINI');
      const tLeft = Number(d.miniTimeLeftSec || 0);
      qMiniTag.textContent = (tLeft > 0) ? ('‚è±Ô∏è ' + tLeft + 's') : '‚Äî';
      qMiniSub.textContent = `${d.miniNow ?? 0}/${d.miniTotal ?? 0}`;
      qMiniFill.style.width = clamp(d.miniPct ?? 0, 0, 100) + '%';

      // urgent style
      if (tLeft > 0 && tLeft <= 3) document.body.classList.add('mini-urgent');
      else document.body.classList.remove('mini-urgent');
    }, {passive:true});

    window.addEventListener('groups:power', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      const cur = Number(d.charge || 0);
      const thr = Math.max(1, Number(d.threshold || 1));
      const pct = clamp((cur/thr)*100, 0, 100);
      powerFill.style.width = pct + '%';
      powerSub.textContent = `${cur}/${thr}`;
    }, {passive:true});

    window.addEventListener('hha:end', (e)=>{
      const d = (e && e.detail) ? e.detail : {};
      endOverlay.classList.remove('hidden');
      endScore.textContent = String(d.scoreFinal ?? 0);
      endAcc.textContent = String(d.accuracyGoodPct ?? 0) + '%';
      endSub.textContent = `GRADE ${d.grade ?? '-'} ‚Ä¢ MISS ${d.misses ?? 0} ‚Ä¢ SHOTS ${d.shots ?? 0} ‚Ä¢ seed ${d.seed ?? ''}`;
    }, {passive:true});

    // ---------------- Start / Buttons ----------------
    const bootOverlay = document.getElementById('bootOverlay');
    const btnStart = document.getElementById('btnStart');
    const btnTune  = document.getElementById('btnTune');

    function startGame(){
      try{
        // ensure layer is wired
        const layer = document.getElementById('playLayer');
        window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.setLayerEl(layer);

        // init fx pack (just in case)
        window.GroupsVR && window.GroupsVR.EffectsPack && window.GroupsVR.EffectsPack.init &&
          window.GroupsVR.EffectsPack.init({ layerEl: layer });

        const diff = String(qs('diff','normal')||'normal');
        const ctx = {
          seed: String(qs('seed','')||Date.now()),
          time: Number(qs('time', 90)),
          runMode: String(qs('run','play')||'play')
        };

        window.GroupsVR.GameEngine.start(diff, ctx);

        bootOverlay.classList.add('hidden');
      }catch(err){
        console.error(err);
        coachText.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      }
    }

    btnStart.addEventListener('click', startGame);

    btnTune.addEventListener('click', ()=>{
      // bump lockPx +6 then reload with query param
      const cur = clamp(Number(window.__HHA_LOCKPX__ ?? 42), 18, 96);
      const next = clamp(cur + 6, 18, 96);
      const u = new URL(location.href);
      u.searchParams.set('lockPx', String(next));
      location.href = u.toString();
    });

    // End overlay buttons
    document.getElementById('btnReplay').addEventListener('click', ()=>{
      const u = new URL(location.href);
      // keep same lockPx/diff/view/time/run/seed if you want; regenerate seed for play
      u.searchParams.set('seed', String(Date.now()));
      location.href = u.toString();
    });

    document.getElementById('btnBackHub').addEventListener('click', ()=>{
      const hub = qs('hub','');
      if (hub) location.href = hub;
      else history.back();
    });

    // ---------------- Fallback tap-to-shoot (IMPORTANT) ----------------
    // If vr-ui is present, it will emit hha:shoot already.
    // But some devices block overlay clicks or pointer-events -> fallback from playLayer.
    (function(){
      const layer = document.getElementById('playLayer');
      if(!layer) return;

      let lastTapAt = 0;

      layer.addEventListener('pointerdown', (ev)=>{
        // do not double-fire too rapidly
        const t = performance.now ? performance.now() : Date.now();
        if (t - lastTapAt < 55) return;
        lastTapAt = t;

        // If vr-ui is loaded, it might be using center aim.
        // Still safe to emit: engine will lockPx-snap to nearest target if needed.
        const lockPx = clamp(Number(window.__HHA_LOCKPX__ ?? 42), 0, 96);

        const x = (ev && typeof ev.clientX === 'number') ? ev.clientX : (window.innerWidth||360)/2;
        const y = (ev && typeof ev.clientY === 'number') ? ev.clientY : (window.innerHeight||640)/2;

        try{
          window.dispatchEvent(new CustomEvent('hha:shoot', {
            detail:{ x, y, lockPx, source:'tap-layer' }
          }));
        }catch(_){}
      }, {passive:true});
    })();

    // ---------------- Auto FX selftest helper ----------------
    // Add ?selftest=1 to see FX READY (from effects-pack.js)
    // nothing needed here, effects-pack reads query itself
  </script>
</body>
</html>