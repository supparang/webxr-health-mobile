<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />

  <!-- ‚úÖ Core CSS (targets + views + crosshair + vrbar base) -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- (optional) FX/logger same ecosystem as other games -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>

  <!-- ‚úÖ Universal VR UI (ENTER/EXIT/RECENTER + crosshair + tap-to-shoot emits hha:shoot)
       NOTE: Groups is DOM game, so vr-ui is used as "Cardboard UI"
  -->
  <script src="../vr/vr-ui.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;

      /* safe-area */
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    html,body{
      margin:0; height:100%; overflow:hidden;
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
    }

    /* ---------------- HUD ---------------- */
    .hud{
      position:fixed; left:0; right:0; top:0;
      padding: calc(12px + var(--sat)) 12px 10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none; z-index:50;
    }
    .hud .box{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      min-width:120px;
    }
    .hud .big{ font-weight:900; font-size:16px; }
    .hud .small{ font-size:12px; color:var(--muted); margin-top:2px; }

    .centerTop{
      position:fixed; left:50%; transform:translateX(-50%);
      top: calc(10px + var(--sat));
      z-index:55; pointer-events:none;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    .pill{
      background:rgba(15,23,42,.72);
      border:1px solid rgba(148,163,184,.16);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color:var(--text);
      box-shadow:0 16px 40px rgba(0,0,0,.35);
    }

    /* ---------------- Quest (GOAL/MINI) ---------------- */
    .questTop{
      position:fixed;
      right:calc(10px + var(--sar));
      top:  calc(62px + var(--sat));
      left:auto;
      width: min(340px, 48vw);
      display:flex; gap:10px; flex-wrap:wrap;
      z-index:58; pointer-events:none;
    }
    .qbar{
      flex:1 1 240px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.14);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .qbar .t{ font-size:12px; color:var(--muted); }
    .qbar .b{ margin-top:2px; font-size:13px; font-weight:900; }
    .qbar .p{
      margin-top:8px; height:10px;
      background:rgba(15,23,42,.65);
      border:1px solid rgba(148,163,184,.14);
      border-radius:999px; overflow:hidden;
    }
    .qbar .p > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
    }
    .qbar .time{
      margin-top:6px;
      font-size:12px;
      color:rgba(226,232,240,.85);
      display:none;
    }

    /* ---------------- Power Bar ---------------- */
    .powerWrap{
      position:fixed; left:12px; right:12px;
      bottom: calc(14px + var(--sab));
      z-index:60; pointer-events:none;
    }
    .power{
      height:14px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.65);
      overflow:hidden;
    }
    .power > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
    }
    .powerLabel{
      margin-top:8px; font-size:12px; color:var(--muted);
      display:flex; justify-content:space-between;
    }

    /* ---------------- Coach bottom-right ---------------- */
    .coachWrap{
      position:fixed;
      right:calc(10px + var(--sar));
      bottom: calc(82px + var(--sab)); /* ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ Power bar */
      z-index:70;
      pointer-events:none;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .coachCard{
      width:220px;
      background:rgba(2,6,23,.60);
      border:1px solid rgba(148,163,184,.14);
      border-radius:18px;
      padding:10px 10px 10px;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .coachLine{ font-size:12px; color:rgba(226,232,240,.92); line-height:1.45; min-height:34px; }
    .feverMini{
      margin-top:8px;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.65);
      overflow:hidden;
    }
    .feverMini > i{ display:block; height:100%; width:0%; background:rgba(239,68,68,.85); }
    .shieldTag{
      margin-top:8px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(226,232,240,.92);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.60);
    }
    .coachImg{
      width:74px; height:74px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.55);
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .coachImg img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* ---------------- Overlays ---------------- */
    .overlay{
      position:fixed; inset:0;
      background:radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 60%),
                 radial-gradient(circle at bottom right, rgba(34,197,94,.18), transparent 60%),
                 rgba(2,6,23,.82);
      display:grid; place-items:center;
      z-index:200;
    }
    .panel{
      width:min(760px, 92vw);
      border:1px solid rgba(148,163,184,.20);
      border-radius:22px;
      background:rgba(2,6,23,.72);
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      padding:18px 18px 14px;
    }
    .panel h2{ margin:0 0 8px; font-size:20px; }
    .panel p{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6; }
    .panel .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .panel button{
      border:0; border-radius:999px; padding:12px 14px;
      font-weight:900; cursor:pointer;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
      color:#061018;
    }
    .panel button.secondary{
      background:rgba(15,23,42,.78);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
    }
    .dbg{ font-size:12px; color:var(--muted); opacity:.92; margin-top:6px; }
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(239,68,68,.25);
      background:rgba(239,68,68,.08);
      color:rgba(254,226,226,.95);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
    #endOverlay{ display:none; }
    #endOverlay.show{ display:grid; }

    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 12px; }
    .kv .k{
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.55);
      border-radius:16px;
      padding:10px 12px;
      font-size:13px;
    }
    .kv .k b{ display:block; font-size:16px; margin-top:2px; }

    /* ---------------- Mini urgent FX ---------------- */
    body.mini-urgent .questTop .qbar{
      border-color: rgba(239,68,68,.25);
      box-shadow: 0 16px 50px rgba(239,68,68,.10), 0 16px 40px rgba(0,0,0,.25);
      animation: miniUrgentPulse .45s infinite alternate;
    }
    @keyframes miniUrgentPulse{
      from{ filter:none; }
      to{ filter:saturate(1.2) brightness(1.06); }
    }

    /* ---------- Responsive tweaks ---------- */
    @media (max-width: 520px){
      .questTop{
        width: min(300px, 56vw);
        top: calc(58px + var(--sat));
      }
      .coachWrap{
        bottom: calc(90px + var(--sab));
      }
      .coachCard{
        width: min(210px, 58vw);
      }
    }
    @media (max-height: 640px){
      .coachCard{ padding: 8px 10px; }
      .coachLine{ min-height: 28px; }
    }
  </style>
</head>

<body>
  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <div class="big" id="uiScore">0</div>
      <div class="small">SCORE</div>
    </div>
    <div class="box" style="text-align:right;">
      <div class="big"><span id="uiTime">90</span>s</div>
      <div class="small">TIME</div>
    </div>
  </div>

  <div class="centerTop">
    <div class="pill">COMBO: <b id="uiCombo">0</b> (MAX <b id="uiComboMax">0</b>)</div>
    <div class="pill">MISS: <b id="uiMiss">0</b></div>
    <div class="pill">GRADE: <b id="uiGrade">C</b></div>
  </div>

  <!-- Quest (Right) -->
  <div class="questTop" aria-label="Quest">
    <div class="qbar">
      <div class="t">GOAL</div>
      <div class="b" id="uiGoalTitle">‚Äî</div>
      <div class="p"><i id="uiGoalBar"></i></div>
    </div>
    <div class="qbar">
      <div class="t">MINI</div>
      <div class="b" id="uiMiniTitle">‚Äî</div>
      <div class="p"><i id="uiMiniBar"></i></div>
      <div class="time" id="uiMiniTime">‚è≥ 0s</div>
    </div>
  </div>

  <!-- Targets layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="power"><i id="uiPowerBar"></i></div>
    <div class="powerLabel">
      <span>POWER</span>
      <span><b id="uiPower">0</b>/<b id="uiPowerThr">8</b></span>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap" aria-label="Coach">
    <div class="coachCard">
      <div class="coachLine" id="uiCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! üéµ</div>
      <div class="feverMini"><i id="uiFeverBar"></i></div>
      <div class="shieldTag" id="uiShieldTag" style="display:none;">üõ°Ô∏è SHIELD READY</div>
    </div>
    <div class="coachImg">
      <img id="uiCoachImg" src="../img/coach-neutral.png" alt="Coach"/>
    </div>
  </div>

  <!-- ‚úÖ Fallback Crosshair + VR Bar (‡∏ñ‡πâ‡∏≤ vr-ui.js ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°) -->
  <div class="hha-crosshair" id="fallbackCrosshair" aria-hidden="true"></div>
  <div class="hha-vrbar" id="fallbackVrBar" aria-label="VR Buttons">
    <button class="primary" id="btnEnterVr">ENTER VR</button>
    <button id="btnExitVr">EXIT</button>
    <button id="btnRecenter">RECENTER</button>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</h2>
      <p id="startDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <div class="dbg">Boot: <b id="dbgBoot">loading‚Ä¶</b></div>
      <div class="warn" id="warnBox"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart">Start</button>
        <button id="btnBack" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <p class="dbg" style="margin-top:10px;">
        cVR: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ = ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (Aim assist) ‚úÖ
      </p>
    </div>
  </div>

  <!-- End overlay -->
  <div class="overlay" id="endOverlay">
    <div class="panel">
      <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="endReason"></p>

      <div class="kv">
        <div class="k">SCORE<b id="endScore">0</b></div>
        <div class="k">GRADE<b id="endGrade">C</b></div>
        <div class="k">ACCURACY<b id="endAcc">0%</b></div>
        <div class="k">COMBO MAX<b id="endComboMax">0</b></div>
      </div>

      <div class="row">
        <button id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);

    const LS_LAST = 'HHA_LAST_SUMMARY';
    const LS_HIST = 'HHA_SUMMARY_HISTORY';

    const runMode = (q.get('runMode') || 'play').toLowerCase();
    const diff    = (q.get('diff') || 'normal').toLowerCase();
    const style   = (q.get('style') || 'mix').toLowerCase();
    const time    = Number(q.get('time') || 90);
    const seed    = (q.get('seed') || '').trim() || String(Date.now());
    const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
    const view    = (q.get('view') || '').toLowerCase(); // pc / mobile / cvr
    const autostart = q.get('autostart') === '1';
    const v = (q.get('v') || String(Date.now()));

    $('startDesc').textContent = `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed} | view=${view||'auto'}`;

    function setBodyView(viewKey){
      const b = document.body;
      b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      if (viewKey === 'pc') b.classList.add('view-pc');
      else if (viewKey === 'cvr') b.classList.add('view-cvr');
      else if (viewKey === 'vr') b.classList.add('view-vr');
      else b.classList.add('view-mobile');
    }

    // view choose
    if (view === 'pc' || view === 'mobile' || view === 'cvr' || view === 'vr'){
      setBodyView(view);
    } else {
      // auto: touch -> mobile else pc
      setBodyView(('ontouchstart' in window) ? 'mobile' : 'pc');
    }

    function warn(msg){
      console.warn(msg);
      const box = $('warnBox');
      if (!box) return;
      box.style.display = 'block';
      box.textContent += (box.textContent ? '\n' : '') + String(msg);
    }

    async function safeImport(path){
      try{
        await import(path + (path.includes('?') ? '' : ('?v='+encodeURIComponent(v))));
        return true;
      }catch(e){
        warn(`‚ö†Ô∏è load fail: ${path}\n${e?.message || e}`);
        return false;
      }
    }

    // Boot list (global modules)
    const BOOT_LIST = [
      './groups-fx.js',
      './audio.js',
      './groups-quests.js',
      './GameEngine.js',
    ];

    async function boot(){
      $('dbgBoot').textContent = 'loading modules‚Ä¶';
      for (const p of BOOT_LIST) await safeImport(p);
      $('dbgBoot').textContent = (window.GroupsVR && window.GroupsVR.GameEngine) ? 'READY ‚úÖ' : 'ENGINE NOT FOUND ‚ùå';
    }

    // ---------- flush hardened ----------
    function flushHardened(reason){
      try{ window.HHACloudLogger?.flush?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushNow?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushHardened?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flush?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flushNow?.({ reason }); }catch{}
    }

    function goHub(){
      flushHardened('go_hub');
      location.href = hub;
    }
    $('btnBack').addEventListener('click', goHub);
    $('btnHub2').addEventListener('click', goHub);

    addEventListener('pagehide', ()=>flushHardened('pagehide'));
    addEventListener('beforeunload', ()=>flushHardened('beforeunload'));
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'hidden') flushHardened('hidden');
    });

    // ---------- VR helpers (DOM Cardboard) ----------
    function isFs(){
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }
    async function enterFs(){
      try{
        const el = document.documentElement;
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      }catch(_){}
    }
    async function exitFs(){
      try{
        if (document.exitFullscreen) await document.exitFullscreen();
        else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
      }catch(_){}
    }
    function emitVr(state){
      try{ window.dispatchEvent(new CustomEvent('hha:vr',{ detail:{ state } })); }catch{}
    }

    // ‚úÖ Fallback VR Bar actions (works even if vr-ui.js doesn't render its own)
    $('btnEnterVr').addEventListener('click', async ()=>{
      await enterFs();
      setBodyView('cvr');
      $('fallbackCrosshair').style.display = 'block';
      try{ window.GroupsVR?.Audio?.unlock?.(); }catch{}
    });
    $('btnExitVr').addEventListener('click', async ()=>{
      await exitFs();
      // keep view as current; optional switch back to mobile
      setBodyView(('ontouchstart' in window) ? 'mobile' : 'pc');
      $('fallbackCrosshair').style.display = 'none';
    });
    $('btnRecenter').addEventListener('click', ()=>{
      emitVr('reset');
      // also recenter via vr-ui if it listens
    });

    // hide fallback VR bar if your universal vr-ui injected its own UI (best-effort)
    function hideFallbackIfUniversalReady(){
      // heuristic: vr-ui usually adds a container/button(s) + sets globals
      const hasUniversal = !!(window.GAME_MODULES?.VRUI || window.HHAVRUI || document.querySelector('[data-hha-vrui]'));
      if (hasUniversal){
        $('fallbackVrBar').style.display = 'none';
        // crosshair is also handled by vr-ui; keep ours hidden
        $('fallbackCrosshair').style.display = 'none';
      } else {
        // show crosshair only in cVR
        if (document.body.classList.contains('view-cvr')) $('fallbackCrosshair').style.display = 'block';
      }
    }
    setInterval(hideFallbackIfUniversalReady, 800);

    // ‚úÖ Tap-to-shoot fallback for cVR (even if vr-ui missing)
    function emitShootCenter(lockPx=92){
      const x: number = (window.innerWidth||360)*0.5;
      const y: number = (window.innerHeight||640)*0.5;
      try{
        window.dispatchEvent(new CustomEvent('hha:shoot',{ detail:{ x, y, lockPx } }));
      }catch{}
    }

    // In cVR: tap anywhere shoots (but don't block UI buttons)
    window.addEventListener('pointerdown', (ev)=>{
      if (!document.body.classList.contains('view-cvr')) return;
      const t = ev.target;
      if (t && (t.closest?.('#fallbackVrBar') || t.closest?.('#startOverlay') || t.closest?.('#endOverlay'))) return;
      // If vr-ui is present it also emits hha:shoot; this fallback is harmless because aim-assist picks a target; 
      // To avoid double-fire, we gate when vr-ui is likely absent:
      const likelyUniversal = !!(window.GAME_MODULES?.VRUI || window.HHAVRUI || document.querySelector('[data-hha-vrui]'));
      if (!likelyUniversal) emitShootCenter(92);
    }, { passive:true });

    // ---------- UI bind ----------
    let urgentTickTimer = 0;
    let lastTickAt = 0;

    function setMiniUrgent(on){
      document.body.classList.toggle('mini-urgent', !!on);
      if (!on){
        if (urgentTickTimer){ clearInterval(urgentTickTimer); urgentTickTimer = 0; }
        lastTickAt = 0;
      } else {
        if (!urgentTickTimer){
          urgentTickTimer = setInterval(()=>{
            try{ window.GroupsVR?.Audio?.tick?.(); }catch{}
          }, 320);
        }
      }
    }

    function bindEvents(){
      addEventListener('hha:score', (e)=>{
        const d = e.detail||{};
        $('uiScore').textContent = String(d.score ?? 0);
        $('uiCombo').textContent = String(d.combo ?? 0);
        $('uiComboMax').textContent = String(d.comboMax ?? 0);
        $('uiMiss').textContent = String(d.misses ?? 0);
      });
      addEventListener('hha:time', (e)=>{
        const d = e.detail||{};
        $('uiTime').textContent = String(d.left ?? 0);
      });
      addEventListener('groups:power', (e)=>{
        const d = e.detail||{};
        const ch = Number(d.charge||0);
        const thr = Math.max(1, Number(d.threshold||8));
        $('uiPower').textContent = String(ch);
        $('uiPowerThr').textContent = String(thr);
        $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
      });
      addEventListener('hha:rank', (e)=>{
        const d = e.detail||{};
        if (d.grade) $('uiGrade').textContent = String(d.grade);
      });

      addEventListener('quest:update', (e)=>{
        const d = e.detail||{};
        if (d.goalTitle != null) $('uiGoalTitle').textContent = String(d.goalTitle);
        if (d.miniTitle != null) $('uiMiniTitle').textContent = String(d.miniTitle);

        let gp = (d.goalPct != null) ? Number(d.goalPct)
               : (d.goalNow != null && d.goalTotal != null) ? (Number(d.goalNow)/Math.max(1,Number(d.goalTotal)))*100
               : 0;
        let mp = (d.miniPct != null) ? Number(d.miniPct)
               : (d.miniNow != null && d.miniTotal != null) ? (Number(d.miniNow)/Math.max(1,Number(d.miniTotal)))*100
               : 0;

        $('uiGoalBar').style.width = Math.max(0, Math.min(100, gp)).toFixed(1)+'%';
        $('uiMiniBar').style.width = Math.max(0, Math.min(100, mp)).toFixed(1)+'%';

        const tLeft = Number(d.miniTimeLeftSec ?? 0);
        const timeEl = $('uiMiniTime');
        if (Number.isFinite(tLeft) && tLeft > 0){
          timeEl.style.display = 'block';
          timeEl.textContent = `‚è≥ ${tLeft}s`;

          // ‚úÖ urgent when <=3s
          setMiniUrgent(tLeft <= 3);
          if (tLeft <= 3){
            const nowMs = Date.now();
            if (nowMs - lastTickAt > 400){
              lastTickAt = nowMs;
              try{ window.GroupsVR?.Audio?.tick?.(); }catch{}
            }
          }
        } else {
          timeEl.style.display = 'none';
          setMiniUrgent(false);
        }
      });

      addEventListener('hha:coach', (e)=>{
        const d = e.detail||{};
        if (d.text) $('uiCoachLine').textContent = String(d.text);
        const mood = String(d.mood||'neutral');
        const img = (mood==='happy') ? '../img/coach-happy.png'
                 : (mood==='sad')   ? '../img/coach-sad.png'
                 : (mood==='fever') ? '../img/coach-fever.png'
                 : '../img/coach-neutral.png';
        $('uiCoachImg').src = img;
      });

      addEventListener('hha:fever', (e)=>{
        const d = e.detail||{};
        const pct = Math.max(0, Math.min(100, Number(d.feverPct||0)));
        $('uiFeverBar').style.width = pct.toFixed(1)+'%';
        const shield = Number(d.shield||0) > 0;
        $('uiShieldTag').style.display = shield ? 'inline-flex' : 'none';
      });

      addEventListener('hha:end', (e)=>{
        const d = e.detail||{};
        $('endOverlay').classList.add('show');
        $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
        $('endScore').textContent = String(d.scoreFinal ?? 0);
        $('endGrade').textContent = String(d.grade ?? 'C');
        $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
        $('endComboMax').textContent = String(d.comboMax ?? 0);
        $('uiGrade').textContent = String(d.grade ?? 'C');

        // ‚úÖ Save LAST + HISTORY (HUB reads these)
        try{
          const timestampIso = new Date().toISOString();
          const payload = {
            timestampIso,
            projectTag: 'HeroHealth',
            game: 'GroupsVR',
            gameMode: 'GroupsVR',
            ...d,
            params: { runMode, diff, style, time, seed, hub, view: (view||'auto') },
            device: (document.body.classList.contains('view-cvr') ? 'cardboard' : (('ontouchstart' in window) ? 'mobile' : 'pc')),
            gameVersion: 'groupsvr-1.0.0',
            durationPlannedSec: Number(time)||90,
            durationPlayedSec: Number(time)||90
          };

          localStorage.setItem(LS_LAST, JSON.stringify(payload));
          localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));

          // history append
          let hist = [];
          try{
            const s = localStorage.getItem(LS_HIST);
            if (s) hist = JSON.parse(s) || [];
            if (!Array.isArray(hist)) hist = [];
          }catch{ hist = []; }

          hist.unshift(payload);
          // keep only latest 50
          hist = hist.slice(0, 50);
          localStorage.setItem(LS_HIST, JSON.stringify(hist));
        }catch{}

        flushHardened('end');
      });
    }

    // ---------- Engine readiness ----------
    function waitEngineReady(){
      return new Promise((resolve)=>{
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;
          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            resolve(GE);
          }
          if (tries > 250){
            clearInterval(t);
            warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GroupsVR.GameEngine.start() ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ 200 ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏£‡∏á');
            $('dbgBoot').textContent = 'ENGINE NOT FOUND ‚ùå';
          }
        }, 80);
      });
    }

    async function startGame(){
      $('btnStart').disabled = true;
      $('startDesc').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶';

      // unlock audio quickly
      try{ window.GroupsVR?.Audio?.unlock?.(); }catch{}

      await boot();
      const GE = await waitEngineReady();
      if (!GE){ $('btnStart').disabled = false; return; }

      GE.setLayerEl($('fg-layer'));
      GE.start(diff, { runMode, style, time, seed });

      $('startOverlay').style.display = 'none';
      $('endOverlay').classList.remove('show');

      $('btnStart').disabled = false;
    }

    $('btnStart').addEventListener('click', startGame);
    $('btnReplay').addEventListener('click', ()=>{
      try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
      $('endOverlay').classList.remove('show');
      $('startOverlay').style.display = 'grid';
      if (autostart) setTimeout(startGame, 250);
    });

    // ensure hub/back flush
    $('btnBack').addEventListener('click', ()=>flushHardened('back'));
    $('btnHub2').addEventListener('click', ()=>flushHardened('hub2'));

    bindEvents();
    await boot();

    // if view=cvr -> show crosshair fallback (until vr-ui takes over)
    if (document.body.classList.contains('view-cvr')){
      $('fallbackCrosshair').style.display = 'block';
    }

    if (autostart) setTimeout(()=> $('btnStart').click(), 350);
  </script>
</body>
</html>