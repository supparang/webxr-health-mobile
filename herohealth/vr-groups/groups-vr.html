<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run ‚Äî PRODUCTION (HHA Standard)
‚úÖ Root=launcher, run=folder friendly
‚úÖ LockPx tuned for Mobile/cVR (set BEFORE vr-ui.js)
‚úÖ Tap-to-start overlay (reliable user gesture)
‚úÖ Fatal overlay (prevents ‚Äústuck screen‚Äù with no info)
‚úÖ HUD/Quest/Power/Coach + BigBanner + End Summary
‚úÖ FX restored: listens to groups:hit (effects-pack.js)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="dark light"/>
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon"/>

  <link rel="stylesheet" href="./groups-vr.css"/>

  <style>
    /* Minimal extras (safe) */
    .hidden{ display:none !important; }
    .tapOverlay .panel{ text-align:center; }
    .tapOverlay .title{ font-size:20px; }
    .tapOverlay .sub{ margin-top:6px; }
    .tapPill{
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; padding:10px 14px;
      background:rgba(15,23,42,.65); border:1px solid rgba(148,163,184,.22);
      font-weight:1100; margin-top:12px;
    }
    .mini-urg{ color:rgba(245,158,11,.98); font-weight:1200; }
  </style>

  <script>
    // -------------------------
    // Query helpers + view apply
    // -------------------------
    (function(){
      const q = new URL(location.href).searchParams;

      function detectBaseView(){
        // Respect explicit view if provided
        const v = String(q.get('view')||'').toLowerCase();
        if (v === 'pc' || v === 'mobile' || v === 'vr' || v === 'cvr') return v;

        // Auto detect
        const coarse = !!(window.matchMedia && matchMedia('(pointer:coarse)').matches);
        const isMobileUA = /android|iphone|ipad|ipod/i.test(navigator.userAgent||'');
        return (coarse || isMobileUA) ? 'mobile' : 'pc';
      }

      const view = detectBaseView();

      // body class for CSS rails
      document.addEventListener('DOMContentLoaded', ()=>{
        document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
        document.body.classList.add('view-' + view);
      });

      // -------------------------
      // VR-UI lockPx tuning (IMPORTANT: BEFORE loading vr-ui.js)
      // -------------------------
      // "‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏î" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Ñ‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î
      let lockPx = 18;     // pc default
      let cooldownMs = 80;

      if (view === 'mobile'){ lockPx = 34; cooldownMs = 75; }
      if (view === 'cvr')   { lockPx = 44; cooldownMs = 70; } // ‡∏™‡∏∏‡∏î

      // Optional debug override: ?lock=40
      const lockQ = Number(q.get('lock')||0);
      if (lockQ > 0) lockPx = Math.max(6, Math.min(96, lockQ));

      window.HHA_VRUI_CONFIG = { lockPx, cooldownMs };

      // expose for UI debug
      window.__GROUPS_VIEW__ = view;
      window.__LOCKPX__ = lockPx;
    })();
  </script>

  <!-- Optional particles (used by EffectsPack if available) -->
  <script src="../vr/particles.js?v=1" defer></script>

  <!-- Effects Pack (listens groups:hit) -->
  <script src="./effects-pack.js?v=1" defer></script>

  <!-- Universal VR UI (ENTER VR / EXIT / RECENTER + crosshair + tap-to-shoot => hha:shoot) -->
  <script src="../vr/vr-ui.js?v=1" defer></script>

  <!-- Engine (IIFE) -->
  <script src="./groups.safe.js?v=1" defer></script>
</head>

<body>
  <!-- XR Scene behind DOM (kept pointer-events:none by CSS) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled:false" renderer="colorManagement:true" background="color:#000">
    <a-entity camera position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- ===== HUD TOP ===== -->
  <header class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">SCORE</span><span id="hudScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span id="hudCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">MISS</span><span id="hudMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">TIME</span><span id="hudTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">ACC</span><span id="hudAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">RANK</span><span id="hudRank" class="val">-</span></div>
    </div>
  </header>

  <!-- ===== QUEST TOP MID ===== -->
  <section class="questTop">
    <!-- GOAL -->
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: ‡∏´‡∏°‡∏π‡πà 1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</div>
        <div id="goalTag" class="tag">‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div id="goalSub" class="qSub">0/12</div>
    </div>

    <!-- MINI -->
    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI: ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        <div id="miniTag" class="tag">MINI</div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div id="miniSub" class="qSub">0/5</div>
    </div>
  </section>

  <!-- ===== BIG BANNER ===== -->
  <div id="bigBanner" class="bigBanner hidden">
    <div id="bigBannerText" class="bigBannerText">‚Äî</div>
  </div>

  <!-- ===== PLAY LAYER (engine spawns targets here) ===== -->
  <main id="playLayer" class="playLayer" aria-label="play area"></main>

  <!-- ===== POWER ===== -->
  <section class="powerWrap">
    <div class="powerCard">
      <div class="pHead">POWER (‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà)</div>
      <div class="bar powerBar"><div id="powerFill" class="fill"></div></div>
      <div id="powerSub" class="pFoot">0/8</div>
    </div>
  </section>

  <!-- ===== COACH ===== -->
  <section class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach"/>
      <div class="coachBubble">
        <div class="coachName">HeroHealth Coach</div>
        <div id="coachText" class="coachText">‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üéØ</div>
      </div>
    </div>
  </section>

  <!-- ===== TAP TO START overlay (reliable) ===== -->
  <section id="tapOverlay" class="overlay tapOverlay">
    <div class="panel">
      <div class="title">Food Groups VR</div>
      <div class="sub">
        ‡πÇ‡∏´‡∏°‡∏î: <b id="tapMode">play</b> ¬∑ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <b id="tapDiff">normal</b> ¬∑ ‡πÄ‡∏ß‡∏•‡∏≤: <b id="tapTime">90</b>s<br/>
        View: <b id="tapView">mobile</b> ¬∑ lockPx: <b id="tapLock">34</b>
      </div>

      <div class="tapPill">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (Tap-to-start)</div>

      <div class="grid2" style="margin-top:14px">
        <button id="btnStart" class="btn btn-strong">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnBackHub" class="btn btn-ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px">
        ‡∏ñ‡πâ‡∏≤ ‚Äú‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‚Äù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (Fatal Overlay) ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚úÖ
      </div>
    </div>
  </section>

  <!-- ===== END overlay ===== -->
  <section id="endOverlay" class="overlay hidden">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">-</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row2" style="margin-top:12px">
        <button id="btnReplay" class="btn btn-strong">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" class="btn btn-ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px" id="endNote">‚Äî</div>
    </div>
  </section>

  <!-- ===== FATAL overlay (prevents silent stuck) ===== -->
  <section id="fatalOverlay" class="overlay hidden">
    <div class="panel">
      <div class="title">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
      <div class="sub" id="fatalMsg">‚Äî</div>
      <div class="row2" style="margin-top:12px">
        <button class="btn btn-strong" onclick="location.reload()">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
        <button class="btn btn-ghost" id="btnHubFatal">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div class="note" style="margin-top:10px">
        ‡∏ó‡∏¥‡∏õ: ‡πÄ‡∏õ‡∏¥‡∏î DevTools/Console ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô error ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ
      </div>
    </div>
  </section>

  <script>
    (function(){
      const DOC = document;
      const WIN = window;

      // ---------- helpers ----------
      function qs(k,d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }
      function show(el){ el && el.classList.remove('hidden'); }
      function hide(el){ el && el.classList.add('hidden'); }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, Number(v)||0)); }

      const tapOverlay = DOC.getElementById('tapOverlay');
      const endOverlay = DOC.getElementById('endOverlay');
      const fatalOverlay = DOC.getElementById('fatalOverlay');

      const hudScore = DOC.getElementById('hudScore');
      const hudCombo = DOC.getElementById('hudCombo');
      const hudMiss  = DOC.getElementById('hudMiss');
      const hudTime  = DOC.getElementById('hudTime');
      const hudAcc   = DOC.getElementById('hudAcc');
      const hudRank  = DOC.getElementById('hudRank');

      const goalTitle= DOC.getElementById('goalTitle');
      const goalTag  = DOC.getElementById('goalTag');
      const goalFill = DOC.getElementById('goalFill');
      const goalSub  = DOC.getElementById('goalSub');

      const miniTitle= DOC.getElementById('miniTitle');
      const miniFill = DOC.getElementById('miniFill');
      const miniSub  = DOC.getElementById('miniSub');

      const powerFill= DOC.getElementById('powerFill');
      const powerSub = DOC.getElementById('powerSub');

      const coachImg = DOC.getElementById('coachImg');
      const coachText= DOC.getElementById('coachText');

      const bigBanner= DOC.getElementById('bigBanner');
      const bigBannerText= DOC.getElementById('bigBannerText');

      let lastSummary = null;
      let started = false;

      function hubUrl(){
        const h = String(qs('hub','')||'');
        return h || '../hub.html';
      }

      function goHub(){
        location.href = hubUrl();
      }

      function showFatal(msg){
        DOC.getElementById('fatalMsg').textContent = String(msg||'Unknown error');
        hide(tapOverlay);
        hide(endOverlay);
        show(fatalOverlay);
      }

      function setCoach(mood, text){
        const m = String(mood||'neutral').toLowerCase();
        const img =
          (m === 'happy') ? '../img/coach-happy.png' :
          (m === 'sad')   ? '../img/coach-sad.png' :
          (m === 'fever') ? '../img/coach-fever.png' :
                            '../img/coach-neutral.png';
        coachImg.src = img;
        coachText.textContent = String(text||'');
      }

      // Big banner helper
      let bannerTimer = 0;
      function banner(text, tone){
        bigBannerText.textContent = String(text||'');
        bigBanner.classList.remove('hidden','show','tone-neutral','tone-good','tone-warn','tone-bad');
        bigBanner.classList.add('show', 'tone-' + (tone||'neutral'));
        clearTimeout(bannerTimer);
        bannerTimer = setTimeout(()=>{
          bigBanner.classList.remove('show');
          setTimeout(()=> bigBanner.classList.add('hidden'), 160);
        }, 950);
      }

      // ---------- event wiring ----------
      WIN.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudScore.textContent = String(d.score ?? 0);
        hudCombo.textContent = String(d.combo ?? 0);
        hudMiss.textContent  = String(d.misses ?? 0);
      }, { passive:true });

      WIN.addEventListener('hha:time', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudTime.textContent = String(d.left ?? 0);
      }, { passive:true });

      WIN.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudAcc.textContent  = String((d.accuracy ?? 0)) + '%';
        hudRank.textContent = String(d.grade ?? '-');
      }, { passive:true });

      WIN.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        goalTitle.textContent = String(d.goalTitle || '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å');
        goalTag.textContent   = String(d.groupName || '‡∏´‡∏°‡∏π‡πà');
        goalFill.style.width  = clamp(d.goalPct ?? 0, 0, 100) + '%';
        goalSub.textContent   = `${d.goalNow ?? 0}/${d.goalTotal ?? 0}`;

        miniTitle.textContent = String(d.miniTitle || 'MINI');
        miniFill.style.width  = clamp(d.miniPct ?? 0, 0, 100) + '%';

        const left = Number(d.miniTimeLeftSec||0);
        if (left > 0){
          miniSub.innerHTML = `${d.miniNow ?? 0}/${d.miniTotal ?? 0} <span class="mini-urg">¬∑ ${left}s</span>`;
          if (left <= 3) DOC.body.classList.add('mini-urgent');
          else DOC.body.classList.remove('mini-urgent');
        }else{
          DOC.body.classList.remove('mini-urgent');
          miniSub.textContent = `${d.miniNow ?? 0}/${d.miniTotal ?? 0}`;
        }
      }, { passive:true });

      WIN.addEventListener('groups:power', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const c = Number(d.charge||0), thr = Math.max(1, Number(d.threshold||8));
        powerFill.style.width = clamp((c/thr)*100, 0, 100) + '%';
        powerSub.textContent = `${c}/${thr}`;
      }, { passive:true });

      WIN.addEventListener('hha:coach', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        setCoach(d.mood||'neutral', d.text||'');
      }, { passive:true });

      // Optional progress banners (storm/boss/switch)
      WIN.addEventListener('groups:progress', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const k = String(d.kind||'');
        if (k === 'storm_on') banner('‡∏û‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üå™Ô∏è', 'warn');
        else if (k === 'storm_off') banner('‡∏û‡∏≤‡∏¢‡∏∏‡∏à‡∏ö! ‚ú®', 'good');
        else if (k === 'boss_spawn') banner('‡∏ö‡∏≠‡∏™‡∏°‡∏≤! üëä', 'warn');
        else if (k === 'boss_down') banner('‡∏ö‡∏≠‡∏™‡πÅ‡∏ï‡∏Å! üí•', 'good');
        else if (k === 'perfect_switch') banner('‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà! üéØ', 'neutral');
      }, { passive:true });

      WIN.addEventListener('hha:end', (ev)=>{
        lastSummary = (ev && ev.detail) ? ev.detail : null;

        // show end overlay
        const s = lastSummary || {};
        DOC.getElementById('endScore').textContent = String(s.scoreFinal ?? 0);
        DOC.getElementById('endRank').textContent  = String(s.grade ?? '-');
        DOC.getElementById('endAcc').textContent   = String(s.accuracyGoodPct ?? 0) + '%';
        DOC.getElementById('endMiss').textContent  = String(s.misses ?? 0);

        DOC.getElementById('endSub').textContent =
          `‡πÇ‡∏´‡∏°‡∏î ${s.runMode||'play'} ¬∑ ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${s.diff||'normal'} ¬∑ view ${s.view||''} ¬∑ seed ${s.seed||''}`;

        DOC.getElementById('endNote').textContent =
          `Tip: ‡∏ñ‡πâ‡∏≤ MISS ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° lockPx (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ?lock=48) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡∏¥‡∏á ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå`;

        show(endOverlay);
      }, { passive:true });

      // ---------- boot logic ----------
      function bootEngine(){
        try{
          if (!WIN.GroupsVR || !WIN.GroupsVR.GameEngine || typeof WIN.GroupsVR.GameEngine.start !== 'function'){
            throw new Error('GroupsVR.GameEngine ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ groups.safe.js ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏°)');
          }

          const diff = String(qs('diff','normal')||'normal').toLowerCase();
          const ctx = {
            runMode: String(qs('run','play')||'play').toLowerCase(),
            seed: qs('seed','') || '',
            time: Number(qs('time',90)||90)
          };

          // Ensure playLayer is the target layer
          const playLayer = DOC.getElementById('playLayer');
          WIN.GroupsVR.GameEngine.setLayerEl(playLayer);

          const ok = WIN.GroupsVR.GameEngine.start(diff, ctx);
          if (!ok) throw new Error('GameEngine.start() ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

          // Flush harden (optional)
          if (WIN.GroupsVR.bindFlushOnLeave){
            WIN.GroupsVR.bindFlushOnLeave(()=>lastSummary);
          }

          started = true;
          hide(tapOverlay);
          hide(fatalOverlay);
          hide(endOverlay);

          // tiny coach hint
          setCoach('neutral', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üéØ');
          return true;
        }catch(e){
          showFatal(e && e.message ? e.message : String(e));
          return false;
        }
      }

      function stopEngine(){
        try{
          WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.stop && WIN.GroupsVR.GameEngine.stop();
        }catch(_){}
      }

      // ---------- buttons ----------
      DOC.getElementById('btnStart').addEventListener('click', ()=>{
        // wait a tick to ensure deferred scripts are parsed
        setTimeout(bootEngine, 0);
      });

      DOC.getElementById('btnBackHub').addEventListener('click', goHub);
      DOC.getElementById('btnHub2').addEventListener('click', goHub);
      DOC.getElementById('btnHubFatal').addEventListener('click', goHub);

      DOC.getElementById('btnReplay').addEventListener('click', ()=>{
        hide(endOverlay);
        stopEngine();
        setTimeout(()=> bootEngine(), 50);
      });

      // Tap overlay summary
      function fillTapInfo(){
        const view = (WIN.__GROUPS_VIEW__ || '').toString();
        DOC.getElementById('tapView').textContent = view || 'mobile';
        DOC.getElementById('tapLock').textContent = String(WIN.__LOCKPX__ ?? '');
        DOC.getElementById('tapMode').textContent = String(qs('run','play')||'play');
        DOC.getElementById('tapDiff').textContent = String(qs('diff','normal')||'normal');
        DOC.getElementById('tapTime').textContent = String(qs('time',90)||90);
      }

      // Auto: show overlay, but also allow autostart if ?autostart=1
      DOC.addEventListener('DOMContentLoaded', ()=>{
        fillTapInfo();
        setCoach('neutral', '‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏¥‡∏á/‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà ‚úÖ');

        const auto = String(qs('autostart','0')||'0') === '1';
        if (auto){
          // give time for defer scripts to load
          setTimeout(()=> bootEngine(), 120);
        }else{
          show(tapOverlay);
        }
      });

      // Catch global errors => show fatal (prevents silent stuck)
      WIN.addEventListener('error', (e)=>{
        if (started) return;
        const msg = (e && e.message) ? e.message : 'Unknown JS error';
        showFatal(msg);
      });

      WIN.addEventListener('unhandledrejection', (e)=>{
        if (started) return;
        const msg = (e && e.reason) ? (e.reason.message || String(e.reason)) : 'Unhandled promise rejection';
        showFatal(msg);
      });
    })();
  </script>
</body>
</html>