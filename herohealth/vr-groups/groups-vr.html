<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR (Run)</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />

  <!-- GUARD: ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ CSS ‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏±‡∏á .hidden ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà -->
  <style>
    .hidden{ display:none !important; }
    html,body{ margin:0; width:100%; height:100%; background:#020617; color:#e5e7eb;
      font-family:system-ui,-apple-system,"Noto Sans Thai","Segoe UI",Roboto,sans-serif; }
  </style>

  <!-- MAIN CSS (‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) -->
  <link id="cssMain" rel="stylesheet" href="./groups-vr.css?v=20260203-2" />
  <script>
    (function(){
      const link = document.getElementById('cssMain');
      link.addEventListener('error', ()=>{
        alert('CSS ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ./groups-vr.css (‡πÄ‡∏ä‡πá‡∏Å path/‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏ö‡∏ô GitHub Pages)');
      });
    })();
  </script>

  <!-- ‚úÖ ‡∏à‡∏π‡∏ô‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: lockPx -->
  <script>
    window.HHA_VRUI_CONFIG = {
      lockPx: 44,     // ‚òÖ ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (36‚Äì54). ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å "‡∏î‡∏π‡∏î‡πÅ‡∏£‡∏á‡∏™‡∏∏‡∏î" ‡πÉ‡∏™‡πà 54
      cooldownMs: 80
    };
  </script>
</head>

<body class="view-mobile">
  <div class="xr-scene" aria-hidden="true"></div>

  <header class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span class="val" id="hudTime">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span class="val" id="hudCombo">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span class="val" id="hudMiss">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üéØ ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">üèÖ RANK</span><span class="val" id="hudRank">D</span></div>
    </div>
  </header>

  <section class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="qGoalTitle">GOAL</span>
        <span class="tag" id="qGoalCount">0/12</span>
      </div>
      <div class="bar"><div class="fill" id="qGoalFill"></div></div>
      <div class="qSub" id="qGoalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="qMiniTitle">MINI</span>
        <span class="tag" id="qMiniCount">0/5</span>
      </div>
      <div class="bar"><div class="fill" id="qMiniFill"></div></div>
      <div class="qSub" id="qMiniSub">‚Äî</div>
    </div>
  </section>

  <div class="bigBanner hidden" id="bigBanner">
    <div class="bigBannerText" id="bigBannerText">READY</div>
  </div>

  <!-- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏∏‡∏î: targets spawn ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
  <main class="playLayer" id="playLayer" aria-label="Play layer"></main>

  <section class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div class="fill" id="pFill"></div></div>
      <div class="pFoot" id="pText">0/8 ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </section>

  <section class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" alt="Coach" src="../img/coach-neutral.png" />
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üéØ</div>
      </div>
    </div>
  </section>

  <section class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>
      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnRetry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div class="note" style="margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </section>

  <div style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:80; pointer-events:auto;" id="startGate">
    <button class="btn btn-strong" style="width:min(360px, 92vw); padding:16px 14px; font-size:16px;" id="btnStart">
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
    </button>
  </div>

  <script>
    function loadScript(src){
      return new Promise((res, rej)=>{
        const s = document.createElement('script');
        s.src = src;
        s.defer = true;
        s.onload = ()=>res(src);
        s.onerror = ()=>rej(new Error('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + src));
        document.head.appendChild(s);
      });
    }

    const $ = (id)=>document.getElementById(id);
    function qs(k, d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }

    function setViewClass(){
      const v = String(qs('view','mobile')||'mobile').toLowerCase();
      document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      document.body.classList.add('view-' + (v==='pc'?'pc':v==='vr'?'vr':v==='cvr'?'cvr':'mobile'));
    }
    function pctFill(el, pct){
      pct = Math.max(0, Math.min(100, Number(pct)||0));
      el.style.width = pct + '%';
    }

    // HUD events
    window.addEventListener('hha:time', (e)=>{ $('hudTime').textContent = String((e.detail&&e.detail.left)|0); }, {passive:true});
    window.addEventListener('hha:score', (e)=>{
      const d=e.detail||{};
      $('hudScore').textContent=String(d.score|0);
      $('hudCombo').textContent=String(d.combo|0);
      $('hudMiss').textContent =String(d.misses|0);
    }, {passive:true});
    window.addEventListener('hha:rank', (e)=>{
      const d=e.detail||{};
      $('hudAcc').textContent = String((d.accuracy|0)) + '%';
      $('hudRank').textContent= String(d.grade||'D');
    }, {passive:true});

    window.addEventListener('quest:update', (e)=>{
      const d=e.detail||{};
      $('qGoalTitle').textContent = d.goalTitle || 'GOAL';
      $('qGoalCount').textContent = `${d.goalNow|0}/${d.goalTotal|0}`;
      pctFill($('qGoalFill'), d.goalPct|0);
      $('qGoalSub').textContent = d.groupName ? `‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: ${d.groupName}` : (d.goalTitle||'‚Äî');

      $('qMiniTitle').textContent = d.miniTitle || 'MINI';
      $('qMiniCount').textContent = `${d.miniNow|0}/${d.miniTotal|0}`;
      pctFill($('qMiniFill'), d.miniPct|0);
      $('qMiniSub').textContent = (d.miniTimeLeftSec>0) ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${d.miniTimeLeftSec|0}s` : '‚Äî';

      if((d.miniTimeLeftSec|0) > 0 && (d.miniTimeLeftSec|0) <= 4) document.body.classList.add('mini-urgent');
      else document.body.classList.remove('mini-urgent');
    }, {passive:true});

    window.addEventListener('groups:power', (e)=>{
      const d=e.detail||{};
      const c=(d.charge|0), th=Math.max(1,(d.threshold|0));
      pctFill($('pFill'), Math.round((c/th)*100));
      $('pText').textContent = `${c}/${th} ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà`;
    }, {passive:true});

    window.addEventListener('hha:coach', (e)=>{
      const d=e.detail||{};
      $('coachText').textContent = String(d.text||'‚Äî');
      const mood = String(d.mood||'neutral').toLowerCase();
      $('coachImg').src =
        mood==='happy' ? '../img/coach-happy.png' :
        mood==='sad'   ? '../img/coach-sad.png' :
        mood==='fever' ? '../img/coach-fever.png' :
                         '../img/coach-neutral.png';
    }, {passive:true});

    window.addEventListener('hha:end', (e)=>{
      const s=e.detail||{};
      $('endSub').textContent =
        `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${s.scoreFinal|0} ‚Ä¢ ‡∏¢‡∏¥‡∏á ${s.goodShots|0}/${s.shots|0} (${s.accuracyGoodPct|0}%) ‚Ä¢ Miss ${s.misses|0} ‚Ä¢ Rank ${s.grade||'D'}`;
      $('endOverlay').classList.remove('hidden');
    }, {passive:true});

    $('btnRetry').addEventListener('click', ()=>location.reload());
    $('btnHub').addEventListener('click', ()=>{
      const hub = qs('hub','')||'';
      if(hub) location.href = hub;
      else history.back();
    });

    (async function main(){
      setViewClass();

      // ‚úÖ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á root=launcher, run=folder:
      // run ‡∏≠‡∏¢‡∏π‡πà /herohealth/vr-groups/  => ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ../vr/ ‡πÅ‡∏•‡∏∞ ../img/ ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å
      await loadScript('../vr/vr-ui.js');
      await loadScript('../vr/particles.js').catch(()=>{}); // optional
      await loadScript('./effects-pack.js');
      await loadScript('./groups.safe.js'); // ‡πÉ‡∏ä‡πâ PATCH ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

      $('btnStart').addEventListener('click', ()=>{
        $('startGate').style.display = 'none';
        try{
          const diff = String(qs('diff','normal')||'normal');
          const ctx = { time:Number(qs('time',90)||90), seed:qs('seed','')||Date.now(), runMode:qs('run','play')||'play' };
          window.GroupsVR.GameEngine.setLayerEl(document.getElementById('playLayer'));
          window.GroupsVR.GameEngine.start(diff, ctx);
        }catch(err){
          alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
        }
      });
    })();
  </script>
</body>
</html>