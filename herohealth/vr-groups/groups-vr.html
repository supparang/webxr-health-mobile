<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- Shared CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame (minimal scene to enable WebXR Enter VR reliably) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script>
    // default lockPx (calibration slider will change this)
    window.HHA_VRUI_CONFIG = { lockPx: 92 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- AI hooks (disabled by default; keep for later) -->
  <script src="../vr/ai-hooks.js" defer></script>

  <!-- Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./GameEngine.js" defer></script>

  <style>
    /* corner buttons (tap-able even in VR/cVR) */
    .cornerBtns{
      position:fixed;
      right: calc(12px + env(safe-area-inset-right, 0px));
      bottom: calc(82px + env(safe-area-inset-bottom, 0px));
      z-index: 60;
      display:flex;
      gap:10px;
      pointer-events:auto;
    }
    body.view-pc .cornerBtns,
    body.view-mobile .cornerBtns{ bottom: calc(12px + env(safe-area-inset-bottom, 0px)); }
    .cornerBtns .btn{ padding: 10px 12px; border-radius: 14px; font-weight: 1000; }
    .overlay .btn{ pointer-events:auto; }
  </style>
</head>

<body class="view-mobile">

  <!-- XR Scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="colorManagement: true">
    <a-entity position="0 1.6 0">
      <a-camera></a-camera>
    </a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span id="vTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span id="vScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span id="vCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span id="vMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÖ RANK</span><span id="vRank" class="val">C</span></div>
      <div class="pill"><span class="lbl">üéØ ACC</span><span id="vAcc" class="val">0%</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">GOAL</div>
        <div class="tag" id="goalCount">0/1</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag"><span class="miniTime" id="miniTime">‚Äî</span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div id="pFill" class="fill"></div></div>
      <div class="pFoot"><span id="pCur">0</span>/<span id="pThr">8</span> ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">ü•¶ Coach</div>
        <div id="coachText" class="coachText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Play Layer -->
  <div id="playLayer" class="playLayer"></div>

  <!-- corner buttons -->
  <div class="cornerBtns">
    <button id="btnCal" class="btn btn-ghost" type="button">üéØ Calibrate</button>
  </div>

  <!-- Practice overlay -->
  <div id="practiceOverlay" class="overlay hidden">
    <div class="panel">
      <div class="title">üß™ Practice 15s</div>
      <div class="sub">
        ‡∏ù‡∏∂‡∏Å‡πÄ‡∏•‡πá‡∏á + ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á<br/>
        <b id="pracLine">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶</b>
      </div>
      <div class="row row2">
        <button id="btnSkipPractice" class="btn btn-strong" type="button">‡∏Ç‡πâ‡∏≤‡∏°‡∏ù‡∏∂‡∏Å ‚ñ∂Ô∏è</button>
      </div>
      <div class="note" style="margin-top:10px;">
        Cardboard: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á / ‡∏Å‡∏î Calibrate ‡πÄ‡∏û‡∏∑‡πà‡∏≠ recenter ‡πÑ‡∏î‡πâ
      </div>
    </div>
  </div>

  <!-- Calibration overlay -->
  <div id="calOverlay" class="overlay hidden">
    <div class="panel">
      <div class="title">üéØ Calibration (Cardboard)</div>
      <div class="sub">
        1) ‡∏´‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ crosshair ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á<br/>
        2) ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á<br/>
        3) ‡∏õ‡∏£‡∏±‡∏ö <b>Lock</b> ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á‡∏¢‡∏≤‡∏Å/‡∏î‡∏π‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="kv">
          <div class="k">Aim Assist LockPx</div>
          <div class="v">
            <input id="lockRange" type="range" min="40" max="160" value="92" style="width:100%">
            <span class="tag" id="lockVal">92</span>
          </div>
          <div class="note">‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å = ‡∏î‡∏π‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô)</div>
        </div>

        <div class="kv">
          <div class="k">Actions</div>
          <div class="v">
            <button id="btnRecenter" class="btn btn-strong" type="button">üß≠ RECENTER</button>
            <button id="btnCloseCal" class="btn" type="button">‚úÖ Done</button>
          </div>
          <div class="note">RECENTER ‡∏à‡∏∞ emit <code>hha:vr {state:'reset'}</code></div>
        </div>
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopy" class="btn" type="button">üìã Copy JSON</button>
      </div>
      <div class="row row2">
        <button id="btnBackLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
        <button id="btnHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        VR Cardboard: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (ENTER VR/EXIT/RECENTER ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô vr-ui.js)
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const $ = (id)=>DOC.getElementById(id);

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }
  function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

  function setView(view){
    const b = DOC.body;
    b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    b.classList.add('view-'+view);
  }

  async function copyText(text){
    try { await navigator.clipboard.writeText(String(text||'')); return true; }
    catch {
      try{
        const ta = DOC.createElement('textarea');
        ta.value = String(text||'');
        DOC.body.appendChild(ta);
        ta.select();
        DOC.execCommand('copy');
        ta.remove();
        return true;
      }catch{ return false; }
    }
  }

  // ---------- HUD binds ----------
  window.addEventListener('hha:score', (ev)=>{
    const d = ev.detail||{};
    $('vScore').textContent = String(d.score ?? 0);
    $('vCombo').textContent = String(d.combo ?? 0);
    $('vMiss').textContent  = String(d.misses ?? 0);
  }, {passive:true});

  window.addEventListener('hha:time', (ev)=>{
    const d = ev.detail||{};
    $('vTime').textContent = String(d.left ?? 0);
  }, {passive:true});

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev.detail||{};
    $('vRank').textContent = String(d.grade ?? 'C');
    $('vAcc').textContent  = String((d.accuracy ?? 0) + '%');
  }, {passive:true});

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev.detail||{};
    $('coachText').textContent = String(d.text||'');
    const mood = String(d.mood||'neutral');
    const img =
      (mood==='happy') ? '../img/coach-happy.png' :
      (mood==='sad')   ? '../img/coach-sad.png' :
      (mood==='fever') ? '../img/coach-fever.png' :
                        '../img/coach-neutral.png';
    $('coachImg').src = img;
  }, {passive:true});

  window.addEventListener('groups:power', (ev)=>{
    const d = ev.detail||{};
    const cur = Number(d.charge||0);
    const thr = Math.max(1, Number(d.threshold||8));
    $('pCur').textContent = String(cur|0);
    $('pThr').textContent = String(thr|0);
    $('pFill').style.width = Math.round((cur/thr)*100) + '%';
  }, {passive:true});

  // quest:update -> goal/mini
  window.addEventListener('quest:update', (ev)=>{
    const d = ev.detail||{};
    const gTitle = String(d.goalTitle||'‚Äî');
    const gNow   = Number(d.goalNow||0);
    const gTot   = Math.max(1, Number(d.goalTotal||1));
    const gPct   = clamp(d.goalPct ?? (gNow/gTot*100), 0, 100);

    const mTitle = String(d.miniTitle||'‚Äî');
    const mNow   = Number(d.miniNow||0);
    const mTot   = Math.max(1, Number(d.miniTotal||1));
    const mPct   = clamp(d.miniPct ?? (mNow/mTot*100), 0, 100);
    const mLeft  = Number(d.miniTimeLeftSec||0);

    $('goalTitle').textContent = 'üéØ GOAL';
    $('goalCount').textContent = `${gNow}/${gTot}`;
    $('goalFill').style.width = Math.round(gPct) + '%';
    $('goalSub').textContent = gTitle;

    $('miniTitle').textContent = '‚ö° MINI';
    $('miniFill').style.width = Math.round(mPct) + '%';
    $('miniSub').textContent = mTitle;
    $('miniTime').textContent = (mLeft>0) ? `${mLeft}s` : '‚Äî';

    const urgent = (mLeft>0 && mLeft<=3);
    DOC.body.classList.toggle('mini-urgent', urgent);
  }, {passive:true});

  // ---------- Audio ----------
  function hookAudio(){
    const A = window.GroupsVR && window.GroupsVR.Audio;
    if (!A) return;

    try{ A.unlock && A.unlock(); }catch{}

    window.addEventListener('hha:judge', (ev)=>{
      const d = ev.detail||{};
      const k = String(d.kind||'').toLowerCase();
      if (k==='good') A.good();
      else if (k==='bad') A.bad();
      else if (k==='boss') A.boss();
      else if (k==='miss') A.bad();
    }, {passive:true});

    window.addEventListener('groups:progress', (ev)=>{
      const d = ev.detail||{};
      const kind = String(d.kind||'');
      if (kind==='storm_on') A.storm();
      if (kind==='boss_spawn') A.boss();
      if (kind==='perfect_switch') A.good();
    }, {passive:true});

    let tmr = 0;
    function tickLoop(){
      clearTimeout(tmr);
      const urgent = DOC.body.classList.contains('mini-urgent') || DOC.body.classList.contains('groups-storm-urgent');
      if (urgent) A.tick();
      tmr = setTimeout(tickLoop, urgent ? 420 : 650);
    }
    tickLoop();
  }

  // ---------- AI hooks (disabled; collect only) ----------
  function hookAI(seed, runMode){
    const AI = window.HHA_AI;
    if (!AI || typeof AI.init !== 'function') return;
    AI.init({ seed, runMode, gameTag:'GroupsVR' });

    const feed = (name)=>(ev)=>{
      try{ AI.onEvent(name, ev.detail||{}); }catch{}
    };

    ['hha:score','hha:rank','hha:fever','hha:time','groups:progress','quest:update','hha:judge','hha:coach']
      .forEach(n=> window.addEventListener(n, feed(n), {passive:true}));

    // NOTE: to enable later set window.HHA_AI_ENABLED=true and then apply suggestions
  }

  // ---------- End / Summary (HHA Standard + flush-hardened) ----------
  const LS_LAST = 'HHA_LAST_SUMMARY';
  const LS_HIST = 'HHA_SUMMARY_HISTORY';

  function deviceHint(){
    const ua = navigator.userAgent || '';
    if (/Oculus|Quest/i.test(ua)) return 'vr-headset';
    if (/Android/i.test(ua)) return 'android';
    if (/iPhone|iPad|iPod/i.test(ua)) return 'ios';
    return 'pc';
  }
  function makeSessionId(){
    return 'G' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  const SESSION_ID = makeSessionId();
  const GAME_VERSION = 'groups-2026-01-01b';

  let lastSummary = null;
  let startIso = new Date().toISOString();
  let flushed = false;

  function saveLast(summary){
    try{ localStorage.setItem(LS_LAST, JSON.stringify(summary)); }catch{}
    try{
      const hist = JSON.parse(localStorage.getItem(LS_HIST)||'[]');
      hist.unshift(summary);
      localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 50)));
    }catch{}
  }

  async function flushSummaryOnce(reason){
    if (flushed) return;
    if (!lastSummary) return;
    flushed = true;
    lastSummary.flushReason = String(reason||'flush');

    // optional cloud logger (if you use hha-cloud-logger.js)
    try{
      const L = window.HHA_CloudLogger;
      if (L && typeof L.post === 'function'){
        await L.post(lastSummary);
      }
    }catch(_){}

    try{ localStorage.setItem(LS_LAST, JSON.stringify(lastSummary)); }catch{}
  }

  // ---------- Practice mode ----------
  let ERef = null;
  let practiceActive = false;

  function showPractice(on){
    $('practiceOverlay').classList.toggle('hidden', !on);
  }
  function setPracLine(t){
    $('pracLine').textContent = String(t||'');
  }

  function startEngine(E, diff, runMode, style, time, seed){
    ERef = E;
    E.setLayerEl($('playLayer'));
    startIso = new Date().toISOString();
    E.start(diff, { runMode, diff, style, time, seed });
  }

  $('btnSkipPractice').addEventListener('click', ()=>{
    if (!practiceActive) return;
    // end practice immediately and go real
    try{ window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.stop('skip_practice'); }catch{}
  });

  // intercept end: if practiceActive -> start real game, do not save/show endOverlay
  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail||{};
    const endIso = new Date().toISOString();

    // practice flow
    if (practiceActive){
      practiceActive = false;
      showPractice(false);
      // start real game using cached params
      const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
      const diff = String(qs('diff','normal')||'normal').toLowerCase();
      const style= String(qs('style','mix')||'mix').toLowerCase();
      const time = clamp(qs('time',90), 30, 180);
      const seed = String(qs('seed', Date.now()) || Date.now());

      // reset flush state
      lastSummary = null;
      flushed = false;

      // tiny countdown text
      setPracLine('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á! üöÄ');
      setTimeout(()=>{
        if (ERef) startEngine(ERef, diff, run, style, time, seed);
      }, 250);
      return;
    }

    // REAL end summary
    lastSummary = Object.assign({
      timestampIso: endIso,
      projectTag: 'HeroHealth',
      gameTag: 'GroupsVR',
      sessionId: SESSION_ID,
      gameVersion: GAME_VERSION,
      device: deviceHint(),
      view: String(qs('view','mobile')||'mobile'),
      runMode: String(qs('run','play')||'play'),
      diff: String(qs('diff','normal')||'normal'),
      style: String(qs('style','mix')||'mix'),
      durationPlannedSec: Number(qs('time',90)||90),
      durationPlayedSec: Math.round((Date.now() - Date.parse(startIso))/1000),
      startTimeIso: startIso,
      endTimeIso: endIso,
      seed: String(qs('seed','')||'')
    }, d);

    saveLast(lastSummary);
    flushSummaryOnce('end');

    $('endOverlay').classList.remove('hidden');
    $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');
    $('endScore').textContent = String(d.scoreFinal ?? 0);
    $('endRank').textContent  = String(d.grade ?? 'C');
    $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
    $('endMiss').textContent  = String(d.misses ?? 0);

    const hub = String(qs('hub','')||'');
    $('btnHub').style.display = hub ? 'inline-flex' : 'none';
  }, {passive:true});

  // flush-hardened
  window.addEventListener('pagehide', ()=>{ flushSummaryOnce('pagehide'); }, {passive:true});
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'hidden') flushSummaryOnce('hidden');
  }, {passive:true});
  window.addEventListener('beforeunload', ()=>{ flushSummaryOnce('beforeunload'); }, {passive:true});

  $('btnRestart').addEventListener('click', ()=> location.reload());
  $('btnCopy').addEventListener('click', async ()=>{
    if (!lastSummary){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
    const ok = await copyText(JSON.stringify(lastSummary, null, 2));
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  });

  const _go = (href, why)=>{
    flushSummaryOnce(why).finally(()=>{ location.href = href; });
  };

  $('btnBackLauncher').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    const u = new URL('../groups-vr.html', location.href);
    if (hub) u.searchParams.set('hub', hub);
    _go(u.toString(), 'backLauncher');
  });

  $('btnHub').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    if (!hub){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå hub=...'); return; }
    _go(hub, 'backHub');
  });

  // ---------- Calibration UI ----------
  function openCal(on){
    $('calOverlay').classList.toggle('hidden', !on);
  }
  $('btnCal').addEventListener('click', ()=> openCal(true));
  $('btnCloseCal').addEventListener('click', ()=> openCal(false));
  $('btnRecenter').addEventListener('click', ()=>{
    // reset view drift for DOM layer (GameEngine listens)
    try{
      window.dispatchEvent(new CustomEvent('hha:vr', { detail:{ state:'reset' }}));
    }catch{}
  });

  const lockRange = $('lockRange');
  const lockVal   = $('lockVal');
  function setLock(v){
    v = clamp(v, 40, 160);
    lockRange.value = String(v|0);
    lockVal.textContent = String(v|0);
    window.HHA_VRUI_CONFIG = window.HHA_VRUI_CONFIG || {};
    window.HHA_VRUI_CONFIG.lockPx = v|0;
  }
  lockRange.addEventListener('input', ()=> setLock(lockRange.value));
  setLock( (window.HHA_VRUI_CONFIG && window.HHA_VRUI_CONFIG.lockPx) || 92 );

  // ---------- Start engine ----------
  function waitForEngine(cb){
    const it = setInterval(()=>{
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function'){
        clearInterval(it);
        cb(E);
      }
    }, 60);
  }

  function startFromParams(){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
    const diff = String(qs('diff','normal')||'normal').toLowerCase();
    const style= String(qs('style','mix')||'mix').toLowerCase();
    const time = clamp(qs('time',90), 30, 180);
    const seed = String(qs('seed', Date.now()) || Date.now());

    setView(view);
    hookAudio();
    hookAI(seed, run);

    // practice default for cVR unless explicitly disabled
    const practiceParam = String(qs('practice', (view==='cvr'?'1':'0'))||'0');
    const doPractice = (practiceParam === '1');

    waitForEngine((E)=>{
      // if practice, run 15s easy-ish (still uses same diff but shorter time)
      if (doPractice){
        practiceActive = true;
        showPractice(true);
        setPracLine('‡∏ù‡∏∂‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‚Ä¶ üéØ');

        // start practice with separate seed
        const pSeed = seed + '::practice';
        startEngine(E, diff, 'play', style, 15, pSeed);
      }else{
        startEngine(E, diff, run, style, time, seed);
      }
    });
  }

  startFromParams();
})();
</script>
</body>
</html>