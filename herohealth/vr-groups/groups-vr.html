<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run (PC/Mobile/Cardboard/cVR) — PRODUCTION (HHA Standard)
✅ Uses vr-ui.js (ENTER VR/EXIT/RECENTER + crosshair + tap-to-shoot => hha:shoot)
✅ lockPx tuned HARD for mobile/cVR (auto by ?view=)
✅ Effects restored: particles.js + effects-pack.js (listens groups:hit)
✅ Touch/Click fallback emits hha:shoot even without VRUI
✅ Safe boot + never blank: playLayer exists + engine gets real area
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth — Food Groups VR</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="../favicon.ico" type="image/x-icon"/>

  <link rel="stylesheet" href="./groups-vr.css"/>

  <style>
    /* tiny safety: ensure playLayer exists even if css missing */
    #playLayer{ position:fixed; inset:0; z-index:10; }
  </style>
</head>

<body class="view-mobile">
  <!-- XR scene behind DOM (optional) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: true" renderer="colorManagement: true;" style="display:none"></a-scene>

  <!-- HUD (top) -->
  <div class="hud" aria-hidden="true">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">TIME</span><span class="val" id="hudTime">90</span></div>
      <div class="pill"><span class="lbl">SCORE</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span class="val" id="hudCombo">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">RANK</span><span class="val" id="hudRank">D</span></div>
      <div class="pill"><span class="lbl">MISS</span><span class="val" id="hudMiss">0</span></div>
    </div>
  </div>

  <!-- Quest cards -->
  <div class="questTop" aria-hidden="true">
    <div class="questCard">
      <div class="qTitle">
        <span id="goalTitle">ยิงให้ถูก: หมู่ 1 โปรตีน</span>
        <span class="tag" id="groupTag">g1</span>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">0 / 12</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="miniTitle">MINI: คอมโบติดกัน 5 ครั้ง</span>
        <span class="tag" id="miniTag">10s</span>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">0 / 5</div>
    </div>
  </div>

  <!-- Big banner -->
  <div class="bigBanner hidden" id="bigBanner" aria-hidden="true">
    <div class="bigBannerText" id="bigBannerText">READY</div>
  </div>

  <!-- Play layer (targets spawn here) -->
  <div class="playLayer" id="playLayer"></div>

  <!-- Power -->
  <div class="powerWrap" aria-hidden="true">
    <div class="powerCard">
      <div class="pHead" id="powerHead">POWER</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerSub">0 / 8</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap" aria-hidden="true">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" src="../img/coach-neutral.png" alt="coach"/>
      <div class="coachBubble">
        <div class="coachName" id="coachName">Coach</div>
        <div class="coachText" id="coachText">แตะ/ยิงให้ถูกหมู่ แล้วเก็บคอมโบ!</div>
      </div>
    </div>
  </div>

  <!-- Overlay (end/calibration) - optional -->
  <div class="overlay hidden" id="overlay">
    <div class="panel">
      <div class="title" id="ovTitle">สรุปผล</div>
      <div class="sub" id="ovSub">—</div>
      <div class="grid2">
        <div class="stat"><div class="k">SCORE</div><div class="v" id="ovScore">0</div></div>
        <div class="stat"><div class="k">ACCURACY</div><div class="v" id="ovAcc">0%</div></div>
      </div>
      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnReplay">เล่นอีกครั้ง</button>
        <button class="btn btn-ghost" id="btnBack">กลับ HUB</button>
      </div>
      <div class="note" style="margin-top:10px;" id="ovNote">seed: —</div>
    </div>
  </div>

  <!-- ====== Scripts (ORDER IMPORTANT) ====== -->

  <!-- A-Frame only if you want VR button reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Universal VR UI: ENTER VR/EXIT/RECENTER + crosshair + hha:shoot -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Particles FX base -->
  <script src="../vr/particles.js"></script>

  <!-- Effects pack listens 'groups:hit' and uses Particles/fallback -->
  <script src="./effects-pack.js"></script>

  <!-- Engine (standalone) -->
  <script src="./groups.safe.js"></script>

  <script>
  (function(){
    'use strict';

    const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };

    // ---------- view class ----------
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    document.body.classList.add('view-' + (['pc','mobile','vr','cvr'].includes(view)?view:'mobile'));

    // ---------- lockPx (แบบสุด ยิงติด) ----------
    // mobile: 44 (บาลานซ์สุด) / cvr: 96 (ดูดจาก crosshair ให้ติดง่ายมาก)
    // vr: 72 / pc: 36
    const lockPx =
      (view === 'mobile') ? 44 :
      (view === 'pc')     ? 36 :
      (view === 'vr')     ? 72 :
      (view === 'cvr')    ? 96 : 48;

    window.HHA_VRUI_CONFIG = { lockPx, cooldownMs: 80 };

    // ---------- DOM refs ----------
    const $ = (id)=>document.getElementById(id);

    const hudTime  = $('hudTime');
    const hudScore = $('hudScore');
    const hudCombo = $('hudCombo');
    const hudAcc   = $('hudAcc');
    const hudRank  = $('hudRank');
    const hudMiss  = $('hudMiss');

    const goalTitle = $('goalTitle');
    const groupTag  = $('groupTag');
    const goalFill  = $('goalFill');
    const goalSub   = $('goalSub');

    const miniTitle = $('miniTitle');
    const miniTag   = $('miniTag');
    const miniFill  = $('miniFill');
    const miniSub   = $('miniSub');

    const powerFill = $('powerFill');
    const powerSub  = $('powerSub');

    const coachImg  = $('coachImg');
    const coachText = $('coachText');

    const bigBanner = $('bigBanner');
    const bigBannerText = $('bigBannerText');

    const overlay = $('overlay');
    const ovSub = $('ovSub');
    const ovScore = $('ovScore');
    const ovAcc = $('ovAcc');
    const ovNote = $('ovNote');

    const btnReplay = $('btnReplay');
    const btnBack = $('btnBack');

    const playLayer = $('playLayer');

    // ---------- FX ready ----------
    try{
      window.GroupsVR = window.GroupsVR || {};
      const FX = window.GroupsVR.EffectsPack;
      FX && FX.init && FX.init({ layerEl: playLayer });
    }catch(_){}

    // ---------- Touch/Click fallback => emit hha:shoot ----------
    // สำคัญมาก: ถ้าไม่ได้ใช้ vr-ui.js ก็ยังยิงได้
    function emitShootFromPoint(x,y, source){
      try{
        window.dispatchEvent(new CustomEvent('hha:shoot', {
          detail: { x, y, lockPx, source: source || 'tap' }
        }));
      }catch(_){}
    }

    function onPointer(e){
      // if overlay open, ignore
      if(overlay && !overlay.classList.contains('hidden')) return;

      // use client coordinates
      const x = (e && typeof e.clientX === 'number') ? e.clientX : 0;
      const y = (e && typeof e.clientY === 'number') ? e.clientY : 0;

      // only when inside playLayer bounds (avoid HUD hits)
      try{
        const r = playLayer.getBoundingClientRect();
        if(x < r.left || x > r.right || y < r.top || y > r.bottom) return;
      }catch(_){}

      emitShootFromPoint(x,y,'tap');
    }

    // pointerdown for mobile/pc
    playLayer.addEventListener('pointerdown', onPointer, { passive:true });

    // ---------- UI listeners from engine ----------
    window.addEventListener('hha:time', (ev)=>{
      const left = (ev && ev.detail) ? ev.detail.left : null;
      if(typeof left === 'number') hudTime.textContent = String(left);
    }, { passive:true });

    window.addEventListener('hha:score', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      hudScore.textContent = String(d.score ?? 0);
      hudCombo.textContent = String(d.combo ?? 0);
      hudMiss.textContent  = String(d.misses ?? 0);
    }, { passive:true });

    window.addEventListener('hha:rank', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      hudAcc.textContent  = String((d.accuracy ?? 0)) + '%';
      hudRank.textContent = String(d.grade ?? 'D');
    }, { passive:true });

    window.addEventListener('hha:coach', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if(d.text) coachText.textContent = d.text;

      // mood -> coach image
      const mood = String(d.mood||'neutral').toLowerCase();
      const base = '../img/';
      const src =
        (mood === 'happy') ? (base+'coach-happy.png') :
        (mood === 'sad')   ? (base+'coach-sad.png') :
        (mood === 'fever') ? (base+'coach-fever.png') :
                             (base+'coach-neutral.png');
      if(coachImg) coachImg.src = src;
    }, { passive:true });

    window.addEventListener('quest:update', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      if(goalTitle) goalTitle.textContent = d.goalTitle || 'เป้าหมาย';
      if(groupTag) groupTag.textContent = d.groupKey || 'g?';

      const gp = Number(d.goalPct)||0;
      if(goalFill) goalFill.style.width = Math.max(0, Math.min(100, gp)) + '%';
      if(goalSub) goalSub.textContent = (d.goalNow||0) + ' / ' + (d.goalTotal||0);

      if(miniTitle) miniTitle.textContent = d.miniTitle || 'MINI';
      const left = Number(d.miniTimeLeftSec)||0;
      if(miniTag) miniTag.textContent = left ? (left+'s') : '—';
      const mp = Number(d.miniPct)||0;
      if(miniFill) miniFill.style.width = Math.max(0, Math.min(100, mp)) + '%';
      if(miniSub) miniSub.textContent = (d.miniNow||0) + ' / ' + (d.miniTotal||0);

      // mini urgent class (visual)
      document.body.classList.toggle('mini-urgent', left > 0 && left <= 3);
    }, { passive:true });

    window.addEventListener('groups:power', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      const c = Number(d.charge)||0;
      const th= Math.max(1, Number(d.threshold)||1);
      const pct = Math.round((c/th)*100);
      if(powerFill) powerFill.style.width = Math.max(0, Math.min(100, pct)) + '%';
      if(powerSub) powerSub.textContent = c + ' / ' + th;
    }, { passive:true });

    // end summary overlay
    let lastSummary = null;
    window.addEventListener('hha:end', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      lastSummary = d;

      if(overlay){
        overlay.classList.remove('hidden');
        if(ovSub)   ovSub.textContent = `จบเกม (${d.reason||'end'}) — Rank ${d.grade||'D'}`;
        if(ovScore) ovScore.textContent = String(d.scoreFinal ?? 0);
        if(ovAcc)   ovAcc.textContent = String(d.accuracyGoodPct ?? 0) + '%';
        if(ovNote)  ovNote.textContent = `seed: ${d.seed||'-'} | view: ${d.view||'-'} | diff: ${d.diff||'-'} | run: ${d.runMode||'-'}`;
      }
    }, { passive:true });

    // buttons
    btnReplay && btnReplay.addEventListener('click', ()=>{
      try{ overlay.classList.add('hidden'); }catch(_){}
      try{ window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.start(qs('diff','normal'), { time: Number(qs('time',90)), seed: qs('seed',''), runMode: qs('run','play') }); }catch(_){}
    });

    btnBack && btnBack.addEventListener('click', ()=>{
      const hub = qs('hub','../hub.html');
      try{ location.href = hub; }catch(_){}
    });

    // ---------- start engine ----------
    function startGame(){
      const diff = String(qs('diff','normal')||'normal');
      const time = Number(qs('time',90));
      const seed = qs('seed','');
      const run = String(qs('run','play')||'play');
      try{
        window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.setLayerEl(playLayer);
        window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.start(diff, { time, seed, runMode: run });
      }catch(_){}
    }

    // hide overlay initially
    try{ overlay.classList.add('hidden'); }catch(_){}

    // little banner
    function banner(text, tone){
      if(!bigBanner || !bigBannerText) return;
      bigBanner.classList.remove('hidden');
      bigBanner.classList.remove('tone-neutral','tone-good','tone-warn','tone-bad','show');
      bigBanner.classList.add('tone-' + (tone||'neutral'));
      bigBannerText.textContent = text;
      bigBanner.classList.add('show');
      setTimeout(()=>{ try{ bigBanner.classList.remove('show'); }catch(_){ } }, 800);
      setTimeout(()=>{ try{ bigBanner.classList.add('hidden'); }catch(_){ } }, 980);
    }

    // auto start (no menu)
    banner('START', 'good');
    setTimeout(startGame, 220);

    // optional: flush hardened if Telemetry exists (engine exposes bindFlushOnLeave)
    try{
      window.GroupsVR && window.GroupsVR.bindFlushOnLeave && window.GroupsVR.bindFlushOnLeave(()=>lastSummary);
    }catch(_){}

  })();
  </script>

</body>
</html>