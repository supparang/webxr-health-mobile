<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run (PC/Mobile/Cardboard/cVR)
‚úÖ Uses vr-ui.js + Particles + Effects pack
‚úÖ PACK 13: Calibration helper (cVR) 2-step
‚úÖ PACK 14: Practice 15s (cVR) then auto start real run
‚úÖ PACK 15: AI hooks attach point (disabled by default; play only with ?ai=1)
‚úÖ FINAL-38..42: Research presets + Gate (strict optional) + Consent/Assent + Copy Research URL
‚úÖ Uses groups.safe.js (standalone)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame: minimal scene for WebXR Enter VR reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script>window.HHA_VRUI_CONFIG = { lockPx: 92 };</script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./ai-hooks.js" defer></script>
  <script src="./effects-pack.js" defer></script>
  <script src="./research-ctx.js" defer></script>
  <script src="./flush-log.js" defer></script>
  <script src="./view-helper.js" defer></script>

  <!-- Engine -->
  <script src="./groups.safe.js" defer></script>
</head>

<body class="view-mobile">

  <!-- XR Scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="colorManagement: true">
    <a-entity position="0 1.6 0"><a-camera></a-camera></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span id="vTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span id="vScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span id="vCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span id="vMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÖ RANK</span><span id="vRank" class="val">C</span></div>
      <div class="pill"><span class="lbl">üéØ ACC</span><span id="vAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">üß™ MODE</span><span id="vMode" class="val">PLAY</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">GOAL</div>
        <div class="tag" id="goalCount">0/1</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag"><span class="miniTime" id="miniTime">‚Äî</span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div id="pFill" class="fill"></div></div>
      <div class="pFoot"><span id="pCur">0</span>/<span id="pThr">8</span> ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">ü•¶ Coach</div>
        <div id="coachText" class="coachText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Play Layer -->
  <div id="playLayer" class="playLayer"></div>

  <!-- === Research FAB + Panel (FINAL-38..42) === -->
  <button id="btnResearchFab" class="researchFab" type="button" title="Research">üßæ</button>

  <div id="rTagPanel" class="overlay overlay-rtag hidden">
    <div class="panel rTagPanel">
      <div class="title">üßæ Research Panel</div>
      <div class="sub">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏à‡∏±‡∏¢ + ‡∏Å‡∏î Copy URL ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏à‡∏±‡∏¢</div>

      <div class="grid2" style="margin-top:12px;">
        <div class="stat">
          <div class="k">studyId</div>
          <input id="inStudyId" class="inTxt" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô HHA-GROUPS-2026|G5-1" />
        </div>
        <div class="stat">
          <div class="k">participantId</div>
          <input id="inParticipantId" class="inTxt" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô P001" />
        </div>
        <div class="stat">
          <div class="k">conditionGroup</div>
          <input id="inConditionGroup" class="inTxt" type="text" placeholder="A/B/C" />
        </div>
        <div class="stat">
          <div class="k">sessionId</div>
          <input id="inSessionId" class="inTxt" type="text" placeholder="AUTO" />
        </div>
      </div>

      <div class="rConsentRow" style="margin-top:10px;">
        <label class="rChk"><input id="ckConsentParent" type="checkbox" /> <span>Consent ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span></label>
        <label class="rChk"><input id="ckAssentChild" type="checkbox" /> <span>Assent ‡πÄ‡∏î‡πá‡∏Å</span></label>
        <label class="rChk"><input id="ckStrict" type="checkbox" /> <span>Strict (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Consent/Assent)</span></label>
      </div>

      <div class="rPresetWrap" style="margin-top:10px;">
        <div class="rPresetTitle">‚ö° Quick Presets</div>

        <div class="rPresetRow">
          <button class="btn btn-ghost" id="btnCondA" type="button">Condition A</button>
          <button class="btn btn-ghost" id="btnCondB" type="button">Condition B</button>
          <button class="btn btn-ghost" id="btnCondC" type="button">Condition C</button>
        </div>

        <div class="rPresetRow">
          <button class="btn btn-ghost" id="btnClass51" type="button">‡∏õ.5/1</button>
          <button class="btn btn-ghost" id="btnClass52" type="button">‡∏õ.5/2</button>
          <button class="btn btn-ghost" id="btnClass53" type="button">‡∏õ.5/3</button>
        </div>

        <div class="rPresetRow">
          <button class="btn btn-strong" id="btnNextP" type="button">üÜï Next Participant (auto +1)</button>
          <button class="btn btn-ghost" id="btnResetP" type="button">‚Ü∫ Reset Counter</button>
        </div>

        <div class="note" style="margin-top:8px;">
          Next Participant: ‡πÄ‡∏û‡∏¥‡πà‡∏° participantId + ‡∏™‡∏£‡πâ‡∏≤‡∏á sessionId ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </div>
      </div>

      <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:space-between;">
        <button id="btnRTagClose" class="btn btn-ghost" type="button">‚úñ ‡∏õ‡∏¥‡∏î</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnRTagSave" class="btn btn-ghost" type="button">üíæ Save</button>
          <button id="btnRTagApplyUrl" class="btn btn-ghost" type="button">üîó Apply to URL</button>
          <button id="btnNewSession" class="btn btn-ghost" type="button">üÜî New sessionId</button>
        </div>
      </div>

      <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:flex-end;">
        <button id="btnCopyResearchUrl" class="btn btn-strong" type="button">üìã Copy Research URL</button>
        <button id="btnCopyPlayUrl" class="btn btn-ghost" type="button">üìã Copy Play URL</button>
      </div>

      <div class="note" style="margin-top:8px;">
        Copy Research URL ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö run=research ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏° tags ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
      </div>
    </div>
  </div>

  <!-- PACK 13: Calibration overlay (cVR only) -->
  <div id="calOverlay" class="overlay overlay-cal hidden">
    <div class="panel calPanel">
      <div class="title">üß≠ Calibration (Cardboard)</div>
      <div id="calSub" class="sub">
        Step 1/2: ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div class="stat">
          <div class="k">Step</div>
          <div id="calStep" class="v">1/2</div>
        </div>
        <div class="stat">
          <div class="k">Shots</div>
          <div id="calShots" class="v">0/3</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnCalNext" class="btn btn-strong" type="button">‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
        <button id="btnCalSkip" class="btn btn-ghost" type="button">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</button>
      </div>

      <div class="note" style="margin-top:10px;">
        cVR: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡πÉ‡∏ä‡πâ RECENTER ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
      </div>
    </div>
  </div>

  <!-- FINAL-39..41: Research Gate -->
  <div id="gateOverlay" class="overlay overlay-gate hidden">
    <div class="panel gatePanel">
      <div class="title">üßæ Research Check</div>
      <div class="sub" id="gateSub">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>

      <div class="grid2" style="margin-top:10px;">
        <div class="stat"><div class="k">studyId</div><div id="gateStudy" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">participantId</div><div id="gatePid" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">conditionGroup</div><div id="gateCond" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">sessionId</div><div id="gateSid" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">consentParent</div><div id="gateConsent" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">assentChild</div><div id="gateAssent" class="v">‚Äî</div></div>
      </div>

      <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap; justify-content:space-between;">
        <button id="btnGateEdit" class="btn btn-ghost" type="button">‚úèÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á Research</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnGateAuto" class="btn btn-ghost" type="button">‚ö° Auto-fill (P+1)</button>
          <button id="btnGateApplyUrl" class="btn btn-ghost" type="button">üîó Apply to URL</button>
          <button id="btnGateStart" class="btn btn-strong" type="button" disabled>üöÄ Start Research</button>
        </div>
      </div>

      <div class="note" style="margin-top:10px;">
        ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î strict=1 ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Consent/Assent ‡∏î‡πâ‡∏ß‡∏¢
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopy" class="btn" type="button">üìã Copy JSON</button>
        <button id="btnCopyResearchUrlEnd" class="btn btn-ghost" type="button">üîó Copy Research URL</button>
      </div>
      <div class="row row2">
        <button id="btnBackLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
        <button id="btnHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        Cardboard (cVR): ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ENTER VR/RECENTER ‡∏≠‡∏¢‡∏π‡πà UI ‡∏Ç‡∏≠‡∏á vr-ui.js
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const $ = (id)=>DOC.getElementById(id);

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }
  function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }
  function normStr(s){ s = String(s??'').trim(); return s ? s : ''; }

  function setView(view){
    const b = DOC.body;
    b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    b.classList.add('view-'+view);
  }

  function aiEnabled(){
    const run = String(qs('run','play')||'play').toLowerCase();
    const on  = String(qs('ai','0')||'0');
    if (run === 'research') return false;
    return (on === '1' || on === 'true');
  }

  function getPracticeSec(view){
    const p = String(qs('practice','0')||'0');
    let sec = Number(p)||0;
    if (p === '1') sec = 15;
    sec = clamp(sec, 0, 30);
    if (view !== 'cvr') sec = 0;
    return sec;
  }

  function isResearchMode(){
    return String(qs('run','play')||'play').toLowerCase() === 'research';
  }
  function isStrictMode(){
    const s = String(qs('strict','0')||'0').toLowerCase();
    return (s === '1' || s === 'true');
  }

  async function copyText(text){
    try { await navigator.clipboard.writeText(String(text||'')); return true; }
    catch {
      try{
        const ta = DOC.createElement('textarea');
        ta.value = String(text||'');
        DOC.body.appendChild(ta);
        ta.select();
        DOC.execCommand('copy');
        ta.remove();
        return true;
      }catch{ return false; }
    }
  }

  // ---------- Research ctx (self-contained) ----------
  const LS_RCTX = 'HHA_RESEARCH_CTX_V1';
  const LS_PCOUNTER = 'HHA_PARTICIPANT_COUNTER_V1';

  function loadRctx(){
    try{ return JSON.parse(localStorage.getItem(LS_RCTX)||'{}')||{}; }catch(_){ return {}; }
  }
  function saveRctx(o){
    try{ localStorage.setItem(LS_RCTX, JSON.stringify(o||{})); return true; }catch(_){ return false; }
  }
  function getRctxFromUrl(){
    const b = (x)=> (String(x||'').trim()==='1' || String(x||'').trim().toLowerCase()==='true');
    return {
      studyId: normStr(qs('studyId','')),
      participantId: normStr(qs('participantId','')),
      conditionGroup: normStr(qs('conditionGroup','')),
      sessionId: normStr(qs('sessionId','')),
      consentParent: b(qs('consentParent','')),
      assentChild: b(qs('assentChild',''))
    };
  }
  function getRctx(){
    const a = loadRctx();
    const u = getRctxFromUrl();
    return {
      studyId: u.studyId || normStr(a.studyId||''),
      participantId: u.participantId || normStr(a.participantId||''),
      conditionGroup: u.conditionGroup || normStr(a.conditionGroup||''),
      sessionId: u.sessionId || normStr(a.sessionId||''),
      consentParent: (u.consentParent === true) ? true : !!a.consentParent,
      assentChild: (u.assentChild === true) ? true : !!a.assentChild
    };
  }
  function setRctx(patch){
    const cur = getRctx();
    const next = Object.assign({}, cur, patch||{});
    next.studyId = normStr(next.studyId);
    next.participantId = normStr(next.participantId);
    next.conditionGroup = normStr(next.conditionGroup);
    next.sessionId = normStr(next.sessionId);
    next.consentParent = !!next.consentParent;
    next.assentChild = !!next.assentChild;
    saveRctx(next);
    return next;
  }
  function makeSessionId(){
    const t = Date.now();
    const r = Math.floor(Math.random()*1e6).toString(16).padStart(5,'0');
    return `S${t}-${r}`;
  }

  // expose for summary merge
  window.GroupsVR = window.GroupsVR || {};
  window.GroupsVR.getResearchCtx = function(){
    const c = getRctx();
    return {
      studyId: c.studyId,
      participantId: c.participantId,
      conditionGroup: c.conditionGroup,
      sessionId: c.sessionId,
      consentParent: !!c.consentParent,
      assentChild: !!c.assentChild
    };
  };

  function toggleRTagPanel(on){
    const el = $('rTagPanel');
    if (!el) return;
    el.classList.toggle('hidden', !on);
    DOC.body.classList.toggle('rtag-open', !!on);
    if (on) syncRTagUI();
  }

  function syncRTagUI(){
    const c = getRctx();
    $('inStudyId') && ($('inStudyId').value = c.studyId || '');
    $('inParticipantId') && ($('inParticipantId').value = c.participantId || '');
    $('inConditionGroup') && ($('inConditionGroup').value = c.conditionGroup || '');
    $('inSessionId') && ($('inSessionId').value = c.sessionId || '');

    $('ckConsentParent') && ($('ckConsentParent').checked = !!c.consentParent);
    $('ckAssentChild') && ($('ckAssentChild').checked = !!c.assentChild);
    $('ckStrict') && ($('ckStrict').checked = isStrictMode());
  }

  // FAB
  $('btnResearchFab') && $('btnResearchFab').addEventListener('click', ()=> toggleRTagPanel(true));
  $('btnRTagClose') && $('btnRTagClose').addEventListener('click', ()=> toggleRTagPanel(false));

  // Save
  $('btnRTagSave') && $('btnRTagSave').addEventListener('click', ()=>{
    setRctx({
      studyId: $('inStudyId') ? $('inStudyId').value : '',
      participantId: $('inParticipantId') ? $('inParticipantId').value : '',
      conditionGroup: $('inConditionGroup') ? $('inConditionGroup').value : '',
      sessionId: $('inSessionId') ? $('inSessionId').value : '',
      consentParent: !!($('ckConsentParent') && $('ckConsentParent').checked),
      assentChild: !!($('ckAssentChild') && $('ckAssentChild').checked)
    });
    syncRTagUI();
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  });

  // New session
  $('btnNewSession') && $('btnNewSession').addEventListener('click', ()=>{
    setRctx({ sessionId: makeSessionId() });
    syncRTagUI();
    alert('‡∏™‡∏£‡πâ‡∏≤‡∏á sessionId ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  });

  // Apply to URL
  $('btnRTagApplyUrl') && $('btnRTagApplyUrl').addEventListener('click', ()=>{
    const c = getRctx();
    const u = new URL(location.href);

    if (c.studyId) u.searchParams.set('studyId', c.studyId); else u.searchParams.delete('studyId');
    if (c.participantId) u.searchParams.set('participantId', c.participantId); else u.searchParams.delete('participantId');
    if (c.conditionGroup) u.searchParams.set('conditionGroup', c.conditionGroup); else u.searchParams.delete('conditionGroup');
    if (c.sessionId) u.searchParams.set('sessionId', c.sessionId); else u.searchParams.delete('sessionId');

    if (c.consentParent) u.searchParams.set('consentParent','1'); else u.searchParams.delete('consentParent');
    if (c.assentChild)   u.searchParams.set('assentChild','1');   else u.searchParams.delete('assentChild');

    const strictOn = !!($('ckStrict') && $('ckStrict').checked);
    if (strictOn) u.searchParams.set('strict','1'); else u.searchParams.delete('strict');

    history.replaceState(null,'',u.toString());
    syncRTagUI();
    alert('Apply URL ‡πÅ‡∏•‡πâ‡∏ß üîó');
  });

  // FINAL-38: Counter helpers
  function loadPCounter(){ try{ return Number(localStorage.getItem(LS_PCOUNTER)||'0')||0; }catch(_){ return 0; } }
  function savePCounter(n){ try{ localStorage.setItem(LS_PCOUNTER, String(n|0)); return true; }catch(_){ return false; } }
  function formatParticipantId(n){ n = Math.max(1, Number(n)||1); return 'P' + String(n).padStart(3,'0'); }

  function bumpParticipant(){
    let n = loadPCounter();
    n = (n|0) + 1;
    savePCounter(n);
    const pid = formatParticipantId(n);
    setRctx({ participantId: pid, sessionId: makeSessionId() });
    syncRTagUI();
    return pid;
  }
  function resetCounter(){
    if (!confirm('Reset participant counter ‡πÄ‡∏õ‡πá‡∏ô 0?')) return;
    savePCounter(0);
    alert('Reset ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (Next ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô P001)');
  }

  function applyPreset(patch){
    setRctx(patch||{});
    syncRTagUI();
  }

  // Condition
  $('btnCondA') && $('btnCondA').addEventListener('click', ()=> applyPreset({ conditionGroup:'A' }));
  $('btnCondB') && $('btnCondB').addEventListener('click', ()=> applyPreset({ conditionGroup:'B' }));
  $('btnCondC') && $('btnCondC').addEventListener('click', ()=> applyPreset({ conditionGroup:'C' }));

  // Class -> suffix to studyId
  function setClass(cls){
    const cur = getRctx();
    const base = cur.studyId || 'HHA-GROUPS-2026';
    const cleaned = base.replace(/\|G5-\d+$/,'');
    applyPreset({ studyId: `${cleaned}|${cls}` });
  }
  $('btnClass51') && $('btnClass51').addEventListener('click', ()=> setClass('G5-1'));
  $('btnClass52') && $('btnClass52').addEventListener('click', ()=> setClass('G5-2'));
  $('btnClass53') && $('btnClass53').addEventListener('click', ()=> setClass('G5-3'));

  $('btnNextP') && $('btnNextP').addEventListener('click', ()=>{
    const pid = bumpParticipant();
    alert(`‡∏ï‡∏±‡πâ‡∏á participantId = ${pid} ‚úÖ`);
  });
  $('btnResetP') && $('btnResetP').addEventListener('click', resetCounter);

  // Default participant if empty
  (function initParticipantDefault(){
    const c = getRctx();
    if (!c.participantId){
      const n = Math.max(1, loadPCounter() || 1);
      applyPreset({ participantId: formatParticipantId(n) });
    }
    if (!c.sessionId){
      applyPreset({ sessionId: makeSessionId() });
    }
  })();

  // FINAL-42: Link Builder
  function buildUrl(mode /* 'research'|'play' */){
    const u = new URL(location.href);
    const sp = u.searchParams;

    sp.set('run', mode === 'research' ? 'research' : 'play');

    const keep = (k, def='')=>{
      const v = String(qs(k, def) ?? def);
      if (v && v !== 'null' && v !== 'undefined') sp.set(k, v);
      else sp.delete(k);
    };

    keep('diff','normal');
    keep('style','mix');
    keep('time','90');
    keep('seed', String(qs('seed', Date.now()) || Date.now()));
    keep('view', String(qs('view','mobile')||'mobile'));

    const passthru = ['hub','log','practice','ai','strict'];
    passthru.forEach(k=>{
      const v = String(qs(k,'')||'');
      if (v) sp.set(k,v);
      else sp.delete(k);
    });

    if (mode === 'research'){
      const c0 = getRctx();
      if (!c0.sessionId) setRctx({ sessionId: makeSessionId() });
      const c = getRctx();

      if (c.studyId) sp.set('studyId', c.studyId); else sp.delete('studyId');
      if (c.participantId) sp.set('participantId', c.participantId); else sp.delete('participantId');
      if (c.conditionGroup) sp.set('conditionGroup', c.conditionGroup); else sp.delete('conditionGroup');
      if (c.sessionId) sp.set('sessionId', c.sessionId); else sp.delete('sessionId');

      if (c.consentParent) sp.set('consentParent','1'); else sp.delete('consentParent');
      if (c.assentChild)   sp.set('assentChild','1');   else sp.delete('assentChild');

      if ($('ckStrict') && $('ckStrict').checked) sp.set('strict','1');
    } else {
      ['studyId','participantId','conditionGroup','sessionId','consentParent','assentChild'].forEach(k=>sp.delete(k));
    }

    return u.toString();
  }

  async function copyUrl(mode){
    const url = buildUrl(mode);
    const ok = await copyText(url);
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }

  $('btnCopyResearchUrl') && $('btnCopyResearchUrl').addEventListener('click', ()=> copyUrl('research'));
  $('btnCopyPlayUrl') && $('btnCopyPlayUrl').addEventListener('click', ()=> copyUrl('play'));

  // ---------- HUD binds ----------
  window.addEventListener('hha:score', (ev)=>{
    const d = ev.detail||{};
    $('vScore').textContent = String(d.score ?? 0);
    $('vCombo').textContent = String(d.combo ?? 0);
    $('vMiss').textContent  = String(d.misses ?? 0);
  }, {passive:true});

  window.addEventListener('hha:time', (ev)=>{
    const d = ev.detail||{};
    $('vTime').textContent = String(Math.max(0, Math.round(d.left ?? 0)));
  }, {passive:true});

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev.detail||{};
    $('vRank').textContent = String(d.grade ?? 'C');
    $('vAcc').textContent  = String((d.accuracy ?? 0) + '%');
  }, {passive:true});

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev.detail||{};
    $('coachText').textContent = String(d.text||'');
    const mood = String(d.mood||'neutral');
    const img =
      (mood==='happy') ? '../img/coach-happy.png' :
      (mood==='sad')   ? '../img/coach-sad.png' :
      (mood==='fever') ? '../img/coach-fever.png' :
                        '../img/coach-neutral.png';
    $('coachImg').src = img;
  }, {passive:true});

  window.addEventListener('groups:power', (ev)=>{
    const d = ev.detail||{};
    const cur = Number(d.charge||0);
    const thr = Math.max(1, Number(d.threshold||8));
    $('pCur').textContent = String(cur|0);
    $('pThr').textContent = String(thr|0);
    $('pFill').style.width = Math.round((cur/thr)*100) + '%';
  }, {passive:true});

  window.addEventListener('quest:update', (ev)=>{
    const d = ev.detail||{};
    const gTitle = String(d.goalTitle||'‚Äî');
    const gNow   = Number(d.goalNow||0);
    const gTot   = Math.max(1, Number(d.goalTotal||1));
    const gPct   = clamp(d.goalPct ?? (gNow/gTot*100), 0, 100);

    const mTitle = String(d.miniTitle||'‚Äî');
    const mNow   = Number(d.miniNow||0);
    const mTot   = Math.max(1, Number(d.miniTotal||1));
    const mPct   = clamp(d.miniPct ?? (mNow/mTot*100), 0, 100);
    const mLeft  = Number(d.miniTimeLeftSec||0);

    $('goalTitle').textContent = 'üéØ GOAL';
    $('goalCount').textContent = `${gNow}/${gTot}`;
    $('goalFill').style.width = Math.round(gPct) + '%';
    $('goalSub').textContent = gTitle;

    $('miniTitle').textContent = '‚ö° MINI';
    $('miniFill').style.width = Math.round(mPct) + '%';
    $('miniSub').textContent = mTitle;
    $('miniTime').textContent = (mLeft>0) ? `${mLeft}s` : '‚Äî';

    const urgent = (mLeft>0 && mLeft<=3);
    DOC.body.classList.toggle('mini-urgent', urgent);
  }, {passive:true});

  // ---------- Summary / History ----------
  const LS_LAST = 'HHA_LAST_SUMMARY';
  const LS_HIST = 'HHA_SUMMARY_HISTORY';

  let lastSummary = null;
  let startIso = new Date().toISOString();
  let startMarkerIso = null; // FINAL-40

  function saveLast(summary){
    try{ localStorage.setItem(LS_LAST, JSON.stringify(summary)); }catch{}
    try{
      const hist = JSON.parse(localStorage.getItem(LS_HIST)||'[]');
      hist.unshift(summary);
      localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 50)));
    }catch{}
  }

  function buildBaseSummary(d, endIso){
    const ctx = (window.GroupsVR && window.GroupsVR.getResearchCtx) ? window.GroupsVR.getResearchCtx() : {};
    return Object.assign({
      timestampIso: endIso,
      projectTag: 'HeroHealth',
      gameTag: 'GroupsVR',
      runMode: String(qs('run','play')||'play'),
      diff: String(qs('diff','normal')||'normal'),
      style: String(qs('style','mix')||'mix'),
      view: String(qs('view','mobile')||'mobile'),
      durationPlannedSec: Number(qs('time',90)||90),
      startTimeIso: startIso,
      startMarkerIso: startMarkerIso || startIso,
      endTimeIso: endIso,
      seed: String(qs('seed','')||'')
    }, ctx, d||{});
  }

  // flush-hardened hook (optional)
  try{
    const B = window.GroupsVR && window.GroupsVR.bindFlushOnLeave;
    B && B(()=>lastSummary);
  }catch(_){}

  let practiceActive = false;
  let practiceDone = false;

  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail||{};
    const endIso = new Date().toISOString();

    // practice chain ‚Üí auto start real run
    if (practiceActive && !practiceDone){
      practiceDone = true;
      practiceActive = false;
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function'){
        setTimeout(()=> startReal(E), 180);
      }
      return;
    }

    lastSummary = buildBaseSummary(d, endIso);
    saveLast(lastSummary);

    $('endOverlay').classList.remove('hidden');
    $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');
    $('endScore').textContent = String(d.scoreFinal ?? 0);
    $('endRank').textContent  = String(d.grade ?? 'C');
    $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
    $('endMiss').textContent  = String(d.misses ?? 0);

    const hub = String(qs('hub','')||'');
    $('btnHub').style.display = hub ? 'inline-flex' : 'none';
  }, {passive:true});

  $('btnRestart').addEventListener('click', ()=> location.reload());

  $('btnCopy').addEventListener('click', async ()=>{
    if (!lastSummary){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
    const ok = await copyText(JSON.stringify(lastSummary, null, 2));
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  });

  $('btnCopyResearchUrlEnd') && $('btnCopyResearchUrlEnd').addEventListener('click', ()=> copyUrl('research'));

  $('btnBackLauncher').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    const u = new URL('../groups-vr.html', location.href);
    if (hub) u.searchParams.set('hub', hub);

    const sp = new URL(location.href).searchParams;
    sp.forEach((v,k)=>{
      if (k==='hub') return;
      u.searchParams.set(k,v);
    });
    location.href = u.toString();
  });

  $('btnHub').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    if (!hub){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå hub=...'); return; }
    location.href = hub;
  });

  // ---------- Engine helpers ----------
  function waitForEngine(cb){
    const t0 = Date.now();
    const it = setInterval(()=>{
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function' && typeof E.setLayerEl === 'function'){
        clearInterval(it);
        cb(E);
        return;
      }
      if (Date.now() - t0 > 7000){
        clearInterval(it);
        try{
          window.dispatchEvent(new CustomEvent('hha:coach', {
            detail:{ text:'‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô (groups.safe.js). ‡πÄ‡∏ä‡πá‡∏Ñ path/‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', mood:'sad' }
          }));
        }catch(_){}
      }
    }, 60);
  }

  function getLayerEl(){
    return $('playLayer') || DOC.querySelector('.playLayer') || DOC.body;
  }

  function initViewHelper(view){
    try{
      const H = window.GroupsVR && window.GroupsVR.ViewHelper;
      H && H.init && H.init({ view });
    }catch(_){}
  }

  // ---------- PACK 13: Calibration ----------
  const cal = { on:false, step:0, shots:0, done:false };

  function showCal(on){
    const el = $('calOverlay');
    if (!el) return;
    el.classList.toggle('hidden', !on);
    DOC.body.classList.toggle('calibration', !!on);
  }

  function setCalStep(step){
    cal.step = step;
    const stepEl = $('calStep');
    const subEl  = $('calSub');
    const shotsEl= $('calShots');
    const nextBt = $('btnCalNext');

    if (stepEl) stepEl.textContent = `${step}/2`;
    if (shotsEl) shotsEl.textContent = `${cal.shots}/3`;

    if (subEl){
      if (step === 1){
        subEl.innerHTML = `Step 1/2: ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤`;
      }else{
        subEl.innerHTML = `Step 2/2: ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á <b>3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</b> (‡πÅ‡∏ï‡∏∞‡∏à‡∏≠) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö crosshair`;
      }
    }

    if (nextBt){
      if (step === 1){
        nextBt.textContent = '‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ';
        nextBt.disabled = false;
      }else{
        nextBt.textContent = (cal.shots>=3) ? 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢' : '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        nextBt.disabled = (cal.shots < 3);
      }
    }
  }

  function startCalibrationIfNeeded(view){
    if (view !== 'cvr') return false;

    cal.on = true;
    cal.done = false;
    cal.shots = 0;

    showCal(true);
    setCalStep(1);

    try{
      window.dispatchEvent(new CustomEvent('hha:coach', {
        detail:{ text:'Calibration: ‡∏Å‡∏î RECENTER ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ï‡πà‡∏≠‡πÑ‡∏õ‚Äù ‚úÖ', mood:'neutral' }
      }));
    }catch(_){}

    return true;
  }

  function finishCalibration(){
    cal.on = false;
    cal.done = true;
    showCal(false);
  }

  // count shots in calibration step 2
  window.addEventListener('hha:shoot', ()=>{
    if (!cal.on) return;
    if (cal.step !== 2) return;
    cal.shots = Math.min(3, (cal.shots|0) + 1);
    setCalStep(2);
  }, {passive:true});

  // buttons
  $('btnCalNext') && $('btnCalNext').addEventListener('click', ()=>{
    if (!cal.on) return;
    if (cal.step === 1){
      setCalStep(2);
      return;
    }
    if (cal.step === 2 && cal.shots >= 3){
      finishCalibration();
      waitForEngine((E)=> startAfterCalibration(E));
    }
  });

  $('btnCalSkip') && $('btnCalSkip').addEventListener('click', ()=>{
    if (!cal.on) return;
    finishCalibration();
    waitForEngine((E)=> startAfterCalibration(E));
  });

  function startAfterCalibration(E){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const practiceSec = getPracticeSec(view);

    if (view === 'cvr' && practiceSec > 0){
      const diff = String(qs('diff','normal')||'normal').toLowerCase();
      const style= String(qs('style','mix')||'mix').toLowerCase();
      const seed = String(qs('seed', Date.now()) || Date.now());
      startPractice(E, { diff, style, seed, practiceSec });
      return;
    }
    startReal(E);
  }

  // ---------- PACK 14: Practice ----------
  function startPractice(E, cfg){
    practiceActive = true;
    practiceDone = false;
    $('vMode').textContent = 'PRACTICE';

    const seedP = String(cfg.seed) + '-practice';
    startIso = new Date().toISOString();
    startMarkerIso = new Date().toISOString();

    initViewHelper('cvr');
    E.setLayerEl(getLayerEl());
    E.start(cfg.diff, { runMode:'practice', diff:cfg.diff, style:cfg.style, time: cfg.practiceSec, seed: seedP });

    try{
      const H = window.GroupsVR && window.GroupsVR.ViewHelper;
      H && H.tryImmersiveForCVR && H.tryImmersiveForCVR();
    }catch(_){}
  }

  function startReal(E){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
    const diff = String(qs('diff','normal')||'normal').toLowerCase();
    const style= String(qs('style','mix')||'mix').toLowerCase();
    const time = clamp(qs('time',90), 30, 180);
    const seed = String(qs('seed', Date.now()) || Date.now());

    $('vMode').textContent = (run==='research') ? 'RESEARCH' : 'PLAY';
    startIso = new Date().toISOString();
    startMarkerIso = new Date().toISOString(); // FINAL-40 start marker

    initViewHelper(view);
    E.setLayerEl(getLayerEl());
    E.start(diff, { runMode: run, diff, style, time, seed });

    // PACK 15: AI hooks attach (safe)
    try{
      const AI = window.GroupsVR && window.GroupsVR.AIHooks;
      if (AI && AI.attach){
        AI.attach({ runMode: run, seed, enabled: aiEnabled() && run!=='research' });
      }
    }catch(_){}
  }

  // ---------- FINAL-39..41: Research Gate ----------
  function gateValidate(ctx){
    ctx = ctx || getRctx();

    const okStudy = !!normStr(ctx.studyId);
    const okPid   = !!normStr(ctx.participantId);
    const okCond  = !!normStr(ctx.conditionGroup);
    const okSid   = !!normStr(ctx.sessionId);

    const strict = isStrictMode();
    const okConsent = strict ? !!ctx.consentParent : true;
    const okAssent  = strict ? !!ctx.assentChild   : true;

    return { ok: (okStudy && okPid && okCond && okSid && okConsent && okAssent),
      okStudy, okPid, okCond, okSid, okConsent, okAssent, strict };
  }

  function gateSyncUI(){
    const c = getRctx();
    const v = gateValidate(c);

    $('gateStudy') && ($('gateStudy').textContent = c.studyId || '‚Äî');
    $('gatePid')   && ($('gatePid').textContent   = c.participantId || '‚Äî');
    $('gateCond')  && ($('gateCond').textContent  = c.conditionGroup || '‚Äî');
    $('gateSid')   && ($('gateSid').textContent   = c.sessionId || '‚Äî');
    $('gateConsent') && ($('gateConsent').textContent = c.consentParent ? '‚úÖ YES' : '‚ùå NO');
    $('gateAssent')  && ($('gateAssent').textContent  = c.assentChild ? '‚úÖ YES' : '‚ùå NO');

    const missing = [];
    if (!v.okStudy) missing.push('studyId');
    if (!v.okPid)   missing.push('participantId');
    if (!v.okCond)  missing.push('conditionGroup');
    if (!v.okSid)   missing.push('sessionId');

    if (v.strict){
      if (!v.okConsent) missing.push('consentParent');
      if (!v.okAssent)  missing.push('assentChild');
    }

    $('gateSub') && ($('gateSub').textContent =
      v.ok ? (v.strict ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° (STRICT) ‚úÖ' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á ‚úÖ')
           : ('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°: ' + missing.join(', '))
    );

    $('btnGateStart') && ($('btnGateStart').disabled = !v.ok);
  }

  function showGate(on){
    const el = $('gateOverlay');
    if (!el) return;
    el.classList.toggle('hidden', !on);
    if (on) gateSyncUI();
    DOC.body.classList.toggle('gate-open', !!on);
  }

  $('btnGateEdit') && $('btnGateEdit').addEventListener('click', ()=>{
    toggleRTagPanel(true);
    gateSyncUI();
  });

  $('btnGateAuto') && $('btnGateAuto').addEventListener('click', ()=>{
    bumpParticipant();
    const c = getRctx();
    if (!c.conditionGroup) applyPreset({ conditionGroup:'A' });
    if (!c.studyId) applyPreset({ studyId:'HHA-GROUPS-2026' });
    if (!c.sessionId) applyPreset({ sessionId: makeSessionId() });

    if (isStrictMode()){
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å auto tick ‡πÉ‡∏´‡πâ‡∏•‡∏ö 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      setRctx({ consentParent:true, assentChild:true });
      syncRTagUI();
    }

    gateSyncUI();
  });

  $('btnGateApplyUrl') && $('btnGateApplyUrl').addEventListener('click', ()=>{
    const c = getRctx();
    const u = new URL(location.href);

    if (c.studyId) u.searchParams.set('studyId', c.studyId); else u.searchParams.delete('studyId');
    if (c.participantId) u.searchParams.set('participantId', c.participantId); else u.searchParams.delete('participantId');
    if (c.conditionGroup) u.searchParams.set('conditionGroup', c.conditionGroup); else u.searchParams.delete('conditionGroup');
    if (c.sessionId) u.searchParams.set('sessionId', c.sessionId); else u.searchParams.delete('sessionId');

    if (c.consentParent) u.searchParams.set('consentParent','1'); else u.searchParams.delete('consentParent');
    if (c.assentChild)   u.searchParams.set('assentChild','1');   else u.searchParams.delete('assentChild');

    history.replaceState(null,'',u.toString());
    gateSyncUI();
    alert('Apply URL ‡πÅ‡∏•‡πâ‡∏ß üîó');
  });

  $('btnGateStart') && $('btnGateStart').addEventListener('click', ()=>{
    const v = gateValidate(getRctx());
    if (!v.ok){ gateSyncUI(); return; }
    showGate(false);

    // ensure URL has research tags (for traceability)
    try{
      const c = getRctx();
      const u = new URL(location.href);
      u.searchParams.set('run','research');
      u.searchParams.set('studyId', c.studyId);
      u.searchParams.set('participantId', c.participantId);
      u.searchParams.set('conditionGroup', c.conditionGroup);
      u.searchParams.set('sessionId', c.sessionId);
      if (c.consentParent) u.searchParams.set('consentParent','1'); else u.searchParams.delete('consentParent');
      if (c.assentChild)   u.searchParams.set('assentChild','1');   else u.searchParams.delete('assentChild');
      history.replaceState(null,'',u.toString());
    }catch(_){}

    // start
    startFromParams();
  });

  // ---------- Start ----------
  function startFromParams(){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';

    setView(view);
    initViewHelper(view);

    // Gate: research only
    if (run === 'research'){
      const v = gateValidate(getRctx());
      if (!v.ok){
        showGate(true);
        return; // ‚úÖ block start until Start Research
      }
    }

    const gated = startCalibrationIfNeeded(view);
    if (gated) return;

    const practiceSec = getPracticeSec(view);
    waitForEngine((E)=>{
      if (view === 'cvr' && practiceSec > 0){
        const diff = String(qs('diff','normal')||'normal').toLowerCase();
        const style= String(qs('style','mix')||'mix').toLowerCase();
        const seed = String(qs('seed', Date.now()) || Date.now());
        startPractice(E, { diff, style, seed, practiceSec });
        return;
      }
      startReal(E);
    });
  }

  startFromParams();
})();
</script>
</body>
</html>