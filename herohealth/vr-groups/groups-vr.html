<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR ‚Äî RUN PAGE (PC/Mobile/cVR) ‚Äî PRODUCTION (PATCH D7‚ÄìD15 v20260215b)
‚úÖ D7: Warmup/Cooldown Buff intake (query wType,wPct,rank,wCrit,wDmg,wHeal,calm) + HUD pill (no-effect in research)
‚úÖ D8: End Summary + Save last summary/history + Back HUB button + store schema
‚úÖ D9: Flush-hardened (pagehide/visibility/beforeunload/back) -> Telemetry.flush + engine bindFlushOnLeave
‚úÖ D13: Calibration/Recenter helper for Cardboard (cVR) + Fullscreen/Landscape helper
‚úÖ D14: Practice mode 15s before real run (disable with ?practice=0) ‚Äî auto flow (no end overlay for practice)
‚úÖ D15: AI hooks module include (./ai-hooks.js) ‚Äî enable only with ?ai=1 in play (research stays OFF)
Requires:
- /herohealth/vr/vr-ui.js
- /herohealth/vr-groups/groups.safe.js
- /herohealth/vr-groups/ai-hooks.js   (NEW)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî GroupsVR</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="../favicon.ico"/>
  <style>
    :root{
      --bg:#040610;
      --panel: rgba(4,6,16,.78);
      --panel2: rgba(10,16,36,.55);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --cyan:#22d3ee; --violet:#a78bfa; --amber:#f59e0b; --red:#ef4444; --pink:#ff4fd8;
      --radius:22px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --hw-top-safe: calc(70px + var(--sat));
      --hw-bottom-safe: calc(96px + var(--sab));
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; overflow:hidden; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(34,211,238,.14) 0%, transparent 55%),
        radial-gradient(1100px 700px at 80% 30%, rgba(167,139,250,.16) 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,79,216,.08) 0%, transparent 60%),
        linear-gradient(180deg, #0b1026, var(--bg));
    }
    #app{
      position:relative;
      width:100%; height:100%;
      padding: calc(10px + var(--sat)) 10px calc(10px + var(--sab));
      display:flex; flex-direction:column; gap:10px;
    }
    .topbar{
      position:relative;
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.78), rgba(2,6,23,.55));
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
      padding: 10px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      z-index: 50;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title b{ font-weight:1000; letter-spacing:.2px; }
    .title span{ color:var(--muted); font-size:12.5px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.55);
      font-size:12px;
      color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .pill b{ color:var(--text); font-weight:1000; }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--cyan); box-shadow:0 0 14px rgba(34,211,238,.55); }
    .dot.good{ background: var(--good); box-shadow:0 0 14px rgba(34,197,94,.55); }
    .dot.amber{ background: var(--amber); box-shadow:0 0 14px rgba(245,158,11,.55); }
    .dot.pink{ background: var(--pink); box-shadow:0 0 14px rgba(255,79,216,.55); }

    button{
      cursor:pointer;
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color:var(--text);
      padding: 9px 10px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      font-weight:900;
    }
    button:hover{ transform: translateY(-1px); background: rgba(2,6,23,.72); border-color: rgba(148,163,184,.32); }
    button:active{ transform: translateY(0px) scale(.99); }
    button.ghost{ background: rgba(148,163,184,.08); }
    button.primary{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.32); }

    .stage{
      position:relative;
      flex: 1 1 auto;
      border-radius: var(--radius);
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.26);
      overflow:hidden;
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
    }
    #playLayer{ position:absolute; inset:0; overflow:hidden; pointer-events:auto; }

    .hud{
      position:absolute; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      pointer-events:none;
      z-index: 30;
    }
    .hudTop{ top: calc(10px + var(--sat)); }
    .hudBottom{ bottom: calc(10px + var(--sab)); }

    .hudBox{
      pointer-events:none;
      display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 8px 10px;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.62);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 46px rgba(0,0,0,.25);
    }
    .hudBox .k{ color:var(--muted); font-size:12px; font-weight:900; }
    .hudBox .v{ font-weight:1000; letter-spacing:.2px; }

    .questTop{
      margin-top:6px;
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      padding: 8px 10px;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.50);
      backdrop-filter: blur(10px);
      max-width: min(560px, 100%);
    }
    .questTop b{ font-weight:1000; }

    .bar{
      height:12px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(167,139,250,.92), rgba(255,79,216,.86));
      transition: width .10s linear;
    }

    .powerWrap{
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      padding: 8px 10px;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.50);
      backdrop-filter: blur(10px);
      max-width: 320px;
    }

    .coachWrap{
      pointer-events:none;
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.50);
      backdrop-filter: blur(10px);
      max-width: min(560px, 100%);
    }
    .coachWrap .face{
      width:36px; height:36px; border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.14);
      font-size:18px;
    }
    .coachWrap .txt{ font-weight:1000; letter-spacing:.2px; }
    .coachWrap .sub{ color:var(--muted); font-size:12px; font-weight:900; }

    /* D8 End screen */
    #endOverlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 9999;
    }
    #endCard{
      width: min(860px, 100%);
      border-radius: var(--radius);
      border:1px solid rgba(148,163,184,.18);
      background: linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.64));
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    #endCard header{
      padding: 12px 12px;
      border-bottom:1px solid rgba(148,163,184,.14);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    #endCard header b{ font-weight:1000; }
    #endCard main{ padding: 12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 860px){ #endCard main{ grid-template-columns: 1fr; } }
    .panel{
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.50);
      padding: 10px 10px;
    }
    pre{
      margin:0;
      white-space: pre-wrap;
      font-size:12px;
      color: rgba(229,231,235,.92);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .endBtns{ padding: 12px; border-top:1px solid rgba(148,163,184,.14); display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

    /* leave space for vr-ui buttons in cVR */
    body[data-view="cvr"] .hudBottom{
      bottom: calc(64px + var(--sab));
    }

    /* cVR strict: disable direct tap on targets => only crosshair shoot */
    body[data-view="cvr"][data-cvr-strict="1"] .tgt{
      pointer-events:none !important;
    }

    .tgt{
      width: 78px; height: 78px;
      border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      font-size: 36px;
      font-weight: 1000;
      background: rgba(15,23,42,.72);
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      pointer-events:auto;
    }

    /* D13 overlays: practice + calibration */
    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      z-index: 9000;
      padding: 14px;
    }
    .overlayCard{
      width: min(860px, 100%);
      border-radius: var(--radius);
      border:1px solid rgba(148,163,184,.18);
      background: linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.64));
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .overlayCard header{
      padding: 12px 12px;
      border-bottom:1px solid rgba(148,163,184,.14);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .overlayCard header b{ font-weight:1000; }
    .overlayCard main{ padding: 12px; display:flex; flex-direction:column; gap:10px; }
    .overlayBtns{
      padding: 12px;
      border-top:1px solid rgba(148,163,184,.14);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    .bigLine{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-weight:1000;
    }
    .bigDot{
      width:12px; height:12px; border-radius:99px;
      background: var(--cyan);
      box-shadow: 0 0 16px rgba(34,211,238,.55);
    }
    .hint{
      color: var(--muted);
      font-weight: 900;
      line-height: 1.35;
      font-size: 12.5px;
    }
    .crossBox{
      border-radius: 18px;
      border:1px dashed rgba(148,163,184,.22);
      background: rgba(2,6,23,.40);
      padding: 14px;
      display:flex; flex-direction:column; gap:8px;
      align-items:center; justify-content:center;
      min-height: 160px;
    }
    .cross{
      font-size: 34px;
      font-weight: 1000;
      letter-spacing: .4px;
      opacity: .92;
    }
  </style>
</head>

<body>
<div id="app">
  <div class="topbar">
    <div class="title">
      <b>ü•ó GroupsVR</b>
      <span id="subline">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà!</span>
    </div>

    <div class="row">
      <div class="pill"><span class="dot"></span> <span>MODE:</span> <b id="modePill">PLAY</b></div>
      <div class="pill"><span class="dot amber"></span> <span>DIFF:</span> <b id="diffPill">normal</b></div>

      <!-- D7 buff pill -->
      <div class="pill" id="buffPill" style="display:none;">
        <span class="dot pink"></span> <span>BUFF:</span> <b id="buffText">‚Äî</b>
      </div>

      <!-- director pill -->
      <div class="pill" id="dirPill" style="display:none;">
        <span class="dot"></span> <span>DIR:</span> <b id="dirText">PLAY</b>
      </div>

      <button class="ghost" id="btnRestart">‚ü≤ Restart</button>
      <button class="ghost" id="btnBack">üè† HUB</button>
    </div>
  </div>

  <div class="stage" id="stage">
    <div id="playLayer"></div>

    <!-- HUD TOP -->
    <div class="hud hudTop">
      <div style="display:flex; flex-direction:column; gap:6px;">
        <div class="hudBox">
          <span class="k">TIME</span> <span class="v" id="hudTime">‚Äî</span>
          <span class="k">SCORE</span> <span class="v" id="hudScore">0</span>
          <span class="k">COMBO</span> <span class="v" id="hudCombo">x0</span>
          <span class="k">MISS</span> <span class="v" id="hudMiss">0</span>
          <span class="k">RANK</span> <span class="v" id="hudRank">‚Äî</span>
        </div>

        <div class="questTop">
          <div><b id="qTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</b> <span style="color:var(--muted); font-weight:900;" id="qSub"></span></div>
          <div class="bar"><i id="qBar"></i></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; font-weight:900;">
            <span id="qMini">MINI: ‚Äî</span>
            <span id="qMiniTime"></span>
          </div>
        </div>
      </div>

      <div class="powerWrap">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <b id="groupName">‡∏´‡∏°‡∏π‡πà 1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</b>
          <span style="color:var(--muted); font-weight:1000;">POWER</span>
        </div>
        <div class="bar"><i id="pBar"></i></div>
        <div style="color:var(--muted); font-size:12px; font-weight:900;">
          <span id="pText">0 / 8</span>
        </div>
      </div>
    </div>

    <!-- HUD BOTTOM -->
    <div class="hud hudBottom">
      <div class="coachWrap">
        <div class="face" id="coachFace">üôÇ</div>
        <div>
          <div class="txt" id="coachTxt">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</div>
          <div class="sub" id="coachSub">‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà</div>
        </div>
      </div>
      <div class="hudBox">
        <span class="k">VIEW</span> <span class="v" id="hudView">‚Äî</span>
        <span class="k">SEED</span> <span class="v" id="hudSeed">‚Äî</span>
      </div>
    </div>

    <!-- D14 Practice overlay -->
    <div class="overlay" id="practiceOverlay">
      <div class="overlayCard">
        <header>
          <div><b>üß™ PRACTICE 15s</b> <span style="color:var(--muted); font-weight:900;" id="practiceSub">‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</span></div>
          <div class="pill"><span class="dot"></span> <span>Auto:</span> <b id="practiceTag">ON</b></div>
        </header>
        <main>
          <div class="bigLine"><span class="bigDot"></span> <span>‡∏ã‡πâ‡∏≠‡∏° 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏∑‡∏≠ ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‚Äù</span></div>
          <div class="crossBox">
            <div class="cross">üéØ ‡πÄ‡∏•‡πá‡∏á + ‡∏¢‡∏¥‡∏á</div>
            <div class="hint" id="practiceHint">‡πÅ‡∏ï‡∏∞‡∏à‡∏≠/‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
          </div>
          <div class="hint">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ <b>?practice=0</b>)</div>
        </main>
        <div class="overlayBtns">
          <button class="ghost" id="btnSkipPractice">‡∏Ç‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≠‡∏°</button>
          <button class="primary" id="btnStartPractice">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≠‡∏°</button>
        </div>
      </div>
    </div>

    <!-- D13 Calibration overlay (cVR) -->
    <div class="overlay" id="calibOverlay">
      <div class="overlayCard">
        <header>
          <div><b>ü•Ω cVR CALIBRATION</b> <span style="color:var(--muted); font-weight:900;">‡∏ï‡∏±‡πâ‡∏á‡∏ó‡πà‡∏≤‡∏°‡∏≠‡∏á + Recenter</span></div>
          <div class="pill"><span class="dot pink"></span> <span>Strict:</span> <b id="strictTag">ON</b></div>
        </header>
        <main>
          <div class="bigLine"><span class="bigDot"></span> <span>‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Cardboard ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≠‡∏á ‚Äú‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‚Äù</span></div>
          <div class="crossBox">
            <div class="cross">Ôºã</div>
            <div class="hint">‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ + ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏û‡∏≠‡∏î‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</div>
          </div>
          <div class="hint">
            ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Å‡∏î Fullscreen + ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏î‡πâ‡∏á/‡∏´‡∏°‡∏∏‡∏ô
          </div>
        </main>
        <div class="overlayBtns">
          <button class="ghost" id="btnFS">Fullscreen</button>
          <button class="ghost" id="btnLand">Lock Landscape</button>
          <button class="ghost" id="btnRecenter">Recenter</button>
          <button class="primary" id="btnCloseCalib">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
      </div>
    </div>

    <!-- D8 End overlay -->
    <div id="endOverlay">
      <div id="endCard">
        <header>
          <div><b id="endTitle">END</b> <span style="color:var(--muted); font-weight:900;" id="endSub"></span></div>
          <div class="pill"><span class="dot good"></span> <span>Saved:</span> <b id="savedTag">yes</b></div>
        </header>
        <main>
          <div class="panel">
            <b>Summary</b>
            <pre id="endSummary"></pre>
          </div>
          <div class="panel">
            <b>Buff (if any)</b>
            <pre id="endBuff"></pre>
          </div>
        </main>
        <div class="endBtns">
          <button id="btnEndAgain">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button class="primary" id="btnEndGoHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="ghost" id="btnEndClose">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Universal VR UI -->
<script src="../vr/vr-ui.js"></script>

<!-- D15 AI hooks (NEW) -->
<script src="./ai-hooks.js"></script>

<!-- Groups engine -->
<script src="./groups.safe.js"></script>

<script>
(() => {
  'use strict';

  function getQS(){
    try{ return new URL(location.href).searchParams; }
    catch{ return new URLSearchParams(); }
  }
  const QS = getQS();
  const q = (k, def='') => (QS.get(k) ?? def);

  const HUB = q('hub','') || '../hub.html';

  const RUN  = String(q('run','play')).toLowerCase();
  const DIFF = String(q('diff','normal')).toLowerCase();
  const VIEW = String(q('view','mobile')).toLowerCase();
  const TIME = Number(q('time','90')||90);
  const SEED = String(q('seed','') || Date.now());

  // D14: practice gate (default ON, except research)
  const PRACTICE_ON = (String(q('practice','1')||'1') !== '0') && (RUN !== 'research');

  // D13: cVR strict
  const CVR_STRICT = (VIEW === 'cvr') && (String(q('cvrStrict','1')||'1') !== '0');

  // D7 buff keys
  const BUFF_QS = {
    wType: q('wType',''),
    wPct:  q('wPct',''),
    rank:  q('rank',''),
    wCrit: q('wCrit',''),
    wDmg:  q('wDmg',''),
    wHeal: q('wHeal',''),
    calm:  q('calm','')
  };

  const $ = (s)=>document.querySelector(s);

  const modePill = $('#modePill');
  const diffPill = $('#diffPill');
  const hudView  = $('#hudView');
  const hudSeed  = $('#hudSeed');

  const hudTime  = $('#hudTime');
  const hudScore = $('#hudScore');
  const hudCombo = $('#hudCombo');
  const hudMiss  = $('#hudMiss');
  const hudRank  = $('#hudRank');

  const groupName = $('#groupName');
  const pBar = $('#pBar');
  const pText = $('#pText');

  const qTitle = $('#qTitle');
  const qSub   = $('#qSub');
  const qBar   = $('#qBar');
  const qMini  = $('#qMini');
  const qMiniTime = $('#qMiniTime');

  const coachFace = $('#coachFace');
  const coachTxt  = $('#coachTxt');
  const coachSub  = $('#coachSub');

  const buffPill = $('#buffPill');
  const buffText = $('#buffText');

  const dirPill = $('#dirPill');
  const dirText = $('#dirText');

  const endOverlay = $('#endOverlay');
  const endTitle = $('#endTitle');
  const endSub = $('#endSub');
  const savedTag = $('#savedTag');
  const endSummary = $('#endSummary');
  const endBuff = $('#endBuff');

  // D14 practice overlay
  const practiceOverlay = $('#practiceOverlay');
  const practiceTag = $('#practiceTag');
  const practiceHint = $('#practiceHint');
  const btnSkipPractice = $('#btnSkipPractice');
  const btnStartPractice = $('#btnStartPractice');

  // D13 calib overlay
  const calibOverlay = $('#calibOverlay');
  const strictTag = $('#strictTag');
  const btnFS = $('#btnFS');
  const btnLand = $('#btnLand');
  const btnRecenter = $('#btnRecenter');
  const btnCloseCalib = $('#btnCloseCalib');

  $('#btnBack').addEventListener('click', ()=>goHub(true));
  $('#btnRestart').addEventListener('click', ()=>restart());

  $('#btnEndAgain').addEventListener('click', ()=>{ hideEnd(); restart(); });
  $('#btnEndGoHub').addEventListener('click', ()=>goHub(true));
  $('#btnEndClose').addEventListener('click', ()=>hideEnd());

  document.body.setAttribute('data-view', VIEW);
  document.body.setAttribute('data-cvr-strict', CVR_STRICT ? '1' : '0');

  // ---- D7 parse buff ----
  const BUFF = parseBuffFromQS(BUFF_QS);

  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function calcRankFromPct(pct){
    pct = Number(pct)||0;
    if(pct >= 92) return 'S';
    if(pct >= 78) return 'A';
    if(pct >= 62) return 'B';
    if(pct >= 45) return 'C';
    return 'D';
  }
  function parseBuffFromQS(o){
    const hasAny = Object.keys(o).some(k => String(o[k]||'').trim() !== '');
    if(!hasAny) return null;

    const b = {
      wType: String(o.wType||'').toLowerCase(),
      wPct:  num(o.wPct),
      rank:  String(o.rank||'').toUpperCase(),
      wCrit: num(o.wCrit),
      wDmg:  num(o.wDmg),
      wHeal: num(o.wHeal),
      calm:  num(o.calm),
      raw: {...o}
    };
    if(!b.rank && b.wPct != null) b.rank = calcRankFromPct(b.wPct);
    return b;
  }

  function renderBuffPill(){
    if(!BUFF){ buffPill.style.display = 'none'; return; }
    const isResearch = (RUN === 'research');
    const label = isResearch
      ? `LOCKED (research) ¬∑ ${BUFF.wType||'buff'} ${BUFF.rank||''}`.trim()
      : `${BUFF.wType||'buff'} ¬∑ Rank ${BUFF.rank||'-'} ¬∑ ${BUFF.wPct!=null ? Math.round(BUFF.wPct)+'%' : ''}`.trim();

    buffText.textContent = label;
    buffPill.style.display = '';
  }
  renderBuffPill();

  // ---- HUD init ----
  modePill.textContent = (RUN||'play').toUpperCase();
  diffPill.textContent = DIFF;
  hudView.textContent = VIEW + (CVR_STRICT ? ' (strict)' : '');
  hudSeed.textContent = String(SEED).slice(0,16);
  hudTime.textContent = TIME + 's';

  function lockPxForView(){
    if(VIEW === 'pc') return 10;
    if(VIEW === 'cvr') return 22;
    return 16;
  }

  let lastSummary = null;

  function setCoach(text, mood){
    coachTxt.textContent = text || '';
    coachSub.textContent = mood ? String(mood) : 'coach';
    const face =
      mood === 'happy' ? 'üòÑ' :
      mood === 'fever' ? 'üî•' :
      mood === 'sad'   ? 'üòµ' :
      mood === 'neutral' ? 'üôÇ' : 'üôÇ';
    coachFace.textContent = face;
  }

  window.addEventListener('hha:time', (ev)=>{
    const left = ev?.detail?.left;
    if(typeof left === 'number') hudTime.textContent = left + 's';
  });

  window.addEventListener('hha:score', (ev)=>{
    const d = ev?.detail || {};
    if(d.score != null) hudScore.textContent = String(d.score|0);
    if(d.combo != null) hudCombo.textContent = 'x' + String(d.combo|0);
    const m = (d.misses != null) ? d.misses : d.miss;
    if(m != null) hudMiss.textContent = String(m|0);
  });

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev?.detail || {};
    if(d.grade) hudRank.textContent = String(d.grade);
  });

  window.addEventListener('quest:update', (ev)=>{
    const d = ev?.detail || {};
    if(d.goalTitle) qTitle.textContent = d.goalTitle;
    const gNow = (d.goalNow!=null) ? d.goalNow : 0;
    const gTot = (d.goalTotal!=null) ? d.goalTotal : 1;
    qSub.textContent = `${gNow}/${gTot}`;
    const pct = Math.round((gNow/Math.max(1,gTot))*100);
    qBar.style.width = pct + '%';

    if(d.miniTitle){
      qMini.textContent = `${d.miniTitle} ¬∑ ${d.miniNow||0}/${d.miniTotal||0}`;
    }
    if(d.miniTimeLeftSec != null && d.miniTimeLeftSec > 0){
      qMiniTime.textContent = `‚è≥ ${d.miniTimeLeftSec}s`;
    }else{
      qMiniTime.textContent = '';
    }
    if(d.groupName) groupName.textContent = d.groupName;
  });

  window.addEventListener('groups:power', (ev)=>{
    const d = ev?.detail || {};
    const c = (d.charge!=null) ? d.charge : 0;
    const t = (d.threshold!=null) ? d.threshold : 1;
    const pct = Math.round((c/Math.max(1,t))*100);
    pBar.style.width = pct + '%';
    pText.textContent = `${c}/${t}`;
  });

  window.addEventListener('groups:group', (ev)=>{
    const d = ev?.detail || {};
    if(d.name) groupName.textContent = d.name;
  });

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev?.detail || {};
    if(d.text) setCoach(d.text, d.mood || 'neutral');
  });

  window.addEventListener('groups:director', (ev)=>{
    const d = ev?.detail || {};
    if(!d.text){ dirPill.style.display='none'; return; }
    dirText.textContent = String(d.text);
    dirPill.style.display = '';
  });

  // ---- D8 Save summary ----
  const LS_LAST = 'HHA_LAST_SUMMARY';
  const LS_HIST = 'HHA_SUMMARY_HISTORY';

  function readJSON(key, fallback){
    try{
      const s = localStorage.getItem(key);
      return s ? JSON.parse(s) : fallback;
    }catch(_){ return fallback; }
  }
  function writeJSON(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); return true; }
    catch(_){ return false; }
  }
  function saveLastSummary(summary, buff, meta){
    try{
      const payload = {
        atISO: new Date().toISOString(),
        game: 'groups',
        meta: meta || {},
        buff: buff || null,
        summary: summary || null
      };
      const ok1 = writeJSON(LS_LAST, payload);
      const hist = readJSON(LS_HIST, []);
      hist.unshift(payload);
      const ok2 = writeJSON(LS_HIST, hist.slice(0, 40));
      return !!(ok1 && ok2);
    }catch(_){
      return false;
    }
  }

  function showEnd(summary, buff, saved){
    endTitle.textContent = 'RESULT';
    endSub.textContent = `grade=${summary?.grade || '-'} ¬∑ acc=${summary?.accuracyPct ?? '-'}% ¬∑ miss=${summary?.miss ?? '-'}`;
    endSummary.textContent = JSON.stringify(summary || {}, null, 2);

    const showBuff = buff ? {
      ...buff,
      note: (RUN === 'research') ? 'LOCKED (research ‚Äî no effect)' : 'ACTIVE (play/practice)'
    } : { note: 'no buff' };

    endBuff.textContent = JSON.stringify(showBuff, null, 2);
    savedTag.textContent = saved ? 'yes' : 'no';
    endOverlay.style.display = 'flex';
  }
  function hideEnd(){ endOverlay.style.display = 'none'; }

  // Practice end: do NOT show end overlay, auto continue
  let inPractice = false;

  window.addEventListener('hha:end', (ev)=>{
    const s = ev?.detail || {};
    lastSummary = s;

    if (inPractice){
      inPractice = false;
      setCoach('‡∏ã‡πâ‡∏≠‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á üî•', 'happy');
      setTimeout(()=>startRealRun(), 350);
      return;
    }

    const saved = saveLastSummary(s, BUFF, {
      view: VIEW, run: RUN, diff: DIFF, time: TIME, seed: SEED,
      cvrStrict: CVR_STRICT ? 1 : 0
    });
    showEnd(s, BUFF, saved);
  });

  // ---- D9 Flush hardened ----
  function flushAll(summary){
    try{
      const T = window.GroupsVR && window.GroupsVR.Telemetry;
      if(T && typeof T.flush === 'function'){
        T.flush(summary || lastSummary || null);
      }
    }catch(_){}
  }
  function bindFlush(){
    try{
      if(window.GroupsVR && typeof window.GroupsVR.bindFlushOnLeave === 'function'){
        window.GroupsVR.bindFlushOnLeave(()=>lastSummary || null);
      }
    }catch(_){}
    window.addEventListener('pagehide', ()=>flushAll(), { passive:true });
    window.addEventListener('beforeunload', ()=>flushAll(), { passive:true });
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'hidden') flushAll();
    });
  }

  // ---- D13 Fullscreen / Orientation helpers ----
  async function requestFullscreen(){
    const el = document.documentElement;
    try{
      if(el.requestFullscreen) await el.requestFullscreen();
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }catch(_){}
  }
  async function lockLandscape(){
    try{
      if(screen.orientation && screen.orientation.lock){
        await screen.orientation.lock('landscape');
      }
    }catch(_){}
  }

  function showCalib(){
    strictTag.textContent = CVR_STRICT ? 'ON' : 'OFF';
    calibOverlay.style.display = 'flex';
  }
  function hideCalib(){ calibOverlay.style.display = 'none'; }

  btnFS.addEventListener('click', ()=>requestFullscreen());
  btnLand.addEventListener('click', ()=>lockLandscape());
  btnRecenter.addEventListener('click', ()=>{
    // fallback recenter event hook (if vr-ui listens, great; if not, harmless)
    try{ window.dispatchEvent(new CustomEvent('hha:recenter', { detail:{ source:'calib' } })); }catch(_){}
    setCoach('Recenter ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ', 'neutral');
  });
  btnCloseCalib.addEventListener('click', ()=>hideCalib());

  // ---- D14 practice overlay ----
  function showPractice(){
    practiceTag.textContent = PRACTICE_ON ? 'ON' : 'OFF';
    practiceHint.textContent = (VIEW==='cvr')
      ? '‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏±‡∏ß) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö'
      : '‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö';
    practiceOverlay.style.display = 'flex';
  }
  function hidePractice(){ practiceOverlay.style.display = 'none'; }

  btnSkipPractice.addEventListener('click', ()=>{
    hidePractice();
    startRealRun();
  });
  btnStartPractice.addEventListener('click', ()=>{
    hidePractice();
    startPracticeRun();
  });

  // ---- ctx for engine ----
  function buildCtx(runMode, timeSec, seedStr){
    const ctx = { runMode: runMode, time: timeSec, seed: seedStr };
    if(BUFF){
      ctx.buff = { ...BUFF };
      ctx.buffLocked = (RUN === 'research');
      if(RUN !== 'research') ctx.buffActive = true;
    }
    return ctx;
  }

  function stop(){
    try{ window.GroupsVR.GameEngine.stop(); }catch(_){}
    flushAll(lastSummary || null);
  }

  function restart(){
    hideEnd();
    stop();
    setTimeout(()=>bootFlow(), 40);
  }

  function goHub(flushFirst){
    if(flushFirst) flushAll(lastSummary || null);
    stop();
    try{ location.href = HUB; }
    catch(_){ location.href = '../hub.html'; }
  }

  // ---- lockPx shim ----
  function installLockPxShim(){
    window.addEventListener('hha:shoot', (ev)=>{
      try{
        if(!ev || !ev.detail) return;
        if(ev.detail.lockPx != null) return;
        const d = ev.detail;
        ev.stopImmediatePropagation();
        window.dispatchEvent(new CustomEvent('hha:shoot', {
          detail: { ...d, lockPx: lockPxForView(), source: d.source || 'shim' }
        }));
      }catch(_){}
    }, true);
  }

  // ---- start engine ----
  function startEngine(runMode, timeSec, seedStr){
    try{ window.GroupsVR.GameEngine.setLayerEl(document.getElementById('playLayer')); }catch(_){}

    try{
      const ctx = buildCtx(runMode, timeSec, seedStr);
      window.GroupsVR.GameEngine.start(DIFF, ctx);
      bindFlush();
    }catch(e){
      console.error(e);
      setCoach('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î console ‡∏î‡∏π error', 'sad');
    }
  }

  function startPracticeRun(){
    inPractice = true;
    setCoach('PRACTICE 15s ‚Äî ‡∏ã‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á üß™', 'neutral');
    const pSeed = String(SEED) + '-p15';
    startEngine('practice', 15, pSeed);
  }

  function startRealRun(){
    inPractice = false;

    renderBuffPill();
    if(BUFF && RUN !== 'research'){
      setCoach(`BUFF ACTIVE: ${BUFF.wType||'warmup'} ¬∑ Rank ${BUFF.rank||'-'}`, 'happy');
    } else if(BUFF && RUN === 'research'){
      setCoach(`BUFF LOCKED (research) ¬∑ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`, 'neutral');
    } else {
      setCoach('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö üî•', 'neutral');
    }

    startEngine(RUN, TIME, SEED);
  }

  function bootFlow(){
    installLockPxShim();

    // cVR: show calibration helper first
    if(VIEW === 'cvr'){
      setCoach('‡πÇ‡∏´‡∏°‡∏î Cardboard (cVR) ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair üéØ', 'neutral');
      coachSub.textContent = CVR_STRICT ? 'STRICT: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' : '‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á crosshair ‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤';
      showCalib();
    }

    // practice gate (default on except research)
    if(PRACTICE_ON){
      showPractice();
      return;
    }

    startRealRun();
  }

  // ---- init ----
  bootFlow();

})();
</script>
</body>
</html>