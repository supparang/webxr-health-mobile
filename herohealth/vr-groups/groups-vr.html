<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }
    html,body{ margin:0; height:100%; overflow:hidden; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,sans-serif; }

    /* spawn layer */
    #fg-layer{
      position:fixed; inset:0;
      transform: translate(var(--vx,0px), var(--vy,0px));
      touch-action:none;
      user-select:none;
      pointer-events:auto;
      z-index:10;
    }

    /* HUD */
    .hud{
      position:fixed; left:0; right:0; top:0;
      padding: calc(12px + var(--sat)) 12px 10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none; z-index:50;
    }
    .hud .box{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      min-width:120px;
    }
    .hud .big{ font-weight:800; font-size:16px; }
    .hud .small{ font-size:12px; color:var(--muted); margin-top:2px; }

    .centerTop{
      position:fixed; left:50%; transform:translateX(-50%);
      top: calc(10px + var(--sat));
      z-index:55; pointer-events:none;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    .pill{
      background:rgba(15,23,42,.72);
      border:1px solid rgba(148,163,184,.16);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color:var(--text);
      box-shadow:0 16px 40px rgba(0,0,0,.35);
    }

    /* Power bar */
    .powerWrap{
      position:fixed; left:12px; right:12px;
      bottom: calc(14px + var(--sab));
      z-index:60; pointer-events:none;
    }
    .power{
      height:14px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.65);
      overflow:hidden;
    }
    .power > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
    }
    .powerLabel{
      margin-top:8px; font-size:12px; color:var(--muted);
      display:flex; justify-content:space-between;
    }

    /* overlays */
    .overlay{
      position:fixed; inset:0;
      background:radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 60%),
                 radial-gradient(circle at bottom right, rgba(34,197,94,.18), transparent 60%),
                 rgba(2,6,23,.82);
      display:grid; place-items:center;
      z-index:200;
    }
    .panel{
      width:min(760px, 92vw);
      border:1px solid rgba(148,163,184,.20);
      border-radius:22px;
      background:rgba(2,6,23,.72);
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      padding:18px 18px 14px;
    }
    .panel h2{ margin:0 0 8px; font-size:20px; }
    .panel p{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.55; }
    .panel .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .panel button{
      border:0; border-radius:999px; padding:12px 14px;
      font-weight:900; cursor:pointer;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
      color:#061018;
    }
    .panel button.secondary{
      background:rgba(15,23,42,.78);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
    }
    .dbg{ font-size:12px; color:var(--muted); opacity:.92; margin-top:6px; }
    .dbg b{ color:var(--text); }

    /* End overlay */
    #endOverlay{ display:none; }
    #endOverlay.show{ display:grid; }
    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 12px; }
    .kv .k{
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.55);
      border-radius:16px;
      padding:10px 12px;
      font-size:13px;
    }
    .kv .k b{ display:block; font-size:16px; margin-top:2px; }

    /* fallback target */
    .fg-target{
      position:absolute;
      left: var(--x, 50%);
      top:  var(--y, 50%);
      transform: translate(-50%,-50%) scale(var(--s,1));
      width:70px; height:70px;
      border-radius:999px;
      display:grid; place-items:center;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      box-shadow:0 16px 40px rgba(0,0,0,.40);
      font-size:34px;
      cursor:pointer;
      pointer-events:auto;
    }
    .fg-target::before{ content: attr(data-emoji); }
    .fg-target.hit{ opacity:0; transform:translate(-50%,-50%) scale(calc(var(--s,1) * 1.3)); transition:.18s ease; }
    .fg-target.out{ opacity:0; transition:.18s ease; }
  </style>
</head>

<body>
  <!-- HUD -->
  <div class="hud">
    <div class="box">
      <div class="big" id="uiScore">0</div>
      <div class="small">SCORE</div>
    </div>
    <div class="box" style="text-align:right;">
      <div class="big"><span id="uiTime">90</span>s</div>
      <div class="small">TIME</div>
    </div>
  </div>

  <div class="centerTop">
    <div class="pill">COMBO: <b id="uiCombo">0</b> (MAX <b id="uiComboMax">0</b>)</div>
    <div class="pill">MISS: <b id="uiMiss">0</b></div>
    <div class="pill">GRADE: <b id="uiGrade">C</b></div>
  </div>

  <!-- Spawn layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="power"><i id="uiPowerBar"></i></div>
    <div class="powerLabel">
      <span>POWER</span>
      <span><b id="uiPower">0</b>/<b id="uiPowerThr">10</b></span>
    </div>
  </div>

  <!-- START overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</h2>
      <p id="startDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <div class="dbg">Engine: <b id="dbgEngine">loading‚Ä¶</b></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart">Start</button>
        <button id="btnBack" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- END overlay -->
  <div class="overlay" id="endOverlay">
    <div class="panel">
      <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="endReason"></p>

      <div class="kv">
        <div class="k">SCORE<b id="endScore">0</b></div>
        <div class="k">GRADE<b id="endGrade">C</b></div>
        <div class="k">ACCURACY<b id="endAcc">0%</b></div>
        <div class="k">COMBO MAX<b id="endComboMax">0</b></div>
      </div>

      <div class="row">
        <button id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- Engine (non-module) -->
  <script src="./GameEngine.js?v=3" defer
    onerror="(function(){var a=document.getElementById('startDesc'); if(a) a.textContent='‚ùå ‡πÇ‡∏´‡∏•‡∏î ./GameEngine.js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (404/‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå/‡∏û‡∏≤‡∏ò)'; var b=document.getElementById('dbgEngine'); if(b) b.textContent='LOAD FAIL';})()">
  </script>

  <!-- Optional modules (‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå) -->
  <script type="module">
    const ver = new URLSearchParams(location.search).get('v') || String(Date.now());
    const log = (...a)=>console.log('[GroupsRun]', ...a);

    async function optImport(path){
      try{
        return await import(path + (path.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(ver));
      }catch(e){
        // ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ï‡∏Å
        console.warn('[GroupsRun] skip', path, e?.message || e);
        return null;
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå /vr-groups/
    const Mods = {
      ui:       await optImport('./ui.js'),
      fever:    await optImport('./ui-fever.js'),
      fx:       await optImport('./fx.js'),
      gfx:      await optImport('./groups-fx.js'),
      coach:    await optImport('./groups-coach-th.js'),
      text:     await optImport('./groups-text.js'),
      quests:   await optImport('./groups-quests.js'),
      hudQuest: await optImport('./groups-hud-quest.js'),
      logger:   await optImport('./logger-cloud.js'),
      input:    await optImport('./input-adapter.js'),
      qm:       await optImport('./quest-manager.js'),
      qs:       await optImport('./quest-serial.js'),
    };

    // expose ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug
    window.GROUPS_MODS = Mods;
    log('optional mods loaded');

    // ---- QuestDirector binding (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏° export ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á) ----
    window.GroupsVR = window.GroupsVR || {};

    // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á quest director ‡∏à‡∏≤‡∏Å groups-quests.js (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const Q = Mods.quests || {};
    let director = null;

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ/‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    const maker =
      Q.createGroupsQuest || Q.createQuest || Q.makeQuestDirector || Q.makeDirector || Q.createQuestDirector;

    if (typeof maker === 'function'){
      try{
        director = maker({
          // ‡πÉ‡∏´‡πâ quest ‡πÉ‡∏ä‡πâ seed ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
          seed: new URLSearchParams(location.search).get('seed') || '',
        });
      }catch(e){
        console.warn('[GroupsRun] quest maker error', e);
      }
    }

    // ‡∏ñ‡πâ‡∏≤ quest-serial / quest-manager ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô repo ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢
    if (!director && Mods.qm && typeof Mods.qm.createQuestManager === 'function'){
      try{ director = Mods.qm.createQuestManager(); }catch{}
    }

    if (director){
      window.GroupsVR.QuestDirector = director;

      // hook: progress ‡∏à‡∏≤‡∏Å GameEngine -> quest
      const onProg =
        director.onProgress || director.handleProgress || director.push || director.feed || director.tick;

      if (typeof onProg === 'function'){
        window.addEventListener('groups:progress', (e)=>{
          try{ onProg.call(director, e.detail || {}); }catch(err){}
        });
      }

      // ‡∏ñ‡πâ‡∏≤ director ‡∏°‡∏µ start()
      if (typeof director.start === 'function'){
        try{ director.start(); }catch{}
      }
      log('QuestDirector ready ‚úÖ');
    } else {
      log('QuestDirector not found (ok)');
    }

    // 2) HUD Quest binder (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ boot/init)
    const HQ = Mods.hudQuest || {};
    const hqBoot = HQ.boot || HQ.init || HQ.bind || HQ.mount;
    if (typeof hqBoot === 'function'){
      try{ hqBoot(); }catch(e){ console.warn('[GroupsRun] hudQuest boot error', e); }
    }
  </script>

  <!-- Run-page wiring -->
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const q = new URLSearchParams(location.search);

      const runMode = (q.get('runMode') || 'play').toLowerCase();
      const diff    = (q.get('diff') || 'normal').toLowerCase();
      const style   = (q.get('style') || 'mix').toLowerCase();
      const time    = Number(q.get('time') || 90);
      const seed    = (q.get('seed') || '').trim() || String(Date.now());
      const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
      const autostart = q.get('autostart') === '1';

      $('startDesc').textContent = `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed}`;

      function goHub(){
        try{ window.HHACloudLogger?.flush?.(); }catch{}
        location.href = hub;
      }
      $('btnBack').addEventListener('click', goHub);
      $('btnHub2').addEventListener('click', goHub);

      function bindEvents(){
        window.addEventListener('hha:score', (e)=>{
          const d = e.detail||{};
          $('uiScore').textContent = String(d.score ?? 0);
          $('uiCombo').textContent = String(d.combo ?? 0);
          $('uiComboMax').textContent = String(d.comboMax ?? 0);
          $('uiMiss').textContent = String(d.misses ?? 0);
        });
        window.addEventListener('hha:time', (e)=>{
          const d = e.detail||{};
          $('uiTime').textContent = String(d.left ?? 0);
        });
        window.addEventListener('groups:power', (e)=>{
          const d = e.detail||{};
          const ch = Number(d.charge||0);
          const thr = Math.max(1, Number(d.threshold||10));
          $('uiPower').textContent = String(ch);
          $('uiPowerThr').textContent = String(thr);
          $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
        });
        window.addEventListener('hha:rank', (e)=>{
          const d = e.detail||{};
          if (d.grade) $('uiGrade').textContent = String(d.grade);
        });

        window.addEventListener('hha:end', (e)=>{
          const d = e.detail||{};
          $('endOverlay').classList.add('show');
          $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
          $('endScore').textContent = String(d.scoreFinal ?? 0);
          $('endGrade').textContent = String(d.grade ?? 'C');
          $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
          $('endComboMax').textContent = String(d.comboMax ?? 0);
          $('uiGrade').textContent = String(d.grade ?? 'C');

          // HHA Standard: ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö HUB
          try{
            const payload = {
              game: 'GroupsVR',
              ts: new Date().toISOString(),
              ...d,
              params: { runMode, diff, style, time, seed, hub }
            };
            localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
            localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));
          }catch{}
        });
      }

      function waitEngineReady(cb){
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;

          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            $('dbgEngine').textContent = 'READY ‚úÖ';
            cb(GE);
            return;
          }

          if (tries % 5 === 0){
            $('dbgEngine').textContent =
              (window.GroupsVR ? 'GroupsVR OK, waiting GameEngine‚Ä¶' : 'waiting script‚Ä¶');
          }

          if (tries > 200){
            clearInterval(t);
            $('dbgEngine').textContent = 'NOT FOUND ‚ùå';
            $('startDesc').textContent =
              '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GroupsVR.GameEngine.start() ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ ./GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ 200 ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏£‡∏á‡∏ö‡∏ô GitHub Pages';
          }
        }, 100);
      }

      function startGame(){
        $('btnStart').disabled = true;
        $('startDesc').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Engine‚Ä¶';

        waitEngineReady((GE)=>{
          const layer = $('fg-layer');
          GE.setLayerEl(layer);
          GE.start(diff, { runMode, style, time, seed });

          $('startOverlay').style.display = 'none';
          $('endOverlay').classList.remove('show');
          $('btnStart').disabled = false;
        });
      }

      $('btnStart').addEventListener('click', startGame);
      $('btnReplay').addEventListener('click', ()=>{
        try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
        $('endOverlay').classList.remove('show');
        $('startOverlay').style.display = 'grid';
        $('btnStart').disabled = false;
        if (autostart) setTimeout(startGame, 250);
      });

      bindEvents();
      waitEngineReady(()=>{});

      if (autostart) setTimeout(()=> $('btnStart').click(), 350);
    })();
  </script>
</body>
</html>