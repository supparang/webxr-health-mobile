<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- Shared CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame (minimal scene to enable WebXR Enter VR reliably) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script>
    window.HHA_VRUI_CONFIG = { lockPx: 92 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./GameEngine.js" defer></script>
</head>

<body class="view-mobile">

  <!-- XR Scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="colorManagement: true">
    <a-entity position="0 1.6 0"><a-camera></a-camera></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span id="vTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span id="vScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span id="vCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span id="vMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÖ RANK</span><span id="vRank" class="val">C</span></div>
      <div class="pill"><span class="lbl">üéØ ACC</span><span id="vAcc" class="val">0%</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">GOAL</div>
        <div class="tag" id="goalCount">0/1</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag"><span class="miniTime" id="miniTime">‚Äî</span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div id="pFill" class="fill"></div></div>
      <div class="pFoot"><span id="pCur">0</span>/<span id="pThr">8</span> ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">ü•¶ Coach</div>
        <div id="coachText" class="coachText">‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Play Layer -->
  <div id="playLayer" class="playLayer"></div>

  <!-- Crosshair (fallback) -->
  <div id="xhair" class="xhair" aria-hidden="true"></div>

  <!-- Start overlay (shows when autostart!=1) -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <div class="title">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô GroupsVR</div>
      <div class="sub" id="startLine">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start (Cardboard ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠)</div>
      <div class="hr"></div>

      <div class="grid2">
        <div class="kv">
          <div class="k">DEVICE / VIEW</div>
          <div class="v">
            <button id="vPC" class="chip" type="button">üñ•Ô∏è PC</button>
            <button id="vMobile" class="chip chip-on" type="button">üì± Mobile</button>
            <button id="vCVR" class="chip" type="button">üï∂Ô∏è Cardboard</button>
          </div>
          <div class="miniHint" id="viewHint" style="margin-top:8px;">‚Äî</div>

          <div class="k" style="margin-top:12px;">AIM MODE</div>
          <div class="v">
            <button id="aimTap" class="chip chip-on" type="button">üëÜ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤</button>
            <button id="aimShoot" class="chip" type="button">üéØ ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠</button>
          </div>
          <div class="miniHint" id="aimHint" style="margin-top:8px;">‚Äî</div>

          <div class="k" style="margin-top:12px;">AUDIO</div>
          <div class="v" style="gap:10px; align-items:center;">
            <button id="muteBtn" class="chip" type="button">üîà Mute: Off</button>
            <input id="volSlider" class="input" style="width:160px;" type="range" min="0" max="100" value="22" />
            <span id="volText" class="hint">22%</span>
          </div>
        </div>

        <div class="kv">
          <div class="k">PARAMS</div>
          <div class="v">
            <button id="runPlay" class="chip chip-on" type="button">run=play</button>
            <button id="runRes" class="chip" type="button">run=research</button>
          </div>

          <div class="v" style="margin-top:10px;">
            <button id="diffEasy" class="chip" type="button">easy</button>
            <button id="diffNormal" class="chip chip-on" type="button">normal</button>
            <button id="diffHard" class="chip" type="button">hard</button>
          </div>

          <div class="v" style="margin-top:10px;">
            <button id="styleMix" class="chip chip-on" type="button">mix</button>
            <button id="styleFeel" class="chip" type="button">feel</button>
            <button id="styleHard" class="chip" type="button">hard</button>
          </div>

          <div class="v" style="margin-top:10px;">
            <span class="hint">time</span>
            <input id="timeInput" class="input" type="number" min="30" max="180" value="90" />
            <button id="seedRand" class="chip" type="button">üé≤ seed=random</button>
          </div>

          <div class="v" style="margin-top:10px;">
            <button id="btnCopyLink" class="btn" type="button">üìã Copy link</button>
            <button id="btnShareLink" class="btn" type="button">üì§ Share</button>
          </div>
        </div>
      </div>

      <div class="row row2">
        <button id="btnStart" class="btn btn-strong" type="button">‚ñ∂Ô∏è START</button>
        <button id="btnLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
      </div>

      <div class="note" style="margin-top:10px;">
        VR Cardboard: ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î <b>ENTER VR</b> (‡∏°‡∏∏‡∏° UI ‡∏à‡∏≤‡∏Å vr-ui.js) ‡πÅ‡∏•‡πâ‡∏ß <b>‡πÅ‡∏ï‡∏∞‡∏à‡∏≠</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopy" class="btn" type="button">üìã Copy JSON</button>
      </div>
      <div class="row row2">
        <button id="btnBackLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
        <button id="btnHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        Tip: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö ‚Äú‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‚Äù ‚Üí ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏´‡πâ <b>crosshair ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const $ = (id)=>DOC.getElementById(id);

  const LS_VOL = 'HHA_AUDIO_VOL';
  const LS_MUT = 'HHA_AUDIO_MUTE';

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }
  function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

  function setView(view){
    const b = DOC.body;
    b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    b.classList.add('view-'+view);
  }

  async function copyText(text){
    try { await navigator.clipboard.writeText(String(text||'')); return true; }
    catch {
      try{
        const ta = DOC.createElement('textarea');
        ta.value = String(text||'');
        DOC.body.appendChild(ta);
        ta.select();
        DOC.execCommand('copy');
        ta.remove();
        return true;
      }catch{ return false; }
    }
  }

  // ---------------- State ----------------
  const state = {
    view: String(qs('view','mobile')||'mobile').toLowerCase(), // pc|mobile|cvr
    aim:  String(qs('aim','tap')||'tap').toLowerCase(),        // tap|shoot
    run:  (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play',
    diff: String(qs('diff','normal')||'normal').toLowerCase(),
    style:String(qs('style','mix')||'mix').toLowerCase(),
    time: clamp(qs('time',90), 30, 180),
    seed: String(qs('seed','')||'').trim() || String(Date.now()),
    ai:   String(qs('ai','1')||'1') !== '0',
    hub:  String(qs('hub','')||''),
  };

  // sanitize
  if (!['pc','mobile','cvr'].includes(state.view)) state.view='mobile';
  if (!['tap','shoot'].includes(state.aim)) state.aim='tap';
  if (!['easy','normal','hard'].includes(state.diff)) state.diff='normal';
  if (!['mix','feel','hard'].includes(state.style)) state.style='mix';
  if (state.view==='cvr') state.aim='shoot';

  // ---------------- UI chips ----------------
  function chip(id, on){
    const el = $(id); if(!el) return;
    el.classList.toggle('chip-on', !!on);
  }

  function applyHints(){
    $('viewHint').textContent =
      (state.view==='cvr') ? 'üï∂Ô∏è Cardboard: ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ + ‡πÄ‡∏Ç‡πâ‡∏≤ ENTER VR' :
      (state.view==='pc')  ? 'üñ•Ô∏è PC: ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÑ‡∏î‡πâ' :
                             'üì± Mobile: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÑ‡∏î‡πâ';

    $('aimHint').textContent =
      (state.aim==='shoot') ? 'üéØ ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠: crosshair + ‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏¥‡∏á (‡πÄ‡∏´‡∏°‡∏≤‡∏∞ Cardboard)' :
                              'üëÜ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤: ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏ö‡∏ô PC/Mobile';
  }

  function applyChips(){
    chip('vPC', state.view==='pc');
    chip('vMobile', state.view==='mobile');
    chip('vCVR', state.view==='cvr');

    chip('aimTap', state.aim==='tap');
    chip('aimShoot', state.aim==='shoot');

    chip('runPlay', state.run==='play');
    chip('runRes', state.run==='research');

    chip('diffEasy', state.diff==='easy');
    chip('diffNormal', state.diff==='normal');
    chip('diffHard', state.diff==='hard');

    chip('styleMix', state.style==='mix');
    chip('styleFeel', state.style==='feel');
    chip('styleHard', state.style==='hard');

    $('timeInput').value = String(state.time|0);

    applyHints();
    applyAimMode();
  }

  function applyAimMode(){
    const shoot = (state.aim==='shoot');
    DOC.body.classList.toggle('aim-shoot', shoot); // CSS patch ‡∏ó‡∏≥ crosshair + disable pointer events
  }

  // ---------------- Audio UI ----------------
  function loadAudioPrefs(){
    const vol = clamp(qs('vol', null) ?? localStorage.getItem(LS_VOL) ?? 22, 0, 100);
    const mute = String(qs('mute', null) ?? localStorage.getItem(LS_MUT) ?? '0');
    const isMute = (mute==='1'||mute==='true');
    $('volSlider').value = String(vol|0);
    $('volText').textContent = String(vol|0) + '%';
    $('muteBtn').textContent = isMute ? 'üîá Mute: On' : 'üîà Mute: Off';
    return { vol, isMute };
  }
  function saveAudioPrefs(vol, isMute){
    try{ localStorage.setItem(LS_VOL, String(vol|0)); }catch{}
    try{ localStorage.setItem(LS_MUT, isMute ? '1' : '0'); }catch{}
  }
  function applyAudioToEngine(){
    const A = window.GroupsVR && window.GroupsVR.Audio;
    if (!A) return;
    const vol = clamp($('volSlider').value, 0, 100);
    const isMute = $('muteBtn').textContent.includes('On');
    try{ A.setMute && A.setMute(!!isMute); }catch{}
    try{ A.setVolume && A.setVolume(vol/100); }catch{}
  }

  // ---------------- Build share link ----------------
  function buildLink(){
    const u = new URL(location.href);
    u.searchParams.set('view', state.view);
    u.searchParams.set('aim', state.aim);
    u.searchParams.set('run', state.run);
    u.searchParams.set('diff', state.diff);
    u.searchParams.set('style', state.style);
    u.searchParams.set('time', String(state.time|0));
    u.searchParams.set('seed', state.seed);
    u.searchParams.set('ai', state.ai ? '1' : '0');

    if (state.hub) u.searchParams.set('hub', state.hub);

    // carry audio prefs
    const vol = clamp($('volSlider').value, 0, 100);
    const isMute = $('muteBtn').textContent.includes('On');
    u.searchParams.set('vol', String(vol|0));
    u.searchParams.set('mute', isMute ? '1' : '0');

    // do NOT force autostart in share link (‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)
    u.searchParams.delete('autostart');
    return u.toString();
  }

  // ---------------- HUD binds ----------------
  window.addEventListener('hha:score', (ev)=>{
    const d = ev.detail||{};
    $('vScore').textContent = String(d.score ?? 0);
    $('vCombo').textContent = String(d.combo ?? 0);
    $('vMiss').textContent  = String(d.misses ?? 0);
  }, {passive:true});

  window.addEventListener('hha:time', (ev)=>{
    const d = ev.detail||{};
    $('vTime').textContent = String(d.left ?? 0);
  }, {passive:true});

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev.detail||{};
    $('vRank').textContent = String(d.grade ?? 'C');
    $('vAcc').textContent  = String((d.accuracy ?? 0) + '%');
  }, {passive:true});

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev.detail||{};
    $('coachText').textContent = String(d.text||'');
    const mood = String(d.mood||'neutral');
    const img =
      (mood==='happy') ? '../img/coach-happy.png' :
      (mood==='sad')   ? '../img/coach-sad.png' :
      (mood==='fever') ? '../img/coach-fever.png' :
                        '../img/coach-neutral.png';
    $('coachImg').src = img;
  }, {passive:true});

  window.addEventListener('groups:power', (ev)=>{
    const d = ev.detail||{};
    const cur = Number(d.charge||0);
    const thr = Math.max(1, Number(d.threshold||8));
    $('pCur').textContent = String(cur|0);
    $('pThr').textContent = String(thr|0);
    $('pFill').style.width = Math.round((cur/thr)*100) + '%';
  }, {passive:true});

  window.addEventListener('quest:update', (ev)=>{
    const d = ev.detail||{};
    const gTitle = String(d.goalTitle||'‚Äî');
    const gNow   = Number(d.goalNow||0);
    const gTot   = Math.max(1, Number(d.goalTotal||1));
    const gPct   = clamp(d.goalPct ?? (gNow/gTot*100), 0, 100);

    const mTitle = String(d.miniTitle||'‚Äî');
    const mNow   = Number(d.miniNow||0);
    const mTot   = Math.max(1, Number(d.miniTotal||1));
    const mPct   = clamp(d.miniPct ?? (mNow/mTot*100), 0, 100);
    const mLeft  = Number(d.miniTimeLeftSec||0);

    $('goalTitle').textContent = 'üéØ GOAL';
    $('goalCount').textContent = `${gNow}/${gTot}`;
    $('goalFill').style.width = Math.round(gPct) + '%';
    $('goalSub').textContent = gTitle;

    $('miniTitle').textContent = '‚ö° MINI';
    $('miniFill').style.width = Math.round(mPct) + '%';
    $('miniSub').textContent = mTitle;
    $('miniTime').textContent = (mLeft>0) ? `${mLeft}s` : '‚Äî';

    const urgent = (mLeft>0 && mLeft<=3);
    DOC.body.classList.toggle('mini-urgent', urgent);
  }, {passive:true});

  // ---------------- Audio hooks ----------------
  function hookAudio(){
    const A = window.GroupsVR && window.GroupsVR.Audio;
    if (!A) return;

    try{ A.unlock && A.unlock(); }catch{}
    applyAudioToEngine();

    window.addEventListener('hha:judge', (ev)=>{
      const d = ev.detail||{};
      const k = String(d.kind||'').toLowerCase();
      if (k==='good') A.good();
      else if (k==='bad') A.bad();
      else if (k==='boss') A.boss();
      else if (k==='miss') A.bad();
    }, {passive:true});

    window.addEventListener('groups:progress', (ev)=>{
      const d = ev.detail||{};
      const kind = String(d.kind||'');
      if (kind==='storm_on') A.storm();
      if (kind==='boss_spawn') A.boss();
      if (kind==='perfect_switch') A.good();
    }, {passive:true});

    let tmr = 0;
    function tickLoop(){
      clearTimeout(tmr);
      const urgent = DOC.body.classList.contains('mini-urgent') || DOC.body.classList.contains('groups-storm-urgent');
      if (urgent) A.tick();
      tmr = setTimeout(tickLoop, urgent ? 420 : 650);
    }
    tickLoop();
  }

  // ---------------- Shoot fallback (aim=shoot) ----------------
  function emitShoot(lockPx){
    const x = (window.innerWidth||360) * 0.5;
    const y = (window.innerHeight||640) * 0.5;
    try{ window.dispatchEvent(new CustomEvent('hha:shoot', { detail:{ x, y, lockPx: lockPx||92 } })); }catch{}
    DOC.body.classList.add('shot-pulse');
    setTimeout(()=> DOC.body.classList.remove('shot-pulse'), 90);
  }

  DOC.addEventListener('pointerdown', (e)=>{
    const startShown = !$('startOverlay').classList.contains('hidden');
    const endShown = !$('endOverlay').classList.contains('hidden');
    if (startShown || endShown) return;
    if (state.aim !== 'shoot') return;

    const t = e.target;
    if (t && t.closest && t.closest('button,.panel,.overlay')) return;

    emitShoot(92);
  }, { passive:true });

  // ---------------- End / Summary ----------------
  const LS_LAST = 'HHA_LAST_SUMMARY';
  const LS_HIST = 'HHA_SUMMARY_HISTORY';

  let lastSummary = null;
  let startIso = new Date().toISOString();

  function saveLast(summary){
    try{ localStorage.setItem(LS_LAST, JSON.stringify(summary)); }catch{}
    try{
      const hist = JSON.parse(localStorage.getItem(LS_HIST)||'[]');
      hist.unshift(summary);
      localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 50)));
    }catch{}
  }

  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail||{};
    const endIso = new Date().toISOString();

    lastSummary = Object.assign({
      timestampIso: endIso,
      projectTag: 'HeroHealth',
      gameTag: 'GroupsVR',
      runMode: state.run,
      diff: state.diff,
      style: state.style,
      view: state.view,
      aim: state.aim,
      ai: state.ai ? 1 : 0,
      durationPlannedSec: state.time|0,
      startTimeIso: startIso,
      endTimeIso: endIso,
      seed: state.seed
    }, d);

    saveLast(lastSummary);

    $('endOverlay').classList.remove('hidden');
    $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');
    $('endScore').textContent = String(d.scoreFinal ?? 0);
    $('endRank').textContent  = String(d.grade ?? 'C');
    $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
    $('endMiss').textContent  = String(d.misses ?? 0);

    $('btnHub').style.display = state.hub ? 'inline-flex' : 'none';
  }, {passive:true});

  $('btnRestart').addEventListener('click', ()=> location.reload());

  $('btnCopy').addEventListener('click', async ()=>{
    if (!lastSummary){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
    const ok = await copyText(JSON.stringify(lastSummary, null, 2));
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  });

  $('btnBackLauncher').addEventListener('click', ()=>{
    const u = new URL('../groups-vr.html', location.href);
    if (state.hub) u.searchParams.set('hub', state.hub);
    location.href = u.toString();
  });

  $('btnHub').addEventListener('click', ()=>{
    if (!state.hub){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå hub=...'); return; }
    location.href = state.hub;
  });

  // ---------------- Start overlay controls ----------------
  $('vPC').addEventListener('click', ()=>{ state.view='pc'; applyChips(); });
  $('vMobile').addEventListener('click', ()=>{ state.view='mobile'; applyChips(); });
  $('vCVR').addEventListener('click', ()=>{ state.view='cvr'; state.aim='shoot'; applyChips(); });

  $('aimTap').addEventListener('click', ()=>{ state.aim='tap'; applyChips(); });
  $('aimShoot').addEventListener('click', ()=>{ state.aim='shoot'; applyChips(); });

  $('runPlay').addEventListener('click', ()=>{ state.run='play'; applyChips(); });
  $('runRes').addEventListener('click', ()=>{ state.run='research'; applyChips(); });

  $('diffEasy').addEventListener('click', ()=>{ state.diff='easy'; applyChips(); });
  $('diffNormal').addEventListener('click', ()=>{ state.diff='normal'; applyChips(); });
  $('diffHard').addEventListener('click', ()=>{ state.diff='hard'; applyChips(); });

  $('styleMix').addEventListener('click', ()=>{ state.style='mix'; applyChips(); });
  $('styleFeel').addEventListener('click', ()=>{ state.style='feel'; applyChips(); });
  $('styleHard').addEventListener('click', ()=>{ state.style='hard'; applyChips(); });

  $('timeInput').addEventListener('change', ()=>{ state.time = clamp($('timeInput').value, 30, 180); applyChips(); });

  $('seedRand').addEventListener('click', ()=>{ state.seed = String(Date.now()); applyChips(); });

  $('btnCopyLink').addEventListener('click', async ()=>{
    const ok = await copyText(buildLink());
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  });

  $('btnShareLink').addEventListener('click', async ()=>{
    const url = buildLink();
    if (navigator.share){
      try{ await navigator.share({ title:'HeroHealth GroupsVR', url }); }catch{}
    }else{
      const ok = await copyText(url);
      alert(ok ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Share ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Share/Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  });

  $('btnLauncher').addEventListener('click', ()=>{
    const u = new URL('../groups-vr.html', location.href);
    if (state.hub) u.searchParams.set('hub', state.hub);
    location.href = u.toString();
  });

  // audio controls on start overlay
  loadAudioPrefs();
  $('volSlider').addEventListener('input', ()=>{
    const vol = clamp($('volSlider').value, 0, 100);
    $('volText').textContent = String(vol|0) + '%';
    const isMute = $('muteBtn').textContent.includes('On');
    saveAudioPrefs(vol, isMute);
    applyAudioToEngine();
  });
  $('muteBtn').addEventListener('click', ()=>{
    const isOn = $('muteBtn').textContent.includes('On');
    $('muteBtn').textContent = isOn ? 'üîà Mute: Off' : 'üîá Mute: On';
    const vol = clamp($('volSlider').value, 0, 100);
    saveAudioPrefs(vol, !isOn);
    applyAudioToEngine();
  });

  // ---------------- Start engine ----------------
  function waitForEngine(cb){
    const it = setInterval(()=>{
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function'){
        clearInterval(it);
        cb(E);
      }
    }, 60);
  }

  function startEngine(){
    setView(state.view);
    applyChips();
    hookAudio();

    waitForEngine((E)=>{
      E.setLayerEl($('playLayer'));
      startIso = new Date().toISOString();
      E.start(state.diff, { runMode: state.run, diff: state.diff, style: state.style, time: state.time, seed: state.seed });
    });
  }

  $('btnStart').addEventListener('click', ()=>{
    $('startOverlay').classList.add('hidden');
    startEngine();
  });

  // autostart
  const auto = String(qs('autostart','0')||'0');
  if (auto === '1'){
    $('startOverlay').classList.add('hidden');
    startEngine();
  }else{
    applyChips();
  }

})();
</script>
</body>
</html>