<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core (VR button + sky feel) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Main CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <style>
    /* minimal overlay UI (safe even if css exists) */
    .overlay{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .panel{
      width:min(720px, 100%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.80);
      box-shadow:0 18px 46px rgba(0,0,0,.45);
      padding:16px;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }
    .panel h2{ margin:6px 0 8px; font-size:20px; }
    .panel .sub{ margin:0 0 12px; color:#94a3b8; line-height:1.5; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      flex:1; min-width:150px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(34,197,94,.18);
      color:#e5e7eb;
      font-weight:800;
      cursor:pointer;
    }
    .btn.secondary{ background:rgba(56,189,248,.16); }
    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .kv div{ padding:10px 12px; border:1px solid rgba(148,163,184,.18); border-radius:14px; background:rgba(15,23,42,.58); }
    .kv b{ display:block; font-size:12px; color:#94a3b8; margin-bottom:2px; }
    .kv span{ font-size:14px; }
    .endBox{ margin-top:12px; padding:12px; border-radius:14px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.58); }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#94a3b8; }
    #endOverlay{ display:none; }
  </style>
</head>

<body class="groups-style-mix">
  <!-- A-Frame tiny scene (sky + VR button) -->
  <a-scene
    embedded
    vr-mode-ui="enabled: true"
    renderer="colorManagement:true"
    style="position:fixed; inset:0; z-index:0;">
    <a-sky color="#020617"></a-sky>
    <a-entity id="cam" camera position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- Gameplay layer -->
  <div id="fg-layer" class="fg-layer" aria-label="targets layer"></div>

  <!-- HUD (‡πÉ‡∏´‡πâ groups-hud-quest.js / hud binder ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏≠‡∏á) -->
  <div id="hudRoot" class="hud-root"></div>

  <!-- START overlay -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <h2>üçΩÔ∏è Food Groups VR</h2>
      <p class="sub">
        ‡∏¢‡∏¥‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏π‡πà ‚Äî ‡πÇ‡∏´‡∏°‡∏î <b id="uiRun">play</b> ‚Ä¢ diff <b id="uiDiff">normal</b> ‚Ä¢ style <b id="uiStyle">mix</b> ‚Ä¢ time <b id="uiTime">90</b>s
      </p>

      <div class="kv">
        <div><b>Seed</b><span id="uiSeed">‚Äî</span></div>
        <div><b>Hub</b><span id="uiHub">‚Äî</span></div>
      </div>

      <div class="row">
        <button class="btn" id="btnStart">‚ñ∂Ô∏è Start</button>
        <button class="btn secondary" id="btnBack">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="endBox">
        <div class="mono">Tip: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ autostart=1 ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î script ‡∏Ñ‡∏£‡∏ö</div>
      </div>
    </div>
  </div>

  <!-- END overlay -->
  <div id="endOverlay" class="overlay">
    <div class="panel">
      <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p class="sub" id="endReason">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</p>

      <div class="kv">
        <div><b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b><span id="endScore">0</span></div>
        <div><b>‡πÄ‡∏Å‡∏£‡∏î</b><span id="endGrade">C</span></div>
        <div><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</b><span id="endAcc">0%</span></div>
        <div><b>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</b><span id="endCombo">0</span></div>
        <div><b>Miss</b><span id="endMiss">0</span></div>
        <div><b>Quest</b><span id="endQuest">0/0 ‚Ä¢ 0/0</span></div>
      </div>

      <div class="endBox">
        <div class="mono" id="endMeta">‚Äî</div>
      </div>

      <div class="row">
        <button class="btn" id="btnRestart">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn secondary" id="btnBack2">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- Scripts (order matters) -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/ui-fever.js" defer></script>
  <script src="../vr/ui-karaoke.js" defer></script>

  <script src="./groups-hud-quest.js" defer></script>
  <script src="./groups-text.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./groups-fx.js" defer></script>

  <script src="./GameEngine.js" defer></script>
  <script src="./groups.safe.js" defer></script>

  <script>
    (function(){
      function qs(){ try{return new URLSearchParams(location.search);}catch{return new URLSearchParams('');} }
      const p = qs();

      const run  = String(p.get('run') || p.get('mode') || 'play').toLowerCase()==='research' ? 'research' : 'play';
      const diff = ['easy','normal','hard'].includes(String(p.get('diff')||'normal').toLowerCase()) ? String(p.get('diff')||'normal').toLowerCase() : 'normal';
      const style= ['hard','feel','mix'].includes(String(p.get('style')||'mix').toLowerCase()) ? String(p.get('style')||'mix').toLowerCase() : 'mix';
      const time = Math.max(30, Math.min(180, parseInt(p.get('time')||'90',10)||90));
      const seed = String(p.get('seed')||'').trim() || ('S'+Date.now());
      const hub  = String(p.get('hub')||'../index.html').trim();

      // body style class
      document.body.classList.remove('groups-style-hard','groups-style-feel','groups-style-mix');
      document.body.classList.add('groups-style-'+style);

      // UI
      document.getElementById('uiRun').textContent = run;
      document.getElementById('uiDiff').textContent = diff;
      document.getElementById('uiStyle').textContent = style;
      document.getElementById('uiTime').textContent = String(time);
      document.getElementById('uiSeed').textContent = seed;
      document.getElementById('uiHub').textContent  = hub;

      function goHub(){ location.href = hub + (hub.includes('?') ? '&' : '?') + 'ts=' + Date.now(); }

      document.getElementById('btnBack').addEventListener('click', goHub);
      document.getElementById('btnBack2').addEventListener('click', goHub);

      // Start
      function startGame(){
        // ensure params for boot/autostart consistency
        try{
          const sp = new URLSearchParams(location.search);
          sp.set('run', run);
          sp.set('diff', diff);
          sp.set('style', style);
          sp.set('time', String(time));
          sp.set('seed', seed);
          sp.set('hub', hub);
          history.replaceState(null,'', location.pathname + '?' + sp.toString());
        }catch{}

        // hide overlay
        document.getElementById('startOverlay').style.display = 'none';

        // Boot.start will also reset quest
        if (window.GroupsBoot && typeof window.GroupsBoot.start === 'function'){
          window.GroupsBoot.start(run, { diff, time, seed, style });
        } else {
          console.warn('[Run] GroupsBoot not ready yet');
        }
      }

      document.getElementById('btnStart').addEventListener('click', startGame);

      // Restart
      document.getElementById('btnRestart').addEventListener('click', ()=>{
        document.getElementById('endOverlay').style.display = 'none';
        // reload for clean state
        const sp = new URLSearchParams(location.search);
        sp.set('autostart','1');
        sp.set('ts', String(Date.now()));
        location.href = location.pathname + '?' + sp.toString();
      });

      // End summary
      window.addEventListener('hha:end', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const q = d && d.goalsTotal != null ? d : null;

        document.getElementById('endReason').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason||'end');
        document.getElementById('endScore').textContent  = String(d.scoreFinal ?? 0);
        document.getElementById('endGrade').textContent  = String(d.grade || 'C');
        document.getElementById('endAcc').textContent    = String((d.accuracyGoodPct ?? 0) + '%');
        document.getElementById('endCombo').textContent  = String(d.comboMax ?? 0);
        document.getElementById('endMiss').textContent   = String(d.misses ?? 0);
        document.getElementById('endQuest').textContent  =
          `${d.goalsCleared ?? 0}/${d.goalsTotal ?? 0} ‚Ä¢ ${d.miniCleared ?? 0}/${d.miniTotal ?? 0}`;

        document.getElementById('endMeta').textContent =
          `run=${d.runMode||run} ‚Ä¢ diff=${d.diff||diff} ‚Ä¢ style=${d.style||style} ‚Ä¢ seed=${d.seed||seed}`;

        // store last summary
        try{
          const payload = {
            game:'groups',
            ts: Date.now(),
            run, diff, style, time, seed,
            summary: d
          };
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
        }catch{}

        document.getElementById('endOverlay').style.display = 'flex';
      });

      // Auto-start overlay: if autostart=1 we can hide overlay immediately after engine starts.
      // Boot itself will autostart; we just keep overlay visible until manual or Boot hides it.
      const autostart = String(p.get('autostart')||'0');
      if (autostart === '1'){
        // try start after small delay (Boot has retry too; this helps in fast devices)
        setTimeout(()=>startGame(), 220);
      }
    })();
  </script>
</body>
</html>
