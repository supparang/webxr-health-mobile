<!-- === /herohealth/vr-groups/groups-vr.html ===
RUN ‚Äî Goal RIGHT + Coach BOTTOM-RIGHT + VR Shoot (gaze/tap)
Params:
- ui=auto|pc|mobile|vr
- shoot=auto|off|tap|gaze   (auto: if ui=vr -> gaze)
- dwell=650 (ms)            for gaze
- lock=140 (px)             lock radius
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />
  <link rel="stylesheet" href="./groups-vr.css" />
</head>

<body>
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <div class="hudRow" aria-label="HUD">
    <div class="hudCard hudLeft">
      <div class="hudItem"><span>SCORE</span><b id="uiScore">0</b></div>
      <div class="hudItem"><span>COMBO</span><b><span id="uiCombo">0</span> <i class="muted">(MAX <span id="uiComboMax">0</span>)</i></b></div>
      <div class="hudItem"><span>MISS</span><b id="uiMiss">0</b></div>
      <div class="hudItem"><span>GRADE</span><b id="uiGrade">C</b></div>
    </div>

    <div class="hudCard hudRight">
      <div class="hudItem"><span>TIME</span><b><span id="uiTime">90</span>s</b></div>
      <div class="hudItem"><span>MODE</span><b id="uiMode">play</b></div>
      <div class="hudItem"><span>DIFF</span><b id="uiDiff">normal</b></div>
      <div class="hudItem"><span>STYLE</span><b id="uiStyle">mix</b></div>
    </div>
  </div>

  <div class="questDock" aria-label="Quest">
    <div class="questCard">
      <div class="qHead">GOAL <span class="qNum" id="uiGoalNum">0/0</span></div>
      <div class="qTitle" id="uiGoalTitle">‚Äî</div>
      <div class="qBar"><i id="uiGoalBar"></i></div>
    </div>

    <div class="questCard">
      <div class="qHead">MINI <span class="qNum" id="uiMiniNum">0/0</span></div>
      <div class="qTitle" id="uiMiniTitle">‚Äî</div>
      <div class="qBar mini"><i id="uiMiniBar"></i></div>
      <div class="qTime" id="uiMiniTime" style="display:none;">‚è≥ 0s</div>
    </div>
  </div>

  <div class="powerDock" aria-label="Power">
    <div class="powerCard">
      <div class="powerTop">
        <b>POWER</b>
        <span><b id="uiPower">0</b>/<b id="uiPowerThr">8</b></span>
      </div>
      <div class="powerBar"><i id="uiPowerBar"></i></div>
      <div class="powerHint" id="uiShootHint">‚≠ê = Overdrive+Magnet+Shield ¬∑ ‚ùÑÔ∏è = Freeze ¬∑ STORM ‡∏£‡∏∞‡∏ß‡∏±‡∏á!</div>
    </div>
  </div>

  <div class="coachDock" aria-label="Coach">
    <div class="coachCard">
      <div class="coachLine" id="uiCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! üéµ</div>
      <div class="feverBar"><i id="uiFeverBar"></i></div>
      <div class="shieldTag" id="uiShieldTag" style="display:none;">üõ°Ô∏è SHIELD READY</div>
    </div>
    <div class="coachImg">
      <img id="uiCoachImg" src="../img/coach-neutral.png" alt="Coach"/>
    </div>
  </div>

  <div id="reticle" class="reticle" aria-hidden="true"></div>
  <button id="btnVR" class="btnVR" type="button">VR</button>

  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</h2>
      <p id="startDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <div class="dbg">Boot: <b id="dbgBoot">loading‚Ä¶</b></div>
      <div class="warn" id="warnBox"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart">Start</button>
        <button id="btnBack" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="endOverlay" style="display:none;">
    <div class="panel">
      <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="endReason"></p>

      <div class="kv">
        <div class="k">SCORE<b id="endScore">0</b></div>
        <div class="k">GRADE<b id="endGrade">C</b></div>
        <div class="k">ACCURACY<b id="endAcc">0%</b></div>
        <div class="k">COMBO MAX<b id="endComboMax">0</b></div>
      </div>

      <div class="row">
        <button id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);

    const runMode = (q.get('runMode') || 'play').toLowerCase();
    const diff    = (q.get('diff') || 'normal').toLowerCase();
    const style   = (q.get('style') || 'mix').toLowerCase();
    const time    = Number(q.get('time') || 90);
    const seed    = (q.get('seed') || '').trim() || String(Date.now());
    const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
    const autostart = q.get('autostart') === '1';
    const v = (q.get('v') || String(Date.now()));
    const ui = (q.get('ui') || 'auto').toLowerCase(); // auto | pc | mobile | vr

    // NEW: VR shooting params
    const shoot = (q.get('shoot') || 'auto').toLowerCase(); // auto|off|tap|gaze
    const dwell = Number(q.get('dwell') || 650);
    const lock  = Number(q.get('lock')  || 140);

    $('uiMode').textContent = runMode;
    $('uiDiff').textContent = diff;
    $('uiStyle').textContent = style;

    $('startDesc').textContent =
      `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed} | ui=${ui} | shoot=${shoot}`;

    function warn(msg){
      console.warn(msg);
      const box = $('warnBox');
      if (!box) return;
      box.style.display = 'block';
      box.textContent += (box.textContent ? '\n' : '') + String(msg);
    }

    function setUIMode(){
      document.body.classList.remove('ui-pc','ui-mobile','ui-vr');
      let m = ui;
      if (m === 'auto'){
        const isSmall = matchMedia('(max-width: 700px)').matches || matchMedia('(max-height: 700px)').matches;
        m = isSmall ? 'mobile' : 'pc';
      }
      if (m === 'vr') document.body.classList.add('ui-vr');
      else if (m === 'mobile') document.body.classList.add('ui-mobile');
      else document.body.classList.add('ui-pc');

      $('reticle').style.display = document.body.classList.contains('ui-vr') ? 'block' : 'none';

      // hint
      const isVR = document.body.classList.contains('ui-vr');
      $('uiShootHint').textContent = isVR
        ? `üéØ VR SHOOT: ${shoot} (dwell=${dwell}ms, lock=${lock}px) ‚Äî ‡∏à‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á/‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠`
        : `‚≠ê = Overdrive+Magnet+Shield ¬∑ ‚ùÑÔ∏è = Freeze ¬∑ STORM ‡∏£‡∏∞‡∏ß‡∏±‡∏á!`;
    }
    setUIMode();
    addEventListener('resize', ()=>{ setUIMode(); syncBlockedRects(); });

    async function safeImport(path){
      try{
        await import(path + (path.includes('?') ? '' : ('?v='+encodeURIComponent(v))));
        return true;
      }catch(e){
        warn(`‚ö†Ô∏è load fail: ${path}\n${e?.message || e}`);
        return false;
      }
    }

    const BOOT_LIST = [
      './groups-fx.js',
      './audio.js',
      './groups-quests.js',
      './GameEngine.js',
    ];

    async function boot(){
      $('dbgBoot').textContent = 'loading modules‚Ä¶';
      for (const p of BOOT_LIST) await safeImport(p);
      $('dbgBoot').textContent = (window.GroupsVR && window.GroupsVR.GameEngine) ? 'READY ‚úÖ' : 'ENGINE NOT FOUND ‚ùå';
    }

    function flushHardened(reason){
      try{ window.HHACloudLogger?.flush?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushNow?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushHardened?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flush?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flushNow?.({ reason }); }catch{}
    }

    function goHub(){
      flushHardened('go_hub');
      location.href = hub;
    }
    $('btnBack').addEventListener('click', goHub);
    $('btnHub2').addEventListener('click', goHub);

    addEventListener('pagehide', ()=>flushHardened('pagehide'));
    addEventListener('beforeunload', ()=>flushHardened('beforeunload'));
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'hidden') flushHardened('hidden');
    });

    // blocked rects
    function rectOf(el){
      if (!el) return null;
      const r = el.getBoundingClientRect();
      if (!r || r.width <= 2 || r.height <= 2) return null;
      return { left:r.left, top:r.top, right:r.right, bottom:r.bottom };
    }
    function syncBlockedRects(){
      const GE = window.GroupsVR?.GameEngine;
      if (!GE || typeof GE.setBlockedRects !== 'function') return;

      const rects = [];
      rects.push(rectOf(document.querySelector('.hudRow')));
      rects.push(rectOf(document.querySelector('.questDock')));
      rects.push(rectOf(document.querySelector('.coachDock')));
      rects.push(rectOf(document.querySelector('.powerDock')));

      GE.setBlockedRects(rects.filter(Boolean));
    }

    // auto No-Junk on mini title
    function isNoJunkTitle(t){
      t = String(t||'').toLowerCase();
      return t.includes('no-junk') || t.includes('nojunk') || (t.includes('‡∏´‡πâ‡∏≤‡∏°') && t.includes('‡∏Ç‡∏¢‡∏∞'));
    }

    function bindEvents(){
      addEventListener('hha:score', (e)=>{
        const d = e.detail||{};
        $('uiScore').textContent = String(d.score ?? 0);
        $('uiCombo').textContent = String(d.combo ?? 0);
        $('uiComboMax').textContent = String(d.comboMax ?? 0);
        $('uiMiss').textContent = String(d.misses ?? 0);
      });

      addEventListener('hha:time', (e)=>{
        const d = e.detail||{};
        $('uiTime').textContent = String(d.left ?? 0);
      });

      addEventListener('groups:power', (e)=>{
        const d = e.detail||{};
        const ch = Number(d.charge||0);
        const thr = Math.max(1, Number(d.threshold||8));
        $('uiPower').textContent = String(ch);
        $('uiPowerThr').textContent = String(thr);
        $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
      });

      addEventListener('hha:rank', (e)=>{
        const d = e.detail||{};
        if (d.grade) $('uiGrade').textContent = String(d.grade);
      });

      addEventListener('quest:update', (e)=>{
        const d = e.detail||{};
        const GE = window.GroupsVR?.GameEngine;

        if (d.goalTitle != null) $('uiGoalTitle').textContent = String(d.goalTitle);
        if (d.miniTitle != null) $('uiMiniTitle').textContent = String(d.miniTitle);

        const gn = (d.goalNow!=null && d.goalTotal!=null) ? `${d.goalNow}/${d.goalTotal}` : '0/0';
        const mn = (d.miniNow!=null && d.miniTotal!=null) ? `${d.miniNow}/${d.miniTotal}` : '0/0';
        $('uiGoalNum').textContent = gn;
        $('uiMiniNum').textContent = mn;

        let gp = (d.goalPct != null) ? Number(d.goalPct)
              : (d.goalNow != null && d.goalTotal != null) ? (Number(d.goalNow)/Math.max(1,Number(d.goalTotal)))*100
              : 0;
        let mp = (d.miniPct != null) ? Number(d.miniPct)
              : (d.miniNow != null && d.miniTotal != null) ? (Number(d.miniNow)/Math.max(1,Number(d.miniTotal)))*100
              : 0;

        $('uiGoalBar').style.width = Math.max(0, Math.min(100, gp)).toFixed(1)+'%';
        $('uiMiniBar').style.width = Math.max(0, Math.min(100, mp)).toFixed(1)+'%';

        const tLeft = Number(d.miniTimeLeftSec ?? 0);
        const timeEl = $('uiMiniTime');
        if (Number.isFinite(tLeft) && tLeft > 0){
          timeEl.style.display = 'block';
          timeEl.textContent = `‚è≥ ${tLeft}s`;
          document.body.classList.toggle('mini-urgent', tLeft <= 3);
        } else {
          timeEl.style.display = 'none';
          document.body.classList.remove('mini-urgent');
        }

        // No-Junk Zone auto ON/OFF
        if (GE && typeof GE.setNoJunk === 'function'){
          const title = String(d.miniTitle||'');
          const on = isNoJunkTitle(title) && (Number.isFinite(tLeft) ? tLeft>0 : true);
          if (on){
            const W = innerWidth || 360;
            const H = innerHeight || 640;
            const r = Math.max(110, Math.min(W,H) * (document.body.classList.contains('ui-vr') ? 0.26 : 0.22));
            const cx = W * 0.50;
            const cy = H * 0.56;
            GE.setNoJunk({ on:true, cx, cy, r });
          } else {
            GE.setNoJunk({ on:false });
          }
        }
      });

      addEventListener('hha:coach', (e)=>{
        const d = e.detail||{};
        if (d.text) $('uiCoachLine').textContent = String(d.text);
        const mood = String(d.mood||'neutral');
        const img = (mood==='happy') ? '../img/coach-happy.png'
                 : (mood==='sad')   ? '../img/coach-sad.png'
                 : (mood==='fever') ? '../img/coach-fever.png'
                 : '../img/coach-neutral.png';
        $('uiCoachImg').src = img;
      });

      addEventListener('hha:fever', (e)=>{
        const d = e.detail||{};
        const pct = Math.max(0, Math.min(100, Number(d.feverPct||0)));
        $('uiFeverBar').style.width = pct.toFixed(1)+'%';
        const shield = Number(d.shield||0) > 0;
        $('uiShieldTag').style.display = shield ? 'inline-flex' : 'none';
      });

      addEventListener('hha:end', (e)=>{
        const d = e.detail||{};
        $('endOverlay').style.display = 'grid';
        $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
        $('endScore').textContent = String(d.scoreFinal ?? 0);
        $('endGrade').textContent = String(d.grade ?? 'C');
        $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
        $('endComboMax').textContent = String(d.comboMax ?? 0);
        $('uiGrade').textContent = String(d.grade ?? 'C');

        try{
          const payload = {
            game: 'GroupsVR',
            ts: new Date().toISOString(),
            ...d,
            params: { runMode, diff, style, time, seed, hub, ui, shoot, dwell, lock }
          };
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
          localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));
        }catch{}

        flushHardened('end');
      });
    }

    function waitEngineReady(){
      return new Promise((resolve)=>{
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;
          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            resolve(GE);
          }
          if (tries > 250){
            clearInterval(t);
            warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GroupsVR.GameEngine.start() ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ 200 ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏£‡∏á');
            $('dbgBoot').textContent = 'ENGINE NOT FOUND ‚ùå';
          }
        }, 80);
      });
    }

    async function startGame(){
      $('btnStart').disabled = true;
      $('startDesc').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶';

      await boot();
      const GE = await waitEngineReady();
      if (!GE){ $('btnStart').disabled = false; return; }

      GE.setLayerEl($('fg-layer'));
      GE.setUIMode?.(document.body.classList.contains('ui-vr') ? 'vr' :
                     document.body.classList.contains('ui-mobile') ? 'mobile' : 'pc');

      syncBlockedRects();
      setTimeout(syncBlockedRects, 120);

      // pass vr shoot settings
      GE.start(diff, {
        runMode, style, time, seed,
        shoot, dwellMs: dwell, lockPx: lock
      });

      $('startOverlay').style.display = 'none';
      $('endOverlay').style.display = 'none';
      $('btnStart').disabled = false;
    }

    $('btnStart').addEventListener('click', startGame);
    $('btnReplay').addEventListener('click', ()=>{
      try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
      $('endOverlay').style.display = 'none';
      $('startOverlay').style.display = 'grid';
      if (autostart) setTimeout(startGame, 250);
    });

    $('btnVR').addEventListener('click', ()=>{
      const u = new URL(location.href);
      const isVR = document.body.classList.contains('ui-vr');
      u.searchParams.set('ui', isVR ? 'auto' : 'vr');
      // if going to VR and shoot is auto -> keep auto (engine will default to gaze)
      u.searchParams.set('v', String(Date.now()));
      location.href = u.toString();
    });

    bindEvents();
    await boot();
    if (autostart) setTimeout(()=> $('btnStart').click(), 350);
  </script>
</body>
</html>