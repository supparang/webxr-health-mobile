<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- A-Frame background (optional) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS alias -->
  <link rel="stylesheet" href="./groups.css" />
</head>

<body>
  <!-- Background scene -->
  <a-scene embedded vr-mode-ui="enabled: true" renderer="antialias: true">
    <a-sky color="#06101f"></a-sky>
    <a-entity position="0 1.6 0" camera look-controls></a-entity>
  </a-scene>

  <!-- Gameplay layer -->
  <div id="fg-layer"></div>

  <!-- HUD -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card hud-left">
        <div class="hud-row"><div class="hud-title">SCORE</div><div class="hud-val" id="hud-score">0</div></div>
        <div class="hud-row"><div class="hud-title">COMBO</div><div class="hud-val" id="hud-combo">0</div></div>
        <div class="hud-row"><div class="hud-title">MISS</div><div class="hud-val" id="hud-miss">0</div></div>
      </div>

      <div class="hud-card hud-mid">
        <div class="hud-group-row">
          <div class="hud-group" id="hud-group">‡∏´‡∏°‡∏π‡πà ?</div>
          <div class="hud-timer" id="hud-time">90</div>
        </div>

        <div class="power-wrap">
          <div class="power-label">
            <div>POWER</div>
            <div id="fg-powerText" style="font-weight:1000;opacity:.92">0/0</div>
          </div>
          <div class="power-bar"><div class="power-fill" id="hud-powerFill"></div></div>
        </div>

        <div class="quest-wrap">
          <div class="quest-line">
            <div class="q-badge">GOAL</div>
            <div class="q-text" id="hud-goal-title">‚Äî</div>
            <div class="q-num" id="hud-goal-val">0/0</div>
          </div>
          <div class="qbar"><div class="qbar-track"><div class="qbar-fill goal" id="hud-goal-bar"></div></div></div>

          <div class="quest-line" id="hud-mini-line">
            <div class="q-badge mini">MINI</div>
            <div class="q-text" id="hud-mini-title">‚Äî</div>
            <div class="q-num" id="hud-mini-val">0/0</div>
          </div>
          <div class="qbar">
            <div class="qbar-track"><div class="qbar-fill mini" id="hud-mini-bar"></div></div>
            <div class="qbar-timer" id="hud-mini-timer"></div>
          </div>
        </div>
      </div>

      <div class="hud-card hud-right">
        <div class="rank-box">
          <div>
            <div class="rank-title">RANK</div>
            <div class="rank-sub"><span>ACC</span><span id="hud-acc">0%</span></div>
          </div>
          <div class="rank-grade" id="hud-rank">C</div>
        </div>
        <div class="rank-sub"><span>BEST</span><span id="hud-comboMax">0</span></div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="coach-bubble" id="coachBubble">
        <div class="coach-avatar" id="coachFace">ü•¶</div>
        <div>
          <div class="coach-text" id="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!</div>
          <div class="coach-sub" id="coachSub">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡∏´‡∏•‡∏≠‡∏Å üòà</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div class="start-overlay" id="startOverlay">
    <div class="start-card">
      <div class="start-title">Food Groups VR üçΩÔ∏è (‡πÇ‡∏´‡∏î+++)</div>
      <div class="start-sub">
        ‚úÖ ‡∏¢‡∏¥‡∏á ‚Äú‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‚Äù = ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°/‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/‡∏ä‡∏≤‡∏£‡πå‡∏à POWER<br/>
        ‚ùå ‡∏¢‡∏¥‡∏á ‚Äú‡∏ú‡∏¥‡∏î‡∏´‡∏°‡∏π‡πà‚Äù (‡∏™‡∏µ‡∏ü‡πâ‡∏≤) = ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö + MISS (‡∏´‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô!)<br/>
        ‚ò†Ô∏è ‡∏Ç‡∏¢‡∏∞ = STUN / ‚ùì decoy = ‡∏´‡∏•‡∏≠‡∏Å‡πÅ‡∏£‡∏á / üëπ boss = ‡∏´‡∏•‡∏≤‡∏¢‡∏Æ‡∏¥‡∏ï
      </div>

      <div class="start-grid">
        <div class="pill" id="pill-diff">DIFF: normal</div>
        <div class="pill" id="pill-time">TIME: 90s</div>
        <div class="pill" id="pill-mode">MODE: play</div>
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn ghost" id="btnRestart">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
      </div>

      <div class="start-note">
        Tip: ‡πÅ‡∏ï‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ = auto-lock / boss ‡∏ï‡πâ‡∏≠‡∏á‡∏Æ‡∏¥‡∏ï‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>
    </div>
  </div>

  <!-- End Overlay -->
  <div class="result-overlay" id="endOverlay">
    <div class="result-card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî Food Groups VR</h2>
      <p>Score: <b id="endScore">0</b> ¬∑ Rank: <b id="endRank">C</b> ¬∑ Acc: <b id="endAcc">0%</b></p>
      <p>ComboMax: <b id="endComboMax">0</b> ¬∑ Miss: <b id="endMiss">0</b></p>
      <p>Goals: <b id="endGoals">0/0</b> ¬∑ Minis: <b id="endMinis">0</b></p>
      <hr/>
      <p style="opacity:.9">Tip: ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ ‚Äú‡∏ú‡∏¥‡∏î‡∏´‡∏°‡∏π‡πà‚Äù ‡πÇ‡∏´‡∏î‡∏°‡∏≤‡∏Å‚Äî‡∏°‡∏≠‡∏á HUD ‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á!</p>
      <div class="result-actions">
        <button class="btn primary" id="btnRetry">RETRY</button>
        <button class="btn ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== Scripts (classic) ===== -->
  <script src="../vr/ui-fever.js"></script>
  <script src="./groups-fx.js"></script>
  <script src="./groups-hud-quest.js"></script>
  <script src="./groups-quests.js"></script>
  <script src="./GameEngine.js"></script>

  <!-- Boot -->
  <script>
  (function(){
    'use strict';

    function qs(name, def){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? def;
    }
    function int(name, def){
      const v = parseInt(qs(name, def), 10);
      return Number.isFinite(v) ? v : def;
    }
    function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

    const diff = String(qs('diff','normal')).toLowerCase();
    const time = clamp(int('time', 90), 30, 180);
    const run  = String(qs('run', qs('runMode','play'))).toLowerCase();
    const hub  = String(qs('hub','../hub.html') || '../hub.html');

    // deterministic seed: sessionId/studentKey + ts
    const sid = String(qs('sessionId', qs('studentKey','')) || '');
    const ts  = String(qs('ts', Date.now()));
    const seed = String(qs('seed', sid ? (sid + '|' + ts) : ts));

    // pills
    document.getElementById('pill-diff').textContent = 'DIFF: ' + diff;
    document.getElementById('pill-time').textContent = 'TIME: ' + time + 's';
    document.getElementById('pill-mode').textContent = 'MODE: ' + run;

    // start controls
    const overlay = document.getElementById('startOverlay');
    const btnStart = document.getElementById('btnStart');
    const btnRestart = document.getElementById('btnRestart');

    function boot(){
      const engine = window.GroupsVR && window.GroupsVR.GameEngine;
      if (!engine){
        alert('GroupsVR.GameEngine not found');
        return;
      }
      engine.setLayerEl(document.getElementById('fg-layer'));
      engine.setTimeLeft(time);
      engine.start(diff, { runMode: run, seed: seed });
      try{ window.dispatchEvent(new CustomEvent('hha:log_session', { detail: { phase:'start', game:'groups', diff, runMode:run, seed, time } })); }catch{}
    }

    btnStart.addEventListener('click', ()=>{
      overlay.style.display = 'none';
      boot();
    }, { passive:true });

    btnRestart.addEventListener('click', ()=> location.reload(), { passive:true });

    // End overlay wiring
    const endOverlay = document.getElementById('endOverlay');
    const btnRetry = document.getElementById('btnRetry');
    const btnBack = document.getElementById('btnBackHub');

    btnRetry.addEventListener('click', ()=> location.reload(), { passive:true });
    btnBack.addEventListener('click', ()=>{
      try{
        const u = new URL(hub, location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }catch{
        location.href = hub;
      }
    }, { passive:true });

    // Show coach bubble always
    const coachBubble = document.getElementById('coachBubble');
    if (coachBubble) coachBubble.classList.add('show');

    // end summary listener (HHA standard-ish)
    window.addEventListener('hha:end', (ev)=>{
      const d = ev.detail || {};
      try{
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(d || {}));
        localStorage.setItem('hha_last_summary', JSON.stringify(d || {}));
      }catch{}

      const s = document.getElementById('endScore'); if (s) s.textContent = String(d.scoreFinal ?? 0);
      const r = document.getElementById('endRank'); if (r) r.textContent = String(d.grade ?? 'C');
      const a = document.getElementById('endAcc');  if (a) a.textContent = String((d.accuracyGoodPct ?? 0) | 0) + '%';
      const cm= document.getElementById('endComboMax'); if (cm) cm.textContent = String(d.comboMax ?? 0);
      const ms= document.getElementById('endMiss'); if (ms) ms.textContent = String(d.misses ?? 0);
      const gl= document.getElementById('endGoals'); if (gl) gl.textContent = String(d.goalsCleared ?? 0) + '/' + String(d.goalsTotal ?? 0);
      const mn= document.getElementById('endMinis'); if (mn) mn.textContent = String(d.miniCleared ?? 0) + '/' + String(d.miniTotal ?? 0);

      if (endOverlay) endOverlay.classList.add('show');
      try{ window.dispatchEvent(new CustomEvent('hha:log_session', { detail: { phase:'end', ...d } })); }catch{}
    }, { passive:true });

    // auto start if ?autostart=1
    if (qs('autostart','0') === '1'){
      overlay.style.display = 'none';
      boot();
    }
  })();
  </script>
</body>
</html>