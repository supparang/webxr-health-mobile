<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />
  <link rel="stylesheet" href="./groups-vr.css?v=1" />

  <!-- ‚úÖ Universal VR UI (ENTER VR / EXIT / RECENTER + crosshair + tap-to-shoot => hha:shoot) -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- optional FX/logger (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
</head>

<body class="view-pc">
  <!-- HUD (TOP minimal) -->
  <div class="hud-top">
    <div class="hud-card hud-left">
      <div class="hud-row"><span class="hud-title">SCORE</span><span class="hud-val" id="uiScore">0</span></div>
      <div class="hud-row"><span class="hud-title">COMBO</span><span class="hud-val"><span id="uiCombo">0</span> <span style="opacity:.65">MAX</span> <span id="uiComboMax">0</span></span></div>
      <div class="hud-row"><span class="hud-title">MISS</span><span class="hud-val" id="uiMiss">0</span></div>
    </div>

    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div class="hud-group" id="uiGroup">‡∏´‡∏°‡∏π‡πà 1</div>
        <div class="hud-timer"><span id="uiTime">90</span>s</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <span>POWER</span>
          <span><b id="uiPower">0</b>/<b id="uiPowerThr">8</b></span>
        </div>
        <div class="power-bar"><div class="power-fill" id="uiPowerBar"></div></div>
      </div>
    </div>

    <div class="hud-card hud-right">
      <div class="rank-box">
        <div>
          <div class="rank-title">GRADE</div>
          <div class="rank-sub"><span>ACC</span><span id="uiAcc">0%</span></div>
        </div>
        <div class="rank-grade" id="uiGrade">C</div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Goal/Mini RIGHT (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) -->
  <div class="quest-right" aria-label="Quest">
    <div class="qcard">
      <div class="qhead">
        <span class="q-badge">GOAL</span>
        <span class="q-num"><span id="uiGoalNow">0</span>/<span id="uiGoalTotal">1</span></span>
      </div>
      <div class="q-text" id="uiGoalTitle">‚Äî</div>
      <div class="qbar-track"><div class="qbar-fill goal" id="uiGoalBar"></div></div>
    </div>

    <div class="qcard" id="hud-mini-line">
      <div class="qhead">
        <span class="q-badge mini">MINI</span>
        <span class="q-num"><span id="uiMiniNow">0</span>/<span id="uiMiniTotal">1</span></span>
      </div>
      <div class="q-text" id="uiMiniTitle">‚Äî</div>
      <div class="qbar-track"><div class="qbar-fill mini" id="uiMiniBar"></div></div>
      <div class="qbar-timer" id="uiMiniTime" style="display:none;">‚è≥ 0s</div>
    </div>
  </div>

  <!-- ‚úÖ Gameplay Layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- ‚úÖ Coach BOTTOM-RIGHT -->
  <div class="coach-br" aria-label="Coach">
    <div class="coachCard">
      <div class="coachLine" id="uiCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! üéµ</div>
      <div class="feverMini"><i id="uiFeverBar"></i></div>
      <div class="shieldTag" id="uiShieldTag" style="display:none;">üõ°Ô∏è SHIELD READY</div>
    </div>
    <div class="coachImg">
      <img id="uiCoachImg" src="../img/coach-neutral.png" alt="Coach"/>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="start-overlay" id="startOverlay">
    <div class="start-card">
      <h2 class="start-title">üöÄ Food Groups VR</h2>
      <p class="start-sub" id="startDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>

      <div class="start-grid">
        <span class="pill">PC / Mobile / VR Cardboard ‚úÖ</span>
        <span class="pill">Tap-to-shoot (Cardboard) ‚úÖ</span>
        <span class="pill">Goal+Mini+Boss+Storm ‚úÖ</span>
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStart">Start</button>
        <button class="btn ghost" id="btnBack">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="start-note">Tip: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô Cardboard ‡πÉ‡∏´‡πâ‡∏Å‡∏î ENTER VR ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≠‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ üéØ</div>
    </div>
  </div>

  <!-- End overlay -->
  <div class="result-overlay" id="endOverlay">
    <div class="result-card">
      <h2 class="start-title">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p class="start-sub" id="endReason">‚Äî</p>

      <div class="kv">
        <div class="k">SCORE<b id="endScore">0</b></div>
        <div class="k">GRADE<b id="endGrade">C</b></div>
        <div class="k">ACCURACY<b id="endAcc">0%</b></div>
        <div class="k">COMBO MAX<b id="endComboMax">0</b></div>
      </div>

      <div class="result-actions">
        <button class="btn primary" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn ghost" id="btnHub2">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);

    const runMode = (q.get('runMode') || 'play').toLowerCase();
    const diff    = (q.get('diff') || 'normal').toLowerCase();
    const style   = (q.get('style') || 'mix').toLowerCase();
    const time    = Number(q.get('time') || 90);
    const seed    = (q.get('seed') || '').trim() || String(Date.now());
    const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
    const autostart = q.get('autostart') === '1';
    const v = (q.get('v') || String(Date.now()));

    // view mode auto
    (function setView(){
      const ua = navigator.userAgent || '';
      const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
      document.body.classList.toggle('view-mobile', !!isMobile);
      document.body.classList.toggle('view-pc', !isMobile);
    })();

    $('startDesc').textContent = `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed}`;

    async function safeImport(path){
      try{
        await import(path + (path.includes('?') ? '' : ('?v='+encodeURIComponent(v))));
        return true;
      }catch(e){
        console.warn(e);
        return false;
      }
    }

    const BOOT_LIST = [
      './groups-fx.js',
      './audio.js',
      './groups-quests.js',
      './GameEngine.js',
    ];

    async function boot(){
      for (const p of BOOT_LIST) await safeImport(p);
    }

    function flushHardened(reason){
      try{ window.HHACloudLogger?.flushHardened?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushNow?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flushNow?.({ reason }); }catch{}
    }

    function goHub(){
      flushHardened('go_hub');
      location.href = hub;
    }
    $('btnBack').addEventListener('click', goHub);
    $('btnHub2').addEventListener('click', goHub);

    addEventListener('pagehide', ()=>flushHardened('pagehide'));
    addEventListener('beforeunload', ()=>flushHardened('beforeunload'));
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'hidden') flushHardened('hidden');
    });

    function bindEvents(){
      addEventListener('hha:score', (e)=>{
        const d = e.detail||{};
        $('uiScore').textContent = String(d.score ?? 0);
        $('uiCombo').textContent = String(d.combo ?? 0);
        $('uiComboMax').textContent = String(d.comboMax ?? 0);
        $('uiMiss').textContent = String(d.misses ?? 0);

        // accuracy from rank event, but keep fallback
        const hitAll = Number(d.hitAll||0);
        const hitGood= Number(d.hitGood||0);
        if (hitAll>0) $('uiAcc').textContent = Math.round((hitGood/hitAll)*100)+'%';
      });

      addEventListener('hha:time', (e)=>{
        const d = e.detail||{};
        $('uiTime').textContent = String(d.left ?? 0);
      });

      addEventListener('groups:power', (e)=>{
        const d = e.detail||{};
        const ch = Number(d.charge||0);
        const thr = Math.max(1, Number(d.threshold||8));
        $('uiPower').textContent = String(ch);
        $('uiPowerThr').textContent = String(thr);
        $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
      });

      addEventListener('hha:rank', (e)=>{
        const d = e.detail||{};
        if (d.grade) $('uiGrade').textContent = String(d.grade);
        if (d.accuracy != null) $('uiAcc').textContent = String(d.accuracy) + '%';
      });

      addEventListener('quest:update', (e)=>{
        const d = e.detail||{};
        if (d.goalTitle != null) $('uiGoalTitle').textContent = String(d.goalTitle);
        if (d.miniTitle != null) $('uiMiniTitle').textContent = String(d.miniTitle);

        $('uiGoalNow').textContent = String(d.goalNow ?? 0);
        $('uiGoalTotal').textContent = String(d.goalTotal ?? 1);
        $('uiMiniNow').textContent = String(d.miniNow ?? 0);
        $('uiMiniTotal').textContent = String(d.miniTotal ?? 1);

        const gp = Number(d.goalPct ?? 0);
        const mp = Number(d.miniPct ?? 0);
        $('uiGoalBar').style.width = Math.max(0, Math.min(100, gp)).toFixed(1)+'%';
        $('uiMiniBar').style.width = Math.max(0, Math.min(100, mp)).toFixed(1)+'%';

        const tLeft = Number(d.miniTimeLeftSec ?? 0);
        const timeEl = $('uiMiniTime');
        const urgent = (tLeft>0 && tLeft<=3);
        $('hud-mini-line').classList.toggle('mini-urgent', urgent);

        if (tLeft > 0){
          timeEl.style.display = 'block';
          timeEl.textContent = `‚è≥ ${tLeft}s`;
        } else {
          timeEl.style.display = 'none';
        }
      });

      addEventListener('hha:coach', (e)=>{
        const d = e.detail||{};
        if (d.text) $('uiCoachLine').textContent = String(d.text);
        const mood = String(d.mood||'neutral');
        const img = (mood==='happy') ? '../img/coach-happy.png'
                 : (mood==='sad')   ? '../img/coach-sad.png'
                 : (mood==='fever') ? '../img/coach-fever.png'
                 : '../img/coach-neutral.png';
        $('uiCoachImg').src = img;
      });

      addEventListener('hha:fever', (e)=>{
        const d = e.detail||{};
        const pct = Math.max(0, Math.min(100, Number(d.feverPct||0)));
        $('uiFeverBar').style.width = pct.toFixed(1)+'%';
        const shield = Number(d.shield||0) > 0;
        $('uiShieldTag').style.display = shield ? 'inline-flex' : 'none';
      });

      addEventListener('hha:end', (e)=>{
        const d = e.detail||{};
        $('endOverlay').classList.add('show');
        $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
        $('endScore').textContent = String(d.scoreFinal ?? 0);
        $('endGrade').textContent = String(d.grade ?? 'C');
        $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
        $('endComboMax').textContent = String(d.comboMax ?? 0);
        $('uiGrade').textContent = String(d.grade ?? 'C');

        try{
          const payload = {
            game: 'GroupsVR',
            ts: new Date().toISOString(),
            ...d,
            params: { runMode, diff, style, time, seed, hub }
          };
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
          localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));
        }catch{}

        flushHardened('end');
      });
    }

    function waitEngineReady(){
      return new Promise((resolve)=>{
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;
          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            resolve(GE);
          }
          if (tries > 250){
            clearInterval(t);
            resolve(null);
          }
        }, 80);
      });
    }

    async function startGame(){
      $('btnStart').disabled = true;

      await boot();
      const GE = await waitEngineReady();
      if (!GE){ $('btnStart').disabled = false; return; }

      GE.setLayerEl($('fg-layer'));
      GE.start(diff, { runMode, style, time, seed });

      $('startOverlay').style.display = 'none';
      $('endOverlay').classList.remove('show');
      $('btnStart').disabled = false;
    }

    $('btnStart').addEventListener('click', startGame);
    $('btnReplay').addEventListener('click', ()=>{
      try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
      $('endOverlay').classList.remove('show');
      $('startOverlay').style.display = 'flex';
      if (autostart) setTimeout(startGame, 250);
    });

    bindEvents();
    await boot();
    if (autostart) setTimeout(startGame, 300);
  </script>
</body>
</html>