<!-- === A: /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run (PC/Mobile/Cardboard)
‚úÖ Uses: groups.safe.js (B) + groups-vr.boot.js (C) + groups-vr.css (D)
‚úÖ Universal VR UI: ../vr/vr-ui.js (EnterVR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot)
‚úÖ PACK 13: Calibration overlay (cVR)
‚úÖ PACK 14: Practice 15s (cVR) then real (handled in A via hha:end practice OR optional in B)
‚úÖ PACK 15: AI hooks attach point (disabled by default; play only with ?ai=1)  (attach is in A)
‚úÖ Flush-hardened logging + research ctx passthrough
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame minimal XR scene for Enter VR reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script>
    // tune crosshair lock a bit larger for kids/mobile
    window.HHA_VRUI_CONFIG = { lockPx: 92, cooldownMs: 90 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./ai-hooks.js" defer></script>         <!-- PACK 15 (stub/safe) -->
  <script src="./effects-pack.js" defer></script>     <!-- optional FX pack -->
  <script src="./research-ctx.js" defer></script>
  <script src="./flush-log.js" defer></script>
  <script src="./view-helper.js" defer></script>

  <!-- ‚úÖ Engine (B) -->
  <script src="./groups.safe.js" defer></script>

  <!-- ‚úÖ Boot (C): detect view + tap-to-start + start engine once -->
  <script src="./groups-vr.boot.js" defer></script>
</head>

<body class="view-mobile">
  <!-- XR Scene behind DOM -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled:false" renderer="colorManagement:true">
    <a-entity position="0 1.6 0"><a-camera></a-camera></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span id="vTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span id="vScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span id="vCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span id="vMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÖ RANK</span><span id="vRank" class="val">C</span></div>
      <div class="pill"><span class="lbl">üéØ ACC</span><span id="vAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">üß™ MODE</span><span id="vMode" class="val">PLAY</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">GOAL</div>
        <div class="tag" id="goalCount">0/1</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag"><span class="miniTime" id="miniTime">‚Äî</span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div id="pFill" class="fill"></div></div>
      <div class="pFoot"><span id="pCur">0</span>/<span id="pThr">8</span> ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">ü•¶ Coach</div>
        <div id="coachText" class="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Play Layer -->
  <div id="playLayer" class="playLayer"></div>

  <!-- PACK 13: Calibration overlay (cVR only; A shows/hides; logic listens to hha:shoot etc.) -->
  <div id="calOverlay" class="overlay overlay-cal hidden">
    <div class="panel calPanel">
      <div class="title">üß≠ Calibration (Cardboard)</div>
      <div id="calSub" class="sub">
        Step 1/2: ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div class="stat">
          <div class="k">Step</div>
          <div id="calStep" class="v">1/2</div>
        </div>
        <div class="stat">
          <div class="k">Shots</div>
          <div id="calShots" class="v">0/3</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnCalNext" class="btn btn-strong" type="button">‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
        <button id="btnCalSkip" class="btn btn-ghost" type="button">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</button>
      </div>

      <div class="note" style="margin-top:10px;">
        cVR: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡πÉ‡∏ä‡πâ RECENTER ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopy" class="btn" type="button">üìã Copy JSON</button>
      </div>
      <div class="row row2">
        <button id="btnBackLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
        <button id="btnHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        Cardboard (cVR): ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ENTER VR/RECENTER ‡∏≠‡∏¢‡∏π‡πà UI ‡∏Ç‡∏≠‡∏á vr-ui.js
      </div>
    </div>
  </div>

  <!-- UI Wiring (events + overlays + summary posting) -->
  <script>
  (function(){
    'use strict';
    const DOC = document;
    const $ = (id)=>DOC.getElementById(id);

    function qs(k, def=null){
      try { return new URL(location.href).searchParams.get(k) ?? def; }
      catch { return def; }
    }
    function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

    async function copyText(text){
      try { await navigator.clipboard.writeText(String(text||'')); return true; }
      catch {
        try{
          const ta = DOC.createElement('textarea');
          ta.value = String(text||'');
          DOC.body.appendChild(ta);
          ta.select();
          DOC.execCommand('copy');
          ta.remove();
          return true;
        }catch{ return false; }
      }
    }

    // ---------- HUD binds ----------
    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail||{};
      $('vScore').textContent = String(d.score ?? 0);
      $('vCombo').textContent = String(d.combo ?? 0);
      $('vMiss').textContent  = String(d.misses ?? 0);
    }, {passive:true});

    window.addEventListener('hha:time', (ev)=>{
      const d = ev.detail||{};
      $('vTime').textContent = String(Math.max(0, Math.round(d.left ?? 0)));
    }, {passive:true});

    window.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail||{};
      $('vRank').textContent = String(d.grade ?? 'C');
      $('vAcc').textContent  = String((d.accuracy ?? 0) + '%');
    }, {passive:true});

    window.addEventListener('hha:coach', (ev)=>{
      const d = ev.detail||{};
      $('coachText').textContent = String(d.text||'');
      const mood = String(d.mood||'neutral');
      const img =
        (mood==='happy') ? '../img/coach-happy.png' :
        (mood==='sad')   ? '../img/coach-sad.png' :
        (mood==='fever') ? '../img/coach-fever.png' :
                          '../img/coach-neutral.png';
      $('coachImg').src = img;
    }, {passive:true});

    window.addEventListener('groups:power', (ev)=>{
      const d = ev.detail||{};
      const cur = Number(d.charge||0);
      const thr = Math.max(1, Number(d.threshold||8));
      $('pCur').textContent = String(cur|0);
      $('pThr').textContent = String(thr|0);
      $('pFill').style.width = Math.round((cur/thr)*100) + '%';
    }, {passive:true});

    window.addEventListener('quest:update', (ev)=>{
      const d = ev.detail||{};
      const gTitle = String(d.goalTitle||'‚Äî');
      const gNow   = Number(d.goalNow||0);
      const gTot   = Math.max(1, Number(d.goalTotal||1));
      const gPct   = clamp(d.goalPct ?? (gNow/gTot*100), 0, 100);

      const mTitle = String(d.miniTitle||'‚Äî');
      const mNow   = Number(d.miniNow||0);
      const mTot   = Math.max(1, Number(d.miniTotal||1));
      const mPct   = clamp(d.miniPct ?? (mNow/mTot*100), 0, 100);
      const mLeft  = Number(d.miniTimeLeftSec||0);

      $('goalTitle').textContent = 'üéØ GOAL';
      $('goalCount').textContent = `${gNow}/${gTot}`;
      $('goalFill').style.width = Math.round(gPct) + '%';
      $('goalSub').textContent = gTitle;

      $('miniTitle').textContent = '‚ö° MINI';
      $('miniFill').style.width = Math.round(mPct) + '%';
      $('miniSub').textContent = mTitle;
      $('miniTime').textContent = (mLeft>0) ? `${mLeft}s` : '‚Äî';

      const urgent = (mLeft>0 && mLeft<=3);
      DOC.body.classList.toggle('mini-urgent', urgent);
    }, {passive:true});

    // ---------- Audio hooks ----------
    function hookAudio(){
      const A = window.GroupsVR && window.GroupsVR.Audio;
      if (!A) return;

      try{ A.unlock && A.unlock(); }catch{}

      window.addEventListener('hha:judge', (ev)=>{
        const d = ev.detail||{};
        const k = String(d.kind||'').toLowerCase();
        if (k==='good') A.good();
        else if (k==='bad') A.bad();
        else if (k==='boss') A.boss();
        else if (k==='miss') A.bad();
      }, {passive:true});

      window.addEventListener('groups:progress', (ev)=>{
        const d = ev.detail||{};
        const kind = String(d.kind||'');
        if (kind==='storm_on') A.storm();
        if (kind==='boss_spawn') A.boss();
        if (kind==='perfect_switch') A.good();
      }, {passive:true});
    }
    hookAudio();

    // ---------- Summary / History / Logger ----------
    const LS_LAST = 'HHA_LAST_SUMMARY';
    const LS_HIST = 'HHA_SUMMARY_HISTORY';

    let lastSummary = null;
    let startIso = new Date().toISOString();

    function saveLast(summary){
      try{ localStorage.setItem(LS_LAST, JSON.stringify(summary)); }catch{}
      try{
        const hist = JSON.parse(localStorage.getItem(LS_HIST)||'[]');
        hist.unshift(summary);
        localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 50)));
      }catch{}
    }

    function buildBaseSummary(d, endIso){
      const ctx = (window.GroupsVR && window.GroupsVR.getResearchCtx) ? window.GroupsVR.getResearchCtx() : {};
      return Object.assign({
        timestampIso: endIso,
        projectTag: 'HeroHealth',
        gameTag: 'GroupsVR',
        runMode: String(qs('run','play')||'play'),
        diff: String(qs('diff','normal')||'normal'),
        style: String(qs('style','mix')||'mix'),
        view: String(qs('view','mobile')||'mobile'),
        durationPlannedSec: Number(qs('time',90)||90),
        startTimeIso: startIso,
        endTimeIso: endIso,
        seed: String(qs('seed','')||'')
      }, ctx, d||{});
    }

    function postNow(summary){
      try{
        const P = window.GroupsVR && window.GroupsVR.postSummary;
        P && P(summary);
      }catch(_){}
    }

    // flush-hardened
    try{
      const B = window.GroupsVR && window.GroupsVR.bindFlushOnLeave;
      B && B(()=>lastSummary);
    }catch(_){}

    // ---------- End event ----------
    window.addEventListener('hha:end', (ev)=>{
      const d = ev.detail||{};
      const endIso = new Date().toISOString();

      lastSummary = buildBaseSummary(d, endIso);
      saveLast(lastSummary);
      postNow(lastSummary);

      $('endOverlay').classList.remove('hidden');
      $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');
      $('endScore').textContent = String(d.scoreFinal ?? 0);
      $('endRank').textContent  = String(d.grade ?? 'C');
      $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
      $('endMiss').textContent  = String(d.misses ?? 0);

      const hub = String(qs('hub','')||'');
      $('btnHub').style.display = hub ? 'inline-flex' : 'none';
    }, {passive:true});

    $('btnRestart').addEventListener('click', ()=> location.reload());

    $('btnCopy').addEventListener('click', async ()=>{
      if (!lastSummary){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
      const ok = await copyText(JSON.stringify(lastSummary, null, 2));
      alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    });

    $('btnBackLauncher').addEventListener('click', ()=>{
      const hub = String(qs('hub','')||'');
      const u = new URL('../groups-vr.html', location.href);
      if (hub) u.searchParams.set('hub', hub);

      const log = String(qs('log','')||'');
      if (log) u.searchParams.set('log', log);

      const sp = new URL(location.href).searchParams;
      sp.forEach((v,k)=>{
        if (['view','run','diff','style','time','seed','practice','ai','autostart'].includes(k)) return;
        if (k==='hub' || k==='log') return;
        u.searchParams.set(k,v);
      });

      location.href = u.toString();
    });

    $('btnHub').addEventListener('click', ()=>{
      const hub = String(qs('hub','')||'');
      if (!hub){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå hub=...'); return; }
      location.href = hub;
    });

    // ---------- PACK 15: AI attach point (SAFE) ----------
    // (AI is disabled by default in research; enable with ?ai=1 in play)
    (function tryAttachAI(){
      try{
        const run = String(qs('run','play')||'play').toLowerCase();
        if (run === 'research') return; // ‚úÖ hard off
        const on = String(qs('ai','0')||'0');
        const enabled = (on === '1' || on === 'true');
        const seed = String(qs('seed', Date.now()) || Date.now());

        const AI = window.GroupsVR && window.GroupsVR.AIHooks;
        if (AI && AI.attach){
          AI.attach({ runMode: run, seed, enabled });
        }
      }catch(_){}
    })();

  })();
  </script>
</body>
</html>