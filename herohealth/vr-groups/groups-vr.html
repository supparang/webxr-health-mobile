<!-- === A: /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî RUN (PRODUCTION)
‚úÖ Loads D: ./groups-vr.css
‚úÖ Loads B: ./groups.safe.js (window.GroupsVR.GameEngine)
‚úÖ Auto add Universal VR UI: ../vr/vr-ui.js (EnterVR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot)
‚úÖ Tap-to-start overlay (only if needed) to satisfy mobile gesture policy
‚úÖ Mount playLayer (#fg-layer) and HUD/Quest/Coach/Power/End overlay
‚úÖ Listens: hha:score, hha:time, hha:rank, hha:coach, quest:update, groups:power, hha:end
‚úÖ Starts engine with query: view/run/diff/time/style/seed/ai + passthrough research fields
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- D -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame scene behind (optional but helps Enter VR reliability) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>

<body class="view-mobile">
  <!-- XR Scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="antialias: true; colorManagement: true;"
           background="color: #050816">
    <a-entity position="0 1.6 0"></a-entity>
    <a-sky color="#050816"></a-sky>
    <a-camera position="0 1.6 0" look-controls="enabled:true"></a-camera>
  </a-scene>

  <!-- Play layer (DOM targets live here) -->
  <div class="playLayer" id="fg-layer" aria-label="play layer"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">SCORE</span> <span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span> <span class="val" id="hudCombo">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">MISS</span> <span class="val" id="hudMiss">0</span></div>
      <div class="pill"><span class="lbl">TIME</span> <span class="val" id="hudTime">0</span></div>
      <div class="pill"><span class="lbl">RANK</span> <span class="val" id="hudRank">C</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="goalTitle">‚Äî</span>
        <span class="tag" id="goalTag">GOAL</span>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>
    <div class="questCard">
      <div class="qTitle">
        <span id="miniTitle">‚Äî</span>
        <span class="tag" id="miniTag">MINI</span>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">POWER</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerSub">0 / 0</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" alt="coach" src="../img/coach-neutral.png" />
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢ üéØ</div>
      </div>
    </div>
  </div>

  <!-- Tap-to-start overlay (only show if required) -->
  <div class="overlay" id="tapOverlay">
    <div class="panel">
      <div class="title">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
      <div class="sub" id="tapSub">
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á/Fullscreen/VR ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>

      <div class="grid2">
        <div class="stat"><div class="k">MODE</div><div class="v" id="stMode">PLAY</div></div>
        <div class="stat"><div class="k">DIFF</div><div class="v" id="stDiff">EASY</div></div>
        <div class="stat"><div class="k">TIME</div><div class="v" id="stTime">90</div></div>
        <div class="stat"><div class="k">VIEW</div><div class="v" id="stView">MOBILE</div></div>
      </div>

      <div class="row">
        <button class="btn btn-strong" id="btnTapStart" type="button">‚ñ∂ TAP TO START</button>
        <button class="btn btn-ghost" id="btnBackHub" type="button">‚§∫ ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" id="tapNote">Tip: ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î cVR ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠</div>
    </div>
  </div>

  <!-- End overlay -->
  <div class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß!</div>
      <div class="sub" id="endSub">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>

      <div class="grid2">
        <div class="stat"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">RANK</div><div class="v" id="endRank">C</div></div>
        <div class="stat"><div class="k">ACC</div><div class="v" id="endAcc">0%</div></div>
        <div class="stat"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
      </div>

      <div class="row row2">
        <button class="btn btn-strong" id="btnReplay" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn" id="btnToHub" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" id="endNote">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HHA_LAST_SUMMARY</div>
    </div>
  </div>

  <!-- Universal VR UI -->
  <script src="../vr/vr-ui.js"></script>

  <!-- B -->
  <script src="./groups.safe.js"></script>

  <script>
  (function(){
    'use strict';

    const DOC = document;
    const WIN = window;

    const $ = (id)=>DOC.getElementById(id);
    const qs = (k, def=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? def; }catch(_){ return def; } };
    const clamp=(v,a,b)=>{ v=Number(v)||0; return v<a?a:(v>b?b:v); };

    // ---------- view class ----------
    function setViewClass(view){
      const b = DOC.body;
      b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      view = String(view||'mobile').toLowerCase();
      if (view.includes('cvr')) b.classList.add('view-cvr');
      else if (view.includes('vr')) b.classList.add('view-vr');
      else if (view.includes('pc')) b.classList.add('view-pc');
      else b.classList.add('view-mobile');
      return view.includes('cvr') ? 'cvr' : (view.includes('vr') ? 'vr' : (view.includes('pc') ? 'pc' : 'mobile'));
    }

    // ---------- unlock chain ----------
    function tryUnlockAudio(){
      try{
        const a = DOC.createElement('audio');
        a.src = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA';
        a.volume = 0;
        a.play().then(()=>{ try{ a.pause(); }catch(_){} }).catch(()=>{});
      }catch(_){}
      try{
        const AC = WIN.AudioContext || WIN.webkitAudioContext;
        if (AC){
          const ctx = new AC();
          ctx.resume && ctx.resume().catch(()=>{});
        }
      }catch(_){}
    }

    async function tryFullscreen(){
      try{
        if (!DOC.documentElement.requestFullscreen) return false;
        await DOC.documentElement.requestFullscreen({ navigationUI: 'hide' });
        return true;
      }catch(_){ return false; }
    }
    async function tryLandscapeLock(){
      try{
        if (!screen.orientation || !screen.orientation.lock) return false;
        await screen.orientation.lock('landscape');
        return true;
      }catch(_){ return false; }
    }

    // ---------- hub helpers ----------
    function goHub(){
      const hub = String(qs('hub','')||'').trim();
      if (hub) location.href = hub;
      else history.back();
    }

    // ---------- tap overlay policy ----------
    // show if mobile or cvr/vr OR if query tap=1
    function shouldShowTapOverlay(view){
      const force = String(qs('tap','')||'').toLowerCase();
      if (force==='1' || force==='true') return true;
      const isTouch = ('ontouchstart' in WIN) || (navigator.maxTouchPoints>0);
      return isTouch || view==='cvr' || view==='vr';
    }

    // ---------- start engine ----------
    function startEngine(){
      const eng = WIN.GroupsVR && WIN.GroupsVR.GameEngine;
      if (!eng || !eng.start){
        console.error('GroupsVR engine not found (GroupsVR.GameEngine)');
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö Engine (groups.safe.js) ‚Äî ‡∏ï‡∏£‡∏ß‡∏à path ‡πÑ‡∏ü‡∏•‡πå');
        return;
      }
      const layer = $('fg-layer');
      eng.setLayerEl(layer);

      const view = setViewClass(qs('view','mobile'));

      const run  = String(qs('run','play')||'play').toLowerCase();
      const diff = String(qs('diff','easy')||'easy').toLowerCase();
      const style= String(qs('style','feel')||'feel').toLowerCase();
      const time = clamp(qs('time', 90), 5, 180);
      const seed = String(qs('seed', Date.now())||Date.now());
      const ai   = String(qs('ai','0')||'0');

      // expose stats on tap overlay
      $('stMode').textContent = run.toUpperCase();
      $('stDiff').textContent = diff.toUpperCase();
      $('stTime').textContent = String(time);
      $('stView').textContent = view.toUpperCase();

      // NOTE: AI hooks attach elsewhere; engine reads runMode internally (play/research/practice)
      // We just pass runMode/time/seed/view.
      eng.start(diff, {
        runMode: (run==='research') ? 'research' : (run==='practice' ? 'practice' : 'play'),
        time: time,
        seed: seed,
        view: view,
        style: style,
        ai: (ai==='1'||ai==='true') ? 1 : 0
      });
    }

    // ---------- UI event bindings ----------
    WIN.addEventListener('hha:score', (e)=>{
      const d = e.detail || {};
      $('hudScore').textContent = String(d.score ?? 0);
      $('hudCombo').textContent = String(d.combo ?? 0);
      $('hudMiss').textContent  = String(d.misses ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:time', (e)=>{
      const d = e.detail || {};
      $('hudTime').textContent = String(d.left ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:rank', (e)=>{
      const d = e.detail || {};
      $('hudRank').textContent = String(d.grade ?? 'C');
    }, { passive:true });

    WIN.addEventListener('hha:coach', (e)=>{
      const d = e.detail || {};
      $('coachText').textContent = String(d.text || '');
      const mood = String(d.mood || 'neutral');
      // mood mapping -> your existing coach images
      const map = {
        happy: '../img/coach-happy.png',
        neutral: '../img/coach-neutral.png',
        sad: '../img/coach-sad.png',
        fever: '../img/coach-fever.png'
      };
      $('coachImg').src = map[mood] || map.neutral;
    }, { passive:true });

    WIN.addEventListener('quest:update', (e)=>{
      const d = e.detail || {};
      $('goalTitle').textContent = String(d.goalTitle || '‚Äî');
      $('goalFill').style.width  = String(clamp(d.goalPct ?? 0, 0, 100)) + '%';
      $('goalSub').textContent   = `Progress: ${(d.goalNow ?? 0)} / ${(d.goalTotal ?? 0)} ‚Ä¢ Goal ${(d.goalIndex ?? 0)+1}/${(d.goalsTotal ?? 1)}`;

      $('miniTitle').textContent = String(d.miniTitle || '‚Äî');
      $('miniFill').style.width  = String(clamp(d.miniPct ?? 0, 0, 100)) + '%';

      const tl = Number(d.miniTimeLeftSec ?? 0) || 0;
      $('miniSub').textContent   = (d.miniTitle && d.miniTitle!=='‚Äî')
        ? `Progress: ${(d.miniNow ?? 0)} / ${(d.miniTotal ?? 0)} ‚Ä¢ Time: ${tl}s ‚Ä¢ Cleared ${(d.miniCountCleared ?? 0)}/${(d.miniCountTotal ?? 0)}`
        : `Cleared ${(d.miniCountCleared ?? 0)}/${(d.miniCountTotal ?? 0)}`;

      // mini urgent class
      DOC.body.classList.toggle('mini-urgent', tl>0 && tl<=3);
    }, { passive:true });

    WIN.addEventListener('groups:power', (e)=>{
      const d = e.detail || {};
      const c = Number(d.charge ?? 0) || 0;
      const t = Math.max(1, Number(d.threshold ?? 1) || 1);
      const pct = clamp((c/t)*100, 0, 100);
      $('powerFill').style.width = pct.toFixed(1) + '%';
      $('powerSub').textContent  = `${c} / ${t}`;
    }, { passive:true });

    // end => show end overlay + save last summary
    WIN.addEventListener('hha:end', (e)=>{
      const s = e.detail || {};
      try{ localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(s)); }catch(_){}

      $('endScore').textContent = String(s.scoreFinal ?? 0);
      $('endRank').textContent  = String(s.grade ?? 'C');
      $('endAcc').textContent   = String(s.accuracyGoodPct ?? 0) + '%';
      $('endMiss').textContent  = String(s.misses ?? 0);

      const rm = String(s.runMode || 'play');
      $('endSub').textContent = `‡πÇ‡∏´‡∏°‡∏î: ${rm} ‚Ä¢ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${String(s.reason||'end')}`;
      $('endOverlay').classList.remove('hidden');
    }, { passive:true });

    // buttons
    $('btnBackHub').addEventListener('click', goHub);
    $('btnToHub').addEventListener('click', goHub);
    $('btnReplay').addEventListener('click', ()=>{
      $('endOverlay').classList.add('hidden');
      location.reload();
    });

    // TAP start
    $('btnTapStart').addEventListener('click', async ()=>{
      // gesture chain
      tryUnlockAudio();
      // if mobile -> fullscreen/landscape best-effort
      const view = String(qs('view','mobile')||'mobile').toLowerCase();
      const isTouch = ('ontouchstart' in WIN) || (navigator.maxTouchPoints>0);
      if (isTouch){
        await tryFullscreen();
        if (view.includes('cvr') || view.includes('vr')) await tryLandscapeLock();
      }

      $('tapOverlay').style.display = 'none';
      startEngine();
    });

    // init
    (function init(){
      const view = setViewClass(qs('view','mobile'));

      // If user came via launcher, they already tapped, but still okay:
      // If overlay not needed, start immediately
      if (!shouldShowTapOverlay(view)){
        $('tapOverlay').style.display = 'none';
        startEngine();
      } else {
        // show overlay, but also allow auto-start if "autoplay=1" exists (optional)
        const ap = String(qs('autoplay','')||'').toLowerCase();
        if (ap==='1' || ap==='true'){
          $('tapOverlay').style.display = 'none';
          startEngine();
        }
      }
    })();

  })();
  </script>
</body>
</html>