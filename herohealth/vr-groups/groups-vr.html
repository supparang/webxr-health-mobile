<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- ‚úÖ CSS alias -->
  <link rel="stylesheet" href="./groups.css?v=20251228" />

  <!-- fallback ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ css ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î -->
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#020617;color:#e5e7eb;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
  </style>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Scripts (order matters) -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/ui-fever.js" defer></script>
  <script src="../vr/ui-karaoke.js" defer></script>

  <script src="./groups-hud-quest.js" defer></script>
  <script src="./groups-text.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./groups-fx.js" defer></script>

  <script src="./GameEngine.js" defer></script>
  <script src="./groups.safe.js" defer></script>
</head>

<body>
  <!-- Apply style class early (pure CSS/FX hook) -->
  <script>
    (function(){
      try{
        const sp = new URLSearchParams(location.search);
        const style = String(sp.get('style')||'mix').toLowerCase();
        document.body.classList.add(
          style==='hard' ? 'groups-style-hard' :
          style==='feel' ? 'groups-style-feel' :
          'groups-style-mix'
        );
      }catch{}
    })();
  </script>

  <!-- A-Frame scene (camera id="cam" ‡πÉ‡∏´‡πâ Boot bind) -->
  <a-scene embedded
           vr-mode-ui="enabled:true"
           device-orientation-permission-ui="enabled:true"
           renderer="colorManagement:true;">
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="cam" wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
    </a-entity>
    <a-sky color="#071022"></a-sky>
  </a-scene>

  <!-- DOM target layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups layer"></div>

  <!-- HUD / Quest (ids ‡∏ó‡∏µ‡πà groups-hud-quest.js ‡πÉ‡∏ä‡πâ) -->
  <div class="hha-ui">
    <!-- IDs for groups-hud-quest.js -->
    <div id="hud-goal-title" style="display:none"></div>
    <div id="hud-goal-val" style="display:none"></div>
    <div id="hud-goal-bar" style="display:none"></div>

    <div id="hud-mini-line" style="display:none"></div>
    <div id="hud-mini-title" style="display:none"></div>
    <div id="hud-mini-val" style="display:none"></div>
    <div id="hud-mini-bar" style="display:none"></div>
    <div id="hud-mini-timer" style="display:none"></div>

    <!-- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ HUD ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÉ‡∏ô groups-vr.css ‡πÑ‡∏î‡πâ
         (‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á start/end ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) -->

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay">
      <div class="overlay-card">
        <div class="overlay-title">Food Groups VR üç≠</div>
        <div class="overlay-sub" id="overlaySub">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! (autostart=1 ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á)</div>
        <div class="overlay-btns">
          <button class="btn" id="btnPlay">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° (Play)</button>
          <button class="btn secondary" id="btnResearch">üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏° (Research)</button>
          <button class="btn secondary" id="btnVr">üï∂Ô∏è VR Mode</button>
        </div>
        <div class="overlay-hint" id="overlayHint">Tip: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå / STORM tick</div>
      </div>
    </div>

    <!-- End summary -->
    <div class="end" id="endModal" style="display:none;">
      <div class="end-card">
        <div class="end-title" id="endTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>

        <div class="end-grid">
          <div class="end-item"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="endScore">0</div></div>
          <div class="end-item"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="endCombo">0</div></div>
          <div class="end-item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
          <div class="end-item"><div class="k">Accuracy</div><div class="v" id="endAcc">0%</div></div>
          <div class="end-item"><div class="k">Grade</div><div class="v" id="endGrade">‚Äî</div></div>
          <div class="end-item"><div class="k">Goals</div><div class="v" id="endGoals">0/0</div></div>
          <div class="end-item"><div class="k">Minis</div><div class="v" id="endMinis">0/0</div></div>
        </div>

        <div class="end-btns">
          <a class="btn secondary" id="btnBackHub" href="../hub.html">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö HUB</a>
          <button class="btn" id="btnReplay">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Glue script: wait GroupsBoot ready (‡πÅ‡∏Å‡πâ not ready) -->
  <script>
    (function(){
      'use strict';

      function $(id){ return document.getElementById(id); }

      function qs(){
        try{ return new URLSearchParams(location.search); }
        catch{ return new URLSearchParams(''); }
      }

      function pickDiff(sp){
        const d = String(sp.get('diff')||'normal').toLowerCase();
        return (d==='easy'||d==='normal'||d==='hard') ? d : 'normal';
      }
      function pickTime(sp){
        const t = parseInt(sp.get('time')||'90',10);
        return Number.isFinite(t) ? Math.max(30, Math.min(180, t|0)) : 90;
      }
      function pickSeed(sp){
        const s = String(sp.get('seed')||'').trim();
        return s ? s : String(Date.now());
      }

      function decodeHub(sp){
        const hubEnc = sp.get('hub');
        if (!hubEnc) return '../hub.html';
        try{ return decodeURIComponent(hubEnc); }catch{ return '../hub.html'; }
      }

      function waitBoot(cb){
        let tries = 0;
        const it = setInterval(()=>{
          tries++;
          if (window.GroupsBoot && typeof window.GroupsBoot.start === 'function'){
            clearInterval(it);
            cb();
          }
          if (tries > 80){ clearInterval(it); console.warn('[Run] GroupsBoot not ready'); }
        }, 80);
      }

      function start(mode){
        const sp = qs();
        const runMode = (String(mode||'play').toLowerCase()==='research') ? 'research' : 'play';
        const diff = pickDiff(sp);
        const time = pickTime(sp);
        const seed = pickSeed(sp);

        waitBoot(()=>{
          try{
            window.GroupsBoot.start(runMode, { diff, time, seed });
          }catch(e){
            console.warn('[Run] start failed', e);
          }
        });

        const ov = $('startOverlay');
        if (ov) ov.style.display = 'none';
      }

      window.addEventListener('DOMContentLoaded', ()=>{
        const sp = qs();

        // hub back
        const hubUrl = decodeHub(sp);
        const back = $('btnBackHub');
        if (back) back.href = hubUrl;

        // VR mode
        $('btnVr')?.addEventListener('click', ()=>{
          const scene = document.querySelector('a-scene');
          try{ scene && scene.enterVR && scene.enterVR(); }catch{}
        });

        $('btnPlay')?.addEventListener('click', ()=>start('play'));
        $('btnResearch')?.addEventListener('click', ()=>start('research'));

        // end modal
        window.addEventListener('hha:end', (ev)=>{
          const d = ev && ev.detail ? ev.detail : {};
          const m = $('endModal'); if (m) m.style.display = '';
          $('endTitle').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî ' + (d.reason || 'end');
          $('endScore').textContent = (d.scoreFinal ?? 0);
          $('endCombo').textContent = (d.comboMax ?? 0);
          $('endMiss').textContent = (d.misses ?? 0);
          $('endAcc').textContent = ((d.accuracyGoodPct ?? 0) + '%');
          $('endGrade').textContent = (d.grade ?? '‚Äî');
          $('endGoals').textContent = (d.goalsCleared ?? 0) + '/' + (d.goalsTotal ?? 0);
          $('endMinis').textContent = (d.miniCleared ?? 0) + '/' + (d.miniTotal ?? 0);
        }, { passive:true });

        // replay (cache-bust)
        $('btnReplay')?.addEventListener('click', ()=>{
          const u = new URL(location.href);
          u.searchParams.set('ts', String(Date.now()));
          location.href = u.toString();
        });

        // autostart UX (overlay hide)
        if (String(sp.get('autostart')||'0') === '1'){
          setTimeout(()=>{ if ($('startOverlay')) $('startOverlay').style.display = 'none'; }, 650);
        }
      });
    })();
  </script>
</body>
</html>
