<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run (PC/Mobile/Cardboard)
‚úÖ Uses vr-ui.js + Particles + Effects pack
‚úÖ PACK 13: Calibration helper (cVR) 2-step
‚úÖ PACK 14: Practice 15s (cVR) then auto start real run
‚úÖ PACK 15: AI hooks attach point (disabled by default; play only with ?ai=1)
‚úÖ PACK 13.95: Telemetry (lite/full/off) + throttle + flush-hardened + auto-downgrade by FPS
‚úÖ NEW (1): Big Banner current group + events
‚úÖ NEW (2): DL-lite Predictor + Explainable micro-tips (play only; off in research/practice)
‚úÖ PATCH (BOOT): On-screen Debug HUD + global error trap + dependency status
‚úÖ PATCH (AIM): lockPx tuned (default 118) + URL override ?lockPx=...
‚úÖ Uses groups.safe.js (standalone)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame: minimal scene for WebXR Enter VR reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>

  <!-- ‚úÖ LOCKPX "‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏î" + override ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å URL -->
  <script>
  (function(){
    'use strict';
    const q = new URLSearchParams(location.search);

    // default "‡∏™‡∏∏‡∏î" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/cVR (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ ?lockPx=140)
    const defLock = 118;

    const lp = Number(q.get('lockPx') || defLock);
    const cd = Number(q.get('shootCd') || 90);

    const lockPx = Math.max(24, Math.min(160, isFinite(lp) ? lp : defLock));
    const cooldownMs = Math.max(40, Math.min(200, isFinite(cd) ? cd : 90));

    window.HHA_VRUI_CONFIG = { lockPx, cooldownMs };
  })();
  </script>

  <script src="../vr/vr-ui.js" defer></script>

  <!-- Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./ai-hooks.js" defer></script>
  <script src="./effects-pack.js" defer></script>
  <script src="./research-ctx.js" defer></script>
  <script src="./flush-log.js" defer></script>
  <script src="./view-helper.js" defer></script>

  <!-- ‚úÖ PACK 13.95: Telemetry -->
  <script src="./telemetry.js" defer></script>

  <!-- Engine -->
  <script src="./groups.safe.js" defer></script>

  <style>
    /* Debug HUD (on-screen) */
    #dbgHud{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(env(safe-area-inset-bottom,0px) + 10px);
      z-index: 9999;
      pointer-events:none;
      display:none;
    }
    #dbgHud.show{ display:block; }
    #dbgBox{
      background: rgba(2,6,23,.86);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      font: 12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      color: rgba(229,231,235,.92);
      white-space: pre-wrap;
      max-height: 42vh;
      overflow:auto;
    }
    #dbgHint{
      margin-top:8px;
      font: 12px/1.25 system-ui,-apple-system,"Noto Sans Thai",sans-serif;
      color: rgba(229,231,235,.82);
      font-weight: 900;
      pointer-events:none;
    }
    #dbgHint b{ color:#fff; }
  </style>
</head>

<body>

  <!-- XR Scene (behind DOM) -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="colorManagement: true">
    <a-entity position="0 1.6 0"><a-camera></a-camera></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span id="vTime" class="val">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span id="vScore" class="val">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span id="vCombo" class="val">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span id="vMiss" class="val">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üèÖ RANK</span><span id="vRank" class="val">C</span></div>
      <div class="pill"><span class="lbl">üéØ ACC</span><span id="vAcc" class="val">0%</span></div>
      <div class="pill"><span class="lbl">üß™ MODE</span><span id="vMode" class="val">PLAY</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">GOAL</div>
        <div class="tag" id="goalCount">0/1</div>
      </div>
      <div class="bar"><div id="goalFill" class="fill"></div></div>
      <div class="qSub" id="goalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag"><span class="miniTime" id="miniTime">‚Äî</span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill"></div></div>
      <div class="qSub" id="miniSub">‚Äî</div>
    </div>
  </div>

  <!-- Big Banner -->
  <div id="bigBanner" class="bigBanner hidden" aria-live="polite">
    <div id="bigBannerText" class="bigBannerText">‚Äî</div>
  </div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div id="pFill" class="fill"></div></div>
      <div class="pFoot"><span id="pCur">0</span>/<span id="pThr">8</span> ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" src="../img/coach-neutral.png" alt="coach" />
      <div class="coachBubble">
        <div class="coachName">ü•¶ Coach</div>
        <div id="coachText" class="coachText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Play Layer -->
  <div id="playLayer" class="playLayer"></div>

  <!-- Calibration overlay (cVR only) -->
  <div id="calOverlay" class="overlay overlay-cal hidden">
    <div class="panel calPanel">
      <div class="title">üß≠ Calibration (Cardboard)</div>
      <div id="calSub" class="sub">
        Step 1/2: ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div class="stat">
          <div class="k">Step</div>
          <div id="calStep" class="v">1/2</div>
        </div>
        <div class="stat">
          <div class="k">Shots</div>
          <div id="calShots" class="v">0/3</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnCalNext" class="btn btn-strong" type="button">‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
        <button id="btnCalSkip" class="btn btn-ghost" type="button">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</button>
      </div>

      <div class="note" style="margin-top:10px;">
        cVR: ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡πÉ‡∏ä‡πâ RECENTER ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="endOverlay" class="overlay overlay-end hidden">
    <div class="panel">
      <div class="title">üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
      <div id="endLine" class="sub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
        <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
      </div>

      <div class="row row2">
        <button id="btnRestart" class="btn btn-strong" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopy" class="btn" type="button">üìã Copy JSON</button>
      </div>
      <div class="row row2">
        <button id="btnBackLauncher" class="btn btn-ghost" type="button">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Launcher</button>
        <button id="btnHub" class="btn btn-ghost" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        Cardboard (cVR): ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ENTER VR/RECENTER ‡∏≠‡∏¢‡∏π‡πà UI ‡∏Ç‡∏≠‡∏á vr-ui.js
      </div>
    </div>
  </div>

  <!-- ‚úÖ DEBUG HUD -->
  <div id="dbgHud" aria-live="polite">
    <div id="dbgBox">debug‚Ä¶</div>
    <div id="dbgHint">‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏µ <b>Error</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>Engine/FX</b> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
  </div>

<script>
(function(){
  'use strict';
  const DOC = document;
  const $ = (id)=>DOC.getElementById(id);

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }
  function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }
  function nowMs(){ return (performance && performance.now) ? performance.now() : Date.now(); }

  // =========================
  // ‚úÖ DEBUG / ERROR TRAP
  // =========================
  const DBG = {
    on: (String(qs('debug','0')||'0') === '1' || String(qs('debug','0')||'0') === 'true'),
    logs: [],
    max: 140,
    shown: false
  };

  function dlog(line){
    const s = String(line||'');
    DBG.logs.push(s);
    if (DBG.logs.length > DBG.max) DBG.logs.shift();
    if (DBG.on) showDbg();
    if (DBG.shown) renderDbg();
  }

  function showDbg(force=false){
    if (!force && !DBG.on) return;
    DBG.shown = true;
    $('dbgHud')?.classList.add('show');
    renderDbg();
  }

  function renderDbg(){
    const box = $('dbgBox');
    if (!box) return;
    const head = [
      'GroupsVR DEBUG HUD',
      'url: ' + location.href,
      'time: ' + new Date().toISOString(),
      'vrui.lockPx: ' + (window.HHA_VRUI_CONFIG && window.HHA_VRUI_CONFIG.lockPx),
      'vrui.cooldownMs: ' + (window.HHA_VRUI_CONFIG && window.HHA_VRUI_CONFIG.cooldownMs),
      '----------------------------------------'
    ].join('\n');
    box.textContent = head + '\n' + DBG.logs.join('\n');
  }

  function showDbgOnError(msg){
    dlog('‚ùå ERROR: ' + msg);
    showDbg(true);
  }

  window.addEventListener('error', (ev)=>{
    const m = ev?.message || 'unknown';
    const src = ev?.filename ? (' @ ' + ev.filename.split('/').slice(-2).join('/') + ':' + (ev.lineno||0)) : '';
    showDbgOnError(m + src);
  });

  window.addEventListener('unhandledrejection', (ev)=>{
    const r = ev?.reason;
    const m = (r && (r.stack || r.message)) ? (r.stack || r.message) : String(r||'unhandledrejection');
    showDbgOnError(m);
  });

  window.addEventListener('error', (ev)=>{
    const t = ev?.target;
    if (!t) return;
    const tag = (t.tagName||'').toLowerCase();
    if (tag === 'script' || tag === 'link' || tag === 'img'){
      const src = t.src || t.href || '(no-src)';
      showDbgOnError(`resource failed: <${tag}> ${src}`);
    }
  }, true);

  function depStatus(){
    const has = (v)=> (typeof v !== 'undefined' && v !== null);
    const P = has(window.Particles);
    const V = has(window.__HHA_VRUI_LOADED__) || has(window.HHA_VRUI_CONFIG);
    const G = has(window.GroupsVR);
    const E = !!(window.GroupsVR && window.GroupsVR.GameEngine && typeof window.GroupsVR.GameEngine.start === 'function');
    const T = !!(window.GroupsVR && window.GroupsVR.Telemetry && typeof window.GroupsVR.Telemetry.init === 'function');
    const VH= !!(window.GroupsVR && window.GroupsVR.ViewHelper && typeof window.GroupsVR.ViewHelper.init === 'function');
    const FX= !!(window.GroupsVR && window.GroupsVR.EffectsPack);
    return { Particles:P, VRUI:V, GroupsVR:G, Engine:E, Telemetry:T, ViewHelper:VH, EffectsPack:FX };
  }

  function reportDeps(prefix){
    const s = depStatus();
    dlog(prefix + ' deps: ' + Object.entries(s).map(([k,v])=>`${k}=${v?'OK':'NO'}`).join(' ‚Ä¢ '));
  }

  // =========================
  // View
  // =========================
  function setView(view){
    const b = DOC.body;
    b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    b.classList.add('view-'+view);
  }

  function aiEnabled(){
    const run = String(qs('run','play')||'play').toLowerCase();
    const on  = String(qs('ai','0')||'0');
    if (run === 'research') return false;
    return (on === '1' || on === 'true');
  }

  function getPracticeSec(view){
    const p = String(qs('practice','0')||'0');
    let sec = Number(p)||0;
    if (p === '1') sec = 15;
    sec = clamp(sec, 0, 30);
    if (view !== 'cvr') sec = 0;
    return sec;
  }

  async function copyText(text){
    try { await navigator.clipboard.writeText(String(text||'')); return true; }
    catch {
      try{
        const ta = DOC.createElement('textarea');
        ta.value = String(text||'');
        DOC.body.appendChild(ta);
        ta.select();
        DOC.execCommand('copy');
        ta.remove();
        return true;
      }catch{ return false; }
    }
  }

  // =========================
  // Big Banner API
  // =========================
  let bannerTmr = 0;
  function showBanner(text, tone='neutral', ms=1200){
    const el = $('bigBanner');
    const tx = $('bigBannerText');
    if (!el || !tx) return;
    tx.textContent = String(text||'');
    el.classList.remove('hidden');
    el.classList.remove('tone-neutral','tone-good','tone-warn','tone-bad');
    el.classList.add('show');
    el.classList.add('tone-'+tone);

    clearTimeout(bannerTmr);
    bannerTmr = setTimeout(()=>{
      try{
        el.classList.remove('show');
        el.classList.add('hidden');
      }catch(_){}
    }, clamp(ms, 600, 2500));
  }

  window.addEventListener('groups:telemetry_auto', (ev)=>{
    const d = ev.detail || {};
    if (d.kind === 'switch'){
      const msg =
        (d.to === 'lite') ? `üì° TELE ‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô LITE (FPS ${d.fps})` :
        (d.to === 'off')  ? `üì° TELE ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (FPS ${d.fps})` :
                            `üì° TELE ‚Üí ${String(d.to||'')}`;

      showBanner(msg, 'warn', 1300);

      try{
        window.dispatchEvent(new CustomEvent('hha:coach', {
          detail:{ text:`‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á (FPS ${d.fps}) ‡πÄ‡∏•‡∏¢‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ‚úÖ`, mood:'neutral' }
        }));
      }catch(_){}
    }
  }, { passive:true });

  // =========================
  // HUD binds
  // =========================
  let _score=0,_combo=0,_miss=0,_acc=0,_left=90,_storm=false,_miniUrg=false;
  let _groupName='‚Äî', _groupKey='', _lastGroupKey='';

  window.addEventListener('hha:score', (ev)=>{
    const d = ev.detail||{};
    _score = Number(d.score ?? _score) || 0;
    _combo = Number(d.combo ?? _combo) || 0;
    _miss  = Number(d.misses ?? _miss) || 0;
    $('vScore').textContent = String(_score|0);
    $('vCombo').textContent = String(_combo|0);
    $('vMiss').textContent  = String(_miss|0);
  }, {passive:true});

  window.addEventListener('hha:time', (ev)=>{
    const d = ev.detail||{};
    _left = Math.max(0, Math.round(d.left ?? _left));
    $('vTime').textContent = String(_left);
  }, {passive:true});

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev.detail||{};
    $('vRank').textContent = String(d.grade ?? 'C');
    _acc = Number(d.accuracy ?? _acc) || 0;
    $('vAcc').textContent  = String(_acc + '%');
  }, {passive:true});

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev.detail||{};
    $('coachText').textContent = String(d.text||'');
    const mood = String(d.mood||'neutral');
    const img =
      (mood==='happy') ? '../img/coach-happy.png' :
      (mood==='sad')   ? '../img/coach-sad.png' :
      (mood==='fever') ? '../img/coach-fever.png' :
                        '../img/coach-neutral.png';
    $('coachImg').src = img;
  }, {passive:true});

  window.addEventListener('groups:power', (ev)=>{
    const d = ev.detail||{};
    const cur = Number(d.charge||0);
    const thr = Math.max(1, Number(d.threshold||8));
    $('pCur').textContent = String(cur|0);
    $('pThr').textContent = String(thr|0);
    $('pFill').style.width = Math.round((cur/thr)*100) + '%';
  }, {passive:true});

  window.addEventListener('quest:update', (ev)=>{
    const d = ev.detail||{};

    const gTitle = String(d.goalTitle||'‚Äî');
    const gNow   = Number(d.goalNow||0);
    const gTot   = Math.max(1, Number(d.goalTotal||1));
    const gPct   = clamp(d.goalPct ?? (gNow/gTot*100), 0, 100);

    const mTitle = String(d.miniTitle||'‚Äî');
    const mNow   = Number(d.miniNow||0);
    const mTot   = Math.max(1, Number(d.miniTotal||1));
    const mPct   = clamp(d.miniPct ?? (mNow/mTot*100), 0, 100);
    const mLeft  = Number(d.miniTimeLeftSec||0);

    $('goalTitle').textContent = 'üéØ GOAL';
    $('goalCount').textContent = `${gNow}/${gTot}`;
    $('goalFill').style.width = Math.round(gPct) + '%';
    $('goalSub').textContent = gTitle;

    $('miniTitle').textContent = '‚ö° MINI';
    $('miniFill').style.width = Math.round(mPct) + '%';
    $('miniSub').textContent = mTitle;
    $('miniTime').textContent = (mLeft>0) ? `${mLeft}s` : '‚Äî';

    const urgent = (mLeft>0 && mLeft<=3);
    _miniUrg = urgent;
    DOC.body.classList.toggle('mini-urgent', urgent);

    _groupName = String(d.groupName || _groupName || '‚Äî');
    _groupKey  = String(d.groupKey  || _groupKey  || '');
    if (_groupKey && _groupKey !== _lastGroupKey){
      _lastGroupKey = _groupKey;
      showBanner('‡∏´‡∏°‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ' + _groupName, 'good', 1200);
    }
  }, {passive:true});

  window.addEventListener('groups:progress', (ev)=>{
    const d = ev.detail||{};
    const k = String(d.kind||'');
    if (k === 'storm_on'){ _storm = true; showBanner('üå™Ô∏è STORM! ‡πÄ‡∏õ‡πâ‡∏≤‡∏ñ‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô', 'warn', 1400); }
    if (k === 'storm_off'){ _storm = false; showBanner('‚ú® ‡∏û‡∏≤‡∏¢‡∏∏‡∏à‡∏ö! ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠', 'good', 1100); }
    if (k === 'boss_spawn'){ showBanner('üëä BOSS ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!', 'warn', 1200); }
    if (k === 'boss_down'){ showBanner('üí• BOSS ‡πÅ‡∏ï‡∏Å!', 'good', 1100); }
    if (k === 'perfect_switch'){ showBanner('üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà!', 'neutral', 1000); }
  }, {passive:true});

  // =========================
  // Summary / History
  // =========================
  const LS_LAST = 'HHA_LAST_SUMMARY';
  const LS_HIST = 'HHA_SUMMARY_HISTORY';
  let lastSummary = null;
  let startIso = new Date().toISOString();

  function saveLast(summary){
    try{ localStorage.setItem(LS_LAST, JSON.stringify(summary)); }catch{}
    try{
      const hist = JSON.parse(localStorage.getItem(LS_HIST)||'[]');
      hist.unshift(summary);
      localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 50)));
    }catch{}
  }

  function buildBaseSummary(d, endIso){
    const ctx = (window.GroupsVR && window.GroupsVR.getResearchCtx) ? window.GroupsVR.getResearchCtx() : {};
    return Object.assign({
      timestampIso: endIso,
      projectTag: 'HeroHealth',
      gameTag: 'GroupsVR',
      runMode: String(qs('run','play')||'play'),
      diff: String(qs('diff','normal')||'normal'),
      style: String(qs('style','mix')||'mix'),
      view: String(qs('view','mobile')||'mobile'),
      durationPlannedSec: Number(qs('time',90)||90),
      startTimeIso: startIso,
      endTimeIso: endIso,
      seed: String(qs('seed','')||'')
    }, ctx, d||{});
  }

  try{
    const B = window.GroupsVR && window.GroupsVR.bindFlushOnLeave;
    B && B(()=>lastSummary);
  }catch(_){}

  let practiceActive = false;
  let practiceDone = false;

  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail||{};
    const endIso = new Date().toISOString();

    if (practiceActive && !practiceDone){
      practiceDone = true;
      practiceActive = false;
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function'){
        setTimeout(()=> startReal(E), 180);
      }
      return;
    }

    lastSummary = buildBaseSummary(d, endIso);
    saveLast(lastSummary);

    $('endOverlay').classList.remove('hidden');
    $('endLine').textContent = '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ' + String(d.reason || 'end');
    $('endScore').textContent = String(d.scoreFinal ?? 0);
    $('endRank').textContent  = String(d.grade ?? 'C');
    $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
    $('endMiss').textContent  = String(d.misses ?? 0);

    const hub = String(qs('hub','')||'');
    $('btnHub').style.display = hub ? 'inline-flex' : 'none';
  }, {passive:true});

  $('btnRestart').addEventListener('click', ()=> location.reload());

  $('btnCopy').addEventListener('click', async ()=>{
    if (!lastSummary){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
    const ok = await copyText(JSON.stringify(lastSummary, null, 2));
    alert(ok ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : 'Copy ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  });

  $('btnBackLauncher').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    const u = new URL('../groups-vr.html', location.href);
    if (hub) u.searchParams.set('hub', hub);

    const sp = new URL(location.href).searchParams;
    sp.forEach((v,k)=>{
      if (k==='hub') return;
      u.searchParams.set(k,v);
    });
    location.href = u.toString();
  });

  $('btnHub').addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    if (!hub){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå hub=...'); return; }
    location.href = hub;
  });

  // =========================
  // Engine helpers
  // =========================
  function getLayerEl(){
    return $('playLayer') || DOC.querySelector('.playLayer') || DOC.body;
  }

  function initViewHelper(view){
    try{
      const H = window.GroupsVR && window.GroupsVR.ViewHelper;
      H && H.init && H.init({ view });
    }catch(e){
      showDbgOnError('ViewHelper.init failed: ' + (e?.message||e));
    }
  }

  function initTelemetry(runMode){
    try{
      const T = window.GroupsVR && window.GroupsVR.Telemetry;
      if (!T || !T.init) return;
      T.init({
        runMode,
        endpoint: String(qs('log','')||''),
        flushEveryMs: 2000,
        maxEventsPerBatch: 60,
        maxQueueBatches: 16,
        statusEveryMs: 850
      });
    }catch(e){
      showDbgOnError('Telemetry.init failed: ' + (e?.message||e));
    }
  }

  function waitForEngine(cb){
    const t0 = Date.now();
    const tick = ()=>{
      const E = window.GroupsVR && window.GroupsVR.GameEngine;
      if (E && typeof E.start === 'function' && typeof E.setLayerEl === 'function'){
        dlog('‚úÖ Engine ready');
        cb(E);
        return;
      }
      if (Date.now() - t0 > 8000){
        reportDeps('‚è±Ô∏è timeout');
        showDbgOnError('Engine not ready after 8s (groups.safe.js loaded but API missing?)');
        try{
          window.dispatchEvent(new CustomEvent('hha:coach', {
            detail:{ text:'‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô (groups.safe.js). ‡πÅ‡∏ï‡πà‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ error ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ô (‡∏î‡∏π DEBUG HUD)', mood:'sad' }
          }));
        }catch(_){}
        return;
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  // =========================
  // Calibration (cVR)
  // =========================
  const cal = { on:false, step:0, shots:0, done:false };

  function showCal(on){
    const el = $('calOverlay');
    if (!el) return;
    el.classList.toggle('hidden', !on);
    DOC.body.classList.toggle('calibration', !!on);
  }

  function setCalStep(step){
    cal.step = step;
    const stepEl = $('calStep');
    const subEl  = $('calSub');
    const shotsEl= $('calShots');
    const nextBt = $('btnCalNext');

    if (stepEl) stepEl.textContent = `${step}/2`;
    if (shotsEl) shotsEl.textContent = `${cal.shots}/3`;

    if (subEl){
      if (step === 1){
        subEl.innerHTML = `Step 1/2: ‡∏Å‡∏î <b>RECENTER</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤`;
      }else{
        subEl.innerHTML = `Step 2/2: ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á <b>3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</b> (‡πÅ‡∏ï‡∏∞‡∏à‡∏≠) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö crosshair`;
      }
    }

    if (nextBt){
      if (step === 1){
        nextBt.textContent = '‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ';
        nextBt.disabled = false;
      }else{
        nextBt.textContent = (cal.shots>=3) ? 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢' : '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        nextBt.disabled = (cal.shots < 3);
      }
    }
  }

  function startCalibrationIfNeeded(view){
    if (view !== 'cvr') return false;
    cal.on = true;
    cal.done = false;
    cal.shots = 0;
    showCal(true);
    setCalStep(1);
    return true;
  }

  function finishCalibration(){
    cal.on = false;
    cal.done = true;
    showCal(false);
  }

  window.addEventListener('hha:shoot', ()=>{
    if (!cal.on) return;
    if (cal.step !== 2) return;
    cal.shots = Math.min(3, (cal.shots|0) + 1);
    setCalStep(2);
  }, {passive:true});

  $('btnCalNext') && $('btnCalNext').addEventListener('click', ()=>{
    if (!cal.on) return;
    if (cal.step === 1){
      setCalStep(2);
      return;
    }
    if (cal.step === 2 && cal.shots >= 3){
      finishCalibration();
      waitForEngine((E)=> startAfterCalibration(E));
    }
  });

  $('btnCalSkip') && $('btnCalSkip').addEventListener('click', ()=>{
    if (!cal.on) return;
    finishCalibration();
    waitForEngine((E)=> startAfterCalibration(E));
  });

  function startAfterCalibration(E){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const practiceSec = getPracticeSec(view);

    if (view === 'cvr' && practiceSec > 0){
      initTelemetry('practice');
      startPractice(E, {
        diff: String(qs('diff','normal')||'normal').toLowerCase(),
        style:String(qs('style','mix')||'mix').toLowerCase(),
        seed: String(qs('seed', Date.now()) || Date.now()),
        practiceSec
      });
      return;
    }

    const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
    initTelemetry(run);
    startReal(E);
  }

  // =========================
  // Practice 15s (cVR)
  // =========================
  function startPractice(E, cfg){
    practiceActive = true;
    practiceDone = false;
    $('vMode').textContent = 'PRACTICE';

    const seedP = String(cfg.seed) + '-practice';
    startIso = new Date().toISOString();

    initViewHelper('cvr');
    E.setLayerEl(getLayerEl());
    E.start(cfg.diff, { runMode:'practice', diff:cfg.diff, style:cfg.style, time: cfg.practiceSec, seed: seedP });
  }

  // =========================
  // AI Predictor (unchanged)
  // =========================
  const PRED = { on:false, lastTipAt:0, lastWarnAt:0, hist:[], maxHist:20 };
  function sigmoid(x){ return 1 / (1 + Math.exp(-x)); }
  function riskScore(f){
    const w = [ 1.35, 1.10, -0.35, 0.55, 0.65, 0.55 ];
    const b = -0.55;
    let z = b;
    for (let i=0;i<w.length;i++) z += w[i] * (Number(f[i])||0);
    return sigmoid(z);
  }
  function pushHist(){
    const t = nowMs();
    PRED.hist.push({ t, miss:_miss|0, acc:_acc|0, combo:_combo|0, left:_left|0, storm:_storm?1:0, miniUrg:_miniUrg?1:0 });
    if (PRED.hist.length > PRED.maxHist) PRED.hist.shift();
  }
  function calcMissRate10s(){
    const t = nowMs();
    const cut = t - 10000;
    const a = PRED.hist.filter(x=>x.t>=cut);
    if (a.length < 2) return 0;
    const dm = (a[a.length-1].miss - a[0].miss);
    return Math.max(0, dm) / 10;
  }
  function shouldTip(){ return (nowMs() - PRED.lastTipAt) > 1600; }
  function tip(text, mood='neutral'){
    if (!PRED.on) return;
    if (!shouldTip()) return;
    PRED.lastTipAt = nowMs();
    try{ window.dispatchEvent(new CustomEvent('hha:coach', { detail:{ text, mood } })); }catch(_){}
  }
  function tickPredictor(){
    if (!PRED.on) return;
    pushHist();
    const missRate = Math.min(1, calcMissRate10s() * 2.2);
    const accBad   = Math.min(1, (100 - _acc) / 100);
    const comboN   = Math.max(0, Math.min(1, _combo / 10));
    const leftLow  = Math.max(0, Math.min(1, (12 - _left) / 12));
    const storm    = _storm ? 1 : 0;
    const miniU    = _miniUrg ? 1 : 0;
    const r = riskScore([missRate, accBad, comboN, leftLow, storm, miniU]);

    if (r >= 0.78){
      if (miniU) { showBanner('‚è±Ô∏è MINI ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î! ‡πÄ‡∏•‡πá‡∏á ‚Äú‡∏ä‡∏±‡∏ß‡∏£‡πå‚Äù ‡∏Å‡πà‡∏≠‡∏ô', 'warn', 1300); tip('MINI ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î! ‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üëÄ', 'fever'); }
      else if (storm){ showBanner('üå™Ô∏è ‡∏û‡∏≤‡∏¢‡∏∏! ‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏¥‡∏î ‡πÄ‡∏•‡πá‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡∏á', 'warn', 1200); tip('‡∏û‡∏≤‡∏¢‡∏∏‡∏≠‡∏¢‡∏π‡πà! ‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏¥‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡∏á üî•', 'fever'); }
      else if (missRate > 0.35){ showBanner('‚ö†Ô∏è ‡∏û‡∏•‡∏≤‡∏î‡∏ñ‡∏µ‡πà! ‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏°‡∏±‡πà‡∏ß', 'bad', 1200); tip('‡∏û‡∏•‡∏≤‡∏î‡∏ñ‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏°‡∏±‡πà‡∏ß 1 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà üéØ', 'sad'); }
      else { showBanner('‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πà‡∏ß‡∏á!', 'warn', 1100); tip('‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ï‡∏¥! ‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á ‚úÖ', 'neutral'); }
    } else if (r >= 0.55){
      if (accBad > 0.35) tip('‡∏•‡∏≠‡∏á ‚Äú‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏¥‡∏î‚Äù ‡πÅ‡∏ï‡πà‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà ‡∏à‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤ üëç', 'neutral');
      else if (leftLow > 0.5) tip('‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‚è≥', 'fever');
    } else {
      const t = nowMs();
      if (t - PRED.lastWarnAt > 6500 && _combo >= 6){
        PRED.lastWarnAt = t;
        tip('‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏ß‡∏¢‡∏°‡∏≤‡∏Å! ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ üí™', 'happy');
      }
    }
  }

  let predIt = 0;
  function startPredictorIfAllowed(runMode){
    const on = String(qs('ai','0')||'0');
    PRED.on = ((on==='1'||on==='true') && runMode === 'play');
    if (!PRED.on) return;
    clearInterval(predIt);
    predIt = setInterval(tickPredictor, 800);
    showBanner('üß† AI Coach ON', 'neutral', 1000);
  }
  function stopPredictor(){
    PRED.on = false;
    clearInterval(predIt);
  }

  // =========================
  // Start Real
  // =========================
  function startReal(E){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
    const diff = String(qs('diff','normal')||'normal').toLowerCase();
    const style= String(qs('style','mix')||'mix').toLowerCase();
    const time = clamp(qs('time',90), 30, 180);
    const seed = String(qs('seed', Date.now()) || Date.now());

    $('vMode').textContent = (run==='research') ? 'RESEARCH' : 'PLAY';
    startIso = new Date().toISOString();

    reportDeps('‚ñ∂ before start');

    initViewHelper(view);

    const layer = getLayerEl();
    if (!layer){
      showDbgOnError('playLayer missing (#playLayer)');
      return;
    }
    E.setLayerEl(layer);

    try{
      E.start(diff, { runMode: run, diff, style, time, seed });
      dlog('‚úÖ Engine.start OK (diff=' + diff + ', time=' + time + ', run=' + run + ')');
    }catch(e){
      showDbgOnError('Engine.start failed: ' + (e?.stack||e?.message||e));
      return;
    }

    if (run === 'play') startPredictorIfAllowed(run);
    else stopPredictor();

    try{
      const AI = window.GroupsVR && window.GroupsVR.AIHooks;
      if (AI && AI.attach){
        AI.attach({ runMode: run, seed, enabled: aiEnabled() && run!=='research' });
        dlog('‚úÖ AIHooks.attach called (enabled=' + (aiEnabled() && run!=='research') + ')');
      }else{
        dlog('‚Ñπ AIHooks.attach not found (ok if disabled)');
      }
    }catch(e){
      showDbgOnError('AIHooks.attach failed: ' + (e?.message||e));
    }
  }

  // =========================
  // START FROM PARAMS
  // =========================
  function startFromParams(){
    const view = String(qs('view','mobile')||'mobile').toLowerCase();
    setView(view);

    if (DBG.on){
      dlog('debug=1 enabled');
      reportDeps('init');
      showDbg(true);
    }else{
      reportDeps('init');
    }

    showBanner('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°! ‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏π‡πà üéØ', 'neutral', 1000);

    if (String(qs('selftest','0')||'0') === '1'){
      try{ window.Particles && window.Particles.popText(40, 80, 'FX OK', 'ok'); dlog('‚úÖ Particles.popText OK'); }
      catch(e){ showDbgOnError('Particles selftest failed: ' + (e?.message||e)); }
    }

    const gated = startCalibrationIfNeeded(view);
    if (gated) return;

    const practiceSec = getPracticeSec(view);
    waitForEngine((E)=>{
      if (view === 'cvr' && practiceSec > 0){
        initTelemetry('practice');
        startPractice(E, {
          diff: String(qs('diff','normal')||'normal').toLowerCase(),
          style:String(qs('style','mix')||'mix').toLowerCase(),
          seed: String(qs('seed', Date.now()) || Date.now()),
          practiceSec
        });
        return;
      }
      const run  = (String(qs('run','play')||'play').toLowerCase()==='research') ? 'research' : 'play';
      initTelemetry(run);
      startReal(E);
    });
  }

  startFromParams();
})();
</script>
</body>
</html>