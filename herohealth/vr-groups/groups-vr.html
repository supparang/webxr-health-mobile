<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR RUN ‚Äî PRODUCTION (HHA Standard)
‚úÖ lockPx tuned for mobile/cVR by diff (Easy/Normal/Hard)
‚úÖ Starts reliably (Tap/Click Start => GameEngine.start)
‚úÖ Loads: groups-vr.css, vr-ui.js, effects-pack.js, groups.safe.js
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <script>
    (function(){
      'use strict';
      function qs(k,d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }
      const diff = String(qs('diff','normal')||'normal').toLowerCase();
      const view = String(qs('view','')||'').toLowerCase(); // may be empty (auto)

      // If view not provided, do a light UA guess (kept simple & safe)
      const ua = (navigator.userAgent||'').toLowerCase();
      const isMobile = /android|iphone|ipad|ipod|mobile/.test(ua);

      // decide effective view for lockPx tuning
      const effectiveView = view || (isMobile ? 'mobile' : 'pc');

      // lockPx table (what we agreed)
      // mobile/cvr should be forgiving; pc smaller
      const LOCK_TABLE = {
        easy:   { mobile:52, cvr:52, vr:28, pc:16 },
        normal: { mobile:48, cvr:48, vr:26, pc:14 },
        hard:   { mobile:42, cvr:42, vr:24, pc:12 }
      };

      function viewKey(v){
        v = String(v||'').toLowerCase();
        if(v === 'cvr') return 'cvr';
        if(v === 'vr')  return 'vr';
        if(v === 'pc')  return 'pc';
        return 'mobile';
      }

      const d = (LOCK_TABLE[diff] ? diff : 'normal');
      const vkey = viewKey(effectiveView);

      // IMPORTANT: set BEFORE vr-ui.js loads
      window.HHA_VRUI_CONFIG = Object.assign({}, window.HHA_VRUI_CONFIG || {}, {
        lockPx: LOCK_TABLE[d][vkey],
        cooldownMs: 90
      });

      // Also set a body class hint early (optional; final view classes can be set later by helper)
      // Do not force override; just add a baseline.
      document.documentElement.classList.add('booted');

    })();
  </script>

  <!-- Universal VR UI (adds Enter VR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot) -->
  <script defer src="../vr/vr-ui.js"></script>

  <!-- Optional particles (if you use it) -->
  <!-- <script defer src="../vr/particles.js"></script> -->

  <!-- FX pack (listens groups:hit) -->
  <script defer src="./effects-pack.js"></script>

  <!-- Engine -->
  <script defer src="./groups.safe.js"></script>
</head>

<body class="view-mobile">
  <!-- XR scene (optional, can be kept minimal if you already have it in your old run file)
       If you already use A-Frame in your project, you can re-add it here.
  -->
  <div class="xr-scene" aria-hidden="true"></div>

  <!-- HUD -->
  <header class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‡πÄ‡∏ß‡∏•‡∏≤</span><span class="val" id="hudTime">90</span></div>
      <div class="pill"><span class="lbl">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span><span class="val" id="hudCombo">0</span></div>
      <div class="pill"><span class="lbl">MISS</span><span class="val" id="hudMiss">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">RANK</span><span class="val" id="hudRank">D</span></div>
    </div>
  </header>

  <!-- Quest -->
  <section class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="goalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: ‡∏´‡∏°‡∏π‡πà 1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span>
        <span class="tag" id="groupTag">g1</span>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">0 / 12</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="miniTitle">MINI: ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
        <span class="tag" id="miniTag">10s</span>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">0 / 5</div>
    </div>
  </section>

  <!-- Big banner -->
  <div class="bigBanner hidden" id="bigBanner">
    <div class="bigBannerText" id="bigBannerText">‡∏û‡∏£‡πâ‡∏≠‡∏°!</div>
  </div>

  <!-- Play layer -->
  <main class="playLayer" id="playLayer" aria-label="play layer"></main>

  <!-- Power -->
  <section class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‡∏û‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerText">0 / 8</div>
    </div>
  </section>

  <!-- Coach -->
  <section class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" src="../img/coach-neutral.png" alt="coach" id="coachImg">
      <div class="coachBubble">
        <div class="coachName">Hero Coach</div>
        <div class="coachText" id="coachText">‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢!</div>
      </div>
    </div>
  </section>

  <!-- Start overlay (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏Å‡∏±‡∏ô ‚Äú‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‚Äù) -->
  <section class="overlay" id="startOverlay">
    <div class="panel">
      <div class="title" id="ovTitle">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</div>
      <div class="sub" id="ovSub">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å Launcher ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br/>
        ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á (‡∏°‡∏µ Aim Assist)
      </div>

      <div class="grid2">
        <div class="stat">
          <div class="k">‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
          <div class="v" id="ovDiff">normal</div>
        </div>
        <div class="stat">
          <div class="k">‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="v"><span id="ovTime">90</span> ‡∏ß‡∏¥</div>
        </div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn btn-ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        Normal 90s KPI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: Miss ‚â§ 20 (‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤ ‚â§ 15)
      </div>
    </div>
  </section>

  <!-- End overlay -->
  <section class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">ACC</div><div class="v" id="endAcc">0%</div></div>
        <div class="stat"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
        <div class="stat"><div class="k">RANK</div><div class="v" id="endRank">D</div></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnHub2">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </section>

  <script>
    (function(){
      'use strict';

      const WIN = window, DOC = document;
      const $ = (id)=>DOC.getElementById(id);

      function qs(k,d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }
      function num(v, d=0){ v = Number(v); return Number.isFinite(v) ? v : d; }

      const hub = String(qs('hub','')||'');
      const diff = String(qs('diff','normal')||'normal').toLowerCase();
      const time = num(qs('time', diff==='easy'?60:diff==='hard'?120:90), 90);

      // show overlay info
      $('ovDiff').textContent = diff;
      $('ovTime').textContent = String(time);

      function setBanner(text, tone){
        const box = $('bigBanner');
        const t = $('bigBannerText');
        if(!box || !t) return;

        box.classList.remove('hidden');
        box.classList.remove('tone-neutral','tone-good','tone-warn','tone-bad');
        box.classList.add('show');
        box.classList.add(tone ? ('tone-' + tone) : 'tone-neutral');
        t.textContent = text;

        setTimeout(()=>{
          box.classList.remove('show');
        }, 800);

        setTimeout(()=>{
          box.classList.add('hidden');
        }, 1100);
      }

      function setCoach(text, mood){
        $('coachText').textContent = text || '';
        const img = $('coachImg');
        if(!img) return;
        // safe: use your known file names
        if(mood === 'happy') img.src = '../img/coach-happy.png';
        else if(mood === 'sad') img.src = '../img/coach-sad.png';
        else if(mood === 'fever') img.src = '../img/coach-fever.png';
        else img.src = '../img/coach-neutral.png';
      }

      function applyViewClass(){
        // if you already have a better view helper, keep it ‚Äî this is safe fallback
        const v = String(qs('view','')||'').toLowerCase();
        const ua = (navigator.userAgent||'').toLowerCase();
        const isMobile = /android|iphone|ipad|ipod|mobile/.test(ua);
        const view = v || (isMobile ? 'mobile' : 'pc');

        DOC.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
        DOC.body.classList.add('view-' + (view==='cvr'?'cvr':view==='vr'?'vr':view==='pc'?'pc':'mobile'));
      }

      function startGame(){
        applyViewClass();

        const playLayer = $('playLayer');
        try{
          if (WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.setLayerEl) {
            WIN.GroupsVR.GameEngine.setLayerEl(playLayer);
          }
        }catch(_){}

        // hide overlay then start
        $('startOverlay').classList.add('hidden');

        setBanner('‡πÄ‡∏£‡∏¥‡πà‡∏°!', 'good');
        setCoach('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö üî•', 'neutral');

        // start engine
        try{
          WIN.GroupsVR.GameEngine.start(diff, { time: time, runMode: String(qs('run','play')||'play'), seed: qs('seed','')||'' });
        }catch(e){
          $('startOverlay').classList.remove('hidden');
          $('ovTitle').textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          $('ovSub').textContent = String(e && e.message ? e.message : e);
        }
      }

      // buttons
      $('btnStart').addEventListener('click', startGame, { passive:true });

      function goHub(){
        if(hub){ location.href = hub; return; }
        // fallback: go to /herohealth/hub.html if exists
        location.href = '../hub.html';
      }
      $('btnBackHub').addEventListener('click', goHub, { passive:true });
      $('btnHub2').addEventListener('click', goHub, { passive:true });

      $('btnReplay').addEventListener('click', ()=>{
        $('endOverlay').classList.add('hidden');
        // restart with same params
        startGame();
      }, { passive:true });

      // HUD wiring
      WIN.addEventListener('hha:time', (ev)=>{
        const left = (ev && ev.detail) ? ev.detail.left : time;
        $('hudTime').textContent = String(left|0);
      }, { passive:true });

      WIN.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        $('hudScore').textContent = String(d.score|0);
        $('hudCombo').textContent = String(d.combo|0);
        $('hudMiss').textContent = String(d.misses|0);
      }, { passive:true });

      WIN.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        $('hudAcc').textContent = String(d.accuracy|0) + '%';
        $('hudRank').textContent = String(d.grade||'D');
      }, { passive:true });

      WIN.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};

        $('goalTitle').textContent = d.goalTitle || '';
        $('groupTag').textContent = d.groupKey || '';
        $('goalSub').textContent = `${d.goalNow||0} / ${d.goalTotal||0}`;
        $('goalFill').style.width = String(d.goalPct||0) + '%';

        $('miniTitle').textContent = d.miniTitle || '';
        $('miniSub').textContent = `${d.miniNow||0} / ${d.miniTotal||0}`;
        $('miniFill').style.width = String(d.miniPct||0) + '%';

        const tl = d.miniTimeLeftSec|0;
        $('miniTag').textContent = tl ? (tl + 's') : '‚Äî';
        if(tl && tl <= 3) DOC.body.classList.add('mini-urgent');
        else DOC.body.classList.remove('mini-urgent');
      }, { passive:true });

      WIN.addEventListener('groups:power', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const c = (d.charge|0), th = Math.max(1, d.threshold|0);
        const pct = Math.round((c/th)*100);
        $('powerFill').style.width = pct + '%';
        $('powerText').textContent = `${c} / ${th}`;
      }, { passive:true });

      WIN.addEventListener('hha:coach', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        setCoach(d.text||'', d.mood||'neutral');
      }, { passive:true });

      // END
      WIN.addEventListener('hha:end', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        $('endScore').textContent = String(d.scoreFinal|0);
        $('endAcc').textContent = String(d.accuracyGoodPct|0) + '%';
        $('endMiss').textContent = String(d.misses|0);
        $('endRank').textContent = String(d.grade||'D');
        $('endSub').textContent = `diff:${d.diff||diff} time:${d.time||time}s seed:${d.seed||''}`;

        $('endOverlay').classList.remove('hidden');
      }, { passive:true });

      // initial text
      $('hudTime').textContent = String(time|0);

    })();
  </script>
</body>
</html>