<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR RUN ‚Äî PRODUCTION (HHA Standard)
‚úÖ Uses vr-ui.js (Enter VR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot {x,y,lockPx})
‚úÖ lockPx tuned for mobile/cVR (fix "‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏¢‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î")
‚úÖ effects-pack.js listens 'groups:hit' (FX back)
‚úÖ playLayer provides real spawn area (works with groups-vr.css)
‚úÖ Safe overlays + end summary hook point
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <style>
    /* tiny helpers for debug ring */
    #aimDebugRing{
      position: fixed;
      left: 0; top: 0;
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 2px dashed rgba(34,211,238,.85);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      pointer-events: none;
      transform: translate(-9999px,-9999px);
      opacity: 0;
      z-index: 58;
    }
  </style>

  <script>
    (function(){
      'use strict';
      const WIN = window;
      const DOC = document;

      const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
      const clamp = (v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));

      function isMobileUA(){
        const ua = (navigator.userAgent||'').toLowerCase();
        return /android|iphone|ipad|ipod|mobile/.test(ua);
      }
      function isQuestUA(){
        const ua = (navigator.userAgent||'').toLowerCase();
        return /oculus|quest/.test(ua);
      }

      // --- view detect (best-effort; respects explicit ?view= if user sets it) ---
      function detectView(){
        const forced = String(qs('view','')||'').toLowerCase();
        if(forced && forced !== 'auto') return forced;

        // If user is on Quest/VR UA => vr
        if(isQuestUA()) return 'vr';

        // If mobile => mobile (cvr must be explicit in URL because it's "strict")
        if(isMobileUA()) return 'mobile';

        return 'pc';
      }

      const view = detectView();
      DOC.body.classList.add('view-' + view);

      // =========================
      // ‚úÖ LOCKPX "‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏î"
      // =========================
      // URL overrides:
      // - ?lockPx=64   (hard override)
      // - ?aim=high|mid|low (preset)
      const aimPreset = String(qs('aim','')||'').toLowerCase();
      const lockFromUrl = qs('lockPx', null);

      function presetLockPx(){
        // tuned for kids + mobile accuracy
        // mobile/cvr: big assist (fix elementFromPoint misses)
        if(view === 'cvr') return 72;
        if(view === 'mobile') return 64;

        // vr: medium (crosshair stable)
        if(view === 'vr') return 34;

        // pc: small (mouse precise)
        return 24;
      }

      let lockPx = presetLockPx();

      if(aimPreset){
        if(aimPreset === 'high'){
          lockPx = (view === 'pc') ? 30 : (view === 'vr') ? 42 : 76;
        }else if(aimPreset === 'mid'){
          lockPx = (view === 'pc') ? 26 : (view === 'vr') ? 36 : 64;
        }else if(aimPreset === 'low'){
          lockPx = (view === 'pc') ? 18 : (view === 'vr') ? 28 : 52;
        }
      }

      if(lockFromUrl != null){
        lockPx = clamp(lockFromUrl, 0, 120);
      }

      // Expose config BEFORE vr-ui.js loads
      WIN.HHA_VRUI_CONFIG = Object.assign({}, WIN.HHA_VRUI_CONFIG || {}, {
        lockPx,
        cooldownMs: clamp(qs('cooldownMs', 90), 40, 220)
      });

      // Optional: show a small banner in console (debug)
      try{
        console.log('[GroupsVR] view=', view, 'lockPx=', WIN.HHA_VRUI_CONFIG.lockPx);
      }catch(_){}
    })();
  </script>

  <!-- Core packs (global) -->
  <script src="../vr/particles.js"></script>
  <script src="../vr/vr-ui.js"></script>

  <!-- GroupsVR packs -->
  <script src="./effects-pack.js"></script>
  <script src="./groups.safe.js"></script>
</head>

<body>

  <!-- Minimal A-Frame scene (behind DOM) for Enter VR reliability -->
  <div class="xr-scene" aria-hidden="true">
    <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true; colorManagement:true">
      <a-entity position="0 1.6 0"></a-entity>
      <a-sky color="#0b1222"></a-sky>
    </a-scene>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">TIME</span><span class="val" id="hudTime">--</span></div>
      <div class="pill"><span class="lbl">SCORE</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">COMBO</span><span class="val" id="hudCombo">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">RANK</span><span class="val" id="hudRank">-</span></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="goalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: -</span>
        <span class="tag" id="groupTag">-</span>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">0 / 0</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="miniTitle">MINI: -</span>
        <span class="tag" id="miniTag">‚è±</span>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">0 / 0</div>
    </div>
  </div>

  <!-- Big banner -->
  <div class="bigBanner hidden" id="bigBanner">
    <div class="bigBannerText" id="bigBannerText">READY</div>
  </div>

  <!-- Play layer -->
  <div class="playLayer" id="playLayer"></div>

  <!-- Power -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="pHead">POWER (‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°)</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerSub">0 / 0</div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" alt="Coach" src="../img/coach-neutral.png" id="coachImg"/>
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞/‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á‡πÄ‡∏•‡∏¢ üéØ</div>
      </div>
    </div>
  </div>

  <!-- Overlays -->
  <div class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">-</div>

      <div class="grid2">
        <div class="stat"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">ACCURACY</div><div class="v" id="endAcc">0%</div></div>
        <div class="stat"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
        <div class="stat"><div class="k">RANK</div><div class="v" id="endRank">-</div></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;">
        ‡∏ó‡∏¥‡∏õ: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πá‡∏á‡∏î‡πâ‡∏ß‡∏¢ <b>?lockPx=64</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>?aim=high</b>
      </div>
    </div>
  </div>

  <div id="aimDebugRing"></div>

  <script>
    (function(){
      'use strict';
      const WIN = window;
      const DOC = document;

      const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
      const clamp = (v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));

      // --- elements ---
      const $ = (id)=>DOC.getElementById(id);

      const hudTime  = $('hudTime');
      const hudScore = $('hudScore');
      const hudCombo = $('hudCombo');
      const hudAcc   = $('hudAcc');
      const hudRank  = $('hudRank');

      const goalTitle = $('goalTitle');
      const groupTag  = $('groupTag');
      const goalFill  = $('goalFill');
      const goalSub   = $('goalSub');

      const miniTitle = $('miniTitle');
      const miniTag   = $('miniTag');
      const miniFill  = $('miniFill');
      const miniSub   = $('miniSub');

      const powerFill = $('powerFill');
      const powerSub  = $('powerSub');

      const coachImg  = $('coachImg');
      const coachText = $('coachText');

      const endOverlay = $('endOverlay');
      const endSub     = $('endSub');
      const endScore   = $('endScore');
      const endAcc     = $('endAcc');
      const endMiss    = $('endMiss');
      const endRank    = $('endRank');

      const btnReplay  = $('btnReplay');
      const btnBackHub = $('btnBackHub');

      const aimDebug = String(qs('aimdebug','0')||'0') === '1';
      const ring = $('aimDebugRing');

      function showRing(x,y, r){
        if(!aimDebug || !ring) return;
        r = clamp(r, 0, 140);
        ring.style.width  = (r*2) + 'px';
        ring.style.height = (r*2) + 'px';
        ring.style.transform = `translate(${Math.round(x-r)}px,${Math.round(y-r)}px)`;
        ring.style.opacity = '1';
        ring.style.transition = 'opacity 180ms ease';
        setTimeout(()=>{ ring.style.opacity = '0'; }, 220);
      }

      // --- HUD events ---
      WIN.addEventListener('hha:time', (ev)=>{
        const left = (ev && ev.detail) ? Number(ev.detail.left)||0 : 0;
        hudTime.textContent = left + 's';
      }, { passive:true });

      WIN.addEventListener('hha:score', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudScore.textContent = Number(d.score)||0;
        hudCombo.textContent = Number(d.combo)||0;
      }, { passive:true });

      WIN.addEventListener('hha:rank', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        hudAcc.textContent = (Number(d.accuracy)||0) + '%';
        hudRank.textContent = String(d.grade||'-');
      }, { passive:true });

      WIN.addEventListener('hha:coach', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        coachText.textContent = String(d.text||'');
        const mood = String(d.mood||'neutral').toLowerCase();
        // match your files: coach-fever.png, coach-happy.png, coach-neutral.png, coach-sad.png
        const src =
          (mood === 'happy') ? '../img/coach-happy.png' :
          (mood === 'fever') ? '../img/coach-fever.png' :
          (mood === 'sad')   ? '../img/coach-sad.png' :
                               '../img/coach-neutral.png';
        coachImg.src = src;
      }, { passive:true });

      WIN.addEventListener('quest:update', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        groupTag.textContent = String(d.groupName||'-');

        goalTitle.textContent = String(d.goalTitle||'');
        goalSub.textContent = (Number(d.goalNow)||0) + ' / ' + (Number(d.goalTotal)||0);
        goalFill.style.width = clamp(d.goalPct,0,100) + '%';

        miniTitle.textContent = String(d.miniTitle||'');
        miniSub.textContent = (Number(d.miniNow)||0) + ' / ' + (Number(d.miniTotal)||0);
        miniFill.style.width = clamp(d.miniPct,0,100) + '%';

        const tl = Number(d.miniTimeLeftSec)||0;
        miniTag.textContent = tl>0 ? ('‚è± ' + tl + 's') : '‚è±';
        DOC.body.classList.toggle('mini-urgent', tl>0 && tl<=3);
      }, { passive:true });

      WIN.addEventListener('groups:power', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const c = Number(d.charge)||0;
        const th= Math.max(1, Number(d.threshold)||1);
        powerSub.textContent = c + ' / ' + th;
        powerFill.style.width = clamp((c/th)*100, 0, 100) + '%';
      }, { passive:true });

      // --- aimdebug hook ---
      WIN.addEventListener('hha:shoot', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        const x = Number(d.x)||0;
        const y = Number(d.y)||0;
        const lockPx = Number(d.lockPx)||0;
        showRing(x,y, lockPx);
      }, { passive:true });

      // --- end overlay ---
      let _lastSummary = null;
      WIN.addEventListener('hha:end', (ev)=>{
        const s = (ev && ev.detail) ? ev.detail : {};
        _lastSummary = s;

        endSub.textContent = `‡πÇ‡∏´‡∏°‡∏î: ${s.runMode||'-'} | diff: ${s.diff||'-'} | seed: ${s.seed||'-'}`;
        endScore.textContent = Number(s.scoreFinal)||0;
        endAcc.textContent = (Number(s.accuracyGoodPct)||0) + '%';
        endMiss.textContent = Number(s.misses)||0;
        endRank.textContent = String(s.grade||'-');

        endOverlay.classList.remove('hidden');
      }, { passive:true });

      btnReplay.addEventListener('click', ()=>{
        endOverlay.classList.add('hidden');
        try{
          WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.start &&
            WIN.GroupsVR.GameEngine.start(qs('diff','normal'), { time: qs('time', 90), seed: qs('seed', Date.now()), runMode: qs('run','play') });
        }catch(_){}
      });

      btnBackHub.addEventListener('click', ()=>{
        const hub = String(qs('hub','')||'');
        if(hub){
          location.href = hub;
        }else{
          history.back();
        }
      });

      // --- start engine ---
      function boot(){
        try{
          // ensure play layer is bound
          const layer = DOC.getElementById('playLayer');
          WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.setLayerEl && WIN.GroupsVR.GameEngine.setLayerEl(layer);

          // start
          const diff = String(qs('diff','normal')||'normal');
          const ctx = {
            time: qs('time', 90),
            seed: qs('seed', Date.now()),
            runMode: qs('run','play')
          };
          WIN.GroupsVR.GameEngine.start(diff, ctx);
        }catch(err){
          console.error(err);
          alert('GroupsVR boot error: ' + (err && err.message ? err.message : err));
        }
      }

      // slight delay to allow css/layout ready (prevents 0-size rect)
      setTimeout(boot, 80);
    })();
  </script>
</body>
</html>