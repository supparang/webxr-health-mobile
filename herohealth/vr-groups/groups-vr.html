<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />
  <link rel="stylesheet" href="./groups-vr.css" />
</head>

<body>
  <!-- HUD: left score/time, center quick pills, right goal/mini, coach bottom-right, power bottom -->
  <div class="hudTop" aria-label="HUD">
    <div class="hudBox hudLeft">
      <div class="hudKV">
        <div class="k">SCORE</div><div class="v" id="uiScore">0</div>
      </div>
      <div class="hudKV">
        <div class="k">TIME</div><div class="v"><span id="uiTime">90</span>s</div>
      </div>
    </div>

    <div class="hudCenter">
      <div class="pill">COMBO: <b id="uiCombo">0</b> <span class="muted">(MAX <b id="uiComboMax">0</b>)</span></div>
      <div class="pill">MISS: <b id="uiMiss">0</b></div>
      <div class="pill">GRADE: <b id="uiGrade">C</b></div>
      <div class="pill pillTiny" id="uiModePill">mode=play</div>
    </div>

    <div class="questRight" aria-label="Quest">
      <div class="qbar">
        <div class="t">GOAL</div>
        <div class="b" id="uiGoalTitle">‚Äî</div>
        <div class="p"><i id="uiGoalBar"></i></div>
      </div>
      <div class="qbar">
        <div class="t">MINI</div>
        <div class="b" id="uiMiniTitle">‚Äî</div>
        <div class="p"><i id="uiMiniBar"></i></div>
        <div class="time" id="uiMiniTime">‚è≥ 0s</div>
      </div>
    </div>
  </div>

  <!-- Gameplay Layer -->
  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <!-- Crosshair + lock ring -->
  <div class="crosshair" aria-hidden="true">
    <div class="chDot"></div>
    <div class="chRing" id="uiLockRing"></div>
    <div class="chLabel" id="uiAimLabel">gaze</div>
  </div>

  <!-- Power bar -->
  <div class="powerWrap" aria-label="Power">
    <div class="power"><i id="uiPowerBar"></i></div>
    <div class="powerLabel">
      <span>POWER</span>
      <span><b id="uiPower">0</b>/<b id="uiPowerThr">8</b></span>
    </div>
  </div>

  <!-- Coach bottom-right -->
  <div class="coachWrap" aria-label="Coach">
    <div class="coachCard">
      <div class="coachLine" id="uiCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! üéµ</div>
      <div class="feverMini"><i id="uiFeverBar"></i></div>
      <div class="shieldTag" id="uiShieldTag" style="display:none;">üõ°Ô∏è SHIELD READY</div>
      <div class="coachHint" id="uiCoachHint">‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠: ‡∏à‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á / ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á</div>
    </div>
    <div class="coachImg">
      <img id="uiCoachImg" src="../img/coach-neutral.png" alt="Coach"/>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</h2>
      <p id="startDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <div class="dbg">Boot: <b id="dbgBoot">loading‚Ä¶</b></div>
      <div class="warn" id="warnBox"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart">Start</button>
        <button id="btnBack" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div class="overlay" id="endOverlay">
    <div class="panel">
      <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="endReason"></p>

      <div class="kv">
        <div class="k">SCORE<b id="endScore">0</b></div>
        <div class="k">GRADE<b id="endGrade">C</b></div>
        <div class="k">ACCURACY<b id="endAcc">0%</b></div>
        <div class="k">COMBO MAX<b id="endComboMax">0</b></div>
      </div>

      <div class="row">
        <button id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" class="secondary">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);

    const runMode = (q.get('runMode') || 'play').toLowerCase();
    const diff    = (q.get('diff') || 'normal').toLowerCase();
    const style   = (q.get('style') || 'mix').toLowerCase();
    const time    = Number(q.get('time') || 90);
    const seed    = (q.get('seed') || '').trim() || String(Date.now());
    const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
    const autostart = q.get('autostart') === '1';
    const v = (q.get('v') || String(Date.now()));

    // ‚úÖ Aim/shoot settings
    const uiMode  = (q.get('ui') || 'auto').toLowerCase();     // auto|pc|mobile|vr
    const shoot   = (q.get('shoot') || 'gaze').toLowerCase();  // gaze|tap
    let dwellMs   = Math.max(280, Math.min(1200, Number(q.get('dwell') || 620)));
    let lockMs    = Math.max(60,  Math.min(350,  Number(q.get('lock')  || 160)));
    let radiusPx  = Math.max(40,  Math.min(140,  Number(q.get('radius')|| 86)));

    function inferUi(){
      const w = innerWidth || 360;
      const h = innerHeight || 640;
      if (w <= 520 || h <= 520) return 'mobile';
      return 'pc';
    }

    const ui = (uiMode === 'auto') ? inferUi() : uiMode;
    document.body.classList.toggle('ui-pc', ui === 'pc');
    document.body.classList.toggle('ui-mobile', ui === 'mobile');
    document.body.classList.toggle('ui-vr', ui === 'vr');

    $('uiModePill').textContent = `mode=${runMode} ‚Ä¢ ${diff} ‚Ä¢ ${style} ‚Ä¢ ui=${ui}`;
    $('uiAimLabel').textContent = shoot;

    $('startDesc').textContent =
      `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed} | shoot=${shoot} | lock=${lockMs}ms | dwell=${dwellMs}ms`;

    function warn(msg){
      console.warn(msg);
      const box = $('warnBox');
      if (!box) return;
      box.style.display = 'block';
      box.textContent += (box.textContent ? '\n' : '') + String(msg);
    }

    async function safeImport(path){
      try{
        await import(path + (path.includes('?') ? '' : ('?v='+encodeURIComponent(v))));
        return true;
      }catch(e){
        warn(`‚ö†Ô∏è load fail: ${path}\n${e?.message || e}`);
        return false;
      }
    }

    const BOOT_LIST = [
      './groups-fx.js',
      './audio.js',
      './groups-quests.js',
      './GameEngine.js',
    ];

    async function boot(){
      $('dbgBoot').textContent = 'loading modules‚Ä¶';
      for (const p of BOOT_LIST) await safeImport(p);
      $('dbgBoot').textContent = (window.GroupsVR && window.GroupsVR.GameEngine) ? 'READY ‚úÖ' : 'ENGINE NOT FOUND ‚ùå';
    }

    function flushHardened(reason){
      try{ window.HHACloudLogger?.flush?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushNow?.({ reason }); }catch{}
      try{ window.HHACloudLogger?.flushHardened?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flush?.({ reason }); }catch{}
      try{ window.GroupsVR?.Logger?.flushNow?.({ reason }); }catch{}
    }

    function goHub(){
      flushHardened('go_hub');
      location.href = hub;
    }
    $('btnBack').addEventListener('click', goHub);
    $('btnHub2').addEventListener('click', goHub);

    addEventListener('pagehide', ()=>flushHardened('pagehide'));
    addEventListener('beforeunload', ()=>flushHardened('beforeunload'));
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'hidden') flushHardened('hidden');
    });

    function bindEvents(){
      addEventListener('hha:score', (e)=>{
        const d = e.detail||{};
        $('uiScore').textContent = String(d.score ?? 0);
        $('uiCombo').textContent = String(d.combo ?? 0);
        $('uiComboMax').textContent = String(d.comboMax ?? 0);
        $('uiMiss').textContent = String(d.misses ?? 0);
      });

      addEventListener('hha:time', (e)=>{
        const d = e.detail||{};
        $('uiTime').textContent = String(d.left ?? 0);
      });

      addEventListener('groups:power', (e)=>{
        const d = e.detail||{};
        const ch = Number(d.charge||0);
        const thr = Math.max(1, Number(d.threshold||8));
        $('uiPower').textContent = String(ch);
        $('uiPowerThr').textContent = String(thr);
        $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
      });

      addEventListener('hha:rank', (e)=>{
        const d = e.detail||{};
        if (d.grade) $('uiGrade').textContent = String(d.grade);
      });

      // ‚úÖ Quest update: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (goalPct/miniPct) ‡∏´‡∏£‡∏∑‡∏≠ (goalNow/goalTotal)
      addEventListener('quest:update', (e)=>{
        const d = e.detail||{};
        if (d.goalTitle != null) $('uiGoalTitle').textContent = String(d.goalTitle);
        if (d.miniTitle != null) $('uiMiniTitle').textContent = String(d.miniTitle);

        let gp = (d.goalPct != null) ? Number(d.goalPct)
               : (d.goalNow != null && d.goalTotal != null) ? (Number(d.goalNow)/Math.max(1,Number(d.goalTotal)))*100
               : 0;

        let mp = (d.miniPct != null) ? Number(d.miniPct)
               : (d.miniNow != null && d.miniTotal != null) ? (Number(d.miniNow)/Math.max(1,Number(d.miniTotal)))*100
               : 0;

        $('uiGoalBar').style.width = Math.max(0, Math.min(100, gp)).toFixed(1)+'%';
        $('uiMiniBar').style.width = Math.max(0, Math.min(100, mp)).toFixed(1)+'%';

        const tLeft = Number(d.miniTimeLeftSec ?? 0);
        const timeEl = $('uiMiniTime');
        if (Number.isFinite(tLeft) && tLeft > 0){
          timeEl.style.display = 'block';
          timeEl.textContent = `‚è≥ ${tLeft}s`;
          document.body.classList.toggle('mini-urgent', tLeft <= 3);
        } else {
          timeEl.style.display = 'none';
          document.body.classList.remove('mini-urgent');
        }
      });

      addEventListener('hha:coach', (e)=>{
        const d = e.detail||{};
        if (d.text) $('uiCoachLine').textContent = String(d.text);
        const mood = String(d.mood||'neutral');
        const img = (mood==='happy') ? '../img/coach-happy.png'
                 : (mood==='sad')   ? '../img/coach-sad.png'
                 : (mood==='fever') ? '../img/coach-fever.png'
                 : '../img/coach-neutral.png';
        $('uiCoachImg').src = img;
      });

      addEventListener('hha:fever', (e)=>{
        const d = e.detail||{};
        const pct = Math.max(0, Math.min(100, Number(d.feverPct||0)));
        $('uiFeverBar').style.width = pct.toFixed(1)+'%';
        const shield = Number(d.shield||0) > 0;
        $('uiShieldTag').style.display = shield ? 'inline-flex' : 'none';
      });

      addEventListener('hha:end', (e)=>{
        const d = e.detail||{};
        $('endOverlay').classList.add('show');
        $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
        $('endScore').textContent = String(d.scoreFinal ?? 0);
        $('endGrade').textContent = String(d.grade ?? 'C');
        $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
        $('endComboMax').textContent = String(d.comboMax ?? 0);
        $('uiGrade').textContent = String(d.grade ?? 'C');

        try{
          const payload = {
            game: 'GroupsVR',
            ts: new Date().toISOString(),
            ...d,
            params: { runMode, diff, style, time, seed, hub, ui, shoot, dwellMs, lockMs, radiusPx }
          };
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
          localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));
        }catch{}

        flushHardened('end');
      });
    }

    function waitEngineReady(){
      return new Promise((resolve)=>{
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;
          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            resolve(GE);
          }
          if (tries > 250){
            clearInterval(t);
            warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GroupsVR.GameEngine.start() ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ 200 ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏£‡∏á');
            $('dbgBoot').textContent = 'ENGINE NOT FOUND ‚ùå';
          }
        }, 80);
      });
    }

    // ===========================
    // ‚úÖ Aim/Shoot System (crosshair)
    // - gaze: lock -> dwell -> fire
    // - tap : tap anywhere -> fire at locked/closest
    // ===========================
    const Aim = {
      running:false,
      layer:null,
      lockedEl:null,
      lockT:0,
      dwellT:0,
      lastT:0,
      burstUntil:0,
      perfectStreak:0,
      lastLockedId:'',
      lastLockStable:false,
    };

    function getShift(){
      const layer = Aim.layer;
      if (!layer) return { vx:0, vy:0 };
      const vx = parseFloat(layer.style.getPropertyValue('--vx')) || 0;
      const vy = parseFloat(layer.style.getPropertyValue('--vy')) || 0;
      return { vx, vy };
    }

    function center(){
      return { cx:(innerWidth||360)*0.5, cy:(innerHeight||640)*0.5 };
    }

    function findCandidate(){
      const layer = Aim.layer;
      if (!layer) return null;

      const { cx, cy } = center();
      const { vx, vy } = getShift();
      const list = layer.querySelectorAll('.fg-target');
      let best = null;
      let bestD = 1e9;

      for (const el of list){
        // ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å dataset (‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô engine)
        const x0 = parseFloat(el.dataset._x || el.dataset.x || 'NaN');
        const y0 = parseFloat(el.dataset._y || el.dataset.y || 'NaN');
        if (!Number.isFinite(x0) || !Number.isFinite(y0)) continue;

        const x = x0 + vx;
        const y = y0 + vy;
        const dx = x - cx;
        const dy = y - cy;
        const d = Math.hypot(dx,dy);

        if (d < bestD){
          bestD = d;
          best = el;
        }
      }

      if (best && bestD <= radiusPx) return best;
      return null;
    }

    function setLockVisual(p){
      // p = 0..1
      const ring = $('uiLockRing');
      ring.style.setProperty('--p', String(Math.max(0,Math.min(1,p))));
      document.body.classList.toggle('aim-lock', p >= 1);
    }

    function fire(el, source='gaze'){
      if (!el || !el.isConnected) return false;

      // perfect-lock bonus: ‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á lock ‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏õ‡πâ‡∏≤)
      if (Aim.lastLockStable){
        Aim.perfectStreak++;
        window.dispatchEvent(new CustomEvent('groups:progress',{ detail:{ kind:'perfect_lock', source } }));
        window.dispatchEvent(new CustomEvent('hha:judge',{ detail:{ kind:'good', text:'PERFECT LOCK!' } }));
      } else {
        Aim.perfectStreak = 0;
      }

      // burst: perfect 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î -> ‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏¥‡∏á‡πÇ‡∏´‡∏î
      if (Aim.perfectStreak >= 3){
        Aim.burstUntil = performance.now() + 4500;
        Aim.perfectStreak = 0;
        document.body.classList.add('groups-burst');
        setTimeout(()=>document.body.classList.remove('groups-burst'), 4700);
        window.dispatchEvent(new CustomEvent('hha:judge',{ detail:{ kind:'boss', text:'BURST MODE!' } }));
      }

      // ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ dispatch pointerdown (‡πÉ‡∏ä‡πâ handler ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á target)
      try{
        const { cx, cy } = center();
        el.dispatchEvent(new PointerEvent('pointerdown', { bubbles:true, cancelable:true, clientX:cx, clientY:cy }));
        return true;
      }catch{
        try{
          el.dispatchEvent(new Event('pointerdown', { bubbles:true, cancelable:true }));
          return true;
        }catch{}
      }
      return false;
    }

    function shootNow(source='tap'){
      const cand = Aim.lockedEl && Aim.lockedEl.isConnected ? Aim.lockedEl : findCandidate();
      if (!cand) return;
      // ‡∏¢‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ lock ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°)
      if (Aim.lockT < lockMs) return;
      fire(cand, source);
      Aim.dwellT = 0;
      setLockVisual(0);
    }

    function aimLoop(ts){
      if (!Aim.running) return;
      const t = ts || performance.now();
      const dt = Aim.lastT ? (t - Aim.lastT) : 16;
      Aim.lastT = t;

      const cand = findCandidate();
      const same = (cand && Aim.lockedEl && cand === Aim.lockedEl);
      const inBurst = (t < Aim.burstUntil);
      const dwellEff = inBurst ? Math.max(220, dwellMs*0.55) : dwellMs;
      const lockEff  = inBurst ? Math.max(80,  lockMs*0.70)  : lockMs;

      if (!cand){
        Aim.lockedEl = null;
        Aim.lockT = 0;
        Aim.dwellT = 0;
        Aim.lastLockStable = false;
        setLockVisual(0);
        requestAnimationFrame(aimLoop);
        return;
      }

      if (!same){
        Aim.lockedEl = cand;
        Aim.lockT = 0;
        Aim.dwellT = 0;
        Aim.lastLockedId = cand.dataset.uid || '';
        Aim.lastLockStable = true;
      } else {
        Aim.lockT += dt;
      }

      // lock progress
      const lp = Math.max(0, Math.min(1, Aim.lockT / lockEff));
      setLockVisual(lp);

      // when locked
      if (Aim.lockT >= lockEff){
        // gaze: dwell ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á
        if (shoot === 'gaze'){
          Aim.dwellT += dt;
          const dp = Math.max(0, Math.min(1, Aim.dwellT / dwellEff));
          document.body.style.setProperty('--aim-dwell', String(dp));
          if (Aim.dwellT >= dwellEff){
            fire(cand, 'gaze');
            Aim.dwellT = 0;
            Aim.lockT = 0;
            setLockVisual(0);
          }
        }
      } else {
        Aim.dwellT = 0;
        document.body.style.setProperty('--aim-dwell', '0');
      }

      requestAnimationFrame(aimLoop);
    }

    function bindShootControls(){
      // tap-to-shoot: ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡∏ñ‡πâ‡∏≤ lock ‡πÄ‡∏ï‡πá‡∏°)
      if (shoot === 'tap'){
        document.addEventListener('pointerdown', (ev)=>{
          // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°/overlay ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á
          const t = ev.target;
          if (t && (t.closest && t.closest('.overlay,button,input,select'))) return;
          shootNow('tap');
        }, { passive:true });
      }
    }

    async function startGame(){
      $('btnStart').disabled = true;
      $('startDesc').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‚Ä¶';

      await boot();
      const GE = await waitEngineReady();
      if (!GE){ $('btnStart').disabled = false; return; }

      const layer = $('fg-layer');
      GE.setLayerEl(layer);
      GE.start(diff, { runMode, style, time, seed });

      // Aim init
      Aim.layer = layer;
      Aim.running = true;
      Aim.lockedEl = null;
      Aim.lockT = 0; Aim.dwellT = 0; Aim.lastT = 0;
      Aim.perfectStreak = 0; Aim.burstUntil = 0;
      bindShootControls();
      requestAnimationFrame(aimLoop);

      $('uiCoachHint').textContent =
        (shoot === 'gaze')
          ? `‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠: ‡∏•‡πá‡∏≠‡∏Å ${lockMs}ms + ‡∏à‡πâ‡∏≠‡∏á ${dwellMs}ms`
          : `‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å ${lockMs}ms ‡∏Å‡πà‡∏≠‡∏ô)`;

      $('startOverlay').style.display = 'none';
      $('endOverlay').classList.remove('show');
      $('btnStart').disabled = false;
    }

    $('btnStart').addEventListener('click', startGame);
    $('btnReplay').addEventListener('click', ()=>{
      try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
      Aim.running = false;
      $('endOverlay').classList.remove('show');
      $('startOverlay').style.display = 'grid';
      if (autostart) setTimeout(startGame, 250);
    });

    bindEvents();
    await boot();
    if (autostart) setTimeout(()=> $('btnStart').click(), 350);
  </script>
</body>
</html>