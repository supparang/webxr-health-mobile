<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Food Groups VR ‚Äî Run</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />
  <link rel="stylesheet" href="./groups-vr.css" />
</head>

<body>
  <div class="hud">
    <div class="box">
      <div class="big" id="uiScore">0</div>
      <div class="small">SCORE</div>
    </div>
    <div class="box" style="text-align:right;">
      <div class="big"><span id="uiTime">90</span>s</div>
      <div class="small">TIME</div>
    </div>
  </div>

  <div class="centerTop">
    <div class="pill">COMBO: <b id="uiCombo">0</b> (MAX <b id="uiComboMax">0</b>)</div>
    <div class="pill">MISS: <b id="uiMiss">0</b></div>
    <div class="pill">GRADE: <b id="uiGrade">C</b></div>
  </div>

  <div class="questTop" aria-label="Quest">
    <div class="qbar">
      <div class="t">GOAL</div>
      <div class="b" id="uiGoalTitle">‚Äî</div>
      <div class="p"><i id="uiGoalBar"></i></div>
    </div>
    <div class="qbar">
      <div class="t">MINI</div>
      <div class="b" id="uiMiniTitle">‚Äî</div>
      <div class="p"><i id="uiMiniBar"></i></div>
      <div class="time" id="uiMiniTime">‚è≥ 0s</div>
    </div>
  </div>

  <div id="fg-layer" class="fg-layer" aria-label="Food Groups Layer"></div>

  <div class="powerWrap">
    <div class="power"><i id="uiPowerBar"></i></div>
    <div class="powerLabel">
      <span>POWER</span>
      <span><b id="uiPower">0</b>/<b id="uiPowerThr">8</b></span>
    </div>
  </div>

  <div class="coachWrap" aria-label="Coach">
    <div class="coachCard">
      <div class="coachLine" id="uiCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! üéµ</div>
      <div class="feverMini"><i id="uiFeverBar"></i></div>
      <div class="shieldTag" id="uiShieldTag" style="display:none;">üõ°Ô∏è SHIELD READY</div>
    </div>
    <div class="coachImg">
      <img id="uiCoachImg" src="../img/coach-neutral.png" alt="Coach"/>
    </div>
  </div>

  <div class="overlay" id="startOverlay" style="
    position:fixed; inset:0; display:grid; place-items:center; z-index:200;
    background:radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 60%),
               radial-gradient(circle at bottom right, rgba(34,197,94,.18), transparent 60%),
               rgba(2,6,23,.82);
  ">
    <div class="panel" style="
      width:min(760px, 92vw);
      border:1px solid rgba(148,163,184,.20);
      border-radius:22px;
      background:rgba(2,6,23,.72);
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      padding:18px 18px 14px;
    ">
      <h2 style="margin:0 0 8px; font-size:20px;">üöÄ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Food Groups VR</h2>
      <p id="startDesc" style="margin:0 0 12px; color:rgba(148,163,184,1); font-size:13px; line-height:1.6;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <div style="font-size:12px; color:rgba(148,163,184,1); opacity:.92;">Boot: <b id="dbgBoot">loading‚Ä¶</b></div>
      <div id="warnBox" style="
        margin-top:10px; padding:10px 12px; border-radius:16px;
        border:1px solid rgba(239,68,68,.25);
        background:rgba(239,68,68,.08);
        color:rgba(254,226,226,.95);
        font-size:12px; display:none; white-space:pre-wrap;
      "></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="btnStart" style="
          border:0; border-radius:999px; padding:12px 14px; font-weight:900; cursor:pointer;
          background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
          color:#061018;
        ">Start</button>

        <button id="btnBack" style="
          border-radius:999px; padding:12px 14px; font-weight:900; cursor:pointer;
          background:rgba(15,23,42,.78); border:1px solid rgba(148,163,184,.18); color:#e5e7eb;
        ">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="endOverlay" style="display:none; position:fixed; inset:0; place-items:center; z-index:220;
    background:radial-gradient(circle at top left, rgba(56,189,248,.10), transparent 60%),
               radial-gradient(circle at bottom right, rgba(34,197,94,.10), transparent 60%),
               rgba(2,6,23,.84);
  ">
    <div class="panel" style="
      width:min(760px, 92vw);
      border:1px solid rgba(148,163,184,.20);
      border-radius:22px;
      background:rgba(2,6,23,.72);
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      padding:18px 18px 14px;
    ">
      <h2 style="margin:0 0 8px; font-size:20px;">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="endReason" style="margin:0 0 12px; color:rgba(148,163,184,1); font-size:13px; line-height:1.6;"></p>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 12px;">
        <div style="border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.55); border-radius:16px; padding:10px 12px; font-size:13px;">
          SCORE<b id="endScore" style="display:block; font-size:16px; margin-top:2px;">0</b>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.55); border-radius:16px; padding:10px 12px; font-size:13px;">
          GRADE<b id="endGrade" style="display:block; font-size:16px; margin-top:2px;">C</b>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.55); border-radius:16px; padding:10px 12px; font-size:13px;">
          ACCURACY<b id="endAcc" style="display:block; font-size:16px; margin-top:2px;">0%</b>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.55); border-radius:16px; padding:10px 12px; font-size:13px;">
          COMBO MAX<b id="endComboMax" style="display:block; font-size:16px; margin-top:2px;">0</b>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnReplay" style="
          border:0; border-radius:999px; padding:12px 14px; font-weight:900; cursor:pointer;
          background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
          color:#061018;
        ">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnHub2" style="
          border-radius:999px; padding:12px 14px; font-weight:900; cursor:pointer;
          background:rgba(15,23,42,.78); border:1px solid rgba(148,163,184,.18); color:#e5e7eb;
        ">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Shared: VR UI (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°) -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- ‚úÖ Groups modules -->
  <script src="./audio.js" defer></script>
  <script src="./groups-quests.js" defer></script>
  <script src="./GameEngine.js" defer></script>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);

    const runMode = (q.get('runMode') || 'play').toLowerCase();
    const diff    = (q.get('diff') || 'normal').toLowerCase();
    const style   = (q.get('style') || 'mix').toLowerCase();
    const time    = Number(q.get('time') || 90);
    const seed    = (q.get('seed') || '').trim() || String(Date.now());
    const hub     = (q.get('hub') || '../index.html').trim() || '../index.html';
    const autostart = q.get('autostart') === '1';

    $('startDesc').textContent = `mode=${runMode} | diff=${diff} | style=${style} | time=${time}s | seed=${seed}`;

    function warn(msg){
      console.warn(msg);
      const box = $('warnBox');
      box.style.display = 'block';
      box.textContent += (box.textContent ? '\n' : '') + String(msg);
    }

    // ‚úÖ mount shared VR UI (‡∏õ‡∏∏‡πà‡∏° Enter VR + tapshoot + crosshair)
    function mountVRUI(){
      try{ window.HHAVRUI?.mount?.({ lockPx: 92 }); }catch{}
    }

    function goHub(){ location.href = hub; }
    $('btnBack').addEventListener('click', goHub);
    $('btnHub2').addEventListener('click', goHub);

    function bindEvents(){
      addEventListener('hha:score', (e)=>{
        const d = e.detail||{};
        $('uiScore').textContent = String(d.score ?? 0);
        $('uiCombo').textContent = String(d.combo ?? 0);
        $('uiComboMax').textContent = String(d.comboMax ?? 0);
        $('uiMiss').textContent = String(d.misses ?? 0);
      });
      addEventListener('hha:time', (e)=>{
        const d = e.detail||{};
        $('uiTime').textContent = String(d.left ?? 0);
      });
      addEventListener('groups:power', (e)=>{
        const d = e.detail||{};
        const ch = Number(d.charge||0);
        const thr = Math.max(1, Number(d.threshold||8));
        $('uiPower').textContent = String(ch);
        $('uiPowerThr').textContent = String(thr);
        $('uiPowerBar').style.width = (Math.min(1, ch/thr)*100).toFixed(1) + '%';
      });
      addEventListener('hha:rank', (e)=>{
        const d = e.detail||{};
        if (d.grade) $('uiGrade').textContent = String(d.grade);
      });

      addEventListener('quest:update', (e)=>{
        const d = e.detail||{};
        if (d.goalTitle != null) $('uiGoalTitle').textContent = String(d.goalTitle);
        if (d.miniTitle != null) $('uiMiniTitle').textContent = String(d.miniTitle);

        let gp = (d.goalPct != null) ? Number(d.goalPct)
               : (d.goalNow != null && d.goalTotal != null) ? (Number(d.goalNow)/Math.max(1,Number(d.goalTotal)))*100 : 0;
        let mp = (d.miniPct != null) ? Number(d.miniPct)
               : (d.miniNow != null && d.miniTotal != null) ? (Number(d.miniNow)/Math.max(1,Number(d.miniTotal)))*100 : 0;

        $('uiGoalBar').style.width = Math.max(0, Math.min(100, gp)).toFixed(1)+'%';
        $('uiMiniBar').style.width = Math.max(0, Math.min(100, mp)).toFixed(1)+'%';

        const tLeft = Number(d.miniTimeLeftSec ?? 0);
        const timeEl = $('uiMiniTime');
        if (Number.isFinite(tLeft) && tLeft > 0){
          timeEl.style.display = 'block';
          timeEl.textContent = `‚è≥ ${tLeft}s`;
        } else {
          timeEl.style.display = 'none';
        }

        // ‚úÖ visual urgent helper
        document.body.classList.toggle('mini-urgent', tLeft > 0 && tLeft <= 3);
      });

      addEventListener('hha:coach', (e)=>{
        const d = e.detail||{};
        if (d.text) $('uiCoachLine').textContent = String(d.text);
        const mood = String(d.mood||'neutral');
        const img = (mood==='happy') ? '../img/coach-happy.png'
                 : (mood==='sad')   ? '../img/coach-sad.png'
                 : (mood==='fever') ? '../img/coach-fever.png'
                 : '../img/coach-neutral.png';
        $('uiCoachImg').src = img;
      });

      addEventListener('hha:fever', (e)=>{
        const d = e.detail||{};
        const pct = Math.max(0, Math.min(100, Number(d.feverPct||0)));
        $('uiFeverBar').style.width = pct.toFixed(1)+'%';
        const shield = Number(d.shield||0) > 0;
        $('uiShieldTag').style.display = shield ? 'inline-flex' : 'none';
      });

      addEventListener('hha:end', (e)=>{
        const d = e.detail||{};
        $('endOverlay').style.display = 'grid';
        $('endReason').textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.reason || '-'}`;
        $('endScore').textContent = String(d.scoreFinal ?? 0);
        $('endGrade').textContent = String(d.grade ?? 'C');
        $('endAcc').textContent = String(d.accuracyGoodPct ?? 0) + '%';
        $('endComboMax').textContent = String(d.comboMax ?? 0);
        $('uiGrade').textContent = String(d.grade ?? 'C');

        try{
          const payload = {
            game: 'GroupsVR',
            ts: new Date().toISOString(),
            ...d,
            params: { runMode, diff, style, time, seed, hub }
          };
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
          localStorage.setItem('HHA_LAST_SUMMARY_GROUPS', JSON.stringify(payload));
        }catch{}
      });
    }

    function waitEngineReady(){
      return new Promise((resolve)=>{
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          const GE = window.GroupsVR && window.GroupsVR.GameEngine;
          if (GE && typeof GE.start === 'function' && typeof GE.setLayerEl === 'function'){
            clearInterval(t);
            resolve(GE);
          }
          if (tries > 250){
            clearInterval(t);
            warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GroupsVR.GameEngine.start() ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ GameEngine.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ 200 ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏£‡∏á');
            $('dbgBoot').textContent = 'ENGINE NOT FOUND ‚ùå';
          }
        }, 80);
      });
    }

    async function startGame(){
      // ‚úÖ unlock audio + mount VR UI (‡∏õ‡∏∏‡πà‡∏° Enter VR + tapshoot)
      try{ window.GroupsVR?.Audio?.unlock?.(); }catch{}
      mountVRUI();

      $('btnStart').disabled = true;
      $('dbgBoot').textContent = 'starting‚Ä¶';

      const GE = await waitEngineReady();
      if (!GE){ $('btnStart').disabled = false; return; }

      GE.setLayerEl($('fg-layer'));
      GE.start(diff, { runMode, style, time, seed });

      $('startOverlay').style.display = 'none';
      $('endOverlay').style.display = 'none';
      $('btnStart').disabled = false;
      $('dbgBoot').textContent = 'READY ‚úÖ';
    }

    $('btnStart').addEventListener('click', startGame);
    $('btnReplay').addEventListener('click', ()=>{
      try{ window.GroupsVR?.GameEngine?.stop?.('replay'); }catch{}
      $('endOverlay').style.display = 'none';
      $('startOverlay').style.display = 'grid';
      if (autostart) setTimeout(startGame, 250);
    });

    bindEvents();
    $('dbgBoot').textContent = 'READY ‚úÖ';
    if (autostart) setTimeout(startGame, 350);
  </script>
</body>
</html>