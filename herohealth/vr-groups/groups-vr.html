<!-- PATCH for /herohealth/vr-groups/groups-vr.html
Add: Back HUB + Copy JSON on end overlay
-->
<!-- ... (р╕кр╣Ир╕зр╕Щр╕Ър╕Щр╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б) ... -->

<!-- End Overlay -->
<div id="endOverlay" class="overlay overlay-end hidden">
  <div class="panel">
    <div class="title">ЁЯПБ р╕Ир╕Ър╣Ар╕Бр╕б</div>
    <div id="endLine" class="sub">тАФ</div>

    <div class="grid2">
      <div class="stat"><div class="k">Score</div><div id="endScore" class="v">0</div></div>
      <div class="stat"><div class="k">Rank</div><div id="endRank" class="v">C</div></div>
      <div class="stat"><div class="k">Accuracy</div><div id="endAcc" class="v">0%</div></div>
      <div class="stat"><div class="k">Miss</div><div id="endMiss" class="v">0</div></div>
    </div>

    <div class="row row2">
      <button id="btnRestart" class="btn btn-strong">ЁЯФБ р╣Ар╕ер╣Ир╕Щр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З</button>
      <button id="btnBack" class="btn btn-ghost">тмЕя╕П р╕Бр╕ер╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╣Ар╕ер╕╖р╕нр╕Бр╣Вр╕лр╕бр╕Ф</button>
    </div>

    <div class="row row2">
      <button id="btnCopyJson" class="btn">ЁЯУЛ Copy JSON</button>
      <button id="btnHub" class="btn btn-ghost">ЁЯПа р╕Бр╕ер╕▒р╕Ъ HUB</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  const $ = (id)=>document.getElementById(id);
  let lastSummary = null;

  function qs(k, def=null){
    try { return new URL(location.href).searchParams.get(k) ?? def; }
    catch { return def; }
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(String(text||''));
      return true;
    }catch{
      try{
        const ta = document.createElement('textarea');
        ta.value = String(text||'');
        document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        ta.remove();
        return true;
      }catch{ return false; }
    }
  }

  // show/hide hub button
  function syncHubBtn(){
    const hub = String(qs('hub','')||'');
    const btn = $('btnHub');
    if (!btn) return;
    btn.style.display = hub ? 'inline-flex' : 'none';
  }
  syncHubBtn();

  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail||{};
    lastSummary = d;

    $('endOverlay').classList.remove('hidden');
    $('endLine').textContent = 'р╣Ар╕лр╕Хр╕╕р╕Ьр╕е: ' + String(d.reason || 'end');

    $('endScore').textContent = String(d.scoreFinal ?? 0);
    $('endRank').textContent  = String(d.grade ?? 'C');
    $('endAcc').textContent   = String((d.accuracyGoodPct ?? 0) + '%');
    $('endMiss').textContent  = String(d.misses ?? 0);

    syncHubBtn();
  }, {passive:true});

  $('btnCopyJson')?.addEventListener('click', async ()=>{
    const s = lastSummary || (()=>{ try{ return JSON.parse(localStorage.getItem('HHA_LAST_SUMMARY')||'null'); }catch{ return null; } })();
    if (!s){ alert('р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Ьр╕ер╣Гр╕лр╣Йр╕Др╕▒р╕Фр╕ер╕нр╕Б'); return; }
    const ok = await copyText(JSON.stringify(s, null, 2));
    if (ok) alert('р╕Др╕▒р╕Фр╕ер╕нр╕Б JSON р╣Бр╕ер╣Йр╕з тЬЕ');
  });

  $('btnHub')?.addEventListener('click', ()=>{
    const hub = String(qs('hub','')||'');
    if (!hub){ alert('р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕кр╣Ир╕Зр╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М hub=...'); return; }
    location.href = hub;
  });

})();
</script>