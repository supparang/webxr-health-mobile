<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR Run ‚Äî PRODUCTION (HHA Standard) ‚Äî PATCH LOCKPX ULTIMATE
‚úÖ lockPx tuned by view (mobile/cvr/vr/pc)
‚úÖ uses /herohealth/vr/vr-ui.js => emits hha:shoot {x,y,lockPx,source}
‚úÖ wires HUD/Quest/Coach/Power events
‚úÖ loads effects-pack.js (groups:hit) + (optional) particles.js
‚úÖ starts engine automatically (no tap-to-start)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame (optional, behind DOM) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
  (function(){
    'use strict';
    const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
    const v = String(qs('view','')||'').toLowerCase();

    // Apply body view classes early (CSS layout depends on this)
    function applyViewClass(){
      const b = document.body;
      if(!b) return;
      b.classList.remove('view-pc','view-mobile','view-vr','view-cvr','cardboard');
      if(v === 'pc') b.classList.add('view-pc');
      else if(v === 'vr') b.classList.add('view-vr');
      else if(v === 'cvr') { b.classList.add('view-cvr'); b.classList.add('cardboard'); }
      else b.classList.add('view-mobile');
    }

    // lockPx ‚Äú‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏î‚Äù (‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á)
    function pickLockPx(){
      if(v === 'cvr') return 54;
      if(v === 'vr')  return 44;
      if(v === 'pc')  return 26;
      return 44; // mobile default
    }

    // Provide config BEFORE loading vr-ui.js
    window.HHA_VRUI_CONFIG = Object.assign({}, window.HHA_VRUI_CONFIG || {}, {
      lockPx: pickLockPx(),
      cooldownMs: 70
    });

    // Expose for debug
    window.__HHA_VIEW__ = v || 'mobile';
    window.__HHA_LOCKPX__ = window.HHA_VRUI_CONFIG.lockPx;

    // Apply ASAP + again on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', applyViewClass);
    applyViewClass();
  })();
  </script>
</head>

<body>
  <!-- XR Scene behind DOM -->
  <a-scene class="xr-scene" embedded vr-mode-ui="enabled: false" renderer="colorManagement:true; physicallyCorrectLights:false">
    <a-entity position="0 1.6 -2"></a-entity>
  </a-scene>

  <!-- ===================== HUD TOP ===================== -->
  <div class="hud" aria-hidden="true">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤</span><span class="val" id="hudTime">--</span></div>
      <div class="pill"><span class="lbl">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">üî• ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span><span class="val" id="hudCombo">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">‚ùå MISS</span><span class="val" id="hudMiss">0</span></div>
      <div class="pill"><span class="lbl">üéñÔ∏è Rank</span><span class="val" id="hudRank">-</span></div>
    </div>
  </div>

  <!-- ===================== QUEST TOP ===================== -->
  <div class="questTop" aria-hidden="true">
    <!-- GOAL -->
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>
        <div class="tag" id="groupTag">‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="bar"><div class="fill" id="goalFill"></div></div>
      <div class="qSub" id="goalSub">0/0</div>
    </div>

    <!-- MINI -->
    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">MINI</div>
        <div class="tag" id="miniTag">‚è≥</div>
      </div>
      <div class="bar"><div class="fill" id="miniFill"></div></div>
      <div class="qSub" id="miniSub">0/0</div>
    </div>
  </div>

  <!-- ===================== BIG BANNER ===================== -->
  <div class="bigBanner hidden" id="bigBanner" aria-hidden="true">
    <div class="bigBannerText" id="bigBannerText">READY</div>
  </div>

  <!-- ===================== PLAY LAYER (IMPORTANT) ===================== -->
  <div id="playLayer" class="playLayer" aria-label="play-layer"></div>

  <!-- ===================== POWER (BOTTOM MID) ===================== -->
  <div class="powerWrap" aria-hidden="true">
    <div class="powerCard">
      <div class="pHead" id="powerTitle">‡∏û‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏™‡∏°</div>
      <div class="bar powerBar"><div class="fill" id="powerFill"></div></div>
      <div class="pFoot" id="powerSub">0/0</div>
    </div>
  </div>

  <!-- ===================== COACH (BOTTOM LEFT) ===================== -->
  <div class="coachWrap" aria-hidden="true">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" src="../img/coach-neutral.png" alt="coach"/>
      <div class="coachBubble">
        <div class="coachName" id="coachName">Coach</div>
        <div class="coachText" id="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! üéØ</div>
      </div>
    </div>
  </div>

  <!-- ===================== OVERLAY: END (optional) ===================== -->
  <div class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>

      <div class="grid2">
        <div class="stat"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="endScore">0</div></div>
        <div class="stat"><div class="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô (Good)</div><div class="v" id="endAcc">0%</div></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="note" style="margin-top:10px;" id="endNote"></div>
    </div>
  </div>

  <!-- ===================== SCRIPTS ===================== -->

  <!-- Optional particles layer (if you have it). If 404, it won't break. -->
  <script src="../vr/particles.js"></script>

  <!-- Universal VR UI (must be after HHA_VRUI_CONFIG is set) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- FX pack: listens groups:hit -->
  <script src="./effects-pack.js"></script>

  <!-- Engine -->
  <script src="./groups.safe.js"></script>

  <script>
  (function(){
    'use strict';

    const WIN = window;
    const DOC = document;

    const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };

    // --- DOM refs ---
    const $ = (id)=>DOC.getElementById(id);

    const hudTime  = $('hudTime');
    const hudScore = $('hudScore');
    const hudCombo = $('hudCombo');
    const hudMiss  = $('hudMiss');
    const hudRank  = $('hudRank');

    const goalTitle = $('goalTitle');
    const groupTag  = $('groupTag');
    const goalFill  = $('goalFill');
    const goalSub   = $('goalSub');

    const miniTitle = $('miniTitle');
    const miniTag   = $('miniTag');
    const miniFill  = $('miniFill');
    const miniSub   = $('miniSub');

    const powerTitle = $('powerTitle');
    const powerFill  = $('powerFill');
    const powerSub   = $('powerSub');

    const coachImg  = $('coachImg');
    const coachText = $('coachText');

    const bigBanner = $('bigBanner');
    const bigBannerText = $('bigBannerText');

    const endOverlay = $('endOverlay');
    const endSub = $('endSub');
    const endScore = $('endScore');
    const endAcc = $('endAcc');
    const endNote = $('endNote');
    const btnReplay = $('btnReplay');
    const btnBackHub = $('btnBackHub');

    const playLayer = $('playLayer');

    function pad2(n){ n = (n|0); return (n<10?('0'+n):String(n)); }
    function fmtTime(sec){
      sec = Math.max(0, sec|0);
      const m = (sec/60)|0;
      const s = sec%60;
      return m + ':' + pad2(s);
    }

    function showBanner(text, tone){
      if(!bigBanner || !bigBannerText) return;
      bigBannerText.textContent = String(text||'');
      bigBanner.classList.remove('hidden','tone-neutral','tone-good','tone-warn','tone-bad','show');
      bigBanner.classList.add('tone-' + (tone||'neutral'));
      // animate
      requestAnimationFrame(()=> bigBanner.classList.add('show'));
      setTimeout(()=>{
        try{
          bigBanner.classList.remove('show');
          setTimeout(()=> bigBanner.classList.add('hidden'), 180);
        }catch(_){}
      }, 900);
    }

    function setCoachMood(mood){
      // your coach files: coach-fever.png, coach-happy.png, coach-neutral.png, coach-sad.png
      const m = String(mood||'neutral').toLowerCase();
      let src = '../img/coach-neutral.png';
      if(m === 'happy') src = '../img/coach-happy.png';
      else if(m === 'fever') src = '../img/coach-fever.png';
      else if(m === 'sad') src = '../img/coach-sad.png';
      if(coachImg) coachImg.src = src;
    }

    // --- Event wiring ---
    WIN.addEventListener('hha:time', (ev)=>{
      const d = ev.detail||{};
      if(hudTime) hudTime.textContent = fmtTime(d.left ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:score', (ev)=>{
      const d = ev.detail||{};
      if(hudScore) hudScore.textContent = String(d.score ?? 0);
      if(hudCombo) hudCombo.textContent = String(d.combo ?? 0);
      if(hudMiss)  hudMiss.textContent  = String(d.misses ?? 0);
    }, { passive:true });

    WIN.addEventListener('hha:rank', (ev)=>{
      const d = ev.detail||{};
      if(hudRank) hudRank.textContent = String(d.grade ?? '-');
    }, { passive:true });

    WIN.addEventListener('hha:coach', (ev)=>{
      const d = ev.detail||{};
      if(coachText) coachText.textContent = String(d.text||'');
      setCoachMood(d.mood||'neutral');

      // tiny banner for strong moods
      const mood = String(d.mood||'neutral').toLowerCase();
      if(mood === 'fever') showBanner('üî• ' + String(d.text||''), 'warn');
      else if(mood === 'happy') showBanner('‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!', 'good');
    }, { passive:true });

    WIN.addEventListener('quest:update', (ev)=>{
      const d = ev.detail||{};
      if(groupTag) groupTag.textContent = String(d.groupName || '‡∏´‡∏°‡∏π‡πà');
      if(goalTitle) goalTitle.textContent = String(d.goalTitle || '‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å');
      if(goalSub) goalSub.textContent = String((d.goalNow ?? 0) + '/' + (d.goalTotal ?? 0));
      if(goalFill) goalFill.style.width = String(clamp(d.goalPct ?? 0,0,100)) + '%';

      if(miniTitle) miniTitle.textContent = String(d.miniTitle || 'MINI');
      if(miniSub) miniSub.textContent = String((d.miniNow ?? 0) + '/' + (d.miniTotal ?? 0));
      if(miniFill) miniFill.style.width = String(clamp(d.miniPct ?? 0,0,100)) + '%';

      const left = Number(d.miniTimeLeftSec ?? 0);
      if(miniTag){
        miniTag.textContent = left>0 ? ('‚è≥ ' + left + 's') : 'üéØ';
      }
      // urgency class
      if(DOC.body){
        if(left>0 && left<=3) DOC.body.classList.add('mini-urgent');
        else DOC.body.classList.remove('mini-urgent');
      }
    }, { passive:true });

    WIN.addEventListener('groups:power', (ev)=>{
      const d = ev.detail||{};
      const c = Number(d.charge ?? 0);
      const thr = Math.max(1, Number(d.threshold ?? 1));
      const pct = clamp((c/thr)*100, 0, 100);
      if(powerFill) powerFill.style.width = pct + '%';
      if(powerSub) powerSub.textContent = c + '/' + thr;
      if(powerTitle) powerTitle.textContent = (c>=thr) ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà!' : '‡∏û‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏™‡∏°';
    }, { passive:true });

    // End overlay (optional)
    WIN.addEventListener('hha:end', (ev)=>{
      const d = ev.detail||{};
      if(endOverlay) endOverlay.classList.remove('hidden');
      if(endScore) endScore.textContent = String(d.scoreFinal ?? 0);
      if(endAcc) endAcc.textContent = String(d.accuracyGoodPct ?? 0) + '%';
      if(endSub) endSub.textContent = `Rank ${d.grade || '-'} ‚Ä¢ MISS ${d.misses ?? 0} ‚Ä¢ SHOTS ${d.shots ?? 0}`;
      if(endNote){
        endNote.textContent =
          `seed=${d.seed || '-'} ‚Ä¢ run=${d.runMode || '-'} ‚Ä¢ diff=${d.diff || '-'} ‚Ä¢ view=${d.view || '-'}`;
      }
    }, { passive:true });

    // Buttons
    function hubUrl(){
      const h = String(qs('hub','')||'');
      return h || '../hub.html';
    }

    if(btnBackHub){
      btnBackHub.addEventListener('click', ()=>{
        location.href = hubUrl();
      });
    }
    if(btnReplay){
      btnReplay.addEventListener('click', ()=>{
        try{ if(endOverlay) endOverlay.classList.add('hidden'); }catch(_){}
        try{
          const diff = String(qs('diff','normal')||'normal');
          const ctx = { time: Number(qs('time',90)), seed: String(qs('seed','')||Date.now()), runMode: String(qs('run','play')||'play') };
          WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.start(diff, ctx);
        }catch(_){}
      });
    }

    // Start engine (NO tap-to-start)
    function startNow(){
      try{
        // Ensure layer is correct
        if(WIN.GroupsVR && WIN.GroupsVR.GameEngine && WIN.GroupsVR.GameEngine.setLayerEl){
          WIN.GroupsVR.GameEngine.setLayerEl(playLayer);
        }
        // FX init again (safe)
        try{
          const FX = WIN.GroupsVR && WIN.GroupsVR.EffectsPack;
          FX && FX.init && FX.init({ layerEl: playLayer });
        }catch(_){}

        // Start
        const diff = String(qs('diff','normal')||'normal');
        const ctx = {
          time: Number(qs('time', 90)),
          seed: String(qs('seed','')||Date.now()),
          runMode: String(qs('run','play')||'play')
        };
        WIN.GroupsVR.GameEngine.start(diff, ctx);

        // Flush harden (if telemetry exists)
        if(WIN.GroupsVR.bindFlushOnLeave){
          WIN.GroupsVR.bindFlushOnLeave(()=> (WIN.__HHA_LAST_SUMMARY__||null));
        }

        // Tiny banner: lockPx info (only if debug=1)
        if(String(qs('debug','0'))==='1'){
          showBanner('lockPx=' + (WIN.__HHA_LOCKPX__||'?'), 'neutral');
        }
      }catch(e){
        console.error('GroupsVR start error:', e);
        showBanner('ERROR', 'bad');
      }
    }

    DOC.addEventListener('DOMContentLoaded', ()=>{
      // tiny delay to let vr-ui mount buttons/crosshair
      setTimeout(startNow, 160);
    });

  })();
  </script>
</body>
</html>