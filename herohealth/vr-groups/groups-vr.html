<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR (Run)</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" />

  <!-- GUARD: ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ CSS ‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏±‡∏á .hidden ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà -->
  <style>
    .hidden{ display:none !important; }
    html,body{ margin:0; width:100%; height:100%; background:#020617; color:#e5e7eb; font-family:system-ui,-apple-system,"Noto Sans Thai","Segoe UI",Roboto,sans-serif; }
  </style>

  <!-- MAIN CSS -->
  <link id="cssMain" rel="stylesheet" href="./groups-vr.css?v=20260203-1" />
  <script>
    (function(){
      const link = document.getElementById('cssMain');
      link.addEventListener('error', ()=>{
        alert('CSS ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ./groups-vr.css (‡πÄ‡∏ä‡πá‡∏Å path/‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏ö‡∏ô GitHub Pages)');
      });
    })();
  </script>

  <!-- Tune VR UI aim assist (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î) -->
  <script>
    window.HHA_VRUI_CONFIG = {
      lockPx: 44,        // ‚úÖ ‡∏à‡∏π‡∏ô‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 36‚Äì54)
      cooldownMs: 80
    };
  </script>
</head>

<body class="view-mobile">
  <!-- XR scene (optional) -->
  <div class="xr-scene" aria-hidden="true"></div>

  <!-- HUD -->
  <header class="hud">
    <div class="hudLeft">
      <div class="pill"><span class="lbl">‚è≥ TIME</span><span class="val" id="hudTime">90</span></div>
      <div class="pill"><span class="lbl">‚≠ê SCORE</span><span class="val" id="hudScore">0</span></div>
      <div class="pill"><span class="lbl">üî• COMBO</span><span class="val" id="hudCombo">0</span></div>
      <div class="pill"><span class="lbl">‚ùå MISS</span><span class="val" id="hudMiss">0</span></div>
    </div>
    <div class="hudRight">
      <div class="pill"><span class="lbl">üéØ ACC</span><span class="val" id="hudAcc">0%</span></div>
      <div class="pill"><span class="lbl">üèÖ RANK</span><span class="val" id="hudRank">D</span></div>
    </div>
  </header>

  <!-- Quest -->
  <section class="questTop">
    <div class="questCard">
      <div class="qTitle">
        <span id="qGoalTitle">GOAL</span>
        <span class="tag" id="qGoalCount">0/12</span>
      </div>
      <div class="bar"><div class="fill" id="qGoalFill"></div></div>
      <div class="qSub" id="qGoalSub">‚Äî</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <span id="qMiniTitle">MINI</span>
        <span class="tag" id="qMiniCount">0/5</span>
      </div>
      <div class="bar"><div class="fill" id="qMiniFill"></div></div>
      <div class="qSub" id="qMiniSub">‚Äî</div>
    </div>
  </section>

  <!-- Big Banner -->
  <div class="bigBanner hidden" id="bigBanner">
    <div class="bigBannerText" id="bigBannerText">READY</div>
  </div>

  <!-- Play Layer (targets spawn here) -->
  <main class="playLayer" id="playLayer" aria-label="Play layer"></main>

  <!-- Power -->
  <section class="powerWrap">
    <div class="powerCard">
      <div class="pHead">‚ö° Power</div>
      <div class="bar powerBar"><div class="fill" id="pFill"></div></div>
      <div class="pFoot" id="pText">0/8 ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà</div>
    </div>
  </section>

  <!-- Coach -->
  <section class="coachWrap">
    <div class="coachCard">
      <img class="coachImg" id="coachImg" alt="Coach" src="../img/coach-neutral.png" />
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üéØ</div>
      </div>
    </div>
  </section>

  <!-- Overlay End -->
  <section class="overlay hidden" id="endOverlay">
    <div class="panel">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>
      <div class="row2" style="margin-top:12px;">
        <button class="btn btn-strong" id="btnRetry">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btn-ghost" id="btnHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div class="note" style="margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </section>

  <!-- Boot button (tap-to-start) -->
  <div style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:80; pointer-events:auto;" id="startGate">
    <button class="btn btn-strong" style="width:min(360px, 92vw); padding:16px 14px; font-size:16px;" id="btnStart">
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
    </button>
  </div>

  <script>
    // ---------- robust loader (try 2 possible paths) ----------
    function loadScriptTry(urls){
      const DOC = document;
      return new Promise((res, rej)=>{
        let i = 0;
        const tryNext = ()=>{
          if(i >= urls.length) return rej(new Error('All script paths failed: ' + urls.join(', ')));
          const src = urls[i++];
          const s = DOC.createElement('script');
          s.src = src;
          s.defer = true;
          s.onload = ()=>res(src);
          s.onerror = ()=>{ try{ s.remove(); }catch(_){}; tryNext(); };
          DOC.head.appendChild(s);
        };
        tryNext();
      });
    }

    function qs(k, d=null){ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } }

    // ---------- UI bindings ----------
    const $ = (id)=>document.getElementById(id);

    function setViewClass(){
      const v = String(qs('view','mobile')||'mobile').toLowerCase();
      document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      document.body.classList.add('view-' + (v==='pc'?'pc':v==='vr'?'vr':v==='cvr'?'cvr':'mobile'));
    }

    function pctFill(el, pct){
      pct = Math.max(0, Math.min(100, Number(pct)||0));
      el.style.width = pct + '%';
    }

    // HUD events from engine
    window.addEventListener('hha:time', (e)=>{
      const left = (e.detail && e.detail.left)|0;
      $('hudTime').textContent = String(left);
    }, {passive:true});

    window.addEventListener('hha:score', (e)=>{
      const d = e.detail||{};
      $('hudScore').textContent = String(d.score|0);
      $('hudCombo').textContent = String(d.combo|0);
      $('hudMiss').textContent  = String(d.misses|0);
    }, {passive:true});

    window.addEventListener('hha:rank', (e)=>{
      const d = e.detail||{};
      $('hudAcc').textContent = String((d.accuracy|0)) + '%';
      $('hudRank').textContent = String(d.grade||'D');
    }, {passive:true});

    window.addEventListener('quest:update', (e)=>{
      const d = e.detail||{};
      $('qGoalTitle').textContent = d.goalTitle || 'GOAL';
      $('qGoalCount').textContent = `${d.goalNow|0}/${d.goalTotal|0}`;
      pctFill($('qGoalFill'), d.goalPct|0);
      $('qGoalSub').textContent = d.groupName ? `‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å: ${d.groupName}` : (d.goalTitle||'‚Äî');

      $('qMiniTitle').textContent = d.miniTitle || 'MINI';
      $('qMiniCount').textContent = `${d.miniNow|0}/${d.miniTotal|0}`;
      pctFill($('qMiniFill'), d.miniPct|0);
      $('qMiniSub').textContent = (d.miniTimeLeftSec>0) ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${d.miniTimeLeftSec|0}s` : '‚Äî';

      // urgent style
      if((d.miniTimeLeftSec|0) > 0 && (d.miniTimeLeftSec|0) <= 4) document.body.classList.add('mini-urgent');
      else document.body.classList.remove('mini-urgent');
    }, {passive:true});

    window.addEventListener('groups:power', (e)=>{
      const d = e.detail||{};
      const c = (d.charge|0), th = Math.max(1, (d.threshold|0));
      const pct = Math.round((c/th)*100);
      pctFill($('pFill'), pct);
      $('pText').textContent = `${c}/${th} ‚Üí ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà`;
    }, {passive:true});

    window.addEventListener('hha:coach', (e)=>{
      const d = e.detail||{};
      $('coachText').textContent = String(d.text||'‚Äî');
      // mood => image
      const mood = String(d.mood||'neutral').toLowerCase();
      const img =
        mood==='happy' ? '../img/coach-happy.png' :
        mood==='sad'   ? '../img/coach-sad.png' :
        mood==='fever' ? '../img/coach-fever.png' :
                         '../img/coach-neutral.png';
      $('coachImg').src = img;
    }, {passive:true});

    window.addEventListener('hha:end', (e)=>{
      const s = e.detail||{};
      $('endSub').textContent =
        `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${s.scoreFinal|0} ‚Ä¢ ‡∏¢‡∏¥‡∏á ${s.goodShots|0}/${s.shots|0} (${s.accuracyGoodPct|0}%) ‚Ä¢ Miss ${s.misses|0} ‚Ä¢ Rank ${s.grade||'D'}`;
      $('endOverlay').classList.remove('hidden');
    }, {passive:true});

    // buttons
    $('btnRetry').addEventListener('click', ()=>location.reload());
    $('btnHub').addEventListener('click', ()=>{
      const hub = qs('hub','')||'';
      if(hub) location.href = hub;
      else history.back();
    });

    // ---------- BOOT ----------
    (async function main(){
      setViewClass();

      // 1) vr-ui (crosshair + hha:shoot)
      await loadScriptTry(['../vr/vr-ui.js','./vr/vr-ui.js']);

      // 2) particles (optional, ok if missing)
      await loadScriptTry(['../vr/particles.js','./vr/particles.js']).catch(()=>{});

      // 3) effects pack (uses groups:hit)
      await loadScriptTry(['./effects-pack.js','./vr-groups/effects-pack.js']);

      // 4) engine
      await loadScriptTry(['./groups.safe.js','./vr-groups/groups.safe.js']);

      // hook start
      $('btnStart').addEventListener('click', ()=>{
        $('startGate').style.display = 'none';

        try{
          // Engine start
          const diff = String(qs('diff','normal')||'normal');
          const ctx = { time:Number(qs('time',90)||90), seed:qs('seed','')||Date.now(), runMode:qs('run','play')||'play' };
          window.GroupsVR.GameEngine.setLayerEl(document.getElementById('playLayer'));
          window.GroupsVR.GameEngine.start(diff, ctx);
        }catch(err){
          alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
        }
      });
    })();
  </script>
</body>
</html>