<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- A-Frame for WebXR Enter VR reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- Global FX + Logger + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Engine (B) -->
  <script src="./groups.safe.js" defer></script>

  <style>
    /* tiny helper: hide overlay until engine ends */
    .overlay[aria-hidden="true"]{ display:none !important; }
  </style>
</head>

<body class="view-mobile">
  <!-- Minimal XR scene behind DOM -->
  <a-scene class="xr-scene" embedded renderer="colorManagement:true" background="color:#0b1120">
    <a-entity position="0 1.6 0">
      <a-camera wasd-controls-enabled="false" look-controls="pointerLockEnabled:false"></a-camera>
    </a-entity>

    <!-- subtle ambience -->
    <a-entity light="type:ambient; intensity:0.8; color:#b9d7ff"></a-entity>
    <a-entity light="type:directional; intensity:0.35; color:#ffffff" position="1 2 1"></a-entity>
  </a-scene>

  <!-- Play layer (targets spawn here) -->
  <div id="playLayer" class="playLayer" aria-label="play layer"></div>

  <!-- HUD -->
  <div class="hud" aria-hidden="false">
    <div class="hudLeft">
      <div class="pill"><div class="lbl">TIME</div><div id="hudTime" class="val">90</div></div>
      <div class="pill"><div class="lbl">SCORE</div><div id="hudScore" class="val">0</div></div>
    </div>
    <div class="hudRight">
      <div class="pill"><div class="lbl">COMBO</div><div id="hudCombo" class="val">0</div></div>
      <div class="pill"><div class="lbl">MISS</div><div id="hudMiss" class="val">0</div></div>
      <div class="pill"><div class="lbl">RANK</div><div id="hudRank" class="val">C</div></div>
      <div class="pill"><div class="lbl">ACC</div><div id="hudAcc" class="val">0%</div></div>
    </div>
  </div>

  <!-- Quest -->
  <div class="questTop" aria-hidden="false">
    <div class="questCard">
      <div class="qTitle">
        <div id="goalTitle">—</div>
        <div class="tag"><span id="goalTag">GOAL</span> <span id="goalCount">0/0</span></div>
      </div>
      <div class="bar"><div id="goalFill" class="fill" style="width:0%"></div></div>
      <div id="goalSub" class="qSub">—</div>
    </div>

    <div class="questCard">
      <div class="qTitle">
        <div id="miniTitle">—</div>
        <div class="tag"><span id="miniTag">MINI</span> <span id="miniCount">0/0</span> <span id="miniTime" style="opacity:.85"></span></div>
      </div>
      <div class="bar"><div id="miniFill" class="fill" style="width:0%"></div></div>
      <div id="miniSub" class="qSub">—</div>
    </div>
  </div>

  <!-- Power -->
  <div class="powerWrap" aria-hidden="false">
    <div class="powerCard">
      <div class="pHead">POWER (เก็บให้เต็มเพื่อ “สลับหมู่”)</div>
      <div class="bar powerBar"><div id="powerFill" class="fill" style="width:0%"></div></div>
      <div class="pFoot"><span id="powerText">0/0</span></div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coachWrap" aria-hidden="false">
    <div class="coachCard">
      <img id="coachImg" class="coachImg" alt="coach" src="../img/coach-neutral.png" />
      <div class="coachBubble">
        <div class="coachName">Coach</div>
        <div id="coachText" class="coachText">พร้อมแล้ว…</div>
      </div>
    </div>
  </div>

  <!-- End Overlay -->
  <div id="endOverlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="title">สรุปผล</div>
      <div id="endSub" class="sub">—</div>

      <div class="grid2">
        <div class="stat"><div class="k">RANK</div><div id="endRank" class="v">C</div></div>
        <div class="stat"><div class="k">SCORE</div><div id="endScore" class="v">0</div></div>
        <div class="stat"><div class="k">MISS</div><div id="endMiss" class="v">0</div></div>
        <div class="stat"><div class="k">ACC</div><div id="endAcc" class="v">0%</div></div>
      </div>

      <div class="row row2">
        <div class="note" id="endNote">—</div>
      </div>

      <div class="row">
        <button id="btnRestart" class="btn btn-strong" type="button">เล่นอีกครั้ง</button>
        <button id="btnBackHub" class="btn btn-ghost" type="button">กลับ HUB</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';
      const ROOT = window;
      const DOC  = document;

      const qs = (k, def=null) => {
        try { return new URL(location.href).searchParams.get(k) ?? def; }
        catch { return def; }
      };
      const qn = (k, def=0) => {
        const v = Number(qs(k, def));
        return isFinite(v) ? v : def;
      };

      function setViewAuto(){
        // ✅ default: mobile/pc by screen width; vr/cvr will be handled by vr-ui / user entering XR
        const w = Math.max(320, ROOT.innerWidth||360);
        const isPC = w >= 980;
        DOC.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
        DOC.body.classList.add(isPC ? 'view-pc' : 'view-mobile');
      }

      function moodToImg(m){
        m = String(m||'neutral');
        if(m.includes('happy')) return '../img/coach-happy.png';
        if(m.includes('sad')) return '../img/coach-sad.png';
        if(m.includes('fever')) return '../img/coach-fever.png';
        return '../img/coach-neutral.png';
      }

      // UI nodes
      const playLayer = DOC.getElementById('playLayer');

      const hudTime  = DOC.getElementById('hudTime');
      const hudScore = DOC.getElementById('hudScore');
      const hudCombo = DOC.getElementById('hudCombo');
      const hudMiss  = DOC.getElementById('hudMiss');
      const hudRank  = DOC.getElementById('hudRank');
      const hudAcc   = DOC.getElementById('hudAcc');

      const goalTitle = DOC.getElementById('goalTitle');
      const goalCount = DOC.getElementById('goalCount');
      const goalFill  = DOC.getElementById('goalFill');
      const goalSub   = DOC.getElementById('goalSub');

      const miniTitle = DOC.getElementById('miniTitle');
      const miniCount = DOC.getElementById('miniCount');
      const miniFill  = DOC.getElementById('miniFill');
      const miniSub   = DOC.getElementById('miniSub');
      const miniTime  = DOC.getElementById('miniTime');

      const powerFill = DOC.getElementById('powerFill');
      const powerText = DOC.getElementById('powerText');

      const coachImg  = DOC.getElementById('coachImg');
      const coachText = DOC.getElementById('coachText');

      const endOverlay = DOC.getElementById('endOverlay');
      const endSub     = DOC.getElementById('endSub');
      const endRank    = DOC.getElementById('endRank');
      const endScore   = DOC.getElementById('endScore');
      const endMiss    = DOC.getElementById('endMiss');
      const endAcc     = DOC.getElementById('endAcc');
      const endNote    = DOC.getElementById('endNote');

      const btnRestart = DOC.getElementById('btnRestart');
      const btnBackHub = DOC.getElementById('btnBackHub');

      function overlayShow(on){
        endOverlay.setAttribute('aria-hidden', on ? 'false' : 'true');
      }

      function safePct(x){ x = Number(x)||0; return Math.max(0, Math.min(100, x)); }

      // Inputs
      const hubUrl = qs('hub', '');
      const run    = String(qs('run', 'play')).toLowerCase();     // play | research | practice
      const diff   = String(qs('diff','normal')).toLowerCase();   // easy | normal | hard
      const time   = qn('time', 90);
      const seed   = qs('seed', String(Date.now()));
      const ai0    = String(qs('ai','0')) === '0';

      // Determine runMode
      let runMode = (run === 'research') ? 'research' : (run === 'practice' ? 'practice' : 'play');

      // practice auto: 15 sec then start play (unless explicitly asked practice-only)
      const practiceAuto = (runMode === 'practice');

      // Engine bridge
      function engineReady(){
        return ROOT.GroupsVR && ROOT.GroupsVR.GameEngine && typeof ROOT.GroupsVR.GameEngine.start === 'function';
      }

      function startEngine(mode){
        if(!engineReady()) return false;

        // attach playLayer
        try{ ROOT.GroupsVR.GameEngine.setLayerEl(playLayer); }catch(_){}

        overlayShow(false);

        // mode options
        const opts = {
          runMode: mode || runMode,
          seed,
          time,
          view: null // we auto-set body classes; engine reads body
        };

        // If practice mode: force 15 seconds (super clear training)
        if(opts.runMode === 'practice') opts.time = 15;

        ROOT.GroupsVR.GameEngine.start(diff, opts);
        return true;
      }

      function waitBoot(){
        setViewAuto();
        let tries = 0;
        const tmr = setInterval(()=>{
          tries++;
          if(engineReady()){
            clearInterval(tmr);
            startEngine(runMode);
          }
          if(tries > 180){
            clearInterval(tmr);
            coachText.textContent = 'โหลดไม่สำเร็จ ลองรีเฟรชหน้านี้อีกครั้ง';
          }
        }, 50);
      }

      // Event wiring
      ROOT.addEventListener('hha:time', (e)=>{
        const left = Number(e.detail && e.detail.left);
        if(isFinite(left)) hudTime.textContent = String(left);
      });

      ROOT.addEventListener('hha:score', (e)=>{
        const d = e.detail || {};
        hudScore.textContent = String(d.score ?? 0);
        hudCombo.textContent = String(d.combo ?? 0);
        // ✅ HUD MISS uses mistake-only (from engine)
        hudMiss.textContent  = String(d.misses ?? 0);
      });

      ROOT.addEventListener('hha:rank', (e)=>{
        const d = e.detail || {};
        hudRank.textContent = String(d.grade || 'C');
        const acc = Number(d.accuracy ?? 0);
        hudAcc.textContent = String(isFinite(acc) ? (acc + '%') : '0%');
      });

      ROOT.addEventListener('groups:power', (e)=>{
        const d = e.detail || {};
        const c = Number(d.charge||0), t = Math.max(1, Number(d.threshold||1));
        powerFill.style.width = safePct((c/t)*100).toFixed(1)+'%';
        powerText.textContent = `${c}/${t}`;
      });

      ROOT.addEventListener('quest:update', (e)=>{
        const d = e.detail || {};
        goalTitle.textContent = String(d.goalTitle || '—');
        goalCount.textContent = `${d.goalNow ?? 0}/${d.goalTotal ?? 0}`;
        goalFill.style.width = safePct(d.goalPct ?? 0).toFixed(1)+'%';
        goalSub.textContent = `GOAL ${d.goalIndex ?? 0}/${d.goalsTotal ?? 0} • หมู่: ${d.groupName || '—'}`;

        miniTitle.textContent = String(d.miniTitle || '—');
        miniCount.textContent = `${d.miniNow ?? 0}/${d.miniTotal ?? 0}`;
        miniFill.style.width = safePct(d.miniPct ?? 0).toFixed(1)+'%';
        miniSub.textContent = `MINI ผ่าน: ${d.miniCountCleared ?? 0}/${d.miniCountTotal ?? 0}`;
        const sec = Number(d.miniTimeLeftSec||0);
        miniTime.textContent = sec>0 ? ` • ${sec}s` : '';

        // urgency class for mini
        const urgent = sec>0 && sec<=3;
        DOC.body.classList.toggle('mini-urgent', urgent);
        DOC.body.classList.toggle('groups-mini-urgent', urgent);
      });

      ROOT.addEventListener('hha:coach', (e)=>{
        const d = e.detail || {};
        coachText.textContent = String(d.text || '');
        coachImg.src = moodToImg(d.mood);
      });

      // Optional judge -> particles
      ROOT.addEventListener('hha:judge', (e)=>{
        const d = e.detail || {};
        if(!ROOT.Particles) return;
        const x = Number(d.x), y = Number(d.y);
        if(isFinite(x) && isFinite(y)){
          if(d.kind === 'good') ROOT.Particles.burst(x,y,10);
          if(d.kind === 'perfect') ROOT.Particles.celebrate(x,y,16);
        }
      });

      // End summary
      ROOT.addEventListener('hha:end', (e)=>{
        const s = e.detail || {};
        const reason = String(s.reason || 'end');

        // ✅ practice auto flow: do NOT show overlay, do NOT log
        if(practiceAuto && reason === 'practice'){
          coachText.textContent = 'จบฝึกแล้ว! เริ่มเกมจริง…';
          setTimeout(()=>{
            runMode = 'play';
            startEngine('play');
          }, 350);
          return;
        }

        // show overlay
        endSub.textContent = `เหตุผล: ${reason} • เวลาเล่น: ${s.durationPlayedSec ?? 0}s`;
        endRank.textContent = String(s.grade || 'C');
        endScore.textContent = String(s.scoreFinal ?? 0);

        // ✅ show MISS = missMistake
        endMiss.textContent = String(s.missMistake ?? s.misses ?? 0);

        endAcc.textContent = String((s.accuracyGoodPct ?? 0) + '%');

        const mAim = Number(s.missAim ?? 0);
        const mMis = Number(s.missMistake ?? s.misses ?? 0);
        const mt   = Number(s.missesTotal ?? (mAim + mMis));
        const mini = `${s.miniCleared ?? 0}/${s.miniTotal ?? 0}`;
        const goal = `${s.goalsCleared ?? 0}/${s.goalsTotal ?? 0}`;
        endNote.textContent = `GOAL ${goal} • MINI ${mini} • aimMiss ${mAim} • totalMiss ${mt}`;

        overlayShow(true);

        // log (if available)
        try{
          if(ROOT.HHA_LOGGER && typeof ROOT.HHA_LOGGER.flush === 'function'){
            // hha-cloud-logger listens to hha:end, but flush hardened here is ok too
            ROOT.HHA_LOGGER.flush('end');
          }
        }catch(_){}
      });

      // Buttons
      btnRestart.addEventListener('click', ()=>{
        // keep same params, restart runMode from query (but if practiceAuto was used, restart play)
        const rm = (practiceAuto ? 'play' : runMode);
        startEngine(rm);
      });

      btnBackHub.addEventListener('click', ()=>{
        if(hubUrl){
          location.href = hubUrl;
        }else{
          // fallback
          history.back();
        }
      });

      // resize -> re-evaluate view classes
      let _rT=0;
      ROOT.addEventListener('resize', ()=>{
        clearTimeout(_rT);
        _rT = setTimeout(setViewAuto, 140);
      }, {passive:true});

      // Boot
      waitBoot();

      // If ai=0, keep AI hooks off (engine already checks in your B logic, but this is extra guard)
      if(ai0){
        try{
          if(ROOT.GroupsVR) ROOT.GroupsVR.__ai = null;
        }catch(_){}
      }
    })();
  </script>
</body>
</html>