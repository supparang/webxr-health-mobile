<!-- === /herohealth/vr-groups/groups-vr.html ===
GroupsVR ‚Äî RUN (Production) ‚Äî PATCH D1‚ÄìD3
‚úÖ D1: Layout ‡πÉ‡∏´‡∏°‡πà PC/Mobile/Cardboard(cVR) ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô + HUD ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤
‚úÖ D2: ‡πÉ‡∏™‡πà Universal VR UI (/herohealth/vr/vr-ui.js) + crosshair/tap-to-shoot => hha:shoot
‚úÖ D3: HUD listeners ‡∏Ñ‡∏£‡∏ö: hha:time/score/rank/coach + quest/update + groups:* + FX hooks
‚úÖ Supports: view=pc|mobile|cvr  (cvr = cardboard strict)
‚úÖ Pass-through: hub, run, diff, time, seed, log, studyId, phase, conditionGroup, ...
‚úÖ Buff pill: listens groups:buff (D7)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî Groups VR</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="../favicon.ico"/>

  <style>
    :root{
      --bg:#040610;
      --panel: rgba(4,6,16,.78);
      --panel2: rgba(10,16,36,.55);
      --stroke: rgba(148,163,184,.18);

      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --cyan:#22d3ee; --violet:#a78bfa; --amber:#f59e0b; --red:#ef4444; --pink:#ff4fd8;

      --radius:22px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);

      /* ‚úÖ HUD-safe zones (engine occlusion guard uses .hud/.questTop/.powerWrap/.coachWrap/.overlay) */
      --hudTop: calc(12px + var(--sat));
      --hudBottom: calc(12px + var(--sab));
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; overflow:hidden; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(34,211,238,.14) 0%, transparent 55%),
        radial-gradient(1100px 700px at 80% 30%, rgba(167,139,250,.16) 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,79,216,.08) 0%, transparent 60%),
        linear-gradient(180deg, #0b1026, var(--bg));
    }

    /* ===== Layout ===== */
    #app{
      position:relative;
      width:100%; height:100%;
      overflow:hidden;
    }

    /* ===== HUD (top) ===== */
    .hud{
      position:absolute; left:0; right:0; top:0;
      padding: calc(10px + var(--sat)) 10px 10px;
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:space-between;
      z-index: 50;
      pointer-events:none; /* ‚úÖ HUD ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á (‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å vr-ui crosshair ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) */
      background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0));
      border-bottom: 1px solid rgba(148,163,184,.08);
      backdrop-filter: blur(10px);
    }

    .rowL, .rowR{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      pointer-events:none;
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.55);
      font-size:12px;
      color:var(--muted);
    }
    .pill b{ color:var(--text); font-weight:1000; }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--cyan); box-shadow:0 0 14px rgba(34,211,238,.55); }

    /* ===== Quest (top center) ===== */
    .questTop{
      position:absolute;
      top: calc(64px + var(--sat));
      left:50%;
      transform:translateX(-50%);
      width:min(560px, calc(100% - 18px));
      z-index: 55;
      pointer-events:none;
    }
    .questCard{
      background: rgba(2,6,23,.58);
      border: 1px solid rgba(148,163,184,.14);
      border-radius: 18px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .questTitle{ font-weight:1000; font-size:12.5px; letter-spacing:.2px; }
    .questSub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .bar{
      margin-top:8px;
      height:10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(34,211,238,.92), rgba(167,139,250,.88), rgba(255,79,216,.78));
      transition: width .12s linear;
    }
    .miniRow{
      display:flex; justify-content:space-between; gap:8px; margin-top:6px;
      color:var(--muted); font-size:11.5px;
    }

    /* ===== Power (bottom) ===== */
    .powerWrap{
      position:absolute; left:50%;
      transform:translateX(-50%);
      bottom: calc(14px + var(--sab));
      width:min(520px, calc(100% - 18px));
      z-index: 55;
      pointer-events:none;
    }
    .powerCard{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: rgba(2,6,23,.58);
      border: 1px solid rgba(148,163,184,.14);
      border-radius: 18px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .powerText{ font-size:12px; color:var(--muted); }
    .powerText b{ color:var(--text); font-weight:1000; }
    .powerBar{
      flex:1;
      height:12px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      overflow:hidden;
      margin-left:8px;
    }
    .powerBar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.90), rgba(34,211,238,.86), rgba(255,79,216,.76));
      transition: width .12s linear;
    }

    /* ===== Coach bubble (bottom right) ===== */
    .coachWrap{
      position:absolute;
      right: 10px;
      bottom: calc(86px + var(--sab));
      width: min(320px, calc(100% - 20px));
      z-index: 60;
      pointer-events:none;
    }
    .coachCard{
      background: rgba(2,6,23,.58);
      border:1px solid rgba(148,163,184,.14);
      border-radius: 18px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.30);
    }
    .coachHead{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; }
    .coachHead b{ color:var(--text); font-weight:1000; }
    .coachMsg{ margin-top:6px; font-weight:900; letter-spacing:.2px; font-size:13.5px; }
    .coachMsg.neutral{ color: rgba(229,231,235,.92); }
    .coachMsg.happy{ color: rgba(34,197,94,.95); }
    .coachMsg.fever{ color: rgba(255,79,216,.92); }

    /* ===== Overlay + Menu ===== */
    .overlay{
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      padding: calc(12px + var(--sat)) 12px calc(12px + var(--sab));
      z-index: 80;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .card{
      width:min(980px, 100%);
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.76), rgba(2,6,23,.55));
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    header.menuHead{
      padding: 14px 14px 10px;
      border-bottom:1px solid rgba(148,163,184,.12);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .menuTitle h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .menuTitle p{ margin:2px 0 0; color:var(--muted); font-size:12.2px; }
    main.menuBody{ padding: 12px 14px 14px; display:grid; grid-template-columns: 1.15fr .85fr; gap:12px; }
    @media (max-width: 860px){ main.menuBody{ grid-template-columns: 1fr; } }
    .panel{
      border-radius: 18px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.45);
      padding: 12px;
    }
    .grid3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 560px){ .grid3{ grid-template-columns: 1fr; } }
    button{
      cursor:pointer;
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color:var(--text);
      padding: 12px 12px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); background: rgba(2,6,23,.72); border-color: rgba(148,163,184,.32); }
    button:active{ transform: translateY(0px) scale(.99); }
    button.primary{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.32);
      font-weight:1000;
    }
    button.ghost{ background: rgba(148,163,184,.08); }
    .kv{ display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .kv div{ padding:10px 10px; border:1px solid rgba(148,163,184,.14); border-radius: 14px; background: rgba(2,6,23,.40); font-size: 12.5px; }
    .kv b{ font-weight: 1000; color: rgba(229,231,235,.95); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .note{ color:var(--muted); font-size:12.3px; line-height:1.45; }

    /* ===== Play Layer (targets host) ===== */
    #playLayer{
      position:absolute; inset:0;
      z-index: 10;
      overflow:hidden;
      /* ‚úÖ keep some breathing room for HUD */
      padding-top: calc(132px + var(--sat));      /* space for .hud + .questTop */
      padding-bottom: calc(120px + var(--sab));   /* space for .powerWrap */
    }

    /* targets (fallback style; engine also sets inline) */
    .tgt{
      display:flex; align-items:center; justify-content:center;
      width:72px; height:72px;
      border-radius: 18px;
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(148,163,184,.22);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      font-size: 34px;
      font-weight: 1000;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    /* FX canvas layer */
    #fxLayer{
      position:absolute; inset:0;
      z-index: 40;
      pointer-events:none;
    }

    /* hide coach by default on narrow screens (optional) */
    @media (max-width: 520px){
      .coachWrap{ right: 8px; bottom: calc(92px + var(--sab)); width: min(290px, calc(100% - 16px)); }
      .questTop{ top: calc(72px + var(--sat)); }
      #playLayer{ padding-top: calc(142px + var(--sat)); }
    }
  </style>
</head>

<body>
<div id="app">

  <!-- ‚úÖ PLAY LAYER (engine spawns targets inside) -->
  <div id="playLayer" aria-label="Play Layer"></div>

  <!-- ‚úÖ FX LAYER -->
  <div id="fxLayer"></div>

  <!-- ‚úÖ HUD TOP -->
  <div class="hud">
    <div class="rowL">
      <span class="pill"><span class="dot"></span> <b id="vMode">PLAY</b></span>
      <span class="pill">Group: <b id="vGroup">‚Äî</b></span>
      <span class="pill">BUFF: <b id="vBuff">‚Äî</b></span>
    </div>
    <div class="rowR">
      <span class="pill">TIME <b id="vTime">‚Äî</b></span>
      <span class="pill">SCORE <b id="vScore">0</b></span>
      <span class="pill">COMBO <b id="vCombo">x0</b></span>
      <span class="pill">RANK <b id="vRank">‚Äî</b></span>
    </div>
  </div>

  <!-- ‚úÖ QUEST TOP -->
  <div class="questTop">
    <div class="questCard">
      <div class="questTitle" id="qTitle">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‚Äî</div>
      <div class="questSub" id="qSub">‚Äî</div>
      <div class="bar"><i id="qBar"></i></div>

      <div class="miniRow">
        <div id="mTitle">MINI: ‚Äî</div>
        <div><span id="mNow">0</span>/<span id="mTot">0</span> ¬∑ <span class="mono" id="mLeft">0s</span></div>
      </div>
      <div class="bar" style="height:9px; margin-top:6px;"><i id="mBar"></i></div>
    </div>
  </div>

  <!-- ‚úÖ POWER BOTTOM -->
  <div class="powerWrap">
    <div class="powerCard">
      <div class="powerText">POWER <b id="pNow">0</b>/<b id="pTot">0</b></div>
      <div class="powerBar"><i id="pBar"></i></div>
      <div class="powerText"><span class="mono" id="dirText">PLAY</span></div>
    </div>
  </div>

  <!-- ‚úÖ COACH -->
  <div class="coachWrap" id="coachWrap" style="display:none;">
    <div class="coachCard">
      <div class="coachHead">üë©‚Äçüè´ <b>Coach</b> ¬∑ <span id="coachMood" class="mono">neutral</span></div>
      <div class="coachMsg neutral" id="coachMsg">‚Äî</div>
    </div>
  </div>

  <!-- ‚úÖ MENU / OVERLAY -->
  <div class="overlay" id="menu">
    <div class="card">
      <header class="menuHead">
        <div class="menuTitle">
          <h1>ü•ó GroupsVR ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô</h1>
          <p>‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö ‚Üí ‡∏ä‡∏≤‡∏£‡πå‡∏à POWER ‚Üí ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà + ‡∏ö‡∏≠‡∏™‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Å‡∏°</p>
        </div>
        <div class="pill">
          <span class="dot"></span>
          view: <b id="vViewBadge">‚Äî</b>
        </div>
      </header>

      <main class="menuBody">
        <section class="panel">
          <div class="grid3">
            <button class="primary" id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
            <button id="btnPractice">üß™ Practice</button>
            <button id="btnResearch">üßæ Research</button>
          </div>

          <div style="height:10px;"></div>

          <div class="grid3">
            <button id="btnEasy">üò∫ Easy</button>
            <button id="btnNormal" class="primary">üòà Normal</button>
            <button id="btnHard">üíÄ Hard</button>
          </div>

          <div style="height:12px;"></div>

          <div class="kv">
            <div>Time (sec)</div><div><b id="vTimePlan">90</b></div>
            <div>Seed</div><div class="mono"><b id="vSeed">‚Äî</b></div>
            <div>Log</div><div class="mono"><b id="vLog">‚Äî</b></div>
          </div>

          <div style="height:10px;"></div>
          <div class="note">
            ‚úÖ ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡πÅ‡∏ï‡∏∞‡∏à‡∏≠/‡∏Ñ‡∏•‡∏¥‡∏Å‚Äù ‡∏´‡∏£‡∏∑‡∏≠ Crosshair (‡πÇ‡∏´‡∏°‡∏î VR/cVR) <br/>
            ‚úÖ view=cvr ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair + aim-assist (lockPx) <br/>
            ‚úÖ Research ‡∏à‡∏∞‡∏õ‡∏¥‡∏î AI & ‡∏õ‡∏¥‡∏î Buff ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </div>

          <div style="height:12px;"></div>
          <div class="grid3">
            <button class="ghost" id="btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
            <button class="ghost" id="btnReload">üîÑ Reload</button>
            <button class="ghost" id="btnCopyLink">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
          </div>
        </section>

        <aside class="panel">
          <div class="note mono" id="routeMini"></div>
          <div style="height:10px;"></div>

          <div class="note">
            <b>Controls</b><br/>
            - PC: ‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÄ‡∏°‡∏≤‡∏™‡πå<br/>
            - Mobile: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤<br/>
            - cVR: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (vr-ui) + tap-to-shoot<br/><br/>
            <b>Buff (‡∏à‡∏≤‡∏Å Warmup/Cooldown)</b><br/>
            ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà HUD ‚ÄúBUFF‚Äù ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô summary ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà research)
          </div>
        </aside>
      </main>
    </div>
  </div>

</div>

<!-- ‚úÖ Universal VR UI (‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô event: hha:shoot) -->
<script src="../vr/vr-ui.js"></script>

<!-- ‚úÖ Groups SAFE Engine (your file) -->
<script src="./groups.safe.js"></script>

<script>
(() => {
  'use strict';

  // ---------------- QS helpers ----------------
  function getQS(){
    try{ return new URL(location.href).searchParams; }
    catch{ return new URLSearchParams(); }
  }
  const QS = getQS();
  const q = (k, def='') => (QS.get(k) ?? def);
  const setQ = (k,v) => { try{ const u=new URL(location.href); u.searchParams.set(k,String(v)); history.replaceState({},'',u.toString()); }catch(_){ } };

  const HUB = q('hub','');
  const view = String(q('view','mobile')).toLowerCase();     // pc|mobile|cvr
  const diffQ = String(q('diff','normal')).toLowerCase();    // easy|normal|hard
  const runQ  = String(q('run','play')).toLowerCase();       // play|practice|research
  const timeQ = Math.max(15, Math.min(180, Number(q('time','90')||90)));
  const seedQ = String(q('seed','') || Date.now());
  const logQ  = String(q('log','')||'');
  const aiQ   = String(q('ai','0')||'0');

  // ---------------- DOM ----------------
  const $ = (s)=>document.querySelector(s);

  const menu = $('#menu');
  const routeMini = $('#routeMini');
  const vViewBadge = $('#vViewBadge');

  const vMode = $('#vMode');
  const vGroup = $('#vGroup');
  const vBuff = $('#vBuff');

  const vTime = $('#vTime');
  const vScore = $('#vScore');
  const vCombo = $('#vCombo');
  const vRank = $('#vRank');

  const qTitle = $('#qTitle');
  const qSub = $('#qSub');
  const qBar = $('#qBar');
  const mTitle = $('#mTitle');
  const mNow = $('#mNow');
  const mTot = $('#mTot');
  const mLeft = $('#mLeft');
  const mBar = $('#mBar');

  const pNow = $('#pNow');
  const pTot = $('#pTot');
  const pBar = $('#pBar');
  const dirText = $('#dirText');

  const coachWrap = $('#coachWrap');
  const coachMood = $('#coachMood');
  const coachMsg = $('#coachMsg');

  const vTimePlan = $('#vTimePlan');
  const vSeed = $('#vSeed');
  const vLog = $('#vLog');

  // ---------------- UI init ----------------
  vViewBadge.textContent = view;
  vTimePlan.textContent = String(timeQ);
  vSeed.textContent = seedQ;
  vLog.textContent = logQ ? '(on)' : '(off)';

  routeMini.textContent =
    `view=${view} run=${runQ} diff=${diffQ} time=${timeQ} seed=${seedQ} ai=${aiQ} log=${logQ ? 'on' : 'off'}`;

  // ---------------- View policy (lockPx for aim assist from vr-ui) ----------------
  // groups.safe.js uses ev.detail.lockPx (0..96)
  // We'll set a default in VR UI init and also override for cvr strict.
  let lockPx = 18;
  if(view === 'pc') lockPx = 8;
  if(view === 'mobile') lockPx = 18;
  if(view === 'cvr') lockPx = 28; // forgiving for cardboard crosshair

  // ---------------- VR UI boot ----------------
  // vr-ui.js expected to exist at ../vr/vr-ui.js
  // It emits hha:shoot {x,y,lockPx,...}
  try{
    if(window.HHAVRUI && typeof window.HHAVRUI.boot === 'function'){
      window.HHAVRUI.boot({
        view,
        lockPx,
        // keep HUD safe: allow recenter + enter VR
        allowRecenter:true
      });
    }
  }catch(_){}

  // ---------------- FX layer (optional) ----------------
  // If you later add GroupsVR.EffectsPack, it can draw into #fxLayer or use events.
  // We'll provide minimal sparkle text FX from groups:hit for now (safe).
  const fxLayer = $('#fxLayer');
  function popFx(x,y,txt){
    try{
      const el = document.createElement('div');
      el.style.cssText =
        `position:absolute; left:${x}px; top:${y}px; transform:translate(-50%,-50%);`+
        `font-weight:1000; font-size:18px; pointer-events:none;`+
        `filter:drop-shadow(0 12px 26px rgba(0,0,0,.35));`+
        `opacity:1; transition: transform 380ms ease, opacity 380ms ease;`;
      el.textContent = txt;
      fxLayer.appendChild(el);
      requestAnimationFrame(()=>{
        el.style.transform = 'translate(-50%,-72%) scale(1.18)';
        el.style.opacity = '0';
      });
      setTimeout(()=>el.remove(), 430);
    }catch(_){}
  }

  // ---------------- Engine start helpers ----------------
  function setModePill(run){
    const r = String(run||'play').toLowerCase();
    vMode.textContent = (r==='research') ? 'RESEARCH' : (r==='practice') ? 'PRACTICE' : 'PLAY';
    dirText.textContent = vMode.textContent;
  }

  function startGame(runMode, diff){
    // update query (so refresh keeps mode)
    setQ('run', runMode);
    setQ('diff', diff);

    setModePill(runMode);

    // hide menu
    menu.style.display = 'none';

    // IMPORTANT: pass ctx to engine
    const ctx = {
      runMode,
      seed: seedQ,
      time: timeQ
    };

    // ‚úÖ set layer element for engine
    try{
      window.GroupsVR && window.GroupsVR.GameEngine && window.GroupsVR.GameEngine.setLayerEl($('#playLayer'));
    }catch(_){}

    // start
    try{
      window.GroupsVR.GameEngine.start(diff, ctx);
    }catch(err){
      alert('Start error: ' + (err && err.message ? err.message : String(err)));
      menu.style.display = '';
    }
  }

  // ---------------- Buttons ----------------
  let curDiff = diffQ || 'normal';
  function markDiff(){
    $('#btnEasy').classList.toggle('primary', curDiff==='easy');
    $('#btnNormal').classList.toggle('primary', curDiff==='normal');
    $('#btnHard').classList.toggle('primary', curDiff==='hard');
  }
  markDiff();

  $('#btnEasy').addEventListener('click', ()=>{ curDiff='easy'; setQ('diff','easy'); markDiff(); });
  $('#btnNormal').addEventListener('click', ()=>{ curDiff='normal'; setQ('diff','normal'); markDiff(); });
  $('#btnHard').addEventListener('click', ()=>{ curDiff='hard'; setQ('diff','hard'); markDiff(); });

  $('#btnStart').addEventListener('click', ()=> startGame('play', curDiff));
  $('#btnPractice').addEventListener('click', ()=> startGame('practice', curDiff));
  $('#btnResearch').addEventListener('click', ()=> startGame('research', curDiff));

  $('#btnBackHub').addEventListener('click', ()=>{
    if(HUB) location.href = HUB;
    else history.length ? history.back() : (location.href = '../hub.html');
  });

  $('#btnReload').addEventListener('click', ()=>location.reload());

  $('#btnCopyLink').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(location.href);
      alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    }catch(_){
      prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå:', location.href);
    }
  });

  // ---------------- HUD listeners (D3) ----------------
  window.addEventListener('hha:time', (ev)=>{
    const left = ev && ev.detail ? Number(ev.detail.left||0) : 0;
    vTime.textContent = left ? `${left}s` : '‚Äî';
  }, { passive:true });

  window.addEventListener('hha:score', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    vScore.textContent = String(d.score ?? 0);
    vCombo.textContent = 'x' + String(d.combo ?? 0);
  }, { passive:true });

  window.addEventListener('hha:rank', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    vRank.textContent = String(d.grade ?? '‚Äî');
  }, { passive:true });

  window.addEventListener('groups:group', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    vGroup.textContent = String(d.name ?? '‚Äî');
  }, { passive:true });

  window.addEventListener('groups:director', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    const t = String(d.text ?? '');
    if(t) dirText.textContent = t;
  }, { passive:true });

  // ‚úÖ D7: buff pill
  window.addEventListener('groups:buff', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    const tag = String(d.tag ?? '‚Äî');
    const pct = (d.pct===null || d.pct===undefined) ? '' : ` ${Math.round(Number(d.pct)||0)}%`;
    vBuff.textContent = (tag === '‚Äî') ? '‚Äî' : (tag + pct);

    // optional: show coach text
    if(d.coachText){
      coachWrap.style.display = '';
      coachMood.textContent = String(d.mood || 'neutral');
      coachMsg.textContent = String(d.coachText || '');
      coachMsg.className = 'coachMsg ' + (String(d.mood||'neutral')==='happy'?'happy':String(d.mood||'neutral')==='fever'?'fever':'neutral');
      setTimeout(()=>{ /* auto-hide after a bit */ coachWrap.style.display = ''; }, 10);
    }
  }, { passive:true });

  window.addEventListener('groups:power', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    const charge = Number(d.charge||0);
    const thr = Number(d.threshold||0) || 1;
    pNow.textContent = String(charge);
    pTot.textContent = String(thr);
    const pct = Math.max(0, Math.min(100, (charge/thr)*100));
    pBar.style.width = pct + '%';
  }, { passive:true });

  window.addEventListener('quest:update', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    qTitle.textContent = String(d.goalTitle || '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‚Äî');
    qSub.textContent = `${d.groupName ? ('‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: '+d.groupName+' ¬∑ ') : ''}${d.goalNow ?? 0}/${d.goalTotal ?? 0}`;
    const gp = Number(d.goalPct||0);
    qBar.style.width = Math.max(0, Math.min(100, gp)) + '%';

    mTitle.textContent = String(d.miniTitle || 'MINI: ‚Äî');
    mNow.textContent = String(d.miniNow ?? 0);
    mTot.textContent = String(d.miniTotal ?? 0);
    const left = Number(d.miniTimeLeftSec||0);
    mLeft.textContent = `${left}s`;
    const mp = Number(d.miniPct||0);
    mBar.style.width = Math.max(0, Math.min(100, mp)) + '%';
  }, { passive:true });

  window.addEventListener('hha:coach', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    const text = String(d.text||'');
    if(!text) return;
    const mood = String(d.mood||'neutral');

    coachWrap.style.display = '';
    coachMood.textContent = mood;
    coachMsg.textContent = text;
    coachMsg.className = 'coachMsg ' + (mood==='happy'?'happy':mood==='fever'?'fever':'neutral');

    // auto-hide after 2.2s
    clearTimeout(window.__coachT);
    window.__coachT = setTimeout(()=>{ coachWrap.style.display = 'none'; }, 2200);
  }, { passive:true });

  // FX hook
  window.addEventListener('groups:hit', (ev)=>{
    const d = (ev && ev.detail) ? ev.detail : {};
    const x = Number(d.x||0), y = Number(d.y||0);
    const kind = String(d.kind||'');
    if(!x || !y) return;
    if(kind === 'hit_good') popFx(x,y,'‚úÖ');
    else if(kind === 'hit_bad') popFx(x,y,'‚ö†Ô∏è');
    else if(kind === 'shot_miss') popFx(x,y,'üí•');
    else if(kind === 'timeout_miss') popFx(x,y,'‚è≥');
  }, { passive:true });

  // ---------------- Initial mode pill ----------------
  setModePill(runQ);

  // ---------------- Autostart option ----------------
  // If user comes from hub with run=play and autostart=1, start immediately
  const auto = String(q('autostart','0')) === '1';
  if(auto){
    startGame(runQ, curDiff);
  }

})();
</script>
</body>
</html>