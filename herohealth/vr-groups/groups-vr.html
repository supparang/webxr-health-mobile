<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <link rel="stylesheet" href="./groups-vr.css?v=2" />

  <script src="./audio.js?v=1" defer></script>
  <script src="./groups-quests.js?v=1" defer></script>
  <script src="./GameEngine.js?v=1" defer></script>
</head>

<body>

  <a-scene embedded vr-mode-ui="enabled: true">
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <div id="fg-layer" class="fg-layer" aria-label="playfield"></div>

  <!-- HUD -->
  <div class="hud hud-top">
    <div class="hud-card hud-left">
      <div class="hud-row"><span class="hud-title">SCORE</span><span id="hud-score" class="hud-val">0</span></div>
      <div class="hud-row"><span class="hud-title">COMBO</span><span id="hud-combo" class="hud-val">0</span></div>
      <div class="hud-row"><span class="hud-title">MISS</span><span id="hud-miss" class="hud-val">0</span></div>
    </div>

    <div class="hud-card hud-mid">
      <div class="centerTop">
        <div id="hud-group" class="hud-group">‡∏´‡∏°‡∏π‡πà 1</div>
        <div id="hud-time" class="hud-timer">90</div>
      </div>

      <div class="powerWrap">
        <div class="power-label">
          <span>POWER</span>
          <span><span id="hud-power-now">0</span>/<span id="hud-power-thr">8</span></span>
        </div>
        <div class="power-bar"><div id="power-fill" class="power-fill"></div></div>
      </div>

      <div class="questTop">
        <div class="quest-line" id="hud-goal-line">
          <span class="q-badge">GOAL</span>
          <span id="hud-goal-text" class="q-text">‚Äî</span>
          <span id="hud-goal-num" class="q-num">0/0</span>
        </div>
        <div class="qbar">
          <div class="qbar-track"><div id="hud-goal-fill" class="qbar-fill goal"></div></div>
        </div>

        <div class="quest-line" id="hud-mini-line">
          <span class="q-badge mini">MINI</span>
          <span id="hud-mini-text" class="q-text">‚Äî</span>
          <span id="hud-mini-num" class="q-num">0/0</span>
        </div>
        <div class="qbar">
          <div class="qbar-track"><div id="hud-mini-fill" class="qbar-fill mini"></div></div>
          <div id="hud-mini-timer" class="qbar-timer"></div>
        </div>
      </div>
    </div>

    <div class="hud-card hud-right">
      <div class="rank-box">
        <div class="rank-title">RANK</div>
        <div id="hud-grade" class="rank-grade">C</div>
      </div>
      <div class="rank-sub">
        <span>ACC</span>
        <span id="hud-acc">0%</span>
      </div>

      <!-- ‚úÖ layout tools -->
      <div class="hud-tools">
        <button id="btn-layout" class="hud-btn" type="button">LAYOUT: MIX</button>
      </div>
    </div>
  </div>

  <!-- Coach + Lyric -->
  <div class="coachWrap">
    <div class="coachCard">
      <img id="coach-img" class="coachImg" alt="coach" src="../img/coach-neutral.png">
      <div>
        <div id="coach-text" class="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏´‡∏°? üéÆ</div>
        <div class="coachHint">‡∏•‡∏≤‡∏Å/‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚ÄúVR feel‚Äù ‚Ä¢ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HUD ‡πÇ‡∏ú‡∏•‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î cinema</div>
      </div>
    </div>

    <div id="lyric-bar" class="lyricBar">
      <div class="lyricPulse"></div>
      <div class="lyricTop">
        <div class="lyricTag">üéµ ‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å 5 ‡∏´‡∏°‡∏π‡πà</div>
        <div id="lyric-beat" class="lyricBeat">BEAT</div>
      </div>
      <div id="lyric-text" class="lyricText">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å 5 ‡∏´‡∏°‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‚Ä¶</div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div id="start" class="start-overlay">
    <div class="start-card">
      <h1 class="start-title">Food Groups VR üçéü•¶</h1>
      <p class="start-sub">‡∏¢‡∏¥‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‚Äù ‡∏™‡∏∞‡∏™‡∏° POWER ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà ‚Ä¢ mini quest ‡πÇ‡∏´‡∏î‡πÅ‡∏ï‡πà‡πÅ‡∏ü‡∏£‡πå!</p>

      <div class="start-grid">
        <span class="pill">‡πÇ‡∏´‡∏°‡∏î: <b id="pill-mode">play</b></span>
        <span class="pill">diff: <b id="pill-diff">normal</b></span>
        <span class="pill">time: <b id="pill-time">90</b>s</span>
        <span class="pill">layout: <b id="pill-layout">mix</b></span>
      </div>

      <div class="start-actions">
        <button id="btn-start" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô üéÆ</button>
        <button id="btn-back" class="btn ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="start-note">‡∏ó‡∏¥‡∏õ: Mini ‚ÄúRing Guardian‚Äù ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ñ‡∏π‡∏Å ‚Äú‡πÉ‡∏ô‡∏ß‡∏á‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î cinema ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô HUD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡∏∑‡πà‡∏ô!</div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div id="result" class="result-overlay">
    <div class="result-card">
      <h2 class="start-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</h2>

      <div class="start-grid">
        <span class="pill">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b id="res-score">0</b></span>
        <span class="pill">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b id="res-combo">0</b></span>
        <span class="pill">MISS: <b id="res-miss">0</b></span>
        <span class="pill">ACC: <b id="res-acc">0%</b></span>
        <span class="pill">GRADE: <b id="res-grade">C</b></span>
      </div>

      <div class="result-actions">
        <button id="btn-restart" class="btn primary">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üîÅ</button>
        <button id="btn-back2" class="btn ghost">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const $ = (q)=>document.querySelector(q);
  const params = new URLSearchParams(location.search);

  const runMode = (params.get('runMode') || params.get('run') || 'play').toLowerCase() === 'research' ? 'research' : 'play';
  const diff = (params.get('diff') || 'normal').toLowerCase();
  const time = Number(params.get('time') || 90) || 90;
  const seed = String(params.get('seed') || Date.now());
  const hub = params.get('hub') || '../index.html';

  // ‚úÖ layout: URL param layout= | style=  (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° style=mix)
  const LS_KEY = 'HHA_GROUPS_LAYOUT';
  const fromURL = (params.get('layout') || params.get('style') || '').toLowerCase().trim();
  const fromLS  = (localStorage.getItem(LS_KEY) || '').toLowerCase().trim();
  const LAYOUTS = ['mix','compact','cinema'];

  function normLayout(v){
    v = String(v||'').toLowerCase();
    if (LAYOUTS.includes(v)) return v;
    return 'mix';
  }
  let layout = normLayout(fromURL || fromLS || 'mix');

  function applyLayout(l){
    layout = normLayout(l);
    localStorage.setItem(LS_KEY, layout);

    document.body.classList.remove('groups-layout-mix','groups-layout-compact','groups-layout-cinema');
    document.body.classList.add('groups-layout-' + layout);

    $('#btn-layout').textContent = 'LAYOUT: ' + layout.toUpperCase();
    $('#pill-layout').textContent = layout;

    // cinema starts hidden after game starts; start overlay should show normally
    if (layout !== 'cinema'){
      document.body.classList.remove('groups-hud-hidden','groups-coach-hidden');
    }
  }

  applyLayout(layout);

  $('#pill-mode').textContent = runMode;
  $('#pill-diff').textContent = diff;
  $('#pill-time').textContent = String(time);

  function goHub(){ location.href = hub; }

  // ---------- HUD / Coach auto-hide for cinema ----------
  let revealTimer = null;
  function revealHUD(ms=2200){
    if (layout !== 'cinema') return;
    document.body.classList.remove('groups-hud-hidden','groups-coach-hidden');
    clearTimeout(revealTimer);
    revealTimer = setTimeout(()=>{
      // ‡∏≠‡∏¢‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ start/result
      const startOn = ($('#start') && getComputedStyle($('#start')).display !== 'none');
      const resultOn = ($('#result') && $('#result').classList.contains('show'));
      if (startOn || resultOn) return;
      document.body.classList.add('groups-hud-hidden','groups-coach-hidden');
    }, ms);
  }

  function hideHUDNow(){
    if (layout !== 'cinema') return;
    const startOn = ($('#start') && getComputedStyle($('#start')).display !== 'none');
    const resultOn = ($('#result') && $('#result').classList.contains('show'));
    if (startOn || resultOn) return;
    document.body.classList.add('groups-hud-hidden','groups-coach-hidden');
  }

  // reveal on interactions
  ['pointerdown','pointermove','touchstart','keydown'].forEach(evt=>{
    window.addEventListener(evt, ()=>revealHUD(2400), {passive:true});
  });

  // ---------- UI binders ----------
  window.addEventListener('hha:score', (ev)=>{
    const d = ev.detail || {};
    $('#hud-score').textContent = d.score ?? 0;
    $('#hud-combo').textContent = d.combo ?? 0;
    $('#hud-miss').textContent  = d.misses ?? 0;
  }, {passive:true});

  window.addEventListener('hha:time', (ev)=>{
    const d = ev.detail || {};
    $('#hud-time').textContent = d.left ?? 0;
  }, {passive:true});

  window.addEventListener('groups:power', (ev)=>{
    const d = ev.detail || {};
    const cur = Number(d.charge||0), thr = Math.max(1, Number(d.threshold||1));
    $('#hud-power-now').textContent = String(cur);
    $('#hud-power-thr').textContent = String(thr);
    $('#power-fill').style.width = (cur/thr*100).toFixed(1)+'%';
  }, {passive:true});

  window.addEventListener('quest:update', (ev)=>{
    const d = ev.detail || {};
    $('#hud-goal-text').textContent = d.goalTitle || '‚Äî';
    $('#hud-goal-num').textContent  = `${d.goalNow||0}/${d.goalTotal||0}`;
    $('#hud-goal-fill').style.width = (d.goalPct||0).toFixed(1)+'%';

    $('#hud-mini-text').textContent = d.miniTitle || '‚Äî';
    $('#hud-mini-num').textContent  = `${d.miniNow||0}/${d.miniTotal||0}`;
    $('#hud-mini-fill').style.width = (d.miniPct||0).toFixed(1)+'%';

    const left = d.miniTimeLeftSec || 0;
    $('#hud-mini-timer').textContent = left ? `‚è± ${left}s` : '';

    if (left && left <= 4) $('#hud-mini-line').classList.add('mini-urgent');
    else $('#hud-mini-line').classList.remove('mini-urgent');
  }, {passive:true});

  window.addEventListener('hha:rank', (ev)=>{
    const d = ev.detail || {};
    $('#hud-grade').textContent = d.grade || 'C';
    $('#hud-acc').textContent   = String(d.accuracy ?? 0) + '%';
  }, {passive:true});

  window.addEventListener('hha:coach', (ev)=>{
    const d = ev.detail || {};
    $('#coach-text').textContent = d.text || '';
    const mood = (d.mood || 'neutral').toLowerCase();
    const img = mood === 'happy' ? 'coach-happy.png'
            : mood === 'sad' ? 'coach-sad.png'
            : mood === 'fever' ? 'coach-fever.png'
            : 'coach-neutral.png';
    $('#coach-img').src = '../img/' + img;
  }, {passive:true});

  window.addEventListener('groups:lyric', (ev)=>{
    const d = ev.detail || {};
    if (d.groupId) $('#hud-group').textContent = `‡∏´‡∏°‡∏π‡πà ${d.groupId}`;
    if (d.line) $('#lyric-text').textContent = d.line;
  }, {passive:true});

  window.addEventListener('groups:beat', ()=>{
    const bar = $('#lyric-bar');
    bar.classList.remove('beat');
    void bar.offsetWidth;
    bar.classList.add('beat');
  }, {passive:true});

  window.addEventListener('hha:end', (ev)=>{
    const d = ev.detail || {};
    $('#res-score').textContent = d.scoreFinal ?? 0;
    $('#res-combo').textContent = d.comboMax ?? 0;
    $('#res-miss').textContent  = d.misses ?? 0;
    $('#res-acc').textContent   = String(d.accuracyGoodPct ?? 0) + '%';
    $('#res-grade').textContent = d.grade ?? 'C';
    $('#result').classList.add('show');

    // show HUD when result
    document.body.classList.remove('groups-hud-hidden','groups-coach-hidden');
  }, {passive:true});

  // ---------- buttons ----------
  $('#btn-back').addEventListener('click', goHub);
  $('#btn-back2').addEventListener('click', goHub);

  // cycle layout
  $('#btn-layout').addEventListener('click', ()=>{
    const i = LAYOUTS.indexOf(layout);
    const next = LAYOUTS[(i+1) % LAYOUTS.length];
    applyLayout(next);
    // reveal immediately
    revealHUD(2600);
  });

  function startGame(){
    $('#start').style.display = 'none';
    $('#result').classList.remove('show');

    try{ window.GroupsVR?.Audio?.init?.(); }catch{}

    // Quest
    const q = window.GroupsVR?.createGroupsQuest?.({ diff, runMode, seed });
    if (q && q.onProgress){
      window._GQ = q;
      q.start();
      window.addEventListener('groups:progress', (ev)=>{ try{ q.onProgress(ev); }catch(e){} }, {passive:true});
    }

    // Engine
    try{
      const eng = window.GroupsVR?.GameEngine;
      if (!eng) throw new Error('GameEngine missing');
      eng.setLayerEl(document.getElementById('fg-layer'));
      eng.start(diff, { runMode, time, seed });
    }catch(e){
      alert('Start fail: ' + e.message);
      console.error(e);
      return;
    }

    // cinema: hide after short reveal
    if (layout === 'cinema'){
      revealHUD(1600);
      setTimeout(hideHUDNow, 1800);
    }
  }

  $('#btn-start').addEventListener('click', startGame);
  $('#btn-restart').addEventListener('click', ()=>location.reload());

})();
</script>

</body>
</html>