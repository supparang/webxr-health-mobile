<!-- === /herohealth/vr-groups/groups-vr.html ===
Food Groups VR ‚Äî PRODUCTION (FULL)
‚úÖ Loads: groups-vr.css + boot modules (cache-bust)
‚úÖ HUD: score/combo/miss + group + timer + power + goal/mini + rank
‚úÖ Start overlay with Thai 5-food-groups song (EXACT)
‚úÖ End overlay summary + Back HUB + Save last summary (HHA_LAST_SUMMARY)
‚úÖ Flush-hardened: pagehide/visibilitychange -> stop + persist last summary
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Food Groups VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./groups-vr.css" />

  <!-- A-Frame (optional sky feel + VR button) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
</head>

<body>

  <!-- A-Frame background (embedded) -->
  <a-scene embedded>
    <a-sky color="#06162f"></a-sky>
  </a-scene>

  <!-- HUD -->
  <div class="hud-top" id="hudTop">
    <!-- LEFT -->
    <div class="hud-card hud-left">
      <div class="hud-row"><div class="hud-title">SCORE</div><div class="hud-val" id="hudScore">0</div></div>
      <div class="hud-row"><div class="hud-title">COMBO</div><div class="hud-val" id="hudCombo">0</div></div>
      <div class="hud-row"><div class="hud-title">MISS</div><div class="hud-val" id="hudMiss">0</div></div>
    </div>

    <!-- MID -->
    <div class="hud-card hud-mid">
      <div class="hud-group-row">
        <div class="hud-group" id="hudGroup">‡∏´‡∏°‡∏π‡πà 1</div>
        <div class="hud-timer">‚è≥ <span id="hudTime">90</span>s</div>
      </div>

      <div class="power-wrap">
        <div class="power-label">
          <div>POWER</div>
          <div><span id="hudPowerNow">0</span>/<span id="hudPowerThr">8</span></div>
        </div>
        <div class="power-bar">
          <div class="power-fill" id="hudPowerFill"></div>
        </div>
      </div>

      <div class="quest-wrap">
        <!-- GOAL -->
        <div class="quest-line" id="hud-goal-line">
          <div class="q-badge">GOAL</div>
          <div class="q-text" id="hudGoalText">‚Äî</div>
          <div class="q-num"><span id="hudGoalNow">0</span>/<span id="hudGoalTot">0</span></div>
        </div>
        <div class="qbar">
          <div class="qbar-track"><div class="qbar-fill goal" id="hudGoalFill"></div></div>
        </div>

        <!-- MINI -->
        <div class="quest-line" id="hud-mini-line">
          <div class="q-badge mini">MINI</div>
          <div class="q-text" id="hudMiniText">‚Äî</div>
          <div class="q-num">
            <span id="hudMiniNow">0</span>/<span id="hudMiniTot">0</span>
            &nbsp;‚Ä¢&nbsp;<span id="hudMiniTimer">0</span>s
          </div>
        </div>
        <div class="qbar">
          <div class="qbar-track"><div class="qbar-fill mini" id="hudMiniFill"></div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="hud-card hud-right">
      <div class="rank-box">
        <div>
          <div class="rank-title">RANK</div>
          <div class="rank-sub">
            <div>ACC</div>
            <div><span id="hudAcc">0</span>%</div>
          </div>
        </div>
        <div class="rank-grade" id="hudGrade">C</div>
      </div>
      <div class="start-note" id="hudHint">‚≠ê=Overdrive+Magnet+Shield ‚Ä¢ ‚ùÑÔ∏è=Freeze ‚Ä¢ STORM ‡∏£‡∏∞‡∏ß‡∏±‡∏á!</div>
    </div>
  </div>

  <!-- Gameplay layer -->
  <div class="fg-layer" id="fgLayer" aria-label="playfield"></div>

  <!-- Start overlay -->
  <div class="start-overlay" id="startOverlay">
    <div class="start-card">
      <h1 class="start-title">Food Groups VR üéÆ</h1>
      <p class="start-sub">
        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ï‡∏µ ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏π‡πà‚Äù ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô ‡∏™‡∏∞‡∏™‡∏° POWER ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ ‚Äú‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‚Äù ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br/>
        ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ü´ß ‡∏Ç‡∏¢‡∏∞/‡∏ú‡∏¥‡∏î‡∏´‡∏°‡∏π‡πà/‡∏´‡∏•‡∏≠‡∏Å = MISS + fever ‡∏û‡∏∏‡πà‡∏á!
      </p>

      <div class="start-grid" id="startPills"></div>

      <div class="start-sub" style="margin-top:8px; font-weight:900; opacity:.95;">
        ‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å 5 ‡∏´‡∏°‡∏π‡πà:
      </div>
      <div class="pill" style="width:100%; line-height:1.45; white-space:pre-wrap; font-weight:900;">
‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å 5 ‡∏´‡∏°‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏ú‡∏±‡∏ô
‡∏´‡∏°‡∏π‡πà 1 ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ ‡∏ô‡∏° ‡πÑ‡∏Ç‡πà ‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏Ç‡πá‡∏á‡∏Ç‡∏±‡∏ô
‡∏´‡∏°‡∏π‡πà 2 ‡∏Ç‡πâ‡∏≤‡∏ß ‡πÅ‡∏õ‡πâ‡∏á ‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å ‡∏°‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á
‡∏´‡∏°‡∏π‡πà 3 ‡∏Å‡∏¥‡∏ô‡∏ú‡∏±‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏à‡∏¥‡∏ì
‡∏´‡∏°‡∏π‡πà 4 ‡∏Å‡∏¥‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏á‡∏°‡∏µ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô
‡∏´‡∏°‡∏π‡πà 5 ‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
      </div>

      <div class="start-actions">
        <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô!</button>
        <button class="btn ghost" id="btnBackHubTop">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="start-note">
        Tip: ‡∏•‡∏≤‡∏Å/‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á = VR feel ‚Ä¢ ‚≠ê ‡πÑ‡∏î‡πâ‡∏û‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© ‚Ä¢ STORM ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö+‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à
      </div>
    </div>
  </div>

  <!-- Result overlay -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-card">
      <h2 class="start-title" style="margin:0 0 6px 0;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</h2>
      <p class="start-sub" id="resultSubtitle">‚Äî</p>

      <div class="result-grid" id="resultGrid"></div>

      <div class="result-actions">
        <button class="btn primary" id="btnRestart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn ghost" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="start-note" id="resultNote">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (HHA_LAST_SUMMARY)</div>
    </div>
  </div>

  <script type="module">
    'use strict';

    const ROOT = window;
    const DOC = document;

    const $ = (id)=> DOC.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const pick = (k,d)=> { const v = qs.get(k); return (v==null || v==='') ? d : v; };
    const clamp = (v,a,b)=> { v = Number(v); if(!Number.isFinite(v)) v = a; return Math.max(a, Math.min(b, v)); };

    // params
    const diff = String(pick('diff','normal')).toLowerCase();
    const time = clamp(pick('time','90'), 30, 180);
    const runMode = String(pick('runMode', pick('run','play'))).toLowerCase()==='research' ? 'research' : 'play';
    const style = String(pick('style','mix')).toLowerCase();
    const seed = String(pick('seed', pick('s', Date.now())));
    const hubUrl = (()=>{
      const u = pick('hubUrl', '');
      if (u) return u;
      const hub = pick('hub','');
      if (hub) return hub;
      return '../index.html';
    })();

    // show pills
    const pills = [
      `diff=${diff}`,
      `time=${time}s`,
      `runMode=${runMode}`,
      `style=${style}`,
      `seed=${seed}`
    ];
    $('startPills').innerHTML = pills.map(t=>`<div class="pill">${t}</div>`).join('');

    $('btnBackHubTop').onclick = ()=> { location.href = hubUrl; };

    // Boot modules with cache-bust
    const TS = Date.now();
    const BOOT_LIST = [
      './groups-fx.js',
      './audio.js',
      './groups-quests.js',
      './GameEngine.js',
    ];

    async function bootAll(){
      for (const m of BOOT_LIST){
        await import(`${m}?v=${TS}`);
      }
    }

    // HUD bindings
    function setText(id, v){ const el = $(id); if (el) el.textContent = String(v); }
    function setFill(id, pct){
      const el = $(id);
      if (!el) return;
      const p = Math.max(0, Math.min(100, Number(pct)||0));
      el.style.width = p.toFixed(1)+'%';
    }

    let lastEnd = null;
    let started = false;
    let ending = false;

    function saveLastSummary(payload){
      try{
        const obj = {
          game: 'GroupsVR',
          at: new Date().toISOString(),
          hubUrl,
          params: { diff, time, runMode, style, seed },
          end: payload || {}
        };
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(obj));
      }catch{}
    }

    function renderResult(payload){
      lastEnd = payload || {};
      const acc = lastEnd.accuracyGoodPct ?? 0;
      const grade = lastEnd.grade ?? 'C';

      $('resultOverlay').classList.add('show');
      $('resultSubtitle').textContent =
        `GRADE ${grade} ‚Ä¢ ACC ${acc}% ‚Ä¢ SCORE ${lastEnd.scoreFinal||0} ‚Ä¢ MISS ${lastEnd.misses||0}`;

      const stats = [
        ['Score', lastEnd.scoreFinal||0],
        ['Combo Max', lastEnd.comboMax||0],
        ['Accuracy (Good)', `${acc||0}%`],
        ['Junk Error', `${lastEnd.junkErrorPct||0}%`],
        ['Avg RT (Good)', `${lastEnd.avgRtGoodMs||0} ms`],
        ['Median RT (Good)', `${lastEnd.medianRtGoodMs||0} ms`],
        ['Goals', `${lastEnd.goalsCleared||0}/${lastEnd.goalsTotal||0}`],
        ['Minis', `${lastEnd.miniCleared||0}/${lastEnd.miniTotal||0}`],
      ];

      $('resultGrid').innerHTML = stats.map(([k,v])=>(
        `<div class="stat"><div class="k">${k}</div><div class="v">${v}</div></div>`
      )).join('');

      // save
      saveLastSummary(lastEnd);

      // optional cloud logger (if you have it)
      try{
        const L = ROOT.HHA_CloudLogger || (ROOT.GAME_MODULES && ROOT.GAME_MODULES.CloudLogger);
        if (L && typeof L.log === 'function'){
          L.log({ gameTag:'GroupsVR', params:{diff,time,runMode,style,seed}, end:lastEnd });
        }
      }catch{}
    }

    // listen events from engine
    ROOT.addEventListener('hha:score', (ev)=>{
      const d = (ev && ev.detail) || {};
      setText('hudScore', d.score ?? 0);
      setText('hudCombo', d.combo ?? 0);
      setText('hudMiss', d.misses ?? 0);
    }, { passive:true });

    ROOT.addEventListener('hha:time', (ev)=>{
      const d = (ev && ev.detail) || {};
      setText('hudTime', d.left ?? time);
    }, { passive:true });

    ROOT.addEventListener('groups:power', (ev)=>{
      const d = (ev && ev.detail) || {};
      const nowv = Number(d.charge)||0;
      const thr = Math.max(1, Number(d.threshold)||1);
      setText('hudPowerNow', nowv);
      setText('hudPowerThr', thr);
      setFill('hudPowerFill', (nowv/thr)*100);
    }, { passive:true });

    ROOT.addEventListener('quest:update', (ev)=>{
      const d = (ev && ev.detail) || {};

      setText('hudGoalText', d.goalTitle || '‚Äî');
      setText('hudGoalNow', d.goalNow ?? 0);
      setText('hudGoalTot', d.goalTotal ?? 0);
      setFill('hudGoalFill', d.goalPct ?? 0);

      setText('hudMiniText', d.miniTitle || '‚Äî');
      setText('hudMiniNow', d.miniNow ?? 0);
      setText('hudMiniTot', d.miniTotal ?? 0);
      setFill('hudMiniFill', d.miniPct ?? 0);

      const t = Number(d.miniTimeLeftSec)||0;
      setText('hudMiniTimer', t);

      // urgent style
      const line = $('hud-mini-line');
      if (line){
        if (t > 0 && t <= 3) line.classList.add('mini-urgent');
        else line.classList.remove('mini-urgent');
      }
    }, { passive:true });

    ROOT.addEventListener('hha:rank', (ev)=>{
      const d = (ev && ev.detail) || {};
      setText('hudGrade', d.grade || 'C');
      setText('hudAcc', d.accuracy ?? 0);
    }, { passive:true });

    ROOT.addEventListener('groups:group', (ev)=>{
      const d = (ev && ev.detail) || {};
      const label = d.label || `‡∏´‡∏°‡∏π‡πà ${d.groupId||1}`;
      setText('hudGroup', label);
      DOC.body.dataset.groupId = String(d.groupId||1);
    }, { passive:true });

    ROOT.addEventListener('hha:end', (ev)=>{
      if (ending) return;
      ending = true;
      const d = (ev && ev.detail) || {};
      renderResult(d);
    }, { passive:true });

    function startGame(){
      if (started) return;
      started = true;
      $('startOverlay').style.display = 'none';

      const layer = $('fgLayer');
      if (!ROOT.GroupsVR || !ROOT.GroupsVR.GameEngine) {
        console.warn('GroupsVR.GameEngine not ready');
        return;
      }
      ROOT.GroupsVR.GameEngine.setLayerEl(layer);
      ROOT.GroupsVR.GameEngine.start(diff, { time, runMode, style, seed });

      try{ ROOT.GroupsVR.Audio && ROOT.GroupsVR.Audio.unlock && ROOT.GroupsVR.Audio.unlock(); }catch{}
    }

    function stopGame(reason){
      try{
        if (ROOT.GroupsVR && ROOT.GroupsVR.GameEngine) ROOT.GroupsVR.GameEngine.stop(reason || 'stop');
      }catch{}
    }

    $('btnStart').onclick = startGame;

    $('btnRestart').onclick = ()=>{
      location.href = `${location.pathname}?diff=${encodeURIComponent(diff)}&time=${encodeURIComponent(time)}&runMode=${encodeURIComponent(runMode)}&style=${encodeURIComponent(style)}&seed=${encodeURIComponent(Date.now())}&hubUrl=${encodeURIComponent(hubUrl)}`;
    };

    $('btnBackHub').onclick = ()=>{
      // flush last summary (already saved)
      location.href = hubUrl;
    };

    // flush-hardened
    ROOT.addEventListener('pagehide', ()=>{ stopGame('pagehide'); }, { passive:true });
    DOC.addEventListener('visibilitychange', ()=>{
      if (DOC.visibilityState === 'hidden') stopGame('hidden');
    }, { passive:true });

    // Boot and ready
    await bootAll();
    // show default time
    setText('hudTime', time);

  </script>

</body>
</html>