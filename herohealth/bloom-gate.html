<!-- === /herohealth/bloom-gate.html ===
HeroHealth Bloom Gate ‚Äî FULL (v20260223-C)
‚úÖ stage=analyze|evaluate|create (Bloom)
‚úÖ cat + theme mapping (nutrition/hygiene/exercise)
‚úÖ deterministic pick=day (pid+day+slot+stage+theme) for research
‚úÖ UI: 1 screen, quick tasks, score/miss/total, end -> next
‚úÖ Create stage supports 3-item plan builder (no typing, fast)
‚úÖ Safe, no external deps
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Bloom Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.60);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(900px 650px at 92% 12%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }
    .wrap{
      min-height:100%;
      padding: calc(14px + var(--sat)) calc(12px + var(--sar)) calc(14px + var(--sab)) calc(12px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .shell{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.62));
      border-radius:24px;
      box-shadow:0 16px 60px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .top{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16));
      display:grid; place-items:center; font-weight:1000;
    }
    .title{font-weight:1000}
    .sub{font-size:12px; color:var(--muted); font-weight:800; margin-top:2px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:1000;
      white-space:nowrap;
    }
    .main{
      display:grid; grid-template-columns: 1.2fr .8fr;
      gap:0;
    }
    @media (max-width: 860px){ .main{ grid-template-columns:1fr; } }
    .play{
      position:relative;
      min-height:560px;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(700px 320px at 50% 10%, rgba(34,211,238,.06), transparent 70%),
        linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.06));
      overflow:hidden;
    }
    @media (max-width: 860px){
      .play{ border-right:none; border-bottom:1px solid var(--stroke); min-height:500px; }
    }
    .hud{
      position:absolute; left:10px; right:10px; top:10px;
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px;
      z-index:4;
    }
    .hud .box{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.38);
      border-radius:14px;
      padding:8px 10px;
      text-align:center;
    }
    .hud .k{font-size:10px; color:var(--muted); font-weight:900}
    .hud .v{margin-top:4px; font-size:15px; font-weight:1100}

    .stage{
      position:absolute; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
    }
    .center{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:2;
      pointer-events:none;
    }
    .center .big{
      font-size:64px; line-height:1;
      filter:drop-shadow(0 8px 24px rgba(0,0,0,.35));
    }
    .center .hint{
      margin-top:8px;
      color:rgba(229,231,235,.85);
      font-weight:900;
      font-size:14px;
    }

    .toast{
      position:absolute; left:50%; top:78px; transform:translateX(-50%) translateY(-6px);
      z-index:6;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.78);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px; font-weight:1100;
      opacity:0;
      transition:all .12s ease;
      pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .flash{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .12s ease;
      z-index:5;
    }
    .flash.good{ background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.16), rgba(34,197,94,0)); }
    .flash.bad{  background:radial-gradient(circle at 50% 50%, rgba(239,68,68,.16), rgba(239,68,68,0)); }

    .side{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
      background:rgba(2,6,23,.22);
    }
    .card{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.34);
      border-radius:18px;
      padding:12px;
    }
    .card h3{
      margin:0;
      font-size:14px;
      font-weight:1000;
    }
    .muted{
      color:rgba(229,231,235,.74);
      font-size:12px;
      line-height:1.35;
      font-weight:750;
    }
    .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
    }
    .row .k{ color:var(--muted); font-weight:900; }
    .row .v{ font-weight:1000; text-align:right; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.30);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000; font-size:13px;
      min-height:42px;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.30);
      background:rgba(34,197,94,.14);
    }
    .btn.warn{
      border-color:rgba(245,158,11,.32);
      background:rgba(245,158,11,.12);
    }

    .end{
      position:absolute; inset:0;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      z-index:9;
      padding:16px;
    }
    .end .panel{
      width:min(560px,100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .end h3{ margin:0; font-size:16px; font-weight:1100; }
    .kv{
      margin-top:10px;
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;
    }
    .kv .item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:14px;
      padding:8px 10px;
    }
    .kv .k{ font-size:10px; color:var(--muted); font-weight:900; }
    .kv .v{ margin-top:4px; font-size:13px; font-weight:1000; word-break:break-word; }

    @media (max-width:560px){
      .hud{ grid-template-columns:repeat(2,minmax(0,1fr)); top:8px; left:8px; right:8px; }
      .top{ padding:10px 12px; }
      .side{ padding:12px; }
      .kv{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">HH</div>
          <div>
            <div class="title" id="gameTitle">Bloom Gate</div>
            <div class="sub" id="subLine">Analyze ‚Üí Evaluate ‚Üí Create</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="pillStage">STAGE: ANALYZE</div>
          <div class="chip" id="pillCat">CAT: NUTRITION</div>
          <div class="chip" id="pillTheme">THEME: GOODJUNK</div>
          <div class="chip" id="pillMode">PICK: DAY</div>
        </div>
      </div>

      <div class="main">
        <div class="play">
          <div class="hud">
            <div class="box"><div class="k">TIME</div><div class="v" id="hudTime">25s</div></div>
            <div class="box"><div class="k">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="box"><div class="k">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="box"><div class="k">TOTAL</div><div class="v" id="hudTotal">0</div></div>
          </div>

          <div class="stage" id="stage" aria-live="polite">
            <div class="center" id="center">
              <div class="big" id="big">üß†</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
            </div>
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="end" id="endOverlay" aria-hidden="true">
            <div class="panel">
              <h3 id="endTitle">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h3>
              <div class="muted" id="endMsg" style="margin-top:6px;">‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>

              <div class="kv">
                <div class="item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
                <div class="item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
                <div class="item"><div class="k">STAGE</div><div class="v" id="endStage">‚Äî</div></div>
                <div class="item"><div class="k">NEXT</div><div class="v" id="endNext">YES</div></div>
              </div>

              <div class="btnrow" style="margin-top:12px;">
                <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
                <button class="btn primary" id="btnContinue">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="card">
            <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bloom</h3>
            <div class="muted" id="desc" style="margin-top:6px;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö Bloom ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏°</div>

            <div style="margin-top:10px; display:grid; gap:8px;">
              <div class="row"><div class="k">Stage</div><div class="v" id="stageText">analyze</div></div>
              <div class="row"><div class="k">Theme</div><div class="v" id="themeText">goodjunk</div></div>
              <div class="row"><div class="k">Duration</div><div class="v" id="durText">25s</div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
              <button class="btn warn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
            </div>
          </div>

          <div class="card">
            <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            <div class="muted" style="margin-top:6px;">
              ‚Ä¢ Analyze = ‡πÅ‡∏¢‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏™‡∏¥‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç<br/>
              ‚Ä¢ Evaluate = ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡πâ‡∏°/‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î<br/>
              ‚Ä¢ Create = ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô/‡∏™‡∏£‡πâ‡∏≤‡∏á routine 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ<br/>
              ‚Ä¢ research ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ pick=day (deterministic)
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $= (id)=>DOC.getElementById(id);

  function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch{ return url; }
  }
  function buildUrl(base, params){
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  function todayKeyLocal(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function hash32(str){
    let h = 2166136261 >>> 0;
    const s = String(str || '');
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  const stageKind = String(q('stage', q('bloom','analyze'))).toLowerCase().trim(); // analyze|evaluate|create
  const cat   = String(q('cat','nutrition')).toLowerCase().trim();
  const theme = String(q('theme','goodjunk')).toLowerCase().trim();
  const pick  = String(q('pick','')).toLowerCase().trim() || 'day';
  const run   = String(q('run','play')).toLowerCase().trim();
  const pid   = String(q('pid','anon')).trim() || 'anon';
  const slot  = String(q('planSlot','')).toLowerCase().trim();
  const hub   = absUrlMaybe(q('hub','../hub.html')) || '../hub.html';
  const next0 = absUrlMaybe(q('next', hub)) || hub;

  const dur = clamp(qNum('dur', stageKind==='create'?30:25), 10, 120);

  // UI refs
  const pillStage=$('pillStage'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillMode=$('pillMode');
  const gameTitle=$('gameTitle'), subLine=$('subLine'), desc=$('desc');
  const stageText=$('stageText'), themeText=$('themeText'), durText=$('durText');

  const stageEl=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');
  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');

  const btnStart=$('btnStart'), btnSkip=$('btnSkip');

  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endMiss=$('endMiss'), endStage=$('endStage'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }
  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }

  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let raf=0, lastTs=0;
  let teardownFns=[];

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudTotal.textContent = String(total);
  }

  function clearStage(){
    teardownFns.forEach(fn=>{ try{ fn(); }catch{} });
    teardownFns=[];
    Array.from(stageEl.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch{}
    });
    center.style.display='block';
    big.textContent = (stageKind==='create')?'üõ†Ô∏è':(stageKind==='evaluate')?'‚öñÔ∏è':'üß†';
    hint.textContent = '‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ';
  }

  function endNow(){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf);
    raf=0;

    const nextUrl = next0 || hub;

    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');
    endTitle.textContent = `Bloom ${stageKind.toUpperCase()} ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!`;
    endMsg.textContent = '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
    endScore.textContent = String(score);
    endMiss.textContent  = String(miss);
    endStage.textContent = stageKind;
    endNext.textContent  = nextUrl ? 'YES' : 'HUB';

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(nextUrl || hub);
  }

  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);
    setHUD();
    if(tLeft<=0){ endNow(); return; }
    raf = requestAnimationFrame(tick);
  }

  // ---------- deterministic picker ----------
  function pickDet(arr, key){
    if(!arr.length) return null;
    if(pick!=='day') return arr[(Math.random()*arr.length)|0];
    const day=todayKeyLocal();
    const seed = `${pid}|${day}|${slot}|${run}|${stageKind}|${theme}|${key||'k'}`;
    const idx = hash32(seed) % arr.length;
    return arr[idx];
  }

  // ---------- helpers ----------
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stageEl.appendChild(pad);
    return pad;
  }

  // ==========================================================
  // BLOOM TASKS (theme-aware)
  // ==========================================================

  function runAnalyze(){
    // Analyze: ‡πÅ‡∏¢‡∏Å "‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç/‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏ú‡∏•" ‡πÉ‡∏´‡πâ‡πÑ‡∏ß
    gameTitle.textContent = `Analyze ‚Äî ${cat.toUpperCase()} / ${theme.toUpperCase()}`;
    desc.textContent = '‡πÅ‡∏ï‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà ‚Äú‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏£‡∏¥‡∏á‚Äù (signal) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';

    const pools = {
      nutrition: {
        goodjunk: [
          {t:'‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', ok:1},{t:'‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô', ok:0},{t:'‡∏ú‡∏±‡∏Å', ok:1},{t:'‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°', ok:0},
          {t:'‡∏ú‡∏•‡πÑ‡∏°‡πâ', ok:1},{t:'‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î', ok:0},
        ],
        groups: [
          {t:'‡∏´‡∏°‡∏π‡πà 1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', ok:1},{t:'‡∏´‡∏°‡∏π‡πà 2 ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö', ok:1},{t:'‡∏´‡∏°‡∏π‡πà 6', ok:0},{t:'‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏à‡∏±‡∏î', ok:0},
          {t:'‡∏´‡∏°‡∏π‡πà 3 ‡∏ú‡∏±‡∏Å', ok:1},{t:'‡∏´‡∏°‡∏π‡πà 4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ', ok:1},{t:'‡∏´‡∏°‡∏π‡πà 5 ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', ok:1},
        ],
        hydration: [
          {t:'‡∏õ‡∏≤‡∏Å‡πÅ‡∏´‡πâ‡∏á', ok:1},{t:'‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏Ç‡πâ‡∏°', ok:1},{t:'‡∏á‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏∂‡∏Å', ok:0},{t:'‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πà‡∏á', ok:1},
        ],
        plate: [
          {t:'‡∏°‡∏µ‡∏ú‡∏±‡∏Å', ok:1},{t:'‡∏°‡∏µ‡∏ú‡∏•‡πÑ‡∏°‡πâ', ok:1},{t:'‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô', ok:0},{t:'‡∏Ñ‡∏£‡∏ö ‚â•3 ‡∏´‡∏°‡∏π‡πà', ok:1},
        ]
      },
      hygiene: {
        handwash: [
          {t:'‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß', ok:1},{t:'‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', ok:1},{t:'‡∏à‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π', ok:1},{t:'‡πÅ‡∏Ñ‡πà‡∏à‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠', ok:0},
        ],
        brush: [
          {t:'‡πÅ‡∏õ‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô', ok:1},{t:'‡πÅ‡∏õ‡∏£‡∏á 10 ‡∏ß‡∏¥', ok:0},{t:'‡πÅ‡∏õ‡∏£‡∏á‡∏ú‡∏¥‡∏ß‡∏ü‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô', ok:1},{t:'‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏´‡∏°‡∏Ç‡∏±‡∏î‡∏ü‡∏±‡∏ô‡πÄ‡∏•‡∏¢', ok:0},
        ],
        maskcough: [
          {t:'‡πÑ‡∏≠/‡∏à‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å', ok:1},{t:'‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏≠‡∏≠‡∏±‡∏î‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', ok:1},{t:'‡πÑ‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©', ok:0},
        ],
        germdetective: [
          {t:'‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡πà‡∏ß‡∏°', ok:1},{t:'‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà', ok:1},{t:'‡πÄ‡∏î‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°', ok:0},{t:'‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á', ok:1},
        ],
        bath: [
          {t:'‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ö (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏π/‡∏£‡∏±‡∏Å‡πÅ‡∏£‡πâ)', ok:1},{t:'‡∏ü‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πâ‡∏≤‡∏á', ok:1},{t:'‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß', ok:0},
        ],
        cleanobjects: [
          {t:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π', ok:1},{t:'‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ', ok:1},{t:'‡∏ú‡∏ô‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏±‡∏ö', ok:0},{t:'‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß', ok:1},
        ]
      },
      exercise: {
        shadow: [
          {t:'‡πÄ‡∏õ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á (normal)', ok:1},{t:'decoy ‡∏´‡∏•‡∏≠‡∏Å', ok:0},{t:'boss target', ok:1},{t:'bomb ‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏•‡∏≤‡∏î', ok:0},
        ],
        rhythm: [
          {t:'‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ï‡∏£‡∏á hit line', ok:1},{t:'‡∏ï‡∏µ‡∏°‡∏±‡πà‡∏ß ‡πÜ', ok:0},{t:'calibration ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', ok:1},
        ],
        jumpduck: [
          {t:'‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á', ok:1},{t:'‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', ok:0},{t:'‡∏´‡∏•‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ä‡πà‡∏ß‡∏á', ok:1},
        ],
        balancehold: [
          {t:'‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á', ok:1},{t:'‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏£‡∏á ‡πÜ', ok:0},{t:'‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á', ok:1},
        ],
        planner: [
          {t:'‡∏à‡∏±‡∏î‡πÅ‡∏ú‡∏ô 3 ‡∏ä‡πà‡∏ß‡∏á', ok:1},{t:'‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', ok:0},{t:'‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á', ok:1},
        ]
      }
    };

    const list =
      (pools[cat] && pools[cat][theme]) ||
      (pools[cat] && pools[cat].goodjunk) ||
      [{t:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á',ok:1},{t:'‡∏´‡∏•‡∏≠‡∏Å',ok:0}];

    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'48%',transform:'translate(-50%,-50%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">ANALYZE: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏£‡∏¥‡∏á‚Äù</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞ ‚Äú‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‚Äù</div>
      <div id="q" style="margin-top:12px;font-size:18px;font-weight:1100;">‚Äî</div>`;
    stageEl.appendChild(card);

    const pad=mkPad(2);
    const b1=mkBtn('‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'); b1.classList.add('primary');
    const b0=mkBtn('‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç');
    b1.style.padding='14px 12px'; b0.style.padding='14px 12px';
    pad.appendChild(b1); pad.appendChild(b0);

    let cur = pickDet(list, 'analyze');
    function next(){
      total++;
      cur = pickDet(list, 'analyze-'+total) || list[(Math.random()*list.length)|0];
      card.querySelector('#q').textContent = cur.t;
    }
    function choose(v){
      if(!started) return;
      if(!!v === !!cur.ok){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }
    b1.addEventListener('click', ()=>choose(1));
    b0.addEventListener('click', ()=>choose(0));
    teardownFns.push(()=>{ b1.onclick=null; b0.onclick=null; });

    next();
  }

  function runEvaluate(){
    // Evaluate: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà "‡∏Ñ‡∏∏‡πâ‡∏°/‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" (‡∏°‡∏µ 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    gameTitle.textContent = `Evaluate ‚Äî ${cat.toUpperCase()} / ${theme.toUpperCase()}`;
    desc.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù';

    center.style.display='none';

    const casesByTheme = {
      goodjunk: [
        {q:'‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?', a:['üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ','üç© ‡πÇ‡∏î‡∏ô‡∏±‡∏ó','ü•§ ‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô'], ok:0},
        {q:'‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏£‡∏î‡∏∑‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£?', a:['ü•§ ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°','üßã ‡∏ä‡∏≤‡∏ô‡∏°','üíß ‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤'], ok:2},
      ],
      groups: [
        {q:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏´‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏π‡πà 1 (‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô) ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?', a:['üêü ‡∏õ‡∏•‡∏≤','üçö ‡∏Ç‡πâ‡∏≤‡∏ß','üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ'], ok:0},
        {q:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏´‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏π‡πà 3 (‡∏ú‡∏±‡∏Å)?', a:['ü•¶ ‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ','ü•õ ‡∏ô‡∏°','üçû ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á'], ok:0},
      ],
      hydration: [
        {q:'‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', a:['üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥','ü•§ ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‚è≥ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÄ‡∏≠‡∏á'], ok:0},
        {q:'‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏Ç‡πâ‡∏° ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤?', a:['‡∏Ñ‡∏ß‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°','‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡∏µ','‡∏Ñ‡∏ß‡∏£‡∏á‡∏î‡∏ô‡πâ‡∏≥'], ok:0},
      ],
      plate: [
        {q:'‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°?', a:['‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏°‡∏ó‡∏≠‡∏î'], ok:0},
      ],
      handwash: [
        {q:'‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏∑‡∏≠‡∏™‡∏Å‡∏õ‡∏£‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', a:['‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ö‡∏π‡πà','‡πÄ‡∏ä‡πá‡∏î‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á','‡∏•‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏£‡πá‡∏ß ‡πÜ'], ok:0},
      ],
      brush: [
        {q:'‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠?', a:['‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô','‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ','‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ä‡πâ‡∏≤'], ok:0},
      ],
      maskcough: [
        {q:'‡πÑ‡∏≠‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', a:['‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡πÑ‡∏≠‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏â‡∏¢ ‡πÜ','‡∏ñ‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'], ok:0},
      ],
      germdetective: [
        {q:'‡πÄ‡∏à‡∏≠‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡πà‡∏ß‡∏° ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô?', a:['‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô','‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à','‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£'], ok:0},
      ],
      bath: [
        {q:'‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏Ç‡πâ‡∏≤‡∏°?', a:['‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ö','‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á','‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á'], ok:0},
      ],
      cleanobjects: [
        {q:'‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πà‡∏≠‡∏ô?', a:['‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π','‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î','‡∏ú‡∏ô‡∏±‡∏á‡∏°‡∏∏‡∏°‡∏´‡πâ‡∏≠‡∏á'], ok:0},
      ],
      shadow: [
        {q:'‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏´‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ï‡∏µ?', a:['‡πÄ‡∏õ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á','decoy','‡∏´‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á'], ok:0},
      ],
      rhythm: [
        {q:'‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', a:['‡∏ï‡∏µ‡∏ï‡∏£‡∏á hit line','‡∏ï‡∏µ‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î','‡∏ï‡∏µ‡∏°‡∏±‡πà‡∏ß'], ok:0},
      ],
      jumpduck: [
        {q:'‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≥ ‡∏Ñ‡∏ß‡∏£?', a:['DUCK','JUMP','‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô'], ok:0},
      ],
      balancehold: [
        {q:'‡∏à‡∏∞‡∏Ñ‡∏∏‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏ß‡∏£?', a:['‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á','‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏£‡∏á ‡πÜ','‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏õ'], ok:0},
      ],
      planner: [
        {q:'‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠?', a:['‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤-‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô-‡πÄ‡∏¢‡πá‡∏ô','‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠','‡∏ó‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î'], ok:0},
      ],
    };

    const list = casesByTheme[theme] || casesByTheme.goodjunk;

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'44%',transform:'translate(-50%,-50%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">EVALUATE: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
      <div id="q" style="margin-top:10px;font-size:18px;font-weight:1100;">‚Äî</div>
      <div class="muted" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
    stageEl.appendChild(card);

    const pad=mkPad(1);
    pad.style.gridTemplateColumns='1fr';
    let cur = pickDet(list, 'eval');

    function next(){
      total++;
      cur = pickDet(list, 'eval-'+total) || list[(Math.random()*list.length)|0];
      card.querySelector('#q').textContent = cur.q;
      pad.innerHTML='';
      cur.a.forEach((txt,i)=>{
        const b=mkBtn(txt);
        b.style.padding='14px 12px'; b.style.borderRadius='16px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(i===cur.ok){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          next();
        });
      });
    }
    next();
  }

  function runCreate(){
    // Create: ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äúmini routine‚Äù 3 ‡∏Ç‡∏±‡πâ‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏ä‡∏¥‡πâ‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏°
    gameTitle.textContent = `Create ‚Äî ${cat.toUpperCase()} / ${theme.toUpperCase()}`;
    desc.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏°‡πÄ‡∏Å‡∏°';

    center.style.display='none';

    const lib = {
      nutrition: {
        goodjunk: ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏µ','‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤','‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏≤‡∏Å‡∏´‡∏ß‡∏≤‡∏ô'],
        groups: ['‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏°‡∏π‡πà','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å','‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô','‡∏Ñ‡∏∏‡∏°‡πÅ‡∏õ‡πâ‡∏á','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ'],
        hydration: ['‡∏à‡∏¥‡∏ö‡∏ô‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô','‡∏î‡∏π‡∏™‡∏µ‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞','‡∏û‡∏Å‡∏Ç‡∏ß‡∏î‡∏ô‡πâ‡∏≥','‡∏î‡∏∑‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏£‡∏á','‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô'],
        plate: ['‡πÄ‡∏ï‡∏¥‡∏°‡∏ú‡∏±‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏à‡∏≤‡∏ô','‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏û‡∏≠‡∏î‡∏µ','‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì','‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î']
      },
      hygiene: {
        handwash: ['‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô','‡∏ñ‡∏π‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß','‡∏ñ‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á','‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÄ‡∏ä‡πá‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏´‡πâ‡∏á'],
        brush: ['‡πÅ‡∏õ‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô','‡πÅ‡∏õ‡∏£‡∏á 2 ‡∏ô‡∏≤‡∏ó‡∏µ','‡πÅ‡∏õ‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô','‡πÉ‡∏ä‡πâ‡πÑ‡∏´‡∏°‡∏Ç‡∏±‡∏î‡∏ü‡∏±‡∏ô','‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å‡∏û‡∏≠‡∏î‡∏µ'],
        maskcough: ['‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å','‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞','‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å','‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏≠'],
        germdetective: ['‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡πà‡∏ß‡∏°','‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏û‡∏£‡πà','‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î','‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á','‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ã‡πâ‡∏≥'],
        bath: ['‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß','‡∏ü‡∏≠‡∏Å‡∏™‡∏ö‡∏π‡πà','‡∏ñ‡∏π‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ö','‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î','‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß/‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤'],
        cleanobjects: ['‡πÄ‡∏ä‡πá‡∏î‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π','‡πÄ‡∏ä‡πá‡∏î‡∏£‡∏µ‡πÇ‡∏°‡∏ï','‡πÄ‡∏ä‡πá‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß','‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏î','‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏¢']
      },
      exercise: {
        shadow: ['‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏û 1 ‡∏ô‡∏≤‡∏ó‡∏µ','‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏õ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á','‡∏´‡∏•‡∏ö bomb','‡∏û‡∏±‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à','‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î'],
        rhythm: ['‡∏ï‡∏±‡πâ‡∏á cal ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á','‡∏ï‡∏µ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞','‡∏û‡∏±‡∏Å‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πâ‡∏ô ‡πÜ','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î','‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏´‡∏≤‡∏¢‡πÉ‡∏à'],
        jumpduck: ['‡∏¢‡∏∑‡∏î‡πÄ‡∏Ç‡πà‡∏≤','‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á','‡∏™‡∏•‡∏±‡∏ö jump/duck','‡∏û‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢','‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô'],
        balancehold: ['‡∏ï‡∏±‡πâ‡∏á‡∏ó‡πà‡∏≤‡∏¢‡∏∑‡∏ô','‡∏°‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà','‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á','‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á','‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö'],
        planner: ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡πÅ‡∏ö‡πà‡∏á 3 ‡∏ä‡πà‡∏ß‡∏á','‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á','‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á','‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ú‡∏•']
      }
    };

    const pool =
      (lib[cat] && lib[cat][theme]) ||
      (lib[cat] && lib[cat].goodjunk) ||
      ['‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô 1','‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô 2','‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô 3','‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô 4'];

    const chosen = [];
    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'44%',transform:'translate(-50%,-50%)',
      width:'min(820px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">CREATE: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô 3 ‡∏Ç‡∏±‡πâ‡∏ô</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏Ç‡∏±‡πâ‡∏ô (‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™)</div>
      <div id="plan" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
      <div id="opts" style="margin-top:12px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;"></div>`;
    stageEl.appendChild(card);

    const planEl=card.querySelector('#plan');
    const optsEl=card.querySelector('#opts');

    function renderPlan(){
      planEl.innerHTML='';
      for(let i=0;i<3;i++){
        const box=DOC.createElement('div');
        box.style.border='1px solid rgba(148,163,184,.18)';
        box.style.borderRadius='16px';
        box.style.background='rgba(2,6,23,.35)';
        box.style.padding='10px 12px';
        box.style.minHeight='60px';
        const txt = chosen[i] || '‡∏ß‡πà‡∏≤‡∏á';
        box.innerHTML = `<div style="font-weight:1100;">‡∏Ç‡∏±‡πâ‡∏ô ${i+1}</div><div class="muted" style="margin-top:6px;">${txt}</div>`;
        planEl.appendChild(box);

        box.addEventListener('click', ()=>{
          if(!started) return;
          if(!chosen[i]) return;
          total++;
          chosen.splice(i,1);
          miss++; toastShow('UNDO'); flashBad();
          renderPlan();
        });
      }
    }

    function renderOpts(){
      optsEl.innerHTML='';
      const pickList = [];
      const n = Math.min(8, pool.length);
      // deterministic select candidate set
      for(let i=0;i<n;i++){
        const it = pickDet(pool, 'create-opt-'+i) || pool[i];
        if(!pickList.includes(it)) pickList.push(it);
      }
      while(pickList.length < n){
        const it = pool[(Math.random()*pool.length)|0];
        if(!pickList.includes(it)) pickList.push(it);
      }

      pickList.forEach(txt=>{
        const b=mkBtn(txt);
        b.style.padding='12px 10px';
        b.style.borderRadius='16px';
        optsEl.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(chosen.includes(txt)){ miss++; toastShow('DUP'); flashBad(); return; }
          if(chosen.length>=3){ miss++; toastShow('FULL'); flashBad(); return; }
          chosen.push(txt);
          score++; toastShow('+1'); flashGood();
          renderPlan();

          if(chosen.length===3){
            score += 2;
            toastShow('+BONUS');
            flashGood();
          }
        });
      });
    }

    renderPlan();
    renderOpts();
  }

  function start(){
    clearStage();
    score=0; miss=0; total=0;
    tLeft=dur; lastTs=0;
    setHUD();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    if(stageKind==='create') runCreate();
    else if(stageKind==='evaluate') runEvaluate();
    else runAnalyze();

    raf = requestAnimationFrame(tick);
  }

  function skip(){
    const target = next0 || hub;
    location.replace(target);
  }

  // header pills
  pillStage.textContent = `STAGE: ${stageKind.toUpperCase()}`;
  pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
  pillTheme.textContent = `THEME: ${theme.toUpperCase()}`;
  pillMode.textContent  = `PICK: ${(pick||'day').toUpperCase()}`;

  stageText.textContent = stageKind;
  themeText.textContent = theme;
  durText.textContent = `${dur}s`;

  subLine.textContent = `Bloom: ${stageKind} ‚Ä¢ ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠`;
  desc.textContent = '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö Bloom ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏°';

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  stageEl.addEventListener('pointerdown', ()=>{
    if(!started) start();
  }, {passive:true});

  btnToHub.onclick = ()=> location.href = hub;
  btnContinue.onclick = ()=> location.replace(next0 || hub);

  setHUD();
})();
</script>
</body>
</html>