<!-- === /herohealth/bloom-gate.html ===
HeroHealth Bloom Gate ‚Äî FULL (v20260223-C)
‚úÖ Bloom Level: Analyze / Evaluate / Create (default=C=Evaluate+Create micro)
‚úÖ Cat = Zone (nutrition/hygiene/exercise)
‚úÖ Theme = Game (goodjunk/groups/hydration/plate/handwash/brush/maskcough/germdetective/bath/clean/shadow/rhythm/jumpduck/balance/planner)
‚úÖ Pick policy compatible with HUB: ?theme / ?game / ?pick=rand|day + research default day
‚úÖ Deterministic (pick=day) uses pid+cat+day(+slot)+bloom
‚úÖ Preserves plan sequence params + hub context
‚úÖ Outputs bloom result via URL: bLevel, bScore, bMiss, bTotal, bRank, bKey
‚úÖ Safe PC/Mobile, no deps
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Bloom Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.60);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(900px 650px at 92% 12%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }
    .wrap{
      min-height:100%;
      padding: calc(14px + var(--sat)) calc(12px + var(--sar)) calc(14px + var(--sab)) calc(12px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .shell{
      width:min(1020px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.62));
      border-radius:24px;
      box-shadow:0 16px 60px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .top{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16));
      display:grid; place-items:center; font-weight:1000;
    }
    .title{font-weight:1000}
    .sub{font-size:12px; color:var(--muted); font-weight:800; margin-top:2px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:1000;
      white-space:nowrap;
    }

    .main{ display:grid; grid-template-columns: 1.2fr .8fr; gap:0; }
    @media (max-width: 860px){ .main{ grid-template-columns:1fr; } }

    .play{
      position:relative;
      min-height:580px;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(700px 320px at 50% 10%, rgba(167,139,250,.08), transparent 70%),
        linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.06));
      overflow:hidden;
    }
    @media (max-width: 860px){
      .play{ border-right:none; border-bottom:1px solid var(--stroke); min-height:520px; }
    }

    .hud{
      position:absolute; left:10px; right:10px; top:10px;
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px; z-index:4;
    }
    .hud .box{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.38);
      border-radius:14px;
      padding:8px 10px;
      text-align:center;
    }
    .hud .k{font-size:10px; color:var(--muted); font-weight:900}
    .hud .v{margin-top:4px; font-size:15px; font-weight:1100}

    .stage{
      position:absolute; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      user-select:none; -webkit-user-select:none;
    }
    .center{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:2;
      pointer-events:none;
    }
    .center .big{ font-size:64px; line-height:1; filter:drop-shadow(0 8px 24px rgba(0,0,0,.35)); }
    .center .hint{ margin-top:8px; color:rgba(229,231,235,.85); font-weight:900; font-size:14px; }

    .toast{
      position:absolute; left:50%; top:78px; transform:translateX(-50%) translateY(-6px);
      z-index:6;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.78);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px; font-weight:1100;
      opacity:0;
      transition:all .12s ease;
      pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .flash{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .12s ease;
      z-index:5;
    }
    .flash.good{ background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.16), rgba(34,197,94,0)); }
    .flash.bad{  background:radial-gradient(circle at 50% 50%, rgba(239,68,68,.16), rgba(239,68,68,0)); }

    .side{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
      background:rgba(2,6,23,.22);
    }
    .card{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.34);
      border-radius:18px;
      padding:12px;
    }
    .card h3{ margin:0; font-size:14px; font-weight:1000; }
    .muted{ color:rgba(229,231,235,.74); font-size:12px; line-height:1.35; font-weight:750; }
    .meta{ margin-top:8px; display:grid; gap:8px; }
    .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
    }
    .row .k{ color:var(--muted); font-weight:900; }
    .row .v{ font-weight:1000; text-align:right; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.30);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000; font-size:13px;
      min-height:42px;
    }
    .btn.primary{ border-color:rgba(167,139,250,.32); background:rgba(167,139,250,.14); }
    .btn.warn{ border-color:rgba(245,158,11,.32); background:rgba(245,158,11,.12); }

    .end{
      position:absolute; inset:0;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      z-index:9;
      padding:16px;
    }
    .end .panel{
      width:min(620px,100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .end h3{ margin:0; font-size:16px; font-weight:1100; }
    .kv{
      margin-top:10px;
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;
    }
    .kv .item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:14px;
      padding:8px 10px;
    }
    .kv .k{ font-size:10px; color:var(--muted); font-weight:900; }
    .kv .v{ margin-top:4px; font-size:13px; font-weight:1000; word-break:break-word; }

    @media (max-width:560px){
      .hud{ grid-template-columns:repeat(2,minmax(0,1fr)); top:8px; left:8px; right:8px; }
      .center .big{ font-size:56px; }
      .center .hint{ font-size:13px; }
      .top{ padding:10px 12px; }
      .side{ padding:12px; }
      .kv{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">HH</div>
          <div>
            <div class="title" id="pageTitle">Bloom Gate</div>
            <div class="sub" id="subLine">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏ö‡∏ö C ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="pillBloom">BLOOM: C</div>
          <div class="chip" id="pillCat">CAT: NUTRITION</div>
          <div class="chip" id="pillTheme">THEME: GOODJUNK</div>
          <div class="chip" id="pillPick">PICK: DAY</div>
        </div>
      </div>

      <div class="main">
        <div class="play">
          <div class="hud">
            <div class="box"><div class="k">TIME</div><div class="v" id="hudTime">25s</div></div>
            <div class="box"><div class="k">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="box"><div class="k">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="box"><div class="k">TOTAL</div><div class="v" id="hudTotal">0</div></div>
          </div>

          <div class="stage" id="stage" aria-live="polite">
            <div class="center" id="center">
              <div class="big" id="big">üß†</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à Bloom</div>
            </div>
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="end" id="endOverlay" aria-hidden="true">
            <div class="panel">
              <h3 id="endTitle">Bloom ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h3>
              <div class="muted" id="endMsg" style="margin-top:6px;">‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>

              <div class="kv">
                <div class="item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
                <div class="item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
                <div class="item"><div class="k">RANK</div><div class="v" id="endRank">B</div></div>
                <div class="item"><div class="k">NEXT</div><div class="v" id="endNext">YES</div></div>
              </div>

              <div class="btnrow" style="margin-top:12px;">
                <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
                <button class="btn primary" id="btnContinue">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="card">
            <h3>Bloom Mission</h3>
            <div class="muted" id="desc" style="margin-top:6px;">
              ‡πÇ‡∏´‡∏°‡∏î C: ‡πÄ‡∏ô‡πâ‡∏ô ‚Äú‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à/‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‚Äù ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
            </div>

            <div class="meta">
              <div class="row"><div class="k">Bloom Level</div><div class="v" id="bloomText">C</div></div>
              <div class="row"><div class="k">Duration</div><div class="v" id="durText">25s</div></div>
              <div class="row"><div class="k">Deterministic</div><div class="v" id="detText">ON (pick=day)</div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
              <button class="btn warn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
            </div>
          </div>

          <div class="card">
            <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            <div class="muted" style="margin-top:6px;">
              ‚Ä¢ Bloom ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ú‡πà‡∏≤‡∏ô URL (bLevel/bScore/...) ‡πÑ‡∏õ‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ<br/>
              ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î research ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô pick=day ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ repeat ‡πÑ‡∏î‡πâ<br/>
              ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö plan sequence params ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô warmup-gate
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $=(id)=>DOC.getElementById(id);

  function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch{ return url; }
  }

  function getLocalDayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function applyPlanSeqParams(u){
    [
      'planSeq','planDay','planSlot','planMode','planSlots','planIndex','autoNext',
      'plannedGame','finalGame','zone'
    ].forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });
    return u;
  }

  function hash32(str){
    let h = 2166136261 >>> 0;
    str = String(str || '');
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function zoneThemePool(category){
    const c = String(category || '').toLowerCase();
    if(c === 'nutrition') return ['goodjunk','groups','hydration','plate'];
    if(c === 'hygiene')   return ['handwash','brush','maskcough','germdetective','bath','clean'];
    if(c === 'exercise')  return ['shadow','rhythm','jumpduck','balance','planner'];
    return ['goodjunk','groups','hydration','plate'];
  }

  const bloom = String(q('bloom', q('b','c'))).toLowerCase().trim() || 'c'; // a|b|c
  const cat   = String(q('cat','nutrition')).toLowerCase();
  const hub   = absUrlMaybe(q('hub','./hub.html')) || './hub.html';
  const next0 = absUrlMaybe(q('next','')) || hub;

  const themeFromQs = String(q('theme','')).toLowerCase().trim();
  const pid = String(q('pid','')).trim() || 'anon';

  const pickQS = String(q('pick','')).toLowerCase().trim();
  const run = String(q('run','play')).toLowerCase().trim();
  const pickMode = (pickQS==='rand' || pickQS==='day') ? pickQS : (run==='research' ? 'day' : 'rand');

  function pickTheme(){
    if(themeFromQs) return themeFromQs;
    const g = String(q('game','')).toLowerCase().trim();
    if(g) return g;

    const pool = zoneThemePool(cat);
    if(!pool.length) return 'goodjunk';

    if(pickMode === 'rand'){
      return pool[(Math.random()*pool.length)|0];
    }

    // day deterministic
    const dayKey = getLocalDayKey();
    const slot = String(q('planSlot','')).toLowerCase().trim();
    const seed = `${pid}|${dayKey}|${slot}|${cat}|${run}|bloom|${bloom}`;
    const idx = hash32(seed) % pool.length;
    return pool[idx];
  }

  const themeKey = pickTheme();

  // UI refs
  const pillBloom=$('pillBloom'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillPick=$('pillPick');
  const pageTitle=$('pageTitle'), subLine=$('subLine'), desc=$('desc');
  const bloomText=$('bloomText'), durText=$('durText'), detText=$('detText');

  const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');

  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');

  const btnStart=$('btnStart'), btnSkip=$('btnSkip');
  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endMiss=$('endMiss'), endRank=$('endRank'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }

  // duration policy: Bloom C ~ 25s default
  const dur = clamp(qNum('dur', 25), 10, 90);

  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let raf=0, lastTs=0;
  let stageAnimRaf=0;
  let teardownFns=[];

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudTotal.textContent = String(total);
  }

  function clearStage(){
    cancelAnimationFrame(stageAnimRaf); stageAnimRaf=0;
    teardownFns.forEach(fn=>{ try{ fn(); }catch{} });
    teardownFns=[];
    Array.from(stage.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch{}
    });
    center.style.display='block';
    big.textContent='üß†';
    hint.textContent='‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥ Bloom mission ‡∏™‡∏±‡πâ‡∏ô ‡πÜ';
  }

  // --- helper UI creators ---
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stage.appendChild(pad);
    return pad;
  }
  function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function shuffle(a){
    a = a.slice();
    for(let i=a.length-1;i>0;i--){
      const j=(Math.random()*(i+1))|0;
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // ============================================================
  // BLOOM MISSIONS (C) ‚Äî fast Evaluate/Create micro tasks
  // ============================================================

  // C/Nutrition: Evaluate ‚Äúwhich plate is better‚Äù (fast compare) + Create ‚Äúpick 3 groups‚Äù
  function missionC_Nutrition(){
    pageTitle.textContent='Bloom C ‚Äî Nutrition';
    desc.textContent='‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‚Äú‡∏à‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‚Äù + ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏π‡πà';
    center.style.display='none';

    // Part 1: Evaluate
    const evalCard=DOC.createElement('div');
    Object.assign(evalCard.style,{
      position:'absolute',left:'50%',top:'34%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.52)'
    });
    evalCard.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Evaluate) ‡∏à‡∏≤‡∏ô‡πÑ‡∏´‡∏ô ‚Äú‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Å‡∏ß‡πà‡∏≤‚Äù ?</div>
      <div class="muted" style="text-align:center; margin-top:4px;">‡πÅ‡∏ï‡∏∞ A ‡∏´‡∏£‡∏∑‡∏≠ B</div>
      <div id="row" style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div id="A" style="border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:12px; background:rgba(2,6,23,.28); text-align:center;">
          <div style="font-weight:1100;">Plate A</div>
          <div id="aemo" style="font-size:32px; margin-top:8px;">üçöü•¶üçé</div>
          <div class="muted" id="albl" style="margin-top:6px;">3 ‡∏´‡∏°‡∏π‡πà</div>
        </div>
        <div id="B" style="border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:12px; background:rgba(2,6,23,.28); text-align:center;">
          <div style="font-weight:1100;">Plate B</div>
          <div id="bemo" style="font-size:32px; margin-top:8px;">üçüüçîü•§</div>
          <div class="muted" id="blbl" style="margin-top:6px;">Junk-heavy</div>
        </div>
      </div>`;
    stage.appendChild(evalCard);

    // deterministic-ish question set (use hash if pick=day)
    const qset = [
      {A:['üçö','ü•¶','üçé'], Ag:3, B:['üçî','üçü','ü•§'], Bg:1, ok:'A'},
      {A:['ü•ö','üçö','ü•¶'], Ag:3, B:['üçû','üçû','üçû'], Bg:1, ok:'A'},
      {A:['ü•õ','üêü','ü•ë'], Ag:2, B:['üçö','ü•¶','üçé','ü•ë'], Bg:4, ok:'B'},
      {A:['üç©','üç¨','ü•§'], Ag:0, B:['üçö','üêü','ü•¶'], Bg:3, ok:'B'},
      {A:['üçö','üçö','üçö'], Ag:1, B:['üçö','ü•¶','üçé'], Bg:3, ok:'B'},
    ];
    let qi = 0;

    function stableIndex(){
      if(pickMode!=='day') return 0;
      const dayKey=getLocalDayKey();
      const slot = String(q('planSlot','')).toLowerCase().trim();
      return hash32(`${pid}|${dayKey}|${slot}|C|nutrition`) % qset.length;
    }
    qi = stableIndex();

    const aemo=evalCard.querySelector('#aemo');
    const bemo=evalCard.querySelector('#bemo');
    const albl=evalCard.querySelector('#albl');
    const blbl=evalCard.querySelector('#blbl');

    function renderQ(){
      const qq = qset[qi % qset.length];
      aemo.textContent = qq.A.join('');
      bemo.textContent = qq.B.join('');
      albl.textContent = `‡∏´‡∏°‡∏π‡πà‡∏£‡∏ß‡∏° ~ ${qq.Ag}`;
      blbl.textContent = `‡∏´‡∏°‡∏π‡πà‡∏£‡∏ß‡∏° ~ ${qq.Bg}`;
    }
    function answer(which){
      if(!started) return;
      total++;
      const qq = qset[qi % qset.length];
      if(which===qq.ok){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      qi++;
      renderQ();
    }
    evalCard.querySelector('#A').addEventListener('click', ()=>answer('A'));
    evalCard.querySelector('#B').addEventListener('click', ()=>answer('B'));

    teardownFns.push(()=>{ try{ evalCard.remove(); }catch{} });

    renderQ();

    // Part 2: Create quick (pick 3 distinct groups)
    const createCard=DOC.createElement('div');
    Object.assign(createCard.style,{
      position:'absolute',left:'50%',top:'64%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.44)'
    });
    createCard.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Create) ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ‚Äú‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏´‡∏°‡∏π‡πà‚Äù</div>
      <div class="muted" id="ct" style="text-align:center; margin-top:4px;">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: 0 ‡∏´‡∏°‡∏π‡πà</div>
      <div style="text-align:center; font-size:34px; margin-top:8px;">üçΩÔ∏è</div>
    `;
    stage.appendChild(createCard);

    const picked = new Set();
    const ct=createCard.querySelector('#ct');

    const pad = mkPad(5);
    const items = [
      {emo:'üêü', g:1},{emo:'ü•ö', g:1},{emo:'ü•õ', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},{emo:'ü•î', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},
    ];
    shuffle(items).slice(0,10).forEach(it=>{
      const b=mkBtn(it.emo);
      b.style.padding='14px 8px'; b.style.borderRadius='16px'; b.style.fontSize='18px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>{
        if(!started) return;
        total++;
        if(!picked.has(it.g)){
          picked.add(it.g);
          score++; toastShow('+1'); flashGood();
        }else{
          miss++; toastShow('MISS'); flashBad();
        }
        ct.textContent = `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${picked.size} ‡∏´‡∏°‡∏π‡πà`;
        if(picked.size>=3){
          // small bonus once
          if(!ct.dataset.bonus){
            ct.dataset.bonus='1';
            score += 2; toastShow('+BONUS'); flashGood();
          }
        }
      });
    });

    teardownFns.push(()=>{ try{ createCard.remove(); }catch{} });
  }

  // C/Hygiene: Evaluate ‚Äúpriority cleaning‚Äù + Create ‚Äúroutine order‚Äù
  function missionC_Hygiene(){
    pageTitle.textContent='Bloom C ‚Äî Hygiene';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô + ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö routine ‡∏™‡∏±‡πâ‡∏ô ‡πÜ';
    center.style.display='none';

    const cases = [
      {q:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π', w:3, emo:'üö™'},
      {q:'‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ', w:3, emo:'üì∫'},
      {q:'‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', w:3, emo:'üçΩÔ∏è'},
      {q:'‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏ö', w:1, emo:'ü™ë'},
      {q:'‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î', w:1, emo:'üßΩ'},
      {q:'‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏ü', w:2, emo:'üí°'},
      {q:'‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠', w:3, emo:'üì±'},
    ];

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'42%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.52)'
    });
    card.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Evaluate) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‚Äù</div>
      <div class="muted" style="text-align:center; margin-top:4px;">‡πÅ‡∏ï‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏à‡∏±‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô</div>
      <div id="grid" style="margin-top:10px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
      <div class="muted" id="hint2" style="text-align:center; margin-top:8px;">‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å = +1 (‡∏ó‡∏≥‡∏ú‡∏¥‡∏î = MISS)</div>
    `;
    stage.appendChild(card);

    const grid = card.querySelector('#grid');

    function stablePick3(){
      const pool = cases.slice();
      if(pickMode==='day'){
        const dayKey=getLocalDayKey();
        const slot = String(q('planSlot','')).toLowerCase().trim();
        let h = hash32(`${pid}|${dayKey}|${slot}|C|hygiene`);
        // deterministic shuffle
        for(let i=pool.length-1;i>0;i--){
          const j = (h % (i+1))|0;
          [pool[i],pool[j]]=[pool[j],pool[i]];
          h = (h * 1103515245 + 12345) >>> 0;
        }
      }else{
        for(let i=pool.length-1;i>0;i--){
          const j=(Math.random()*(i+1))|0;
          [pool[i],pool[j]]=[pool[j],pool[i]];
        }
      }
      return pool.slice(0,3);
    }

    let trio = stablePick3();
    function render(){
      grid.innerHTML='';
      const best = trio.reduce((a,b)=> (b.w>a.w?b:a), trio[0]);
      trio.forEach(it=>{
        const b = mkBtn(`${it.emo} ${it.q}`);
        b.style.borderRadius='16px';
        b.style.padding='12px';
        b.style.fontSize='12px';
        b.style.textAlign='left';
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(it===best){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          trio = stablePick3();
          render();
        });
        grid.appendChild(b);
      });
    }
    render();

    // Create: arrange routine order (tap in correct order)
    const routine = ['‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á','‡πÄ‡∏ä‡πá‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™','‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠','‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠'];
    const order = (pickMode==='day')
      ? routine.slice() // stable
      : shuffle(routine);

    const card2=DOC.createElement('div');
    Object.assign(card2.style,{
      position:'absolute',left:'50%',top:'74%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.44)'
    });
    card2.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Create) ‡πÅ‡∏ï‡∏∞‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö routine: 1‚Üí4</div>
      <div class="muted" id="rt" style="text-align:center; margin-top:4px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠ 1</div>
      <div id="rpad" style="margin-top:10px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;"></div>
    `;
    stage.appendChild(card2);

    const rpad = card2.querySelector('#rpad');
    const rt = card2.querySelector('#rt');
    let idx=0;
    const options = shuffle(order);

    function renderRoutine(){
      rpad.innerHTML='';
      options.forEach(step=>{
        const b = mkBtn(step);
        b.style.borderRadius='16px';
        b.style.padding='12px';
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(step===order[idx]){
            score++; toastShow('+1'); flashGood();
            idx++;
            rt.textContent = (idx>=order.length) ? '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! +BONUS' : `‡∏ï‡πà‡∏≠‡πÑ‡∏õ: ‡∏Ç‡πâ‡∏≠ ${idx+1}`;
            if(idx>=order.length){
              if(!rt.dataset.bonus){ rt.dataset.bonus='1'; score += 2; toastShow('+BONUS'); flashGood(); }
              idx=0; // loop
            }
          }else{
            miss++; toastShow('MISS'); flashBad();
          }
        });
        rpad.appendChild(b);
      });
    }
    renderRoutine();

    teardownFns.push(()=>{ try{ card.remove(); card2.remove(); }catch{} });
  }

  // C/Exercise: Evaluate ‚Äúchoose safer/better action‚Äù + Create ‚Äúmini plan pick 3‚Äù
  function missionC_Exercise(){
    pageTitle.textContent='Bloom C ‚Äî Exercise';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞ + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ';
    center.style.display='none';

    const cases = [
      {q:'‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', ok:'‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏û', a:['‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î','‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏û','‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô'], emo:'üèÉ'},
      {q:'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å/‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', ok:'‡∏û‡∏±‡∏Å/‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥', a:['‡∏ù‡∏∑‡∏ô‡∏ï‡πà‡∏≠','‡∏û‡∏±‡∏Å/‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°'], emo:'üíß'},
      {q:'‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏£‡∏á ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ô‡πâ‡∏ô?', ok:'‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ï/‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô', a:['‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ï/‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô','‡∏ô‡∏≠‡∏ô‡πÄ‡∏â‡∏¢','‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°'], emo:'üí™'},
      {q:'‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', ok:'‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå', a:['‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå','‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠','‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≠'], emo:'üßò'},
    ];

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.52)'
    });
    card.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Evaluate) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
      <div id="qq" style="margin-top:8px; font-size:16px; font-weight:1000; text-align:center;">‚Äî</div>
      <div id="qe" style="margin-top:6px; font-size:40px; text-align:center;">üí™</div>
      <div id="pad" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
    `;
    stage.appendChild(card);

    const qq=card.querySelector('#qq');
    const qe=card.querySelector('#qe');
    const pad=card.querySelector('#pad');

    let idx = 0;
    if(pickMode==='day'){
      const dayKey=getLocalDayKey();
      const slot = String(q('planSlot','')).toLowerCase().trim();
      idx = hash32(`${pid}|${dayKey}|${slot}|C|exercise`) % cases.length;
    }else idx = (Math.random()*cases.length)|0;

    function render(){
      const c = cases[idx % cases.length];
      qq.textContent = c.q;
      qe.textContent = c.emo;
      pad.innerHTML='';
      const opts = shuffle(c.a);
      opts.forEach(ans=>{
        const b=mkBtn(ans);
        b.style.borderRadius='16px';
        b.style.padding='12px';
        b.style.fontSize='12px';
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(ans===c.ok){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          idx++;
          render();
        });
        pad.appendChild(b);
      });
    }
    render();

    // Create: choose 3 activities
    const acts=['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß','‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö','‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô','‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ï','‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà','‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå'];
    const chosen=[];
    const card2=DOC.createElement('div');
    Object.assign(card2.style,{
      position:'absolute',left:'50%',top:'76%',transform:'translate(-50%,-50%)',
      width:'min(860px,94%)',padding:'12px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)', background:'rgba(2,6,23,.44)'
    });
    card2.innerHTML = `
      <div style="font-weight:1100; text-align:center;">(Create) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
      <div class="muted" id="ct" style="text-align:center; margin-top:4px;">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: 0/3</div>
      <div id="apad" style="margin-top:10px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
    `;
    stage.appendChild(card2);

    const ct = card2.querySelector('#ct');
    const apad = card2.querySelector('#apad');
    const pick = shuffle(acts).slice(0,6);

    pick.forEach(a=>{
      const b=mkBtn(a);
      b.style.borderRadius='16px';
      b.style.padding='12px';
      b.style.fontSize='12px';
      b.addEventListener('click', ()=>{
        if(!started) return;
        total++;
        if(chosen.includes(a)){
          miss++; toastShow('MISS'); flashBad();
          return;
        }
        chosen.push(a);
        score++; toastShow('+1'); flashGood();
        ct.textContent = `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${chosen.length}/3`;
        if(chosen.length>=3){
          if(!ct.dataset.bonus){ ct.dataset.bonus='1'; score += 2; toastShow('+BONUS'); flashGood(); }
        }
      });
      apad.appendChild(b);
    });

    teardownFns.push(()=>{ try{ card.remove(); card2.remove(); }catch{} });
  }

  function runBloomC(){
    // choose by category
    if(cat==='hygiene') return missionC_Hygiene();
    if(cat==='exercise') return missionC_Exercise();
    return missionC_Nutrition();
  }

  function rankFromAcc(acc){
    if(acc>=0.88) return 'S';
    if(acc>=0.74) return 'A';
    if(acc>=0.58) return 'B';
    return 'C';
  }

  function buildNextUrl(){
    const u = new URL(next0 || hub, location.href);

    // pass-through common context
    [
      'hub','run','diff','time','seed','studyId','conditionGroup','log','view','pid','researchPhase'
    ].forEach(k=>{
      const v=q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });

    // preserve research phase
    const rp=q('researchPhase','');
    if(rp && !u.searchParams.has('phase')) u.searchParams.set('phase', rp);

    // bloom outputs
    const acc = (total>0) ? (score/Math.max(1,total)) : 0;
    const bRank = rankFromAcc(acc);

    u.searchParams.set('bloom', bloom.toUpperCase());
    u.searchParams.set('bLevel', bloom.toUpperCase());
    u.searchParams.set('bScore', String(score));
    u.searchParams.set('bMiss', String(miss));
    u.searchParams.set('bTotal', String(total));
    u.searchParams.set('bRank', String(bRank));
    u.searchParams.set('bKey', `${cat}:${themeKey}`);

    applyPlanSeqParams(u);
    return u.toString();
  }

  function endNow(){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf); raf=0;
    cancelAnimationFrame(stageAnimRaf); stageAnimRaf=0;

    const nextUrl = buildNextUrl();
    const acc = (total>0) ? (score/Math.max(1,total)) : 0;
    const bRank = rankFromAcc(acc);

    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');
    endTitle.textContent = 'Bloom (C) ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
    endMsg.textContent = '‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô warmup ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á) ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
    endScore.textContent = String(score);
    endMiss.textContent = String(miss);
    endRank.textContent = bRank;
    endNext.textContent = nextUrl ? 'YES' : 'HUB';

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(nextUrl || hub);
  }

  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);
    setHUD();
    if(tLeft<=0){
      endNow();
      return;
    }
    raf = requestAnimationFrame(tick);
  }

  function start(){
    clearStage();
    score=0; miss=0; total=0;
    tLeft=dur; lastTs=0;
    setHUD();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    // Only implement C now (as requested)
    runBloomC();

    subLine.textContent = 'Bloom C ‚Äî ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠';
    raf = requestAnimationFrame(tick);
  }

  function skip(){
    const u = new URL(next0 || hub, location.href);
    applyPlanSeqParams(u);
    location.replace(u.toString());
  }

  // ---- init pills ----
  pillBloom.textContent = `BLOOM: ${String(bloom||'c').toUpperCase()}`;
  pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
  pillTheme.textContent = `THEME: ${themeKey.toUpperCase()}`;
  pillPick.textContent  = `PICK: ${pickMode.toUpperCase()}`;

  bloomText.textContent = String(bloom||'c').toUpperCase();
  durText.textContent = `${dur}s`;
  detText.textContent = (pickMode==='day') ? 'ON (pick=day)' : 'OFF (pick=rand)';

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  stage.addEventListener('pointerdown', ()=>{
    if(!started) start();
  }, {passive:true});

  WIN.addEventListener('visibilitychange', ()=>{
    if(DOC.hidden && started) endNow();
  });

})();
</script>
</body>
</html>