<!-- === /herohealth/bloom-gate.html ===
HeroHealth Bloom Gate ‚Äî FULL (v20260224-ABC)
‚úÖ bloom=a|b|c (default c)
‚úÖ deterministic variants 1..5 by pid+day+slot+cat+theme+bloom (or override ?variant=)
‚úÖ daily once-per-day per PID+cat+bloom (auto-skip)
‚úÖ next= can point to warmup-gate (so flow: Bloom -> Warmup -> Game)
‚úÖ planSeq passthrough
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Bloom Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.60);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(900px 650px at 92% 12%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }
    .wrap{
      min-height:100%;
      padding: calc(14px + var(--sat)) calc(12px + var(--sar)) calc(14px + var(--sab)) calc(12px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .shell{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.62));
      border-radius:24px;
      box-shadow:0 16px 60px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .top{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16));
      display:grid; place-items:center; font-weight:1000;
    }
    .title{font-weight:1000}
    .sub{font-size:12px; color:var(--muted); font-weight:800; margin-top:2px}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:1000;
      white-space:nowrap;
    }

    .main{ display:grid; grid-template-columns: 1.2fr .8fr; gap:0; }
    @media (max-width: 860px){ .main{ grid-template-columns:1fr; } }

    .play{
      position:relative;
      min-height:560px;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(700px 320px at 50% 10%, rgba(34,211,238,.06), transparent 70%),
        linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.06));
      overflow:hidden;
    }
    @media (max-width: 860px){
      .play{ border-right:none; border-bottom:1px solid var(--stroke); min-height:520px; }
    }

    .hud{
      position:absolute; left:10px; right:10px; top:10px;
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px;
      z-index:4;
    }
    .hud .box{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.38);
      border-radius:14px;
      padding:8px 10px;
      text-align:center;
    }
    .hud .k{font-size:10px; color:var(--muted); font-weight:900}
    .hud .v{margin-top:4px; font-size:15px; font-weight:1100}

    .stage{
      position:absolute; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
      padding-top:64px;
    }
    .center{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:2;
      pointer-events:none;
    }
    .center .big{ font-size:56px; line-height:1; filter:drop-shadow(0 8px 24px rgba(0,0,0,.35)); }
    .center .hint{ margin-top:8px; color:rgba(229,231,235,.85); font-weight:900; font-size:14px; }

    .flash{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .12s ease;
      z-index:5;
    }
    .flash.good{ background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.16), rgba(34,197,94,0)); }
    .flash.bad{  background:radial-gradient(circle at 50% 50%, rgba(239,68,68,.16), rgba(239,68,68,0)); }

    .toast{
      position:absolute; left:50%; top:78px; transform:translateX(-50%) translateY(-6px);
      z-index:6;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.78);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px; font-weight:1100;
      opacity:0;
      transition:all .12s ease;
      pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .side{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
      background:rgba(2,6,23,.22);
    }
    .card{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.34);
      border-radius:18px;
      padding:12px;
    }
    .card h3{ margin:0; font-size:14px; font-weight:1000; }
    .muted{ color:rgba(229,231,235,.74); font-size:12px; line-height:1.35; font-weight:750; }
    .meta{ margin-top:8px; display:grid; gap:8px; }
    .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
    }
    .row .k{ color:var(--muted); font-weight:900; }
    .row .v{ font-weight:1000; text-align:right; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.30);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000; font-size:13px;
      min-height:42px;
    }
    .btn.primary{ border-color:rgba(34,197,94,.30); background:rgba(34,197,94,.14); }
    .btn.warn{ border-color:rgba(245,158,11,.32); background:rgba(245,158,11,.12); }

    .end{
      position:absolute; inset:0;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      z-index:9;
      padding:16px;
    }
    .end .panel{
      width:min(560px,100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .end h3{ margin:0; font-size:16px; font-weight:1100; }
    .kv{
      margin-top:10px;
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;
    }
    .kv .item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:14px;
      padding:8px 10px;
    }
    .kv .k{ font-size:10px; color:var(--muted); font-weight:900; }
    .kv .v{ margin-top:4px; font-size:13px; font-weight:1000; word-break:break-word; }

    @media (max-width:560px){
      .hud{ grid-template-columns:repeat(2,minmax(0,1fr)); top:8px; left:8px; right:8px; }
      .center .big{ font-size:50px; }
      .center .hint{ font-size:13px; }
      .kv{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">HH</div>
          <div>
            <div class="title" id="gameTitle">Bloom Gate</div>
            <div class="sub" id="subLine">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à Bloom ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="pillBloom">BLOOM: C</div>
          <div class="chip" id="pillCat">CAT: NUTRITION</div>
          <div class="chip" id="pillTheme">THEME: GOODJUNK</div>
          <div class="chip" id="pillDaily">DAILY: NEW</div>
        </div>
      </div>

      <div class="main">
        <div class="play">
          <div class="hud">
            <div class="box"><div class="k">TIME</div><div class="v" id="hudTime">20s</div></div>
            <div class="box"><div class="k">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="box"><div class="k">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="box"><div class="k">TOTAL</div><div class="v" id="hudTotal">0</div></div>
          </div>

          <div class="stage" id="stage" aria-live="polite">
            <div class="center" id="center">
              <div class="big" id="big">üß†</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à Bloom ‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
            </div>
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="end" id="endOverlay" aria-hidden="true">
            <div class="panel">
              <h3 id="endTitle">Bloom ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</h3>
              <div class="muted" id="endMsg" style="margin-top:6px;">‡πÑ‡∏õ‡∏ï‡πà‡∏≠ Warmup ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>

              <div class="kv">
                <div class="item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
                <div class="item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
                <div class="item"><div class="k">VARIANT</div><div class="v" id="endVar">1</div></div>
                <div class="item"><div class="k">NEXT</div><div class="v" id="endNext">YES</div></div>
              </div>

              <div class="btnrow" style="margin-top:12px;">
                <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
                <button class="btn primary" id="btnContinue">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="card">
            <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bloom</h3>
            <div class="muted" id="desc" style="margin-top:6px;">Bloom A/B/C ‚Äî ‡∏™‡∏±‡πâ‡∏ô ‡πÅ‡∏ï‡πà ‚Äú‡∏Ñ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‚Äù</div>

            <div class="meta">
              <div class="row"><div class="k">Status</div><div class="v" id="statusText">ready</div></div>
              <div class="row"><div class="k">Duration</div><div class="v" id="durText">20s</div></div>
              <div class="row"><div class="k">Daily Rule</div><div class="v">‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î/‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô/‡∏ï‡πà‡∏≠ PID/‡∏ï‡πà‡∏≠ Bloom</div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
              <button class="btn warn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
            </div>
          </div>

          <div class="card">
            <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            <div class="muted" style="margin-top:6px;">
              ‚Ä¢ C = ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç<br/>
              ‚Ä¢ variant 1..5 deterministic (‡∏´‡∏£‡∏∑‡∏≠ override ‡∏î‡πâ‡∏ß‡∏¢ ?variant=)<br/>
              ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ï‡πà‡∏≠ cat+bloom+pid) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $=(id)=>DOC.getElementById(id);

  function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch{ return String(url||''); }
  }
  function buildUrl(base, params){
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  function getLocalDayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function dailyKey(prefix, category, bloom, pid){
    const day=getLocalDayKey();
    const p=(pid||'anon').trim()||'anon';
    return `${prefix}:${category}:${bloom}:${p}:${day}`;
  }
  function isDaily(prefix, category, bloom, pid){
    try{ return localStorage.getItem(dailyKey(prefix,category,bloom,pid))==='1'; }catch{ return false; }
  }
  function markDaily(prefix, category, bloom, pid){
    try{ localStorage.setItem(dailyKey(prefix,category,bloom,pid),'1'); }catch{}
  }

  function applyPlanSeqParams(u){
    [
      'planSeq','planDay','planSlot','planMode','planSlots','planIndex','autoNext',
      'plannedGame','finalGame','zone'
    ].forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });
    return u;
  }

  function hash32(str){
    let h = 2166136261 >>> 0;
    str = String(str || '');
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  const bloom = String(q('bloom','c')).toLowerCase().trim();     // a|b|c
  const cat   = String(q('cat','nutrition')).toLowerCase().trim();
  const theme = String(q('theme','')).toLowerCase().trim() || 'goodjunk';
  const hub   = absUrlMaybe(q('hub','./hub.html')) || './hub.html';
  const next0 = absUrlMaybe(q('next','')) || hub;
  const pid   = String(q('pid','')).trim() || 'anon';

  const dur = clamp(qNum('dur', 18), 8, 40); // bloom ‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤ warmup
  const dailyPrefix = 'HHA_BLOOM_DONE';
  const dailyDone = isDaily(dailyPrefix, cat, bloom, pid);

  // deterministic variant 1..5 (override ?variant=)
  function resolveVariant(){
    const ov = clamp(qNum('variant', 0), 0, 5);
    if(ov>=1 && ov<=5) return ov;

    const pick = String(q('pick','')).toLowerCase().trim();
    const run = String(q('run','play')).toLowerCase().trim();
    const mode = (pick==='rand' || pick==='day') ? pick : (run==='research' ? 'day' : 'rand');
    if(mode==='rand') return 1 + ((Math.random()*5)|0);

    const slot = String(q('planSlot','')).toLowerCase().trim();
    const dayKey = getLocalDayKey();
    const seed = `${pid}|${dayKey}|${slot}|${cat}|${theme}|${bloom}|bloom-gate`;
    return 1 + (hash32(seed) % 5);
  }
  const variant = resolveVariant();

  const pillBloom=$('pillBloom'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillDaily=$('pillDaily');
  const subLine=$('subLine'), statusText=$('statusText'), durText=$('durText');
  const gameTitle=$('gameTitle'), desc=$('desc');
  const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');

  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');

  const btnStart=$('btnStart'), btnSkip=$('btnSkip');

  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endMiss=$('endMiss'), endVar=$('endVar'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }

  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let raf=0, lastTs=0;
  let stageAnimRaf=0;
  let teardownFns=[];

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudTotal.textContent = String(total);
  }

  function clearStage(){
    cancelAnimationFrame(stageAnimRaf);
    stageAnimRaf = 0;
    teardownFns.forEach(fn=>{ try{ fn(); }catch{} });
    teardownFns = [];

    Array.from(stage.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch{}
    });

    center.style.display='block';
    big.textContent='üß†';
    hint.textContent='‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Bloom ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°';
  }

  function endNow(){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf);
    cancelAnimationFrame(stageAnimRaf);
    raf = 0; stageAnimRaf = 0;

    markDaily(dailyPrefix, cat, bloom, pid);

    const u = new URL(next0 || hub, location.href);
    applyPlanSeqParams(u);

    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');
    endTitle.textContent = `Bloom ${bloom.toUpperCase()} ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`;
    endScore.textContent = String(score);
    endMiss.textContent  = String(miss);
    endVar.textContent   = String(variant);
    endNext.textContent  = (next0 ? 'YES' : 'HUB');
    endMsg.textContent   = '‡πÑ‡∏õ‡∏ï‡πà‡∏≠ Warmup ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(u.toString());
  }

  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);
    setHUD();
    if(tLeft<=0){ endNow(); return; }
    raf = requestAnimationFrame(tick);
  }

  function autoSkipIfDaily(){
    if(!dailyDone) return false;

    subLine.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ Bloom ‡πÅ‡∏•‡πâ‡∏ß (pid=${pid}, cat=${cat}, bloom=${bloom}) ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    statusText.textContent = 'Daily gate: DONE';

    setTimeout(()=>{
      try{
        const u = new URL(next0 || hub, location.href);
        applyPlanSeqParams(u);
        location.replace(u.toString());
      }catch(_){
        location.replace(next0 || hub);
      }
    }, 220);

    return true;
  }

  function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stage.appendChild(pad);
    return pad;
  }

  // ============================================================
  // BLOOM MISSIONS (A/B/C) ‚Äî variants 1..5 (theme-aware)
  // ============================================================

  function missionTitle(){
    return `Bloom ${bloom.toUpperCase()} ‚Ä¢ ${cat.toUpperCase()} ‚Ä¢ ${theme.toUpperCase()} ‚Ä¢ V${variant}`;
  }

  function setMetaText(){
    pillBloom.textContent = `BLOOM: ${bloom.toUpperCase()}`;
    pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
    pillTheme.textContent = `THEME: ${theme.toUpperCase()}`;
    pillDaily.textContent = dailyDone ? 'DAILY: DONE' : 'DAILY: NEW';
    durText.textContent = `${dur}s`;
  }

  // A: Recall (‡∏á‡πà‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡πá‡∏ß)
  function runA(){
    gameTitle.textContent = missionTitle();
    desc.textContent = 'A (Remember): ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
    center.style.display='none';

    const qaPool = {
      nutrition: [
        {q:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà 1 ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', opts:['‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô','‡∏Ñ‡∏≤‡∏£‡πå‡∏ö','‡∏ú‡∏±‡∏Å','‡∏ú‡∏•‡πÑ‡∏°‡πâ'], ok:0},
        {q:'‡∏´‡∏°‡∏π‡πà 5 ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', opts:['‡∏ú‡∏±‡∏Å','‡πÑ‡∏Ç‡∏°‡∏±‡∏ô','‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô'], ok:1},
        {q:'‡∏´‡∏°‡∏π‡πà 3 ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', opts:['‡∏Ñ‡∏≤‡∏£‡πå‡∏ö','‡∏ú‡∏±‡∏Å','‡πÑ‡∏Ç‡∏°‡∏±‡∏ô','‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô'], ok:1},
      ],
      hygiene: [
        {q:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', opts:['‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß','‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠','‡∏ß‡∏¥‡πà‡∏á','‡∏î‡∏π‡∏ó‡∏µ‡∏ß‡∏µ'], ok:0},
        {q:'‡πÑ‡∏≠/‡∏à‡∏≤‡∏°‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', opts:['‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô','‡∏ß‡∏¥‡πà‡∏á‡∏´‡∏ô‡∏µ','‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô'], ok:0},
        {q:'‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á?', opts:['1','2','3','5'], ok:1},
      ],
      exercise: [
        {q:'‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', opts:['‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ','‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°','‡∏ô‡∏≠‡∏ô','‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°'], ok:0},
        {q:'‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ñ‡∏∑‡∏≠?', opts:['Balance','Snack','Sleep','Skip'], ok:0},
        {q:'‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå?', opts:['‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢','‡∏´‡∏¥‡∏ß','‡∏á‡πà‡∏ß‡∏á','‡πÄ‡∏à‡πá‡∏ö'], ok:0},
      ]
    };

    const pool = qaPool[cat] || qaPool.nutrition;
    let cur = randPick(pool);

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'44%',transform:'translate(-50%,-50%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'
    });
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">${bloom.toUpperCase()} ‚Äî ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</div>
      <div id="qq" style="margin-top:10px;font-size:18px;font-weight:1100;text-align:center;">‚Äî</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>
    `;
    stage.appendChild(card);

    const pad = mkPad(2);

    function next(){
      total++;
      cur = randPick(pool);
      card.querySelector('#qq').textContent = cur.q;
      pad.innerHTML='';
      cur.opts.forEach((t,i)=>{
        const b=mkBtn(t);
        b.style.padding='14px 12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(i===cur.ok){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          next();
        });
      });
    }
    next();
  }

  // B: Apply (‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå + ‡∏Å‡∏é)
  function runB(){
    gameTitle.textContent = missionTitle();
    desc.textContent = 'B (Apply): ‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå';
    center.style.display='none';

    const casesByCat = {
      nutrition: [
        {q:'‡∏à‡∏≤‡∏ô‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≤‡∏ß+‡∏Ç‡∏ô‡∏° ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°?', opts:['‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‡∏Ç‡∏ô‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°','‡∏ó‡∏≠‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°'], ok:0},
        {q:'‡∏Å‡∏¥‡∏ô‡∏ô‡∏°+‡πÑ‡∏Ç‡πà ‚Üí ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏°‡∏π‡πà?', opts:['1','2','3','4'], ok:0},
        {q:'‡∏Å‡∏¥‡∏ô‡∏Å‡∏•‡πâ‡∏ß‡∏¢ ‚Üí ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏°‡∏π‡πà?', opts:['1','2','4','5'], ok:2},
      ],
      hygiene: [
        {q:'‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß ‚Üí ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', opts:['‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠','‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤','‡πÑ‡∏≠‡πÉ‡∏™‡πà','‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô'], ok:0},
        {q:'‡πÑ‡∏≠‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Üí ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‚Äú‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î‚Äù?', opts:['‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡∏ñ‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å','‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô','‡∏à‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô'], ok:0},
        {q:'‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‚Üí ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞?', opts:['45¬∞ ‡πÄ‡∏ö‡∏≤ ‡πÜ','‡πÅ‡∏£‡∏á ‡πÜ','‡∏Ç‡∏π‡∏î‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å','‡πÅ‡∏õ‡∏£‡∏á‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß'], ok:0},
      ],
      exercise: [
        {q:'‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Üí ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô?', opts:['‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ','‡∏ô‡∏≠‡∏ô','‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‡∏´‡∏¢‡∏∏‡∏î'], ok:0},
        {q:'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô ‚Üí ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥?', opts:['‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°','‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ','‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à'], ok:0},
        {q:'‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏î‡∏∏‡∏• ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ô‡πâ‡∏ô?', opts:['‡∏ô‡∏¥‡πà‡∏á+‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Å‡∏ô','‡∏£‡∏µ‡∏ö‡πÜ','‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏ï‡∏•‡∏≠‡∏î','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î'], ok:0},
      ],
    };

    const pool = casesByCat[cat] || casesByCat.nutrition;
    let cur = randPick(pool);

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'44%',transform:'translate(-50%,-50%)',
      width:'min(820px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'
    });
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">B ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞</div>
      <div id="qq" style="margin-top:10px;font-size:18px;font-weight:1100;text-align:center;">‚Äî</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÉ‡∏ä‡πâ‡∏Å‡∏é/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ</div>
    `;
    stage.appendChild(card);

    const pad=mkPad(2);

    function next(){
      total++;
      cur = randPick(pool);
      card.querySelector('#qq').textContent = cur.q;
      pad.innerHTML='';
      cur.opts.forEach((t,i)=>{
        const b=mkBtn(t);
        b.style.padding='14px 12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(i===cur.ok){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          next();
        });
      });
    }
    next();
  }

  // C: Evaluate/Analyze (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç + tradeoff)
  function runC(){
    gameTitle.textContent = missionTitle();
    desc.textContent = 'C (Evaluate): ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î';
    center.style.display='none';

    // 5 variants per category/theme: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå C1..C5
    // ‡πÉ‡∏ä‡πâ deterministic variant ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ research ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
    const cases = [];

    if(cat==='nutrition'){
      // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà ‚Äú‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå‡∏Å‡∏ß‡πà‡∏≤/‡∏•‡∏î junk/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‚Äù
      cases.push(
        {q:'‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ï‡πà üçöüçü ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£ ‚Äú‡∏Ñ‡∏∏‡πâ‡∏°‡∏™‡∏∏‡∏î‚Äù?', opts:['‡πÄ‡∏û‡∏¥‡πà‡∏° ü•¶ + üçé','‡πÄ‡∏û‡∏¥‡πà‡∏° üç©','‡πÄ‡∏û‡∏¥‡πà‡∏° üßã','‡πÄ‡∏û‡∏¥‡πà‡∏° üçü'], ok:0, why:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å+‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•'},
        {q:'‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‚Üí ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?', opts:['‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏ó‡∏ô 1 ‡πÅ‡∏Å‡πâ‡∏ß','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô','‡∏á‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','‡∏î‡∏∑‡πà‡∏°‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°'], ok:0, why:'‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï'},
        {q:'‡∏à‡∏≤‡∏ô‡∏°‡∏µ‡∏´‡∏°‡∏π‡πà 1+2 ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î?', opts:['‡∏´‡∏°‡∏π‡πà 3 ‡∏´‡∏£‡∏∑‡∏≠ 4','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏π‡πà 2','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏π‡πà 1','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏π‡πà 5 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß'], ok:0, why:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏°‡∏î‡∏∏‡∏•'}
      );
    }else if(cat==='hygiene'){
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡πÄ‡∏ä‡∏∑‡πâ‡∏≠/‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
      cases.push(
        {q:'‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏™‡∏Å‡∏õ‡∏£‡∏Å + ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á ‚Üí ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏Å‡πà‡∏≠‡∏ô?', opts:['‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô','‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°‡∏Å‡πà‡∏≠‡∏ô','‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠','‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô'], ok:0, why:'‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠'},
        {q:'‡πÑ‡∏≠‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏≠‡∏±‡∏î + ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù?', opts:['‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å + ‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡∏ñ‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å','‡πÑ‡∏≠‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏â‡∏¢ ‡πÜ','‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏´‡∏•‡∏ö'], ok:0, why:'‡∏•‡∏î‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ù‡∏≠‡∏¢'},
        {q:'‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î ‚Äú‡∏Ñ‡∏∏‡πâ‡∏°‡∏™‡∏∏‡∏î‚Äù?', opts:['‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î/‡∏£‡∏µ‡πÇ‡∏°‡∏ï/‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß','‡∏ú‡∏ô‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö','‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î','‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ'], ok:0, why:'‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏π‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏∏‡∏î'}
      );
    }else{
      // exercise: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô/‡∏•‡∏î‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö
      cases.push(
        {q:'‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ï ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù?', opts:['‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ','‡∏ù‡∏∑‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ','‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÉ‡∏à','‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠'], ok:0, why:'‡∏•‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö/‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß'},
        {q:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏±‡∏Å‡∏©‡∏≤ streak ‚Üí ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‚Äú‡∏Ñ‡∏∏‡πâ‡∏°‡∏™‡∏∏‡∏î‚Äù?', opts:['‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡πÄ‡∏ö‡∏≤ ‡πÜ 3 ‡∏ô‡∏≤‡∏ó‡∏µ','‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏ô‡∏±‡∏Å 20 ‡∏ô‡∏≤‡∏ó‡∏µ','‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢','‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à 1 ‡∏ô‡∏≤‡∏ó‡∏µ'], ok:0, why:'‡πÑ‡∏î‡πâ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°+‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢'},
        {q:'‡∏ù‡∏∂‡∏Å Balance ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏°‡∏≤‡∏Å ‚Üí ‡∏ß‡∏¥‡∏ò‡∏µ ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù?', opts:['‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å/‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÅ‡∏Å‡∏ô','‡πÄ‡∏£‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß','‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏ï‡∏•‡∏≠‡∏î','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°'], ok:0, why:'‡∏Ñ‡∏∏‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß'}
      );
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ï‡∏≤‡∏° variant ‡πÉ‡∏´‡πâ ‚Äú‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå/‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‚Äù
    // variant 1..5: ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°
    const startIdx = (variant-1) % Math.max(1,cases.length);
    let idx = startIdx;

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'44%',transform:'translate(-50%,-50%)',
      width:'min(860px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'
    });
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">C ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà ‚Äú‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù</div>
      <div id="qq" style="margin-top:10px;font-size:18px;font-weight:1100;text-align:center;">‚Äî</div>
      <div class="muted" id="why" style="margin-top:6px;text-align:center;">‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
    `;
    stage.appendChild(card);

    const pad=mkPad(2);

    function showCase(){
      const cur = cases[idx % cases.length];
      card.querySelector('#qq').textContent = cur.q;
      card.querySelector('#why').textContent = '‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ';
      pad.innerHTML='';
      cur.opts.forEach((t,i)=>{
        const b=mkBtn(t);
        b.style.padding='14px 12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(i===cur.ok){
            score++; toastShow('+1'); flashGood();
            card.querySelector('#why').textContent = '‚úÖ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞: ' + cur.why;
          }else{
            miss++; toastShow('MISS'); flashBad();
            card.querySelector('#why').textContent = '‚ùå ‡∏•‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î ‚Äú‡∏Ñ‡∏∏‡πâ‡∏°‡∏™‡∏∏‡∏î/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          }
          idx++;
          setTimeout(showCase, 520);
        });
      });
    }

    showCase();
  }

  function start(){
    if(dailyDone){ autoSkipIfDaily(); return; }

    clearStage();
    score=0; miss=0; total=0;
    tLeft=dur; lastTs=0;
    setHUD();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏≤‡∏° bloom
    if(bloom==='a') runA();
    else if(bloom==='b') runB();
    else runC();

    subLine.textContent = `Bloom ${bloom.toUpperCase()} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ó‡∏≥‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°`;
    statusText.textContent = `running: pid=${pid} cat=${cat} theme=${theme} bloom=${bloom} v=${variant}`;

    raf = requestAnimationFrame(tick);
  }

  function skip(){
    markDaily(dailyPrefix, cat, bloom, pid);
    const u = new URL(next0 || hub, location.href);
    applyPlanSeqParams(u);
    location.replace(u.toString());
  }

  setMetaText();
  setHUD();

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  stage.addEventListener('pointerdown', ()=>{
    if(!started && !dailyDone) start();
  }, {passive:true});

  if(!autoSkipIfDaily()){
    const name = `Bloom ${bloom.toUpperCase()}`;
    subLine.textContent = `${name} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù`;
    statusText.textContent = `ready: pid=${pid} cat=${cat} theme=${theme} bloom=${bloom} v=${variant}`;
  }

  WIN.addEventListener('visibilitychange', ()=>{
    if(DOC.hidden && started) endNow();
  });

})();
</script>
</body>
</html>