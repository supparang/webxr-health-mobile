<!-- === /herohealth/plate/plate-vr.html ===
Balanced Plate VR — RUN (PRODUCTION / HHA Standard)
✅ PC/Mobile/Cardboard/cVR (auto detect by boot/safe)
✅ Uses plate-vr.css (HUD/Quest/Coach/FX) + never blocks targets
✅ Uses Universal VR UI (/herohealth/vr/vr-ui.js) => ENTER VR/EXIT/RECENTER + crosshair tap-to-shoot (hha:shoot)
✅ Flush-hardened cloud logging (/herohealth/vr/hha-cloud-logger.js) via ?log=
✅ HHA Standard end summary + back HUB + save last summary
✅ Research deterministic seed passthrough
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- (Optional) A-Frame minimal scene helps WebXR "Enter VR" reliability on some browsers -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Universal VR UI (ENTER VR/EXIT/RECENTER + crosshair + tap-to-shoot) -->
  <script>
    // Global config for vr-ui
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Logger (flush-hardened) -->
  <script src="../vr/hha-cloud-logger.js" defer></script>

  <!-- Game engine -->
  <script type="module" src="./plate.safe.js"></script>

  <style>
    /* Minimal A-Frame scene hidden behind DOM game (for XR entry) */
    .xr-scene-wrap{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:0;
    }
    .xr-scene-wrap a-scene{ width:100%; height:100%; }
  </style>
</head>

<body class="view-auto">
  <!-- A-Frame helper scene -->
  <div class="xr-scene-wrap" aria-hidden="true">
    <a-scene
      embedded
      renderer="colorManagement:true; physicallyCorrectLights:true"
      vr-mode-ui="enabled:false"
    >
      <a-entity camera position="0 1.6 0"></a-entity>
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div id="app">
    <!-- Host layer for targets -->
    <div id="plate-layer" aria-hidden="false"></div>

    <!-- HUD (pointer-events none by CSS) -->
    <div id="hud" aria-hidden="false">
      <div class="hud-row">
        <div class="hud-pill">
          <div class="hud-stat">
            <span class="k">SCORE</span>
            <span class="v" id="uiScore">0</span>
          </div>
          <div class="hud-stat" style="margin-left:10px;">
            <span class="k">COMBO</span>
            <span class="v" id="uiCombo">0</span>
          </div>
        </div>

        <div class="hud-pill">
          <div class="hud-stat">
            <span class="k">TIME</span>
            <span class="v" id="uiTime">0:00</span>
          </div>
        </div>
      </div>

      <div id="questbar">
        <!-- GOAL -->
        <div class="q-card" id="goalCard">
          <div class="q-title">
            <div class="t">GOAL</div>
            <div class="sub" id="uiGoalMeta">0/0</div>
          </div>
          <div class="q-text" id="uiGoalText">—</div>
          <div class="q-bar"><div class="q-fill" id="uiGoalFill"></div></div>
        </div>

        <!-- MINI -->
        <div class="q-card" id="miniCard">
          <div class="q-title">
            <div class="t">MINI QUEST</div>
            <div class="sub"><span id="uiMiniMeta">0/0</span> • <span id="uiMiniTimer">--</span></div>
          </div>
          <div class="q-text" id="uiMiniText">—</div>
          <div class="q-bar"><div class="q-fill" id="uiMiniFill"></div></div>
        </div>
      </div>
    </div>

    <!-- Coach -->
    <div id="coach" aria-hidden="false">
      <div class="coach-card" id="coachCard" aria-hidden="true">
        <div class="coach-dot" id="coachDot"></div>
        <div id="coachMsg">—</div>
      </div>
    </div>

    <!-- Hit FX -->
    <div id="hitFx" aria-hidden="true">+10</div>

    <!-- End overlay (HHA Standard) -->
    <div id="endOverlay" aria-hidden="true" style="
      position:fixed; inset:0; z-index:120;
      display:grid; place-items:center;
      padding: calc(env(safe-area-inset-top,0px) + 14px)
               calc(env(safe-area-inset-right,0px) + 14px)
               calc(env(safe-area-inset-bottom,0px) + 14px)
               calc(env(safe-area-inset-left,0px) + 14px);
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    ">
      <div style="
        width:min(720px, 96vw);
        border-radius:24px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(2,6,23,.86);
        box-shadow: 0 18px 70px rgba(0,0,0,.50);
        padding:16px 16px 14px;
      ">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:950;font-size:16px;">สรุปผลการเล่น</div>
          <div id="endReason" style="color:#94a3b8;font-weight:800;font-size:12px;">—</div>
        </div>

        <div id="endSummary" style="
          margin-top:12px;
          display:grid;
          grid-template-columns: repeat(3, 1fr);
          gap:10px;
        "></div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap;">
          <button id="btnRestart" style="
            appearance:none;border:1px solid rgba(148,163,184,.22);
            background: rgba(15,23,42,.65);
            color:#e5e7eb;font-weight:950;
            padding:10px 14px;border-radius:999px;
          ">เล่นอีกครั้ง</button>

          <button id="btnBackHub" style="
            appearance:none;border:1px solid rgba(34,197,94,.35);
            background: rgba(34,197,94,.14);
            color:#e5e7eb;font-weight:950;
            padding:10px 14px;border-radius:999px;
          ">กลับหน้า HUB</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    const DOC = document;
    const qs = (k, def=null) => { try{ return new URL(location.href).searchParams.get(k) ?? def; }catch{ return def; } };

    // ---------- URL params (HHA Standard passthrough) ----------
    const hub = qs('hub', '');
    const run = (qs('run','play')||'play').toLowerCase(); // play | research | study
    const diff = (qs('diff','normal')||'normal').toLowerCase();
    const time = Number(qs('time','70')||70);
    const seed = qs('seed','');
    const log = qs('log',''); // endpoint for hha-cloud-logger.js
    const studyId = qs('studyId','');
    const phase = qs('phase','');
    const conditionGroup = qs('conditionGroup','');
    const sessionOrder = qs('sessionOrder','');
    const blockLabel = qs('blockLabel','');

    // Expose context for plate.safe.js (if it reads window.HHA_RUN_CONTEXT)
    window.HHA_RUN_CONTEXT = {
      gameId: 'plate',
      hub, run, diff, time, seed,
      log, studyId, phase, conditionGroup, sessionOrder, blockLabel
    };

    // ---------- View class (best-effort; engine may set too) ----------
    function setViewClass(v){
      const b = DOC.body;
      b.classList.remove('view-auto','view-pc','view-mobile','view-vr','view-cvr');
      b.classList.add('view-' + v);
    }
    setViewClass('auto');

    // ---------- End summary helpers ----------
    const endOverlay = DOC.getElementById('endOverlay');
    const endSummary = DOC.getElementById('endSummary');
    const endReason = DOC.getElementById('endReason');

    function card(k,v){
      const el = DOC.createElement('div');
      el.style.cssText = `
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.55);
        border-radius:18px;
        padding:10px 12px;
      `;
      el.innerHTML = `
        <div style="color:#94a3b8;font-weight:850;font-size:11px;letter-spacing:.2px;">${k}</div>
        <div style="font-weight:950;font-size:16px;margin-top:3px;font-variant-numeric:tabular-nums;">${v}</div>
      `;
      return el;
    }

    function showEnd(summary){
      // Save last summary (HHA Standard)
      try{
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(summary));
      }catch(e){}

      // Render cards
      endSummary.innerHTML = '';
      endSummary.appendChild(card('SCORE', summary.scoreFinal ?? 0));
      endSummary.appendChild(card('COMBO MAX', summary.comboMax ?? 0));
      endSummary.appendChild(card('ACCURACY', (summary.accuracyGoodPct!=null ? (Number(summary.accuracyGoodPct).toFixed(0)+'%') : '—')));
      endSummary.appendChild(card('GOALS', `${summary.goalsCleared ?? 0}/${summary.goalsTotal ?? 0}`));
      endSummary.appendChild(card('MINI', `${summary.miniCleared ?? 0}/${summary.miniTotal ?? 0}`));
      endSummary.appendChild(card('MISSES', summary.misses ?? 0));

      endReason.textContent = summary.reason || 'end';

      endOverlay.setAttribute('aria-hidden','false');
    }

    // Listen from engine (plate.safe.js) — should dispatch hha:end with detail.summary
    window.addEventListener('hha:end', (ev)=>{
      const detail = ev?.detail || {};
      const summary = detail.summary || detail || {};
      showEnd(summary);
    });

    // Back HUB (preserve hub param)
    DOC.getElementById('btnBackHub').addEventListener('click', ()=>{
      const target = hub ? decodeURIComponent(hub) : '../hub.html';
      // Keep a backlink hint for hub if needed
      try{
        const u = new URL(target, location.href);
        u.searchParams.set('from', 'plate');
        location.href = u.toString();
      }catch{
        location.href = target;
      }
    });

    // Restart (reload keeping same params)
    DOC.getElementById('btnRestart').addEventListener('click', ()=>{
      location.reload();
    });

    // If logger endpoint provided, tell logger (it reads ?log= by itself normally)
    // but we can emit a ping so dev sees it
    if (log){
      window.dispatchEvent(new CustomEvent('hha:log:status', { detail: { ok:true, endpoint: log } }));
    }

  })();
  </script>
</body>
</html>