<!-- === /herohealth/plate/plate-vr.html ===
Balanced Plate VR Run — PRODUCTION (HHA Standard)
✅ Uses ./plate-vr.css
✅ Uses ./plate.safe.js (engine)
✅ Uses ../vr/vr-ui.js (ENTER VR/EXIT/RECENTER + crosshair shoot => hha:shoot)
✅ Uses ../vr/hha-cloud-logger.js (flush-hardened)
✅ Auto view detect (NO menu, NO override)
✅ End overlay controlled by aria-hidden only
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#020617" />

  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./plate-vr.css" />

  <style>
    /* minimal fallback if css fails */
    body{ background:#020617; }
  </style>

  <!-- Universal VR UI config (must be BEFORE vr-ui.js) -->
  <script>
    // IMPORTANT: do not allow user override via query
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>

  <!-- Universal VR UI -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Logger (reads ?log= endpoint) -->
  <script src="../vr/hha-cloud-logger.js" defer></script>
</head>

<body class="view-auto" data-game="plate">

  <!-- ===================== HUD (non-blocking) ===================== -->
  <header id="hud" aria-label="HUD">
    <div class="hud-row">
      <!-- Left: stats -->
      <div class="chip" id="chipScore">
        <span class="k">SCORE</span>
        <span class="v" id="vScore">0</span>
      </div>

      <div class="chip" id="chipTime">
        <span class="k">TIME</span>
        <span class="v" id="vTime">0</span>
      </div>

      <div class="chip" id="chipCombo">
        <span class="k">COMBO</span>
        <span class="v" id="vCombo">0</span>
      </div>

      <!-- Center: GOAL -->
      <section class="quest" id="goalCard" aria-label="Goal">
        <div class="quest-title">
          <div class="t">GOAL</div>
          <div class="m"><span id="goalCur">0</span>/<span id="goalTarget">0</span></div>
        </div>
        <div class="bar" aria-hidden="true"><i id="goalBar"></i></div>
        <div class="quest-sub">
          <div id="goalText">—</div>
          <div class="mini-timer" id="goalTag" aria-hidden="false">MAIN</div>
        </div>
      </section>

      <!-- Right: MINI -->
      <section class="quest" id="miniCard" aria-label="Mini Quest">
        <div class="quest-title">
          <div class="t">MINI</div>
          <div class="m"><span id="miniCur">0</span>/<span id="miniTarget">0</span></div>
        </div>
        <div class="bar" aria-hidden="true"><i id="miniBar"></i></div>
        <div class="quest-sub">
          <div id="miniText">—</div>
          <div class="mini-timer" id="miniTimer" aria-hidden="false"><span id="miniLeft">0</span>s</div>
        </div>
      </section>
    </div>
  </header>

  <!-- ===================== Play Layer (DOM targets spawned here) ===================== -->
  <main id="plate-layer" aria-label="Play Layer"></main>

  <!-- ===================== Coach ===================== -->
  <aside id="coachCard" aria-hidden="true" aria-label="Coach">
    <div id="coachDot" aria-hidden="true"></div>
    <div id="coachMsg">—</div>
  </aside>

  <!-- ===================== Hit FX (center toast) ===================== -->
  <div id="hitFx" class="hitfx" aria-hidden="true">+0</div>

  <!-- ===================== End Overlay (aria-hidden drives visibility) ===================== -->
  <section id="endOverlay" aria-hidden="true" role="dialog" aria-label="Summary">
    <div class="end-card">
      <h2 class="end-title" id="endTitle">สรุปผล</h2>

      <div class="end-grid" aria-label="Metrics">
        <div class="end-item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="end-item"><div class="k">ACCURACY</div><div class="v" id="endAcc">0%</div></div>
        <div class="end-item"><div class="k">GOALS</div><div class="v" id="endGoal">0/0</div></div>
        <div class="end-item"><div class="k">MINI</div><div class="v" id="endMini">0/0</div></div>
        <div class="end-item"><div class="k">MISSES</div><div class="v" id="endMiss">0</div></div>
        <div class="end-item"><div class="k">DURATION</div><div class="v" id="endDur">0s</div></div>
      </div>

      <div class="end-actions">
        <button class="btn" id="btnRestart" type="button">เล่นอีกครั้ง</button>
        <button class="btn warn" id="btnBackHub" type="button">กลับ HUB</button>
        <button class="btn primary" id="btnCloseEnd" type="button">ปิด</button>
      </div>
    </div>
  </section>

  <!-- ===================== Boot (safe engine) ===================== -->
  <script type="module">
    import { boot as bootPlate } from './plate.safe.js';

    // ---------- Query helpers ----------
    function q(k, def=null){
      try { return new URL(location.href).searchParams.get(k) ?? def; }
      catch { return def; }
    }
    function qNum(k, def=0){
      const v = Number(q(k, def));
      return Number.isFinite(v) ? v : def;
    }
    function lower(s){ return (s||'').toLowerCase(); }

    // ---------- Auto view detect (NO override) ----------
    function detectView(){
      // Use heuristics only (DO NOT trust query view)
      const ua = navigator.userAgent || '';
      const isMobile = /Android|iPhone|iPad|iPod/i.test(ua) || (navigator.maxTouchPoints > 1);
      // cVR: user may enter split mode from hub param, but we still don't read view override
      const hinted = lower(q('view','')); // allowed only for cvr strict when launcher sets it
      if (hinted === 'cvr') return 'cvr'; // only cvr allowed as "special mode"
      return isMobile ? 'mobile' : 'pc';
    }
    function applyViewClass(view){
      const b = document.body;
      b.classList.remove('view-pc','view-mobile','view-vr','view-cvr','view-auto');
      if (view === 'cvr') b.classList.add('view-cvr');
      else if (view === 'mobile') b.classList.add('view-mobile');
      else b.classList.add('view-pc');
    }

    const view = detectView();
    applyViewClass(view);

    // ---------- Game context ----------
    const runMode = lower(q('run','play'));          // play | study
    const diff    = lower(q('diff','normal'));       // easy|normal|hard
    const timeSec = qNum('time', 70);                // duration planned
    const seedQ   = qNum('seed', 0);
    const seed    = seedQ > 0 ? seedQ : Date.now();  // research may pass fixed seed
    const hub     = q('hub','../hub.html');
    const logUrl  = q('log', null);                  // Apps Script endpoint

    // expose for logger + engine
    window.HHA_CTX = {
      game: 'plate',
      view,
      runMode,
      diff,
      durationPlannedSec: timeSec,
      seed,
      hub,
      logUrl
    };

    // ---------- UI refs ----------
    const $ = (s)=>document.querySelector(s);
    const vScore = $('#vScore');
    const vTime  = $('#vTime');
    const vCombo = $('#vCombo');

    // Quest cards
    const goalText = $('#goalText');
    const goalCur  = $('#goalCur');
    const goalTarget = $('#goalTarget');
    const goalBar = $('#goalBar');

    const miniText = $('#miniText');
    const miniCur  = $('#miniCur');
    const miniTarget = $('#miniTarget');
    const miniBar = $('#miniBar');
    const miniLeft = $('#miniLeft');

    // Coach & fx
    const coachCard = $('#coachCard');
    const coachMsg  = $('#coachMsg');
    const hitFx = $('#hitFx');

    // End overlay
    const endOverlay = $('#endOverlay');
    const endScore = $('#endScore');
    const endAcc   = $('#endAcc');
    const endGoal  = $('#endGoal');
    const endMini  = $('#endMini');
    const endMiss  = $('#endMiss');
    const endDur   = $('#endDur');

    // Buttons
    const btnRestart = $('#btnRestart');
    const btnBackHub = $('#btnBackHub');
    const btnCloseEnd = $('#btnCloseEnd');

    // ---------- End overlay helpers ----------
    function showEnd(summary){
      // summary is produced by plate.safe.js
      endScore.textContent = String(summary?.scoreFinal ?? 0);
      endAcc.textContent   = String(summary?.accuracyGoodPct ?? 0) + '%';
      endGoal.textContent  = `${summary?.goalsCleared ?? 0}/${summary?.goalsTotal ?? 0}`;
      endMini.textContent  = `${summary?.miniCleared ?? 0}/${summary?.miniTotal ?? 0}`;
      endMiss.textContent  = String(summary?.misses ?? 0);
      endDur.textContent   = String(summary?.durationPlayedSec ?? 0) + 's';

      endOverlay.setAttribute('aria-hidden','false');
    }
    function hideEnd(){
      endOverlay.setAttribute('aria-hidden','true');
    }

    // ---------- Buttons ----------
    btnRestart.addEventListener('click', ()=>{
      // keep same params but refresh seed for play; keep seed for study unless provided
      const u = new URL(location.href);
      if (runMode === 'play'){
        u.searchParams.set('seed', String(Date.now()));
      }
      location.href = u.toString();
    });

    btnBackHub.addEventListener('click', ()=>{
      // flush-hardened logger will catch pagehide; also we emit force_end
      try { window.dispatchEvent(new CustomEvent('hha:force_end', { detail:{ reason:'back-hub' }})); } catch {}
      const u = new URL(hub, location.href);
      location.href = u.toString();
    });

    btnCloseEnd.addEventListener('click', hideEnd);

    // ---------- HUD event listeners ----------
    window.addEventListener('hha:score', (e)=>{
      const d = e.detail || {};
      if (vScore) vScore.textContent = String(d.score ?? d.value ?? 0);
      if (vCombo) vCombo.textContent = String(d.combo ?? 0);
      if (hitFx && d.toast){
        hitFx.textContent = d.toast;
        hitFx.classList.toggle('fx-good', !!d.good);
        hitFx.classList.toggle('fx-bad', !!d.bad);
        hitFx.classList.toggle('fx-perfect', !!d.perfect);
        hitFx.setAttribute('aria-hidden','false');
        clearTimeout(hitFx.__t);
        hitFx.__t = setTimeout(()=>hitFx.setAttribute('aria-hidden','true'), 320);
      }
    });

    window.addEventListener('hha:time', (e)=>{
      const d = e.detail || {};
      if (vTime) vTime.textContent = String(d.left ?? d.value ?? 0);
    });

    window.addEventListener('quest:update', (e)=>{
      const qd = (e.detail || {});
      const g = qd.goal || {};
      const m = qd.mini || {};

      // goal
      if (goalText) goalText.textContent = g.text ?? '—';
      if (goalCur) goalCur.textContent = String(g.cur ?? 0);
      if (goalTarget) goalTarget.textContent = String(g.target ?? 0);
      if (goalBar){
        const pct = (g.target>0) ? Math.max(0, Math.min(100, (g.cur/g.target)*100)) : 0;
        goalBar.style.width = pct.toFixed(1)+'%';
      }

      // mini
      if (miniText) miniText.textContent = m.text ?? '—';
      if (miniCur) miniCur.textContent = String(m.cur ?? 0);
      if (miniTarget) miniTarget.textContent = String(m.target ?? 0);
      if (miniBar){
        const pct = (m.target>0) ? Math.max(0, Math.min(100, (m.cur/m.target)*100)) : 0;
        miniBar.style.width = pct.toFixed(1)+'%';
      }
      if (miniLeft) miniLeft.textContent = String(m.leftSec ?? 0);
    });

    window.addEventListener('hha:coach', (e)=>{
      const d = e.detail || {};
      if (!coachCard || !coachMsg) return;
      coachMsg.textContent = d.text ?? '—';
      coachCard.setAttribute('aria-hidden','false');
      clearTimeout(coachCard.__t);
      coachCard.__t = setTimeout(()=>coachCard.setAttribute('aria-hidden','true'), d.ms ?? 1800);
    });

    // Engine end -> show summary + store last summary + emit to logger
    window.addEventListener('hha:end', (e)=>{
      const summary = e.detail || {};
      try{
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify({
          game:'plate',
          at: new Date().toISOString(),
          summary
        }));
      }catch{}

      showEnd(summary);

      // logger picks up this event too (optional)
      try{ window.dispatchEvent(new CustomEvent('hha:log', { detail: summary })); }catch{}
    });

    // ---------- Start engine ----------
    bootPlate({
      host: document.querySelector('#plate-layer'),
      runMode,
      diff,
      durationPlannedSec: timeSec,
      seed,
      view,
      hub
    });

    // ---------- Logger endpoint passthrough ----------
    // hha-cloud-logger reads ?log= but also allow from ctx
    if (logUrl){
      window.HHA_LOG_ENDPOINT = logUrl;
    }
  </script>
</body>
</html>