<!-- === /herohealth/plate/plate-vr.html ===
PlateVR RUN ‚Äî PRODUCTION (HHA Standard)
‚úÖ CSS: ./plate-vr.css
‚úÖ Boot: ./plate.boot.js
‚úÖ UI: HUD + Coach + End Overlay (KPI + Miss breakdown + Grade)
‚úÖ Post-game: Evaluate + Create + immediate feedback + badges (silent)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî PlateVR</title>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#020617"/>
  <link rel="icon" href="../favicon.ico"/>

  <link rel="stylesheet" href="./plate-vr.css"/>

  <!-- (optional) fatal overlay ‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ error -->
  <style>
    #plate-fatal{
      position:fixed; inset:0; z-index:9999;
      display:none; padding:14px;
      background:#020617; color:#e5e7eb;
      white-space:pre-wrap; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    #plate-fatal.show{ display:block; }
  </style>
</head>

<body class="view-pc">
  <pre id="plate-fatal"></pre>

  <div id="app">
    <!-- optional FX layers -->
    <div id="bossFx"></div>
    <div id="stormFx"></div>

    <!-- playfield / mount for mode-factory targets -->
    <div id="plate-layer" aria-label="PlateVR Playfield"></div>

    <!-- HUD -->
    <section id="hud" aria-label="HUD">
      <div class="hudRow">
        <div class="chip score">
          <div class="lbl">SCORE</div>
          <div class="val" id="hudScore">0</div>
        </div>
        <div class="chip time">
          <div class="lbl">TIME</div>
          <div class="val" id="hudTime">0</div>
        </div>
        <div class="chip combo">
          <div class="lbl">COMBO</div>
          <div class="val" id="hudCombo">0</div>
        </div>
      </div>

      <div class="card" aria-label="Quests">
        <div class="cardTitle">
          <div class="t">Missions</div>
          <div class="hint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö + ‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div>
        </div>

        <div class="qItem">
          <div class="qText">
            <div class="name" id="goalName">Goal</div>
            <div class="sub"  id="goalSub"></div>
          </div>
          <div class="qProg">
            <div class="qNums" id="goalNums">0/0</div>
            <div class="bar"><i id="goalBar"></i></div>
          </div>
        </div>

        <div class="qItem">
          <div class="qText">
            <div class="name" id="miniName">Mini Quest</div>
            <div class="sub"  id="miniSub"></div>
          </div>
          <div class="qProg">
            <div class="qNums" id="miniNums">0/0</div>
            <div class="bar"><i id="miniBar"></i></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coach bubble -->
    <div id="coachCard" aria-hidden="true">
      <div class="inner">
        <div id="coachMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!</div>
        <div id="coachMeta">Coach</div>
      </div>
    </div>

    <!-- End overlay -->
    <section id="endOverlay" aria-hidden="true">
      <div class="endPanel" role="dialog" aria-label="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô">

        <div class="endTitle">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
          <div class="tag">
            Grade: <b id="kGrade">‚Äî</b>
          </div>
        </div>

        <div class="endGrid">
          <div class="kpi"><div class="k">Score</div><div class="v" id="kScore">0</div></div>
          <div class="kpi"><div class="k">Accuracy</div><div class="v" id="kAcc">‚Äî</div></div>
          <div class="kpi"><div class="k">Max Combo</div><div class="v" id="kCombo">0</div></div>

          <div class="kpi"><div class="k">Goals</div><div class="v" id="kGoals">0/0</div></div>
          <div class="kpi"><div class="k">Mini</div><div class="v" id="kMini">0/0</div></div>
          <div class="kpi"><div class="k">Miss (Total)</div><div class="v" id="kMiss">0</div></div>

          <!-- Miss breakdown -->
          <div class="kpi"><div class="k">Miss: Junk</div><div class="v" id="kMissJunk">0</div></div>
          <div class="kpi"><div class="k">Miss: Timeout</div><div class="v" id="kMissTimeout">0</div></div>
          <div class="kpi"><div class="k">Miss: Shot</div><div class="v" id="kMissShot">0</div></div>
        </div>

        <!-- badges (silent) -->
        <div class="kpi" style="margin:0 6px 10px;">
          <div class="k">Badges (this run)</div>
          <div class="v" id="badgeRow" style="font-size:13px;font-weight:900;color:#e5e7eb;line-height:1.35;">
            ‚Äî
          </div>
        </div>

        <!-- Post-game: Evaluate -->
        <div class="kpi" style="margin:0 6px 10px;">
          <div class="k">Evaluate (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô)</div>
          <div class="v" style="font-size:13px;font-weight:800;color:#e5e7eb;">
            <form id="evalForm" style="margin-top:8px;">
              <label style="display:block;margin:6px 0;">
                <input type="radio" name="eval" value="too_much_carb"> ‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á‡∏°‡∏≤‡∏Å‡πÑ‡∏õ
              </label>
              <label style="display:block;margin:6px 0;">
                <input type="radio" name="eval" value="too_little_veg"> ‡∏ú‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ
              </label>
              <label style="display:block;margin:6px 0;">
                <input type="radio" name="eval" value="need_more_protein"> ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô
              </label>
              <label style="display:block;margin:6px 0;">
                <input type="radio" name="eval" value="too_much_fat"> ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÑ‡∏õ
              </label>

              <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn" type="button" id="btnEvalSend">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Post-game: Create -->
        <div class="kpi" style="margin:0 6px 10px;">
          <div class="k">Create (‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>
          <div class="v" style="font-size:13px;font-weight:800;color:#e5e7eb;">
            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;">
              <button class="btn" type="button" data-create="add_veg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ü•¶</button>
              <button class="btn" type="button" data-create="reduce_rice">‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß üçö</button>
              <button class="btn" type="button" data-create="swap_snack_fruit">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ üçé</button>
            </div>

            <div id="createResult" style="margin-top:10px;color:#94a3b8;font-weight:900;">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            </div>
          </div>
        </div>

        <div class="endBtns">
          <button class="btn" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="btn primary" id="btnRestart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Boot -->
  <script type="module" src="./plate.boot.js"></script>

  <!-- UI glue: Evaluate/Create + show immediate effect + badge row -->
  <script>
    (function(){
      'use strict';
      const WIN = window, DOC = document;

      const fatal = (msg)=>{
        const box = DOC.getElementById('plate-fatal');
        if(!box) return;
        box.textContent = String(msg||'Fatal error');
        box.classList.add('show');
      };

      WIN.addEventListener('error', (e)=>fatal(e && e.message ? e.message : 'Unknown error'));
      WIN.addEventListener('unhandledrejection', (e)=>fatal(e && e.reason ? (e.reason.stack || e.reason) : 'Unhandled rejection'));

      // last summary snapshot for Create "immediate feedback"
      let LAST = null;

      function emit(name, detail){
        try{ WIN.dispatchEvent(new CustomEvent(name,{detail})); }catch(_){}
      }

      function setBadgeRow(arr){
        const row = DOC.getElementById('badgeRow');
        if(!row) return;
        if(!arr || !arr.length){ row.textContent = '‚Äî'; return; }
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏¥‡∏õ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ
        const map = {
          plate_eval: 'üìù Evaluate',
          plate_create: 'üõ†Ô∏è Create',
          plate_fix: 'üèÖ Fix-It'
        };
        row.textContent = arr.map(x=>map[x] || x).join('  ¬∑  ');
      }

      // When game ends, capture summary & badges
      WIN.addEventListener('hha:end', (e)=>{
        LAST = e.detail || {};
        setBadgeRow(LAST.badgesEarned || []);
      });

      // Evaluate send
      DOC.addEventListener('click', (ev)=>{
        const t = ev.target;
        if(!t) return;

        // Save Evaluate choice
        if(t.id === 'btnEvalSend'){
          const form = DOC.getElementById('evalForm');
          if(!form) return;
          const picked = form.querySelector('input[name="eval"]:checked');
          const choice = picked ? picked.value : '';
          if(!choice){
            // ‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡πâ‡∏á coach ‡∏£‡∏±‡∏ß
            const cr = DOC.getElementById('createResult');
            if(cr) cr.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• 1 ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô';
            return;
          }
          emit('plate:evaluate', { choice });

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge row ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (silent)
          const b = (Array.isArray(LAST && LAST.badgesEarned) ? LAST.badgesEarned.slice(0) : []);
          if(!b.includes('plate_eval')) b.push('plate_eval');
          setBadgeRow(b);

          const cr = DOC.getElementById('createResult');
          if(cr) cr.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Evaluate ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
        }

        // Create buttons
        if(t && t.matches && t.matches('button[data-create]')){
          const choice = String(t.getAttribute('data-create') || '');
          if(!choice) return;

          // ---- immediate "‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" ‡πÅ‡∏ö‡∏ö ‡∏õ.5 ----
          // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• g1..g5 ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏à‡∏≤‡∏Å plate.safe.js summary schema ‡πÉ‡∏´‡∏°‡πà)
          const g1 = Number(LAST && (LAST.g1 ?? 0))||0; // ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô
          const g2 = Number(LAST && (LAST.g2 ?? 0))||0; // ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö
          const g3 = Number(LAST && (LAST.g3 ?? 0))||0; // ‡∏ú‡∏±‡∏Å
          const g4 = Number(LAST && (LAST.g4 ?? 0))||0; // ‡∏ú‡∏•‡πÑ‡∏°‡πâ
          const g5 = Number(LAST && (LAST.g5 ?? 0))||0; // ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô
          const haveAll5 = [g1,g2,g3,g4,g5].filter(v=>v>0).length >= 5;

          let improved = false;
          let msg = '';

          if(choice === 'add_veg'){
            improved = (g3 === 0) || (!haveAll5);
            msg = improved
              ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ ‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ú‡∏±‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà)'
              : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏π‡∏á)';
          }else if(choice === 'reduce_rice'){
            improved = (g2 > Math.max(g1,g3,g4)) || (g2 >= 3);
            msg = improved
              ? '‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô)'
              : '‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å/‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡πâ‡∏ß‡∏¢';
          }else if(choice === 'swap_snack_fruit'){
            improved = (g4 === 0) || (!haveAll5);
            msg = improved
              ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏π‡πà)'
              : '‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î/‡∏´‡∏ß‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞';
          }

          // ‡∏™‡πà‡∏á‡πÑ‡∏õ engine (‡πÉ‡∏´‡πâ summary ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å createChoice + improved)
          emit('plate:create', { choice, improved });

          // badge UI (silent)
          const b = (Array.isArray(LAST && LAST.badgesEarned) ? LAST.badgesEarned.slice(0) : []);
          if(!b.includes('plate_create')) b.push('plate_create');
          if(improved && !b.includes('plate_fix')) b.push('plate_fix');
          setBadgeRow(b);

          const out = DOC.getElementById('createResult');
          if(out) out.textContent = msg + (improved ? ' üèÖ +Badge' : '');
        }
      });
    })();
  </script>
</body>
</html>