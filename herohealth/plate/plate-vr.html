<!-- === /herohealth/plate/plate-vr.html ===
     HeroHealth ‚Äî Balanced Plate VR (RUN)
     ‚úÖ Uses: plate-vr.css
     ‚úÖ Boots: plate.boot.js (module)
     ‚úÖ Includes: particles + cloud logger + vr-ui
     ‚úÖ Adds: Miss breakdown slots (junk / expireGood) in End Overlay

     ‚úÖ ADD: Warmup/Cooldown Gate (20s, boss theme via /herohealth/warmup-gate.html)
        - gate=1 (default) => warmup -> back here with gate=0
        - gate=0 => skip gates
        - Back HUB => cooldown -> hub
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- A-Frame: helps WebXR Enter VR reliability -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- Global FX + Logger + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Boot -->
  <script type="module" src="./plate.boot.js"></script>
</head>

<body class="view-pc">
  <div id="app">
    <!-- Minimal A-Frame scene (hidden) for Enter VR -->
    <a-scene
      embedded
      renderer="antialias:true; colorManagement:true"
      xr-mode-ui="enabled:false"
      style="position:fixed; inset:0; z-index:0; opacity:0; pointer-events:none;"
    >
      <a-entity camera position="0 1.6 0"></a-entity>
    </a-scene>

    <!-- FX layers (optional hooks) -->
    <div id="bossFx" aria-hidden="true"></div>
    <div id="stormFx" aria-hidden="true"></div>

    <!-- Playfield (targets spawn inside this rect) -->
    <div id="plate-layer" aria-label="playfield"></div>

    <!-- HUD -->
    <div id="hud" aria-label="hud">
      <div class="hudRow">
        <div class="chip score">
          <span class="lbl">SCORE</span>
          <span class="val" id="hudScore">0</span>
        </div>
        <div class="chip time">
          <span class="lbl">TIME</span>
          <span class="val" id="hudTime">0</span>
        </div>
        <div class="chip combo">
          <span class="lbl">COMBO</span>
          <span class="val" id="hudCombo">0</span>
        </div>
      </div>

      <div class="card" id="questCard">
        <div class="cardTitle">
          <div class="t">üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <div class="hint" id="hudHint">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‚Ä¢ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏ó‡∏≠‡∏î</div>
        </div>

        <!-- GOAL -->
        <div class="qItem" id="goalItem">
          <div class="qText">
            <div class="name" id="goalName">Goal</div>
            <div class="sub" id="goalSub">‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="goalNums">0/1</div>
            <div class="bar"><i id="goalBar"></i></div>
          </div>
        </div>

        <!-- MINI -->
        <div class="qItem" id="miniItem">
          <div class="qText">
            <div class="name" id="miniName">Mini Quest</div>
            <div class="sub" id="miniSub">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="miniNums">0/1</div>
            <div class="bar"><i id="miniBar"></i></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coach bubble (optional) -->
    <div id="coachCard" aria-hidden="true">
      <div class="inner">
        <div id="coachMsg">‚Ä¶</div>
        <div class="meta" id="coachMeta">Coach</div>
      </div>
    </div>

    <!-- End Overlay -->
    <div id="endOverlay" aria-hidden="true">
      <div class="endPanel">
        <div class="endTitle">
          <h2 id="endTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
          <div class="tag" id="endTag">PlateVR</div>
        </div>

        <div class="endGrid">
          <div class="kpi"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="kScore">0</div></div>
          <div class="kpi"><div class="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div><div class="v" id="kAcc">0%</div></div>
          <div class="kpi"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="kCombo">0</div></div>

          <div class="kpi"><div class="k">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div><div class="v" id="kGoals">0/0</div></div>
          <div class="kpi"><div class="k">‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Ñ‡∏ß‡∏™</div><div class="v" id="kMini">0/0</div></div>

          <!-- ‚úÖ Miss (total) -->
          <div class="kpi"><div class="k">Miss (‡∏£‡∏ß‡∏°)</div><div class="v" id="kMiss">0</div></div>

          <!-- ‚úÖ Miss breakdown -->
          <div class="kpi"><div class="k">Miss: ‡πÇ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏ó‡∏≠‡∏î</div><div class="v" id="kMissJunk">0</div></div>
          <div class="kpi"><div class="k">Miss: ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏î‡∏µ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="kMissExpire">0</div></div>

          <!-- (optional) Grade -->
          <div class="kpi"><div class="k">‡πÄ‡∏Å‡∏£‡∏î</div><div class="v" id="kGrade">‚Äî</div></div>
        </div>

        <div class="endBtns">
          <button class="btn" id="btnRestart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button class="btn primary" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Warmup/Cooldown Gate wiring (boss theme gate page) -->
  <script>
  (function(){
    'use strict';
    const DOC = document;

    function getSP(){
      try{ return new URL(location.href).searchParams; }
      catch{ return new URLSearchParams(); }
    }
    const SP = getSP();
    const qs = (k, d=null)=> (SP.get(k) ?? d);

    // ---- config ----
    const warmupSec = 20;
    const cooldownSec = 20;
    const GATE_PATH = '/herohealth/warmup-gate.html';

    function passthrough(){
      const deny = new Set(['next','hub','phase','dur','cdur','autonext','gate','skipGate']);
      const out = {};
      SP.forEach((v,k)=>{ if(!deny.has(k)) out[k]=v; });
      return out;
    }
    function buildUrl(base, add){
      const u = new URL(base, location.href);
      Object.entries(add||{}).forEach(([k,v])=>{
        if(v===undefined || v===null || v==='') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }
    function currentUrlWith(add){
      return buildUrl(location.href, add || {});
    }

    const hub = String(qs('hub','../hub.html'));
    const gateFlag = String(qs('gate','1'));

    function goWarmupThenBack(){
      const backHere = currentUrlWith({ gate: 0 });
      const url = buildUrl(GATE_PATH, {
        ...passthrough(),
        phase: 'warmup',
        dur: warmupSec,
        hub: hub,
        next: backHere,
        autonext: 1
      });
      location.replace(url);
    }
    function goCooldownTo(dest){
      const url = buildUrl(GATE_PATH, {
        ...passthrough(),
        phase: 'cooldown',
        cdur: cooldownSec,
        hub: hub,
        next: dest,
        autonext: 0
      });
      location.href = url;
    }

    // auto warmup on first enter (default gate=1)
    if(gateFlag !== '0'){
      try{
        if(!String(location.pathname||'').includes('warmup-gate')){
          goWarmupThenBack();
          return;
        }
      }catch(_){}
    }

    // Back HUB => cooldown first
    const btnBackHub = DOC.getElementById('btnBackHub');
    if(btnBackHub){
      btnBackHub.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        goCooldownTo(hub);
      }, { passive:false });
    }

    // expose helper for engines/overlays if needed
    window.HHA = window.HHA || {};
    window.HHA.goCooldownTo = (dest)=>goCooldownTo(dest || hub);
  })();
  </script>
     <script>
(function(){
  'use strict';
  function qs(k, def=null){
    try{ return new URL(location.href).searchParams.get(k) ?? def; }
    catch{ return def; }
  }
  function buildUrl(base, add){
    const u = new URL(base, location.href);
    Object.entries(add||{}).forEach(([k,v])=>{
      if (v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  // enable gate flow only when gate=1
  const gateOn = String(qs('gate','0')||'0');
  if (!(gateOn==='1' || gateOn==='true')) return;

  const hub  = String(qs('hub','../hub.html'));
  const view = String(qs('view','mobile'));
  const run  = String(qs('run','play'));
  const diff = String(qs('diff','normal'));
  const time = String(qs('time','80'));
  const seed = String(qs('seed',''));
  const cdur = String(qs('cdur','20'));

  // cooldown gate is at root
  const cooldownGate = '../warmup-gate.html';

  window.addEventListener('hha:end', function(){
    // cooldown -> autonext -> hub
    const nextHub = hub;
    const url = buildUrl(cooldownGate, {
      view, run, diff, time, seed,
      phase: 'cooldown',
      cdur: cdur,
      hub: hub,
      next: nextHub,
      autonext: 1
    });
    location.href = url;
  }, { passive:true });
})();
</script>


  <!-- NOTE:
    vr-ui.js will inject ENTER VR/EXIT/RECENTER + crosshair overlay automatically.
    plate.boot.js will set view class and boot the engine.
  -->
</body>
</html>
