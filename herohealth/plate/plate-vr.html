<!-- === /herohealth/plate/plate-vr.html ===
PlateVR RUN ‚Äî PRODUCTION (HHA Standard)
‚úÖ CSS:  ./plate-vr.css
‚úÖ Boot: ./plate.boot.js  (HUD + coach + end overlay + miss breakdown)
‚úÖ Engine: ./plate.safe.js (ESM, spawned via mode-factory)
‚úÖ VR UI: ../vr/vr-ui.js (ENTER VR/EXIT/RECENTER + crosshair emits hha:shoot)
‚úÖ EndOverlay: Evaluate + Create (‡∏õ.5) + instant effect + silent badge (emit hha:badge)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî PlateVR</title>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#020617"/>
  <link rel="icon" href="../favicon.ico"/>

  <link rel="stylesheet" href="./plate-vr.css"/>

  <style>
    /* Minimal additions for Evaluate/Create; main UI is in plate-vr.css */
    .endDivider{ height:1px; background: rgba(148,163,184,.14); margin: 10px 6px; }
    .endSection{ padding: 8px 6px 6px; }
    .endSection h3{ margin:0 0 8px; font-size:14px; font-weight:950; }

    .optGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
    @media (max-width: 560px){ .optGrid{ grid-template-columns: repeat(1, minmax(0, 1fr)); } }

    .optBtn{
      pointer-events:auto;
      cursor:pointer;
      text-align:left;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(10,16,40,.35);
      color: var(--text);
      font-weight:900;
    }
    .optBtn small{ display:block; margin-top:4px; font-weight:700; color: var(--muted); }
    .optBtn[aria-pressed="true"]{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
    }

    .miniCard{
      border-radius:18px;
      background: rgba(10,16,40,.35);
      border:1px solid rgba(148,163,184,.14);
      padding: 12px 12px;
    }
    .miniRow{ display:flex; justify-content:space-between; gap:10px; margin-top:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border-radius:999px;
      background: rgba(2,6,23,.62);
      border:1px solid rgba(148,163,184,.14);
      color: var(--muted);
      font-size:12px; font-weight:800;
    }
    .pill strong{ color: var(--text); }
    .toast{
      margin-top:10px;
      font-size:13px;
      color: var(--muted);
      line-height:1.35;
    }
    .resultLine{
      margin-top:10px;
      font-size:13px;
      color: var(--text);
      font-weight:900;
    }
    .resultLine span{ color: var(--cyan); }
  </style>
</head>

<body class="view-pc">
  <div id="app">

    <!-- FX layers (optional placeholders) -->
    <div id="bossFx" aria-hidden="true"></div>
    <div id="stormFx" aria-hidden="true"></div>

    <!-- PLAYFIELD (mount for spawner) -->
    <div id="plate-layer" aria-label="Plate playfield"></div>

    <!-- HUD -->
    <section id="hud" aria-label="HUD">
      <div class="hudRow">
        <div class="chip score" aria-label="Score">
          <div class="lbl">SCORE</div>
          <div class="val" id="hudScore">0</div>
        </div>
        <div class="chip time" aria-label="Time">
          <div class="lbl">TIME</div>
          <div class="val" id="hudTime">0</div>
        </div>
        <div class="chip combo" aria-label="Combo">
          <div class="lbl">COMBO</div>
          <div class="val" id="hudCombo">0</div>
        </div>
      </div>

      <div class="card" aria-label="Quests">
        <div class="cardTitle">
          <div class="t">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <div class="hint">‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà + ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div>
        </div>

        <div class="qItem" aria-label="Goal Quest">
          <div class="qText">
            <div class="name" id="goalName">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
            <div class="sub"  id="goalSub">‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏°‡∏π‡πà‡∏•‡∏∞ 1)</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="goalNums">0/5</div>
            <div class="bar"><i id="goalBar"></i></div>
          </div>
        </div>

        <div class="qItem" aria-label="Mini Quest">
          <div class="qText">
            <div class="name" id="miniName">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
            <div class="sub"  id="miniSub">‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô ‚â• 80%</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="miniNums">0/80</div>
            <div class="bar"><i id="miniBar"></i></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coach bubble -->
    <aside id="coachCard" aria-hidden="true">
      <div class="inner">
        <div id="coachMsg">‚Äî</div>
        <div id="coachMeta">Coach</div>
      </div>
    </aside>

    <!-- END OVERLAY -->
    <div id="endOverlay" aria-hidden="true" role="dialog" aria-label="End Summary">
      <div class="endPanel">
        <div class="endTitle">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî PlateVR</h2>
          <div class="tag">‡∏ú‡∏•‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
        </div>

        <!-- KPIs -->
        <div class="endGrid" aria-label="KPIs">
          <div class="kpi"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="kScore">0</div></div>
          <div class="kpi"><div class="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div><div class="v" id="kAcc">‚Äî</div></div>
          <div class="kpi"><div class="k">‡πÄ‡∏Å‡∏£‡∏î</div><div class="v" id="kGrade">‚Äî</div></div>

          <div class="kpi"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="kCombo">0</div></div>
          <div class="kpi"><div class="k">‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏ß‡∏°</div><div class="v" id="kMiss">0</div></div>
          <div class="kpi"><div class="k">Goal / Mini</div><div class="v"><span id="kGoals">0/0</span> ¬∑ <span id="kMini">0/0</span></div></div>

          <div class="kpi"><div class="k">‡∏û‡∏•‡∏≤‡∏î: ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏ó‡∏≠‡∏î</div><div class="v" id="kMissJunk">0</div></div>
          <div class="kpi"><div class="k">‡∏û‡∏•‡∏≤‡∏î: ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="kMissTimeout">0</div></div>
          <div class="kpi"><div class="k">‚Äî</div><div class="v">üçΩÔ∏è</div></div>
        </div>

        <div class="endDivider"></div>

        <!-- Evaluate + Create -->
        <div class="endSection" aria-label="Evaluate and Create">
          <h3>Evaluate: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‚Äú‡∏à‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‚Äù</h3>
          <div class="optGrid" id="evalGrid">
            <button class="optBtn" data-eval="too_much_carb" aria-pressed="false">
              üçö ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ
              <small>‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</small>
            </button>
            <button class="optBtn" data-eval="too_little_veg" aria-pressed="false">
              ü•¶ ‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ
              <small>‡∏ú‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</small>
            </button>
            <button class="optBtn" data-eval="add_fruit" aria-pressed="false">
              üçé ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£
              <small>‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏ú‡∏•‡πÑ‡∏°‡πâ‚Äù</small>
            </button>
          </div>

          <div class="toast" id="evalHint">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ ‚ÄúCreate‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          </div>

          <div class="endDivider"></div>

          <h3>Create (‡∏õ.5): ‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h3>
          <div class="optGrid" id="createGrid">
            <button class="optBtn" data-create="add_veg" aria-pressed="false">
              ü•¨ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å
              <small>‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏à‡∏≤‡∏ô</small>
            </button>
            <button class="optBtn" data-create="reduce_rice" aria-pressed="false">
              üçö ‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß
              <small>‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ</small>
            </button>
            <button class="optBtn" data-create="swap_snack_fruit" aria-pressed="false">
              üç≠‚û°Ô∏èüçå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ
              <small>‡∏´‡∏ß‡∏≤‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</small>
            </button>
          </div>

          <div class="miniCard" style="margin-top:10px">
            <div class="pill"><span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö:</span> <strong id="createResult">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö</strong></div>
            <div class="miniRow">
              <div class="pill">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <strong id="createBonus">+0</strong></div>
              <div class="pill">Badge: <strong id="createBadge">‚Äî</strong></div>
            </div>
            <div class="resultLine" id="createExplain" style="display:none"></div>
          </div>
        </div>

        <div class="endDivider"></div>

        <!-- Buttons -->
        <div class="endBtns">
          <button class="btn" id="btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="btn primary" id="btnRestart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Universal VR UI (module; safe if not entering VR) -->
  <script type="module" src="../vr/vr-ui.js"></script>

  <!-- Boot -->
  <script type="module" src="./plate.boot.js"></script>

  <!-- Evaluate/Create logic -->
  <script type="module">
    const WIN = window;
    const DOC = document;

    const $$ = (s)=>DOC.querySelectorAll(s);
    const $  = (s)=>DOC.querySelector(s);

    const evalBtns = Array.from($$('#evalGrid .optBtn'));
    const createBtns = Array.from($$('#createGrid .optBtn'));

    const elCreateResult = $('#createResult');
    const elCreateBonus  = $('#createBonus');
    const elCreateBadge  = $('#createBadge');
    const elCreateExplain= $('#createExplain');

    let lastSummary = null;
    let evalPick = '';
    let createPick = '';

    function emit(name, detail){
      try{ WIN.dispatchEvent(new CustomEvent(name, { detail })); }catch{}
    }

    function setPressed(btns, picked, key){
      for(const b of btns){
        const v = (key === 'eval') ? (b.dataset.eval || '') : (b.dataset.create || '');
        b.setAttribute('aria-pressed', (v === picked) ? 'true' : 'false');
      }
    }

    // Silent badge = emit event only (UI ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏≠‡∏á)
    function silentBadge(id, reason){
      emit('hha:badge', { id, reason, ts: Date.now() });
    }

    // Instant effect (kid-friendly; ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ scoreFinal ‡∏Ç‡∏≠‡∏á engine)
    function computeInstantEffect(pick, summary){
      const baseAcc = Number(summary?.accuracyPct ?? summary?.accuracyGoodPct ?? 0) || 0;
      const miss = Number(summary?.miss ?? summary?.misses ?? 0) || 0;

      let bonus = 0;
      let badge = '‚Äî';
      let text  = '';

      if(pick === 'add_veg'){
        bonus = 120;
        badge = 'ü•¨ Veg Hero';
        text = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ‚Üí ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ç‡∏∂‡πâ‡∏ô! ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡πÄ‡∏î‡∏¥‡∏° <span>${baseAcc}%</span> (‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏∞‡∏û‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á)`;
      }else if(pick === 'reduce_rice'){
        bonus = 100;
        badge = 'üçö Smart Carb';
        text = `‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß ‚Üí ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏û‡∏≠‡∏î‡∏µ! ‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏° <span>${miss}</span> (‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡πÅ‡∏ï‡∏∞ ‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏µ‡∏ö)`;
      }else if(pick === 'swap_snack_fruit'){
        bonus = 140;
        badge = 'üçå Fruit Swap';
        text = `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ ‚Üí ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î üéâ`;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Evaluate + Create ‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à
      if(evalPick && pick) bonus += 20;

      return { bonus, badge, text };
    }

    function applyCreate(pick){
      if(!lastSummary) return;

      createPick = pick;
      setPressed(createBtns, createPick, 'create');

      const { bonus, badge, text } = computeInstantEffect(createPick, lastSummary);

      if(elCreateResult){
        elCreateResult.textContent =
          (createPick === 'add_veg') ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß' :
          (createPick === 'reduce_rice') ? '‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß' :
          (createPick === 'swap_snack_fruit') ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÅ‡∏•‡πâ‡∏ß' :
          '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö';
      }
      if(elCreateBonus) elCreateBonus.textContent = `+${bonus}`;
      if(elCreateBadge) elCreateBadge.textContent = badge;

      if(elCreateExplain){
        elCreateExplain.style.display = 'block';
        elCreateExplain.innerHTML = text;
      }

      // Silent badges
      if(createPick === 'add_veg') silentBadge('plate_create_addveg', 'create:add_veg');
      if(createPick === 'reduce_rice') silentBadge('plate_create_reducerice', 'create:reduce_rice');
      if(createPick === 'swap_snack_fruit') silentBadge('plate_create_swapfruit', 'create:swap_snack_fruit');

      // gentle coach feedback (no popup badge)
      emit('hha:coach', { msg:'‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚úÖ', tag:'Coach' });
    }

    // Evaluate buttons
    for(const b of evalBtns){
      b.addEventListener('click', ()=>{
        evalPick = b.dataset.eval || '';
        setPressed(evalBtns, evalPick, 'eval');
        silentBadge('plate_evaluate', 'evaluate:selected');
        emit('hha:coach', { msg:'‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏•‡∏≠‡∏á ‚Äú‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‚Äù ‡πÉ‡∏ô Create üëá', tag:'Coach' });
      });
    }

    // Create buttons
    for(const b of createBtns){
      b.addEventListener('click', ()=> applyCreate(b.dataset.create || '') );
    }

    // Reset state per end
    WIN.addEventListener('hha:end', (e)=>{
      lastSummary = e.detail || null;

      evalPick = '';
      createPick = '';
      setPressed(evalBtns, '', 'eval');
      setPressed(createBtns, '', 'create');

      if(elCreateResult) elCreateResult.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö';
      if(elCreateBonus)  elCreateBonus.textContent = '+0';
      if(elCreateBadge)  elCreateBadge.textContent = '‚Äî';
      if(elCreateExplain){
        elCreateExplain.style.display = 'none';
        elCreateExplain.textContent = '';
      }
    });
  </script>
</body>
</html>