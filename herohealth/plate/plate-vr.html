<!-- === /herohealth/plate/plate-vr.html ===
HeroHealth ‚Äî Balanced Plate VR (RUN) ‚Äî PRODUCTION v20260215b
‚úÖ HHA Standard + Start overlay + Pause overlay + Result overlay + Back HUB
‚úÖ PC/Mobile/cVR supported (view=cvr ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏ú‡πà‡∏≤‡∏ô vr-ui.js => hha:shoot)
‚úÖ Uses /herohealth/plate/plate.safe.js (module) and calls boot({mount,cfg})
‚úÖ Coach images: /herohealth/img/plate-*.png (plate-neutral.png / plate-happy.png / plate-sad.png / plate-fever.png)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- Optional external CSS -->
  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + Logger + Universal VR UI + AI Hooks -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>
  <script src="../vr/ai-hooks.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
      --pill:999px;

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);

      /* IMPORTANT: mode-factory reads these (plate.safe.js uses mode-factory spawn) */
      --plate-top-safe: calc(150px + var(--sat));
      --plate-bottom-safe: calc(160px + var(--sab));
      --plate-left-safe: 12px;
      --plate-right-safe: 12px;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; height:100%; width:100%;
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Noto Sans Thai", Segoe UI, Roboto, sans-serif;
    }
    a-scene{ position:fixed; inset:0; z-index:0; }

    .bg{
      position:fixed; inset:0; z-index:1;
      background:
        radial-gradient(circle at 12% 10%, rgba(34,211,238,.12), transparent 40%),
        radial-gradient(circle at 88% 20%, rgba(167,139,250,.10), transparent 42%),
        radial-gradient(circle at 50% 92%, rgba(34,197,94,.10), transparent 48%),
        linear-gradient(180deg, rgba(2,6,23,.98), rgba(2,6,23,1));
      pointer-events:none;
    }

    .stage{
      position:fixed; inset:0; z-index:2;
      padding: calc(10px + var(--sat)) calc(10px + var(--sar)) calc(10px + var(--sab)) calc(10px + var(--sal));
    }

    /* spawn layer (mount) */
    #plate-layer{
      position:fixed; inset:0;
      z-index:10;
      pointer-events:auto;
      touch-action:none;
      user-select:none;
    }

    .plateTarget{
      position:absolute;
      display:grid;
      place-items:center;
      border-radius:999px;
      font-weight:1200;
      font-size:28px;
      line-height:1;
      background:rgba(15,23,42,.70);
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      transform: translate(-50%,-50%);
      -webkit-tap-highlight-color:transparent;
      user-select:none;
    }
    .plateTarget[data-kind="junk"]{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.26);
    }

    .hudTop{
      position:fixed;
      left:10px; right:10px;
      top: calc(10px + var(--sat));
      z-index:30;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-start;
      pointer-events:none;
    }

    .card{
      pointer-events:auto;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      min-width: 220px;
    }
    .card.small{ min-width: 180px; }
    .t{ font-weight:1000; font-size:12px; color:rgba(229,231,235,.92); }
    .v{ margin-top:6px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.56);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .muted{ color:var(--muted); font-weight:900; }

    .bar{
      width:160px;
      height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    .bar > i{ display:block; height:100%; width:0%; background:rgba(34,197,94,.85); }

    #miniPanel, #coachPanel{
      position:fixed;
      left:10px; right:10px;
      z-index:28;
      pointer-events:none;
    }
    #miniPanel{ top: calc(84px + var(--sat)); }
    #coachPanel{ bottom: calc(72px + var(--sab)); }

    .questCard{
      pointer-events:auto;
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .questCol{ display:flex; flex-direction:column; gap:6px; min-width:220px; }
    .questRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .k{ font-weight:1100; font-size:12px; color:rgba(229,231,235,.92); }
    .hint{ font-weight:900; font-size:12px; color:rgba(148,163,184,.95); line-height:1.25; }

    #hudBtns{
      position:fixed;
      right:10px;
      bottom: calc(10px + var(--sab));
      z-index:40;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .btn{
      pointer-events:auto;
      appearance:none;
      border:none;
      border-radius:999px;
      padding:10px 12px;
      background:rgba(2,6,23,.70);
      border:1px solid rgba(148,163,184,.20);
      color:rgba(229,231,235,.95);
      font: 1000 12px/1 system-ui, -apple-system, "Noto Sans Thai", Segoe UI, Roboto, sans-serif;
      box-shadow: 0 16px 40px rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.30); }
    .btn.warn{ background:rgba(245,158,11,.14); border-color:rgba(245,158,11,.30); }

    /* overlays */
    #startOverlay, #hudPaused, #resultBackdrop{
      position:fixed; inset:0;
      z-index:70;
      display:none;
      place-items:center;
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(10px);
    }
    .panelCard{
      width:min(980px, 100%);
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 26px 90px rgba(0,0,0,.42);
    }

    @media (max-width: 920px){
      .card{ min-width: 170px; }
      .bar{ width:140px; }
    }

    @media (max-width: 920px){
      #resultGrid{ grid-template-columns: 1fr !important; }
    }
  </style>

  <script>
    // Universal VR UI crosshair assist (vr-ui.js emits hha:shoot {x,y})
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>
</head>

<body>
  <!-- Minimal A-Frame scene -->
  <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true" background="color: #000">
    <a-entity id="rig" position="0 0 0">
      <a-camera position="0 1.6 0" look-controls="enabled:true"></a-camera>
    </a-entity>
  </a-scene>

  <div class="bg"></div>

  <div class="stage">
    <div id="plate-layer" aria-label="plate targets layer"></div>

    <!-- HUD TOP -->
    <div class="hudTop" id="hudTop">
      <div class="card">
        <div class="t">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="v">
          <span class="pill">üèÜ <span id="uiScore">0</span></span>
          <span class="pill">üî• <span id="uiCombo">0</span> (<span class="muted">max</span> <span id="uiComboMax">0</span>)</span>
          <span class="pill">üí• <span id="uiMiss">0</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ / ‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="v">
          <span class="pill">üçΩÔ∏è <span id="uiPlateHave">0</span>/5</span>
          <span class="pill">üéØ <span id="uiAcc">0%</span></span>
          <span class="pill">üèÖ <span id="uiGrade">C</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡πÄ‡∏ß‡∏•‡∏≤ / ShotMiss</div>
        <div class="v">
          <span class="pill">‚è±Ô∏è <span id="uiTime">0</span>s</span>
          <span class="pill">üéØ‚ùå <span id="uiShotMiss">0</span></span>
        </div>
      </div>

      <div class="card">
        <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (5 ‡∏´‡∏°‡∏π‡πà)</div>
        <div class="v">
          <span class="pill">ü•¶ <span id="uiG1">0</span></span>
          <span class="pill">üçé <span id="uiG2">0</span></span>
          <span class="pill">üêü <span id="uiG3">0</span></span>
          <span class="pill">üçö <span id="uiG4">0</span></span>
          <span class="pill">ü•ë <span id="uiG5">0</span></span>
        </div>
      </div>
    </div>

    <!-- GOAL + MINI -->
    <div id="miniPanel">
      <div class="questCard">
        <div class="questCol">
          <div class="k">üéØ GOAL</div>
          <div style="font-weight:1100" id="uiGoalTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill"><span id="uiGoalCount">0/0</span></span>
            <div class="bar" style="width:200px"><i id="uiGoalFill" style="width:0%"></i></div>
          </div>
        </div>

        <div class="questCol">
          <div class="k">‚ö° MINI</div>
          <div style="font-weight:1100" id="uiMiniTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill">‚è≥ <span id="uiMiniTime">--</span></span>
            <span class="pill">‚úÖ <span id="uiMiniCount">0/0</span></span>
            <div class="bar" style="width:200px">
              <i id="uiMiniFill" style="width:0%; background:rgba(245,158,11,.85)"></i>
            </div>
          </div>
        </div>

        <div class="questCol" style="min-width:260px">
          <div class="k">üí° Hint</div>
          <div class="hint" id="uiHint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥!</div>
          <div class="hint" id="uiCvrHint" style="margin-top:6px">Cardboard: view=cvr ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair</div>
        </div>
      </div>
    </div>

    <!-- COACH -->
    <div id="coachPanel">
      <div class="questCard" style="justify-content:space-between">
        <div style="display:flex; gap:10px; align-items:center; min-width:260px;">
          <img id="coachImg" src="../img/plate-neutral.png" alt="coach"
               style="width:44px;height:44px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.50);object-fit:cover" />
          <div>
            <div class="k">üßë‚Äçüè´ Coach</div>
            <div id="coachMsg" style="font-weight:1100">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üí™</div>
          </div>
        </div>
        <div class="hint" style="text-align:right; max-width:360px">
          ‡∏¢‡∏¥‡∏á/‡πÅ‡∏ï‡∏∞ = ‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ‚Ä¢ cVR/VR = ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (vr-ui.js)
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div id="hudBtns">
      <button class="btn primary" id="btnStart" type="button" style="display:none">‚ñ∂ START</button>
      <button class="btn" id="btnPause" type="button">‚è∏ PAUSE</button>
      <button class="btn warn" id="btnRestart" type="button">‚ôª RESTART</button>
      <button class="btn" id="btnEnterVR" type="button">üï∂ ENTER VR</button>
    </div>

    <!-- Start overlay -->
    <div id="startOverlay" style="display:grid">
      <div class="panelCard">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start">
          <div>
            <div style="font-weight:1200; font-size:18px">üçΩÔ∏è Balanced Plate VR</div>
            <div style="margin-top:6px; color:var(--muted); font-weight:900; line-height:1.35; font-size:13px">
              ‡πÇ‡∏´‡∏°‡∏î: <b id="uiRunPreview">play</b> ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <b id="uiDiffPreview">normal</b> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <b id="uiTimePreview">90</b>s
              <br/>Play = Adaptive ON ‚Ä¢ Study/Research = Seeded & Adaptive OFF
            </div>
          </div>
          <div style="color:var(--muted); font-weight:900; font-size:13px; text-align:right">
            Tip: Cardboard ‡πÉ‡∏ä‡πâ <b>view=cvr</b><br/>‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="btn primary" id="btnStartMain" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂</button>
          <button class="btn" id="btnCopyLink" type="button">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ üîó</button>
          <button class="btn warn" id="btnBackHubFromStart" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB üè†</button>
        </div>

        <div id="startDbg" style="margin-top:10px; color:var(--muted); font-weight:900; font-size:12px"></div>
      </div>
    </div>

    <!-- Paused overlay -->
    <div id="hudPaused">
      <div class="panelCard" style="width:min(520px,100%); text-align:center">
        <div style="font-weight:1200; font-size:18px">‚è∏ Paused</div>
        <div style="margin-top:6px; color:var(--muted); font-weight:900">‡∏Å‡∏î Pause ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</div>
        <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
          <button class="btn primary" id="btnResume2" type="button">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</button>
          <button class="btn warn" id="btnRestart2" type="button">‚ôª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    </div>

    <!-- Result overlay -->
    <div id="resultBackdrop">
      <div class="panelCard">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start">
          <div>
            <div style="font-weight:1200; font-size:18px">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
            <div style="margin-top:6px; color:var(--muted); font-weight:900">
              Mode: <b id="rMode">‚Äî</b> ‚Ä¢ Grade: <b id="rGrade">‚Äî</b>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn primary" id="btnPlayAgain" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚ñ∂</button>
            <button class="btn" id="btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB üè†</button>
          </div>
        </div>

        <div id="resultGrid" style="margin-top:12px; display:grid; grid-template-columns: 1.1fr .9fr; gap:12px">
          <div style="background:var(--panel2); border:1px solid var(--stroke); border-radius:18px; padding:12px">
            <div class="t">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">üèÜ <span id="rScore">0</span></span>
              <span class="pill">üî• Max Combo <b id="rMaxCombo">0</b></span>
              <span class="pill">üí• Miss <b id="rMiss">0</b></span>
              <span class="pill">üéØ Acc <b id="rAcc">0%</b></span>
              <span class="pill">üéØ Goals <b id="rGoals">0/0</b></span>
              <span class="pill">‚ö° Minis <b id="rMinis">0/0</b></span>
              <span class="pill">üéØ‚ùå ShotMiss <b id="rShotMiss">0</b></span>
            </div>
          </div>

          <div style="background:var(--panel2); border:1px solid var(--stroke); border-radius:18px; padding:12px">
            <div class="t">5 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">ü•¶ <b id="rG1">0</b></span>
              <span class="pill">üçé <b id="rG2">0</b></span>
              <span class="pill">üêü <b id="rG3">0</b></span>
              <span class="pill">üçö <b id="rG4">0</b></span>
              <span class="pill">ü•ë <b id="rG5">0</b></span>
              <span class="pill">Œ£ <b id="rGTotal">0</b></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap -->
  <script type="module">
    import { boot as plateBoot } from './plate.safe.js';

    const $ = (id)=>document.getElementById(id);
    const sp = new URL(location.href).searchParams;

    // ---- params ----
    const run = (sp.get('run') || sp.get('runMode') || 'play').toLowerCase();     // play | study | research
    const diff = (sp.get('diff') || 'normal').toLowerCase();                     // easy | normal | hard
    const time = Number(sp.get('time') || 90) || 90;
    const seed = Number(sp.get('seed') || 0) || 0;
    const view = (sp.get('view') || '').toLowerCase();                           // cvr | mobile | pc ...
    const pid  = sp.get('pid') || 'anon';
    const studyId = sp.get('studyId') || '';
    const phase = sp.get('phase') || '';
    const conditionGroup = sp.get('conditionGroup') || '';
    const log = sp.get('log') || '';

    // show preview
    const dbg = $('startDbg');
    if(dbg) dbg.textContent = 'URL: ' + location.href;
    const setText = (id,v)=>{ const e=$(id); if(e) e.textContent = String(v); };

    setText('uiRunPreview', run);
    setText('uiDiffPreview', diff);
    setText('uiTimePreview', time);

    // resolve hub safely (fix hub=.%252Fhub.html etc.)
    function resolveHubUrl(){
      const raw = sp.get('hub');
      if(!raw) return new URL('../hub.html', location.href).toString();
      try{
        let s = raw;
        try{ s = decodeURIComponent(s); }catch{}
        try{ if(/%2f|%3a/i.test(s)) s = decodeURIComponent(s); }catch{}
        return new URL(s, location.href).toString();
      }catch{
        return new URL('../hub.html', location.href).toString();
      }
    }
    const HUB_URL = resolveHubUrl();

    if(view === 'cvr') document.documentElement.dataset.view = 'cvr';

    const startOverlay  = $('startOverlay');
    const pausedOverlay = $('hudPaused');
    const resultOverlay = $('resultBackdrop');
    const mount = $('plate-layer');

    const show = (el, on)=>{ if(!el) return; el.style.display = on ? 'grid' : 'none'; };

    // buttons (overlay)
    $('btnStartMain')?.addEventListener('click', ()=> $('btnStart')?.click(), {passive:true});
    $('btnCopyLink')?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); if(dbg) dbg.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'; }
      catch{ if(dbg) dbg.textContent = '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö URL ‡πÑ‡∏î‡πâ'; }
    }, {passive:true});

    $('btnBackHub')?.addEventListener('click', ()=> location.href = HUB_URL, {passive:true});
    $('btnBackHubFromStart')?.addEventListener('click', ()=> location.href = HUB_URL, {passive:true});
    $('btnPlayAgain')?.addEventListener('click', ()=> location.reload(), {passive:true});
    $('btnResume2')?.addEventListener('click', ()=> $('btnPause')?.click(), {passive:true});
    $('btnRestart2')?.addEventListener('click', ()=> $('btnRestart')?.click(), {passive:true});

    // buttons (hud)
    $('btnEnterVR')?.addEventListener('click', ()=>{
      try{ document.querySelector('a-scene')?.enterVR?.(); }catch(e){}
    }, {passive:true});

    // ---- game instance ----
    let game = null;
    let started = false;
    let paused = false;

    function cfgFromUrl(){
      return {
        runMode: run,
        diff,
        seed: seed || Date.now(),
        durationPlannedSec: time,
        pid, studyId, phase, conditionGroup, log, view
      };
    }

    function hardResetUI(){
      setText('uiScore', 0);
      setText('uiCombo', 0);
      setText('uiComboMax', 0);
      setText('uiMiss', 0);
      setText('uiPlateHave', 0);
      setText('uiAcc', '0%');
      setText('uiGrade', 'C');
      setText('uiTime', time);
      setText('uiShotMiss', 0);

      setText('uiG1', 0); setText('uiG2', 0); setText('uiG3', 0); setText('uiG4', 0); setText('uiG5', 0);

      setText('uiGoalTitle', '‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà');
      setText('uiGoalCount', '0/5');
      const gf = $('uiGoalFill'); if(gf) gf.style.width = '0%';

      setText('uiMiniTitle', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥');
      setText('uiMiniTime', '--');
      setText('uiMiniCount', '0/0');
      const mf = $('uiMiniFill'); if(mf) mf.style.width = '0%';

      const coachImg = $('coachImg'); if(coachImg) coachImg.src = '../img/plate-neutral.png';
      setText('coachMsg', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üí™');

      show(resultOverlay, false);
      show(pausedOverlay, false);
      mount.style.pointerEvents = 'auto';
    }

    function startGame(){
      if(!mount) { alert('plate-layer not found'); return; }
      hardResetUI();
      show(startOverlay, false);

      // Start engine
      game = plateBoot({ mount, cfg: cfgFromUrl() });

      started = true;
      paused = false;
    }

    // Start hidden bridge button
    $('btnStart')?.addEventListener('click', ()=>{
      if(started) return;
      startGame();
    }, {passive:true});

    // Pause
    $('btnPause')?.addEventListener('click', ()=>{
      if(!started) return;
      paused = !paused;
      show(pausedOverlay, paused);

      // block interactions (UI)
      mount.style.pointerEvents = paused ? 'none' : 'auto';

      // tell engine (optional)
      try{
        window.dispatchEvent(new CustomEvent('hha:pause', { detail:{ paused } }));
      }catch{}
    }, {passive:true});

    // Restart
    $('btnRestart')?.addEventListener('click', ()=>{
      location.reload();
    }, {passive:true});

    // initial overlay visible
    show(startOverlay, true);

    // ---- UI events from plate.safe.js ----
    window.addEventListener('hha:start', (e)=>{
      const d = e.detail || {};
      setText('uiTime', d.timePlannedSec ?? time);
    });

    window.addEventListener('hha:score', (e)=>{
      const d = e.detail || {};
      setText('uiScore', d.score ?? 0);
      setText('uiCombo', d.combo ?? 0);
      setText('uiComboMax', d.comboMax ?? 0);
      setText('uiMiss', d.miss ?? 0);
      setText('uiPlateHave', Array.isArray(d.gCount) ? d.gCount.filter(x=>Number(x)>0).length : (d.plateHave ?? 0));
      setText('uiAcc', (d.accuracyPct!=null) ? `${Math.round(Number(d.accuracyPct))}%` : '0%');

      // prefer canonical grade from engine
      if(d.grade) setText('uiGrade', d.grade);
      else{
        const s = Number(d.score||0);
        const g = s>=2200?'S':s>=1700?'A':s>=1200?'B':s>=700?'C':'D';
        setText('uiGrade', g);
      }

      // group counts if provided
      if(Array.isArray(d.gCount) && d.gCount.length>=5){
        setText('uiG1', d.gCount[0]||0);
        setText('uiG2', d.gCount[1]||0);
        setText('uiG3', d.gCount[2]||0);
        setText('uiG4', d.gCount[3]||0);
        setText('uiG5', d.gCount[4]||0);
      }
    });

    window.addEventListener('hha:time', (e)=>{
      const d = e.detail || {};
      setText('uiTime', (d.timeLeftSec!=null) ? d.timeLeftSec : (d.leftSec!=null ? d.leftSec : 0));
    });

    window.addEventListener('quest:update', (e)=>{
      const d = e.detail || {};
      if(d.goal){
        const title = d.goal.title || d.goal.name || '‚Äî';
        setText('uiGoalTitle', title);
        setText('uiGoalCount', `${d.goal.cur ?? 0}/${d.goal.target ?? 0}`);
        const p = (d.goal.target>0) ? Math.round((d.goal.cur/d.goal.target)*100) : 0;
        const gf = $('uiGoalFill'); if(gf) gf.style.width = `${Math.max(0,Math.min(100,p))}%`;
        setText('uiPlateHave', d.goal.cur ?? 0);
      }
      if(d.mini){
        const title = d.mini.title || d.mini.name || '‚Äî';
        setText('uiMiniTitle', title);
        setText('uiMiniTime', d.mini.timeText || '--');
        setText('uiMiniCount', `${d.mini.cur ?? 0}/${d.mini.target ?? 0}`);
        const p2 = (d.mini.target>0) ? Math.round((d.mini.cur/d.mini.target)*100) : 0;
        const mf = $('uiMiniFill'); if(mf) mf.style.width = `${Math.max(0,Math.min(100,p2))}%`;
      }
    });

    window.addEventListener('hha:coach', (e)=>{
      const d = e.detail || {};
      if(typeof d.msg === 'string' && d.msg) setText('coachMsg', d.msg);

      // mood from engine preferred
      const img = $('coachImg');
      if(!img) return;
      const mood = String(d.mood || 'neutral').toLowerCase();
      const allow = ['neutral','happy','sad','fever'];
      img.src = `../img/plate-${allow.includes(mood)?mood:'neutral'}.png`;
    });

    window.addEventListener('hha:judge', (e)=>{
      const d = e.detail || {};
      if(String(d.kind||'') === 'shot_miss'){
        const cur = Number(($('uiShotMiss')?.textContent)||0) || 0;
        setText('uiShotMiss', cur + 1);
      }
    });

    window.addEventListener('hha:end', (e)=>{
      const s = e.detail || {};
      setText('rMode', s.runMode ?? run);
      setText('rGrade', s.grade ?? '‚Äî');
      setText('rScore', s.scoreFinal ?? 0);
      setText('rMaxCombo', s.comboMax ?? 0);
      setText('rMiss', s.miss ?? 0);
      setText('rShotMiss', s.shotMiss ?? 0);
      setText('rAcc', (s.accuracyPct!=null) ? `${s.accuracyPct}%` : '‚Äî');
      setText('rGoals', `${s.goalsCleared ?? 0}/${s.goalsTotal ?? 0}`);
      setText('rMinis', `${s.miniCleared ?? 0}/${s.miniTotal ?? 0}`);

      setText('rG1', s.g1 ?? 0); setText('rG2', s.g2 ?? 0); setText('rG3', s.g3 ?? 0); setText('rG4', s.g4 ?? 0); setText('rG5', s.g5 ?? 0);
      const total = (Number(s.g1||0)+Number(s.g2||0)+Number(s.g3||0)+Number(s.g4||0)+Number(s.g5||0));
      setText('rGTotal', total);

      show(pausedOverlay, false);
      show(resultOverlay, true);
      mount.style.pointerEvents = 'none';
    });

  </script>
</body>
</html>