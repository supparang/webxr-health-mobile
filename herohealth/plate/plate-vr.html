<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî PlateVR (RUN)</title>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#020617"/>
  <link rel="icon" href="../favicon.ico"/>

  <!-- UI / Safe zones / Targets FX -->
  <link rel="stylesheet" href="./plate-vr.css"/>
</head>

<body class="view-pc">
  <div id="app">
    <!-- Optional FX layers -->
    <div id="bossFx" aria-hidden="true"></div>
    <div id="stormFx" aria-hidden="true"></div>

    <!-- Playfield (mount for mode-factory) -->
    <div id="plate-layer" aria-label="PlateVR playfield"></div>

    <!-- HUD -->
    <section id="hud" aria-label="HUD">
      <div class="hudRow">
        <div class="chip score">
          <div class="lbl">SCORE</div>
          <div class="val" id="hudScore">0</div>
        </div>
        <div class="chip time">
          <div class="lbl">TIME</div>
          <div class="val" id="hudTime">0</div>
        </div>
        <div class="chip combo">
          <div class="lbl">COMBO</div>
          <div class="val" id="hudCombo">0</div>
        </div>
      </div>

      <div class="card" aria-label="Quests">
        <div class="cardTitle">
          <div class="t">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <div class="hint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà + ‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div>
        </div>

        <div class="qItem">
          <div class="qText">
            <div class="name" id="goalName">Goal</div>
            <div class="sub" id="goalSub">‚Äî</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="goalNums">0/5</div>
            <div class="bar"><i id="goalBar"></i></div>
          </div>
        </div>

        <div class="qItem">
          <div class="qText">
            <div class="name" id="miniName">Mini Quest</div>
            <div class="sub" id="miniSub">‚Äî</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="miniNums">0/80</div>
            <div class="bar"><i id="miniBar"></i></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coach bubble -->
    <section id="coachCard" aria-hidden="true">
      <div class="inner">
        <div id="coachMsg">‚Äî</div>
        <div id="coachMeta">Coach</div>
      </div>
    </section>

    <!-- END OVERLAY -->
    <section id="endOverlay" aria-hidden="true">
      <div class="endPanel" role="dialog" aria-label="‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô">
        <div class="endTitle">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• PlateVR</h2>
          <div class="tag">
            Grade: <b id="kGrade">‚Äî</b>
          </div>
        </div>

        <!-- KPI grid (matches boot.js ids) -->
        <div class="endGrid">
          <div class="kpi">
            <div class="k">Score</div>
            <div class="v" id="kScore">0</div>
          </div>
          <div class="kpi">
            <div class="k">Accuracy</div>
            <div class="v" id="kAcc">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="k">Combo Max</div>
            <div class="v" id="kCombo">0</div>
          </div>
          <div class="kpi">
            <div class="k">Goal</div>
            <div class="v" id="kGoals">0/1</div>
          </div>
          <div class="kpi">
            <div class="k">Mini</div>
            <div class="v" id="kMini">0/1</div>
          </div>
          <div class="kpi">
            <div class="k">Miss (‡∏£‡∏ß‡∏°)</div>
            <div class="v" id="kMiss">0</div>
          </div>
        </div>

        <!-- Miss breakdown (optional, supported by boot.js) -->
        <div style="padding:0 6px 10px;display:flex;gap:10px;flex-wrap:wrap;">
          <div class="kpi" style="flex:1;min-width:220px;">
            <div class="k">Miss ‡∏à‡∏≤‡∏Å Junk</div>
            <div class="v" id="kMissJunk">0</div>
          </div>
          <div class="kpi" style="flex:1;min-width:220px;">
            <div class="k">Miss ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Good expire)</div>
            <div class="v" id="kMissTimeout">0</div>
          </div>
        </div>

        <!-- ==========================================
             Evaluate + Create (‡∏õ.5) ‚Äî End Learning Loop
             ‚Äú‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + silent badge‚Äù
        =========================================== -->
        <div style="padding:6px 6px 14px;">
          <div style="font-weight:950;margin:6px 0 10px;">üß† Evaluate (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</div>

          <div class="kpi" style="padding:12px;">
            <div class="k">‡∏ó‡∏≥‡πÑ‡∏°‡∏à‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏î‡∏µ‚Äù ?</div>
            <div style="margin-top:10px;display:grid;gap:8px;">
              <label style="display:flex;gap:10px;align-items:flex-start;cursor:pointer;">
                <input type="radio" name="evalReason" value="too_much" />
                <span><b>‡∏°‡∏≤‡∏Å‡πÑ‡∏õ</b> (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ)</span>
              </label>
              <label style="display:flex;gap:10px;align-items:flex-start;cursor:pointer;">
                <input type="radio" name="evalReason" value="too_little" />
                <span><b>‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ</b> (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ)</span>
              </label>
              <label style="display:flex;gap:10px;align-items:flex-start;cursor:pointer;">
                <input type="radio" name="evalReason" value="need_add" />
                <span><b>‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£</b> (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ/‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô)</span>
              </label>
            </div>

            <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <button class="btn primary" id="btnSaveEvaluate" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</button>
              <span style="color:var(--muted);font-size:12px;">(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</span>
            </div>
            <div id="evalSavedHint" style="margin-top:8px;color:var(--muted);font-size:12px;display:none;">
              ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            </div>
          </div>

          <div style="font-weight:950;margin:14px 0 10px;">‚ú® Create (‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>

          <div class="kpi" style="padding:12px;">
            <div class="k">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‚Äù ‡∏à‡∏≤‡∏Å‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°:</div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" id="btnAddVeg" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ü•¶</button>
              <button class="btn" id="btnReduceRice" type="button">‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á üçö</button>
              <button class="btn" id="btnSwapSnack" type="button">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ üç≠‚Üíüçé</button>
            </div>

            <div style="margin-top:12px;border-top:1px solid rgba(148,163,184,.14);padding-top:12px;">
              <div class="k">‡∏ú‡∏• ‚Äú‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á‚Äù (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>

              <div style="margin-top:10px;display:grid;gap:8px;">
                <div style="display:flex;justify-content:space-between;gap:10px;">
                  <span style="color:var(--muted);">‡∏Å‡πà‡∏≠‡∏ô</span>
                  <span id="plateBeforeText" style="font-weight:900;">‚Äî</span>
                </div>
                <div style="display:flex;justify-content:space-between;gap:10px;">
                  <span style="color:var(--muted);">‡∏´‡∏•‡∏±‡∏á</span>
                  <span id="plateAfterText" style="font-weight:900;">‚Äî</span>
                </div>
              </div>

              <div style="margin-top:10px;color:var(--muted);font-size:12px;">
                üîí Badge ‡∏à‡∏∞ ‚Äú‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÇ‡∏ú‡∏•‡πà‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Å‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
              </div>

              <div id="silentBadgesRow" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>
          </div>
        </div>

        <!-- buttons -->
        <div class="endBtns">
          <button class="btn" id="btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="btn primary" id="btnRestart" type="button">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Universal VR UI (ENTER VR / EXIT / RECENTER + crosshair emits hha:shoot) -->
  <script type="module" src="../vr/vr-ui.js"></script>

  <!-- Boot (wires HUD + end overlay) -->
  <script type="module" src="./plate.boot.js"></script>

  <!-- Evaluate + Create logic (silent) -->
  <script type="module">
    const LS_KEY = 'HHA_PLATE_SILENT_BADGES';
    const LS_EVAL = 'HHA_PLATE_EVAL_LAST';

    const el = (id)=>document.getElementById(id);

    function loadBadges(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveBadges(arr){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }catch{}
    }
    function addBadge(id){
      const arr = loadBadges();
      if(!arr.includes(id)){
        arr.push(id);
        saveBadges(arr);
      }
      renderBadges();
    }

    function badgeChip(label){
      const d = document.createElement('div');
      d.className = 'kpi';
      d.style.padding = '8px 10px';
      d.style.borderRadius = '999px';
      d.style.display = 'inline-flex';
      d.style.alignItems = 'center';
      d.style.gap = '8px';
      d.innerHTML = `<span style="font-weight:950;">üè∑Ô∏è</span><span style="font-weight:900;">${label}</span>`;
      return d;
    }

    function renderBadges(){
      const row = el('silentBadgesRow');
      if(!row) return;
      row.innerHTML = '';
      const badges = loadBadges();

      // show only plate-related (simple filter)
      const map = {
        'plate_eval_saved': 'Evaluator',
        'plate_create_veg': 'Veg+',
        'plate_create_reduce_rice': 'Smart Carb',
        'plate_create_swap_snack': 'Fruit Swap',
      };

      badges.filter(b=>map[b]).forEach(b=>{
        row.appendChild(badgeChip(map[b]));
      });

      if(!row.children.length){
        const tip = document.createElement('div');
        tip.style.color = 'var(--muted)';
        tip.style.fontSize = '12px';
        tip.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ badge ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ';
        row.appendChild(tip);
      }
    }

    // --- End data snapshot (from hha:end) ---
    let lastSummary = null;

    function plateTextFromCounts(g1,g2,g3,g4,g5){
      // Thai 5 food groups fixed mapping you defined
      return `‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô:${g1} | ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö:${g2} | ‡∏ú‡∏±‡∏Å:${g3} | ‡∏ú‡∏•‡πÑ‡∏°‡πâ:${g4} | ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô:${g5}`;
    }

    function setBeforeAfter(before, after){
      if(el('plateBeforeText')) el('plateBeforeText').textContent = before || '‚Äî';
      if(el('plateAfterText'))  el('plateAfterText').textContent  = after  || '‚Äî';
    }

    window.addEventListener('hha:end', (e)=>{
      lastSummary = e.detail || {};
      const g1 = Number(lastSummary.g1||0), g2 = Number(lastSummary.g2||0),
            g3 = Number(lastSummary.g3||0), g4 = Number(lastSummary.g4||0),
            g5 = Number(lastSummary.g5||0);

      const before = plateTextFromCounts(g1,g2,g3,g4,g5);
      setBeforeAfter(before, '‚Äî');
      renderBadges();
    });

    // --- Evaluate ---
    const btnSaveEvaluate = el('btnSaveEvaluate');
    if(btnSaveEvaluate){
      btnSaveEvaluate.addEventListener('click', ()=>{
        const picked = document.querySelector('input[name="evalReason"]:checked');
        const val = picked ? picked.value : '';
        if(!val) return;

        try{
          localStorage.setItem(LS_EVAL, JSON.stringify({
            at: Date.now(),
            reason: val,
            scoreFinal: lastSummary?.scoreFinal ?? lastSummary?.score ?? null,
            miss: lastSummary?.miss ?? lastSummary?.misses ?? null,
            grade: lastSummary?.grade ?? null
          }));
        }catch{}

        addBadge('plate_eval_saved'); // silent badge
        const hint = el('evalSavedHint');
        if(hint){
          hint.style.display = 'block';
          setTimeout(()=>{ hint.style.display='none'; }, 1600);
        }
      });
    }

    // --- Create (simulate immediate impact) ---
    function applyCreate(kind){
      if(!lastSummary){
        addBadge('plate_create_' + kind);
        return;
      }

      // snapshot before
      let g1 = Number(lastSummary.g1||0), g2 = Number(lastSummary.g2||0),
          g3 = Number(lastSummary.g3||0), g4 = Number(lastSummary.g4||0),
          g5 = Number(lastSummary.g5||0);

      const before = plateTextFromCounts(g1,g2,g3,g4,g5);

      // simple child-friendly simulation rules (instant feedback)
      if(kind === 'veg'){
        g3 = g3 + 1;
      }else if(kind === 'reduce_rice'){
        g2 = Math.max(0, g2 - 1);
        g3 = g3 + 1; // nudge better balance
      }else if(kind === 'swap_snack'){
        // treat swap as reducing junk impact -> increase fruit
        g4 = g4 + 1;
      }

      const after = plateTextFromCounts(g1,g2,g3,g4,g5);
      setBeforeAfter(before, after);

      addBadge('plate_create_' + kind);
    }

    const bVeg = el('btnAddVeg');
    const bRice = el('btnReduceRice');
    const bSwap = el('btnSwapSnack');

    if(bVeg)  bVeg.addEventListener('click', ()=>applyCreate('veg'));
    if(bRice) bRice.addEventListener('click', ()=>applyCreate('reduce_rice'));
    if(bSwap) bSwap.addEventListener('click', ()=>applyCreate('swap_snack'));

    // initial
    renderBadges();
  </script>
</body>
</html>