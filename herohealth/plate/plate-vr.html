<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- External CSS -->
  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- A-Frame (ENTER VR / EXIT / RECENTER handled by vr-ui.js) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Cloud Logger + Universal VR UI -->
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>

  <script>
    /* Universal VR UI lockPx (crosshair assist) */
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>
</head>

<body class="view-mobile">
  <!-- Minimal A-Frame scene (enterVR/exit/recenter work) -->
  <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true" background="color: #000">
    <a-entity id="rig" position="0 0 0">
      <a-camera position="0 1.6 0" look-controls="enabled:true"></a-camera>
    </a-entity>
  </a-scene>

  <div class="bg"></div>

  <main class="stage" id="stage">
    <!-- Spawn layer -->
    <div id="plate-layer" aria-label="plate targets layer"></div>

    <!-- HUD TOP -->
    <section class="hudTop" id="hudTop">
      <div class="card">
        <div class="t">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="v">
          <span class="pill">üèÜ <span id="uiScore">0</span></span>
          <span class="pill">üî• <span id="uiCombo">0</span> (<span class="muted">max</span> <span id="uiComboMax">0</span>)</span>
          <span class="pill">üí• <span id="uiMiss">0</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ / ‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="v">
          <span class="pill">üçΩÔ∏è <span id="uiPlateHave">0</span>/5</span>
          <span class="pill">üéØ <span id="uiAcc">0%</span></span>
          <span class="pill">üèÖ <span id="uiGrade">C</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="v">
          <span class="pill">‚è±Ô∏è <span id="uiTime">0</span>s</span>
          <span class="pill muted">view: <span id="uiView">mobile</span></span>
        </div>
      </div>

      <div class="card">
        <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (5 ‡∏´‡∏°‡∏π‡πà)</div>
        <div class="v">
          <span class="pill">ü•¶ <span id="uiG1">0</span></span>
          <span class="pill">üçé <span id="uiG2">0</span></span>
          <span class="pill">üêü <span id="uiG3">0</span></span>
          <span class="pill">üçö <span id="uiG4">0</span></span>
          <span class="pill">ü•ë <span id="uiG5">0</span></span>
        </div>
      </div>
    </section>

    <!-- GOAL + MINI -->
    <section class="miniPanel" id="miniPanel">
      <div class="questCard">
        <div class="questCol">
          <div class="k">üéØ GOAL</div>
          <div style="font-weight:1100" id="uiGoalTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill"><span id="uiGoalCount">0/5</span></span>
            <div class="bar" style="width:200px"><i id="uiGoalFill" style="width:0%"></i></div>
          </div>
        </div>

        <div class="questCol">
          <div class="k">‚ö° MINI</div>
          <div style="font-weight:1100" id="uiMiniTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill">üéØ <span id="uiMiniCount">0%</span></span>
            <div class="bar" style="width:200px">
              <i id="uiMiniFill" style="width:0%"></i>
            </div>
          </div>
        </div>

        <div class="questCol" style="min-width:260px">
          <div class="k">üí° Hint</div>
          <div class="hint" id="uiHint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‚â• 80%</div>
          <div class="hint" id="uiCvrHint" style="margin-top:6px">Cardboard: view=cvr ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (vr-ui.js)</div>
        </div>
      </div>
    </section>

    <!-- COACH -->
    <section class="coachPanel" id="coachPanel">
      <div class="questCard coachRow">
        <div class="coachLeft">
          <img id="coachImg" src="../img/plate-neutral.png" alt="coach" class="coachImg" />
          <div>
            <div class="k">üßë‚Äçüè´ Coach</div>
            <div id="coachMsg" class="coachMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üçΩÔ∏è</div>
          </div>
        </div>
        <div class="hint coachRight">
          ‡πÅ‡∏ï‡∏∞ = ‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ‚Ä¢ VR/cVR = ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (vr-ui.js ‚Üí hha:shoot)
        </div>
      </div>
    </section>

    <!-- Buttons -->
    <section class="hudBtns" id="hudBtns">
      <button class="btn primary" id="btnStart" type="button">‚ñ∂ START</button>
      <button class="btn" id="btnBackHub" type="button">üè† HUB</button>
      <button class="btn warn" id="btnRestart" type="button">‚ôª RESTART</button>
    </section>

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay" style="display:grid">
      <div class="panelCard">
        <div class="topRow">
          <div>
            <div class="title">üçΩÔ∏è Balanced Plate VR</div>
            <div class="sub">
              ‡πÇ‡∏´‡∏°‡∏î: <b id="uiRunPreview">play</b> ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <b id="uiDiffPreview">normal</b> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <b id="uiTimePreview">90</b>s
              <br/>Play = Adaptive ON ‚Ä¢ Study/Research = Seeded & Adaptive OFF
            </div>
          </div>
          <div class="sub" style="text-align:right">
            Tip: Cardboard ‡πÉ‡∏ä‡πâ <b>view=cvr</b><br/>‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnStartMain" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂</button>
          <button class="btn" id="btnCopyLink" type="button">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ üîó</button>
          <button class="btn" id="btnOpenRoot" type="button">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Root Launcher üß≠</button>
        </div>

        <div class="dbg" id="startDbg"></div>
      </div>
    </div>

    <!-- Result overlay -->
    <div class="overlay" id="resultBackdrop">
      <div class="panelCard">
        <div class="topRow">
          <div>
            <div class="title">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
            <div class="sub">Mode: <b id="rMode">‚Äî</b> ‚Ä¢ Grade: <b id="rGrade">‚Äî</b></div>
          </div>
          <div class="btnRow" style="justify-content:flex-end;margin-top:0">
            <button class="btn primary" id="btnPlayAgain" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚ñ∂</button>
            <button class="btn" id="btnBackHub2" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB üè†</button>
          </div>
        </div>

        <div class="grid2">
          <div class="box">
            <div class="t">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">üèÜ <span id="rScore">0</span></span>
              <span class="pill">üî• Max Combo <b id="rMaxCombo">0</b></span>
              <span class="pill">üí• Miss <b id="rMiss">0</b></span>
              <span class="pill">üéØ Acc <b id="rAcc">0%</b></span>
            </div>
          </div>

          <div class="box">
            <div class="t">5 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">ü•¶ <b id="rG1">0</b></span>
              <span class="pill">üçé <b id="rG2">0</b></span>
              <span class="pill">üêü <b id="rG3">0</b></span>
              <span class="pill">üçö <b id="rG4">0</b></span>
              <span class="pill">ü•ë <b id="rG5">0</b></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- RUN GAME -->
  <script type="module">
    import { boot } from './plate.safe.js';

    const LS_LAST = 'HHA_LAST_SUMMARY';
    const LS_HIST = 'HHA_SUMMARY_HISTORY';

    const qs = (id)=>document.getElementById(id);
    const setText = (id,v)=>{ const el=qs(id); if(el) el.textContent = String(v); };
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,Number(v)||0));

    const U = new URL(location.href);
    const hubUrl = U.searchParams.get('hub') || '../hub.html';
    const runRaw = (U.searchParams.get('run') || U.searchParams.get('runMode') || 'play').toLowerCase();
    const diff   = (U.searchParams.get('diff') || 'normal').toLowerCase();
    const timePlannedSec = clamp(U.searchParams.get('time') || 90, 20, 9999);
    const seedParam = U.searchParams.get('seed');
    const view = (U.searchParams.get('view') || 'mobile').toLowerCase();

    const isStudy = (runRaw === 'study' || runRaw === 'research');
    const runMode = isStudy ? runRaw : 'play';
    const seed = Number(seedParam || (isStudy ? 13579 : (Date.now() ^ (Math.random()*1e9)))) || 13579;

    // view classes
    document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    document.body.classList.add(view === 'cvr' ? 'view-cvr' : (view === 'vr' ? 'view-vr' : (view === 'pc' ? 'view-pc' : 'view-mobile')));
    setText('uiView', view);

    // previews
    setText('uiRunPreview', runMode);
    setText('uiDiffPreview', diff);
    setText('uiTimePreview', timePlannedSec);

    // coach assets (path: /herohealth/img/plate-*.png)
    const COACH = {
      neutral:'../img/plate-neutral.png',
      happy:'../img/plate-happy.png',
      sad:'../img/plate-sad.png',
      fever:'../img/plate-fever.png'
    };
    function setCoach(mood, msg){
      const img = qs('coachImg');
      const m = COACH[mood] ? mood : 'neutral';
      if(img) img.src = COACH[m];
      if(msg != null) setText('coachMsg', msg);
    }

    function saveJson(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch{} }
    function loadJson(key,fb){ try{ const s=localStorage.getItem(key); return s?JSON.parse(s):fb; }catch{ return fb; } }

    async function flushHardened(reason){
      try{
        const L = window.HHA_LOGGER || window.HHACloudLogger || window.HHA_CloudLogger || null;
        if(L && typeof L.flush === 'function'){
          await Promise.race([ Promise.resolve(L.flush(reason||'manual')), new Promise(res=>setTimeout(res, 650)) ]);
        }else if(L && typeof L.flushNow === 'function'){
          await Promise.race([ Promise.resolve(L.flushNow({reason})), new Promise(res=>setTimeout(res, 650)) ]);
        }
      }catch{}
    }

    function showResult(summary){
      qs('resultBackdrop').style.display = 'grid';
      setText('rMode', summary.runMode || runMode);
      setText('rGrade', summary.grade || '‚Äî');
      setText('rScore', summary.scoreFinal ?? summary.score ?? 0);
      setText('rMaxCombo', summary.comboMax ?? 0);
      setText('rMiss', summary.miss ?? summary.misses ?? 0);
      setText('rAcc', (summary.accuracyPct != null ? summary.accuracyPct : (summary.accuracyGoodPct ?? 0)) + '%');

      setText('rG1', summary.g1 ?? 0);
      setText('rG2', summary.g2 ?? 0);
      setText('rG3', summary.g3 ?? 0);
      setText('rG4', summary.g4 ?? 0);
      setText('rG5', summary.g5 ?? 0);
    }

    // wire HUD streams
    window.addEventListener('hha:score', (e)=>{
      const d = e.detail || {};
      setText('uiScore', d.score ?? 0);
      setText('uiCombo', d.combo ?? 0);
      setText('uiComboMax', d.comboMax ?? 0);
    });

    window.addEventListener('hha:time', (e)=>{
      const d = e.detail || {};
      const left = (d.leftSec != null) ? d.leftSec : (d.timeLeftSec != null ? d.timeLeftSec : 0);
      setText('uiTime', left);
    });

    window.addEventListener('quest:update', (e)=>{
      const d = e.detail || {};
      const g = d.goal || {};
      const m = d.mini || {};

      setText('uiGoalTitle', g.name || '‚Äî');
      setText('uiGoalCount', `${g.cur ?? 0}/${g.target ?? 0}`);
      const gf = qs('uiGoalFill');
      if(gf){
        const pct = (g.target ? (Number(g.cur||0)/Number(g.target||1))*100 : 0);
        gf.style.width = Math.max(0,Math.min(100,pct)) + '%';
      }

      setText('uiMiniTitle', m.name || '‚Äî');
      setText('uiMiniCount', `${m.cur ?? 0}%`);
      const mf = qs('uiMiniFill');
      if(mf){
        const pct = Math.max(0,Math.min(100, Number(m.cur||0)));
        mf.style.width = pct + '%';
      }
    });

    // grade/acc/miss/plate-have best-effort from judge stream
    window.addEventListener('hha:judge', (e)=>{
      const d = e.detail || {};
      if(d.kind === 'good'){
        const gid = Number(d.groupId||0);
        if(gid>=1 && gid<=5){
          const id = 'uiG' + gid;
          const cur = Number(qs(id)?.textContent||0);
          setText(id, cur + 1);

          const haveNow = [1,2,3,4,5].reduce((acc,i)=> acc + (Number(qs('uiG'+i)?.textContent||0)>0 ? 1:0), 0);
          setText('uiPlateHave', haveNow);
        }
      }
      if(d.kind === 'junk' || d.kind === 'expire_good'){
        const curMiss = Number(qs('uiMiss')?.textContent||0);
        setText('uiMiss', curMiss + 1);
      }
      // try update grade/acc if payload contains them (future-proof)
      if(d.grade) setText('uiGrade', d.grade);
      if(d.accuracyPct != null) setText('uiAcc', d.accuracyPct + '%');
    });

    window.addEventListener('hha:coach', (e)=>{
      const d = e.detail || {};
      const msg = String(d.msg||'');
      const mood = (d.mood ? String(d.mood) : 'neutral');
      setCoach(mood, msg || '‚Äî');
    });

    window.addEventListener('hha:end', async (e)=>{
      const summary = e.detail || {};
      saveJson(LS_LAST, summary);

      const hist = loadJson(LS_HIST, []);
      const next = Array.isArray(hist) ? hist : [];
      next.unshift(summary);
      while(next.length > 50) next.pop();
      saveJson(LS_HIST, next);

      // reflect final stats
      setText('uiGrade', summary.grade || '‚Äî');
      setText('uiAcc', (summary.accuracyPct != null ? summary.accuracyPct : (summary.accuracyGoodPct ?? 0)) + '%');
      setText('uiMiss', summary.miss ?? summary.misses ?? Number(qs('uiMiss')?.textContent||0));

      setCoach((summary.grade==='D'?'sad':'happy'), '‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üèÅ');
      showResult(summary);

      await flushHardened(summary.reason || 'end');
    });

    // Buttons
    qs('btnBackHub')?.addEventListener('click', async ()=>{
      await flushHardened('back-hub');
      location.href = hubUrl || '../hub.html';
    }, {passive:true});

    qs('btnBackHub2')?.addEventListener('click', async ()=>{
      await flushHardened('back-hub');
      location.href = hubUrl || '../hub.html';
    }, {passive:true});

    qs('btnRestart')?.addEventListener('click', async ()=>{
      await flushHardened('restart');
      const uu = new URL(location.href);
      if(!isStudy) uu.searchParams.set('seed', String(Date.now() ^ (Math.random()*1e9)));
      location.href = uu.toString();
    }, {passive:true});

    qs('btnPlayAgain')?.addEventListener('click', async ()=>{
      await flushHardened('play-again');
      const uu = new URL(location.href);
      if(!isStudy) uu.searchParams.set('seed', String(Date.now() ^ (Math.random()*1e9)));
      location.href = uu.toString();
    }, {passive:true});

    qs('btnCopyLink')?.addEventListener('click', async ()=>{
      const dbg = qs('startDbg');
      try{
        await navigator.clipboard.writeText(location.href);
        if(dbg) dbg.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß';
      }catch{
        if(dbg) dbg.textContent = '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö URL ‡πÑ‡∏î‡πâ';
      }
    }, {passive:true});

    qs('btnOpenRoot')?.addEventListener('click', ()=>{
      const root = new URL('../plate-vr.html', location.href);
      const hub = U.searchParams.get('hub');
      if(hub) root.searchParams.set('hub', hub);
      ['run','diff','time','seed','view'].forEach(k=>{
        const v = U.searchParams.get(k);
        if(v!=null && v!=='') root.searchParams.set(k,v);
      });
      location.href = root.toString();
    }, {passive:true});

    // Start overlay debug
    const startDbg = qs('startDbg');
    if(startDbg) startDbg.textContent = 'URL: ' + location.href;

    function startGame(){
      // reset UI quick
      setText('uiScore', 0); setText('uiCombo', 0); setText('uiComboMax', 0);
      setText('uiMiss', 0);
      setText('uiG1',0); setText('uiG2',0); setText('uiG3',0); setText('uiG4',0); setText('uiG5',0);
      setText('uiPlateHave',0);
      setText('uiAcc','0%'); setText('uiGrade','C');

      qs('startOverlay').style.display = 'none';
      qs('resultBackdrop').style.display = 'none';

      const cfg = {
        runMode,
        diff,
        seed,
        durationPlannedSec: timePlannedSec,
        allowEarlyEnd: false
      };

      const mount = qs('plate-layer');
      boot({ mount, cfg });

      setCoach('neutral', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üçΩÔ∏è');
    }

    qs('btnStart')?.addEventListener('click', startGame, {passive:true});
    qs('btnStartMain')?.addEventListener('click', startGame, {passive:true});

    // cVR strict: disable pointer events on targets; shoot via crosshair (vr-ui.js)
    if(view === 'cvr'){
      const layer = qs('plate-layer');
      if(layer) layer.style.pointerEvents = 'none';
    }
  </script>

  <!-- SAFE Engine (already in /herohealth/plate/plate.safe.js) -->
  <script type="module" src="./plate.safe.js"></script>
</body>
</html>