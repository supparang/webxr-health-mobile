<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR (RUN)</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- External CSS -->
  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- A-Frame (ENTER VR / EXIT / RECENTER handled by vr-ui.js) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Logger + Universal VR UI + FX -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>

  <script>
    // vr-ui.js aim assist
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>
</head>

<body class="view-mobile">
  <!-- Minimal A-Frame scene so vr-ui.js can show EnterVR/Exit/Recenter -->
  <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true" background="color:#000">
    <a-entity id="rig" position="0 0 0">
      <a-camera position="0 1.6 0" look-controls="enabled:true"></a-camera>
    </a-entity>
  </a-scene>

  <div class="bg"></div>

  <!-- FX layers (optional) -->
  <div id="stormFx"></div>
  <div id="bossFx"></div>

  <div class="stage">
    <!-- spawn layer -->
    <div id="plate-layer" aria-label="plate targets layer"></div>
    <div id="hitFx"></div>

    <!-- HUD TOP -->
    <div class="hudTop" id="hudTop">
      <div class="card">
        <div class="t">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="v">
          <span class="pill">üèÜ <span id="uiScore">0</span></span>
          <span class="pill">üî• <span id="uiCombo">0</span> (<span class="muted">max</span> <span id="uiComboMax">0</span>)</span>
          <span class="pill">üí• <span id="uiMiss">0</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ / ‡πÄ‡∏Å‡∏£‡∏î</div>
        <div class="v">
          <span class="pill">üçΩÔ∏è <span id="uiPlateHave">0</span>/5</span>
          <span class="pill">üéØ <span id="uiAcc">0%</span></span>
          <span class="pill">üèÖ <span id="uiGrade">C</span></span>
        </div>
      </div>

      <div class="card small">
        <div class="t">‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="v">
          <span class="pill">‚è±Ô∏è <span id="uiTime">0</span>s</span>
          <span class="pill muted">diff: <span id="uiDiffPreview">normal</span></span>
          <span class="pill muted">mode: <span id="uiRunPreview">play</span></span>
        </div>
      </div>

      <div class="card">
        <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (5 ‡∏´‡∏°‡∏π‡πà)</div>
        <div class="v">
          <span class="pill">ü•¶ <span id="uiG1">0</span></span>
          <span class="pill">üçé <span id="uiG2">0</span></span>
          <span class="pill">üêü <span id="uiG3">0</span></span>
          <span class="pill">üçö <span id="uiG4">0</span></span>
          <span class="pill">ü•ë <span id="uiG5">0</span></span>
        </div>
      </div>
    </div>

    <!-- Storm HUD -->
    <div id="stormHud">
      <div class="stormCard">
        <div class="t" id="stormTitle">üå™Ô∏è STORM</div>
        <div class="stormLine" id="stormHint">‚Äî</div>
        <div class="stormProg" id="stormProg">‚Äî</div>
      </div>
    </div>

    <!-- Boss HUD -->
    <div id="bossHud">
      <div class="bossCard">
        <div class="t" id="bossTitle">üëπ BOSS</div>
        <div class="bossLine" id="bossHint">‚Äî</div>
        <div class="bossProg" id="bossProg">‚Äî</div>
      </div>
    </div>

    <!-- GOAL + MINI -->
    <div id="miniPanel">
      <div class="questCard">
        <div class="questCol">
          <div class="k">üéØ GOAL</div>
          <div style="font-weight:1100" id="uiGoalTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill"><span id="uiGoalCount">0/0</span></span>
            <div class="bar" style="width:200px"><i id="uiGoalFill" style="width:0%"></i></div>
          </div>
        </div>

        <div class="questCol">
          <div class="k">‚ö° MINI</div>
          <div style="font-weight:1100" id="uiMiniTitle">‚Äî</div>
          <div class="questRow">
            <span class="pill">‚è≥ <span id="uiMiniTime">--</span></span>
            <span class="pill">‚úÖ <span id="uiMiniCount">0/0</span></span>
            <div class="bar" style="width:200px">
              <i id="uiMiniFill" style="width:0%; background:rgba(245,158,11,.85)"></i>
            </div>
          </div>
        </div>

        <div class="questCol" style="min-width:260px">
          <div class="k">üí° Hint</div>
          <div class="hint" id="uiHint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥!</div>
          <div class="hint" id="uiCvrHint" style="margin-top:6px">Cardboard: view=cvr ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair</div>
        </div>
      </div>
    </div>

    <!-- COACH -->
    <div id="coachPanel">
      <div class="questCard" style="justify-content:space-between">
        <div style="display:flex; gap:10px; align-items:center; min-width:260px;">
          <img id="coachImg" src="../img/plate-neutral.png" alt="coach"
               style="width:44px;height:44px;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.50);object-fit:cover" />
          <div>
            <div class="k">üßë‚Äçüè´ Coach</div>
            <div id="coachMsg" style="font-weight:1100">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üí™</div>
          </div>
        </div>
        <div class="hint" style="text-align:right; max-width:360px">
          ‡∏¢‡∏¥‡∏á/‡πÅ‡∏ï‡∏∞ = ‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ‚Ä¢ cVR/VR = ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair (vr-ui.js)
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div id="hudBtns">
      <button class="btn primary" id="btnStart" type="button" style="display:none">‚ñ∂ START</button>
      <button class="btn" id="btnPause" type="button">‚è∏ PAUSE</button>
      <button class="btn warn" id="btnRestart" type="button">‚ôª RESTART</button>
      <button class="btn" id="btnEnterVR" type="button">üï∂ ENTER VR</button>
      <button class="btn" id="btnBackHub" type="button">üè† HUB</button>
    </div>

    <!-- Start overlay -->
    <div id="startOverlay" style="display:grid">
      <div class="panelCard">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start">
          <div>
            <div style="font-weight:1200; font-size:18px">üçΩÔ∏è Balanced Plate VR</div>
            <div style="margin-top:6px; color:var(--muted); font-weight:900; line-height:1.35; font-size:13px">
              ‡πÇ‡∏´‡∏°‡∏î: <b id="ovRun">play</b> ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <b id="ovDiff">normal</b> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <b id="ovTime">90</b>s
              <br/>Play = Adaptive + AI tips ‚Ä¢ Study/Research = Seeded + Adaptive OFF
            </div>
          </div>
          <div style="color:var(--muted); font-weight:900; font-size:13px; text-align:right">
            Tip: Cardboard ‡πÉ‡∏ä‡πâ <b>view=cvr</b><br/>‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="btn primary" id="btnStartMain" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂</button>
          <button class="btn" id="btnCopyLink" type="button">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ üîó</button>
          <button class="btn warn" id="btnGoLauncher" type="button">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Launcher üß≠</button>
        </div>

        <div id="startDbg" style="margin-top:10px; color:var(--muted); font-weight:900; font-size:12px"></div>
      </div>
    </div>

    <!-- Paused overlay -->
    <div id="hudPaused">
      <div class="panelCard" style="width:min(520px,100%); text-align:center">
        <div style="font-weight:1200; font-size:18px">‚è∏ Paused</div>
        <div style="margin-top:6px; color:var(--muted); font-weight:900">‡∏Å‡∏î Pause ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</div>
        <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
          <button class="btn primary" id="btnResume" type="button">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</button>
          <button class="btn warn" id="btnRestart2" type="button">‚ôª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    </div>

    <!-- Result overlay -->
    <div id="resultBackdrop">
      <div class="panelCard">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start">
          <div>
            <div style="font-weight:1200; font-size:18px">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
            <div style="margin-top:6px; color:var(--muted); font-weight:900">
              Mode: <b id="rMode">‚Äî</b> ‚Ä¢ Grade: <b id="rGrade">‚Äî</b>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn primary" id="btnPlayAgain" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚ñ∂</button>
            <button class="btn" id="btnBackHub2" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB üè†</button>
          </div>
        </div>

        <div style="margin-top:12px; display:grid; grid-template-columns: 1.1fr .9fr; gap:12px" id="resultGrid">
          <div style="background:var(--panel2); border:1px solid var(--stroke); border-radius:18px; padding:12px">
            <div class="t">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">üèÜ <span id="rScore">0</span></span>
              <span class="pill">üî• Max Combo <b id="rMaxCombo">0</b></span>
              <span class="pill">üí• Miss <b id="rMiss">0</b></span>
              <span class="pill">üéØ Acc <b id="rAcc">0%</b></span>
              <span class="pill">‚ö° Minis <b id="rMinis">0/0</b></span>
            </div>
          </div>

          <div style="background:var(--panel2); border:1px solid var(--stroke); border-radius:18px; padding:12px">
            <div class="t">5 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ</div>
            <div class="v" style="margin-top:10px">
              <span class="pill">ü•¶ <b id="rG1">0</b></span>
              <span class="pill">üçé <b id="rG2">0</b></span>
              <span class="pill">üêü <b id="rG3">0</b></span>
              <span class="pill">üçö <b id="rG4">0</b></span>
              <span class="pill">ü•ë <b id="rG5">0</b></span>
            </div>
          </div>
        </div>

        <style>
          @media (max-width: 920px){
            #resultGrid{ grid-template-columns: 1fr !important; }
          }
        </style>
      </div>
    </div>

  </div>

  <!-- UI bridge + coach listener -->
  <script>
    (function(){
      const U = new URL(location.href);
      const hub = U.searchParams.get('hub') || '';

      const view = (U.searchParams.get('view') || 'mobile').toLowerCase();
      const run  = (U.searchParams.get('run') || U.searchParams.get('runMode') || 'play').toLowerCase();
      const diff = (U.searchParams.get('diff') || 'normal').toLowerCase();
      const time = Number(U.searchParams.get('time') || 90) || 90;

      // body view class
      document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
      document.body.classList.add(view === 'cvr' ? 'view-cvr' : (view === 'vr' ? 'view-vr' : (view === 'pc' ? 'view-pc' : 'view-mobile')));

      // previews
      const setText = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent=String(v); };
      setText('uiDiffPreview', diff);
      setText('uiRunPreview', run);
      setText('ovRun', run);
      setText('ovDiff', diff);
      setText('ovTime', time);

      // overlay buttons
      const startDbg = document.getElementById('startDbg');
      const btnStartMain = document.getElementById('btnStartMain');
      const btnCopy = document.getElementById('btnCopyLink');
      const btnGoLauncher = document.getElementById('btnGoLauncher');
      if(startDbg) startDbg.textContent = 'URL: ' + location.href;

      btnStartMain?.addEventListener('click', ()=> document.getElementById('btnStart')?.click(), {passive:true});
      btnCopy?.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(location.href); if(startDbg) startDbg.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'; }
        catch{ if(startDbg) startDbg.textContent = '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö URL ‡πÑ‡∏î‡πâ'; }
      }, {passive:true});
      btnGoLauncher?.addEventListener('click', ()=>{
        const L = new URL('../plate-vr.html', location.href);
        if(hub) L.searchParams.set('hub', hub);
        location.href = L.toString();
      }, {passive:true});

      // HUD buttons actions (wired by engine too, but keep safe)
      const backToHub = ()=>{
        if(hub) location.href = hub;
        else location.href = '../hub.html';
      };
      document.getElementById('btnBackHub')?.addEventListener('click', backToHub, {passive:true});
      document.getElementById('btnBackHub2')?.addEventListener('click', backToHub, {passive:true});

      // pause overlay helpers
      document.getElementById('btnResume')?.addEventListener('click', ()=>document.getElementById('btnPause')?.click(), {passive:true});
      document.getElementById('btnRestart2')?.addEventListener('click', ()=>document.getElementById('btnRestart')?.click(), {passive:true});

      // coach images in /img/plate-*.png
      const coachImg = document.getElementById('coachImg');
      const coachMsg = document.getElementById('coachMsg');
      const COACH = {
        neutral: '../img/plate-neutral.png',
        happy:   '../img/plate-happy.png',
        sad:     '../img/plate-sad.png',
        fever:   '../img/plate-fever.png',
      };

      window.addEventListener('hha:coach', (ev)=>{
        const d = ev.detail || {};
        const msg = String(d.msg || d.text || '');
        const mood = String(d.mood || d.tag || 'neutral').toLowerCase();
        if(coachMsg && msg) coachMsg.textContent = msg;
        if(coachImg){
          const key = (mood.includes('happy')?'happy' :
                       mood.includes('sad')?'sad' :
                       mood.includes('fever')?'fever' : 'neutral');
          coachImg.src = COACH[key] || COACH.neutral;
        }
      }, {passive:true});

      // result overlay bind
      window.addEventListener('hha:end', (ev)=>{
        const s = ev.detail || {};
        const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=String(v); };
        document.getElementById('resultBackdrop').style.display = 'grid';
        set('rMode', s.runMode || run);
        set('rGrade', s.grade || 'C');
        set('rScore', s.scoreFinal ?? 0);
        set('rMaxCombo', s.comboMax ?? 0);
        set('rMiss', s.miss ?? s.misses ?? 0);
        set('rAcc', (s.accuracyPct!=null ? (Math.round(s.accuracyPct)+'%') : (s.accuracyGoodPct!=null ? (Math.round(s.accuracyGoodPct)+'%') : '0%')));
        set('rMinis', `${s.miniCleared ?? 0}/${s.miniTotal ?? 0}`);
        set('rG1', s.g1 ?? 0);
        set('rG2', s.g2 ?? 0);
        set('rG3', s.g3 ?? 0);
        set('rG4', s.g4 ?? 0);
        set('rG5', s.g5 ?? 0);
      }, {passive:true});

      // play again
      document.getElementById('btnPlayAgain')?.addEventListener('click', ()=>{
        const u = new URL(location.href);
        if(run === 'play'){
          u.searchParams.set('seed', String((Date.now() ^ (Math.random()*1e9))|0));
        }
        location.href = u.toString();
      }, {passive:true});

      // enter vr button (fallback; vr-ui.js already provides UI)
      document.getElementById('btnEnterVR')?.addEventListener('click', ()=>{
        try{ document.querySelector('a-scene')?.enterVR?.(); }catch(e){}
      }, {passive:true});
    })();
  </script>

  <!-- RUN GAME -->
  <script type="module" src="./plate.safe.js"></script>
</body>
</html>