<!-- === /herohealth/plate/plate-vr.html ===
Balanced Plate VR ‚Äî RUN (PRODUCTION)
‚úÖ Uses: ./plate-vr.css
‚úÖ Uses: ./plate.safe.js (engine)
‚úÖ Auto loads Universal VR UI: ../vr/vr-ui.js
‚úÖ Supports: view=auto|pc|mobile|vr|cvr (auto default)
‚úÖ HHA Standard: hub/back + last summary localStorage + URL passthrough
‚úÖ Cloud Logger ready (?log=...)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./plate-vr.css" />

  <!-- Universal VR UI (Enter VR / Exit / Recenter + crosshair + tap-to-shoot) -->
  <script>
    // MUST NOT override user's choice; default is auto
    window.HHA_VRUI_CONFIG = { lockPx: 28, cooldownMs: 90 };
  </script>
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Optional: FX (if your project already uses it; safe to omit) -->
  <script src="../vr/particles.js" defer></script>

  <!-- Cloud logger (optional; uses ?log= endpoint) -->
  <script src="../vr/hha-cloud-logger.js" defer></script>

  <style>
    /* minimal host IDs used by engine */
    #plate-layer { position:fixed; inset:0; }
  </style>
</head>

<body class="view-auto">
  <!-- Optional background slot -->
  <div id="sceneRoot" aria-hidden="true"></div>

  <!-- PLAY LAYER: targets spawn inside -->
  <div id="plate-layer" aria-label="play layer"></div>

  <!-- ===== HUD TOP ===== -->
  <div id="hudTop" aria-hidden="false">
    <div id="hudMain" class="hudCard">
      <div class="hudStat">
        <div class="hudLabel">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div id="uiScore" class="hudValue">0</div>
      </div>

      <div class="hudStat">
        <div class="hudLabel">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
        <div id="uiCombo" class="hudValue">0</div>
      </div>

      <div class="hudStat" style="min-width:150px;">
        <div class="hudLabel">‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div id="uiTime" class="hudValue">00:00</div>
        <div class="hudTiny" id="uiTimeHint">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>

      <div class="hudStat" style="min-width:150px; justify-content:flex-end;">
        <div class="hudLabel">FEVER</div>
        <div id="uiFeverWrap" aria-label="fever bar">
          <div id="uiFeverFill"></div>
        </div>
      </div>

      <div class="hudStat" style="justify-content:flex-end;">
        <div id="uiGradeChip">Diff</div>
      </div>
    </div>
  </div>

  <!-- ===== GOAL / MINI ===== -->
  <div id="miniPanel" aria-hidden="false">
    <div class="miniCard">
      <div class="miniTitle">GOAL</div>
      <div id="uiGoalText" class="miniText">‚Äî</div>
      <div class="miniProg" aria-label="goal progress"><i id="uiGoalFill"></i></div>
    </div>

    <div class="miniCard">
      <div class="miniTitle">MINI QUEST</div>
      <div id="uiMiniText" class="miniText">‚Äî</div>
      <div class="miniProg" aria-label="mini progress"><i id="uiMiniFill"></i></div>
    </div>
  </div>

  <!-- ===== Boss / Storm (optional) ===== -->
  <div id="bossHud" aria-hidden="true">
    <div class="phaseCard">
      <div class="phaseTop">
        <div class="phaseTitle" id="uiBossTitle">BOSS</div>
        <div class="phaseHint" id="uiBossHint">‚Äî</div>
      </div>
      <div class="phaseProg"><i id="uiBossFill"></i></div>
    </div>
  </div>

  <div id="stormHud" aria-hidden="true">
    <div class="phaseCard">
      <div class="phaseTop">
        <div class="phaseTitle" id="uiStormTitle">STORM</div>
        <div class="phaseHint" id="uiStormHint">‚Äî</div>
      </div>
      <div class="phaseProg"><i id="uiStormFill"></i></div>
    </div>
  </div>

  <!-- ===== COACH ===== -->
  <div id="coachPanel" aria-hidden="false">
    <div class="coachCard">
      <div id="coachAvatar" aria-hidden="true">üôÇ</div>
      <div>
        <div id="coachMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡∏∞</div>
        <div id="coachHint">‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤ ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î VR ‡πÉ‡∏ä‡πâ crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠</div>
      </div>
    </div>
  </div>

  <!-- ===== BUTTONS ===== -->
  <div id="hudBtns" aria-hidden="false">
    <button class="hudBtn secondary" id="btnPause" type="button">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button class="hudBtn warn" id="btnRestart" type="button">‚Üª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    <button class="hudBtn" id="btnBackHub" type="button">‚Ü© ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
  </div>

  <!-- ===== HIT FX ===== -->
  <div id="hitFx" aria-hidden="true"></div>

  <!-- ===== START OVERLAY ===== -->
  <div id="startOverlay" aria-hidden="false">
    <div class="modal">
      <h1>Balanced Plate VR</h1>
      <p id="startDesc">
        ‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‚Äù ‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‚Ä¢
        ‡πÇ‡∏´‡∏°‡∏î VR ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (crosshair)
      </p>

      <div class="row">
        <button class="bigBtn secondary" id="btnHow" type="button">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="bigBtn" id="btnStart" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô ‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- ===== PAUSED ===== -->
  <div id="hudPaused" aria-hidden="true">
    <div class="modal">
      <h1>‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</h1>
      <p>‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</p>
      <div class="row">
        <button class="bigBtn secondary" id="btnResume" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</button>
        <button class="bigBtn secondary" id="btnPauseRestart" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        <button class="bigBtn" id="btnPauseHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== RESULT ===== -->
  <div id="resultBackdrop" aria-hidden="true">
    <div class="modal">
      <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h1>
      <p id="resultSummary">‚Äî</p>
      <div class="row">
        <button class="bigBtn secondary" id="btnResultRestart" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="bigBtn" id="btnResultHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== Engine boot ===== -->
  <script type="module">
    import { boot as plateBoot } from './plate.safe.js';

    function qs(k, def=null){
      try{ return new URL(location.href).searchParams.get(k) ?? def; }
      catch{ return def; }
    }
    function clampStr(v, arr, def){
      v = (v||'').toLowerCase();
      return arr.includes(v) ? v : def;
    }
    function setBodyView(view){
      const b = document.body;
      b.classList.remove('view-auto','view-pc','view-mobile','view-vr','view-cvr');
      b.classList.add('view-' + view);
    }
    function autoView(){
      // DON'T override if user provided view=
      const forced = (qs('view','')||'').toLowerCase();
      if(forced){
        return clampStr(forced, ['pc','mobile','vr','cvr','auto'], 'auto');
      }
      const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints>0);
      const isNarrow = Math.min(innerWidth, innerHeight) <= 540;
      return (isTouch && isNarrow) ? 'mobile' : 'pc';
    }

    // --- URL context (HHA standard passthrough) ---
    const hub = qs('hub','../hub.html');
    const run = clampStr(qs('run','play'), ['play','study','research'], 'play');
    const diff = clampStr(qs('diff','normal'), ['easy','normal','hard'], 'normal');
    const time = Math.max(20, Number(qs('time','70'))||70);
    const seed = Number(qs('seed','0')) || 0;

    const view = autoView();
    setBodyView(view);

    // UI chips
    const chip = document.getElementById('uiGradeChip');
    chip.textContent = `${diff.toUpperCase()} ‚Ä¢ ${run.toUpperCase()}`;

    // buttons basic
    const startOverlay = document.getElementById('startOverlay');
    const paused = document.getElementById('hudPaused');
    const result = document.getElementById('resultBackdrop');

    const goHub = ()=>{
      // flush-hardened convention: store last link for hub
      const u = new URL(hub, location.href);
      u.searchParams.set('last', location.href);
      location.href = u.toString();
    };

    document.getElementById('btnBackHub').onclick = goHub;
    document.getElementById('btnPauseHub').onclick = goHub;
    document.getElementById('btnResultHub').onclick = goHub;

    document.getElementById('btnRestart').onclick = ()=> location.reload();
    document.getElementById('btnPauseRestart').onclick = ()=> location.reload();
    document.getElementById('btnResultRestart').onclick = ()=> location.reload();

    document.getElementById('btnHow').onclick = ()=>{
      alert("‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô:\n- ‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à\n- ‡πÇ‡∏´‡∏°‡∏î VR ‡πÉ‡∏ä‡πâ crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ + tap-to-shoot\n- ‡∏ó‡∏≥ GOAL ‡πÅ‡∏•‡∏∞ MINI QUEST ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ö‡∏ô‡∏±‡∏™");
    };

    // pause toggle
    document.getElementById('btnPause').onclick = ()=>{
      paused.style.display = 'grid';
      paused.setAttribute('aria-hidden','false');
      // let engine know (optional)
      window.dispatchEvent(new CustomEvent('hha:pause'));
    };
    document.getElementById('btnResume').onclick = ()=>{
      paused.style.display = 'none';
      paused.setAttribute('aria-hidden','true');
      window.dispatchEvent(new CustomEvent('hha:resume'));
    };

    // start
    document.getElementById('btnStart').onclick = ()=>{
      startOverlay.style.display = 'none';
      startOverlay.setAttribute('aria-hidden','true');
      window.dispatchEvent(new CustomEvent('hha:start'));
    };

    // listen end summary from engine
    window.addEventListener('hha:end', (ev)=>{
      try{
        const d = ev.detail || {};
        const s = [
          `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${d.scoreFinal ?? d.score ?? 0}`,
          `‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${d.comboMax ?? d.combo ?? 0}`,
          `‡∏û‡∏•‡∏≤‡∏î: ${d.misses ?? 0}`,
          `GOAL: ${(d.goalsCleared ?? 0)}/${(d.goalsTotal ?? 0)}`,
          `MINI: ${(d.miniCleared ?? 0)}/${(d.miniTotal ?? 0)}`
        ].join(" ‚Ä¢ ");
        document.getElementById('resultSummary').textContent = s;

        // Store last summary (HHA standard)
        const payload = {
          game:'plate',
          at: new Date().toISOString(),
          url: location.href,
          summary: d
        };
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(payload));
      }catch{}
      result.style.display = 'grid';
      result.setAttribute('aria-hidden','false');
    });

    // boot engine (safe)
    plateBoot({
      host: '#plate-layer',
      hub,
      runMode: run,
      diff,
      durationPlannedSec: time,
      seed: seed || Date.now(),
      view
    });
  </script>
</body>
</html>