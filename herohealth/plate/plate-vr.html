<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî PlateVR (RUN)</title>
  <meta name="color-scheme" content="dark light"/>
  <meta name="theme-color" content="#020617"/>
  <link rel="icon" href="../favicon.ico"/>
  <link rel="stylesheet" href="./plate-vr.css"/>
</head>

<body class="view-pc">
  <div id="app">

    <!-- optional FX layers -->
    <div id="bossFx" aria-hidden="true"></div>
    <div id="stormFx" aria-hidden="true"></div>

    <!-- playfield (mount for spawner) -->
    <div id="plate-layer" aria-label="‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏ô PlateVR"></div>

    <!-- HUD -->
    <section id="hud" aria-label="HUD">
      <div class="hudRow">
        <div class="chip score" aria-label="Score">
          <div class="lbl">SCORE</div>
          <div class="val" id="hudScore">0</div>
        </div>
        <div class="chip time" aria-label="Time left">
          <div class="lbl">TIME</div>
          <div class="val" id="hudTime">0</div>
        </div>
        <div class="chip combo" aria-label="Combo">
          <div class="lbl">COMBO</div>
          <div class="val" id="hudCombo">0</div>
        </div>
      </div>

      <div class="card" aria-label="Quests">
        <div class="cardTitle">
          <div class="t">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <div class="hint" id="hudHint">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
        </div>

        <div class="qItem" aria-label="Goal quest">
          <div class="qText">
            <div class="name" id="goalName">Goal</div>
            <div class="sub" id="goalSub">‚Äî</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="goalNums">0/0</div>
            <div class="bar"><i id="goalBar"></i></div>
          </div>
        </div>

        <div class="qItem" aria-label="Mini quest">
          <div class="qText">
            <div class="name" id="miniName">Mini</div>
            <div class="sub" id="miniSub">‚Äî</div>
          </div>
          <div class="qProg">
            <div class="qNums" id="miniNums">0/0</div>
            <div class="bar"><i id="miniBar"></i></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Coach bubble -->
    <section id="coachCard" aria-hidden="true" aria-label="Coach">
      <div class="inner">
        <div id="coachMsg">‚Äî</div>
        <div id="coachMeta">Coach</div>
      </div>
    </section>

    <!-- End overlay -->
    <section id="endOverlay" aria-hidden="true" aria-label="‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•">
      <div class="endPanel" role="dialog" aria-modal="true" aria-label="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡∏°">
        <div class="endTitle">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• PlateVR</h2>
          <div class="tag" id="endTag">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</div>
        </div>

        <div class="endGrid" aria-label="KPI">
          <div class="kpi"><div class="k">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div class="v" id="kScore">0</div></div>
          <div class="kpi"><div class="k">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</div><div class="v" id="kAcc">‚Äî</div></div>
          <div class="kpi"><div class="k">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="v" id="kCombo">0</div></div>

          <div class="kpi"><div class="k">Goal</div><div class="v" id="kGoals">0/0</div></div>
          <div class="kpi"><div class="k">Mini</div><div class="v" id="kMini">0/0</div></div>
          <div class="kpi"><div class="k">Miss ‡∏£‡∏ß‡∏°</div><div class="v" id="kMiss">0</div></div>

          <!-- optional extras -->
          <div class="kpi"><div class="k">Miss (Junk)</div><div class="v" id="kMissJunk">0</div></div>
          <div class="kpi"><div class="k">Miss (Timeout)</div><div class="v" id="kMissTimeout">0</div></div>
          <div class="kpi"><div class="k">Grade</div><div class="v" id="kGrade">‚Äî</div></div>
        </div>

        <!-- ========= Evaluate + Create (Grade 5) ========= -->
        <div style="padding: 6px 6px 10px;">
          <div style="font-weight:950;margin:6px 0 8px;">üß† Evaluate (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</div>
          <div id="evalBox" style="
            border:1px solid rgba(148,163,184,.14);
            background:rgba(10,16,40,.35);
            border-radius:18px;
            padding:10px 10px;
          ">
            <label style="display:flex;gap:10px;align-items:flex-start;padding:8px 8px;border-radius:14px;">
              <input type="radio" name="evalReason" value="‡∏°‡∏≤‡∏Å‡πÑ‡∏õ" />
              <div><div style="font-weight:900;">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ</div><div style="color:var(--muted);font-size:12px;">‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô ‚Üí ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î</div></div>
            </label>
            <label style="display:flex;gap:10px;align-items:flex-start;padding:8px 8px;border-radius:14px;">
              <input type="radio" name="evalReason" value="‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ" />
              <div><div style="font-weight:900;">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ</div><div style="color:var(--muted);font-size:12px;">‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</div></div>
            </label>
            <label style="display:flex;gap:10px;align-items:flex-start;padding:8px 8px;border-radius:14px;">
              <input type="radio" name="evalReason" value="‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£" />
              <div><div style="font-weight:900;">‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£</div><div style="color:var(--muted);font-size:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ/‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‚Äù</div></div>
            </label>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
              <button class="btn" id="btnEvalSave" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</button>
              <div id="evalSaved" style="color:var(--muted);font-size:12px;align-self:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            </div>
          </div>

          <div style="font-weight:950;margin:14px 0 8px;">‚ú® Create (‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>
          <div id="createBox" style="
            border:1px solid rgba(148,163,184,.14);
            background:rgba(10,16,40,.35);
            border-radius:18px;
            padding:10px 10px;
          ">
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" id="btnAddVeg" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ü•¶</button>
              <button class="btn" id="btnReduceRice" type="button">‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß üçö‚¨áÔ∏è</button>
              <button class="btn" id="btnSwapSnack" type="button">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ üç≠‚û°Ô∏èüçé</button>
              <button class="btn primary" id="btnApplyCreate" type="button">‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö + ‡∏£‡∏±‡∏ö Badge</button>
            </div>

            <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div style="border:1px solid rgba(148,163,184,.14);border-radius:16px;padding:10px;background:rgba(2,6,23,.45);">
                <div style="font-weight:900;margin-bottom:6px;">‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö</div>
                <div id="plateBefore" style="color:var(--muted);font-size:12px;line-height:1.45;">‚Äî</div>
              </div>
              <div style="border:1px solid rgba(148,163,184,.14);border-radius:16px;padding:10px;background:rgba(2,6,23,.45);">
                <div style="font-weight:900;margin-bottom:6px;">‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</div>
                <div id="plateAfter" style="color:var(--muted);font-size:12px;line-height:1.45;">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:10px;border:1px solid rgba(148,163,184,.14);border-radius:16px;padding:10px;background:rgba(2,6,23,.45);">
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                <div style="font-weight:900;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                <div id="instantScore" style="color:var(--cyan);font-weight:950;">‚Äî</div>
              </div>
              <div id="instantHint" style="margin-top:6px;color:var(--muted);font-size:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‚Äù</div>
            </div>

            <div id="createStatus" style="margin-top:8px;color:var(--muted);font-size:12px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö</div>
          </div>
        </div>

        <div class="endBtns">
          <button class="btn" id="btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="btn primary" id="btnRestart" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </section>
  </div>

  <!-- VR UI (ENTER VR/EXIT/RECENTER + crosshair + hha:shoot) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Boot -->
  <script type="module" src="./plate.boot.js"></script>

  <!-- Evaluate + Create logic + Silent Badge -->
  <script type="module">
    const WIN = window;
    const DOC = document;

    // ---------------------------
    // Silent badge storage
    // ---------------------------
    const BADGE_KEY = 'HHA_BADGES';
    function loadBadges(){
      try{ return JSON.parse(localStorage.getItem(BADGE_KEY) || '{}') || {}; }catch{ return {}; }
    }
    function saveBadges(obj){
      try{ localStorage.setItem(BADGE_KEY, JSON.stringify(obj)); }catch{}
    }
    WIN.addEventListener('hha:badge', (e)=>{
      const d = e.detail || {};
      const id = String(d.id || '').trim();
      if(!id) return;
      const store = loadBadges();
      if(!store[id]){
        store[id] = { earnedAt: Date.now(), reason: String(d.reason || '') };
        saveBadges(store);
      }
    });

    function emit(name, detail){
      try{ WIN.dispatchEvent(new CustomEvent(name, { detail })); }catch{}
    }

    // ---------------------------
    // End overlay hooks
    // ---------------------------
    const elBefore = DOC.getElementById('plateBefore');
    const elAfter  = DOC.getElementById('plateAfter');
    const elInst   = DOC.getElementById('instantScore');
    const elHint   = DOC.getElementById('instantHint');
    const elCreateStatus = DOC.getElementById('createStatus');

    const elEvalSaved = DOC.getElementById('evalSaved');
    const btnEvalSave = DOC.getElementById('btnEvalSave');

    const btnAddVeg = DOC.getElementById('btnAddVeg');
    const btnReduceRice = DOC.getElementById('btnReduceRice');
    const btnSwapSnack = DOC.getElementById('btnSwapSnack');
    const btnApplyCreate = DOC.getElementById('btnApplyCreate');

    // last summary snapshot
    let last = null;

    // create selection state
    let createPick = null; // 'addVeg'|'reduceRice'|'swapSnack'
    let sim = null;

    function fmtPlate(g){
      // mapping (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ): ‡∏´‡∏°‡∏π‡πà1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô, ‡∏´‡∏°‡∏π‡πà2 ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö, ‡∏´‡∏°‡∏π‡πà3 ‡∏ú‡∏±‡∏Å, ‡∏´‡∏°‡∏π‡πà4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ, ‡∏´‡∏°‡∏π‡πà5 ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô
      const p = (g.g1|0), c=(g.g2|0), v=(g.g3|0), f=(g.g4|0), fat=(g.g5|0);
      return [
        `‡∏´‡∏°‡∏π‡πà1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô: ${p}`,
        `‡∏´‡∏°‡∏π‡πà2 ‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á: ${c}`,
        `‡∏´‡∏°‡∏π‡πà3 ‡∏ú‡∏±‡∏Å: ${v}`,
        `‡∏´‡∏°‡∏π‡πà4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ: ${f}`,
        `‡∏´‡∏°‡∏π‡πà5 ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô: ${fat}`
      ].join('<br/>');
    }

    function cloneG(){
      return {
        g1: last?.g1|0, g2:last?.g2|0, g3:last?.g3|0, g4:last?.g4|0, g5:last?.g5|0
      };
    }

    function calcInstant(g){
      // simple ‚Äú‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‚Äù heuristic for kids:
      // - reward veggies/fruit/protein
      // - penalize carbs imbalance
      const p=g.g1|0, c=g.g2|0, v=g.g3|0, f=g.g4|0, fat=g.g5|0;
      let score = 50;
      score += Math.min(20, v*4);
      score += Math.min(15, f*3);
      score += Math.min(15, p*3);
      const balance = Math.abs(c - (v+p));
      score += Math.max(0, 15 - balance*2);
      score -= Math.max(0, (fat-3)*2);
      score = Math.max(0, Math.min(100, Math.round(score)));
      return score;
    }

    function updateSim(){
      if(!last) return;
      const g0 = cloneG();
      const g1 = cloneG();

      if(createPick === 'addVeg'){
        g1.g3 += 1;
      }else if(createPick === 'reduceRice'){
        g1.g2 = Math.max(0, g1.g2 - 1);
      }else if(createPick === 'swapSnack'){
        g1.g4 += 1;
      }

      sim = { before:g0, after:g1 };
      if(elBefore) elBefore.innerHTML = fmtPlate(sim.before);
      if(elAfter)  elAfter.innerHTML  = fmtPlate(sim.after);

      const s0 = calcInstant(sim.before);
      const s1 = calcInstant(sim.after);

      if(elInst) elInst.textContent = `${s0} ‚Üí ${s1} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û`;
      if(elHint){
        if(!createPick) elHint.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‚Äù';
        else{
          const label = createPick==='addVeg' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å' : (createPick==='reduceRice' ? '‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ');
          elHint.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${label} ‚úÖ ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!`;
        }
      }
      if(elCreateStatus){
        elCreateStatus.textContent = createPick
          ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${createPick==='addVeg'?'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ü•¶':createPick==='reduceRice'?'‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏ß üçö‚¨áÔ∏è':'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ üç≠‚û°Ô∏èüçé'}`
          : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö';
      }
    }

    function setCreatePick(p){
      createPick = p;
      [btnAddVeg, btnReduceRice, btnSwapSnack].forEach(b=>b && b.classList.remove('primary'));
      if(p==='addVeg' && btnAddVeg) btnAddVeg.classList.add('primary');
      if(p==='reduceRice' && btnReduceRice) btnReduceRice.classList.add('primary');
      if(p==='swapSnack' && btnSwapSnack) btnSwapSnack.classList.add('primary');
      updateSim();
    }

    btnAddVeg?.addEventListener('click', ()=>setCreatePick('addVeg'));
    btnReduceRice?.addEventListener('click', ()=>setCreatePick('reduceRice'));
    btnSwapSnack?.addEventListener('click', ()=>setCreatePick('swapSnack'));

    btnApplyCreate?.addEventListener('click', ()=>{
      if(!last){
        elCreateStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Å‡∏°';
        return;
      }
      if(!createPick){
        elCreateStatus.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞';
        return;
      }

      emit('plate:create', {
        pick: createPick,
        before: sim?.before || null,
        after: sim?.after || null,
        time: Date.now()
      });

      // silent badge ‚Äî store only, no popup
      const badgeId =
        createPick==='addVeg' ? 'plate_create_addveg' :
        createPick==='reduceRice' ? 'plate_create_reducerice' :
        'plate_create_swapfruit';

      emit('hha:badge', { id: badgeId, reason: '‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (Create)' });

      elCreateStatus.textContent = '‡∏£‡∏±‡∏ö Badge ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ)';
    });

    btnEvalSave?.addEventListener('click', ()=>{
      const picked = DOC.querySelector('input[name="evalReason"]:checked')?.value || '';
      if(!picked){
        elEvalSaved.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        return;
      }
      elEvalSaved.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${picked}`;

      emit('plate:evaluate', { reason: picked, time: Date.now() });

      // optional silent badge for evaluate
      emit('hha:badge', { id:'plate_eval_done', reason:'‡∏ó‡∏≥ Evaluate ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô' });
    });

    WIN.addEventListener('hha:end', (e)=>{
      last = e.detail || {};
      createPick = null;
      sim = null;
      [btnAddVeg, btnReduceRice, btnSwapSnack].forEach(b=>b && b.classList.remove('primary'));
      if(elEvalSaved) elEvalSaved.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
      updateSim();
    });
  </script>
</body>
</html>