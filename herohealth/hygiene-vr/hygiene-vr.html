<!-- === /herohealth/hygiene-vr/hygiene-vr.html ===
HygieneVR RUN ‚Äî PRODUCTION (HHA Standard)
PATCH v20260210f
‚úÖ Views: pc/mobile/vr/cvr (body class)
‚úÖ Uses: ../vr/vr-ui.js (Enter VR/Exit/Recenter + crosshair + hha:shoot)
‚úÖ FX: ../vr/particles.js
‚úÖ Engine: hygiene.safe.js (export boot)
‚úÖ Quiz: ./hygiene-quiz-bank.js (window.HHA_HYGIENE_QUIZ_BANK)
‚úÖ Anti-stall: stall overlay + watchdog (reads window.__HHA_HEARTBEAT__)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî HygieneVR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./hygiene-vr.css?v=20260210f" />

  <!-- Universal VR UI (MUST defer) -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- FX -->
  <script src="../vr/particles.js" defer></script>

  <!-- AI packs (optional) -->
  <script src="../vr/hha-ai-coach.js" defer></script>
  <script src="../vr/hha-difficulty-director.js" defer></script>
  <script src="../vr/hha-badges.js" defer></script>

  <!-- Quiz bank (‚úÖ correct name) -->
  <script src="./hygiene-quiz-bank.js" defer></script>

  <!-- Boot (module) -->
  <script type="module" src="./hygiene-vr.boot.js?v=20260210f"></script>
</head>

<body class="view-pc">
  <div id="gameRoot" class="hw-root">
    <div class="hw-stage" id="stage" aria-label="HygieneVR stage"></div>

    <!-- HUD -->
    <div class="hw-hud">
      <div class="hw-top">
        <div class="hw-title">üßº Handwash Survival</div>
        <div class="hw-sub" id="hudSub">ready‚Ä¶</div>

        <div class="hw-row">
          <div class="hw-pill" id="pillStep">STEP 1/7 ü´ß ‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠</div>
          <div class="hw-pill" id="pillHits">HITS 0/6</div>
          <div class="hw-pill" id="pillCombo">COMBO 0</div>
          <div class="hw-pill bad" id="pillMiss">MISS 0 / 3</div>
        </div>

        <div class="hw-row">
          <div class="hw-pill warn" id="pillRisk">RISK Incomplete 0% ‚Ä¢ Unsafe 0%</div>
          <div class="hw-pill" id="pillTime">TIME 70</div>
          <div class="hw-pill cyan" id="pillQuest">QUEST ‚Äî</div>
          <button class="hw-pill btn" id="btnPause" type="button">‚è∏ Pause</button>
          <button class="hw-pill btn" id="btnBack" type="button">‚Ü© HUB</button>
        </div>

        <!-- Quiz box -->
        <div class="hw-quiz" id="quizBox" style="display:none">
          <div class="hw-quiz-q" id="quizQ">QUIZ</div>
          <div class="hw-quiz-sub" id="quizSub">‚Äî</div>
        </div>
      </div>

      <div class="hw-banner" id="banner" aria-live="polite"></div>
    </div>

    <!-- Start Overlay -->
    <div class="hw-overlay" id="startOverlay">
      <div class="hw-card">
        <div class="hw-card-title">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠ üßº</div>
        <div class="hw-card-sub">
          ‡πÇ‡∏´‡∏°‡∏î <b>Survival</b> ‚Äî ‡∏ó‡∏≥‡∏ï‡∏≤‡∏° <b>7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</b> ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚Ä¢ ‡∏´‡∏•‡∏ö‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ü¶† ‚Ä¢ ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î<br>
          <b>‡∏Ñ‡∏≥‡∏ó‡πà‡∏≠‡∏á:</b> ‚Äú‡∏ù‡πà‡∏≤-‡∏´‡∏•‡∏±‡∏á-‡∏ã‡∏≠‡∏Å-‡∏Ç‡πâ‡∏≠-‡πÇ‡∏õ‡πâ‡∏á-‡πÄ‡∏•‡πá‡∏ö-‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‚Äù<br>
          ‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á ‚Äú‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>
        <div class="hw-card-row">
          <button class="hw-cta" id="btnStart" type="button">‚ñ∂ Start</button>
          <button class="hw-ghost" id="btnRestart" type="button">‚Üª Reset</button>
        </div>
        <div class="hw-card-sub" style="margin-top:10px">
          Mode: <span id="labMode">play</span> ‚Ä¢ Diff: <span id="labDiff">normal</span> ‚Ä¢ View: <span id="labView">pc</span>
        </div>

        <div class="hw-card-sub" style="margin-top:10px;color:rgba(148,163,184,.9)">
          ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô ‡πÜ ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á: ‡∏Å‡∏î <b>Reload</b> (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏á/‡πÄ‡∏°‡∏°‡πÄ‡∏ï‡πá‡∏°/JS error) ‡πÅ‡∏•‡∏∞‡∏î‡∏π Console/Network
        </div>
      </div>
    </div>

    <!-- End Overlay -->
    <div class="hw-overlay" id="endOverlay" style="display:none">
      <div class="hw-card">
        <div class="hw-card-title" id="endTitle">‡∏à‡∏ö‡πÄ‡∏Å‡∏° ‚úÖ</div>
        <div class="hw-card-sub" id="endSub">‚Äî</div>
        <pre class="hw-pre" id="endJson"></pre>
        <div class="hw-card-row">
          <button class="hw-cta" id="btnPlayAgain" type="button">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button class="hw-ghost" id="btnCopyJson" type="button">üìã Copy Summary</button>
          <button class="hw-ghost" id="btnBack2" type="button">‚Ü© ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        </div>
      </div>
    </div>

    <!-- Stall overlay (anti-freeze UX) -->
    <div class="hw-overlay" id="stallOverlay" style="display:none">
      <div class="hw-card">
        <div class="hw-card-title">‡πÄ‡∏Å‡∏°‡∏Ñ‡πâ‡∏≤‡∏á/‡∏™‡∏∞‡∏î‡∏∏‡∏î ‚ö†Ô∏è</div>
        <div class="hw-card-sub" id="stallSub">
          ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î Reload ‡πÄ‡∏Å‡∏° (‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å memory/JS error/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏á)
        </div>
        <div class="hw-card-row">
          <button class="hw-cta" id="btnReload" type="button">‚ü≥ Reload</button>
          <button class="hw-ghost" id="btnDismissStall" type="button">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div class="hw-card-sub" style="margin-top:10px">
          ‡πÄ‡∏õ‡∏¥‡∏î Console ‡∏î‡∏π error ‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à Network ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå 404 ‡πÑ‡∏´‡∏°
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const qs = (k,d=null)=>{ try{return new URL(location.href).searchParams.get(k) ?? d;}catch{return d;} };

  function setViewClass(){
    const view = (qs('view','pc')||'pc').toLowerCase();
    document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
    document.body.classList.add(
      view==='mobile'?'view-mobile':
      (view==='vr'?'view-vr':
      (view==='cvr'?'view-cvr':'view-pc'))
    );
    const el = document.getElementById('labView');
    if(el) el.textContent = view;
  }

  setViewClass();
  const lm = document.getElementById('labMode'); if(lm) lm.textContent = (qs('run','play')||'play');
  const ld = document.getElementById('labDiff'); if(ld) ld.textContent = (qs('diff','normal')||'normal');

  // Anti-stall UX helper API for boot/engine (optional)
  const stallOverlay = document.getElementById('stallOverlay');
  const stallSub = document.getElementById('stallSub');
  const btnReload = document.getElementById('btnReload');
  const btnDismiss = document.getElementById('btnDismissStall');

  function showStall(msg){
    if(stallSub && msg) stallSub.textContent = String(msg);
    if(stallOverlay) stallOverlay.style.display = 'grid';
  }
  function hideStall(){
    if(stallOverlay) stallOverlay.style.display = 'none';
  }

  btnReload && btnReload.addEventListener('click', ()=> location.reload());
  btnDismiss && btnDismiss.addEventListener('click', hideStall);

  // Expose to window for boot if needed
  window.HHA_STALL = { show: showStall, hide: hideStall };

  // Watchdog: if heartbeat stops => show stall overlay
  // hygiene.safe.js updates window.__HHA_HEARTBEAT__
  let lastOk = Date.now();
  let shown = false;

  function watchdog(){
    const hb = Number(window.__HHA_HEARTBEAT__ || 0);
    const now = Date.now();

    if(hb > 0){
      // convert perf-now-ish to monotonic "recent"
      // we only care that it changes frequently; if it changes, mark ok
      if(!watchdog._prevHb || hb !== watchdog._prevHb){
        watchdog._prevHb = hb;
        lastOk = now;
        if(shown){
          shown = false;
          hideStall();
        }
      }
    }

    // after start overlay hidden, expect heartbeat; but we keep it simple:
    if((now - lastOk) > 4500 && !shown){
      shown = true;
      showStall('‡πÄ‡∏Å‡∏°‡∏Ñ‡πâ‡∏≤‡∏á/‡∏™‡∏∞‡∏î‡∏∏‡∏î ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î Reload ‡πÄ‡∏Å‡∏° (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏á/‡πÄ‡∏°‡∏°‡πÄ‡∏ï‡πá‡∏°/JS error)');
    }
  }
  setInterval(watchdog, 700);
})();
</script>
</body>
</html>