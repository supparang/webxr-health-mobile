<!-- === /herohealth/warmup-gate.html ===
HeroHealth Warmup/Cooldown Gate ‚Äî PRODUCTION (daily done keys + next routing)
FULL v20260224-GATE-DAILYDONE
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Ä¢ Warmup/Cooldown Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg0:#050814;
      --bg1:#0b1220;
      --card: rgba(2,6,23,.72);
      --card2: rgba(2,6,23,.55);
      --bd: rgba(148,163,184,.18);
      --txt: rgba(229,231,235,.96);
      --mut: rgba(148,163,184,.95);
      --vio: rgba(99,102,241,.95);
      --good: rgba(34,197,94,.95);
      --warn: rgba(251,191,36,.96);
      --bad: rgba(244,63,94,.92);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    html,body{ height:100%; margin:0; background: radial-gradient(1100px 700px at 50% 12%, rgba(99,102,241,.18), rgba(0,0,0,0) 60%), linear-gradient(180deg,var(--bg0),var(--bg1)); color:var(--txt); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ overflow:hidden; }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--sat) + 14px) calc(var(--sar) + 14px) calc(var(--sab) + 14px) calc(var(--sal) + 14px);
    }
    .card{
      width:min(860px, 96vw);
      border-radius: 18px;
      border:1px solid var(--bd);
      background: var(--card);
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 16px;
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size: 18px;
      margin:0;
    }
    .sub{
      margin-top:6px;
      color:var(--mut);
      font-size: 12px;
      word-break: break-all;
      line-height:1.35;
    }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.42);
      font-weight:900;
      font-size:12px;
      color:var(--txt);
    }
    .pill b{ opacity:.9; }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:stretch;
    }
    .panel{
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.14);
      background: var(--card2);
      padding: 12px;
    }

    .timerBox{
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      min-height: 220px;
    }
    .bigTime{
      font-size: 72px;
      font-weight:1100;
      letter-spacing:.5px;
      line-height:1;
      text-shadow: 0 18px 70px rgba(0,0,0,.45);
    }
    .hint{
      font-size: 13px;
      color: var(--mut);
      text-align:center;
      line-height:1.45;
      max-width: 520px;
    }
    .task{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.45);
      font-weight:900;
      line-height:1.35;
    }
    .task .k{ font-size:12px; color:var(--mut); font-weight:900; }
    .task .v{ margin-top:6px; font-size:15px; color:var(--txt); }

    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn.primary{
      border-color: rgba(99,102,241,.35);
      background: rgba(99,102,241,.22);
    }
    .btn.good{
      border-color: rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
    }
    .btn.danger{
      border-color: rgba(244,63,94,.30);
      background: rgba(244,63,94,.16);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:none;
    }

    .bar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.45);
      overflow:hidden;
    }
    #barFill{
      height:100%;
      width:0%;
      background: rgba(99,102,241,.92);
      transition: width 120ms linear;
    }

    .stamp{
      margin-top:10px;
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, monospace;
      color: rgba(229,231,235,.92);
      opacity:.9;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.42);
      word-break: break-all;
    }
    .stamp small{ color: var(--mut); display:block; margin-bottom:6px; }

    .bannerDone{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(34,197,94,.24);
      background: rgba(34,197,94,.10);
      font-weight: 1000;
      color: rgba(229,231,235,.96);
    }
    .bannerDone.show{ display:block; }

    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .bigTime{ font-size: 62px; }
      .timerBox{ min-height: 200px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1 class="title" id="title">Gate</h1>
          <div class="sub" id="sub">‚Äî</div>
          <div class="pillRow">
            <span class="pill">üß≠ <b>phase</b> <span id="pillPhase">‚Äî</span></span>
            <span class="pill">üè∑Ô∏è <b>cat</b> <span id="pillCat">‚Äî</span></span>
            <span class="pill">üë§ <b>pid</b> <span id="pillPid">‚Äî</span></span>
            <span class="pill">‚è± <b>dur</b> <span id="pillDur">‚Äî</span>s</span>
            <span class="pill">üìÖ <b>day</b> <span id="pillDay">‚Äî</span></span>
          </div>
        </div>
        <div style="text-align:right; min-width: 180px;">
          <div style="font-weight:1000; opacity:.95" id="modeTag">HEROHEALTH</div>
          <div style="margin-top:6px; font-size:12px; color:var(--mut)" id="themeTag">theme=‚Äî</div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div style="font-weight:1000; margin-bottom:8px;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div class="task">
            <div class="k">TASK</div>
            <div class="v" id="taskText">‚Äî</div>
          </div>
          <div class="task" id="breathBox">
            <div class="k">GUIDE</div>
            <div class="v" id="guideText">‚Äî</div>
          </div>

          <div class="bar" aria-hidden="false">
            <div id="barFill"></div>
          </div>

          <div class="bannerDone" id="doneBanner">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>

          <div class="stamp" id="debugBox" style="display:none;">
            <small>debug</small>
            <div id="debugText">‚Äî</div>
          </div>
        </div>

        <div class="panel">
          <div class="timerBox">
            <div style="font-weight:1000; opacity:.9" id="timerLabel">READY</div>
            <div class="bigTime" id="timeText">‚Äî</div>
            <div class="hint" id="hintText">‡∏Å‡∏î Start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</div>

            <div class="actions">
              <button class="btn primary" id="btnStart">Start</button>
              <button class="btn" id="btnSkip">Skip</button>
              <button class="btn danger" id="btnBackHub">Back HUB</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  'use strict';
  const qs = (k, d='')=>{ try{ return (new URL(location.href)).searchParams.get(k) ?? d; }catch(e){ return d; } };
  const clamp = (v,a,b)=>{ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b,v)); };

  const $ = (id)=> document.getElementById(id);

  // ---- params ----
  const gatePhase = String(qs('gatePhase', qs('phase','warmup')) || 'warmup').toLowerCase();
  const cat = String(qs('cat','nutrition') || 'nutrition').toLowerCase();
  const pid = String(qs('pid','anon') || 'anon').trim() || 'anon';
  const theme = String(qs('theme', gatePhase==='cooldown' ? 'calm' : 'active') || '').toLowerCase();

  // dur priority: dur, else wdur/cdur, else default
  let dur = Number(qs('dur',''));
  if(!Number.isFinite(dur) || dur<=0){
    dur = gatePhase==='cooldown' ? Number(qs('cdur','15')) : Number(qs('wdur','10'));
  }
  dur = clamp(dur, 5, 60);

  const hub = String(qs('hub','')||'').trim();
  const next = String(qs('next','')||'').trim();
  const dbg = String(qs('dbg','0')||'0') === '1';

  function abs(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch(e){ return url; }
  }

  // ---- daily key ----
  function localDayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  const dayKey = localDayKey();

  function dailyKeyFor(phase, cat, pid){
    const c = String(cat||'nutrition').toLowerCase() || 'nutrition';
    const p = String(pid||'anon').trim() || 'anon';
    const d = dayKey;
    if(phase==='cooldown') return `HHA_COOLDOWN_DONE:${c}:${p}:${d}`;
    return `HHA_WARMUP_DONE:${c}:${p}:${d}`;
  }
  const doneKey = dailyKeyFor(gatePhase, cat, pid);

  function isDoneToday(){
    try{ return localStorage.getItem(doneKey) === '1'; }catch(e){ return false; }
  }
  function markDone(){
    try{ localStorage.setItem(doneKey, '1'); }catch(e){}
  }

  // ---- content (deterministic tasks) ----
  function xmur3(str){
    str = String(str||'');
    let h = 1779033703 ^ str.length;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    return function(){
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      return (h ^= (h >>> 16)) >>> 0;
    };
  }
  function sfc32(a,b,c,d){
    return function(){
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
      let t = (a + b) | 0;
      a = b ^ (b >>> 9);
      b = (c + (c << 3)) | 0;
      c = (c << 21) | (c >>> 11);
      d = (d + 1) | 0;
      t = (t + d) | 0;
      c = (c + t) | 0;
      return (t >>> 0) / 4294967296;
    };
  }
  function makeRng(seedStr){
    const seed = xmur3(seedStr);
    return sfc32(seed(), seed(), seed(), seed());
  }
  const seedStr = `HHA_GATE|${gatePhase}|${cat}|${pid}|${dayKey}`;
  const rng = makeRng(seedStr);
  const r01 = ()=> rng();
  const pick = (arr)=> arr[(r01()*arr.length)|0];

  const WARM_TASKS = [
    '‡∏¢‡∏∑‡∏î‡∏Ñ‡∏≠-‡πÑ‡∏´‡∏•‡πà 3 ‡∏ó‡πà‡∏≤ (‡∏Ç‡∏ß‡∏≤/‡∏ã‡πâ‡∏≤‡∏¢/‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏´‡∏•‡πà) ‡∏ä‡πâ‡∏≤ ‡πÜ',
    '‡∏Ç‡∏¢‡∏±‡∏ö‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á + ‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠ 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
    '‡∏¢‡∏∑‡∏î‡∏´‡∏•‡∏±‡∏á: ‡∏Å‡πâ‡∏°‡πÅ‡∏ï‡∏∞‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏ö‡∏≤ ‡πÜ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ x2',
    '‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏°‡∏∑‡∏≠: ‡πÅ‡∏ö‡∏°‡∏∑‡∏≠/‡∏Å‡∏≥‡∏°‡∏∑‡∏≠ 25 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á + ‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
    '‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏™‡∏≤‡∏¢‡∏ï‡∏≤: ‡∏°‡∏≠‡∏á‡πÑ‡∏Å‡∏• 5 ‡∏ß‡∏¥ ‚Üí ‡πÉ‡∏Å‡∏•‡πâ 5 ‡∏ß‡∏¥ ‡∏ó‡∏≥ 6 ‡∏£‡∏≠‡∏ö'
  ];
  const COOL_TASKS = [
    '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πâ‡∏≤ ‡πÜ 4-2-6 (‡πÄ‡∏Ç‡πâ‡∏≤-‡∏Ñ‡πâ‡∏≤‡∏á-‡∏≠‡∏≠‡∏Å) ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á',
    '‡∏¢‡∏∑‡∏î‡πÅ‡∏Ç‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ç‡πâ‡∏≤‡∏á x2',
    '‡∏Ñ‡∏•‡∏≤‡∏¢‡πÑ‡∏´‡∏•‡πà: ‡∏¢‡∏Å‡πÑ‡∏´‡∏•‡πà‡∏Ñ‡πâ‡∏≤‡∏á 2 ‡∏ß‡∏¥ ‚Üí ‡∏õ‡∏•‡πà‡∏≠‡∏¢ ‡∏ó‡∏≥ 8 ‡∏£‡∏≠‡∏ö',
    '‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏ï‡∏≤: ‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡πÄ‡∏ö‡∏≤ ‡πÜ 10 ‡∏ß‡∏¥ ‚Üí ‡∏°‡∏≠‡∏á‡πÑ‡∏Å‡∏• 10 ‡∏ß‡∏¥',
    '‡∏¢‡∏∑‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠/‡∏ô‡∏¥‡πâ‡∏ß 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ç‡πâ‡∏≤‡∏á + ‡∏™‡∏∞‡∏ö‡∏±‡∏î‡∏°‡∏∑‡∏≠‡πÄ‡∏ö‡∏≤ ‡πÜ'
  ];

  const task = (gatePhase==='cooldown') ? pick(COOL_TASKS) : pick(WARM_TASKS);

  // ---- UI wiring ----
  const title = $('title');
  const sub = $('sub');
  const pillPhase = $('pillPhase');
  const pillCat = $('pillCat');
  const pillPid = $('pillPid');
  const pillDur = $('pillDur');
  const pillDay = $('pillDay');
  const themeTag = $('themeTag');
  const modeTag = $('modeTag');

  const taskText = $('taskText');
  const guideText = $('guideText');
  const breathBox = $('breathBox');

  const timerLabel = $('timerLabel');
  const timeText = $('timeText');
  const hintText = $('hintText');
  const barFill = $('barFill');
  const btnStart = $('btnStart');
  const btnSkip = $('btnSkip');
  const btnBackHub = $('btnBackHub');
  const doneBanner = $('doneBanner');

  const debugBox = $('debugBox');
  const debugText = $('debugText');

  const isCooldown = gatePhase==='cooldown';

  title.textContent = isCooldown ? 'Cooldown ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö HUB' : 'Warmup ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°';
  pillPhase.textContent = gatePhase;
  pillCat.textContent = cat;
  pillPid.textContent = pid;
  pillDur.textContent = String(dur);
  pillDay.textContent = dayKey;
  themeTag.textContent = `theme=${theme}`;
  modeTag.textContent = isCooldown ? 'COOLDOWN' : 'WARMUP';

  taskText.textContent = task;

  function setGuideByTheme(){
    if(isCooldown){
      guideText.textContent = '‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Ñ‡∏•‡∏≤‡∏¢‡πÑ‡∏´‡∏•‡πà ‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö ‚Äî ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥';
    }else{
      guideText.textContent = '‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏±‡∏ß ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô/‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
    }
    if(theme==='calm'){
      guideText.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏á‡∏ö: ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πâ‡∏≤ ‡πÜ + ‡∏Ñ‡∏•‡∏≤‡∏¢‡πÑ‡∏´‡∏•‡πà + ‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤';
    }
    if(theme==='active'){
      guideText.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏±‡∏ß: ‡∏Ç‡∏¢‡∏±‡∏ö‡πÅ‡∏Ç‡∏ô/‡πÑ‡∏´‡∏•‡πà + ‡∏¢‡∏∑‡∏î‡∏´‡∏•‡∏±‡∏á + ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏™‡∏≤‡∏¢‡∏ï‡∏≤';
    }
  }
  setGuideByTheme();

  if(dbg){
    debugBox.style.display = 'block';
    debugText.textContent =
      `seed=${seedStr}\n`+
      `doneKey=${doneKey}\n`+
      `next=${abs(next)||'(none)'}\n`+
      `hub=${abs(hub)||'(none)'}\n`;
  }

  // ---- routing ----
  function fallbackHub(){
    if(hub) return abs(hub);
    try{ return new URL('./hub.html', location.href).toString(); }catch(e){ return './hub.html'; }
  }
  function nextUrl(){
    if(next) return abs(next);
    if(hub) return abs(hub);
    return fallbackHub();
  }

  // prevent loop spam (per tab)
  const LOOP_KEY = `HHA_GATE_LOOP:${gatePhase}:${cat}:${pid}:${dayKey}`;
  function loopCount(){
    try{ return Number(sessionStorage.getItem(LOOP_KEY)||'0')||0; }catch(e){ return 0; }
  }
  function bumpLoop(){
    try{ sessionStorage.setItem(LOOP_KEY, String(loopCount()+1)); }catch(e){}
  }

  // if already done today ‚Üí show banner + enable ‚Äúgo next‚Äù immediately
  const alreadyDone = isDoneToday();
  if(alreadyDone){
    doneBanner.classList.add('show');
    timerLabel.textContent = 'DONE TODAY';
    timeText.textContent = '0';
    hintText.textContent = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏Å‡∏î Start (‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
    btnStart.textContent = 'Go Next';
    btnStart.classList.add('good');
  }

  btnBackHub.addEventListener('click', ()=> location.href = fallbackHub());

  btnSkip.addEventListener('click', ()=>{
    // skip does NOT mark done
    location.href = nextUrl();
  });

  // ---- timer flow ----
  let running = false;
  let tLeft = dur;
  let t0 = 0;

  function updateUI(){
    timeText.textContent = String(Math.max(0, Math.ceil(tLeft)));
    const p = (dur>0) ? (1 - (tLeft/dur)) : 1;
    barFill.style.width = `${Math.max(0, Math.min(100, p*100))}%`;
  }
  updateUI();

  function finishAndGo(){
    markDone();
    doneBanner.classList.add('show');
    timerLabel.textContent = 'SAVED ‚úÖ';
    hintText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≠...';
    setTimeout(()=> location.href = nextUrl(), 450);
  }

  function tick(now){
    if(!running) return;
    const dt = (now - t0)/1000;
    t0 = now;
    tLeft = Math.max(0, tLeft - dt);
    updateUI();
    if(tLeft <= 0){
      running = false;
      finishAndGo();
      return;
    }
    requestAnimationFrame(tick);
  }

  btnStart.addEventListener('click', ()=>{
    // if already done today -> just go next
    if(isDoneToday()){
      location.href = nextUrl();
      return;
    }

    // anti-loop: if bounced too many times in this tab, allow pass-through
    bumpLoop();
    if(loopCount() >= 6){
      // fail-safe: avoid trapping the user
      location.href = nextUrl();
      return;
    }

    if(running) return;
    running = true;
    btnStart.disabled = true;
    btnSkip.disabled = true;
    btnBackHub.disabled = true;

    timerLabel.textContent = isCooldown ? 'COOLDOWN' : 'WARMUP';
    hintText.textContent = '‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
    tLeft = dur;
    updateUI();

    t0 = performance.now();
    requestAnimationFrame(tick);
  });

  // paint initial time
  timeText.textContent = alreadyDone ? '0' : String(dur);

})();
</script>
</body>
</html>