<!-- === /herohealth/warmup-gate.html ===
HeroHealth ‚Äî Warmup/Cooldown Gate (FULL one-file) ‚Äî PRODUCTION
‚úÖ phase=warmup|cooldown
‚úÖ dur/cdur (5..60)
‚úÖ autonext=1 uses location.replace() (no back-loop)
‚úÖ Warmup finish -> go next (NO mark done)
‚úÖ Cooldown finish -> mark DONE today (zone daily, + pid/device binding)
‚úÖ Writes BOTH keys:
   - HHA_ZONE_DONE::<zone>::YYYY-MM-DD
   - HHA_ZONE_DONE::<zone>::YYYY-MM-DD::<pidOrDevice>
‚úÖ Fallback: bad next/hub -> ./hub.html
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî Warmup/Cooldown Gate</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="./favicon.ico"/>
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel: rgba(2,6,23,.72);
      --panel2: rgba(15,23,42,.72);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --warn:#f59e0b; --cyan:#22d3ee; --violet:#a78bfa; --bad:#ef4444;

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);

      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1100px 640px at 15% 18%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(900px 520px at 86% 22%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(820px 480px at 60% 92%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      overflow:auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wrap{ width:min(980px, 100%); display:flex; flex-direction:column; gap:12px; }
    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding: 12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .title{
      margin:0;
      font-size: clamp(20px, 2.0vw, 28px);
      letter-spacing:.2px;
      font-weight:1000;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.45;
    }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
    }
    .pill b{ color:var(--text); font-weight:900; }
    .body{
      padding: 14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
    }
    @media (max-width: 900px){ .body{ grid-template-columns: 1fr; } }
    .card{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      min-height: 180px;
    }
    .card h3{ margin:0 0 8px 0; font-size:16px; letter-spacing:.2px; font-weight:1000; }
    .card p{ margin:0; color:var(--muted); font-size:13px; line-height:1.5; }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      font-weight:1000;
      margin-top: 10px;
      width: fit-content;
    }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 18px rgba(245,158,11,.35);
    }
    .badge.cool .dot{ background: var(--cyan); box-shadow: 0 0 18px rgba(34,211,238,.35); }
    .badge.warm .dot{ background: var(--violet); box-shadow: 0 0 18px rgba(167,139,250,.35); }

    .timer{
      font-size: 46px;
      font-weight: 1100;
      letter-spacing: .5px;
      margin-top: 12px;
      line-height:1;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      margin-top: 12px;
    }
    .fill{
      height:100%;
      width: 0%;
      background: rgba(34,197,94,.85);
      transition: width .08s linear;
    }
    .fill.warm{ background: rgba(167,139,250,.85); }
    .fill.cool{ background: rgba(34,211,238,.85); }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.46);
      padding: 12px 12px;
      border-radius: 16px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
      font-weight:1000;
      font-size: 13px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.10); }
    .btn.ghost{ color: var(--muted); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .note{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.30);
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--sab));
      transform: translateX(-50%);
      background: rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 9999;
      max-width: 92vw;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
<div class="wrap">
  <section class="panel" aria-label="Warmup/Cooldown Gate">
    <div class="head">
      <div>
        <h1 class="title" id="hTitle">‚Äî</h1>
        <p class="sub" id="hSub">‚Äî</p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <div class="body">
      <div class="card">
        <h3 id="cardTitle">‚è±Ô∏è Gate</h3>
        <p id="cardDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶</p>

        <div class="badge warm" id="badgeMode"><span class="dot"></span><span id="badgeText">‚Äî</span></div>

        <div class="timer"><span id="tLeft">‚Äî</span><span class="mono" style="font-size:18px; font-weight:900; color:var(--muted);">s</span></div>
        <div class="bar"><div class="fill warm" id="fill"></div></div>

        <div class="btnrow">
          <button class="btn good" id="btnStart">‚ñ∂Ô∏è Start</button>
          <button class="btn warn" id="btnSkip">‚è≠Ô∏è Skip ‚Üí Next</button>
          <button class="btn ghost" id="btnHub">üè† Hub</button>
        </div>

        <div class="note" id="routeNote"></div>
      </div>

      <div class="card">
        <h3>üìå DONE today (‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ)</h3>
        <p>Warmup ‡πÑ‡∏°‡πà mark done ‚Ä¢ Cooldown ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ mark DONE (‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÇ‡∏ã‡∏ô)</p>

        <div class="note">
          <div><b>Zone:</b> <span class="mono" id="zName">‚Äî</span></div>
          <div style="margin-top:6px;"><b>Today:</b> <span class="mono" id="todayText">‚Äî</span></div>
          <div style="margin-top:6px;"><b>pid/device:</b> <span class="mono" id="idText">‚Äî</span></div>
          <div style="margin-top:6px;"><b>DONE key (zone):</b><br/>
            <span class="mono" id="doneKeyZoneText">‚Äî</span>
          </div>
          <div style="margin-top:6px;"><b>DONE key (zone+id):</b><br/>
            <span class="mono" id="doneKeyIdText">‚Äî</span>
          </div>
          <div style="margin-top:6px;"><b>DONE today?</b> <span class="mono" id="doneVal">‚Äî</span></div>
        </div>

        <div class="note">
          <b>Params</b><br/>
          phase=<span class="mono">warmup|cooldown</span> ‚Ä¢ dur/cdur=<span class="mono">5..60</span> ‚Ä¢ autonext=<span class="mono">0|1</span><br/>
          next=<span class="mono">URL</span> ‚Ä¢ hub=<span class="mono">URL</span> (fallback ./hub.html)
        </div>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  'use strict';

  // -----------------------------
  // QS helpers
  // -----------------------------
  function pageUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(pageUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  const QS = parseQS();
  const q = (k, def='') => { const v = QS.get(k); return (v==null ? def : v); };

  function clampInt(v, min, max, def){
    const n = Number(v);
    if(!Number.isFinite(n)) return def;
    const x = Math.floor(n);
    return Math.max(min, Math.min(max, x));
  }

  function ymdLocal(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  // -----------------------------
  // config
  // -----------------------------
  const ZONE = (q('zone','nutrition') || 'nutrition').toLowerCase();
  const PHASE = (q('phase','warmup') || 'warmup').toLowerCase(); // warmup | cooldown
  const DUR = clampInt(PHASE === 'cooldown' ? q('cdur','20') : q('dur','20'), 5, 60, 20);
  const AUTONEXT = String(q('autonext','0')||'0') === '1';

  // next/hub (safe fallback)
  const HUB_FALLBACK = './hub.html';
  const hubRaw = (q('hub','')||'').trim();
  const nextRaw = (q('next','')||'').trim();

  // deny passthrough keys from gate
  const DENY = new Set(['next','hub','phase','dur','cdur','autonext','wmode','games']);

  // -----------------------------
  // pid/device binding
  // -----------------------------
  function safeIdFromPidOrDevice(){
    const pid = (q('pid','')||'').trim();
    if(pid) return pid;

    const K = 'HHA_DEVICE_ID_V1';
    try{
      let v = localStorage.getItem(K);
      if(v && v.length >= 10) return v;
      v = 'dev_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
      localStorage.setItem(K, v);
      return v;
    }catch(_){
      return 'dev_' + Math.random().toString(16).slice(2);
    }
  }
  const ID = safeIdFromPidOrDevice();

  // Keys: both zone-only and zone+id (so hub/launcher can choose)
  function doneKeyZone(zone){
    return `HHA_ZONE_DONE::${zone}::${ymdLocal()}`;
  }
  function doneKeyId(zone){
    return `HHA_ZONE_DONE::${zone}::${ymdLocal()}::${ID}`;
  }
  function isDoneToday(zone){
    try{
      return localStorage.getItem(doneKeyZone(zone)) === '1'
          || localStorage.getItem(doneKeyId(zone)) === '1';
    }catch(_){ return false; }
  }
  function setDoneToday(zone){
    try{
      localStorage.setItem(doneKeyZone(zone), '1');
      localStorage.setItem(doneKeyId(zone), '1');
    }catch(_){}
  }

  // -----------------------------
  // toast
  // -----------------------------
  const toastEl = document.getElementById('toast');
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1400);
  }

  // -----------------------------
  // URL safety helpers
  // -----------------------------
  function isLikelyUrl(s){
    if(!s) return false;
    try{ new URL(s, location.href); return true; }catch(_){ return false; }
  }
  function resolveHubUrl(){
    if(hubRaw && isLikelyUrl(hubRaw)) return new URL(hubRaw, location.href).toString();
    return new URL(HUB_FALLBACK, location.href).toString();
  }
  function resolveNextUrl(){
    if(nextRaw && isLikelyUrl(nextRaw)) return new URL(nextRaw, location.href).toString();
    return resolveHubUrl();
  }

  // -----------------------------
  // UI
  // -----------------------------
  function renderPills(){
    const keys = ['pid','run','diff','time','seed','studyId','conditionGroup','log','view','zone','phase','autonext'];
    const pills = keys
      .map(k => [k, QS.get(k)])
      .filter(x => x[1]!=null && String(x[1]).trim()!=='')
      .slice(0, 12);

    const el = document.getElementById('pillrow');
    el.innerHTML = (pills.length ? pills : [['ctx','none']])
      .map(([k,v])=> `<span class="pill"><b>${k}</b>: ${String(v).replace(/</g,'&lt;')}</span>`)
      .join('');
  }

  function renderHeader(){
    const phaseName = (PHASE === 'cooldown') ? 'Cooldown' : 'Warmup';
    document.getElementById('hTitle').textContent = `üèÅ ${phaseName} Gate ‚Äî ${ZONE}`;
    document.getElementById('hSub').textContent = (PHASE === 'cooldown')
      ? `‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå ${DUR} ‡∏ß‡∏¥ ‚Ä¢ ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ mark DONE ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`
      : `‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ ${DUR} ‡∏ß‡∏¥ ‚Ä¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏õ next (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà mark DONE)`;
  }

  function renderModeUI(){
    const badge = document.getElementById('badgeMode');
    const fill = document.getElementById('fill');
    const badgeText = document.getElementById('badgeText');

    badge.classList.remove('warm','cool');
    fill.classList.remove('warm','cool');

    if(PHASE === 'cooldown'){
      badge.classList.add('cool');
      fill.classList.add('cool');
      badgeText.textContent = `COOLDOWN ‚Ä¢ ${DUR}s`;
      document.getElementById('cardTitle').textContent = 'üßä Cooldown';
      document.getElementById('cardDesc').textContent = '‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏∂‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î‡∏à‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô';
    }else{
      badge.classList.add('warm');
      fill.classList.add('warm');
      badgeText.textContent = `WARMUP ‚Ä¢ ${DUR}s`;
      document.getElementById('cardTitle').textContent = 'üî• Warmup';
      document.getElementById('cardDesc').textContent = '‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á';
    }
  }

  function renderStatusBox(){
    document.getElementById('zName').textContent = ZONE;
    document.getElementById('todayText').textContent = ymdLocal();
    document.getElementById('idText').textContent = ID;

    document.getElementById('doneKeyZoneText').textContent = doneKeyZone(ZONE);
    document.getElementById('doneKeyIdText').textContent = doneKeyId(ZONE);
    document.getElementById('doneVal').textContent = isDoneToday(ZONE) ? 'YES' : 'NO';
  }

  function renderRoute(){
    const hub = resolveHubUrl();
    const next = resolveNextUrl();
    document.getElementById('routeNote').innerHTML = `
      <b>Route</b><br/>
      hub: <span class="mono">${hub.replace(/</g,'&lt;')}</span><br/>
      next: <span class="mono">${next.replace(/</g,'&lt;')}</span><br/>
      autonext: <span class="mono">${AUTONEXT ? '1' : '0'}</span>
    `;
  }

  // -----------------------------
  // timer engine
  // -----------------------------
  let running = false;
  let startAt = 0;
  let raf = 0;

  const tLeftEl = document.getElementById('tLeft');
  const fillEl = document.getElementById('fill');

  function setTimeLeft(sec){ tLeftEl.textContent = String(Math.max(0, Math.ceil(sec))); }
  function setProgress(pct){ fillEl.style.width = `${Math.max(0, Math.min(100, pct))}%`; }

  function stop(){
    running = false;
    if(raf) cancelAnimationFrame(raf);
    raf = 0;
  }

  function goReplace(url){
    try{ location.replace(url); }
    catch(_){ location.href = url; }
  }

  function finish(){
    stop();

    // cooldown marks DONE
    if(PHASE === 'cooldown'){
      setDoneToday(ZONE);
      renderStatusBox();
      toast('‚úÖ DONE ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ) ‡πÅ‡∏•‡πâ‡∏ß');
    }

    const next = resolveNextUrl();
    const hub = resolveHubUrl();
    const target = next || hub;

    if(AUTONEXT){
      // small delay for UX then replace (no back-loop)
      setTimeout(()=> goReplace(target), 450);
    }else{
      toast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î Skip ‚Üí Next ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
    }
  }

  function tick(){
    if(!running) return;
    const now = performance.now();
    const elapsed = (now - startAt) / 1000;
    const left = Math.max(0, DUR - elapsed);
    setTimeLeft(left);
    setProgress((elapsed / DUR) * 100);
    if(left <= 0.001) return finish();
    raf = requestAnimationFrame(tick);
  }

  function start(){
    if(running) return;
    running = true;
    startAt = performance.now();
    toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!');
    tick();
  }

  // -----------------------------
  // actions
  // -----------------------------
  function goHub(){
    goReplace(resolveHubUrl());
  }

  function goNext(){
    // if skip during cooldown => still mark DONE (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏ö‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß)
    if(PHASE === 'cooldown'){
      setDoneToday(ZONE);
      renderStatusBox();
      toast('‚úÖ DONE ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ) ‡πÅ‡∏•‡πâ‡∏ß');
    }else{
      toast('‡πÑ‡∏õ next‚Ä¶');
    }
    setTimeout(()=> goReplace(resolveNextUrl()), 200);
  }

  // -----------------------------
  // init
  // -----------------------------
  renderPills();
  renderHeader();
  renderModeUI();
  renderStatusBox();
  renderRoute();

  document.getElementById('btnStart').addEventListener('click', start);
  document.getElementById('btnSkip').addEventListener('click', goNext);
  document.getElementById('btnHub').addEventListener('click', goHub);

  // autostart default = 1 (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö gate)
  const autostart = String(q('autostart','1')||'1') === '1';
  if(autostart){
    setTimeout(start, 350);
  }

})();
</script>
</body>
</html>