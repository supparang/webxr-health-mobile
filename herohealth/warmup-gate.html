<!-- === /herohealth/warmup-gate.html ===
HeroHealth Warmup/Cooldown Gate ‚Äî FULL (v20260218-nutri4x5-real)
‚úÖ Theme-based mini games by THEME (game) + CAT (zone)
‚úÖ Play: pick=rand / Research: pick=day (override by ?pick=)
‚úÖ Nutrition 4 themes have REAL v1‚Äìv5 (pool/speed/rules/decoy/bonus feel different)
‚úÖ Daily once-per-day per PID+category for warmup and cooldown
‚úÖ Warmup end -> pass buffs (wType/wPct/wCrit/wDmg/wHeal/rank) into next URL
‚úÖ Cooldown end -> go next (usually hub)
‚úÖ No-repeat per THEME (variant won't repeat last for same theme)
‚úÖ Works PC/Mobile (tap/click). Safe, no external deps.
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Warmup Gate</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#020617" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.70);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#fb7185;
      --accent:#38bdf8;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif; }
    body{
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(56,189,248,.10), transparent 60%),
        var(--bg);
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal)); }
    .card{
      width:min(880px, 96vw);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.58));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-weight:1000; letter-spacing:.2px; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.45);
      font-weight:900; user-select:none;
    }
    .pill.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .pill.bad{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }
    .sub{ color: var(--muted); font-weight:800; font-size:12px; margin-top:8px; line-height:1.35; }
    .grid{ margin-top:12px; display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }

    .panel{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
      border-radius: 18px;
      padding: 12px;
      position: relative;
      overflow: hidden;
    }
    .panel h3{ margin:0; font-size:13px; font-weight:1000; color:rgba(229,231,235,.92); }
    .panel .muted{ color:rgba(148,163,184,.92); font-size:12px; font-weight:850; margin-top:6px; line-height:1.35; }

    .hud{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width: 520px){ .hud{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .k{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.38);
      border-radius: 16px;
      padding:10px 12px;
    }
    .k .h{ color:rgba(148,163,184,.9); font-size:11px; font-weight:900; }
    .k .v{ font-size:15px; font-weight:1000; margin-top:3px; word-break:break-word; }

    .stage{
      position: relative;
      height: min(460px, 58vh);
      border-radius: 18px;
      border:1px dashed rgba(148,163,184,.18);
      background:
        radial-gradient(800px 380px at 20% 10%, rgba(34,197,94,.08), transparent 55%),
        radial-gradient(640px 320px at 90% 20%, rgba(56,189,248,.06), transparent 60%),
        rgba(2,6,23,.22);
      overflow:hidden;
      touch-action: manipulation;
      user-select:none;
    }
    .btn{
      appearance:none; border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-weight:1000;
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
    }
    .btn.primary{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }
    .btn.warn{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }
    .btn:active{ transform: translateY(1px); }

    .toast{
      position: absolute;
      left: 50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 20;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.72);
      font-weight: 1000;
      font-size: 12px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
      white-space: nowrap;
    }
    .toast.show{ opacity: 1; }
    .flash{
      position:absolute; inset:0;
      background: transparent;
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
    }
    .flash.good{ background: rgba(34,197,94,.14); }
    .flash.bad{ background: rgba(251,113,133,.12); }

    .center{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      text-align:center;
    }
    .big{
      font-size: 56px;
      font-weight: 1000;
      line-height: 1;
      margin: 0;
    }
    .hint{
      margin-top: 8px;
      color: rgba(229,231,235,.85);
      font-weight: 900;
      font-size: 12px;
    }

    .overlay{
      position: fixed;
      inset:0;
      z-index: 9999;
      display: none;
      align-items:center;
      justify-content:center;
      padding: 24px;
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(6px);
    }
    .overlay .box{
      width: min(720px, 92vw);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.70));
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .overlay .box h2{ margin:0; font-size:16px; font-weight:1100; }
    .overlay .box p{ margin:8px 0 0; color:rgba(229,231,235,.82); font-weight:850; font-size:12px; line-height:1.4; }
    .overlay .kv{ margin-top:12px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .overlay .kv .k .v{ font-size:18px; }
    .overlay .actions{ margin-top:12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="title">
          <span class="pill" id="pillPhase">PHASE: ‚Ä¶</span>
          <span class="pill" id="pillCat">CAT: ‚Ä¶</span>
          <span class="pill" id="pillTheme">THEME: ‚Ä¶</span>
          <span class="pill" id="pillPick">PICK: ‚Ä¶</span>
          <span class="pill" id="pillDaily">DAILY: ‚Ä¶</span>
        </div>
        <div class="row">
          <button class="btn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
          <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
        </div>
      </div>

      <div class="sub" id="subLine">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° mini-game‚Ä¶</div>

      <div class="grid">
        <div class="panel">
          <h3 id="gameTitle">‚Äî</h3>
          <div class="muted" id="desc">‚Äî</div>

          <div class="stage" id="stage" role="application" aria-label="Mini game stage">
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
            <div class="center" id="center">
              <div class="big" id="big">üéØ</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
          <div class="muted" id="statusText">‚Äî</div>
          <div style="height:10px"></div>
          <div class="hud" aria-label="hud">
            <div class="k"><div class="h">TIME</div><div class="v" id="hudTime">‚Äî</div></div>
            <div class="k"><div class="h">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="k"><div class="h">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="k"><div class="h">TOTAL</div><div class="v" id="hudTotal">0</div></div>
          </div>

          <div style="height:10px"></div>
          <div class="muted" style="font-size:11px;">
            Tip: ‡∏•‡πá‡∏≠‡∏Å‡∏ò‡∏µ‡∏°‡πÄ‡∏≠‡∏á‡πÉ‡∏™‡πà <b>?theme=goodjunk</b> / <b>groups</b> / <b>hydration</b> / <b>plate</b> / <b>handwash</b> / <b>brush</b> / <b>maskcough</b> / <b>germ</b> / <b>shadow</b> / <b>rhythm</b> / <b>jumpduck</b> / <b>balance</b> / <b>planner</b><br/>
            Tip: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÉ‡∏™‡πà <b>?variant=1..5</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>?pick=rand|day</b>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="endOverlay" aria-hidden="true">
    <div class="box">
      <h2 id="endTitle">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
      <p id="endMsg">‚Äî</p>
      <div class="kv">
        <div class="k"><div class="h">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="k"><div class="h">MISS</div><div class="v" id="endMiss">0</div></div>
        <div class="k"><div class="h">BUFF</div><div class="v" id="endBuff">‚Äî</div></div>
        <div class="k"><div class="h">NEXT</div><div class="v" id="endNext">‚Üí</div></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button class="btn primary" id="btnContinue">‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $= (id)=>DOC.getElementById(id);

  // ---------- QS utils ----------
  function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch{ return url; }
  }

  // ---------- Daily keys (pid+category+day) ----------
  function getLocalDayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function dailyKey(prefix, category, pid){
    const day=getLocalDayKey();
    const p=(pid||'anon').trim()||'anon';
    return `${prefix}:${category}:${p}:${day}`;
  }
  function isDaily(prefix, category, pid){
    try{ return localStorage.getItem(dailyKey(prefix,category,pid))==='1'; }catch{ return false; }
  }
  function markDaily(prefix, category, pid){
    try{ localStorage.setItem(dailyKey(prefix,category,pid),'1'); }catch{}
  }

  // ---------- Gate params ----------
  const phaseRaw = String(q('phase','')).toLowerCase().trim();
  const gate = String(q('gate', (phaseRaw==='warmup'||phaseRaw==='cooldown') ? phaseRaw : 'warmup')).toLowerCase();

  const cat0 = String(q('cat', q('category','nutrition'))).toLowerCase();
  const cat  = (cat0==='hygiene'||cat0==='nutrition'||cat0==='exercise') ? cat0 : 'nutrition';

  const studyPhase = String(q('studyPhase', (phaseRaw && phaseRaw!=='warmup' && phaseRaw!=='cooldown') ? phaseRaw : '')).trim();

  const hub   = absUrlMaybe(q('hub','../hub.html')) || '../hub.html';
  const next0 = absUrlMaybe(q('next','')) || hub;

  const durWarm = clamp(qNum('dur', 20), 5, 60);
  const durCool = clamp(qNum('cdur', qNum('dur',20)), 5, 60);
  const dur = (gate==='cooldown') ? durCool : durWarm;

  let pid = String(q('pid','')).trim() || 'anon';

  // ---------- THEME detect ----------
  function detectThemeKey(){
    const t = String(q('theme', q('game',''))).toLowerCase().trim();
    if(t) return t;

    const n = String(next0||'').toLowerCase();
    if(n.includes('vr-goodjunk') || n.includes('goodjunk')) return 'goodjunk';
    if(n.includes('vr-groups')   || n.includes('groups'))   return 'groups';
    if(n.includes('hydration-vr')|| n.includes('hydration'))return 'hydration';
    if(n.includes('/plate/')     || n.includes('plate-vr')) return 'plate';

    if(n.includes('handwash')) return 'handwash';
    if(n.includes('vr-brush') || n.includes('brush')) return 'brush';
    if(n.includes('maskcough') || n.includes('mask')) return 'maskcough';
    if(n.includes('germ') || n.includes('detective')) return 'germ';

    if(n.includes('shadow-breaker') || n.includes('shadow')) return 'shadow';
    if(n.includes('rhythm-boxer') || n.includes('rhythm')) return 'rhythm';
    if(n.includes('jump-duck') || n.includes('jumpduck')) return 'jumpduck';
    if(n.includes('balance-hold') || n.includes('balance')) return 'balance';
    if(n.includes('fitness-planner') || n.includes('planner')) return 'planner';

    return (cat==='hygiene') ? 'handwash' : (cat==='exercise') ? 'jumpduck' : 'goodjunk';
  }
  const themeKey = detectThemeKey();

  // daily policy
  const dailyPrefix = (gate==='cooldown') ? 'HHA_COOLDOWN_DONE' : 'HHA_WARMUP_DONE';
  const dailyDone = isDaily(dailyPrefix, cat, pid);

  // ---------- UI refs ----------
  const pillPhase=$('pillPhase'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillPick=$('pillPick'), pillDaily=$('pillDaily');
  const subLine=$('subLine'), statusText=$('statusText');
  const gameTitle=$('gameTitle'), desc=$('desc');
  const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');

  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');

  const btnStart=$('btnStart'), btnSkip=$('btnSkip');

  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endMiss=$('endMiss'), endBuff=$('endBuff'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  // ---------- Basic feedback ----------
  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }

  // ---------- Game state ----------
  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let raf=0, lastTs=0;

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudTotal.textContent = String(total);
  }

  function clearStage(){
    Array.from(stage.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch{}
    });
    center.style.display='block';
    big.textContent='üéØ';
    hint.textContent='‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';
  }

  // ---------- Helpers ----------
  function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stage.appendChild(pad);
    return pad;
  }

  // ============================================================
  // ‚úÖ NUTRITION 4 THEMES x 5 VARIANTS (REAL DIFFERENT FEEL)
  // ============================================================

  const NUTRI_V = {
    goodjunk: {
      1:{ pGood:.75, trapPct:0.00, streakN:0, streakBonus:0, pool:'default', speed:1.00, bonus:'none' },
      2:{ pGood:.70, trapPct:0.00, streakN:3, streakBonus:1, pool:'default', speed:1.05, bonus:'streak' },
      3:{ pGood:.62, trapPct:0.00, streakN:0, streakBonus:0, pool:'moreJunk', speed:1.08, bonus:'pressure' },
      4:{ pGood:.68, trapPct:0.12, streakN:0, streakBonus:0, pool:'default', speed:1.10, bonus:'trap' },
      5:{ pGood:.70, trapPct:0.00, streakN:0, streakBonus:0, pool:'kids',    speed:1.12, bonus:'kids' },
    },
    groups: {
      1:{ pool:'full', shortLabels:false, streakN:0, streakBonus:0, twoStepPct:0.00, speed:1.00, bonus:'none' },
      2:{ pool:'full', shortLabels:true,  streakN:0, streakBonus:0, twoStepPct:0.00, speed:1.05, bonus:'short' },
      3:{ pool:'full', shortLabels:true,  streakN:4, streakBonus:1, twoStepPct:0.00, speed:1.08, bonus:'streak' },
      4:{ pool:'lean', shortLabels:true,  streakN:0, streakBonus:0, twoStepPct:0.00, speed:1.12, bonus:'lean' },
      5:{ pool:'full', shortLabels:false, streakN:0, streakBonus:0, twoStepPct:0.35, speed:1.10, bonus:'2step' },
    },
    hydration: {
      1:{ zone:0.34, baseSp:0.085, addSp:0.060, speedUp:0.002, doubleTapMs:0,   doubleBonus:0, fakePct:0.00, speed:1.00 },
      2:{ zone:0.28, baseSp:0.090, addSp:0.060, speedUp:0.002, doubleTapMs:0,   doubleBonus:0, fakePct:0.00, speed:1.05 },
      3:{ zone:0.34, baseSp:0.090, addSp:0.070, speedUp:0.002, doubleTapMs:330, doubleBonus:1, fakePct:0.00, speed:1.08 },
      4:{ zone:0.34, baseSp:0.100, addSp:0.090, speedUp:0.003, doubleTapMs:0,   doubleBonus:0, fakePct:0.00, speed:1.10 },
      5:{ zone:0.32, baseSp:0.095, addSp:0.080, speedUp:0.003, doubleTapMs:300, doubleBonus:1, fakePct:0.70, speed:1.12 },
    },
    plate: {
      1:{ target:3, dupRule:'miss',  decoyDup:0, fastBonus:0, fastWithin:7, balanceAt:0, balanceBonus:0, speed:1.00, bonus:'none' },
      2:{ target:3, dupRule:'minus', decoyDup:0, fastBonus:0, fastWithin:7, balanceAt:0, balanceBonus:0, speed:1.05, bonus:'minus' },
      3:{ target:3, dupRule:'miss',  decoyDup:0, fastBonus:2, fastWithin:7, balanceAt:0, balanceBonus:0, speed:1.08, bonus:'fast' },
      4:{ target:3, dupRule:'miss',  decoyDup:3, fastBonus:0, fastWithin:7, balanceAt:0, balanceBonus:0, speed:1.10, bonus:'decoy' },
      5:{ target:4, dupRule:'miss',  decoyDup:2, fastBonus:0, fastWithin:7, balanceAt:4, balanceBonus:2, speed:1.12, bonus:'balance' },
    }
  };

  const POOL_GJ = {
    default:{ good:['üçé','üçå','ü•¶','ü•¨','ü•ö','üêü','ü•õ','üçö','üçû','ü•ë','ü•ú','üçá','üçä'],
              junk:['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§','üç≠','üç∞','üç´'] },
    moreJunk:{ good:['üçé','üçå','ü•¶','ü•¨','ü•ö','üêü','ü•õ','üçö','üçû','ü•ë'],
              junk:['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§','üç≠','üç∞','üç´','üçø','üßÅ'] },
    kids:{    good:['üçé','üçå','üçá','üçä','ü•õ','ü•ö','üçö','üçû','ü•¶'],
              junk:['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§'] }
  };

  // ---------- Nutrition runners (‡∏£‡∏±‡∏ö cfg) ----------
  function runNutrition_goodjunk(cfg){
    cfg = cfg || NUTRI_V.goodjunk[1];

    gameTitle.textContent = `Nutrition Warmup ‚Äî GoodJunk v${cfg._v||1}`;
    desc.textContent = '‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏° / ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù ‡∏à‡∏∞‡∏û‡∏•‡∏≤‡∏î (trap/streak/pool ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)';
    center.style.display='none';

    const pool = POOL_GJ[cfg.pool || 'default'] || POOL_GJ.default;
    const GOOD = pool.good, JUNK = pool.junk;

    const pGood = (cfg.pGood ?? 0.70);
    const trapPct = (cfg.trapPct ?? 0);
    const speed = (cfg.speed ?? 1.0);

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!</div>
      <div id="it" style="font-size:60px;margin-top:8px;">üçé</div>
      <div class="muted" style="margin-top:6px;">GOOD = +1 / JUNK = MISS</div>`;
    stage.appendChild(card);

    let curKind='good';
    let streak=0;
    let lockUntil=0;

    function next(){
      curKind = (Math.random()<pGood) ? 'good' : 'junk';
      if(curKind==='good' && trapPct>0 && Math.random()<trapPct) curKind='junk';
      const emo = (curKind==='good') ? randPick(GOOD) : randPick(JUNK);
      card.querySelector('#it').textContent = emo;
    }

    card.addEventListener('pointerdown', ()=>{
      if(!started) return;

      const now=performance.now();
      const cd=Math.max(120, 220 / speed);
      if(now<lockUntil) return;
      lockUntil = now + cd;

      total++;
      if(curKind==='good'){
        score++; streak++;
        toastShow('+1'); flashGood();

        const n=cfg.streakN||0, b=cfg.streakBonus||0;
        if(n>0 && b>0 && (streak % n===0)){
          score += b;
          toastShow(`+${b} STREAK`);
        }
      }else{
        miss++; streak=0;
        toastShow('MISS'); flashBad();
      }
      next();
    }, {passive:true});

    next();
  }

  function runNutrition_groups(cfg){
    cfg = cfg || NUTRI_V.groups[1];

    gameTitle.textContent = `Nutrition Warmup ‚Äî 5 ‡∏´‡∏°‡∏π‡πà v${cfg._v||1}`;
    desc.textContent = '‡∏î‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ ‚Äú‡∏´‡∏°‡∏π‡πà 1‚Äì5‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å (labels/pool/streak/2-step ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)';
    center.style.display='none';

    const FULL = [
      {emo:'ü•ö', g:1},{emo:'üêü', g:1},{emo:'ü•õ', g:1},{emo:'ü•ú', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},{emo:'ü•î', g:2},{emo:'üç†', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},{emo:'ü•í', g:3},{emo:'ü•ï', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},{emo:'üçâ', g:4},{emo:'üçä', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},{emo:'ü´í', g:5},{emo:'ü••', g:5},
    ];
    const pool = (cfg.pool==='lean') ? FULL.filter((_,i)=>i%2===0) : FULL;

    const labels = cfg.shortLabels ? ['1','2','3','4','5'] : ['‡∏´‡∏°‡∏π‡πà1','‡∏´‡∏°‡∏π‡πà2','‡∏´‡∏°‡∏π‡πà3','‡∏´‡∏°‡∏π‡πà4','‡∏´‡∏°‡∏π‡πà5'];
    const speed = (cfg.speed ?? 1.0);
    const twoStepPct = cfg.twoStepPct || 0;

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:18px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£: <span id="it" style="font-size:36px;">ü•ö</span></div>
      <div class="muted" id="lbl" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>`;
    stage.appendChild(card);

    const pad=mkPad(5);
    labels.forEach((t,i)=>{
      const b=mkBtn(t);
      b.style.padding='12px 8px';
      b.style.borderRadius='14px';
      b.style.fontWeight='1100';
      b.style.fontSize='12px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>choose(i+1));
    });

    let streak=0;
    const streakN=cfg.streakN||0, streakBonus=cfg.streakBonus||0;

    let cur = randPick(pool);
    let needSecond = false;
    let firstPick = 0;

    function next(){
      cur = randPick(pool);
      needSecond = (twoStepPct>0 && Math.random()<twoStepPct);
      firstPick = 0;
      card.querySelector('#it').textContent = cur.emo;
      card.querySelector('#lbl').textContent = needSecond ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
    }

    function choose(g){
      if(!started) return;

      // normal (1-step)
      if(!needSecond){
        total++;
        if(g===cur.g){
          score++; streak++;
          toastShow('+1'); flashGood();
          if(streakN>0 && streakBonus>0 && streak%streakN===0){ score+=streakBonus; toastShow(`+${streakBonus} STREAK`); }
        }else{
          miss++; streak=0;
          toastShow('MISS'); flashBad();
        }
        setTimeout(next, Math.max(0, 140/speed));
        return;
      }

      // 2-step Analyze-lite: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡πâ‡∏ß "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" (‡πÅ‡∏ï‡∏∞‡∏´‡∏°‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
      total++;
      if(!firstPick){
        firstPick = g;
        if(g===cur.g){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        card.querySelector('#lbl').textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏ï‡∏∞‡∏´‡∏°‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';
        return;
      }else{
        // step 2
        total++;
        if(g===firstPick){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        setTimeout(next, Math.max(0, 140/speed));
      }
    }

    next();
  }

  function runNutrition_hydration(cfg){
    cfg = cfg || NUTRI_V.hydration[1];

    gameTitle.textContent = `Nutrition Warmup ‚Äî Hydration v${cfg._v||1}`;
    desc.textContent = '‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô ‚Äú‡∏à‡∏∏‡∏î‚Äù ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ (zone/speed/double/fake ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)';
    center.style.display='none';

    const zonePct = cfg.zone ?? 0.34;
    const baseSp  = cfg.baseSp ?? 0.085;
    const addSp   = cfg.addSp ?? 0.06;
    const speedUp = cfg.speedUp ?? 0.002;
    const doubleTapMs = cfg.doubleTapMs || 0;
    const doubleBonus = cfg.doubleBonus || 0;
    const fakePct = cfg.fakePct || 0;
    const speed = cfg.speed ?? 1.0;

    const ring=DOC.createElement('div');
    Object.assign(ring.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'240px',height:'240px',borderRadius:'999px',
      border:'2px solid rgba(56,189,248,.35)',
      background:`radial-gradient(circle at 50% 50%, rgba(34,197,94,.12) 0 ${Math.round(zonePct*100)}%, transparent ${Math.round(zonePct*100)+1}% 100%)`
    });
    stage.appendChild(ring);

    const dot=DOC.createElement('div');
    Object.assign(dot.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'16px',height:'16px',borderRadius:'999px',
      background:'rgba(251,113,133,.95)'
    });
    stage.appendChild(dot);

    let t=0;
    let lastTap=0;

    function anim(){
      if(!started) return;
      const played = dur - tLeft;
      const sp = (baseSp + Math.min(addSp, played*speedUp)) * speed;

      t += sp;
      const r=96;
      const x=Math.cos(t)*r;
      const y=Math.sin(t)*r;
      dot.style.marginLeft = x+'px';
      dot.style.marginTop  = (y-30)+'px';

      const dist=Math.hypot(x,y);
      let inZone = (dist < (zonePct*100)) ? 1 : 0;

      // fake beat: ‡∏´‡∏•‡∏≠‡∏Å‡∏ô‡∏¥‡∏î ‡πÜ (v5 ‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î)
      if(fakePct>0 && Math.random()<fakePct*0.02) inZone = 1-inZone;

      dot.dataset.inzone = inZone ? '1':'0';
      raf = requestAnimationFrame(anim);
    }

    stage.addEventListener('pointerdown', ()=>{
      if(!started) return;
      total++;

      const ok = (dot.dataset.inzone==='1');
      if(ok){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }

      if(doubleTapMs>0){
        const now=performance.now();
        if(now-lastTap<=doubleTapMs && ok && doubleBonus>0){
          score += doubleBonus;
          toastShow(`+${doubleBonus} DOUBLE`);
        }
        lastTap = now;
      }
    }, {passive:true});

    requestAnimationFrame(anim);
  }

  function runNutrition_plate(cfg){
    cfg = cfg || NUTRI_V.plate[1];

    gameTitle.textContent = `Nutrition Warmup ‚Äî Plate v${cfg._v||1}`;
    desc.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (dupRule/decoy/fast/balance/target ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)';
    center.style.display='none';

    const target = cfg.target || 3;
    const dupRule = cfg.dupRule || 'miss'; // miss | minus | none
    const decoyDup = cfg.decoyDup || 0;
    const fastBonus = cfg.fastBonus || 0;
    const fastWithin = cfg.fastWithin || 7;
    const balanceAt = cfg.balanceAt || 0;
    const balanceBonus = cfg.balanceBonus || 0;

    const picked=new Set();
    const tStart = performance.now();

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô</div>
      <div class="muted" id="pb" style="margin-top:6px;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‚â• ${target} ‡∏´‡∏°‡∏π‡πà</div>
      <div style="margin-top:10px;font-size:34px;">üçΩÔ∏è</div>`;
    stage.appendChild(card);

    const itemsBase=[
      {emo:'üêü', g:1},{emo:'ü•õ', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},
    ];

    const items=[...itemsBase];
    for(let i=0;i<decoyDup;i++){
      items.push(itemsBase[(Math.random()*itemsBase.length)|0]);
    }

    const pad=mkPad(5);
    items.slice(0,10).forEach(it=>{
      const b=mkBtn(it.emo);
      b.style.padding='14px 8px'; b.style.borderRadius='16px';
      b.style.fontSize='18px';
      pad.appendChild(b);

      b.addEventListener('click', ()=>{
        if(!started) return;
        total++;

        if(!picked.has(it.g)){
          picked.add(it.g);
          score++; toastShow('+1'); flashGood();
        }else{
          if(dupRule==='none'){
            toastShow('OK');
          }else if(dupRule==='minus'){
            score = Math.max(0, score-1);
            miss++; toastShow('-1'); flashBad();
          }else{
            miss++; toastShow('MISS'); flashBad();
          }
        }

        card.querySelector('#pb').textContent = `‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${picked.size} ‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‚â• ${target})`;

        if(picked.size>=target){
          const sec = (performance.now()-tStart)/1000;

          if(fastBonus>0 && sec<=fastWithin){
            score += fastBonus;
            toastShow(`+${fastBonus} FAST`);
          }

          if(balanceAt>0 && picked.size>=balanceAt && balanceBonus>0 && !card.dataset.balanced){
            card.dataset.balanced='1';
            score += balanceBonus;
            toastShow(`+${balanceBonus} BAL`);
          }
        }
      });
    });
  }

  // ---------- Variant picking: ?variant=1..5 + ?pick=rand|day + no-repeat ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ theme ----------
  function dayIndex1to5(){
    const d = new Date();
    return (d.getDate() % 5) + 1;
  }
  function pickVariantForTheme(themeKey){
    const forced = Number(q('variant','0'));
    if(forced>=1 && forced<=5) return forced;

    const pickMode = String(q('pick','rand')).toLowerCase(); // rand|day
    let v = (pickMode==='day') ? dayIndex1to5() : (1 + ((Math.random()*5)|0));

    // no-repeat ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ theme
    try{
      const k = `HHA_LAST_V_${themeKey}`;
      const last = Number(localStorage.getItem(k) || '0');
      if(last && v===last) v = (v % 5) + 1;
      localStorage.setItem(k, String(v));
    }catch(e){}
    return v;
  }
  function themeToVariantKey(themeKey, v){
    if(themeKey==='goodjunk')  return `goodjunk_v${v}`;
    if(themeKey==='groups')    return `groups_v${v}`;
    if(themeKey==='hydration') return `hydration_v${v}`;
    if(themeKey==='plate')     return `plate_v${v}`;
    return themeKey;
  }

  // ---------- Theme router ----------
  const Theme = {
    // nutrition (fallback)
    goodjunk:  ()=>runNutrition_goodjunk({...NUTRI_V.goodjunk[1], _v:1}),
    groups:    ()=>runNutrition_groups({...NUTRI_V.groups[1], _v:1}),
    hydration: ()=>runNutrition_hydration({...NUTRI_V.hydration[1], _v:1}),
    plate:     ()=>runNutrition_plate({...NUTRI_V.plate[1], _v:1}),
  };

  function withV(theme, n){
    return ()=>{
      const cfg = (NUTRI_V[theme] && NUTRI_V[theme][n]) ? {...NUTRI_V[theme][n]} : {};
      cfg._v = n;

      if(theme==='goodjunk')  return runNutrition_goodjunk(cfg);
      if(theme==='groups')    return runNutrition_groups(cfg);
      if(theme==='hydration') return runNutrition_hydration(cfg);
      if(theme==='plate')     return runNutrition_plate(cfg);
    };
  }
  const NUTRI_FUN = {
    goodjunk_v1: withV('goodjunk',1), goodjunk_v2: withV('goodjunk',2), goodjunk_v3: withV('goodjunk',3), goodjunk_v4: withV('goodjunk',4), goodjunk_v5: withV('goodjunk',5),
    groups_v1: withV('groups',1), groups_v2: withV('groups',2), groups_v3: withV('groups',3), groups_v4: withV('groups',4), groups_v5: withV('groups',5),
    hydration_v1: withV('hydration',1), hydration_v2: withV('hydration',2), hydration_v3: withV('hydration',3), hydration_v4: withV('hydration',4), hydration_v5: withV('hydration',5),
    plate_v1: withV('plate',1), plate_v2: withV('plate',2), plate_v3: withV('plate',3), plate_v4: withV('plate',4), plate_v5: withV('plate',5),
  };
  Object.assign(Theme, NUTRI_FUN);

  // ---------- Buff generator (A+C: ‡∏ö‡∏±‡∏ü‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏° Theme) ----------
  function makeWarmupBuff(themeKey){
    const acc = (total>0) ? (score/Math.max(1,total)) : 0;
    const pct = Math.round(clamp(acc*100, 5, 30));
    const rank = (acc>=0.85) ? 'S' : (acc>=0.70) ? 'A' : (acc>=0.55) ? 'B' : 'C';

    // ‡∏ö‡∏±‡∏ü‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á
    let wCrit=0, wDmg=0, wHeal=0;
    let wType = 'warmup';

    if(themeKey==='hydration'){
      wHeal = 1;
    }else if(themeKey==='plate'){
      wCrit = 1;
    }else if(themeKey==='groups'){
      wCrit = 1;
    }else if(themeKey==='goodjunk'){
      wDmg  = 1;
    }else{
      wCrit = 1;
    }

    return { wType, wPct:pct, rank, wCrit, wDmg, wHeal };
  }

  // ---------- buildNextUrl ----------
  function buildNextUrl(buff){
    let target = next0 || hub;

    if(gate==='cooldown'){
      return target || hub;
    }

    const u = new URL(target, location.href);

    const passthroughKeys = [
      'hub','run','diff','time','seed','studyId','conditionGroup','log','view','pid','cat','category','studyPhase'
    ];
    passthroughKeys.forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });

    if(pid && !u.searchParams.has('pid')) u.searchParams.set('pid', pid);
    if(!u.searchParams.has('cat')) u.searchParams.set('cat', cat);
    if(!u.searchParams.has('category')) u.searchParams.set('category', cat);
    if(studyPhase && !u.searchParams.has('studyPhase')) u.searchParams.set('studyPhase', studyPhase);

    Object.entries(buff||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });

    if(!u.searchParams.has('wType')) u.searchParams.set('wType', String((buff&&buff.wType) || 'warmup'));
    if(!u.searchParams.has('wPct'))  u.searchParams.set('wPct',  String((buff&&buff.wPct)  || 10));

    return u.toString();
  }

  // ---------- End ----------
  function endNow(buffObj){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf);

    markDaily(dailyPrefix, cat, pid);

    const buff = buffObj || {};
    const nextUrl = buildNextUrl(buff);

    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');
    endTitle.textContent = (gate==='cooldown') ? 'Cooldown ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : 'Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
    endScore.textContent = String(score);
    endMiss.textContent  = String(miss);
    endBuff.textContent  = Object.keys(buff).length ? Object.keys(buff).join(',') : '‚Äî';
    endNext.textContent  = nextUrl ? 'YES' : 'HUB';
    endMsg.textContent =
      (gate==='cooldown')
        ? '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
        : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(nextUrl || hub);
  }

  // ---------- Tick ----------
  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);
    setHUD();
    if(tLeft<=0){
      if(gate==='cooldown') endNow({ calm: 1 });
      else endNow(makeWarmupBuff(themeKey));
      return;
    }
    raf = requestAnimationFrame(tick);
  }

  // ---------- Daily auto-skip ----------
  function autoSkipIfDaily(){
    if(!dailyDone) return false;
    const target = (next0 || hub);
    subLine.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ ${gate} ‡πÅ‡∏•‡πâ‡∏ß (pid=${pid}, cat=${cat}) ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    statusText.textContent = 'Daily gate: DONE';
    setTimeout(()=> location.replace(target), 220);
    return true;
  }

  // ---------- Cooldown mini ----------
  function runCooldown_Calm(){
    gameTitle.textContent='Cooldown ‚Äî Calm Breathing';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚ÄúIN/OUT‚Äù ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ)';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(560px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;">‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞</div>
      <div style="margin-top:12px;font-size:56px;">ü´Å</div>
      <div id="bt" style="margin-top:8px;font-size:18px;font-weight:1100;">INHALE</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn primary" id="bin">IN</button>
        <button class="btn" id="bout">OUT</button>
      </div>`;
    stage.appendChild(card);

    const bin=card.querySelector('#bin');
    const bout=card.querySelector('#bout');
    const bt=card.querySelector('#bt');

    let cur='IN';
    function next(){
      cur = (Math.random()<0.5)?'IN':'OUT';
      bt.textContent = (cur==='IN')?'INHALE':'EXHALE';
    }
    function choose(a){
      if(!started) return;
      total++;
      if(a===cur){ score++; flashGood(); toastShow('+1'); }
      else { miss++; flashBad(); toastShow('MISS'); }
      next();
    }
    bin.addEventListener('click', ()=>choose('IN'));
    bout.addEventListener('click', ()=>choose('OUT'));
    next();
  }

  // ---------- Start / Skip ----------
  function start(){
    if(dailyDone){ autoSkipIfDaily(); return; }

    clearStage();
    score=0; miss=0; total=0;
    tLeft=dur; lastTs=0;
    setHUD();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    if(gate==='cooldown'){
      runCooldown_Calm();
      statusText.textContent = `Cooldown (${dur}s) ‚Äî pid=${pid} cat=${cat}`;
      pillPick.textContent = `PICK: ${String(q('pick','rand')).toUpperCase()}`;
    }else{
      const v = pickVariantForTheme(themeKey);
      const key = themeToVariantKey(themeKey, v);

      pillPick.textContent = `PICK: ${String(q('pick','rand')).toUpperCase()} v${v}`;

      const fn = Theme[key] || Theme[themeKey] || Theme.goodjunk;
      fn();

      statusText.textContent = `Warmup (${dur}s) ‚Äî theme=${themeKey} v${v} ‚Üí next`;
    }

    subLine.textContent = (gate==='cooldown')
      ? '‡πÄ‡∏•‡πà‡∏ô cooldown ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö/‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'
      : '‡πÄ‡∏•‡πà‡∏ô warmup ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';

    requestAnimationFrame(tick);
  }

  function skip(){
    const target = (next0 || hub);
    markDaily(dailyPrefix, cat, pid);
    location.replace(target);
  }

  function maybeAutoEnd(){
    if(!started) return;
    if(gate==='cooldown') endNow({ calm: 1 });
    else endNow(makeWarmupBuff(themeKey));
  }

  // ---------- UI init ----------
  pillPhase.textContent  = `PHASE: ${gate.toUpperCase()}`;
  pillCat.textContent    = `CAT: ${cat.toUpperCase()}`;
  pillTheme.textContent  = `THEME: ${themeKey.toUpperCase()}`;
  pillPick.textContent   = `PICK: ${String(q('pick','rand')).toUpperCase()}`;
  pillDaily.textContent  = dailyDone ? 'DAILY: DONE' : 'DAILY: NEW';

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  stage.addEventListener('pointerdown', ()=>{
    if(!started && !dailyDone) start();
  }, {passive:true});

  if(!autoSkipIfDaily()){
    const name = (gate==='cooldown')?'Cooldown':'Warmup';
    subLine.textContent = `${name} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù`;
    statusText.textContent =
      `ready: pid=${pid} cat=${cat} theme=${themeKey} next=${next0 ? 'yes' : 'hub'}`
      + (studyPhase ? ` studyPhase=${studyPhase}` : '');
    setHUD();
  }

  WIN.addEventListener('visibilitychange', ()=>{
    if(DOC.hidden && started) maybeAutoEnd();
  });

})();
</script>
</body>
</html>