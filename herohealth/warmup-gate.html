<!-- === /herohealth/warmup-gate.html ===
HeroHealth Warmup/Cooldown Gate ‚Äî FULL (v20260218-pick5-FULL)
‚úÖ cat = zone (nutrition|hygiene|exercise)
‚úÖ theme = game (goodjunk|groups|hydration|plate|handwash|brush|maskcough|germ|shadow|rhythm|jumpduck|balance|planner)
‚úÖ 5 variants per (cat,theme)
‚úÖ Play: pick=rand / Research: pick=day (override by ?pick=rand|day)
‚úÖ Override: ?variant=1..5 (forces the mini-game variant)
‚úÖ Daily once-per-day per PID+cat for warmup and cooldown (prefix differs)
‚úÖ Warmup end -> pass buffs (wType/wPct/wCrit/wDmg/wHeal/rank/calm) into next URL
‚úÖ Cooldown end -> go next (usually hub)
‚úÖ Works PC/Mobile (tap/click). Safe, no external deps.
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Warmup Gate</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#020617" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.70);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#fb7185;
      --accent:#38bdf8;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif; }
    body{
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(56,189,248,.10), transparent 60%),
        var(--bg);
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal)); }
    .card{
      width:min(920px, 96vw);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.58));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-weight:1000; letter-spacing:.2px; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.45);
      font-weight:900; user-select:none;
      font-size:12px;
    }
    .pill.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .pill.bad{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }
    .sub{ color: var(--muted); font-weight:800; font-size:12px; margin-top:8px; line-height:1.35; }
    .grid{ margin-top:12px; display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }

    .panel{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
      border-radius: 18px;
      padding: 12px;
      position: relative;
      overflow: hidden;
    }
    .panel h3{ margin:0; font-size:13px; font-weight:1000; color:rgba(229,231,235,.92); }
    .panel .muted{ color:rgba(148,163,184,.92); font-size:12px; font-weight:850; margin-top:6px; line-height:1.35; }

    .hud{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width: 520px){ .hud{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .k{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.38);
      border-radius: 16px;
      padding:10px 12px;
    }
    .k .h{ color:rgba(148,163,184,.9); font-size:11px; font-weight:900; }
    .k .v{ font-size:15px; font-weight:1000; margin-top:3px; word-break:break-word; }

    .stage{
      position: relative;
      height: min(480px, 60vh);
      border-radius: 18px;
      border:1px dashed rgba(148,163,184,.18);
      background:
        radial-gradient(800px 380px at 20% 10%, rgba(34,197,94,.08), transparent 55%),
        radial-gradient(640px 320px at 90% 20%, rgba(56,189,248,.06), transparent 60%),
        rgba(2,6,23,.22);
      overflow:hidden;
      touch-action: manipulation;
      user-select:none;
    }
    .btn{
      appearance:none; border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-weight:1000;
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
    }
    .btn.primary{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }
    .btn.warn{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }
    .btn:active{ transform: translateY(1px); }

    .toast{
      position: absolute;
      left: 50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 20;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.72);
      font-weight: 1000;
      font-size: 12px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
      white-space: nowrap;
    }
    .toast.show{ opacity: 1; }
    .flash{
      position:absolute; inset:0;
      background: transparent;
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
    }
    .flash.good{ background: rgba(34,197,94,.14); }
    .flash.bad{ background: rgba(251,113,133,.12); }

    .center{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      text-align:center;
    }
    .big{
      font-size: 56px;
      font-weight: 1000;
      line-height: 1;
      margin: 0;
    }
    .hint{
      margin-top: 8px;
      color: rgba(229,231,235,.85);
      font-weight: 900;
      font-size: 12px;
    }

    .overlay{
      position: fixed;
      inset:0;
      z-index: 9999;
      display: none;
      align-items:center;
      justify-content:center;
      padding: 24px;
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(6px);
    }
    .overlay .box{
      width: min(720px, 92vw);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.70));
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .overlay .box h2{ margin:0; font-size:16px; font-weight:1100; }
    .overlay .box p{ margin:8px 0 0; color:rgba(229,231,235,.82); font-weight:850; font-size:12px; line-height:1.4; }
    .overlay .kv{ margin-top:12px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .overlay .kv .k .v{ font-size:18px; }
    .overlay .actions{ margin-top:12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="title">
          <span class="pill" id="pillPhase">PHASE: ‚Ä¶</span>
          <span class="pill" id="pillCat">CAT: ‚Ä¶</span>
          <span class="pill" id="pillTheme">THEME: ‚Ä¶</span>
          <span class="pill" id="pillPick">PICK: ‚Ä¶</span>
          <span class="pill" id="pillVar">VAR: ‚Ä¶</span>
          <span class="pill" id="pillDaily">DAILY: ‚Ä¶</span>
        </div>
        <div class="row">
          <button class="btn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
          <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
        </div>
      </div>

      <div class="sub" id="subLine">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° mini-game‚Ä¶</div>

      <div class="grid">
        <div class="panel">
          <h3 id="gameTitle">‚Äî</h3>
          <div class="muted" id="desc">‚Äî</div>

          <div class="stage" id="stage" role="application" aria-label="Mini game stage">
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
            <div class="center" id="center">
              <div class="big" id="big">üéØ</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
          <div class="muted" id="statusText">‚Äî</div>
          <div style="height:10px"></div>
          <div class="hud" aria-label="hud">
            <div class="k"><div class="h">TIME</div><div class="v" id="hudTime">‚Äî</div></div>
            <div class="k"><div class="h">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="k"><div class="h">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="k"><div class="h">TOTAL</div><div class="v" id="hudTotal">0</div></div>
          </div>

          <div style="height:10px"></div>
          <div class="muted" style="font-size:11px; line-height:1.35;">
            Tip: ‡∏•‡πá‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô/‡∏ò‡∏µ‡∏°‡πÄ‡∏≠‡∏á‡πÉ‡∏™‡πà <b>?cat=nutrition</b> / <b>hygiene</b> / <b>exercise</b> ‡πÅ‡∏•‡∏∞ <b>?theme=goodjunk</b> ‡∏Ø‡∏•‡∏Ø<br/>
            Tip: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏™‡πà <b>?pick=rand</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>?pick=day</b> ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö variant ‡πÉ‡∏™‡πà <b>?variant=1..5</b>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Result overlay -->
  <div class="overlay" id="endOverlay" aria-hidden="true">
    <div class="box">
      <h2 id="endTitle">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
      <p id="endMsg">‚Äî</p>
      <div class="kv">
        <div class="k"><div class="h">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="k"><div class="h">MISS</div><div class="v" id="endMiss">0</div></div>
        <div class="k"><div class="h">BUFF</div><div class="v" id="endBuff">‚Äî</div></div>
        <div class="k"><div class="h">NEXT</div><div class="v" id="endNext">‚Üí</div></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button class="btn primary" id="btnContinue">‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $= (id)=>DOC.getElementById(id);

  // ---------- QS utils ----------
  function getQS(){ try{ return new URL(location.href).searchParams; }catch(e){ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch(e){ return url; }
  }
  function buildUrl(base, params){
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  // ---------- Deterministic helpers ----------
  function getLocalDayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function hash32(str){
    // FNV-1a 32-bit
    str = String(str||'');
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function pickVariant(mode, pid, cat, theme, forced){
    // forced: 1..5
    const f = Number(forced);
    if(Number.isFinite(f) && f>=1 && f<=5) return (f|0);

    mode = String(mode||'rand').toLowerCase();
    if(mode==='day'){
      const day=getLocalDayKey();
      const key = `${pid||'anon'}|${cat||''}|${theme||''}|${day}`;
      const h = hash32(key);
      return (h % 5) + 1; // 1..5 deterministic
    }
    // rand
    return ((Math.random()*5)|0) + 1;
  }

  // ---------- Daily keys (pid+category+day) ----------
  function dailyKey(prefix, category, pid){
    const day=getLocalDayKey();
    const p=(pid||'anon').trim()||'anon';
    return `${prefix}:${category}:${p}:${day}`;
  }
  function isDaily(prefix, category, pid){
    try{ return localStorage.getItem(dailyKey(prefix,category,pid))==='1'; }catch(e){ return false; }
  }
  function markDaily(prefix, category, pid){
    try{ localStorage.setItem(dailyKey(prefix,category,pid),'1'); }catch(e){}
  }

  // ---------- Core params ----------
  const phase = String(q('phase','warmup')).toLowerCase();  // warmup|cooldown
  const cat   = String(q('cat','nutrition')).toLowerCase(); // nutrition|hygiene|exercise
  const hub   = absUrlMaybe(q('hub','../hub.html')) || '../hub.html';
  const next0 = absUrlMaybe(q('next','')) || hub;

  const runMode = String(q('run','play')).toLowerCase(); // play|research
  const pickMode = String(q('pick', (runMode==='research') ? 'day' : 'rand')).toLowerCase(); // rand|day
  const forcedVar = qNum('variant', 0);

  // duration: warmup uses ?dur, cooldown uses ?cdur (fallback dur)
  const durWarm = clamp(qNum('dur', 20), 5, 60);
  const durCool = clamp(qNum('cdur', qNum('dur',20)), 5, 60);
  const dur = (phase==='cooldown') ? durCool : durWarm;

  // pid: query first
  let pid = String(q('pid','')).trim() || 'anon';

  // ---------- Detect theme from ?theme or ?game or next path ----------
  function detectThemeKey(){
    const t = String(q('theme','')).toLowerCase().trim();
    if(t) return t;

    const g = String(q('game','')).toLowerCase().trim();
    if(g) return g;

    const n = String(next0||'').toLowerCase();

    // nutrition
    if(n.includes('vr-goodjunk') || n.includes('goodjunk')) return 'goodjunk';
    if(n.includes('vr-groups')   || n.includes('groups'))   return 'groups';
    if(n.includes('hydration-vr')|| n.includes('hydration'))return 'hydration';
    if(n.includes('/plate/')     || n.includes('plate-vr')) return 'plate';

    // hygiene
    if(n.includes('handwash')) return 'handwash';
    if(n.includes('vr-brush') || n.includes('brush')) return 'brush';
    if(n.includes('maskcough') || n.includes('mask')) return 'maskcough';
    if(n.includes('germ') || n.includes('detective')) return 'germ';

    // exercise
    if(n.includes('shadow-breaker') || n.includes('shadow')) return 'shadow';
    if(n.includes('rhythm-boxer') || n.includes('rhythm')) return 'rhythm';
    if(n.includes('jump-duck') || n.includes('jumpduck')) return 'jumpduck';
    if(n.includes('balance-hold') || n.includes('balance')) return 'balance';
    if(n.includes('fitness-planner') || n.includes('planner')) return 'planner';

    // fallback by cat
    return (cat==='hygiene') ? 'handwash' : (cat==='exercise') ? 'jumpduck' : 'goodjunk';
  }
  const themeKey = detectThemeKey();

  // Choose variant once per load (or per start) - to keep consistent during a run:
  const variant = pickVariant(pickMode, pid, cat, themeKey, forcedVar);

  // daily policy: warmup once/day, cooldown once/day (per pid+cat)
  const dailyPrefix = (phase==='cooldown') ? 'HHA_COOLDOWN_DONE' : 'HHA_WARMUP_DONE';
  const dailyDone = isDaily(dailyPrefix, cat, pid);

  // ---------- UI refs ----------
  const pillPhase=$('pillPhase'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillPick=$('pillPick'), pillVar=$('pillVar'), pillDaily=$('pillDaily');
  const subLine=$('subLine'), statusText=$('statusText');
  const gameTitle=$('gameTitle'), desc=$('desc');
  const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');

  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');
  const btnStart=$('btnStart'), btnSkip=$('btnSkip');

  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endMiss=$('endMiss'), endBuff=$('endBuff'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  // ---------- Basic feedback ----------
  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }

  // ---------- Game state ----------
  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let rafTick=0, lastTs=0;

  // Some mini-games may use their own RAF. We'll keep a list to cancel.
  let rafLocal=0;
  function cancelLocalRAF(){
    try{ if(rafLocal) cancelAnimationFrame(rafLocal); }catch(e){}
    rafLocal=0;
  }

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudTotal.textContent = String(total);
  }

  function clearStage(){
    cancelLocalRAF();
    // keep toast+flash+center
    Array.from(stage.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch(e){}
    });
    center.style.display='block';
    big.textContent='üéØ';
    hint.textContent='‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';
  }

  function endNow(buffObj){
    if(!started) return;
    started=false;
    try{ cancelAnimationFrame(rafTick); }catch(e){}
    cancelLocalRAF();

    // mark daily immediately (so refresh won't replay)
    markDaily(dailyPrefix, cat, pid);

    // build NEXT url
    const buff = buffObj || {};
    const nextUrl = buildNextUrl(buff);

    // show overlay
    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');
    endTitle.textContent = (phase==='cooldown') ? 'Cooldown ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : 'Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
    endScore.textContent = String(score);
    endMiss.textContent  = String(miss);
    endBuff.textContent  = Object.keys(buff).length ? Object.keys(buff).join(',') : '‚Äî';
    endNext.textContent  = nextUrl ? 'YES' : 'HUB';
    endMsg.textContent =
      (phase==='cooldown')
        ? '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
        : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(nextUrl || hub);
  }

  function buildNextUrl(buff){
    let target = next0 || hub;

    // cooldown: always go next/hub without warmup buffs
    if(phase==='cooldown'){
      return target || hub;
    }

    const u = new URL(target, location.href);

    // pass-through: keep existing params from gate (research context)
    const passthroughKeys = [
      'hub','run','diff','time','seed','studyId','phase','conditionGroup','log','view','pid','cat','theme','pick','variant'
    ];
    passthroughKeys.forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });

    // ensure pid present
    if(pid && !u.searchParams.has('pid')) u.searchParams.set('pid', pid);

    // add warmup buffs
    Object.entries(buff||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });

    // recommended minimal marker
    if(!u.searchParams.has('wType')) u.searchParams.set('wType', String(buff.wType || 'warmup'));
    if(!u.searchParams.has('wPct'))  u.searchParams.set('wPct',  String(buff.wPct  || 10));

    return u.toString();
  }

  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);
    setHUD();
    if(tLeft<=0){
      // default buff if game didn't provide
      if(phase==='cooldown') endNow({ calm: 1 });
      else endNow(makeWarmupBuff());
      return;
    }
    rafTick = requestAnimationFrame(tick);
  }

  // ---------- Daily auto-skip ----------
  function autoSkipIfDaily(){
    if(!dailyDone) return false;
    const target = (next0 || hub);
    subLine.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ ${phase} ‡πÅ‡∏•‡πâ‡∏ß (pid=${pid}, cat=${cat}) ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    statusText.textContent = 'Daily gate: DONE';
    setTimeout(()=> location.replace(target), 220);
    return true;
  }

  // ---------- Helpers for mini games ----------
  function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stage.appendChild(pad);
    return pad;
  }

  // =====================================================================
  //  MINI GAME VARIANTS (5 per theme)
  //  Convention: each function should:
  //   - set gameTitle/desc
  //   - hide center
  //   - wire events; update score/miss/total
  // =====================================================================

  // ---------------- NUTRITION: goodjunk ----------------
  // V1: Food Sort Sprint (tap good vs junk)
  function gj_v1_sort(){
    gameTitle.textContent='Nutrition Warmup ‚Äî GoodJunk V1: Food Sort Sprint';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏° / ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù ‡∏à‡∏∞‡∏û‡∏•‡∏≤‡∏î (‡∏ù‡∏∂‡∏Å‡πÅ‡∏¢‡∏Å‡πÄ‡∏£‡πá‡∏ß ‡πÜ)';
    center.style.display='none';

    const GOOD = ['üçé','üçå','ü•¶','ü•¨','ü•ö','üêü','ü•õ','üçö','üçû','ü•ë'];
    const JUNK = ['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§','üç≠'];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!</div>
      <div id="it" style="font-size:60px;margin-top:8px;">üçé</div>
      <div class="muted" style="margin-top:6px;">GOOD = +1 / JUNK = MISS</div>`;
    stage.appendChild(card);

    let curKind='good';
    function next(){
      total++;
      curKind = (Math.random()<0.70) ? 'good' : 'junk';
      const emo = (curKind==='good') ? randPick(GOOD) : randPick(JUNK);
      card.querySelector('#it').textContent = emo;
    }
    card.addEventListener('pointerdown', ()=>{
      if(!started) return;
      if(curKind==='good'){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }, {passive:true});

    next();
  }

  // V2: Trash Dash (tap only junk, good is trap)
  function gj_v2_trashdash(){
    gameTitle.textContent='Nutrition Warmup ‚Äî GoodJunk V2: Trash Dash';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß! (‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏à‡∏∞ MISS)';
    center.style.display='none';

    const GOOD = ['üçé','ü•¶','ü•õ','üçö','üêü','ü•ö'];
    const JUNK = ['üçü','üçî','üçï','üç©','üç¨','ü•§'];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'48%',transform:'translate(-50%,-55%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢!</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÅ‡∏ï‡∏∞ JUNK = +1 | ‡πÅ‡∏ï‡∏∞ GOOD = MISS</div>
      <div id="lane" style="position:relative;margin:12px auto 0;width:min(560px,100%);height:220px;border-radius:16px;
        border:1px dashed rgba(148,163,184,.18);background:rgba(2,6,23,.25);overflow:hidden;"></div>
    `;
    stage.appendChild(card);
    const lane=card.querySelector('#lane');

    function spawn(){
      if(!started) return;
      total++;
      const isJ = Math.random()<0.62;
      const emo = isJ ? randPick(JUNK) : randPick(GOOD);
      const b=DOC.createElement('button');
      b.className='btn';
      b.textContent=emo;
      b.style.position='absolute';
      b.style.left = (10 + Math.random()*80) + '%';
      b.style.top  = '-10px';
      b.style.transform='translate(-50%,0)';
      b.style.borderRadius='999px';
      b.style.fontSize='22px';
      b.style.padding='10px 12px';
      b.style.background='rgba(2,6,23,.42)';
      b.dataset.kind = isJ ? 'junk' : 'good';
      lane.appendChild(b);

      let y=-10;
      function fall(){
        if(!started){ try{ b.remove(); }catch(e){}; return; }
        y += 2.4;
        b.style.top = y+'px';
        if(y>220){
          // missed target: if junk fell => miss, good fell => ok
          if(b.dataset.kind==='junk'){ miss++; toastShow('MISS'); flashBad(); }
          try{ b.remove(); }catch(e){}
          spawn();
          return;
        }
        rafLocal=requestAnimationFrame(fall);
      }
      rafLocal=requestAnimationFrame(fall);

      b.addEventListener('click', ()=>{
        if(!started) return;
        if(b.dataset.kind==='junk'){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        try{ b.remove(); }catch(e){}
        spawn();
      });
    }

    spawn();
  }

  // V3: Speed Plate (choose which item is "healthier" of two)
  function gj_v3_speedplate(){
    gameTitle.textContent='Nutrition Warmup ‚Äî GoodJunk V3: Speed Plate';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏ß‡πà‡∏≤‚Äù ‡∏à‡∏≤‡∏Å 2 ‡∏ï‡∏±‡∏ß (‡∏ú‡∏¥‡∏î = MISS)';
    center.style.display='none';

    const GOOD = ['üçé','ü•¶','ü•õ','üçö','üêü','ü•ö','ü•ë','üçå'];
    const JUNK = ['üçü','üçî','üçï','üç©','üç¨','ü•§','üßã','üç≠'];

    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    wrap.innerHTML=`
      <div style="font-weight:1100;font-size:16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á ‚Äú‡∏î‡∏µ‚Äù</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏ß‡πà‡∏≤</div>
      <div id="pair" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(wrap);
    const pair=wrap.querySelector('#pair');

    function next(){
      total++;
      pair.innerHTML='';
      // 70%: good vs junk, 30%: good vs good (trick) -> then accept either as correct
      const mode = Math.random();
      let leftKind='good', rightKind='junk', eitherGood=false;

      if(mode<0.30){
        leftKind='good'; rightKind='good'; eitherGood=true;
      }else{
        leftKind = (Math.random()<0.5)?'good':'junk';
        rightKind = (leftKind==='good')?'junk':'good';
      }

      const L = (leftKind==='good') ? randPick(GOOD) : randPick(JUNK);
      const R = (rightKind==='good') ? randPick(GOOD) : randPick(JUNK);

      const bL=mkBtn(L), bR=mkBtn(R);
      [bL,bR].forEach(b=>{
        b.style.padding='18px 12px';
        b.style.borderRadius='18px';
        b.style.fontSize='28px';
        b.style.minHeight='90px';
      });
      pair.appendChild(bL); pair.appendChild(bR);

      function choose(which){
        if(!started) return;
        const ok = eitherGood ? true : (which==='L' ? (leftKind==='good') : (rightKind==='good'));
        if(ok){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        next();
      }
      bL.addEventListener('click', ()=>choose('L'));
      bR.addEventListener('click', ()=>choose('R'));
    }
    next();
  }

  // V4: Combo Click (tap 3 good in a row to earn bonus; junk breaks)
  function gj_v4_combo(){
    gameTitle.textContent='Nutrition Warmup ‚Äî GoodJunk V4: Combo Click';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (+2) ‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ = MISS ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö';
    center.style.display='none';

    const GOOD = ['üçé','ü•¶','ü•õ','üçö','üêü','ü•ö','üçå','ü•ë'];
    const JUNK = ['üçü','üçî','üçï','üç©','üç¨','ü•§','üßã'];

    let combo=0;

    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    wrap.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <div style="font-weight:1100;font-size:16px;">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ</div>
        <div class="pill" id="comboPill">COMBO: 0</div>
      </div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>
      <div id="grid" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(wrap);
    const grid=wrap.querySelector('#grid');
    const comboPill=wrap.querySelector('#comboPill');

    function render(){
      grid.innerHTML='';
      // 6 buttons, 4 good, 2 junk shuffled
      const items=[];
      for(let i=0;i<4;i++) items.push({k:'good', emo: randPick(GOOD)});
      for(let i=0;i<2;i++) items.push({k:'junk', emo: randPick(JUNK)});
      for(let i=items.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [items[i],items[j]]=[items[j],items[i]]; }

      items.forEach(it=>{
        const b=mkBtn(it.emo);
        b.style.padding='18px 12px';
        b.style.borderRadius='18px';
        b.style.fontSize='28px';
        b.style.minHeight='86px';
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(it.k==='good'){
            score++; combo++;
            toastShow('+1'); flashGood();
            if(combo>=3){
              score += 2;
              combo = 0;
              toastShow('+BONUS'); flashGood();
            }
          }else{
            miss++; combo = 0;
            toastShow('MISS'); flashBad();
          }
          comboPill.textContent = 'COMBO: ' + combo;
          render();
        });
        grid.appendChild(b);
      });
    }
    render();
  }

  // V5: Memory Flip (find matching good pairs quickly; mismatch = miss)
  function gj_v5_memory(){
    gameTitle.textContent='Nutrition Warmup ‚Äî GoodJunk V5: Memory Flip';
    desc.textContent='‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏≤ ‚Äú‡∏Ñ‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠ (‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏ú‡∏¥‡∏î = MISS)';
    center.style.display='none';

    const GOOD = ['üçé','ü•¶','ü•õ','üçö','üêü','ü•ö','üçå','ü•ë'];

    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    wrap.innerHTML=`
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏î‡∏µ</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏õ‡∏¥‡∏î 2 ‡πÉ‡∏ö ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏π‡πà‡∏ï‡∏£‡∏á = +1 ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á = MISS</div>
      <div id="board" style="margin-top:12px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(wrap);
    const board=wrap.querySelector('#board');

    let cards=[];
    let open=[];
    function resetBoard(){
      const picks=[];
      while(picks.length<8){
        const a=randPick(GOOD);
        if(!picks.includes(a)) picks.push(a);
      }
      cards = picks.concat(picks).map(emo=>({emo, open:false, done:false}));
      for(let i=cards.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [cards[i],cards[j]]=[cards[j],cards[i]]; }
      open=[];
      render();
    }

    function render(){
      board.innerHTML='';
      cards.forEach((c,idx)=>{
        const b=mkBtn(c.done ? c.emo : (c.open ? c.emo : '‚ùì'));
        b.style.padding='16px 10px';
        b.style.borderRadius='18px';
        b.style.fontSize='26px';
        b.style.minHeight='78px';
        b.disabled = c.done;
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(c.done || c.open) return;
          total++;
          c.open=true;
          open.push(idx);
          render();

          if(open.length===2){
            const a=cards[open[0]], d=cards[open[1]];
            if(a.emo===d.emo){
              score++; toastShow('+1'); flashGood();
              a.done=true; d.done=true;
              a.open=false; d.open=false;
              open=[];
              // if all done -> reset (keeps loop going)
              if(cards.every(x=>x.done)){
                resetBoard();
                return;
              }
              render();
            }else{
              miss++; toastShow('MISS'); flashBad();
              const aa=open[0], bb=open[1];
              open=[];
              setTimeout(()=>{
                cards[aa].open=false;
                cards[bb].open=false;
                render();
              }, 260);
            }
          }
        });
        board.appendChild(b);
      });
    }

    resetBoard();
  }

  // ---------------- NUTRITION: groups (5 ‡∏´‡∏°‡∏π‡πà) ----------------
  // V1: 5 ‡∏´‡∏°‡∏π‡πà Snap Match (from your previous)
  function gr_v1_snapmatch(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Groups V1: 5 ‡∏´‡∏°‡∏π‡πà Snap Match';
    desc.textContent='‡∏î‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ ‚Äú‡∏´‡∏°‡∏π‡πà 1‚Äì5‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ)';
    center.style.display='none';

    // mapping ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ: ‡∏´‡∏°‡∏π‡πà1 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô, ‡∏´‡∏°‡∏π‡πà2 ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö, ‡∏´‡∏°‡∏π‡πà3 ‡∏ú‡∏±‡∏Å, ‡∏´‡∏°‡∏π‡πà4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ, ‡∏´‡∏°‡∏π‡πà5 ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô
    const pool = [
      {emo:'ü•ö', g:1},{emo:'üêü', g:1},{emo:'ü•õ', g:1},{emo:'ü•ú', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},{emo:'ü•î', g:2},{emo:'üç†', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},{emo:'ü•í', g:3},{emo:'ü•ï', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},{emo:'üçâ', g:4},{emo:'üçä', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},{emo:'ü´í', g:5},{emo:'ü••', g:5},
    ];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:18px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£: <span id="it" style="font-size:36px;">ü•ö</span></div>
      <div class="muted" id="lbl" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>`;
    stage.appendChild(card);

    const pad=mkPad(5);
    const labels=['‡∏´‡∏°‡∏π‡πà1','‡∏´‡∏°‡∏π‡πà2','‡∏´‡∏°‡∏π‡πà3','‡∏´‡∏°‡∏π‡πà4','‡∏´‡∏°‡∏π‡πà5'];

    let cur = randPick(pool);
    function next(){
      total++;
      cur = randPick(pool);
      card.querySelector('#it').textContent = cur.emo;
      card.querySelector('#lbl').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
    }
    function choose(g){
      if(!started) return;
      if(g===cur.g){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }

    labels.forEach((t,i)=>{
      const b=mkBtn(t);
      b.style.padding='12px 8px';
      b.style.borderRadius='14px';
      b.style.fontWeight='1100';
      b.style.fontSize='12px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>choose(i+1));
    });

    next();
  }

  // V2..V5 for groups: for now, we keep distinct flavors but same core (no external deps)
  function gr_v2_twochoices(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Groups V2: Two-Choice';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‚Äù ‡∏à‡∏≤‡∏Å 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏£‡πá‡∏ß/‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)';
    center.style.display='none';

    const pool = [
      {emo:'ü•ö', g:1},{emo:'üêü', g:1},{emo:'ü•õ', g:1},{emo:'ü•ú', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},{emo:'ü•î', g:2},{emo:'üç†', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},{emo:'ü•í', g:3},{emo:'ü•ï', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},{emo:'üçâ', g:4},{emo:'üçä', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},{emo:'ü´í', g:5},{emo:'ü••', g:5},
    ];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(620px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£: <span id="it" style="font-size:42px;">üçö</span></div>
      <div class="muted" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≤‡∏Å 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      <div id="pair" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(card);
    const pair=card.querySelector('#pair');

    let cur = randPick(pool);
    function next(){
      total++;
      cur = randPick(pool);
      card.querySelector('#it').textContent = cur.emo;

      pair.innerHTML='';
      const wrong = ((cur.g + (1 + ((Math.random()*4)|0))) - 1) % 5 + 1;
      const opts = Math.random()<0.5 ? [cur.g, wrong] : [wrong, cur.g];

      opts.forEach(g=>{
        const b=mkBtn('‡∏´‡∏°‡∏π‡πà ' + g);
        b.style.padding='14px 12px';
        b.style.borderRadius='16px';
        pair.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(g===cur.g){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          next();
        });
      });
    }
    next();
  }

  function gr_v3_sort5bins(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Groups V3: Sort to 5 Bins';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏±‡∏á‡∏´‡∏°‡∏π‡πà 1‚Äì5 (‡∏à‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ)';
    // reuse V1 (same mechanics) but title differs
    gr_v1_snapmatch();
  }
  function gr_v4_speedround(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Groups V4: Speed Round';
    desc.textContent='‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ú‡∏¥‡∏î = MISS)';
    // reuse V2
    gr_v2_twochoices();
  }
  function gr_v5_flashcards(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Groups V5: Flash Cards';
    desc.textContent='‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
    // reuse V1
    gr_v1_snapmatch();
  }

  // ---------------- NUTRITION: hydration ----------------
  // V1: Sip Rhythm (from your previous)
  function hy_v1_siprhythm(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Hydration V1: Sip Rhythm';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô ‚Äú‡∏à‡∏∏‡∏î‚Äù ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏ß‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞';
    center.style.display='none';

    const ring=DOC.createElement('div');
    Object.assign(ring.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'240px',height:'240px',borderRadius:'999px',
      border:'2px solid rgba(56,189,248,.35)',
      background:'radial-gradient(circle at 50% 50%, rgba(34,197,94,.12) 0 34%, transparent 35% 100%)'
    });
    stage.appendChild(ring);

    const dot=DOC.createElement('div');
    Object.assign(dot.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'16px',height:'16px',borderRadius:'999px',
      background:'rgba(251,113,133,.95)'
    });
    stage.appendChild(dot);

    let t=0;
    function anim(){
      if(!started) return;
      const played = dur - tLeft;
      const sp = 0.085 + Math.min(0.06, played*0.002);
      t += sp;
      const r=96;
      const x=Math.cos(t)*r;
      const y=Math.sin(t)*r;
      dot.style.marginLeft = x+'px';
      dot.style.marginTop  = (y-30)+'px';
      const dist=Math.hypot(x,y);
      dot.dataset.inzone = (dist < 34) ? '1' : '0';
      rafLocal = requestAnimationFrame(anim);
    }
    stage.addEventListener('pointerdown', ()=>{
      if(!started) return;
      total++;
      if(dot.dataset.inzone==='1'){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
    }, {passive:true});

    rafLocal = requestAnimationFrame(anim);
  }

  // V2: Cup Catch (tap only when cup icon appears)
  function hy_v2_cupcatch(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Hydration V2: Cup Catch';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô ‚Äú‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‚Äù ‡πÇ‡∏ú‡∏•‡πà (‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô = MISS)';
    center.style.display='none';

    const box=DOC.createElement('div');
    Object.assign(box.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    box.innerHTML=`
      <div style="font-weight:1100;font-size:16px;">‡∏à‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      <div id="icon" style="margin-top:10px;font-size:64px;">‚Ä¶</div>
    `;
    stage.appendChild(box);
    const icon=box.querySelector('#icon');

    let showing=false;
    let nextAt=0;

    function step(){
      if(!started) return;
      const now = Date.now();
      if(now>=nextAt){
        showing = !showing;
        icon.textContent = showing ? 'ü•§' : '‚Ä¶';
        const base = showing ? 550 : 350;
        const jitter = (Math.random()*260)|0;
        nextAt = now + base + jitter;
      }
      rafLocal=requestAnimationFrame(step);
    }

    stage.addEventListener('pointerdown', ()=>{
      if(!started) return;
      total++;
      if(showing){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
    }, {passive:true});

    nextAt = Date.now() + 400;
    rafLocal=requestAnimationFrame(step);
  }

  // V3: Thirst Meter (keep pointer in green zone by tapping)
  function hy_v3_meter(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Hydration V3: Thirst Meter';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ‚Äú‡πÇ‡∏ã‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù (‡∏´‡∏•‡∏∏‡∏î = MISS)';
    center.style.display='none';

    const box=DOC.createElement('div');
    Object.assign(box.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(560px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    box.innerHTML=`
      <div style="font-weight:1100;font-size:16px;">‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥ / ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏à‡∏∞‡∏•‡∏î‡πÄ‡∏≠‡∏á</div>
      <div id="track" style="margin:14px auto 0;width:min(440px,92%);height:18px;border-radius:999px;
        border:1px solid rgba(148,163,184,.18);background: rgba(148,163,184,.12); position:relative; overflow:hidden;">
        <div style="position:absolute;left:35%;top:0;width:30%;height:100%;background: rgba(34,197,94,.18);
          border-left:1px solid rgba(34,197,94,.25); border-right:1px solid rgba(34,197,94,.25);"></div>
        <div id="bar" style="position:absolute;left:10%;top:2px;width:18px;height:14px;border-radius:999px;background: rgba(56,189,248,.92);"></div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:11px;">‡πÇ‡∏ã‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°, ‡∏ô‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô = MISS (‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞)</div>
    `;
    stage.appendChild(box);
    const track=box.querySelector('#track');
    const bar=box.querySelector('#bar');

    let x=0.12; // 0..1
    let v=-0.002;

    function inGreen(){ return x>=0.35 && x<=0.65; }

    function step(){
      if(!started) return;
      // natural drain
      x += v;
      x = Math.max(0.02, Math.min(0.98, x));
      const w = track.getBoundingClientRect().width;
      bar.style.left = Math.round(x*w) + 'px';

      // score tick
      total++;
      if(inGreen()){ score++; flashGood(); }
      else { miss++; flashBad(); }

      rafLocal=requestAnimationFrame(step);
    }

    stage.addEventListener('pointerdown', ()=>{
      if(!started) return;
      // tap increases x
      x = Math.min(0.98, x + 0.08);
      toastShow('SIP'); flashGood();
    }, {passive:true});

    rafLocal=requestAnimationFrame(step);
  }

  // V4: Clean vs Sweet (tap water vs sugary drink)
  function hy_v4_choice(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Hydration V4: Water Choice';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‚Äù (ü•§/üíß) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≤‡∏Å 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    center.style.display='none';

    const good=['üíß','üö∞','ü•õ']; // include milk as ‚Äúok‚Äù
    const bad=['üßã','ü•§','ü•∂ü•§','üçπ','ü•§üßä'];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(680px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML=`
      <div style="font-weight:1100;font-size:16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏ß‡πà‡∏≤</div>
      <div class="muted" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥/‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏≤‡∏ô</div>
      <div id="pair" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(card);
    const pair=card.querySelector('#pair');

    let Lkind='good', Rkind='bad';
    function next(){
      total++;
      pair.innerHTML='';
      Lkind = Math.random()<0.5?'good':'bad';
      Rkind = (Lkind==='good')?'bad':'good';
      const L = (Lkind==='good') ? randPick(good) : randPick(bad);
      const R = (Rkind==='good') ? randPick(good) : randPick(bad);

      const bL=mkBtn(L), bR=mkBtn(R);
      [bL,bR].forEach(b=>{
        b.style.padding='18px 12px';
        b.style.borderRadius='18px';
        b.style.fontSize='30px';
        b.style.minHeight='92px';
      });
      pair.appendChild(bL); pair.appendChild(bR);

      bL.addEventListener('click', ()=>{
        if(!started) return;
        if(Lkind==='good'){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        next();
      });
      bR.addEventListener('click', ()=>{
        if(!started) return;
        if(Rkind==='good'){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        next();
      });
    }
    next();
  }

  // V5: Tap to Fill (tap repeatedly; missing taps is fine, but over-tap triggers miss)
  function hy_v5_fill(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Hydration V5: Fill the Bottle';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏ß‡∏î‡πÉ‡∏´‡πâ ‚Äú‡∏û‡∏≠‡∏î‡∏µ‚Äù (‡πÄ‡∏Å‡∏¥‡∏ô = MISS)';
    center.style.display='none';

    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(620px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    wrap.innerHTML=`
      <div style="font-weight:1100;font-size:16px;">‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÄ‡∏•‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á = MISS)</div>
      <div id="tank" style="margin:12px auto 0;width:120px;height:240px;border-radius:18px;
        border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.25);position:relative;overflow:hidden;">
        <div style="position:absolute;left:0;right:0;bottom:62%;height:2px;background:rgba(34,197,94,.55);"></div>
        <div style="position:absolute;left:0;right:0;bottom:78%;height:2px;background:rgba(251,113,133,.55);"></div>
        <div id="water" style="position:absolute;left:0;right:0;bottom:0;height:20%;background:rgba(56,189,248,.35);"></div>
      </div>
      <div class="muted" id="lvl" style="margin-top:8px;font-weight:1000;">LEVEL: 20%</div>
    `;
    stage.appendChild(wrap);
    const water=wrap.querySelector('#water');
    const lvl=wrap.querySelector('#lvl');

    let level=20; // %
    function render(){
      water.style.height = level + '%';
      lvl.textContent = 'LEVEL: ' + level + '%';
    }
    function drain(){
      if(!started) return;
      level = Math.max(0, level - 0.18);
      render();
      rafLocal=requestAnimationFrame(drain);
    }
    stage.addEventListener('pointerdown', ()=>{
      if(!started) return;
      total++;
      level = Math.min(100, level + 6);
      // evaluate
      if(level>=78){
        miss++; toastShow('MISS'); flashBad();
        level = 20; // reset
      }else if(level>=62){
        score++; toastShow('+1'); flashGood();
      }else{
        // neutral tap
        toastShow('SIP'); flashGood();
      }
      render();
    }, {passive:true});

    render();
    rafLocal=requestAnimationFrame(drain);
  }

  // ---------------- NUTRITION: plate ----------------
  // V1: Plate Builder (from your previous)
  function pl_v1_builder(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Plate V1: Plate Builder';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ ‚Äú‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏´‡∏°‡∏π‡πà‚Äù (‡∏ã‡πâ‡∏≥‡∏´‡∏°‡∏π‡πà = MISS)';
    center.style.display='none';

    const picked=new Set();
    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô</div>
      <div class="muted" id="pb" style="margin-top:6px;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‚â• 3 ‡∏´‡∏°‡∏π‡πà</div>
      <div style="margin-top:10px;font-size:34px;">üçΩÔ∏è</div>`;
    stage.appendChild(card);

    const items=[
      {emo:'üêü', g:1},{emo:'ü•õ', g:1},
      {emo:'üçö', g:2},{emo:'üçû', g:2},
      {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},
      {emo:'üçé', g:4},{emo:'üçå', g:4},
      {emo:'ü•ë', g:5},{emo:'üßà', g:5},
    ];

    const pad=mkPad(5);
    items.forEach(it=>{
      const b=mkBtn(it.emo);
      b.style.padding='14px 8px'; b.style.borderRadius='16px';
      b.style.fontSize='18px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>{
        if(!started) return;
        total++;
        if(!picked.has(it.g)){
          picked.add(it.g); score++; toastShow('+1'); flashGood();
        }else{
          miss++; toastShow('MISS'); flashBad();
        }
        card.querySelector('#pb').textContent = `‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${picked.size} ‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‚â• 3)`;
      });
    });
  }

  // V2: Balanced 4 zones (choose missing group)
  function pl_v2_missinggroup(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Plate V2: Missing Group';
    desc.textContent='‡∏î‡∏π‡∏à‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å (‡∏ú‡∏¥‡∏î = MISS)';
    center.style.display='none';

    const groups=[1,2,3,4,5];
    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    card.innerHTML=`
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏´‡∏°‡∏π‡πà‡πÑ‡∏´‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ?</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏≤‡∏ô</div>
      <div id="plate" style="margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;font-size:30px;"></div>
      <div id="pad" style="margin-top:12px;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;"></div>
    `;
    stage.appendChild(card);
    const plate=card.querySelector('#plate');
    const pad=card.querySelector('#pad');

    const pool = {
      1:['ü•ö','üêü','ü•õ','ü•ú'],
      2:['üçö','üçû','ü•î','üç†'],
      3:['ü•¶','ü•¨','ü•ï','ü•í'],
      4:['üçé','üçå','üçâ','üçä'],
      5:['ü•ë','üßà','ü´í','ü••'],
    };

    let missing=1;
    function next(){
      total++;
      plate.innerHTML='';
      const missIdx = ((Math.random()*5)|0)+1;
      missing = missIdx;

      // show 4 groups on plate
      groups.filter(g=>g!==missing).forEach(g=>{
        const s=DOC.createElement('span');
        s.textContent = randPick(pool[g]);
        plate.appendChild(s);
      });

      // render choices
      pad.innerHTML='';
      groups.forEach(g=>{
        const b=mkBtn('‡∏´‡∏°‡∏π‡πà'+g);
        b.style.padding='12px 8px';
        b.style.borderRadius='14px';
        b.style.fontSize='12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(g===missing){ score++; toastShow('+1'); flashGood(); }
          else{ miss++; toastShow('MISS'); flashBad(); }
          next();
        });
      });
    }
    next();
  }

  // V3: Portion tap (tap to add veggies; too much sugar triggers miss)
  function pl_v3_portion(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Plate V3: Portion Control';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏ú‡∏±‡∏Å‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô = MISS)';
    center.style.display='none';

    let veg=0, sugar=0;
    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    wrap.innerHTML=`
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏Ñ‡∏∏‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ‚â• 3 ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏° | ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 2 = MISS</div>
      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
        <div class="k"><div class="h">VEG</div><div class="v" id="vegV">0</div></div>
        <div class="k"><div class="h">SUGAR</div><div class="v" id="sugV">0</div></div>
      </div>
      <div id="pad" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(wrap);
    const vegV=wrap.querySelector('#vegV');
    const sugV=wrap.querySelector('#sugV');
    const pad=wrap.querySelector('#pad');

    const bVeg=mkBtn('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å ü•¶');
    const bSug=mkBtn('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ß‡∏≤‡∏ô üç¨');
    [bVeg,bSug].forEach(b=>{
      b.style.padding='16px 12px';
      b.style.borderRadius='18px';
      b.style.fontSize='16px';
      pad.appendChild(b);
    });

    function render(){
      vegV.textContent=String(veg);
      sugV.textContent=String(sugar);
    }

    bVeg.addEventListener('click', ()=>{
      if(!started) return;
      total++;
      veg++;
      if(veg>=3){ score++; toastShow('+1'); flashGood(); veg=0; sugar=0; }
      render();
    });

    bSug.addEventListener('click', ()=>{
      if(!started) return;
      total++;
      sugar++;
      if(sugar>2){ miss++; toastShow('MISS'); flashBad(); veg=0; sugar=0; }
      render();
    });

    render();
  }

  // V4: Speed add (tap 3 different groups quickly; repeats miss)
  function pl_v4_speedadd(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Plate V4: Speed Add';
    desc.textContent='‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 3 ‡∏´‡∏°‡∏π‡πà ‚Äú‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‚Äù (‡∏ã‡πâ‡∏≥ = MISS) ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
    // reuse V1 builder (same rule) but keep title
    pl_v1_builder();
  }

  // V5: Quiz (which is better balanced plate)
  function pl_v5_quiz(){
    gameTitle.textContent='Nutrition Warmup ‚Äî Plate V5: Balanced Quiz';
    desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‚Äú‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Å‡∏ß‡πà‡∏≤‚Äù ‡∏à‡∏≤‡∏Å 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    center.style.display='none';

    const wrap=DOC.createElement('div');
    Object.assign(wrap.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    wrap.innerHTML=`
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏à‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Å‡∏ß‡πà‡∏≤?</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤</div>
      <div id="pair" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;"></div>
    `;
    stage.appendChild(wrap);
    const pair=wrap.querySelector('#pair');

    function mkPlate(groupsCount){
      const all=['ü•ö','üçö','ü•¶','üçé','ü•ë'];
      const picks=[];
      for(let i=0;i<groupsCount;i++){
        picks.push(all[i]);
      }
      // shuffle display a bit
      for(let i=picks.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [picks[i],picks[j]]=[picks[j],picks[i]]; }
      return picks.join(' ');
    }

    function next(){
      total++;
      pair.innerHTML='';
      const g1 = 2 + ((Math.random()*2)|0); // 2..3
      const g2 = 4 + ((Math.random()*2)|0); // 4..5
      const leftBetter = Math.random()<0.5;
      const L = leftBetter ? mkPlate(g2) : mkPlate(g1);
      const R = leftBetter ? mkPlate(g1) : mkPlate(g2);

      const bL=mkBtn(L), bR=mkBtn(R);
      [bL,bR].forEach(b=>{
        b.style.padding='18px 12px';
        b.style.borderRadius='18px';
        b.style.fontSize='22px';
        b.style.minHeight='96px';
        b.style.whiteSpace='normal';
        b.style.lineHeight='1.2';
      });
      pair.appendChild(bL); pair.appendChild(bR);

      bL.addEventListener('click', ()=>{
        if(!started) return;
        if(leftBetter){ score++; toastShow('+1'); flashGood(); }
        else{ miss++; toastShow('MISS'); flashBad(); }
        next();
      });
      bR.addEventListener('click', ()=>{
        if(!started) return;
        if(!leftBetter){ score++; toastShow('+1'); flashGood(); }
        else{ miss++; toastShow('MISS'); flashBad(); }
        next();
      });
    }
    next();
  }

  // ---------------- HYGIENE ----------------
  // handwash V1..V5
  function hw_v1_order(){
    gameTitle.textContent='Hygiene Warmup ‚Äî Handwash V1: Wash Steps Order';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‚Äú‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å (‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡πá‡∏ß ‡πÜ)';
    center.style.display='none';

    const steps = ['‡∏ñ‡∏π‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠','‡∏ñ‡∏π‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠','‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß','‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏¥‡πâ‡∏ß','‡∏ñ‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á','‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß/‡πÄ‡∏•‡πá‡∏ö'];
    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'42%',transform:'translate(-50%,-50%)',
      width:'min(720px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 1 ‚Üí 3</div>
      <div class="muted" id="hwq" style="margin-top:6px;">‚Äî</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);

    let order=[], idx=0;
    function newRound(){
      idx=0;
      const s=[...steps];
      order=[];
      while(order.length<3){
        const pick=s.splice((Math.random()*s.length)|0,1)[0];
        order.push(pick);
      }
      card.querySelector('#hwq').textContent = `‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‚ë† ${order[0]} ‚Üí ‚ë° ${order[1]} ‚Üí ‚ë¢ ${order[2]}`;
      pad.innerHTML='';
      const decoy = steps.filter(x=>!order.includes(x));
      const opts=[...order, randPick(decoy)];
      for(let i=opts.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(txt=>{
        const b=mkBtn(txt);
        b.style.padding='14px 12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(txt===order[idx]){
            idx++; score++; toastShow('+1'); flashGood();
            if(idx>=3) newRound();
          }else{
            miss++; toastShow('MISS'); flashBad();
          }
        });
      });
    }
    newRound();
  }
  function hw_v2_spots(){ gameTitle.textContent='Hygiene Warmup ‚Äî Handwash V2'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; hw_v1_order(); }
  function hw_v3_timer(){ gameTitle.textContent='Hygiene Warmup ‚Äî Handwash V3'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; hw_v1_order(); }
  function hw_v4_germs(){ gameTitle.textContent='Hygiene Warmup ‚Äî Handwash V4'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; hw_v1_order(); }
  function hw_v5_combo(){ gameTitle.textContent='Hygiene Warmup ‚Äî Handwash V5'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; hw_v1_order(); }

  // brush V1..V5
  function br_v1_angle(){
    gameTitle.textContent='Hygiene Warmup ‚Äî Brush V1: Brush Angle Accuracy';
    desc.textContent='‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ ‚Äú‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏ó‡∏¥‡∏®‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å (‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤/‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á)';
    center.style.display='none';

    const pos = [
      {q:'‡∏ö‡∏ô-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏ö‡∏ô'}, {q:'‡∏ö‡∏ô-‡∏Ç‡∏ß‡∏≤', a:'‡∏ö‡∏ô'},
      {q:'‡∏•‡πà‡∏≤‡∏á-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏•‡πà‡∏≤‡∏á'}, {q:'‡∏•‡πà‡∏≤‡∏á-‡∏Ç‡∏ß‡∏≤', a:'‡∏•‡πà‡∏≤‡∏á'},
      {q:'‡πÅ‡∏Å‡πâ‡∏°-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏ã‡πâ‡∏≤‡∏¢'}, {q:'‡πÅ‡∏Å‡πâ‡∏°-‡∏Ç‡∏ß‡∏≤', a:'‡∏Ç‡∏ß‡∏≤'},
    ];
    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="bq" style="font-size:18px;">‚Äî</span></div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);
    const choices=['‡∏ö‡∏ô','‡∏•‡πà‡∏≤‡∏á','‡∏ã‡πâ‡∏≤‡∏¢','‡∏Ç‡∏ß‡∏≤'];

    let cur = randPick(pos);
    function next(){
      total++;
      cur = randPick(pos);
      card.querySelector('#bq').textContent = cur.q;
    }
    choices.forEach(c=>{
      const b=mkBtn(c);
      b.style.padding='14px 12px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>{
        if(!started) return;
        if(c===cur.a){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        next();
      });
    });

    next();
  }
  function br_v2_zone(){ gameTitle.textContent='Hygiene Warmup ‚Äî Brush V2'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; br_v1_angle(); }
  function br_v3_combo(){ gameTitle.textContent='Hygiene Warmup ‚Äî Brush V3'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; br_v1_angle(); }
  function br_v4_timer(){ gameTitle.textContent='Hygiene Warmup ‚Äî Brush V4'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; br_v1_angle(); }
  function br_v5_quiz(){ gameTitle.textContent='Hygiene Warmup ‚Äî Brush V5'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; br_v1_angle(); }

  // maskcough V1..V5
  function mc_v1_choice(){
    gameTitle.textContent='Hygiene Warmup ‚Äî MaskCough V1: Choice';
    desc.textContent='‡∏™‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å (‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å/‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å/‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞)';
    center.style.display='none';

    const cases = [
      {q:'‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏≠‡∏±‡∏î', ok:'‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', emo:'üò∑'},
      {q:'‡πÑ‡∏≠/‡∏à‡∏≤‡∏°‡∏Å‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô', ok:'‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å', emo:'ü§ß'},
      {q:'‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô', ok:'‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞', emo:'‚ÜîÔ∏è'},
      {q:'‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', ok:'‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', emo:'üè´'},
      {q:'‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', ok:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠', emo:'üßº'},
    ];
    const actions=['‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å','‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞','‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠'];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(620px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
      <div id="mq" style="margin-top:8px;font-size:18px;font-weight:1000;">‚Äî</div>
      <div id="me" style="margin-top:6px;font-size:40px;">üò∑</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);
    let cur=randPick(cases);
    function next(){
      total++;
      cur=randPick(cases);
      card.querySelector('#mq').textContent = cur.q;
      card.querySelector('#me').textContent = cur.emo;
    }
    actions.forEach(a=>{
      const b=mkBtn(a);
      b.style.padding='14px 12px';
      pad.appendChild(b);
      b.addEventListener('click', ()=>{
        if(!started) return;
        if(a===cur.ok){ score++; toastShow('+1'); flashGood(); }
        else { miss++; toastShow('MISS'); flashBad(); }
        next();
      });
    });
    next();
  }
  function mc_v2_fast(){ gameTitle.textContent='Hygiene Warmup ‚Äî MaskCough V2'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; mc_v1_choice(); }
  function mc_v3_signs(){ gameTitle.textContent='Hygiene Warmup ‚Äî MaskCough V3'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; mc_v1_choice(); }
  function mc_v4_distance(){ gameTitle.textContent='Hygiene Warmup ‚Äî MaskCough V4'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; mc_v1_choice(); }
  function mc_v5_combo(){ gameTitle.textContent='Hygiene Warmup ‚Äî MaskCough V5'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; mc_v1_choice(); }

  // germ V1..V5
  function ge_v1_detect(){
    gameTitle.textContent='Hygiene Warmup ‚Äî Germ V1: Germ Detective';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏Å)';
    center.style.display='none';

    const board=DOC.createElement('div');
    Object.assign(board.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',aspectRatio:'1/1',
      display:'grid',gridTemplateColumns:'repeat(4, minmax(0,1fr))',gap:'10px'});
    stage.appendChild(board);

    function spawnCells(){
      board.innerHTML='';
      const idxG = (Math.random()*16)|0;
      let idxD = (Math.random()*16)|0; if(idxD===idxG) idxD=(idxD+5)%16;

      for(let i=0;i<16;i++){
        const b=DOC.createElement('button');
        b.className='btn';
        b.style.height='100%';
        b.style.borderRadius='16px';
        b.style.fontSize='22px';
        b.style.background='rgba(2,6,23,.35)';
        b.style.border='1px solid rgba(148,163,184,.18)';
        b.style.padding='0';
        let kind='blank';
        if(i===idxG){ b.textContent='ü¶†'; kind='germ'; }
        else if(i===idxD){ b.textContent='‚ú®'; kind='decoy'; }
        else b.textContent='¬∑';

        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(kind==='germ'){ score++; toastShow('+1'); flashGood(); }
          else { miss++; toastShow('MISS'); flashBad(); }
          spawnCells();
        });
        board.appendChild(b);
      }
    }
    spawnCells();
  }
  function ge_v2_spread(){ gameTitle.textContent='Hygiene Warmup ‚Äî Germ V2'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; ge_v1_detect(); }
  function ge_v3_hide(){ gameTitle.textContent='Hygiene Warmup ‚Äî Germ V3'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; ge_v1_detect(); }
  function ge_v4_flash(){ gameTitle.textContent='Hygiene Warmup ‚Äî Germ V4'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; ge_v1_detect(); }
  function ge_v5_boss(){ gameTitle.textContent='Hygiene Warmup ‚Äî Germ V5'; desc.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÉ‡∏ä‡πâ V1 engine)'; ge_v1_detect(); }

  // ---------------- EXERCISE ----------------
  function ex_v1_dodge(){
    gameTitle.textContent='Exercise Warmup ‚Äî Shadow V1: Dodge & Strike';
    desc.textContent='‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡πà‡∏° ‚Äú‡∏ï‡∏µ‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏´‡∏•‡∏ö‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
      <div id="sx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚öîÔ∏è</div>
      <div id="st" style="margin-top:8px;font-size:18px;font-weight:1100;">‚Äî</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);
    const btnHit=mkBtn('‡∏ï‡∏µ'); const btnDodge=mkBtn('‡∏´‡∏•‡∏ö');
    btnHit.style.padding='14px 12px'; btnDodge.style.padding='14px 12px';
    pad.appendChild(btnHit); pad.appendChild(btnDodge);

    let cur='‡∏ï‡∏µ';
    function next(){
      total++;
      cur = (Math.random()<0.5)?'‡∏ï‡∏µ':'‡∏´‡∏•‡∏ö';
      card.querySelector('#st').textContent = `‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${cur}`;
      card.querySelector('#sx').textContent = (cur==='‡∏ï‡∏µ')?'ü•ä':'ü´£';
    }
    function choose(a){
      if(!started) return;
      if(a===cur){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }
    btnHit.addEventListener('click', ()=>choose('‡∏ï‡∏µ'));
    btnDodge.addEventListener('click', ()=>choose('‡∏´‡∏•‡∏ö'));
    next();
  }

  function ex_v1_rhythm(){
    gameTitle.textContent='Exercise Warmup ‚Äî Rhythm V1: Beat Punch';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ ‚Äú‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‚Äù';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(620px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
      <div id="rx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚¨ÖÔ∏è</div>
      <div id="rt" style="margin-top:8px;font-size:18px;font-weight:1100;">‡∏ã‡πâ‡∏≤‡∏¢</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);
    const bL=mkBtn('‡∏ã‡πâ‡∏≤‡∏¢'); const bR=mkBtn('‡∏Ç‡∏ß‡∏≤');
    bL.style.padding='14px 12px'; bR.style.padding='14px 12px';
    pad.appendChild(bL); pad.appendChild(bR);

    let cur='‡∏ã‡πâ‡∏≤‡∏¢';
    function next(){
      total++;
      cur = (Math.random()<0.5)?'‡∏ã‡πâ‡∏≤‡∏¢':'‡∏Ç‡∏ß‡∏≤';
      card.querySelector('#rt').textContent = cur;
      card.querySelector('#rx').textContent = (cur==='‡∏ã‡πâ‡∏≤‡∏¢')?'‚¨ÖÔ∏è':'‚û°Ô∏è';
    }
    function choose(a){
      if(!started) return;
      if(a===cur){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }
    bL.addEventListener('click', ()=>choose('‡∏ã‡πâ‡∏≤‡∏¢'));
    bR.addEventListener('click', ()=>choose('‡∏Ç‡∏ß‡∏≤'));
    next();
  }

  function ex_v1_jumpduck(){
    gameTitle.textContent='Exercise Warmup ‚Äî JumpDuck V1: Jump/Duck Drill';
    desc.textContent='‡∏™‡∏∏‡πà‡∏° ‚ÄúJUMP‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚ÄúDUCK‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
      width:'min(620px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
      <div id="jx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚¨ÜÔ∏è</div>
      <div id="jt" style="margin-top:8px;font-size:18px;font-weight:1100;">JUMP</div>`;
    stage.appendChild(card);

    const pad=mkPad(2);
    const bJ=mkBtn('JUMP'); const bD=mkBtn('DUCK');
    bJ.style.padding='14px 12px'; bD.style.padding='14px 12px';
    pad.appendChild(bJ); pad.appendChild(bD);

    let cur='JUMP';
    function next(){
      total++;
      cur = (Math.random()<0.5)?'JUMP':'DUCK';
      card.querySelector('#jt').textContent = cur;
      card.querySelector('#jx').textContent = (cur==='JUMP')?'‚¨ÜÔ∏è':'‚¨áÔ∏è';
    }
    function choose(a){
      if(!started) return;
      if(a===cur){ score++; toastShow('+1'); flashGood(); }
      else { miss++; toastShow('MISS'); flashBad(); }
      next();
    }
    bJ.addEventListener('click', ()=>choose('JUMP'));
    bD.addEventListener('click', ()=>choose('DUCK'));
    next();
  }

  function ex_v1_balance(){
    gameTitle.textContent='Exercise Warmup ‚Äî Balance V1: Hold Steady Meter';
    desc.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ ‚Äú‡πÅ‡∏ñ‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‚Äù (‡∏õ‡∏•‡πà‡∏≠‡∏¢/‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á = MISS)';
    center.style.display='none';

    const box=DOC.createElement('div');
    Object.assign(box.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    box.innerHTML = `
      <div style="font-weight:1100;font-size:16px;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á</div>
      <div class="muted" style="margin-top:6px;">‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á ‚Üí ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
      <div id="track" style="margin:14px auto 0; width: min(420px,92%); height:14px; border-radius:999px;
        border:1px solid rgba(148,163,184,.18); background: rgba(148,163,184,.12); position:relative; overflow:hidden;">
        <div id="zone" style="position:absolute; left:44%; top:0; width:12%; height:100%;
          background: rgba(34,197,94,.18); border-left:1px solid rgba(34,197,94,.25); border-right:1px solid rgba(34,197,94,.25);"></div>
        <div id="bar" style="position:absolute; left:10%; top:2px; width:18px; height:10px; border-radius:999px; background: rgba(56,189,248,.92);"></div>
      </div>
      <div style="margin-top:12px;">
        <button class="btn primary" id="holdBtn" style="min-width:180px;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á (HOLD)</button>
      </div>
    `;
    stage.appendChild(box);

    const track=box.querySelector('#track');
    const bar=box.querySelector('#bar');
    const holdBtn=box.querySelector('#holdBtn');

    let holding=false;
    let x=0.10;
    let v=0.0;

    function inZone(){ return x>=0.44 && x<=0.56; }

    function step(){
      if(!started) return;
      const played = dur - tLeft;
      const drift = 0.002 + Math.min(0.003, played*0.0002);
      v += (Math.random()-0.5)*drift;

      if(holding){
        v *= 0.92;
        x += v;
        x += (0.50 - x)*0.01;
      }else{
        x += v;
      }
      x = Math.max(0.02, Math.min(0.98, x));

      const w = track.getBoundingClientRect().width;
      bar.style.left = Math.round(x*w) + 'px';

      if(holding){
        total++;
        if(inZone()){ score++; flashGood(); }
        else { miss++; flashBad(); }
      }
      rafLocal = requestAnimationFrame(step);
    }

    holdBtn.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      holding=true;
      holdBtn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á...';
      holdBtn.classList.add('primary');
    });
    WIN.addEventListener('pointerup', ()=>{
      if(!holding) return;
      holding=false;
      holdBtn.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á (HOLD)';
    });

    rafLocal = requestAnimationFrame(step);
  }

  function ex_v1_planner(){
    gameTitle.textContent='Exercise Warmup ‚Äî Planner V1: Plan Sprint';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡∏à‡∏±‡∏î ‚Äú‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 3 ‡∏ä‡πà‡∏ß‡∏á‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏¢‡πá‡∏ô)';
    center.style.display='none';

    const acts=['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß','‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö','‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô','‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ï','‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà','‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå'];
    const slots=['‡πÄ‡∏ä‡πâ‡∏≤','‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô','‡πÄ‡∏¢‡πá‡∏ô'];

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'42%',transform:'translate(-50%,-50%)',
      width:'min(760px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏à‡∏±‡∏î‡πÅ‡∏ú‡∏ô 3 ‡∏ä‡πà‡∏ß‡∏á</div>
      <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏ä‡πà‡∏≠‡∏á (‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á = MISS)</div>
      <div id="slots" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
      <div id="acts" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
    `;
    stage.appendChild(card);

    const slotsEl=card.querySelector('#slots');
    const actsEl=card.querySelector('#acts');

    const chosen = {‡πÄ‡∏ä‡πâ‡∏≤:'',‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô:'',‡πÄ‡∏¢‡πá‡∏ô:''};

    function renderSlots(){
      slotsEl.innerHTML='';
      slots.forEach(s=>{
        const box=DOC.createElement('div');
        box.style.border='1px solid rgba(148,163,184,.18)';
        box.style.borderRadius='16px';
        box.style.background='rgba(2,6,23,.35)';
        box.style.padding='10px 12px';
        box.style.minHeight='60px';
        box.innerHTML = `<div style="font-weight:1100;">${s}</div>
          <div class="muted" style="margin-top:6px;">${chosen[s]||'‡∏ß‡πà‡∏≤‡∏á'}</div>`;
        slotsEl.appendChild(box);

        box.addEventListener('click', ()=>{
          if(!started) return;
          if(chosen[s]){
            total++;
            chosen[s]='';
            miss++; toastShow('MISS'); flashBad();
            renderSlots();
          }
        });
      });
    }

    function renderActs(){
      actsEl.innerHTML='';
      const pick = [];
      while(pick.length<6){
        const a = randPick(acts);
        if(!pick.includes(a)) pick.push(a);
      }
      pick.forEach(a=>{
        const b=mkBtn(a);
        b.style.padding='12px 10px';
        b.style.borderRadius='16px';
        actsEl.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          const s = slots.find(x=>!chosen[x]);
          if(!s){
            miss++; toastShow('MISS'); flashBad();
            return;
          }
          chosen[s]=a;
          score++; toastShow('+1'); flashGood();
          renderSlots();

          if(slots.every(x=>chosen[x])){
            score += 2; toastShow('+BONUS'); flashGood();
          }
        });
      });
    }

    renderSlots();
    renderActs();
  }

  // ---------------- COOLDOWN ----------------
  function runCooldown_Calm(){
    gameTitle.textContent='Cooldown ‚Äî Calm Breathing';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚ÄúIN/OUT‚Äù ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ (‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ)';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(560px,92%)',padding:'14px',borderRadius:'18px',
      border:'1px solid rgba(148,163,184,.18)',background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;">‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞</div>
      <div id="bx" style="margin-top:12px;font-size:56px;">ü´Å</div>
      <div id="bt" style="margin-top:8px;font-size:18px;font-weight:1100;">INHALE</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn primary" id="bin">IN</button>
        <button class="btn" id="bout">OUT</button>
      </div>`;
    stage.appendChild(card);

    const bin=card.querySelector('#bin');
    const bout=card.querySelector('#bout');
    const bt=card.querySelector('#bt');

    let cur='IN';
    function next(){
      total++;
      cur = (Math.random()<0.5)?'IN':'OUT';
      bt.textContent = (cur==='IN')?'INHALE':'EXHALE';
    }
    function choose(a){
      if(!started) return;
      if(a===cur){ score++; flashGood(); toastShow('+1'); }
      else { miss++; flashBad(); toastShow('MISS'); }
      next();
    }
    bin.addEventListener('click', ()=>choose('IN'));
    bout.addEventListener('click', ()=>choose('OUT'));
    next();
  }

  // =====================================================================
  //  Variant router by cat+theme
  // =====================================================================
  const POOLS = {
    nutrition: {
      goodjunk:  [gj_v1_sort, gj_v2_trashdash, gj_v3_speedplate, gj_v4_combo, gj_v5_memory],
      groups:    [gr_v1_snapmatch, gr_v2_twochoices, gr_v3_sort5bins, gr_v4_speedround, gr_v5_flashcards],
      hydration: [hy_v1_siprhythm, hy_v2_cupcatch, hy_v3_meter, hy_v4_choice, hy_v5_fill],
      plate:     [pl_v1_builder, pl_v2_missinggroup, pl_v3_portion, pl_v4_speedadd, pl_v5_quiz],
    },
    hygiene: {
      handwash:  [hw_v1_order, hw_v2_spots, hw_v3_timer, hw_v4_germs, hw_v5_combo],
      brush:     [br_v1_angle, br_v2_zone, br_v3_combo, br_v4_timer, br_v5_quiz],
      maskcough: [mc_v1_choice, mc_v2_fast, mc_v3_signs, mc_v4_distance, mc_v5_combo],
      germ:      [ge_v1_detect, ge_v2_spread, ge_v3_hide, ge_v4_flash, ge_v5_boss],
      // extras you mentioned:
      germprotective: [ge_v1_detect, ge_v2_spread, ge_v3_hide, ge_v4_flash, ge_v5_boss],
      cleanobject:    [hw_v1_order, hw_v2_spots, hw_v3_timer, hw_v4_germs, hw_v5_combo],
    },
    exercise: {
      shadow:   [ex_v1_dodge, ex_v1_dodge, ex_v1_dodge, ex_v1_dodge, ex_v1_dodge],
      rhythm:   [ex_v1_rhythm, ex_v1_rhythm, ex_v1_rhythm, ex_v1_rhythm, ex_v1_rhythm],
      jumpduck: [ex_v1_jumpduck, ex_v1_jumpduck, ex_v1_jumpduck, ex_v1_jumpduck, ex_v1_jumpduck],
      balance:  [ex_v1_balance, ex_v1_balance, ex_v1_balance, ex_v1_balance, ex_v1_balance],
      planner:  [ex_v1_planner, ex_v1_planner, ex_v1_planner, ex_v1_planner, ex_v1_planner],
    }
  };

  function runWarmupByVariant(){
    const zone = POOLS[cat] ? cat : 'nutrition';
    const themePool = (POOLS[zone] && POOLS[zone][themeKey]) ? POOLS[zone][themeKey] : null;

    // fallback theme within zone
    let pool = themePool;
    if(!pool){
      const fallbackTheme = (zone==='hygiene') ? 'handwash' : (zone==='exercise') ? 'jumpduck' : 'goodjunk';
      pool = (POOLS[zone] && POOLS[zone][fallbackTheme]) ? POOLS[zone][fallbackTheme] : POOLS.nutrition.goodjunk;
    }

    const idx = clamp(variant, 1, 5) - 1;
    const fn = pool[idx] || pool[0];
    fn();
  }

  // ---------- Buff generator ----------
  function makeWarmupBuff(){
    const acc = (total>0) ? (score/Math.max(1,total)) : 0;
    const pct = Math.round(clamp(acc*100, 5, 30)); // 5..30
    const rank = (acc>=0.85) ? 'S' : (acc>=0.70) ? 'A' : (acc>=0.55) ? 'B' : 'C';

    let wCrit=0, wDmg=0, wHeal=0;
    // heal-ish themes
    if(themeKey==='hydration' || themeKey==='handwash' || themeKey==='maskcough') wHeal = 1;
    else if(themeKey==='shadow' || themeKey==='rhythm' || themeKey==='jumpduck') wDmg = 1;
    else wCrit = 1;

    return { wType:'warmup', wPct:pct, rank, wCrit, wDmg, wHeal };
  }

  // ---------- Start / Skip ----------
  function start(){
    if(dailyDone){
      autoSkipIfDaily();
      return;
    }

    clearStage();
    score=0; miss=0; total=0;
    tLeft=dur; lastTs=0;
    setHUD();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    if(phase==='cooldown'){
      runCooldown_Calm();
      statusText.textContent = `Cooldown (${dur}s) ‚Äî pid=${pid} cat=${cat}`;
    }else{
      runWarmupByVariant();
      statusText.textContent = `Warmup (${dur}s) ‚Äî cat=${cat} theme=${themeKey} pick=${pickMode} var=${variant}`;
    }

    subLine.textContent = (phase==='cooldown')
      ? '‡πÄ‡∏•‡πà‡∏ô cooldown ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö/‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'
      : '‡πÄ‡∏•‡πà‡∏ô warmup ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';

    rafTick = requestAnimationFrame(tick);
  }

  function skip(){
    const target = (next0 || hub);
    markDaily(dailyPrefix, cat, pid);
    location.replace(target);
  }

  function maybeAutoEnd(){
    if(!started) return;
    if(phase==='cooldown'){
      endNow({ calm: 1 });
    }else{
      endNow(makeWarmupBuff());
    }
  }

  // ---------- UI init ----------
  pillPhase.textContent = `PHASE: ${phase.toUpperCase()}`;
  pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
  pillTheme.textContent = `THEME: ${String(themeKey).toUpperCase()}`;
  pillPick.textContent  = `PICK: ${String(pickMode).toUpperCase()} (${runMode})`;
  pillVar.textContent   = `VAR: ${variant}${forcedVar? ' (forced)':''}`;
  pillDaily.textContent = dailyDone ? 'DAILY: DONE' : 'DAILY: NEW';

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  // tap stage to start
  stage.addEventListener('pointerdown', ()=>{
    if(!started && !dailyDone) start();
  }, {passive:true});

  // auto skip if daily already done
  if(!autoSkipIfDaily()){
    const name = (phase==='cooldown')?'Cooldown':'Warmup';
    subLine.textContent = `${name} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù`;
    statusText.textContent = `ready: pid=${pid} cat=${cat} theme=${themeKey} pick=${pickMode} var=${variant} next=${next0 ? 'yes' : 'hub'}`;
    setHUD();
  }

  // safety: if started and user leaves tab -> end
  WIN.addEventListener('visibilitychange', ()=>{
    if(DOC.hidden && started){
      maybeAutoEnd();
    }
  });

})();
</script>
</body>
</html>