<!-- === /herohealth/warmup-gate.html ===
HeroHealth Warmup/Cooldown Gate ‚Äî P5 UPGRADE FULL (v20260224p5)
‚úÖ root file (as you said)
‚úÖ pick5 policies: theme/game/pick=rand|day + detect from next
‚úÖ daily once-per-day per PID+category for warmup and cooldown
‚úÖ warmup end -> pass buffs (wType/wPct/wCrit/wDmg/wHeal/rank/calm) into next URL
‚úÖ cooldown end -> supports plan sequence passthrough + cdnext chain already in next
‚úÖ NEW (P5): grade=p5 => default dur/cdur=30 (teacher override respected)
‚úÖ NEW: Mission panel (3 daily missions deterministic by day+pid) + bonus
‚úÖ NEW: P5 mini-games: risky/skill-based (streak, decoys, perfect timing)
‚úÖ NEW: Cooldown breath ring timing with perfect window
Works PC/Mobile (tap/click). Safe, no external deps.
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Warmup Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.60);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(900px 650px at 92% 12%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }

    .wrap{
      min-height:100%;
      padding: calc(14px + var(--sat)) calc(12px + var(--sar)) calc(14px + var(--sab)) calc(12px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .shell{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.62));
      border-radius:24px;
      box-shadow:0 16px 60px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .top{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16));
      display:grid; place-items:center; font-weight:1000;
    }
    .title{font-weight:1000}
    .sub{font-size:12px; color:var(--muted); font-weight:800; margin-top:2px}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:1000;
      white-space:nowrap;
    }

    .main{
      display:grid; grid-template-columns: 1.2fr .8fr;
      gap:0;
    }
    @media (max-width: 860px){ .main{ grid-template-columns:1fr; } }

    .play{
      position:relative;
      min-height:560px;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(700px 320px at 50% 10%, rgba(34,211,238,.06), transparent 70%),
        linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.06));
      overflow:hidden;
    }
    @media (max-width: 860px){
      .play{ border-right:none; border-bottom:1px solid var(--stroke); min-height:520px; }
    }

    .hud{
      position:absolute; left:10px; right:10px; top:10px;
      display:grid; grid-template-columns: repeat(5, minmax(0,1fr));
      gap:8px;
      z-index:4;
    }
    .hud .box{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.38);
      border-radius:14px;
      padding:8px 10px;
      text-align:center;
    }
    .hud .k{font-size:10px; color:var(--muted); font-weight:900}
    .hud .v{margin-top:4px; font-size:15px; font-weight:1100}
    @media (max-width:560px){
      .hud{ grid-template-columns:repeat(3,minmax(0,1fr)); top:8px; left:8px; right:8px; }
    }

    .stage{
      position:absolute; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
    }

    .center{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:2;
      pointer-events:none;
    }
    .center .big{
      font-size:64px; line-height:1;
      filter:drop-shadow(0 8px 24px rgba(0,0,0,.35));
    }
    .center .hint{
      margin-top:8px;
      color:rgba(229,231,235,.85);
      font-weight:900;
      font-size:14px;
    }

    .flash{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .12s ease;
      z-index:5;
    }
    .flash.good{ background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.16), rgba(34,197,94,0)); }
    .flash.bad{  background:radial-gradient(circle at 50% 50%, rgba(239,68,68,.16), rgba(239,68,68,0)); }

    .toast{
      position:absolute; left:50%; top:78px; transform:translateX(-50%) translateY(-6px);
      z-index:6;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.78);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px; font-weight:1100;
      opacity:0;
      transition:all .12s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .side{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
      background:rgba(2,6,23,.22);
    }
    .card{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.34);
      border-radius:18px;
      padding:12px;
    }
    .card h3{
      margin:0;
      font-size:14px;
      font-weight:1000;
    }
    .muted{
      color:rgba(229,231,235,.74);
      font-size:12px;
      line-height:1.35;
      font-weight:750;
    }
    .meta{ margin-top:8px; display:grid; gap:8px; }
    .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
    }
    .row .k{ color:var(--muted); font-weight:900; }
    .row .v{ font-weight:1000; text-align:right; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.30);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000; font-size:13px;
      min-height:42px;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.30);
      background:rgba(34,197,94,.14);
    }
    .btn.warn{
      border-color:rgba(245,158,11,.32);
      background:rgba(245,158,11,.12);
    }

    /* --- mission panel minimal --- */
    .mwrap{ margin-top:10px; display:grid; gap:8px; }
    .mitem{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:9px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .mleft{ display:flex; gap:8px; align-items:flex-start; }
    .mbadge{
      width:26px;height:26px;border-radius:10px;
      border:1px solid var(--stroke);
      display:grid; place-items:center;
      background:rgba(2,6,23,.26);
      font-weight:1000;
    }
    .mtext .t{ font-weight:1000; font-size:12px; }
    .mtext .s{ font-size:11px; color:rgba(229,231,235,.70); margin-top:2px; }
    .mdone{
      font-weight:1100;
      font-size:11px;
      border:1px solid rgba(34,197,94,.28);
      background:rgba(34,197,94,.10);
      padding:4px 8px;
      border-radius:999px;
      opacity:.45;
    }
    .mitem.done .mdone{ opacity:1; }
    .mitem.done .mbadge{ border-color:rgba(34,197,94,.30); background:rgba(34,197,94,.08); }
    .mitem.done .mtext .t{ color:rgba(34,197,94,.95); }

    /* end overlay */
    .end{
      position:absolute; inset:0;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      z-index:9;
      padding:16px;
    }
    .end .panel{
      width:min(560px,100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .end h3{ margin:0; font-size:16px; font-weight:1100; }
    .kv{
      margin-top:10px;
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;
    }
    .kv .item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:14px;
      padding:8px 10px;
    }
    .kv .k{ font-size:10px; color:var(--muted); font-weight:900; }
    .kv .v{ margin-top:4px; font-size:13px; font-weight:1000; word-break:break-word; }

    @media (max-width:560px){
      .top{ padding:10px 12px; }
      .side{ padding:12px; }
      .kv{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">HH</div>
          <div>
            <div class="title" id="gameTitle">Warmup Gate</div>
            <div class="sub" id="subLine">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="pillPhase">PHASE: WARMUP</div>
          <div class="chip" id="pillCat">CAT: NUTRITION</div>
          <div class="chip" id="pillTheme">THEME: GOODJUNK</div>
          <div class="chip" id="pillDaily">DAILY: NEW</div>
        </div>
      </div>

      <div class="main">
        <div class="play">
          <div class="hud">
            <div class="box"><div class="k">TIME</div><div class="v" id="hudTime">30s</div></div>
            <div class="box"><div class="k">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="box"><div class="k">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="box"><div class="k">STREAK</div><div class="v" id="hudStreak">0</div></div>
            <div class="box"><div class="k">ACC</div><div class="v" id="hudAcc">0%</div></div>
          </div>

          <div class="stage" id="stage" aria-live="polite">
            <div class="center" id="center">
              <div class="big" id="big">‚ö°</div>
              <div class="hint" id="hint">‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‚Äî ‡∏õ.5 ‡∏à‡∏∞‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô!</div>
            </div>
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="end" id="endOverlay" aria-hidden="true">
            <div class="panel">
              <h3 id="endTitle">Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h3>
              <div class="muted" id="endMsg" style="margin-top:6px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>

              <div class="kv">
                <div class="item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
                <div class="item"><div class="k">ACC</div><div class="v" id="endAcc">0%</div></div>
                <div class="item"><div class="k">STREAK</div><div class="v" id="endStreak">0</div></div>
                <div class="item"><div class="k">MISSIONS</div><div class="v" id="endMissions">0/3</div></div>
                <div class="item"><div class="k">BUFF KEYS</div><div class="v" id="endBuff">‚Äî</div></div>
                <div class="item"><div class="k">NEXT</div><div class="v" id="endNext">YES</div></div>
              </div>

              <div class="btnrow" style="margin-top:12px;">
                <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
                <button class="btn primary" id="btnContinue">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="card">
            <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Gate</h3>
            <div class="muted" id="desc" style="margin-top:6px;">Warmup/Cooldown ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</div>

            <div class="meta">
              <div class="row"><div class="k">Status</div><div class="v" id="statusText">ready</div></div>
              <div class="row"><div class="k">Duration</div><div class="v" id="durText">30s</div></div>
              <div class="row"><div class="k">Grade</div><div class="v" id="gradeText">‚Äî</div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
              <button class="btn warn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
            </div>
          </div>

          <div class="card" id="missionCard">
            <h3>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Daily Missions)</h3>
            <div class="muted" style="margin-top:6px;">
              ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô 30 ‡∏ß‡∏¥ ‚Äî ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô/‡∏ó‡∏∏‡∏Å PID)
            </div>
            <div class="mwrap" id="missionWrap"></div>
          </div>

          <div class="card">
            <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            <div class="muted" style="margin-top:6px;">
              ‚Ä¢ Warmup ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ü‡∏ú‡πà‡∏≤‡∏ô URL ‡πÑ‡∏õ‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á<br/>
              ‚Ä¢ Cooldown ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö HUB ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏õ slot ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (plan sequence)<br/>
              ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î research ‡πÉ‡∏ä‡πâ pick=day (deterministic) ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const WIN=window, DOC=document;
  const $=(id)=>DOC.getElementById(id);

  function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
  const QS=getQS();
  const q=(k,d='')=> (QS.get(k) ?? d);
  const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };
  const clamp=(v,a,b)=>{ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); };

  function absUrlMaybe(url){
    if(!url) return '';
    try{ return new URL(url, location.href).toString(); }catch{ return String(url||''); }
  }

  function getLocalDayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function dailyKey(prefix, category, pid){
    const day=getLocalDayKey();
    const p=(pid||'anon').trim()||'anon';
    return `${prefix}:${category}:${p}:${day}`;
  }
  function isDaily(prefix, category, pid){
    try{ return localStorage.getItem(dailyKey(prefix,category,pid))==='1'; }catch{ return false; }
  }
  function markDaily(prefix, category, pid){
    try{ localStorage.setItem(dailyKey(prefix,category,pid),'1'); }catch{}
  }

  function hash32(str){
    let h = 2166136261 >>> 0;
    str = String(str || '');
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function zoneThemePool(category){
    const c = String(category || '').toLowerCase();
    if(c === 'nutrition') return ['goodjunk','groups','hydration','plate'];
    if(c === 'hygiene')   return ['handwash','brush','maskcough','germdetective','bath','clean'];
    if(c === 'exercise')  return ['shadow','rhythm','jumpduck','balance','planner'];
    return ['goodjunk','groups','hydration','plate'];
  }

  const phase = String(q('gatePhase', q('phase','warmup'))).toLowerCase();
  const cat   = String(q('cat','nutrition')).toLowerCase();
  const themeFromQs = String(q('theme','')).toLowerCase().trim();
  const hub   = absUrlMaybe(q('hub','../hub.html')) || '../hub.html';
  const next0 = absUrlMaybe(q('next','')) || hub;

  let pid = String(q('pid','')).trim() || 'anon';
  const run = String(q('run','play')).toLowerCase().trim();
  const pick = String(q('pick','')).toLowerCase().trim();

  const grade = String(q('grade','')).toLowerCase().trim();
  const isP5 = (grade === 'p5' || grade === 'g5' || grade === 'kid' || grade === '‡πÄ‡∏î‡πá‡∏Å');

  // duration: teacher override respected, else P5 defaults 30s, else 20s
  const durWarmDefault = isP5 ? 30 : 20;
  const durCoolDefault = isP5 ? 30 : 15;

  const durWarm = clamp(qNum('dur', durWarmDefault), 5, 60);
  const durCool = clamp(qNum('cdur', durCoolDefault), 5, 60);
  const dur = (phase==='cooldown') ? durCool : durWarm;

  function pickThemeByPolicy(category){
    if(themeFromQs) return themeFromQs;

    const g = String(q('game','')).toLowerCase().trim();
    if(g) return g;

    const mode = (pick==='rand' || pick==='day') ? pick : (run==='research' ? 'day' : 'rand');
    const pool = zoneThemePool(category);
    if(!pool.length) return 'goodjunk';

    if(mode === 'rand') return pool[(Math.random()*pool.length)|0];

    const dayKey = getLocalDayKey();
    const slot = String(q('planSlot','')).toLowerCase().trim();
    const seed = `${pid}|${dayKey}|${slot}|${category}|${run}|warmup-gate`;
    const idx = hash32(seed) % pool.length;
    return pool[idx];
  }

  function detectThemeKey(){
    if(themeFromQs) return themeFromQs;
    const g = String(q('game','')).toLowerCase().trim();
    if(g) return g;

    if(pick==='rand' || pick==='day' || run==='research'){
      return pickThemeByPolicy(cat);
    }

    const n = String(next0||'').toLowerCase();

    if(n.includes('vr-goodjunk') || n.includes('goodjunk')) return 'goodjunk';
    if(n.includes('vr-groups')   || n.includes('groups'))   return 'groups';
    if(n.includes('hydration-vr')|| n.includes('hydration'))return 'hydration';
    if(n.includes('/plate/')     || n.includes('plate-vr')) return 'plate';

    if(n.includes('handwash')) return 'handwash';
    if(n.includes('vr-brush') || n.includes('brush')) return 'brush';
    if(n.includes('maskcough') || n.includes('mask')) return 'maskcough';
    if(n.includes('germ-detective') || n.includes('germ') || n.includes('detective')) return 'germdetective';
    if(n.includes('bath')) return 'bath';
    if(n.includes('home-clean') || n.includes('cleanobjects') || n.includes('clean')) return 'clean';

    if(n.includes('shadow-breaker') || n.includes('shadow')) return 'shadow';
    if(n.includes('rhythm-boxer') || n.includes('rhythm')) return 'rhythm';
    if(n.includes('jump-duck') || n.includes('jumpduck')) return 'jumpduck';
    if(n.includes('balance-hold') || n.includes('balance')) return 'balance';
    if(n.includes('fitness-planner') || n.includes('planner')) return 'planner';

    return (cat==='hygiene') ? 'handwash' : (cat==='exercise') ? 'jumpduck' : 'goodjunk';
  }
  const themeKey = detectThemeKey();

  // daily
  const dailyPrefix = (phase==='cooldown') ? 'HHA_COOLDOWN_DONE' : 'HHA_WARMUP_DONE';
  const dailyDone = isDaily(dailyPrefix, cat, pid);

  // dom
  const pillPhase=$('pillPhase'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillDaily=$('pillDaily');
  const subLine=$('subLine'), statusText=$('statusText'), durText=$('durText'), gradeText=$('gradeText');
  const gameTitle=$('gameTitle'), desc=$('desc');
  const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
  const toast=$('toast'), flash=$('flash');

  const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudStreak=$('hudStreak'), hudAcc=$('hudAcc');
  const btnStart=$('btnStart'), btnSkip=$('btnSkip');

  const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
  const endScore=$('endScore'), endAcc=$('endAcc'), endStreak=$('endStreak'), endMissions=$('endMissions'), endBuff=$('endBuff'), endNext=$('endNext');
  const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

  const missionWrap=$('missionWrap');

  function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
  function toastShow(text){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 420);
  }

  // runtime
  let started=false;
  let tLeft=dur;
  let score=0, miss=0, total=0;
  let streak=0, bestStreak=0;
  let raf=0, lastTs=0;
  let stageAnimRaf=0;
  let teardownFns=[];

  // missions
  const missions = { list: [], done: [false,false,false], doneCount: 0 };
  function mkMissions(){
    const day = getLocalDayKey();
    const seed = `${pid}|${day}|${cat}|${themeKey}|missions`;
    const base = hash32(seed);

    const pool = [
      { code:'ACC75',  icon:'üéØ', text:'‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô ‚â• 75%',       check:()=> accPct()>=75 },
      { code:'ACC85',  icon:'üèπ', text:'‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô ‚â• 85%',       check:()=> accPct()>=85 },
      { code:'STREAK6',icon:'üî•', text:'‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 6',        check:()=> bestStreak>=6 },
      { code:'STREAK9',icon:'‚ö°', text:'‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 9',        check:()=> bestStreak>=9 },
      { code:'SCORE35',icon:'üíé', text:'‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚â• 35',         check:()=> score>=35 },
      { code:'SCORE50',icon:'üèÜ', text:'‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚â• 50',         check:()=> score>=50 },
      { code:'MISS3',  icon:'üß†', text:'‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3',        check:()=> miss<=3 && total>=8 },
      { code:'PERF2',  icon:'‚ú®', text:'Perfect 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',       check:()=> perfCount>=2 },
      { code:'BOMB0',  icon:'üß®', text:'‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î',         check:()=> bombHit===0 && total>=8 },
    ];

    // deterministic pick 3 (allow repeat by day+pid)
    const pick3 = [];
    for(let i=0;i<3;i++){
      const idx = (base + i*1013) % pool.length;
      pick3.push(pool[idx]);
    }
    missions.list = pick3;
    missions.done = [false,false,false];
    missions.doneCount = 0;
    renderMissions();
  }

  function renderMissions(){
    if(!missionWrap) return;
    missionWrap.innerHTML='';
    missions.list.forEach((m,i)=>{
      const row = DOC.createElement('div');
      row.className = 'mitem' + (missions.done[i] ? ' done' : '');
      row.innerHTML = `
        <div class="mleft">
          <div class="mbadge">${m.icon}</div>
          <div class="mtext">
            <div class="t">${m.text}</div>
            <div class="s">‡∏£‡∏´‡∏±‡∏™: ${m.code}</div>
          </div>
        </div>
        <div class="mdone">${missions.done[i] ? 'DONE' : '‚Äî'}</div>
      `;
      missionWrap.appendChild(row);
    });
  }

  function accPct(){
    return total>0 ? Math.round((score/Math.max(1,total))*100) : 0;
  }

  // P5 counters
  let perfCount=0;
  let bombHit=0;

  function setHUD(){
    hudTime.textContent = `${Math.ceil(tLeft)}s`;
    hudScore.textContent = String(score);
    hudMiss.textContent = String(miss);
    hudStreak.textContent = String(bestStreak);
    hudAcc.textContent = accPct() + '%';
  }

  function clearStage(){
    cancelAnimationFrame(stageAnimRaf);
    stageAnimRaf = 0;
    teardownFns.forEach(fn=>{ try{ fn(); }catch{} });
    teardownFns = [];

    Array.from(stage.children).forEach(el=>{
      if(el===toast || el===flash || el===center) return;
      try{ el.remove(); }catch{}
    });

    center.style.display='block';
    big.textContent = isP5 ? '‚ö°' : 'üéØ';
    hint.textContent = isP5
      ? '‡πÇ‡∏´‡∏°‡∏î ‡∏õ.5: ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å!'
      : '‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';
  }

  function makeWarmupBuff(){
    const acc = (total>0) ? (score/Math.max(1,total)) : 0;
    // P5: ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏±‡∏ü‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î (5..30)
    const pctBuff = Math.round(clamp(acc*100, 5, 30));
    const rank = (acc>=0.88) ? 'S' : (acc>=0.74) ? 'A' : (acc>=0.60) ? 'B' : 'C';

    let wCrit=0, wDmg=0, wHeal=0;
    if(['hydration','handwash','maskcough','bath','clean'].includes(themeKey)) wHeal = 1;
    else if(['shadow','rhythm','jumpduck'].includes(themeKey)) wDmg = 1;
    else wCrit = 1;

    // mission bonus: complete >=2 => +5% buff (cap 30)
    const bonus = (missions.doneCount>=2) ? 5 : 0;
    const finalPct = clamp(pctBuff + bonus, 5, 30);

    return { wType:'warmup', wPct:finalPct, rank, wCrit, wDmg, wHeal };
  }

  function applyPlanSeqParams(u){
    [
      'planSeq','planDay','planSlot','planMode','planSlots','planIndex','autoNext',
      'plannedGame','finalGame','zone','cdnext'
    ].forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });
    return u;
  }

  function buildNextUrl(buff){
    let target = next0 || hub;

    const u = new URL(target, location.href);
    applyPlanSeqParams(u);

    if(phase==='cooldown'){
      // always calm
      u.searchParams.set('calm', '1');
      if(isP5) u.searchParams.set('grade','p5');
      return u.toString();
    }

    // passthrough
    [
      'hub','run','diff','time','seed','studyId','conditionGroup','log','view','pid','category','researchPhase','grade'
    ].forEach(k=>{
      const v = q(k,'');
      if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
    });

    const rp = q('researchPhase','');
    if(rp && !u.searchParams.has('phase')) u.searchParams.set('phase', rp);

    if(pid && !u.searchParams.has('pid')) u.searchParams.set('pid', pid);
    if(isP5 && !u.searchParams.has('grade')) u.searchParams.set('grade','p5');

    Object.entries(buff||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==='') return;
      u.searchParams.set(k, String(v));
    });

    if(!u.searchParams.has('wType')) u.searchParams.set('wType', String(buff.wType || 'warmup'));
    if(!u.searchParams.has('wPct'))  u.searchParams.set('wPct',  String(buff.wPct  || 10));

    return u.toString();
  }

  function updateMissions(){
    let c=0;
    missions.list.forEach((m,i)=>{
      const ok = !!m.check();
      missions.done[i]=ok;
      if(ok) c++;
    });
    missions.doneCount = c;
    renderMissions();
  }

  function endNow(buffObj){
    if(!started) return;
    started=false;
    cancelAnimationFrame(raf);
    cancelAnimationFrame(stageAnimRaf);
    raf = 0; stageAnimRaf = 0;

    markDaily(dailyPrefix, cat, pid);

    updateMissions();

    const buff = buffObj || {};
    const nextUrl = buildNextUrl(buff);

    endOverlay.style.display='flex';
    endOverlay.setAttribute('aria-hidden','false');

    const a = accPct();
    endTitle.textContent = (phase==='cooldown') ? 'Cooldown ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : 'Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
    endScore.textContent = String(score);
    endAcc.textContent   = a + '%';
    endStreak.textContent= String(bestStreak);
    endMissions.textContent = `${missions.doneCount}/3`;

    endBuff.textContent  = Object.keys(buff).length ? Object.keys(buff).join(',') : '‚Äî';
    endNext.textContent  = nextUrl ? 'YES' : 'HUB';
    endMsg.textContent =
      (phase==='cooldown')
        ? '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
        : (missions.doneCount>=2 ? '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ ‚â• 2 ‡∏Ç‡πâ‡∏≠ ‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ö‡∏±‡∏ü‡∏î‡πâ‡∏ß‡∏¢!' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á');

    btnToHub.onclick = ()=> location.href = hub;
    btnContinue.onclick = ()=> location.replace(nextUrl || hub);
  }

  function tick(ts){
    if(!started) return;
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.25, (ts-lastTs)/1000);
    lastTs = ts;
    tLeft = Math.max(0, tLeft - dt);

    // update missions live (lightweight)
    updateMissions();

    setHUD();
    if(tLeft<=0){
      if(phase==='cooldown') endNow({ calm: 1 });
      else endNow(makeWarmupBuff());
      return;
    }
    raf = requestAnimationFrame(tick);
  }

  function autoSkipIfDaily(){
    if(!dailyDone) return false;
    const target = (next0 || hub);
    subLine.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ ${phase} ‡πÅ‡∏•‡πâ‡∏ß (pid=${pid}, cat=${cat}) ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    statusText.textContent = 'Daily gate: DONE';
    setTimeout(()=> location.replace(target), 220);
    return true;
  }

  function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
  function mkBtn(label){
    const b=DOC.createElement('button');
    b.className='btn';
    b.textContent=label;
    return b;
  }
  function mkPad(cols){
    const pad=DOC.createElement('div');
    pad.style.position='absolute';
    pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
    pad.style.display='grid';
    pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    pad.style.gap='8px';
    stage.appendChild(pad);
    return pad;
  }

  // ===== P5 MINI GAMES (skill/risk/goal) =====
  // Generic target spawner: tap correct, avoid traps, keep streak
  function runP5_TargetRush(opts){
    // opts: { title, desc, goodSet, badSet, bombSet?, goodRate?, bombRate?, ttlMsBase? }
    gameTitle.textContent = opts.title;
    desc.textContent = opts.desc;
    center.style.display='none';

    const board=DOC.createElement('div');
    Object.assign(board.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-52%)',
      width:'min(620px,92%)',height:'min(360px,54vh)',
      border:'1px solid rgba(148,163,184,.18)',
      borderRadius:'18px',
      background:'rgba(2,6,23,.36)',
      overflow:'hidden'
    });
    stage.appendChild(board);

    const note=DOC.createElement('div');
    note.style.position='absolute';
    note.style.left='14px'; note.style.top='14px';
    note.style.fontWeight='1100';
    note.style.fontSize='12px';
    note.style.color='rgba(229,231,235,.78)';
    note.textContent = '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ! (‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)';
    board.appendChild(note);

    const fever=DOC.createElement('div');
    fever.style.position='absolute';
    fever.style.right='14px'; fever.style.top='14px';
    fever.style.fontWeight='1100';
    fever.style.fontSize='12px';
    fever.style.color='rgba(167,139,250,.95)';
    fever.textContent = '√ó1';
    board.appendChild(fever);

    let alive=true;
    let liveTargets=0;
    let spawnTimer=0;

    function spawnOne(){
      if(!started || !alive) return;
      if(liveTargets>=4) return;

      const played = dur - tLeft;
      const ttlBase = opts.ttlMsBase || 900;
      const ttl = clamp(ttlBase - played*6, 520, 980);

      const roll = Math.random();
      const goodRate = (opts.goodRate ?? 0.70);
      const bombRate = (opts.bombRate ?? 0.12);
      let kind='good';
      if(roll > goodRate){
        kind = (opts.bombSet && roll > (1 - bombRate)) ? 'bomb' : 'bad';
      }

      const el=DOC.createElement('button');
      el.className='btn';
      el.type='button';
      el.style.position='absolute';
      el.style.width='74px'; el.style.height='74px';
      el.style.borderRadius='18px';
      el.style.padding='0';
      el.style.fontSize='26px';
      el.style.display='grid';
      el.style.placeItems='center';
      el.style.border='1px solid rgba(148,163,184,.18)';
      el.style.background='rgba(2,6,23,.26)';

      const w = board.getBoundingClientRect().width;
      const h = board.getBoundingClientRect().height;
      const x = 18 + (w-18-74-18) * Math.random();
      const y = 62 + (h-62-74-18) * Math.random();
      el.style.left = x+'px';
      el.style.top  = y+'px';

      const emo =
        (kind==='good') ? randPick(opts.goodSet) :
        (kind==='bomb') ? randPick(opts.bombSet) :
        randPick(opts.badSet);

      el.textContent = emo;

      liveTargets++;
      board.appendChild(el);

      let died=false;
      const born = performance.now();

      function removeSelf(){
        if(died) return;
        died=true;
        liveTargets = Math.max(0, liveTargets-1);
        try{ el.remove(); }catch(_){}
      }

      // timeout => treat as miss (only if good)
      const tm = setTimeout(()=>{
        if(died) return;
        if(kind==='good'){
          miss++; total++;
          streak=0;
          toastShow('MISS'); flashBad();
        }
        removeSelf();
      }, ttl);

      el.addEventListener('pointerdown', (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        if(died || !started) return;
        clearTimeout(tm);

        total++;

        // perfect window: last 22% of ttl
        const age = performance.now() - born;
        const perfect = age >= ttl*0.78;

        if(kind==='good'){
          score += perfect ? 3 : 2;
          streak++;
          bestStreak = Math.max(bestStreak, streak);
          if(perfect){ perfCount++; toastShow('PERFECT ‚ú®'); }
          else toastShow('+2');
          flashGood();
        }else if(kind==='bomb'){
          bombHit++;
          miss += 2;
          streak = 0;
          toastShow('BOMB! üß®'); flashBad();
        }else{
          miss++;
          streak = 0;
          toastShow('TRAP'); flashBad();
        }

        // fever multiplier in last 6s
        const mult = (tLeft <= 6) ? 2 : 1;
        fever.textContent = '√ó' + mult;
        if(mult===2 && kind==='good'){
          score += 1; // small extra
        }

        removeSelf();
      }, {passive:false});

      teardownFns.push(()=>{
        try{ clearTimeout(tm); }catch(_){}
        try{ el.remove(); }catch(_){}
      });
    }

    spawnTimer = setInterval(spawnOne, 220);
    teardownFns.push(()=>{ try{ clearInterval(spawnTimer); }catch(_){ } });

    // spawn a few at start
    for(let i=0;i<2;i++) setTimeout(spawnOne, 120 + i*140);
  }

  // Nutrition P5
  function runP5_Nutrition(){
    runP5_TargetRush({
      title:'P5 Warmup ‚Äî Food Sort Rush',
      desc:'‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏° (PERFECT ‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™) ‡∏£‡∏∞‡∏ß‡∏±‡∏á JUNK/‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î!',
      goodSet:['üçé','üçå','ü•¶','ü•¨','ü•ö','üêü','ü•õ','üçö','üçû','ü•ë'],
      badSet:['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§','üç≠'],
      bombSet:['üí•','üß®'],
      goodRate:0.72,
      bombRate:0.12,
      ttlMsBase:920
    });
  }

  // Hygiene P5
  function runP5_Hygiene(){
    // boss shield micro: occasionally spawn üíé (good but must tap twice quickly)
    gameTitle.textContent='P5 Warmup ‚Äî Hygiene Combo Hunt';
    desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å ‚ú® ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏™ üíé (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';
    center.style.display='none';

    const board=DOC.createElement('div');
    Object.assign(board.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-52%)',
      width:'min(620px,92%)',height:'min(360px,54vh)',
      border:'1px solid rgba(148,163,184,.18)',borderRadius:'18px',
      background:'rgba(2,6,23,.36)',overflow:'hidden'
    });
    stage.appendChild(board);

    const legend=DOC.createElement('div');
    legend.style.position='absolute';
    legend.style.left='14px'; legend.style.top='14px';
    legend.style.fontWeight='1100';
    legend.style.fontSize='12px';
    legend.style.color='rgba(229,231,235,.78)';
    legend.textContent='ü¶†=‡πÅ‡∏ï‡πâ‡∏° | ‚ú®=‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å | üíé=‡∏ö‡∏≠‡∏™ (2 hits)';
    board.appendChild(legend);

    let live=0;
    let spawnTimer=0;

    function spawn(){
      if(!started) return;
      if(live>=4) return;

      const played = dur - tLeft;
      const ttl = clamp(860 - played*7, 520, 920);

      const roll=Math.random();
      let kind='germ';
      if(roll>0.78) kind = (roll>0.93)?'boss':'trap';

      const el=DOC.createElement('button');
      el.className='btn';
      el.type='button';
      el.style.position='absolute';
      el.style.width='74px'; el.style.height='74px';
      el.style.borderRadius='18px';
      el.style.padding='0';
      el.style.fontSize='26px';
      el.style.display='grid';
      el.style.placeItems='center';
      el.style.border='1px solid rgba(148,163,184,.18)';
      el.style.background='rgba(2,6,23,.26)';

      const w = board.getBoundingClientRect().width;
      const h = board.getBoundingClientRect().height;
      el.style.left = (18 + (w-110)*Math.random())+'px';
      el.style.top  = (62 + (h-154)*Math.random())+'px';

      let hp = (kind==='boss') ? 2 : 1;
      el.textContent = (kind==='germ')?'ü¶†':(kind==='trap')?'‚ú®':'üíé';

      live++;
      board.appendChild(el);

      let dead=false;
      const born=performance.now();
      const tm=setTimeout(()=>{
        if(dead) return;
        if(kind==='germ' || kind==='boss'){
          miss++; total++; streak=0; flashBad(); toastShow('MISS');
        }
        dead=true; live=Math.max(0,live-1);
        try{ el.remove(); }catch(_){}
      }, ttl);

      el.addEventListener('pointerdown',(ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        if(dead || !started) return;

        total++;

        const age=performance.now()-born;
        const perfect = age >= ttl*0.78;

        if(kind==='trap'){
          miss++; streak=0; bombHit++; // count as hazard
          flashBad(); toastShow('TRAP');
          clearTimeout(tm);
          dead=true; live=Math.max(0,live-1);
          try{ el.remove(); }catch(_){}
          return;
        }

        if(kind==='boss'){
          hp--;
          if(hp>0){
            // shield fake: first tap only breaks shield
            score += 1;
            streak++; bestStreak=Math.max(bestStreak, streak);
            flashGood(); toastShow('SHIELD!');
            el.textContent='üéØ'; // show weakspot now
            return;
          }
          // boss kill
          score += perfect ? 5 : 4;
          if(perfect){ perfCount++; toastShow('PERFECT üíé'); } else toastShow('+4');
          streak++; bestStreak=Math.max(bestStreak, streak);
          flashGood();
        }else{
          score += perfect ? 3 : 2;
          if(perfect){ perfCount++; toastShow('PERFECT ‚ú®'); } else toastShow('+2');
          streak++; bestStreak=Math.max(bestStreak, streak);
          flashGood();
        }

        clearTimeout(tm);
        dead=true; live=Math.max(0,live-1);
        try{ el.remove(); }catch(_){}
      },{passive:false});

      teardownFns.push(()=>{ try{ clearTimeout(tm); }catch(_){ } try{ el.remove(); }catch(_){ } });
    }

    spawnTimer=setInterval(spawn, 230);
    teardownFns.push(()=>{ try{ clearInterval(spawnTimer); }catch(_){ } });
    setTimeout(spawn, 120);
    setTimeout(spawn, 260);
  }

  // Exercise P5
  function runP5_Exercise(){
    gameTitle.textContent='P5 Warmup ‚Äî Coach Callouts';
    desc.textContent='‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏ä‡πÉ‡∏´‡πâ‡πÑ‡∏ß: ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤/‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î/‡∏´‡∏°‡∏≠‡∏ö (‡∏ú‡∏¥‡∏î = ‡∏£‡∏µ‡∏™‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏Ñ)';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-52%)',
      width:'min(620px,92%)',padding:'14px',
      borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)',textAlign:'center'
    });
    card.innerHTML = `
      <div class="muted" style="font-weight:1100;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÇ‡∏Ñ‡πâ‡∏ä</div>
      <div id="cx" style="margin-top:10px;font-size:58px;font-weight:1100;">‚¨ÖÔ∏è</div>
      <div id="ct" style="margin-top:8px;font-size:18px;font-weight:1100;">‡∏ã‡πâ‡∏≤‡∏¢</div>
      <div class="muted" style="margin-top:6px;">‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á ‚Äú‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‚Äù (‡∏ó‡πâ‡∏≤‡∏¢ ‡πÜ ‡∏à‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)</div>
    `;
    stage.appendChild(card);

    const pad=mkPad(2);
    const btnA=mkBtn('‡∏ã‡πâ‡∏≤‡∏¢'); const btnB=mkBtn('‡∏Ç‡∏ß‡∏≤');
    btnA.style.padding='14px 12px'; btnB.style.padding='14px 12px';
    pad.appendChild(btnA); pad.appendChild(btnB);

    const pad2=mkPad(2);
    pad2.style.bottom='64px';
    const btnC=mkBtn('JUMP'); const btnD=mkBtn('DUCK');
    btnC.style.padding='14px 12px'; btnD.style.padding='14px 12px';
    pad2.appendChild(btnC); pad2.appendChild(btnD);

    const cmds = [
      {t:'‡∏ã‡πâ‡∏≤‡∏¢', emo:'‚¨ÖÔ∏è'}, {t:'‡∏Ç‡∏ß‡∏≤', emo:'‚û°Ô∏è'},
      {t:'JUMP', emo:'‚¨ÜÔ∏è'}, {t:'DUCK', emo:'‚¨áÔ∏è'}
    ];
    let cur = randPick(cmds);
    let born=performance.now();
    let winMs = 620; // reaction window, shrinks over time

    function next(){
      total++;
      cur = randPick(cmds);
      born = performance.now();
      const played = dur - tLeft;
      winMs = clamp(620 - played*10, 320, 620);
      card.querySelector('#ct').textContent = cur.t;
      card.querySelector('#cx').textContent = cur.emo;
    }

    function choose(a){
      if(!started) return;
      const age = performance.now() - born;
      const perfect = (age <= winMs);

      if(a===cur.t && perfect){
        score += 3;
        streak++; bestStreak=Math.max(bestStreak, streak);
        perfCount++; toastShow('PERFECT ‚ú®'); flashGood();
      }else if(a===cur.t){
        score += 2;
        streak++; bestStreak=Math.max(bestStreak, streak);
        toastShow('+2'); flashGood();
      }else{
        miss++; streak=0;
        toastShow('MISS'); flashBad();
      }
      next();
    }

    [
      [btnA,'‡∏ã‡πâ‡∏≤‡∏¢'],[btnB,'‡∏Ç‡∏ß‡∏≤'],[btnC,'JUMP'],[btnD,'DUCK']
    ].forEach(([b,val])=> b.addEventListener('click', ()=>choose(val)));

    next();
  }

  // ===== Cooldown: Breath Ring Timing (perfect window) =====
  function runCooldown_BreathRing(){
    gameTitle.textContent = 'Cooldown ‚Äî Breath Ring Timing';
    desc.textContent = '‡∏Å‡∏î ‚Äú‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‚Äù ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ß‡∏á (Perfect ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{
      position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-52%)',
      width:'min(620px,92%)',padding:'14px',
      borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)',textAlign:'center'
    });
    card.innerHTML = `
      <div style="font-weight:1100;font-size:16px;">‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏≤‡∏°‡∏ß‡∏á</div>
      <div class="muted" style="margin-top:6px;">‡∏ß‡∏á‡∏´‡∏î = IN | ‡∏ß‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢ = OUT (‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</div>
      <div id="ringBox" style="position:relative; margin:14px auto 0; width:260px; height:260px;">
        <div id="ring" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
          width:240px; height:240px; border-radius:999px; border:2px solid rgba(56,189,248,.35);
          box-shadow:0 0 0 10px rgba(34,197,94,.06) inset;">
        </div>
        <div id="zone" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
          width:160px; height:160px; border-radius:999px; border:2px dashed rgba(34,197,94,.30);">
        </div>
        <div id="label" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
          font-weight:1200; font-size:22px;">IN</div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn primary" id="bin">IN</button>
        <button class="btn" id="bout">OUT</button>
      </div>
    `;
    stage.appendChild(card);

    const ring=card.querySelector('#ring');
    const label=card.querySelector('#label');
    const bin=card.querySelector('#bin');
    const bout=card.querySelector('#bout');

    let t=0;
    let cur='IN'; // expected
    let inPerfect=false;

    function step(){
      if(!started) return;
      const played = dur - tLeft;

      // breathing cycle speed: slightly faster at end but still calm
      const sp = 0.018 + Math.min(0.010, played*0.0004);
      t += sp;

      // s in [0..1]
      const s = (Math.sin(t)+1)/2;
      const size = 150 + s*90; // 150..240
      ring.style.width = size+'px';
      ring.style.height= size+'px';

      // expected: when shrinking => IN, expanding => OUT
      const v = Math.cos(t); // derivative sign approx
      cur = (v < 0) ? 'OUT' : 'IN';
      label.textContent = cur;

      // perfect zone: around mid radius
      inPerfect = (size >= 182 && size <= 198);

      stageAnimRaf = requestAnimationFrame(step);
    }

    function choose(a){
      if(!started) return;
      total++;
      if(a===cur && inPerfect){
        score += 3; perfCount++; streak++; bestStreak=Math.max(bestStreak, streak);
        toastShow('PERFECT ‚ú®'); flashGood();
      }else if(a===cur){
        score += 2; streak++; bestStreak=Math.max(bestStreak, streak);
        toastShow('+2'); flashGood();
      }else{
        miss++; streak=0; toastShow('MISS'); flashBad();
      }
    }

    bin.addEventListener('click', ()=>choose('IN'));
    bout.addEventListener('click', ()=>choose('OUT'));

    stageAnimRaf = requestAnimationFrame(step);
  }

  // Legacy (non-P5) fallbacks (keep your original simpler ones)
  function runLegacy_SimpleTap(){
    gameTitle.textContent='Warmup ‚Äî Quick Tap';
    desc.textContent='‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)';
    center.style.display='none';

    const card=DOC.createElement('div');
    Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
      width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
      background:'rgba(2,6,23,.50)',textAlign:'center'});
    card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!</div>
      <div id="it" style="font-size:60px;margin-top:8px;">üéØ</div>
      <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞ = +1</div>`;
    stage.appendChild(card);

    function onTap(){
      if(!started) return;
      total++; score++; streak++; bestStreak=Math.max(bestStreak, streak);
      toastShow('+1'); flashGood();
    }
    card.addEventListener('pointerdown', onTap, {passive:true});
    teardownFns.push(()=> card.removeEventListener('pointerdown', onTap));
  }

  // Theme map
  const ThemeP5 = {
    // nutrition
    goodjunk: runP5_Nutrition,
    groups:   runP5_Nutrition,
    hydration:runP5_Nutrition,
    plate:    runP5_Nutrition,
    // hygiene
    handwash: runP5_Hygiene,
    brush:    runP5_Hygiene,
    maskcough:runP5_Hygiene,
    germdetective:runP5_Hygiene,
    germ:     runP5_Hygiene,
    bath:     runP5_Hygiene,
    clean:    runP5_Hygiene,
    cleanobjects:runP5_Hygiene,
    // exercise
    shadow:   runP5_Exercise,
    rhythm:   runP5_Exercise,
    jumpduck: runP5_Exercise,
    balance:  runP5_Exercise,
    planner:  runP5_Exercise,
  };

  function start(){
    if(dailyDone){ autoSkipIfDaily(); return; }

    clearStage();
    score=0; miss=0; total=0;
    streak=0; bestStreak=0;
    perfCount=0; bombHit=0;

    tLeft=dur; lastTs=0;
    setHUD();

    mkMissions();

    endOverlay.style.display='none';
    endOverlay.setAttribute('aria-hidden','true');

    started=true;

    if(phase==='cooldown'){
      runCooldown_BreathRing();
      statusText.textContent = `Cooldown (${dur}s) ‚Äî pid=${pid} cat=${cat}`;
    }else{
      if(isP5){
        const fn = ThemeP5[themeKey] || runP5_Nutrition;
        fn();
      }else{
        runLegacy_SimpleTap();
      }
      statusText.textContent = `Warmup (${dur}s) ‚Äî theme=${themeKey}`;
    }

    subLine.textContent = (phase==='cooldown')
      ? '‡πÄ‡∏•‡πà‡∏ô cooldown ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö/‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'
      : (isP5 ? '‡πÇ‡∏´‡∏°‡∏î ‡∏õ.5: ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á' : '‡πÄ‡∏•‡πà‡∏ô warmup ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)');

    raf = requestAnimationFrame(tick);
  }

  function skip(){
    const target = (next0 || hub);
    markDaily(dailyPrefix, cat, pid);

    const u = new URL(target, location.href);
    applyPlanSeqParams(u);
    if(isP5 && !u.searchParams.get('grade')) u.searchParams.set('grade','p5');
    location.replace(u.toString());
  }

  function maybeAutoEnd(){
    if(!started) return;
    if(phase==='cooldown') endNow({ calm: 1 });
    else endNow(makeWarmupBuff());
  }

  // top pills
  pillPhase.textContent = `PHASE: ${phase.toUpperCase()}`;
  pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
  pillTheme.textContent = `THEME: ${themeKey.toUpperCase()}`;
  pillDaily.textContent = dailyDone ? 'DAILY: DONE' : 'DAILY: NEW';
  durText.textContent = `${dur}s`;
  gradeText.textContent = isP5 ? 'P5' : (grade || '‚Äî');

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

  stage.addEventListener('pointerdown', ()=>{
    if(!started && !dailyDone) start();
  }, {passive:true});

  if(!autoSkipIfDaily()){
    const name = (phase==='cooldown')?'Cooldown':'Warmup';
    subLine.textContent = `${name} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù`;
    statusText.textContent = `ready: pid=${pid} cat=${cat} theme=${themeKey} next=${next0 ? 'yes' : 'hub'}`;
    setHUD();
    mkMissions();
  }

  WIN.addEventListener('visibilitychange', ()=>{
    if(DOC.hidden && started) maybeAutoEnd();
  });
})();
</script>
</body>
</html>