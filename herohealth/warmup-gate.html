<!-- === /herohealth/warmup-gate.html ===
HeroHealth ‚Äî Warmup/Cooldown Gate (FULL single-file)
‚úÖ One file handles BOTH phases: warmup | cooldown
‚úÖ Params:
   - phase=warmup|cooldown
   - zone=nutrition|hygiene|fitness   (DEFAULT: nutrition)
   - dur=seconds (warmup seconds, also used if cdur missing)
   - cdur=seconds (cooldown seconds)
   - autonext=1 (auto route when timer ends)
   - next=URL (where to go after gate)
   - hub=URL  (fallback hub)
   - pid=...  (optional; only for display/debug)
‚úÖ Cooldown phase will mark:
   - HHA_ZONE_DONE::<zone>::YYYY-MM-DD = 1
‚úÖ "Once per day" is enforced by checking the key above (if already done, show DONE + allow jump)
‚úÖ Safe fallback: if next missing -> go hub
‚úÖ No crashes if params missing
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Gate</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel: rgba(2,6,23,.72);
      --panel2: rgba(15,23,42,.72);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;

      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --cyan:#22d3ee; --violet:#a78bfa;

      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1200px 700px at 12% 12%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1000px 600px at 82% 20%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(900px 520px at 55% 92%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      overflow:auto;
    }

    .wrap{ max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
    .top{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding: 6px 6px 0;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(22px, 2.2vw, 30px); letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:13px; line-height:1.4; max-width: 78ch; }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding: 12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
    }
    .pill b{ color:var(--text); font-weight:900; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .body{
      padding: 12px 12px 14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
    }
    @media (max-width: 900px){ .body{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      border-radius: 18px;
      padding: 14px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      min-height: 160px;
    }
    .card h3{ margin:0 0 6px 0; font-size: 16px; letter-spacing:.2px; }
    .card p{ margin:0; color:var(--muted); font-size: 13px; line-height:1.45; }

    .meter{
      height: 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      margin-top: 12px;
    }
    .fill{
      height:100%;
      width:0%;
      background: rgba(34,197,94,.88);
      transition: width .10s linear;
    }
    .fill.cool{ background: rgba(34,211,238,.88); }
    .fill.warn{ background: rgba(245,158,11,.90); }

    .bigTimer{
      margin-top: 10px;
      font-size: clamp(36px, 5vw, 58px);
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1;
    }
    .statusLine{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.30);
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.46);
      padding: 12px 12px;
      border-radius: 16px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
      font-weight:1000;
      font-size: 13px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .btn.cyan{ border-color: rgba(34,211,238,.28); background: rgba(34,211,238,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.10); }
    .btn.ghost{ color: var(--muted); }
    .btn.disabled{ opacity:.55; cursor:not-allowed; transform:none !important; }

    .zoneLine{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.34);
      padding: 10px 10px;
      border-radius: 14px;
      font-size: 13px;
      margin-top: 10px;
    }
    .dot{
      width:10px; height:10px; border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 16px rgba(245,158,11,.35);
      flex: 0 0 auto;
    }
    .zoneLine.ok .dot{ background: var(--good); box-shadow: 0 0 16px rgba(34,197,94,.35); }
    .zoneLeft{ display:flex; align-items:center; gap:10px; }
    .zoneName{ font-weight:1000; letter-spacing:.2px; }
    .zoneVal{ color: var(--muted); font-weight:900; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--sab));
      transform: translateX(-50%);
      background: rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 9999;
      max-width: 92vw;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 id="title">‚õ©Ô∏è Gate</h1>
        <p class="subtitle" id="subtitle">‚Äî</p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <section class="panel" aria-label="Gate">
      <div class="head">
        <div class="pillrow">
          <span class="pill"><b>today</b>: <span id="todayText">‚Äî</span></span>
          <span class="pill"><b>phase</b>: <span id="phaseText">‚Äî</span></span>
          <span class="pill"><b>zone</b>: <span class="mono" id="zoneText">‚Äî</span></span>
        </div>
        <div class="pillrow">
          <span class="pill"><b>autonext</b>: <span id="autoText">‚Äî</span></span>
          <span class="pill"><b>pid</b>: <span class="mono" id="pidText">‚Äî</span></span>
        </div>
      </div>

      <div class="body">
        <!-- LEFT -->
        <div class="card">
          <h3 id="hAction">‚è±Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶</h3>
          <p id="pAction">‚Äî</p>

          <div class="bigTimer" id="bigTimer">‚Äî</div>
          <div class="meter"><div class="fill" id="fill"></div></div>

          <div class="btnrow">
            <button class="btn good" id="btnStart">‚ñ∂Ô∏è Start</button>
            <button class="btn cyan" id="btnSkip">‚è≠Ô∏è ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢</button>
            <button class="btn ghost" id="btnHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          </div>

          <div class="statusLine" id="statusLine">‚Äî</div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <h3>üìå Daily Zone Status</h3>
          <p>‡∏Ñ‡∏µ‡∏¢‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Hub: <span class="mono">HHA_ZONE_DONE::&lt;zone&gt;::YYYY-MM-DD</span></p>

          <div class="zoneLine" id="zLine">
            <div class="zoneLeft"><span class="dot"></span><span class="zoneName" id="zName">‚Äî</span></div>
            <div class="zoneVal" id="zVal">‚Äî</div>
          </div>

          <div class="statusLine" style="margin-top:12px;">
            <div><b>next</b>: <span class="mono" id="nextText">‚Äî</span></div>
            <div style="margin-top:6px;"><b>hub</b>: <span class="mono" id="hubText">‚Äî</span></div>
          </div>

          <div class="btnrow" style="margin-top:12px;">
            <button class="btn warn" id="btnResetThisZone">‚ôªÔ∏è Reset zone ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ)</button>
          </div>

          <div class="statusLine" style="margin-top:10px;">
            <b>Rules</b><br/>
            ‚Ä¢ Warmup: ‡πÑ‡∏°‡πà mark DONE (‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà gate ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°)<br/>
            ‚Ä¢ Cooldown: mark DONE ‡πÉ‡∏´‡πâ Hub ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ ‚ÄúDONE TODAY‚Äù<br/>
            ‚Ä¢ ‡∏ñ‡πâ‡∏≤ DONE ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ cooldown ‡∏≠‡∏µ‡∏Å ‚Üí ‡πÉ‡∏´‡πâ ‚Äú‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‚Äù ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥)
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  'use strict';

  // -----------------------------
  // QS helpers
  // -----------------------------
  function pageUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(pageUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  const QS = parseQS();
  const q = (k, def='') => (QS.get(k) ?? def);

  function clamp(v, a, b){ v = Number(v); if(!Number.isFinite(v)) v = a; return Math.max(a, Math.min(b, v)); }
  function esc(s){ return String(s||'').replace(/</g,'&lt;'); }

  // -----------------------------
  // day key (local)
  // -----------------------------
  function ymdLocal(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  const TODAY = ymdLocal();

  function zoneDoneKey(zone){ return `HHA_ZONE_DONE::${zone}::${TODAY}`; }
  function isZoneDoneToday(zone){
    try{ return localStorage.getItem(zoneDoneKey(zone)) === '1'; }catch(_){ return false; }
  }
  function setZoneDoneToday(zone){
    try{ localStorage.setItem(zoneDoneKey(zone), '1'); }catch(_){}
  }
  function clearZoneToday(zone){
    try{ localStorage.removeItem(zoneDoneKey(zone)); }catch(_){}
  }

  // -----------------------------
  // toast
  // -----------------------------
  const toastEl = document.getElementById('toast');
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1400);
  }

  // -----------------------------
  // params
  // -----------------------------
  const phaseRaw = String(q('phase','warmup')).toLowerCase();
  const phase = (phaseRaw === 'cooldown') ? 'cooldown' : 'warmup';

  const zoneRaw = String(q('zone', q('category','nutrition'))).toLowerCase().trim();
  const zone = (zoneRaw === 'hygiene' || zoneRaw === 'fitness' || zoneRaw === 'nutrition') ? zoneRaw : 'nutrition';

  const dur  = clamp(q('dur', (phase==='cooldown' ? q('cdur','20') : '20')), 5, 60);
  const cdur = clamp(q('cdur', String(dur)), 5, 60);

  const autonext = String(q('autonext','0')) === '1';

  const hub = String(q('hub','./hub.html') || './hub.html');
  const next = String(q('next', hub) || hub);
  const pid = String(q('pid','') || '').trim();

  const alreadyDone = isZoneDoneToday(zone);

  // -----------------------------
  // UI refs
  // -----------------------------
  const elTitle = document.getElementById('title');
  const elSub = document.getElementById('subtitle');
  const elPills = document.getElementById('pillrow');

  const todayText = document.getElementById('todayText');
  const phaseText = document.getElementById('phaseText');
  const zoneText  = document.getElementById('zoneText');
  const autoText  = document.getElementById('autoText');
  const pidText   = document.getElementById('pidText');

  const hAction = document.getElementById('hAction');
  const pAction = document.getElementById('pAction');
  const bigTimer = document.getElementById('bigTimer');
  const fill = document.getElementById('fill');
  const statusLine = document.getElementById('statusLine');

  const zLine = document.getElementById('zLine');
  const zName = document.getElementById('zName');
  const zVal  = document.getElementById('zVal');

  const nextText = document.getElementById('nextText');
  const hubText  = document.getElementById('hubText');

  const btnStart = document.getElementById('btnStart');
  const btnSkip  = document.getElementById('btnSkip');
  const btnHub   = document.getElementById('btnHub');
  const btnResetThisZone = document.getElementById('btnResetThisZone');

  // -----------------------------
  // render pills
  // -----------------------------
  function renderPills(){
    const keys = ['pid','run','diff','time','seed','studyId','conditionGroup','log','view','zone','phase','autonext','dur','cdur'];
    const pills = [];
    for(const k of keys){
      const v = QS.get(k);
      if(v!=null && String(v).trim()!=='') pills.push([k,v]);
    }
    elPills.innerHTML = (pills.length ? pills.slice(0, 14) : [['ctx','none']])
      .map(([k,v])=>`<span class="pill"><b>${esc(k)}</b>: ${esc(v)}</span>`)
      .join('');
  }

  // -----------------------------
  // zone status UI
  // -----------------------------
  function zoneLabel(z){
    if(z==='nutrition') return 'ü•ó Nutrition';
    if(z==='hygiene') return 'üßº Hygiene';
    if(z==='fitness') return 'üèÉ Fitness';
    return z;
  }
  function syncZoneLine(){
    const done = isZoneDoneToday(zone);
    zLine.classList.toggle('ok', done);
    zName.textContent = zoneLabel(zone);
    zVal.textContent = done ? 'DONE TODAY' : 'NOT DONE';
  }

  // -----------------------------
  // routing
  // -----------------------------
  function go(url){
    // flush-safe: allow repaint/toast
    try{ location.replace(url); }catch(_){ location.href = url; }
  }
  function goNext(){ go(next || hub); }
  function goHub(){ go(hub); }

  // -----------------------------
  // timer
  // -----------------------------
  let running = false;
  let tLeft = (phase === 'cooldown') ? cdur : dur;
  let tStart = 0;
  let rafId = 0;

  function fmt(n){
    n = Math.max(0, Math.ceil(n));
    return String(n);
  }

  function setFill(p){
    p = Math.max(0, Math.min(1, p));
    fill.style.width = Math.round(p*100) + '%';
  }

  function setTheme(){
    const isCool = (phase === 'cooldown');
    document.title = isCool ? 'HeroHealth ‚Äî Cooldown Gate' : 'HeroHealth ‚Äî Warmup Gate';

    elTitle.textContent = isCool ? 'üßä Cooldown Gate' : '‚öîÔ∏è Warmup Gate';
    elSub.innerHTML = isCool
      ? `‡∏û‡∏±‡∏Å/‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏á‡∏ö <b>${cdur} ‡∏ß‡∏¥</b> ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö HUB ‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞ <b>mark DONE</b> ‡πÉ‡∏´‡πâ‡πÇ‡∏ã‡∏ô <span class="mono">${esc(zone)}</span>`
      : `‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ <b>${dur} ‡∏ß‡∏¥</b> ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‚Ä¢ Warmup <b>‡πÑ‡∏°‡πà mark DONE</b>`;

    hAction.textContent = isCool ? 'üßä Cooldown' : '‚öîÔ∏è Warmup';
    pAction.textContent = isCool
      ? (alreadyDone ? '‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ DONE ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ' : '‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ mark DONE ‡πÉ‡∏´‡πâ‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hub)')
      : '‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (next)';

    fill.classList.toggle('cool', isCool);
    fill.classList.toggle('warn', !isCool);
  }

  function markDoneIfNeeded(){
    if(phase !== 'cooldown') return;
    if(isZoneDoneToday(zone)) return;
    setZoneDoneToday(zone);
    syncZoneLine();
    toast(`DONE TODAY ‚úÖ (${zone})`);
  }

  function stop(){
    running = false;
    try{ cancelAnimationFrame(rafId); }catch(_){}
  }

  function tick(ts){
    if(!running) return;
    if(!tStart) tStart = ts;

    const elapsed = (ts - tStart)/1000;
    const total = (phase === 'cooldown') ? cdur : dur;
    const left = Math.max(0, total - elapsed);
    tLeft = left;

    bigTimer.textContent = fmt(left);
    setFill( (total<=0) ? 1 : (elapsed/total) );

    if(left <= 0.001){
      stop();

      // cooldown: mark DONE here (source of truth)
      markDoneIfNeeded();

      statusLine.innerHTML = autonext
        ? `‚úÖ ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≠‚Ä¶`
        : `‚úÖ ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡∏Å‡∏î ‚Äú‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;

      if(autonext){
        setTimeout(goNext, 350);
      }else{
        toast('‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
      }
      return;
    }

    rafId = requestAnimationFrame(tick);
  }

  function start(){
    if(running) return;
    running = true;
    tStart = 0;
    statusLine.innerHTML = (phase==='cooldown')
      ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‚Ä¶ <span class="mono">${cdur}s</span>`
      : `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏û‚Ä¶ <span class="mono">${dur}s</span>`;
    requestAnimationFrame(tick);
  }

  // -----------------------------
  // init render
  // -----------------------------
  todayText.textContent = TODAY;
  phaseText.textContent = phase;
  zoneText.textContent  = zone;
  autoText.textContent  = autonext ? '1' : '0';
  pidText.textContent   = pid || '‚Äî';

  nextText.textContent = esc(next || hub);
  hubText.textContent  = esc(hub);

  renderPills();
  setTheme();
  syncZoneLine();

  // default timer display
  bigTimer.textContent = fmt(tLeft);
  setFill(0);

  // If phase=cooldown AND already done: allow skip/start both
  if(phase === 'cooldown' && alreadyDone){
    statusLine.innerHTML = `‚úÖ ‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ DONE TODAY ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢`;
  }else{
    statusLine.innerHTML = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start`;
  }

  // buttons
  btnStart.addEventListener('click', ()=>{
    toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤');
    start();
  });

  btnSkip.addEventListener('click', ()=>{
    if(phase === 'cooldown'){
      // IMPORTANT: if skipping cooldown, do NOT mark done
      toast('‡∏Ç‡πâ‡∏≤‡∏° Gate (‡πÑ‡∏°‡πà mark DONE)');
    }else{
      toast('‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢');
    }
    setTimeout(goNext, 220);
  });

  btnHub.addEventListener('click', ()=>{
    toast('‡∏Å‡∏•‡∏±‡∏ö HUB');
    setTimeout(goHub, 220);
  });

  btnResetThisZone.addEventListener('click', ()=>{
    clearZoneToday(zone);
    syncZoneLine();
    toast(`Reset zone ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß (${zone})`);
  });

  // autostart convenience (optional)
  const autostart = String(q('autostart','0')) === '1';
  if(autostart){
    setTimeout(start, 250);
  }

})();
</script>

</body>
</html>