<!-- === /herohealth/warmup-gate.html ===
HeroHealth Warmup/Cooldown Gate ‚Äî PRODUCTION FULL (v20260224-PRO-mult-pick-missions)
‚úÖ Root file: /herohealth/warmup-gate.html
‚úÖ Cat = Zone (nutrition/hygiene/exercise)
‚úÖ Theme = Game (goodjunk/groups/hydration/plate/handwash/brush/maskcough/germdetective/bath/clean/shadow/rhythm/jumpduck/balance/planner)
‚úÖ Theme pick policy (5 modes via hub policy support):
   1) ?theme= override
   2) ?game= legacy override
   3) ?pick=rand => random within category
   4) ?pick=day  => deterministic by pid+cat+day(+slot)
   5) fallback detect from next path
‚úÖ Daily once-per-day per PID+category for warmup and cooldown
‚úÖ Warmup end -> Pass buffs (wType/wPct/wCrit/wDmg/wHeal/rank/calm/multBest) into next URL
‚úÖ Warmup upgrades:
   - Combo Multiplier x1/x2/x3 by streak (>=6 => x2, >=10 => x3)
   - CLUTCH bonus (+1) in last 4s when hit
   - Daily Mini-Missions (deterministic by day+pid+cat+theme), show panel + completion ticks
   - End screen Buff Pick A/B (quick choice) before Continue
‚úÖ Cooldown end -> calm=1, supports plan sequence passthrough + cdnext chain target already in next
‚úÖ Works PC/Mobile (tap/click). Safe, no external deps.
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Warmup Gate</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.78);
      --panel2: rgba(15,23,42,.60);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1000px 700px at 15% 0%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(900px 650px at 92% 12%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }

    .wrap{
      min-height:100%;
      padding: calc(14px + var(--sat)) calc(12px + var(--sar)) calc(14px + var(--sab)) calc(12px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .shell{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.62));
      border-radius:24px;
      box-shadow:0 16px 60px rgba(0,0,0,.42);
      overflow:hidden;
    }
    .top{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background:rgba(2,6,23,.45);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16));
      display:grid; place-items:center; font-weight:1000;
    }
    .title{font-weight:1000}
    .sub{font-size:12px; color:var(--muted); font-weight:800; margin-top:2px}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:1000;
      white-space:nowrap;
    }

    .main{
      display:grid; grid-template-columns: 1.2fr .8fr;
      gap:0;
    }
    @media (max-width: 860px){ .main{ grid-template-columns:1fr; } }

    .play{
      position:relative;
      min-height:560px;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(700px 320px at 50% 10%, rgba(34,211,238,.06), transparent 70%),
        linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.06));
      overflow:hidden;
    }
    @media (max-width: 860px){
      .play{ border-right:none; border-bottom:1px solid var(--stroke); min-height:500px; }
    }

    .hud{
      position:absolute; left:10px; right:10px; top:10px;
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px;
      z-index:4;
    }
    .hud .box{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.38);
      border-radius:14px;
      padding:8px 10px;
      text-align:center;
    }
    .hud .k{font-size:10px; color:var(--muted); font-weight:900}
    .hud .v{margin-top:4px; font-size:15px; font-weight:1100}

    .clutch{
      position:absolute; right:12px; top:72px;
      z-index:5;
      border:1px solid rgba(245,158,11,.30);
      background:rgba(245,158,11,.12);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:1100;
      color:rgba(229,231,235,.92);
      display:none;
      pointer-events:none;
    }
    .clutch.show{ display:inline-flex; gap:8px; align-items:center; }

    .center{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:2;
      pointer-events:none;
    }
    .center .big{
      font-size:64px; line-height:1;
      filter:drop-shadow(0 8px 24px rgba(0,0,0,.35));
    }
    .center .hint{
      margin-top:8px;
      color:rgba(229,231,235,.85);
      font-weight:900;
      font-size:14px;
    }

    .stage{
      position:absolute; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      user-select:none;
      -webkit-user-select:none;
    }

    .flash{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .12s ease;
      z-index:5;
    }
    .flash.good{ background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.16), rgba(34,197,94,0)); }
    .flash.bad{  background:radial-gradient(circle at 50% 50%, rgba(239,68,68,.16), rgba(239,68,68,0)); }

    .toast{
      position:absolute; left:50%; top:78px; transform:translateX(-50%) translateY(-6px);
      z-index:6;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.78);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px; font-weight:1100;
      opacity:0;
      transition:all .12s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.p1{ border-color: rgba(245,158,11,.30); }
    .toast.p2{ border-color: rgba(167,139,250,.35); }

    .side{
      padding:14px;
      display:flex; flex-direction:column; gap:12px;
      background:rgba(2,6,23,.22);
    }
    .card{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.34);
      border-radius:18px;
      padding:12px;
    }
    .card h3{
      margin:0;
      font-size:14px;
      font-weight:1000;
    }
    .muted{
      color:rgba(229,231,235,.74);
      font-size:12px;
      line-height:1.35;
      font-weight:750;
    }
    .meta{ margin-top:8px; display:grid; gap:8px; }
    .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
    }
    .row .k{ color:var(--muted); font-weight:900; }
    .row .v{ font-weight:1000; text-align:right; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.30);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000; font-size:13px;
      min-height:42px;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.30);
      background:rgba(34,197,94,.14);
    }
    .btn.warn{
      border-color:rgba(245,158,11,.32);
      background:rgba(245,158,11,.12);
    }

    .missions{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .ms-item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.22);
      border-radius:14px;
      padding:8px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .ms-left{ min-width:0; }
    .ms-title{ font-size:12px; font-weight:1000; }
    .ms-desc{ font-size:11px; color:rgba(229,231,235,.72); font-weight:800; margin-top:2px; }
    .ms-ck{
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      display:grid; place-items:center;
      font-weight:1100;
      flex:0 0 auto;
      color:rgba(229,231,235,.86);
      background:rgba(2,6,23,.28);
    }
    .ms-ck.ok{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
      color: rgba(229,231,235,.96);
    }

    .end{
      position:absolute; inset:0;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      z-index:9;
      padding:16px;
    }
    .end .panel{
      width:min(620px,100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.70));
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .end h3{ margin:0; font-size:16px; font-weight:1100; }
    .kv{
      margin-top:10px;
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px;
    }
    .kv .item{
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.28);
      border-radius:14px;
      padding:8px 10px;
    }
    .kv .k{ font-size:10px; color:var(--muted); font-weight:900; }
    .kv .v{ margin-top:4px; font-size:13px; font-weight:1100; word-break:break-word; }

    #buffPickWrap{ margin-top:12px; display:none; }
    #buffPickWrap h4{ margin:0; font-size:13px; font-weight:1100; }
    #buffPickNote{ margin-top:8px; }

    @media (max-width:560px){
      .hud{ grid-template-columns:repeat(2,minmax(0,1fr)); top:8px; left:8px; right:8px; }
      .center .big{ font-size:56px; }
      .center .hint{ font-size:13px; }
      .top{ padding:10px 12px; }
      .side{ padding:12px; }
      .kv{ grid-template-columns:1fr; }
      .clutch{ top:110px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="brand">
          <div class="logo">HH</div>
          <div>
            <div class="title" id="gameTitle">Warmup Gate</div>
            <div class="sub" id="subLine">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="pillPhase">PHASE: WARMUP</div>
          <div class="chip" id="pillCat">CAT: NUTRITION</div>
          <div class="chip" id="pillTheme">THEME: GOODJUNK</div>
          <div class="chip" id="pillDaily">DAILY: NEW</div>
        </div>
      </div>

      <div class="main">
        <div class="play">
          <div class="hud">
            <div class="box"><div class="k">TIME</div><div class="v" id="hudTime">28s</div></div>
            <div class="box"><div class="k">SCORE</div><div class="v" id="hudScore">0</div></div>
            <div class="box"><div class="k">MISS</div><div class="v" id="hudMiss">0</div></div>
            <div class="box"><div class="k">MULT</div><div class="v" id="hudTotal">x1</div></div>
          </div>

          <div class="clutch" id="clutchPill">‚ö° CLUTCH +1</div>

          <div class="stage" id="stage" aria-live="polite">
            <div class="center" id="center">
              <div class="big" id="big">üéØ</div>
              <div class="hint" id="hint">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
            </div>
            <div class="toast" id="toast">+1</div>
            <div class="flash" id="flash"></div>
          </div>

          <div class="end" id="endOverlay" aria-hidden="true">
            <div class="panel">
              <h3 id="endTitle">Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h3>
              <div class="muted" id="endMsg" style="margin-top:6px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>

              <div class="kv">
                <div class="item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
                <div class="item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
                <div class="item"><div class="k">ACC</div><div class="v" id="endAcc">0%</div></div>
                <div class="item"><div class="k">STREAK BEST</div><div class="v" id="endStreak">0</div></div>
                <div class="item"><div class="k">MULT BEST</div><div class="v" id="endMultBest">x1</div></div>
                <div class="item"><div class="k">MISSIONS</div><div class="v" id="endMissions">0/3</div></div>
                <div class="item"><div class="k">BUFF KEYS</div><div class="v" id="endBuff">‚Äî</div></div>
                <div class="item"><div class="k">NEXT</div><div class="v" id="endNext">YES</div></div>
              </div>

              <div class="card" id="buffPickWrap">
                <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏£‡πá‡∏ß ‡πÜ)</h4>
                <div class="muted" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÑ‡∏õ‡∏ï‡πà‡∏≠‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á</div>
                <div class="btnrow" style="margin-top:10px;">
                  <button class="btn primary" id="buffA">‡∏ö‡∏±‡∏ü A</button>
                  <button class="btn" id="buffB">‡∏ö‡∏±‡∏ü B</button>
                </div>
                <div class="muted" id="buffPickNote">‚Äî</div>
              </div>

              <div class="btnrow" style="margin-top:12px;">
                <button class="btn" id="btnToHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
                <button class="btn primary" id="btnContinue">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
              </div>
            </div>
          </div>
        </div>

        <div class="side">
          <div class="card">
            <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Gate</h3>
            <div class="muted" id="desc" style="margin-top:6px;">Warmup/Cooldown ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</div>

            <div class="meta">
              <div class="row"><div class="k">Status</div><div class="v" id="statusText">ready</div></div>
              <div class="row"><div class="k">Duration</div><div class="v" id="durText">28s</div></div>
              <div class="row"><div class="k">Daily Rule</div><div class="v">‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î/‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô/‡∏ï‡πà‡∏≠ PID</div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn primary" id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
              <button class="btn warn" id="btnSkip">‡∏Ç‡πâ‡∏≤‡∏°</button>
            </div>
          </div>

          <div class="card" id="missionsCard">
            <h3>Daily Missions</h3>
            <div class="muted" style="margin-top:6px;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠/‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô+pid)</div>
            <div class="missions" id="missionsList"></div>
          </div>

          <div class="card">
            <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            <div class="muted" style="margin-top:6px;">
              ‚Ä¢ Warmup ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ü‡∏ú‡πà‡∏≤‡∏ô URL ‡πÑ‡∏õ‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á<br/>
              ‚Ä¢ Warmup: streak ‚Üí x2/x3, ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢ 4s = CLUTCH +1<br/>
              ‚Ä¢ Cooldown ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö HUB ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏õ slot ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (plan sequence)<br/>
              ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î research ‡πÉ‡∏ä‡πâ pick=day (deterministic) ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const WIN=window, DOC=document;
    const $= (id)=>DOC.getElementById(id);

    function getQS(){ try{ return new URL(location.href).searchParams; }catch{ return new URLSearchParams(); } }
    const QS=getQS();
    const q=(k,d='')=> (QS.get(k) ?? d);
    const qNum=(k,d=0)=>{ const n=Number(q(k,d)); return Number.isFinite(n)?n:d; };

    function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) v=a; return Math.max(a, Math.min(b, v)); }
    function vib(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(_){} }

    function absUrlMaybe(url){
      if(!url) return '';
      try{ return new URL(url, location.href).toString(); }catch{ return url; }
    }

    function getLocalDayKey(){
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function dailyKey(prefix, category, pid){
      const day=getLocalDayKey();
      const p=(pid||'anon').trim()||'anon';
      return `${prefix}:${category}:${p}:${day}`;
    }
    function isDaily(prefix, category, pid){
      try{ return localStorage.getItem(dailyKey(prefix,category,pid))==='1'; }catch{ return false; }
    }
    function markDaily(prefix, category, pid){
      try{ localStorage.setItem(dailyKey(prefix,category,pid),'1'); }catch{}
    }

    const phase = String(q('gatePhase', q('phase','warmup'))).toLowerCase();
    const cat   = String(q('cat','nutrition')).toLowerCase();
    const themeFromQs = String(q('theme','')).toLowerCase().trim();
    const hub   = absUrlMaybe(q('hub','../hub.html')) || '../hub.html';
    const next0 = absUrlMaybe(q('next','')) || hub;

    // ‚úÖ default durations: warmup ~28s, cooldown ~25s (user request 25‚Äì30)
    const durWarm = clamp(qNum('dur', 28), 10, 60);
    const durCool = clamp(qNum('cdur', qNum('dur',25)), 10, 60);
    const dur = (phase==='cooldown') ? durCool : durWarm;

    let pid = String(q('pid','')).trim() || 'anon';

    function applyPlanSeqParams(u){
      [
        'planSeq','planDay','planSlot','planMode','planSlots','planIndex','autoNext',
        'plannedGame','finalGame','zone'
      ].forEach(k=>{
        const v = q(k,'');
        if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
      });
      return u;
    }

    function hash32(str){
      let h = 2166136261 >>> 0;
      str = String(str || '');
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function zoneThemePool(category){
      const c = String(category || '').toLowerCase();
      if(c === 'nutrition') return ['goodjunk','groups','hydration','plate'];
      if(c === 'hygiene')   return ['handwash','brush','maskcough','germdetective','bath','clean'];
      if(c === 'exercise')  return ['shadow','rhythm','jumpduck','balance','planner'];
      return ['goodjunk','groups','hydration','plate'];
    }

    function pickThemeByPolicy(category){
      if(themeFromQs) return themeFromQs;

      const g = String(q('game','')).toLowerCase().trim();
      if(g) return g;

      const pick = String(q('pick','')).toLowerCase().trim();
      const run = String(q('run','play')).toLowerCase().trim();
      const mode = (pick==='rand' || pick==='day') ? pick : (run==='research' ? 'day' : 'rand');

      const pool = zoneThemePool(category);
      if(!pool.length) return 'goodjunk';

      if(mode === 'rand'){
        return pool[(Math.random()*pool.length)|0];
      }

      const dayKey = getLocalDayKey();
      const slot = String(q('planSlot','')).toLowerCase().trim();
      const seed = `${pid}|${dayKey}|${slot}|${category}|${run}|warmup-gate`;
      const idx = hash32(seed) % pool.length;
      return pool[idx];
    }

    function detectThemeKey(){
      if(themeFromQs) return themeFromQs;
      const g = String(q('game','')).toLowerCase().trim();
      if(g) return g;

      const usePick = String(q('pick','')).toLowerCase().trim();
      if(usePick==='rand' || usePick==='day'){
        return pickThemeByPolicy(cat);
      }

      const n = String(next0||'').toLowerCase();

      // nutrition
      if(n.includes('vr-goodjunk') || n.includes('goodjunk')) return 'goodjunk';
      if(n.includes('vr-groups')   || n.includes('groups'))   return 'groups';
      if(n.includes('hydration-vr')|| n.includes('hydration'))return 'hydration';
      if(n.includes('/plate/')     || n.includes('plate-vr')) return 'plate';

      // hygiene
      if(n.includes('handwash')) return 'handwash';
      if(n.includes('vr-brush') || n.includes('brush')) return 'brush';
      if(n.includes('maskcough') || n.includes('mask')) return 'maskcough';
      if(n.includes('germ-detective') || n.includes('germ') || n.includes('detective')) return 'germdetective';
      if(n.includes('bath')) return 'bath';
      if(n.includes('home-clean') || n.includes('cleanobjects') || n.includes('clean')) return 'clean';

      // exercise
      if(n.includes('shadow-breaker') || n.includes('shadow')) return 'shadow';
      if(n.includes('rhythm-boxer') || n.includes('rhythm')) return 'rhythm';
      if(n.includes('jump-duck') || n.includes('jumpduck')) return 'jumpduck';
      if(n.includes('balance-hold') || n.includes('balance')) return 'balance';
      if(n.includes('fitness-planner') || n.includes('planner')) return 'planner';

      return (cat==='hygiene') ? 'handwash' : (cat==='exercise') ? 'jumpduck' : 'goodjunk';
    }
    const themeKey = detectThemeKey();

    const dailyPrefix = (phase==='cooldown') ? 'HHA_COOLDOWN_DONE' : 'HHA_WARMUP_DONE';
    const dailyDone = isDaily(dailyPrefix, cat, pid);

    /* ---------- UI refs ---------- */
    const pillPhase=$('pillPhase'), pillCat=$('pillCat'), pillTheme=$('pillTheme'), pillDaily=$('pillDaily');
    const subLine=$('subLine'), statusText=$('statusText'), durText=$('durText');
    const gameTitle=$('gameTitle'), desc=$('desc');
    const stage=$('stage'), center=$('center'), big=$('big'), hint=$('hint');
    const toast=$('toast'), flash=$('flash');
    const clutchPill=$('clutchPill');

    const hudTime=$('hudTime'), hudScore=$('hudScore'), hudMiss=$('hudMiss'), hudTotal=$('hudTotal');

    const btnStart=$('btnStart'), btnSkip=$('btnSkip');

    const endOverlay=$('endOverlay'), endTitle=$('endTitle'), endMsg=$('endMsg');
    const endScore=$('endScore'), endMiss=$('endMiss'), endBuff=$('endBuff'), endNext=$('endNext');
    const endAcc=$('endAcc'), endStreak=$('endStreak'), endMultBest=$('endMultBest'), endMissions=$('endMissions');
    const btnToHub=$('btnToHub'), btnContinue=$('btnContinue');

    const missionsList=$('missionsList');

    const buffPickWrap=$('buffPickWrap');
    const buffA=$('buffA');
    const buffB=$('buffB');
    const buffPickNote=$('buffPickNote');
    let pickedBuff=null;

    function flashGood(){ flash.className='flash good'; flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
    function flashBad(){  flash.className='flash bad';  flash.style.opacity='1'; setTimeout(()=>flash.style.opacity='0',120); }
    function toastShow(text, pri){
      toast.textContent=String(text||'');
      toast.classList.remove('p1','p2');
      if(pri===1) toast.classList.add('p1');
      if(pri===2) toast.classList.add('p2');
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 520);
    }

    /* ---------- runtime state ---------- */
    let started=false;
    let tLeft=dur;
    let score=0, miss=0, total=0;

    // accuracy + combo
    let hitCount=0;
    let streak=0, bestStreak=0;
    let mult=1, multBest=1;
    let perfect=0, fast=0, clutch=0;
    let lastActionAt=0;

    let raf=0, lastTs=0;
    let stageAnimRaf=0;
    let teardownFns=[];

    function setHUD(){
      hudTime.textContent = `${Math.ceil(tLeft)}s`;
      hudScore.textContent = String(score);
      hudMiss.textContent = String(miss);
      hudTotal.textContent = `x${mult}`;

      const clutchOn = (started && phase!=='cooldown' && tLeft<=4.0 && tLeft>0);
      if(clutchPill){
        clutchPill.classList.toggle('show', !!clutchOn);
      }
    }

    function clearStage(){
      cancelAnimationFrame(stageAnimRaf);
      stageAnimRaf = 0;
      teardownFns.forEach(fn=>{ try{ fn(); }catch{} });
      teardownFns = [];

      Array.from(stage.children).forEach(el=>{
        if(el===toast || el===flash || el===center || el===clutchPill) return;
        try{ el.remove(); }catch{}
      });

      center.style.display='block';
      big.textContent='üéØ';
      hint.textContent='‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';
    }

    function calcMultFromStreak(s){
      if(s>=10) return 3;
      if(s>=6)  return 2;
      return 1;
    }
    function onMultChange(newM){
      if(newM===mult) return;
      mult = newM;
      multBest = Math.max(multBest, mult);
      if(mult===2){ toastShow('üî• x2 COMBO!', 1); vib(20); }
      if(mult===3){ toastShow('üëë x3 COMBO!', 2); vib(35); setTimeout(()=>vib(25), 140); }
    }

    function markAction(good){
      const now = performance.now ? performance.now() : Date.now();
      const dt = lastActionAt ? (now - lastActionAt) : 9999;
      lastActionAt = now;

      if(good){
        streak++;
        bestStreak = Math.max(bestStreak, streak);
        if(dt<=260) fast++;
        if(dt<=350) perfect++;
        onMultChange(calcMultFromStreak(streak));
      }else{
        streak = 0;
        onMultChange(1);
      }
    }

    function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
    function mkBtn(label){
      const b=DOC.createElement('button');
      b.className='btn';
      b.textContent=label;
      return b;
    }
    function mkPad(cols){
      const pad=DOC.createElement('div');
      pad.style.position='absolute';
      pad.style.left='12px'; pad.style.right='12px'; pad.style.bottom='12px';
      pad.style.display='grid';
      pad.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
      pad.style.gap='8px';
      stage.appendChild(pad);
      return pad;
    }

    /* ---------- missions (deterministic daily) ---------- */
    let missionDefs = [];
    let pickedMissions = [];
    function pickDailyMissions(){
      if(phase==='cooldown'){
        missionDefs = [];
        pickedMissions = [];
        return;
      }

      const poolCommon = [
        { id:'acc70', t:'Accuracy ‚â• 70%', d:'‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô (hit/total)' },
        { id:'acc85', t:'Accuracy ‚â• 85%', d:'‡πÇ‡∏´‡∏î ‡πÜ ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (hit/total)' },
        { id:'streak6', t:'‡∏ó‡∏≥ streak ‚â• 6', d:'‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ x2' },
        { id:'streak10', t:'‡∏ó‡∏≥ streak ‚â• 10', d:'‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ x3' },
        { id:'clutch2', t:'CLUTCH hit ‚â• 2', d:'‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢ 4s ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°' },
        { id:'miss0', t:'MISS = 0', d:'‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏•‡∏≤‡∏î' },
        { id:'fast3', t:'FAST ‚â• 3', d:'‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‚â§260ms)' },
      ];

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° mission ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ stats ‡πÄ‡∏î‡∏¥‡∏°)
      const pool = poolCommon.slice();

      // deterministic pick 3 missions by day+pid+cat+theme
      const day = getLocalDayKey();
      const seed = `${day}|${pid}|${cat}|${themeKey}|missions`;
      const h = hash32(seed);

      function pickIdx(n, mod){
        return (hash32(h + '|' + n) % mod) >>> 0;
      }

      const chosen = [];
      const used = new Set();
      for(let i=0;i<12 && chosen.length<3;i++){
        const idx = pickIdx(i, pool.length);
        if(used.has(idx)) continue;
        used.add(idx);
        chosen.push(pool[idx]);
      }
      while(chosen.length<3) chosen.push(poolCommon[chosen.length]);

      missionDefs = pool;
      pickedMissions = chosen;
    }

    function evalMission(id){
      const acc = total>0 ? (hitCount/Math.max(1,total)) : 0;
      switch(id){
        case 'acc70': return acc >= 0.70;
        case 'acc85': return acc >= 0.85;
        case 'streak6': return bestStreak >= 6;
        case 'streak10': return bestStreak >= 10;
        case 'clutch2': return clutch >= 2;
        case 'miss0': return miss === 0 && total>0;
        case 'fast3': return fast >= 3;
        default: return false;
      }
    }

    function renderMissions(){
      if(!missionsList) return;
      missionsList.innerHTML = '';
      if(phase==='cooldown'){
        missionsList.innerHTML = '<div class="muted">Cooldown ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (‡πÇ‡∏´‡∏°‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢)</div>';
        return;
      }
      pickedMissions.forEach((m)=>{
        const ok = evalMission(m.id);
        const row = DOC.createElement('div');
        row.className = 'ms-item';
        row.innerHTML = `
          <div class="ms-left">
            <div class="ms-title">${m.t}</div>
            <div class="ms-desc">${m.d}</div>
          </div>
          <div class="ms-ck ${ok?'ok':''}">${ok?'‚úì':'‚Ä¢'}</div>
        `;
        missionsList.appendChild(row);
      });
    }

    /* ---------- buff calc + pick ---------- */
    function makeWarmupBaseBuff(){
      const acc = (total>0) ? (hitCount/Math.max(1,total)) : 0;
      let pct = Math.round(clamp(acc*100, 5, 30));

      // bonus ‡∏à‡∏≤‡∏Å multBest (fair)
      if(multBest===2) pct = clamp(pct + 3, 5, 30);
      if(multBest===3) pct = clamp(pct + 6, 5, 30);

      const rank = (acc>=0.85) ? 'S' : (acc>=0.70) ? 'A' : (acc>=0.55) ? 'B' : 'C';

      let wCrit=0, wDmg=0, wHeal=0;
      if(['hydration','handwash','maskcough','bath','clean'].includes(themeKey)) wHeal = 1;
      else if(['shadow','rhythm','jumpduck'].includes(themeKey)) wDmg = 1;
      else wCrit = 1;

      return { wType:'warmup', wPct:pct, rank, wCrit, wDmg, wHeal, multBest };
    }

    function makeBuffChoices(base){
      const pct = Number(base.wPct)||10;
      const mb  = Number(base.multBest)||1;
      const b2 = (mb>=2) ? 1 : 0;
      const b3 = (mb>=3) ? 1 : 0;

      let A = { ...base, wPick:'A' };
      let B = { ...base, wPick:'B' };

      if(['shadow','rhythm','jumpduck','balance'].includes(themeKey)){
        A.wDmg = 1; A.wCrit = 0; A.wHeal = 0; A.calm = 0;
        B.wCrit = 1; B.wDmg = 0; B.wHeal = 0; B.calm = 0;
        if(b3){ B.wDmg = 1; } // ‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏´‡∏î = ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏Æ‡∏ö‡∏£‡∏¥‡∏î (‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô flag)
        return {
          A, B,
          labelA:`‚öîÔ∏è Power (DMG+${pct}%)`,
          labelB:`üéØ Precision (CRIT+${pct}%)`,
          note:`multBest=x${mb} ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏ö‡∏π‡πä‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡∏Ñ‡∏£‡∏¥‡∏ï`
        };
      }

      if(['hydration','handwash','maskcough','bath','clean'].includes(themeKey)){
        A.wHeal = 1; A.wCrit = 0; A.wDmg = 0; A.calm = 0;
        B.calm = 1;  B.wHeal = 0; B.wCrit = 0; B.wDmg = 0;
        if(b3){ A.wCrit = 1; } // ‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å = ‡∏Ñ‡∏£‡∏¥‡∏ï‡πÅ‡∏ñ‡∏°
        return {
          A, B,
          labelA:`üíö Recovery (HEAL+${pct}%)`,
          labelB:`üßò Steady (CALM+1)`,
          note:`multBest=x${mb} ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏¥‡πà‡∏á`
        };
      }

      // nutrition / planner
      A.wCrit = 1; A.wDmg = 0; A.wHeal = 0; A.calm = 0;
      B.wDmg  = 1; B.wCrit = 0; B.wHeal = 0; B.calm = 0;
      if(b3){ A.wHeal = 1; } // ‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å = ‡πÑ‡∏î‡πâ heal ‡πÅ‡∏ñ‡∏°
      return {
        A, B,
        labelA:`üéØ Smart (CRIT+${pct}%)`,
        labelB:`‚ö° Speed (DMG+${pct}%)`,
        note:`multBest=x${mb} ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü‡∏™‡∏≤‡∏¢‡∏Ñ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡∏™‡∏õ‡∏µ‡∏î`
      };
    }

    function buildNextUrl(buff){
      let target = next0 || hub;

      if(phase==='cooldown'){
        const u = new URL(target, location.href);
        applyPlanSeqParams(u);
        return u.toString();
      }

      const u = new URL(target, location.href);

      const passthroughKeys = [
        'hub','run','diff','time','seed','studyId','conditionGroup','log','view','pid','category','researchPhase'
      ];
      passthroughKeys.forEach(k=>{
        const v = q(k,'');
        if(v!=='' && !u.searchParams.has(k)) u.searchParams.set(k, v);
      });

      const rp = q('researchPhase','');
      if(rp && !u.searchParams.has('phase')) u.searchParams.set('phase', rp);

      if(pid && !u.searchParams.has('pid')) u.searchParams.set('pid', pid);

      Object.entries(buff||{}).forEach(([k,v])=>{
        if(v===undefined || v===null || v==='') return;
        u.searchParams.set(k, String(v));
      });

      if(!u.searchParams.has('wType')) u.searchParams.set('wType', String(buff.wType || 'warmup'));
      if(!u.searchParams.has('wPct'))  u.searchParams.set('wPct',  String(buff.wPct  || 10));

      applyPlanSeqParams(u);
      return u.toString();
    }

    function endNow(buffObj){
      if(!started) return;
      started=false;
      cancelAnimationFrame(raf);
      cancelAnimationFrame(stageAnimRaf);
      raf = 0;
      stageAnimRaf = 0;

      markDaily(dailyPrefix, cat, pid);

      const acc = (total>0) ? Math.round((hitCount/Math.max(1,total))*100) : 0;
      const mDone = (phase==='cooldown') ? 0 : pickedMissions.reduce((n,m)=> n + (evalMission(m.id)?1:0), 0);

      endOverlay.style.display='flex';
      endOverlay.setAttribute('aria-hidden','false');
      endTitle.textContent = (phase==='cooldown') ? 'Cooldown ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : 'Warmup ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
      endScore.textContent = String(score);
      endMiss.textContent  = String(miss);
      endAcc.textContent   = acc + '%';
      endStreak.textContent = String(bestStreak);
      endMultBest.textContent = 'x' + String(multBest);
      endMissions.textContent = `${mDone}/3`;

      endMsg.textContent =
        (phase==='cooldown')
          ? '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
          : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á';

      btnToHub.onclick = ()=> location.href = hub;

      // cooldown: no pick
      if(phase==='cooldown'){
        const nextUrl = buildNextUrl({ calm: 1 });
        endBuff.textContent  = 'calm';
        endNext.textContent  = nextUrl ? 'YES' : 'HUB';
        if(buffPickWrap) buffPickWrap.style.display='none';
        btnContinue.onclick = ()=> location.replace(nextUrl || hub);
        return;
      }

      // warmup: show pick A/B
      const base = buffObj || makeWarmupBaseBuff();
      const pack = makeBuffChoices(base);
      pickedBuff = pack.A;

      if(buffPickWrap){
        buffPickWrap.style.display = '';
        if(buffA) buffA.textContent = pack.labelA;
        if(buffB) buffB.textContent = pack.labelB;
        if(buffPickNote) buffPickNote.textContent = pack.note || '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á';
      }

      function pick(which){
        pickedBuff = (which==='B') ? pack.B : pack.A;
        if(buffA && buffB){
          if(which==='B'){ buffA.classList.remove('primary'); buffB.classList.add('primary'); }
          else { buffB.classList.remove('primary'); buffA.classList.add('primary'); }
        }
        toastShow(which==='B' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü B' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ü A', 1);
        endBuff.textContent  = Object.keys(pickedBuff).join(',');
      }

      if(buffA) buffA.onclick = ()=> pick('A');
      if(buffB) buffB.onclick = ()=> pick('B');

      // default show A keys
      endBuff.textContent  = Object.keys(pickedBuff).join(',');

      const nextUrl = buildNextUrl(pickedBuff);
      endNext.textContent  = nextUrl ? 'YES' : 'HUB';
      btnContinue.onclick = ()=> location.replace(nextUrl || hub);
    }

    function tick(ts){
      if(!started) return;
      if(!lastTs) lastTs = ts;
      const dt = Math.min(0.25, (ts-lastTs)/1000);
      lastTs = ts;
      tLeft = Math.max(0, tLeft - dt);
      setHUD();
      renderMissions();
      if(tLeft<=0){
        if(phase==='cooldown') endNow({ calm: 1 });
        else endNow(makeWarmupBaseBuff());
        return;
      }
      raf = requestAnimationFrame(tick);
    }

    function autoSkipIfDaily(){
      if(!dailyDone) return false;
      const target = (phase==='cooldown') ? (next0 || hub) : (next0 || hub);
      subLine.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ ${phase} ‡πÅ‡∏•‡πâ‡∏ß (pid=${pid}, cat=${cat}) ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
      statusText.textContent = 'Daily gate: DONE';
      setTimeout(()=> location.replace(target), 220);
      return true;
    }

    /* ---------- MINI GAMES ---------- */
    function runNutrition_Sort(){
      gameTitle.textContent='Nutrition Warmup ‚Äî Food Sort Sprint';
      desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏° / ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù ‡∏à‡∏∞‡∏û‡∏•‡∏≤‡∏î';
      center.style.display='none';

      const GOOD = ['üçé','üçå','ü•¶','ü•¨','ü•ö','üêü','ü•õ','üçö','üçû','ü•ë'];
      const JUNK = ['üçü','üçî','üçï','üç©','üç¨','üßã','ü•§','üç≠'];

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!</div>
        <div id="it" style="font-size:60px;margin-top:8px;">üçé</div>
        <div class="muted" style="margin-top:6px;">GOOD = +mult / JUNK = MISS</div>`;
      stage.appendChild(card);

      let curKind='good';
      function next(){
        total++;
        curKind = (Math.random()<0.70) ? 'good' : 'junk';
        card.querySelector('#it').textContent = (curKind==='good') ? randPick(GOOD) : randPick(JUNK);
      }
      const onTap = ()=>{
        if(!started) return;
        if(curKind==='good'){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        next();
        setHUD();
        renderMissions();
      };
      card.addEventListener('pointerdown', onTap, {passive:true});
      teardownFns.push(()=> card.removeEventListener('pointerdown', onTap));
      next();
    }

    function runNutrition_GroupsMatch(){
      gameTitle.textContent='Nutrition Warmup ‚Äî 5 ‡∏´‡∏°‡∏π‡πà Snap Match';
      desc.textContent='‡∏î‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ ‚Äú‡∏´‡∏°‡∏π‡πà 1‚Äì5‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
      center.style.display='none';

      const pool = [
        {emo:'ü•ö', g:1},{emo:'üêü', g:1},{emo:'ü•õ', g:1},{emo:'ü•ú', g:1},
        {emo:'üçö', g:2},{emo:'üçû', g:2},{emo:'ü•î', g:2},{emo:'üç†', g:2},
        {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},{emo:'ü•í', g:3},{emo:'ü•ï', g:3},
        {emo:'üçé', g:4},{emo:'üçå', g:4},{emo:'üçâ', g:4},{emo:'üçä', g:4},
        {emo:'ü•ë', g:5},{emo:'üßà', g:5},{emo:'ü´í', g:5},{emo:'ü••', g:5},
      ];

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:18px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£: <span id="it" style="font-size:36px;">ü•ö</span></div>
        <div class="muted" id="lbl" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>`;
      stage.appendChild(card);

      const pad=mkPad(5);
      const labels=['‡∏´‡∏°‡∏π‡πà1','‡∏´‡∏°‡∏π‡πà2','‡∏´‡∏°‡∏π‡πà3','‡∏´‡∏°‡∏π‡πà4','‡∏´‡∏°‡∏π‡πà5'];
      let cur = randPick(pool);

      function next(){
        total++;
        cur = randPick(pool);
        card.querySelector('#it').textContent = cur.emo;
        card.querySelector('#lbl').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
      }
      function choose(g){
        if(!started) return;
        if(g===cur.g){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        next();
        setHUD();
        renderMissions();
      }

      labels.forEach((t,i)=>{
        const b=mkBtn(t);
        b.style.padding='12px 8px';
        b.style.borderRadius='14px';
        b.style.fontWeight='1100';
        b.style.fontSize='12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>choose(i+1));
      });
      next();
    }

    function runNutrition_SipRhythm(){
      gameTitle.textContent='Nutrition Warmup ‚Äî Sip Rhythm';
      desc.textContent='‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞';
      center.style.display='none';

      const ring=DOC.createElement('div');
      Object.assign(ring.style,{
        position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'240px',height:'240px',borderRadius:'999px',
        border:'2px solid rgba(56,189,248,.35)',
        background:'radial-gradient(circle at 50% 50%, rgba(34,197,94,.12) 0 34%, transparent 35% 100%)'
      });
      stage.appendChild(ring);

      const dot=DOC.createElement('div');
      Object.assign(dot.style,{
        position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'16px',height:'16px',borderRadius:'999px',background:'rgba(251,113,133,.95)'
      });
      stage.appendChild(dot);

      let t=0;
      const anim = ()=>{
        if(!started) return;
        const played = dur - tLeft;
        const sp = 0.085 + Math.min(0.06, played*0.002);
        t += sp;
        const r=96;
        const x=Math.cos(t)*r;
        const y=Math.sin(t)*r;
        dot.style.marginLeft = x+'px';
        dot.style.marginTop  = (y-30)+'px';
        dot.dataset.inzone = (Math.hypot(x,y) < 34) ? '1' : '0';
        stageAnimRaf = requestAnimationFrame(anim);
      };

      const onTap = ()=>{
        if(!started) return;
        total++;
        if(dot.dataset.inzone==='1'){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        setHUD();
        renderMissions();
      };
      stage.addEventListener('pointerdown', onTap, {passive:true});
      teardownFns.push(()=> stage.removeEventListener('pointerdown', onTap));

      stageAnimRaf = requestAnimationFrame(anim);
    }

    function runNutrition_PlateBuilder(){
      gameTitle.textContent='Nutrition Warmup ‚Äî Plate Builder';
      desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ ‚Äú‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏´‡∏°‡∏π‡πà‚Äù (‡∏ã‡πâ‡∏≥‡∏´‡∏°‡∏π‡πà = MISS)';
      center.style.display='none';

      const picked=new Set();
      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏ô</div>
        <div class="muted" id="pb" style="margin-top:6px;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‚â• 3 ‡∏´‡∏°‡∏π‡πà</div>
        <div style="margin-top:10px;font-size:34px;">üçΩÔ∏è</div>`;
      stage.appendChild(card);

      const items=[
        {emo:'üêü', g:1},{emo:'ü•õ', g:1},
        {emo:'üçö', g:2},{emo:'üçû', g:2},
        {emo:'ü•¶', g:3},{emo:'ü•¨', g:3},
        {emo:'üçé', g:4},{emo:'üçå', g:4},
        {emo:'ü•ë', g:5},{emo:'üßà', g:5},
      ];
      const pad=mkPad(5);
      items.slice(0,10).forEach(it=>{
        const b=mkBtn(it.emo);
        b.style.padding='14px 8px'; b.style.borderRadius='16px'; b.style.fontSize='18px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          total++;
          if(!picked.has(it.g)){
            picked.add(it.g);
            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
            toastShow(add>1 ? `+${add} (x${mult})` : '+1');
            flashGood();
          }else{
            miss++;
            markAction(false);
            toastShow('MISS');
            flashBad();
          }
          card.querySelector('#pb').textContent = `‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${picked.size} ‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‚â• 3)`;
          setHUD();
          renderMissions();
        });
      });
    }

    function runHygiene_WashOrder(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Wash Steps Order';
      desc.textContent='‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‚Äú‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
      center.style.display='none';

      const steps = ['‡∏ñ‡∏π‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠','‡∏ñ‡∏π‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠','‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß','‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏¥‡πâ‡∏ß','‡∏ñ‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á','‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß/‡πÄ‡∏•‡πá‡∏ö'];
      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'42%',transform:'translate(-50%,-50%)',
        width:'min(720px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 1 ‚Üí 3</div>
        <div class="muted" id="hwq" style="margin-top:6px;">‚Äî</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      let order=[], idx=0;

      function newRound(){
        idx=0;
        const s=[...steps];
        order=[];
        while(order.length<3){
          order.push(s.splice((Math.random()*s.length)|0,1)[0]);
        }
        card.querySelector('#hwq').textContent = `‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‚ë† ${order[0]} ‚Üí ‚ë° ${order[1]} ‚Üí ‚ë¢ ${order[2]}`;
        pad.innerHTML='';
        const decoy = steps.filter(x=>!order.includes(x));
        const opts=[...order, randPick(decoy)];
        for(let i=opts.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [opts[i],opts[j]]=[opts[j],opts[i]]; }

        opts.forEach(txt=>{
          const b=mkBtn(txt);
          b.style.padding='14px 12px';
          pad.appendChild(b);
          b.addEventListener('click', ()=>{
            if(!started) return;
            total++;
            if(txt===order[idx]){
              idx++;
              hitCount++;
              const clutchOn = (tLeft<=4.0 && tLeft>0);
              const add = mult + (clutchOn ? 1 : 0);
              if(clutchOn) clutch++;
              score += add;
              markAction(true);
              toastShow(add>1 ? `+${add} (x${mult})` : '+1');
              flashGood();
              if(idx>=3) newRound();
            }else{
              miss++;
              markAction(false);
              toastShow('MISS');
              flashBad();
            }
            setHUD();
            renderMissions();
          });
        });
      }
      newRound();
    }

    function runHygiene_BrushAngle(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Brush Angle Accuracy';
      desc.textContent='‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ ‚Äú‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á/‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å';
      center.style.display='none';

      const pos = [
        {q:'‡∏ö‡∏ô-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏ö‡∏ô'}, {q:'‡∏ö‡∏ô-‡∏Ç‡∏ß‡∏≤', a:'‡∏ö‡∏ô'},
        {q:'‡∏•‡πà‡∏≤‡∏á-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏•‡πà‡∏≤‡∏á'}, {q:'‡∏•‡πà‡∏≤‡∏á-‡∏Ç‡∏ß‡∏≤', a:'‡∏•‡πà‡∏≤‡∏á'},
        {q:'‡πÅ‡∏Å‡πâ‡∏°-‡∏ã‡πâ‡∏≤‡∏¢', a:'‡∏ã‡πâ‡∏≤‡∏¢'}, {q:'‡πÅ‡∏Å‡πâ‡∏°-‡∏Ç‡∏ß‡∏≤', a:'‡∏Ç‡∏ß‡∏≤'},
      ];
      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="bq" style="font-size:18px;">‚Äî</span></div>
        <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      const choices=['‡∏ö‡∏ô','‡∏•‡πà‡∏≤‡∏á','‡∏ã‡πâ‡∏≤‡∏¢','‡∏Ç‡∏ß‡∏≤'];
      let cur = randPick(pos);
      function next(){
        total++;
        cur = randPick(pos);
        card.querySelector('#bq').textContent = cur.q;
      }
      choices.forEach(c=>{
        const b=mkBtn(c);
        b.style.padding='14px 12px';
        pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(c===cur.a){
            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
            toastShow(add>1 ? `+${add} (x${mult})` : '+1');
            flashGood();
          }else{
            miss++;
            markAction(false);
            toastShow('MISS');
            flashBad();
          }
          next();
          setHUD();
          renderMissions();
        });
      });
      next();
    }

    function runHygiene_MaskChoice(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Mask & Cough Choice';
      desc.textContent='‡∏™‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å';
      center.style.display='none';

      const cases = [
        {q:'‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏≠‡∏±‡∏î', ok:'‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', emo:'üò∑'},
        {q:'‡πÑ‡∏≠/‡∏à‡∏≤‡∏°‡∏Å‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô', ok:'‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å', emo:'ü§ß'},
        {q:'‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô', ok:'‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞', emo:'‚ÜîÔ∏è'},
        {q:'‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', ok:'‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å', emo:'üè´'},
        {q:'‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', ok:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠', emo:'üßº'},
      ];
      const actions=['‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å','‡∏õ‡∏¥‡∏î‡∏õ‡∏≤‡∏Å-‡∏à‡∏°‡∏π‡∏Å','‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞','‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠'];

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(620px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
        <div id="mq" style="margin-top:8px;font-size:18px;font-weight:1000;">‚Äî</div>
        <div id="me" style="margin-top:6px;font-size:40px;">üò∑</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      let cur=randPick(cases);
      function next(){
        total++;
        cur=randPick(cases);
        card.querySelector('#mq').textContent = cur.q;
        card.querySelector('#me').textContent = cur.emo;
      }
      actions.forEach(a=>{
        const b=mkBtn(a); b.style.padding='14px 12px'; pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(a===cur.ok){
            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
            toastShow(add>1 ? `+${add} (x${mult})` : '+1');
            flashGood();
          }else{
            miss++;
            markAction(false);
            toastShow('MISS');
            flashBad();
          }
          next();
          setHUD();
          renderMissions();
        });
      });
      next();
    }

    function runHygiene_GermDetect(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Germ Detective';
      desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏Å)';
      center.style.display='none';

      const board=DOC.createElement('div');
      Object.assign(board.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',aspectRatio:'1/1',display:'grid',gridTemplateColumns:'repeat(4,minmax(0,1fr))',gap:'10px'});
      stage.appendChild(board);

      function spawnCells(){
        board.innerHTML='';
        const idxG = (Math.random()*16)|0;
        let idxD = (Math.random()*16)|0; if(idxD===idxG) idxD=(idxD+5)%16;

        for(let i=0;i<16;i++){
          const b=DOC.createElement('button');
          b.className='btn';
          b.style.height='100%'; b.style.borderRadius='16px'; b.style.fontSize='22px';
          b.style.background='rgba(2,6,23,.35)'; b.style.border='1px solid rgba(148,163,184,.18)'; b.style.padding='0';
          let kind='blank';
          if(i===idxG){ b.textContent='ü¶†'; kind='germ'; }
          else if(i===idxD){ b.textContent='‚ú®'; kind='decoy'; }
          else b.textContent='¬∑';

          b.addEventListener('click', ()=>{
            if(!started) return;
            total++;
            if(kind==='germ'){
              hitCount++;
              const clutchOn = (tLeft<=4.0 && tLeft>0);
              const add = mult + (clutchOn ? 1 : 0);
              if(clutchOn) clutch++;
              score += add;
              markAction(true);
              toastShow(add>1 ? `+${add} (x${mult})` : '+1');
              flashGood();
            }else{
              miss++;
              markAction(false);
              toastShow('MISS');
              flashBad();
            }
            spawnCells();
            setHUD();
            renderMissions();
          });
          board.appendChild(b);
        }
      }
      spawnCells();
    }

    function runHygiene_Bath(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Bath Hidden Spot';
      desc.textContent='‡πÅ‡∏ï‡∏∞‡∏à‡∏∏‡∏î‡∏™‡∏Å‡∏õ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß';
      center.style.display='none';

      const board=DOC.createElement('div');
      Object.assign(board.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',aspectRatio:'1/1',display:'grid',gridTemplateColumns:'repeat(3,minmax(0,1fr))',gap:'10px'});
      stage.appendChild(board);

      function render(){
        board.innerHTML='';
        const hot = (Math.random()*9)|0;
        for(let i=0;i<9;i++){
          const b=DOC.createElement('button');
          b.className='btn';
          b.style.height='100%'; b.style.borderRadius='16px'; b.style.fontSize='24px';
          b.textContent = (i===hot) ? 'üü§' : 'ü´ß';
          b.addEventListener('click', ()=>{
            if(!started) return;
            total++;
            if(i===hot){
              hitCount++;
              const clutchOn = (tLeft<=4.0 && tLeft>0);
              const add = mult + (clutchOn ? 1 : 0);
              if(clutchOn) clutch++;
              score += add;
              markAction(true);
              toastShow(add>1 ? `+${add} (x${mult})` : '+1');
              flashGood();
            }else{
              miss++;
              markAction(false);
              toastShow('MISS');
              flashBad();
            }
            render();
            setHUD();
            renderMissions();
          });
          board.appendChild(b);
        }
      }
      render();
    }

    function runHygiene_CleanObjects(){
      gameTitle.textContent='Hygiene Warmup ‚Äî Clean Object Choice';
      desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà ‚Äú‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‚Äù';
      center.style.display='none';

      const cases = [
        {q:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π', ok:'‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô', emo:'üö™'},
        {q:'‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ', ok:'‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô', emo:'üì∫'},
        {q:'‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î', ok:'‡∏£‡∏≠‡πÑ‡∏î‡πâ', emo:'üßΩ'},
        {q:'‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', ok:'‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô', emo:'üçΩÔ∏è'},
        {q:'‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏ö', ok:'‡∏£‡∏≠‡πÑ‡∏î‡πâ', emo:'ü™ë'}
      ];

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(620px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div style="font-weight:1100;font-size:16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
        <div id="cq" style="margin-top:8px;font-size:18px;font-weight:1000;">‚Äî</div>
        <div id="ce" style="margin-top:6px;font-size:40px;">üßº</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      let cur = randPick(cases);

      function next(){
        total++;
        cur = randPick(cases);
        card.querySelector('#cq').textContent = cur.q;
        card.querySelector('#ce').textContent = cur.emo;
      }

      ['‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô','‡∏£‡∏≠‡πÑ‡∏î‡πâ'].forEach(a=>{
        const b=mkBtn(a); b.style.padding='14px 12px'; pad.appendChild(b);
        b.addEventListener('click', ()=>{
          if(!started) return;
          if(a===cur.ok){
            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
            toastShow(add>1 ? `+${add} (x${mult})` : '+1');
            flashGood();
          }else{
            miss++;
            markAction(false);
            toastShow('MISS');
            flashBad();
          }
          next();
          setHUD();
          renderMissions();
        });
      });

      next();
    }

    function runExercise_DodgeStrike(){
      gameTitle.textContent='Exercise Warmup ‚Äî Dodge & Strike Reaction';
      desc.textContent='‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡πà‡∏° ‚Äú‡∏ï‡∏µ‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏´‡∏•‡∏ö‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏ß';
      center.style.display='none';

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
        <div id="sx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚öîÔ∏è</div>
        <div id="st" style="margin-top:8px;font-size:18px;font-weight:1100;">‚Äî</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      const btnHit=mkBtn('‡∏ï‡∏µ'); const btnDodge=mkBtn('‡∏´‡∏•‡∏ö');
      btnHit.style.padding='14px 12px'; btnDodge.style.padding='14px 12px';
      pad.appendChild(btnHit); pad.appendChild(btnDodge);

      let cur='‡∏ï‡∏µ';
      function next(){
        total++;
        cur = (Math.random()<0.5)?'‡∏ï‡∏µ':'‡∏´‡∏•‡∏ö';
        card.querySelector('#st').textContent = `‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${cur}`;
        card.querySelector('#sx').textContent = (cur==='‡∏ï‡∏µ')?'ü•ä':'ü´£';
      }
      function choose(a){
        if(!started) return;
        if(a===cur){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        next();
        setHUD();
        renderMissions();
      }
      btnHit.addEventListener('click', ()=>choose('‡∏ï‡∏µ'));
      btnDodge.addEventListener('click', ()=>choose('‡∏´‡∏•‡∏ö'));
      next();
    }

    function runExercise_BeatPunch(){
      gameTitle.textContent='Exercise Warmup ‚Äî Beat Punch';
      desc.textContent='‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ ‚Äú‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‚Äù';
      center.style.display='none';

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(620px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
        <div id="rx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚¨ÖÔ∏è</div>
        <div id="rt" style="margin-top:8px;font-size:18px;font-weight:1100;">‡∏ã‡πâ‡∏≤‡∏¢</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      const bL=mkBtn('‡∏ã‡πâ‡∏≤‡∏¢'); const bR=mkBtn('‡∏Ç‡∏ß‡∏≤');
      bL.style.padding='14px 12px'; bR.style.padding='14px 12px';
      pad.appendChild(bL); pad.appendChild(bR);

      let cur='‡∏ã‡πâ‡∏≤‡∏¢';
      function next(){
        total++;
        cur = (Math.random()<0.5)?'‡∏ã‡πâ‡∏≤‡∏¢':'‡∏Ç‡∏ß‡∏≤';
        card.querySelector('#rt').textContent = cur;
        card.querySelector('#rx').textContent = (cur==='‡∏ã‡πâ‡∏≤‡∏¢')?'‚¨ÖÔ∏è':'‚û°Ô∏è';
      }
      function choose(a){
        if(!started) return;
        if(a===cur){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        next();
        setHUD();
        renderMissions();
      }
      bL.addEventListener('click', ()=>choose('‡∏ã‡πâ‡∏≤‡∏¢'));
      bR.addEventListener('click', ()=>choose('‡∏Ç‡∏ß‡∏≤'));
      next();
    }

    function runExercise_JumpDuck(){
      gameTitle.textContent='Exercise Warmup ‚Äî Jump / Duck Drill';
      desc.textContent='‡∏™‡∏∏‡πà‡∏° JUMP ‡∏´‡∏£‡∏∑‡∏≠ DUCK ‡πÉ‡∏´‡πâ‡πÑ‡∏ß';
      center.style.display='none';

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'46%',transform:'translate(-50%,-50%)',
        width:'min(620px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `<div class="muted" style="font-weight:1000;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
        <div id="jx" style="margin-top:10px;font-size:56px;font-weight:1100;">‚¨ÜÔ∏è</div>
        <div id="jt" style="margin-top:8px;font-size:18px;font-weight:1100;">JUMP</div>`;
      stage.appendChild(card);

      const pad=mkPad(2);
      const bJ=mkBtn('JUMP'); const bD=mkBtn('DUCK');
      bJ.style.padding='14px 12px'; bD.style.padding='14px 12px';
      pad.appendChild(bJ); pad.appendChild(bD);

      let cur='JUMP';
      function next(){
        total++;
        cur = (Math.random()<0.5)?'JUMP':'DUCK';
        card.querySelector('#jt').textContent = cur;
        card.querySelector('#jx').textContent = (cur==='JUMP')?'‚¨ÜÔ∏è':'‚¨áÔ∏è';
      }
      function choose(a){
        if(!started) return;
        if(a===cur){
          hitCount++;
          const clutchOn = (tLeft<=4.0 && tLeft>0);
          const add = mult + (clutchOn ? 1 : 0);
          if(clutchOn) clutch++;
          score += add;
          markAction(true);
          toastShow(add>1 ? `+${add} (x${mult})` : '+1');
          flashGood();
        }else{
          miss++;
          markAction(false);
          toastShow('MISS');
          flashBad();
        }
        next();
        setHUD();
        renderMissions();
      }
      bJ.addEventListener('click', ()=>choose('JUMP'));
      bD.addEventListener('click', ()=>choose('DUCK'));
      next();
    }

    function runExercise_BalanceMeter(){
      gameTitle.textContent='Exercise Warmup ‚Äî Balance Hold Meter';
      desc.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á';
      center.style.display='none';

      const box=DOC.createElement('div');
      Object.assign(box.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(520px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      box.innerHTML = `
        <div style="font-weight:1100;font-size:16px;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á</div>
        <div class="muted" style="margin-top:6px;">‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á ‚Üí ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
        <div id="track" style="margin:14px auto 0; width:min(420px,92%); height:14px; border-radius:999px;
          border:1px solid rgba(148,163,184,.18); background:rgba(148,163,184,.12); position:relative; overflow:hidden;">
          <div id="zone" style="position:absolute; left:44%; top:0; width:12%; height:100%;
            background:rgba(34,197,94,.18); border-left:1px solid rgba(34,197,94,.25); border-right:1px solid rgba(34,197,94,.25);"></div>
          <div id="bar" style="position:absolute; left:10%; top:2px; width:18px; height:10px; border-radius:999px; background:rgba(56,189,248,.92);"></div>
        </div>
        <div style="margin-top:12px;">
          <button class="btn primary" id="holdBtn" style="min-width:180px;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á (HOLD)</button>
        </div>`;
      stage.appendChild(box);

      const track=box.querySelector('#track');
      const bar=box.querySelector('#bar');
      const holdBtn=box.querySelector('#holdBtn');

      let holding=false, x=0.10, v=0.0;
      function inZone(){ return x>=0.44 && x<=0.56; }

      const onDown = (e)=>{ e.preventDefault(); holding=true; holdBtn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á...'; };
      const onUp   = ()=>{ if(!holding) return; holding=false; holdBtn.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á (HOLD)'; };

      holdBtn.addEventListener('pointerdown', onDown);
      WIN.addEventListener('pointerup', onUp);
      teardownFns.push(()=>{
        holdBtn.removeEventListener('pointerdown', onDown);
        WIN.removeEventListener('pointerup', onUp);
      });

      const step = ()=>{
        if(!started) return;
        const played = dur - tLeft;
        const drift = 0.002 + Math.min(0.003, played*0.0002);
        v += (Math.random()-0.5)*drift;

        if(holding){
          v *= 0.92;
          x += v;
          x += (0.50 - x)*0.01;
        }else{
          x += v;
        }
        x = Math.max(0.02, Math.min(0.98, x));

        const w = track.getBoundingClientRect().width;
        bar.style.left = Math.round(x*w) + 'px';

        if(holding){
          total++;
          const ok = inZone();
          if(ok){
            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
          }else{
            miss++;
            markAction(false);
          }
          setHUD();
          renderMissions();
        }
        stageAnimRaf = requestAnimationFrame(step);
      };

      stageAnimRaf = requestAnimationFrame(step);
    }

    function runExercise_PlanSprint(){
      gameTitle.textContent='Exercise Warmup ‚Äî Plan Sprint';
      desc.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏ä‡πà‡∏ß‡∏á';
      center.style.display='none';

      const acts=['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß','‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î','‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö','‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô','‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ï','‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà','‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå'];
      const slots=['‡πÄ‡∏ä‡πâ‡∏≤','‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô','‡πÄ‡∏¢‡πá‡∏ô'];

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'42%',transform:'translate(-50%,-50%)',
        width:'min(760px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)'});
      card.innerHTML = `
        <div style="font-weight:1100;font-size:16px;text-align:center;">‡∏à‡∏±‡∏î‡πÅ‡∏ú‡∏ô 3 ‡∏ä‡πà‡∏ß‡∏á</div>
        <div class="muted" style="margin-top:6px;text-align:center;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏ä‡πà‡∏≠‡∏á</div>
        <div id="slots" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>
        <div id="acts" style="margin-top:12px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;"></div>`;
      stage.appendChild(card);

      const slotsEl=card.querySelector('#slots');
      const actsEl=card.querySelector('#acts');
      const chosen = {‡πÄ‡∏ä‡πâ‡∏≤:'',‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô:'',‡πÄ‡∏¢‡πá‡∏ô:''};

      function renderSlots(){
        slotsEl.innerHTML='';
        slots.forEach(s=>{
          const box=DOC.createElement('div');
          box.style.border='1px solid rgba(148,163,184,.18)';
          box.style.borderRadius='16px';
          box.style.background='rgba(2,6,23,.35)';
          box.style.padding='10px 12px';
          box.style.minHeight='60px';
          box.innerHTML = `<div style="font-weight:1100;">${s}</div><div class="muted" style="margin-top:6px;">${chosen[s]||'‡∏ß‡πà‡∏≤‡∏á'}</div>`;
          slotsEl.appendChild(box);

          box.addEventListener('click', ()=>{
            if(!started) return;
            if(chosen[s]){
              total++;
              chosen[s]='';
              miss++;
              markAction(false);
              toastShow('MISS');
              flashBad();
              renderSlots();
              setHUD(); renderMissions();
            }
          });
        });
      }

      function renderActs(){
        actsEl.innerHTML='';
        const pick = [];
        while(pick.length<6){
          const a = randPick(acts);
          if(!pick.includes(a)) pick.push(a);
        }
        pick.forEach(a=>{
          const b=mkBtn(a);
          b.style.padding='12px 10px';
          b.style.borderRadius='16px';
          actsEl.appendChild(b);
          b.addEventListener('click', ()=>{
            if(!started) return;
            total++;
            const s = slots.find(x=>!chosen[x]);
            if(!s){
              miss++;
              markAction(false);
              toastShow('MISS');
              flashBad();
              setHUD(); renderMissions();
              return;
            }
            chosen[s]=a;

            hitCount++;
            const clutchOn = (tLeft<=4.0 && tLeft>0);
            const add = mult + (clutchOn ? 1 : 0);
            if(clutchOn) clutch++;
            score += add;
            markAction(true);
            toastShow(add>1 ? `+${add} (x${mult})` : '+1');
            flashGood();

            renderSlots();
            if(slots.every(x=>chosen[x])){
              // bonus
              score += 2;
              toastShow('+BONUS', 1);
              flashGood();
            }
            setHUD(); renderMissions();
          });
        });
      }

      renderSlots();
      renderActs();
    }

    function runCooldown_Calm(){
      gameTitle.textContent='Cooldown ‚Äî Calm Breathing';
      desc.textContent='‡πÅ‡∏ï‡∏∞ ‚Äú‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞';
      center.style.display='none';

      const card=DOC.createElement('div');
      Object.assign(card.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-55%)',
        width:'min(560px,92%)',padding:'14px',borderRadius:'18px',border:'1px solid rgba(148,163,184,.18)',
        background:'rgba(2,6,23,.50)',textAlign:'center'});
      card.innerHTML = `
        <div style="font-weight:1100;font-size:16px;">‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞</div>
        <div id="bx" style="margin-top:12px;font-size:56px;">ü´Å</div>
        <div id="bt" style="margin-top:8px;font-size:18px;font-weight:1100;">INHALE</div>
        <div class="muted" style="margin-top:6px;">‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
        <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="btn primary" id="bin">IN</button>
          <button class="btn" id="bout">OUT</button>
        </div>`;
      stage.appendChild(card);

      const bin=card.querySelector('#bin');
      const bout=card.querySelector('#bout');
      const bt=card.querySelector('#bt');

      let cur='IN';
      function next(){
        total++;
        cur = (Math.random()<0.5)?'IN':'OUT';
        bt.textContent = (cur==='IN')?'INHALE':'EXHALE';
      }
      function choose(a){
        if(!started) return;
        if(a===cur){
          hitCount++;
          score += 1;
          markAction(true);
          flashGood();
          toastShow('+1');
        }else{
          miss++;
          markAction(false);
          flashBad();
          toastShow('MISS');
        }
        next();
        setHUD(); renderMissions();
      }
      bin.addEventListener('click', ()=>choose('IN'));
      bout.addEventListener('click', ()=>choose('OUT'));
      next();
    }

    const Theme = {
      goodjunk:  runNutrition_Sort,
      groups:    runNutrition_GroupsMatch,
      hydration: runNutrition_SipRhythm,
      plate:     runNutrition_PlateBuilder,

      handwash:     runHygiene_WashOrder,
      brush:        runHygiene_BrushAngle,
      maskcough:    runHygiene_MaskChoice,
      germdetective:runHygiene_GermDetect,
      germ:         runHygiene_GermDetect,
      bath:         runHygiene_Bath,
      clean:        runHygiene_CleanObjects,
      cleanobjects: runHygiene_CleanObjects,

      shadow:    runExercise_DodgeStrike,
      rhythm:    runExercise_BeatPunch,
      jumpduck:  runExercise_JumpDuck,
      balance:   runExercise_BalanceMeter,
      planner:   runExercise_PlanSprint,
    };

    function start(){
      if(dailyDone){ autoSkipIfDaily(); return; }

      clearStage();

      // reset stats
      score=0; miss=0; total=0;
      hitCount=0;
      streak=0; bestStreak=0;
      mult=1; multBest=1;
      perfect=0; fast=0; clutch=0;
      lastActionAt=0;

      tLeft=dur; lastTs=0;
      setHUD();

      pickedBuff=null;
      if(buffPickWrap) buffPickWrap.style.display='none';

      pickDailyMissions();
      renderMissions();

      endOverlay.style.display='none';
      endOverlay.setAttribute('aria-hidden','true');

      started=true;

      if(phase==='cooldown'){
        runCooldown_Calm();
        statusText.textContent = `Cooldown (${dur}s) ‚Äî pid=${pid} cat=${cat}`;
      }else{
        const fn = Theme[themeKey] || Theme.goodjunk;
        fn();
        statusText.textContent = `Warmup (${dur}s) ‚Äî theme=${themeKey}`;
      }

      subLine.textContent = (phase==='cooldown')
        ? '‡πÄ‡∏•‡πà‡∏ô cooldown ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö/‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'
        : '‡πÄ‡∏•‡πà‡∏ô warmup ‡∏™‡∏±‡πâ‡∏ô ‡πÜ (x2/x3 + clutch) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';

      raf = requestAnimationFrame(tick);
    }

    function skip(){
      const target = (phase==='cooldown') ? (next0 || hub) : (next0 || hub);
      markDaily(dailyPrefix, cat, pid);

      const u = new URL(target, location.href);
      applyPlanSeqParams(u);
      location.replace(u.toString());
    }

    function maybeAutoEnd(){
      if(!started) return;
      if(phase==='cooldown') endNow({ calm: 1 });
      else endNow(makeWarmupBaseBuff());
    }

    pillPhase.textContent = `PHASE: ${phase.toUpperCase()}`;
    pillCat.textContent   = `CAT: ${cat.toUpperCase()}`;
    pillTheme.textContent = `THEME: ${themeKey.toUpperCase()}`;
    pillDaily.textContent = dailyDone ? 'DAILY: DONE' : 'DAILY: NEW';
    durText.textContent = `${dur}s`;

    btnStart.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
    btnSkip.addEventListener('click', (e)=>{ e.preventDefault(); skip(); });

    stage.addEventListener('pointerdown', ()=>{
      if(!started && !dailyDone) start();
    }, {passive:true});

    // initial missions
    pickDailyMissions();
    renderMissions();

    if(!autoSkipIfDaily()){
      const name = (phase==='cooldown')?'Cooldown':'Warmup';
      subLine.textContent = `${name} (${dur}s) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äù`;
      statusText.textContent = `ready: pid=${pid} cat=${cat} theme=${themeKey} next=${next0 ? 'yes' : 'hub'}`;
      setHUD();
    }

    WIN.addEventListener('visibilitychange', ()=>{
      if(DOC.hidden && started) maybeAutoEnd();
    });
  })();
  </script>
</body>
</html>