<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî BOSS Warmup/Cooldown Gate (20s)</title>

  <style>
    :root{
      --bg:#050614;
      --panel:rgba(6,8,26,.72);
      --panel2:rgba(10,14,44,.62);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;

      --pink:#ff2bd6;
      --cyan:#22d3ee;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);

      --r:22px;
      --shadow: 0 20px 80px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif; }
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,43,214,.22) 0%, transparent 55%),
        radial-gradient(1100px 650px at 80% 25%, rgba(34,211,238,.18) 0%, transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(34,197,94,.16) 0%, transparent 55%),
        linear-gradient(180deg, #07081b, #050614);
      overflow:hidden;
    }

    @keyframes rainbowWave{
      0%{ background-position: 0% 50%; }
      50%{ background-position: 100% 50%; }
      100%{ background-position: 0% 50%; }
    }
    @keyframes epicGlow{
      0%,100%{ box-shadow: 0 0 30px rgba(255,43,214,.35), 0 0 60px rgba(34,211,238,.22); }
      50%{ box-shadow: 0 0 55px rgba(255,43,214,.55), 0 0 95px rgba(34,211,238,.35); }
    }
    @keyframes glitch{
      0%,100%{ transform: translate(0) }
      20%{ transform: translate(-2px,1px) }
      40%{ transform: translate(2px,-1px) }
      60%{ transform: translate(-1px,2px) }
      80%{ transform: translate(1px,-2px) }
    }
    @keyframes pop{
      0%{ transform: scale(.8); opacity:.3 }
      100%{ transform: scale(1); opacity:1 }
    }

    .bg-epic{
      background: linear-gradient(-45deg, #ff2bd6, #22d3ee, #f59e0b, #22c55e);
      background-size: 400% 400%;
      animation: rainbowWave 16s ease infinite;
    }

    .wrap{
      height:100%;
      padding: calc(12px + var(--sat)) 12px calc(12px + var(--sab));
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      width:min(980px,100%);
      height:min(740px,100%);
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: calc(var(--r) + 2px);
      background: linear-gradient(90deg, rgba(255,43,214,.55), rgba(34,211,238,.45), rgba(34,197,94,.45));
      opacity:.25;
      filter: blur(14px);
      pointer-events:none;
    }
    header{
      position:relative;
      z-index:1;
      padding: 14px 16px;
      background: rgba(0,0,0,.55);
      border-bottom: 1px solid var(--stroke);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .hleft{ display:flex; flex-direction:column; gap:4px; }
    .title{
      margin:0;
      font-weight: 1000;
      letter-spacing: .4px;
      font-size: 16px;
      display:flex; gap:10px; align-items:center;
    }
    .title .neon{
      background: linear-gradient(90deg, #ff2bd6, #22d3ee, #22c55e);
      -webkit-background-clip:text; background-clip:text;
      color: transparent;
      filter: drop-shadow(0 0 10px rgba(255,43,214,.25));
    }
    .sub{ margin:0; font-size: 12px; color: var(--muted); }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.45);
      font-size:12px;
      color: var(--muted);
    }
    .pill b{ color: var(--text); font-weight: 1000; }
    .pill .dot{
      width:10px; height:10px; border-radius:999px; background: var(--green);
      box-shadow: 0 0 16px rgba(34,197,94,.45);
    }

    main{
      position:relative;
      z-index:1;
      height: calc(100% - 64px);
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 860px){
      main{ grid-template-columns: 1fr; height: calc(100% - 64px); overflow:auto; }
    }

    .panel{
      background: rgba(2,6,23,.45);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 12px;
    }
    .panel.epic{ animation: epicGlow 2.2s ease-in-out infinite; }

    .note{
      border: 1px dashed rgba(148,163,184,.35);
      border-radius: 14px;
      background: rgba(2,6,23,.35);
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .grid3{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px; }
    @media (max-width: 560px){ .grid3{ grid-template-columns: 1fr; } }

    button{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.52);
      color:var(--text);
      padding:12px;
      border-radius: 16px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(148,163,184,.34); background: rgba(2,6,23,.72); }
    button:active{ transform: translateY(0px) scale(.99); }
    button[disabled]{ opacity:.5; cursor:not-allowed; transform:none; }

    .modeBtn{ display:flex; gap:12px; align-items:center; text-align:left; }
    .modeIcon{
      width:48px; height:48px; border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      font-size:22px; font-weight: 1000;
      border:1px solid rgba(255,255,255,.10);
    }
    .mmeta{ display:flex; flex-direction:column; gap:2px; }
    .mmeta .name{ font-weight:1000; letter-spacing:.2px; }
    .mmeta .desc{ font-size:12px; color:var(--muted); }
    .mmeta .tag{ font-size:11px; color: rgba(229,231,235,.9); }

    .actionRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .primary{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
    }
    .primary:hover{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.48); }
    .ghost{ background: rgba(148,163,184,.10); }
    .danger{
      border-color: rgba(239,68,68,.28);
      background: rgba(239,68,68,.12);
    }
    .danger:hover{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.38); }

    .big{
      height:100%;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center;
      gap:10px;
      padding: 10px;
      animation: pop .2s ease-out;
    }
    .emoji{ font-size:70px; filter: drop-shadow(0 16px 28px rgba(0,0,0,.55)); }
    .h2{ margin:0; font-size: 22px; font-weight: 1000; }
    .hint{ margin:0; font-size: 13px; color: var(--muted); max-width: 56ch; }

    .timerRow{
      width:min(560px,100%);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .timeBox{
      padding: 8px 12px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      font-weight: 1000;
      font-size: 13px;
    }
    .bar{
      width:min(560px,100%);
      height: 14px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(255,43,214,.88), rgba(34,211,238,.85), rgba(34,197,94,.85));
      transition: width .12s linear;
    }
    .rank{
      display:inline-flex; gap:10px; align-items:center;
      padding: 10px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.58);
      font-weight:1000;
    }
    .rank b{ font-size: 18px; }
    .rank .badge{
      width:34px; height:34px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      animation: glitch .35s;
    }

    .side h3{ margin:0 0 8px; font-size: 13.5px; letter-spacing:.2px; }
    .side p{ margin:0 0 10px; font-size: 12.5px; color: var(--muted); line-height:1.45; }

    .kv{ display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .kv > div{
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.45);
      font-size: 12.5px;
    }
    .kv b{ font-weight:1000; }

    footer{
      position:absolute; left:0; right:0; bottom:0;
      z-index:1;
      padding: 10px 14px;
      border-top: 1px solid rgba(148,163,184,.12);
      background: rgba(0,0,0,.35);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
    }
    .mini{ opacity:.9; }

    /* meditation arena */
    .arena{
      width:min(560px,100%);
      height: 190px;
      border-radius: 18px;
      border: 1px dashed rgba(148,163,184,.35);
      background: rgba(2,6,23,.35);
      position:relative;
      overflow:hidden;
    }
    .orb{
      position:absolute;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .orb.good{
      width:76px; height:76px;
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.40);
      box-shadow: 0 0 18px rgba(34,197,94,.25);
    }
    .orb.bad{
      width:58px; height:58px;
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
      box-shadow: 0 0 18px rgba(239,68,68,.18);
    }
    .orb span{ font-size: 22px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card" id="app">
    <header>
      <div class="hleft">
        <p class="title"><span class="neon" id="topTitle">‚öîÔ∏è WARMUP BEFORE THE BOSS</span></p>
        <p class="sub" id="topSub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏° 20 ‡∏ß‡∏¥ ‚Äî ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô</p>
      </div>
      <div class="pill">
        <span class="dot"></span>
        phase: <b id="phaseBadge">warmup</b> ¬∑ game: <b id="gameBadge">‚Äî</b>
      </div>
    </header>

    <main>
      <!-- LEFT -->
      <section class="panel epic">
        <div id="screenSelect">
          <div class="note" id="routeNote"></div>

          <div class="grid3">
            <button class="modeBtn" id="btnBreath">
              <div class="modeIcon" style="background:rgba(34,211,238,.10);border-color:rgba(34,211,238,.28)">üå¨Ô∏è</div>
              <div class="mmeta">
                <div class="name">Breath Blade</div>
                <div class="desc">‡∏Å‡∏î‡∏™‡∏•‡∏±‡∏ö ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡∏¥‡∏î</div>
                <div class="tag">BUFF: ‚≠ê Crit + (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ö‡∏≠‡∏™)</div>
              </div>
            </button>

            <button class="modeBtn" id="btnMeditate">
              <div class="modeIcon" style="background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.28)">üßò</div>
              <div class="mmeta">
                <div class="name">Green Focus</div>
                <div class="desc">‡πÅ‡∏ï‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù (‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡∏´‡∏•‡∏≠‡∏Å)</div>
                <div class="tag">BUFF: üõ°Ô∏è Reduce DMG</div>
              </div>
            </button>

            <button class="modeBtn" id="btnStretch">
              <div class="modeIcon" style="background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.28)">ü§∏</div>
              <div class="mmeta">
                <div class="name">Charge Stretch</div>
                <div class="desc">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°</div>
                <div class="tag">BUFF: üíö Heal +</div>
              </div>
            </button>
          </div>

          <div class="actionRow">
            <button class="primary" id="btnCooldown">üòå COOLDOWN 20s</button>
            <button class="ghost" id="btnHub">üè† HUB</button>
            <button class="ghost" id="btnReroll">üé≤ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          </div>
        </div>

        <div id="screenRun" class="big" style="display:none">
          <div class="emoji" id="runEmoji">üå¨Ô∏è</div>
          <h2 class="h2" id="runTitle">WARMUP</h2>
          <p class="hint" id="runHint">‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 20 ‡∏ß‡∏¥</p>

          <div class="timerRow">
            <div class="timeBox" id="runTime">‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 20 ‡∏ß‡∏¥</div>
            <div class="timeBox" id="runPct">‚ö° Power: 0%</div>
          </div>
          <div class="bar"><i id="runBar"></i></div>

          <div id="runArea" style="width:100%; display:flex; justify-content:center; margin-top:10px;"></div>

          <div class="actionRow">
            <button class="danger" id="btnStop">‡∏´‡∏¢‡∏∏‡∏î</button>
          </div>
        </div>

        <div id="screenDone" class="big" style="display:none">
          <div class="emoji">üèÜ</div>
          <h2 class="h2">BUFF ACQUIRED!</h2>
          <p class="hint" id="doneMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏≠‡∏™</p>

          <div class="rank" id="rankBox">
            <span class="badge" id="rankBadge">D</span>
            <div>RANK <b id="rankText">D</b> ¬∑ <span class="mono" id="buffLine">wCrit=0.03</span></div>
          </div>

          <div class="note" style="width:min(560px,100%); text-align:left;">
            ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢ Query:
            <span class="mono">wg=1&wType&wPct&wCrit&wDmg&wHeal&calm&rank</span>
          </div>

          <div class="actionRow">
            <button id="btnAgain">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
            <button class="primary" id="btnGo">‚ñ∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            <button class="ghost" id="btnGoHub">üè† HUB</button>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="panel side">
        <h3>üß≠ Route</h3>
        <p class="mono" id="routeMini"></p>

        <h3>üéØ Buff Range (20s)</h3>
        <div class="kv">
          <div>‚≠ê Crit Bonus</div><div><b>0.03 ‚Üí 0.07</b></div>
          <div>üõ°Ô∏è Dmg Reduce</div><div><b>0.06 ‚Üí 0.16</b></div>
          <div>üíö Heal Bonus</div><div><b>4 ‚Üí 10</b></div>
          <div>üòå Calm</div><div><b>0 ‚Üí 100</b></div>
        </div>

        <h3 style="margin-top:12px;">üé≤ Random Next</h3>
        <p>‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á <span class="mono">next=</span> ‡∏°‡∏≤ ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å pool (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏Å‡∏°‡πÄ‡∏î‡∏¥‡∏°)</p>

        <div class="actionRow" style="margin-top:8px;">
          <button id="btnClear" class="ghost">‡∏•‡πâ‡∏≤‡∏á last pick</button>
        </div>
      </aside>
    </main>

    <footer>
      <div class="mini">HeroHealth ¬∑ Boss Warmup/Cooldown Gate ¬∑ 20s</div>
      <div class="mini" id="footText">‡πÄ‡∏î‡πá‡∏Å ‡∏õ.5: ‡∏™‡∏±‡πâ‡∏ô-‡πÅ‡∏£‡∏á-‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
    </footer>
  </div>
</div>

<script>
(()=> {
  'use strict';

  // -------------------------
  // URL + config
  // -------------------------
  function getQS(){ try{ return new URL(location.href).searchParams; }catch(_){ return new URLSearchParams(); } }
  const QS = getQS();
  const q = (k, d='') => (QS.get(k) ?? d);
  const qNum = (k, d=0)=>{ const v=Number(q(k,'')); return Number.isFinite(v)?v:d; };
  const clamp=(v,a,b)=>Math.max(a, Math.min(b, Number(v)||0));

  const PHASE = (q('phase','warmup')||'warmup').toLowerCase(); // warmup|cooldown
  const GAME  = (q('game','')||'').toLowerCase();             // goodjunk|groups|hydration|plate
  const HUB   = q('hub','');
  const DUR   = clamp(qNum('dur',20), 5, 60);
  const CDUR  = clamp(qNum('cdur',20), 5, 60);

  // next: ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô / ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á -> ‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å pool
  let NEXT = q('next',''); // absolute/relative url
  const AUTORAND = (q('autonext','1') !== '0'); // default ON
  const POOL = (q('pool','')||'').trim();       // comma-separated urls optional

  const KEY_LAST_PICK = 'HHA_NEXT_LAST';
  const KEY_LAST_BUFF = 'HHA_WARMUP_LAST';

  function buildUrl(base, add){
    if(!base) return '';
    try{
      const u = new URL(base, location.href);
      Object.entries(add||{}).forEach(([k,v])=>{
        if(v===undefined||v===null||v==='') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }catch(_){
      const join = base.includes('?') ? '&' : '?';
      const qs = Object.entries(add||{})
        .filter(([,v])=>!(v===undefined||v===null||v===''))
        .map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(String(v))).join('&');
      return qs ? (base + join + qs) : base;
    }
  }

  function getPassthrough(){
    const deny = new Set(['phase','game','hub','dur','cdur','next','pool','autonext']);
    const out = {};
    QS.forEach((v,k)=>{ if(!deny.has(k)) out[k]=v; });
    return out;
  }

  function goHub(){
    if(HUB){ location.href = HUB; return; }
    history.length ? history.back() : (location.href = './');
  }

  function defaultPool(){
    // root launchers ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
    return [
      './goodjunk-vr.html',
      './groups-vr.html',
      './hydration-vr.html',
      './plate-vr.html'
    ];
  }

  function parsePool(){
    if(POOL){
      return POOL.split(',').map(s=>s.trim()).filter(Boolean);
    }
    return defaultPool();
  }

  function pickRandomNext(){
    const pool = parsePool();
    let last = '';
    try{ last = localStorage.getItem(KEY_LAST_PICK) || ''; }catch(_){}
    const candidates = pool.filter(u => u && u !== last);
    const list = candidates.length ? candidates : pool;
    const pick = list[Math.floor(Math.random()*list.length)] || pool[0];
    try{ localStorage.setItem(KEY_LAST_PICK, pick); }catch(_){}
    return pick;
  }

  function ensureNext(){
    if(NEXT) return NEXT;
    if(!AUTORAND) return '';
    NEXT = pickRandomNext();
    return NEXT;
  }

  // -------------------------
  // DOM
  // -------------------------
  const $ = (s)=>document.querySelector(s);

  const topTitle = $('#topTitle');
  const topSub = $('#topSub');
  const phaseBadge = $('#phaseBadge');
  const gameBadge = $('#gameBadge');
  const routeNote = $('#routeNote');
  const routeMini = $('#routeMini');

  const screenSelect = $('#screenSelect');
  const screenRun = $('#screenRun');
  const screenDone = $('#screenDone');

  const runEmoji = $('#runEmoji');
  const runTitle = $('#runTitle');
  const runHint = $('#runHint');
  const runTime = $('#runTime');
  const runPct = $('#runPct');
  const runBar = $('#runBar');
  const runArea = $('#runArea');

  const doneMsg = $('#doneMsg');
  const rankBadge = $('#rankBadge');
  const rankText = $('#rankText');
  const buffLine = $('#buffLine');

  // buttons
  const btnBreath = $('#btnBreath');
  const btnMeditate = $('#btnMeditate');
  const btnStretch = $('#btnStretch');
  const btnCooldown = $('#btnCooldown');
  const btnHub = $('#btnHub');
  const btnReroll = $('#btnReroll');
  const btnStop = $('#btnStop');
  const btnAgain = $('#btnAgain');
  const btnGo = $('#btnGo');
  const btnGoHub = $('#btnGoHub');
  const btnClear = $('#btnClear');

  // -------------------------
  // State
  // -------------------------
  let timerId=null, tickId=null;

  const S = {
    mode: null,        // breath|focus|charge|cooldown
    tLeft: 0,
    pct: 0,

    // breath
    step: 0,
    hits: 0,

    // focus
    good: 0,
    bad: 0,

    // charge
    holding: false,
    holdMs: 0,

    // cooldown
    calm: 0
  };

  function stopTimers(){
    if(timerId){ clearInterval(timerId); timerId=null; }
    if(tickId){ clearInterval(tickId); tickId=null; }
  }
  function show(which){
    screenSelect.style.display = (which==='select') ? '' : 'none';
    screenRun.style.display    = (which==='run')    ? '' : 'none';
    screenDone.style.display   = (which==='done')   ? '' : 'none';
  }

  function setTime(sec){
    S.tLeft = sec;
    runTime.textContent = `‚è±Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${sec} ‡∏ß‡∏¥`;
  }
  function setProgress(p){
    S.pct = clamp(p,0,100);
    runPct.textContent = `‚ö° Power: ${Math.round(S.pct)}%`;
    runBar.style.width = `${S.pct}%`;
  }

  function rankOfPct(p){
    if(p >= 92) return 'S';
    if(p >= 75) return 'A';
    if(p >= 55) return 'B';
    if(p >= 35) return 'C';
    return 'D';
  }

  function makeBuff(){
    const pct = clamp(S.pct,0,100);
    const rank = rankOfPct(pct);

    let out = { wg:1, phase:PHASE, game:GAME, wType:'', wPct:pct, rank };

    if(S.mode === 'breath'){
      out.wType = 'breathing';
      out.wCrit = +(0.03 + (pct/100)*0.04).toFixed(3); // 0.03..0.07
    }else if(S.mode === 'focus'){
      out.wType = 'meditation';
      out.wDmg = +(0.06 + (pct/100)*0.10).toFixed(3);  // 0.06..0.16
    }else if(S.mode === 'charge'){
      out.wType = 'stretching';
      out.wHeal = Math.round(4 + (pct/100)*6);         // 4..10
    }else if(S.mode === 'cooldown'){
      out.wType = 'cooldown';
      out.calm = Math.round(pct);                      // 0..100
    }
    return out;
  }

  function saveLast(buff){
    try{ localStorage.setItem(KEY_LAST_BUFF, JSON.stringify({ ...buff, at:new Date().toISOString() })); }catch(_){}
  }

  function finish(){
    stopTimers();
    const buff = makeBuff();
    saveLast(buff);

    // render
    const isCD = (S.mode === 'cooldown');
    doneMsg.textContent = isCD ? '‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö HUB ‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏á ‡πÜ' : '‡∏ö‡∏±‡∏ü‡∏û‡∏£‡πâ‡∏≠‡∏°! ‚öîÔ∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
    const line = [];
    line.push(`wType=${buff.wType}`);
    line.push(`wPct=${buff.wPct}`);
    if(buff.wCrit!==undefined) line.push(`wCrit=${buff.wCrit}`);
    if(buff.wDmg!==undefined) line.push(`wDmg=${buff.wDmg}`);
    if(buff.wHeal!==undefined) line.push(`wHeal=${buff.wHeal}`);
    if(buff.calm!==undefined) line.push(`calm=${buff.calm}`);
    line.push(`rank=${buff.rank}`);

    rankBadge.textContent = buff.rank;
    rankText.textContent = buff.rank;
    buffLine.textContent = line.join('  ');

    // cooldown phase: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ next ‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
    const n = ensureNext();
    btnGo.disabled = !n || isCD;

    show('done');
  }

  function goNext(){
    const n = ensureNext();
    if(!n) return;
    const buff = makeBuff();

    const add = {
      ...getPassthrough(),
      wg: 1,
      game: GAME || '',
      wType: buff.wType,
      wPct: buff.wPct,
      rank: buff.rank
    };
    if(buff.wCrit!==undefined) add.wCrit = buff.wCrit;
    if(buff.wDmg!==undefined) add.wDmg = buff.wDmg;
    if(buff.wHeal!==undefined) add.wHeal = buff.wHeal;
    if(buff.calm!==undefined) add.calm = buff.calm;

    // ‡∏™‡πà‡∏á hub ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: end game ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÑ‡∏î‡πâ)
    if(HUB) add.hub = HUB;

    location.href = buildUrl(n, add);
  }

  // -------------------------
  // Modes
  // -------------------------
  function commonStart(title, emoji, hint, seconds){
    stopTimers();
    S.tLeft = seconds;
    S.pct = 0;
    S.step = 0; S.hits = 0;
    S.good = 0; S.bad = 0;
    S.holding = false; S.holdMs = 0;
    S.calm = 0;

    runTitle.textContent = title;
    runEmoji.textContent = emoji;
    runHint.textContent = hint;

    setTime(seconds);
    setProgress(0);
    show('run');

    let t = seconds;
    timerId = setInterval(()=>{
      t--;
      setTime(t);
      if(t<=0) finish();
    }, 1000);
  }

  function startBreath(){
    S.mode='breath';
    commonStart(`‚öîÔ∏è Breath Blade (${DUR}s)`, 'üå¨Ô∏è', '‡∏Å‡∏î‡∏™‡∏•‡∏±‡∏ö ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡∏¥‡∏î (‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á‡∏¢‡∏¥‡πà‡∏á‡πÅ‡∏£‡∏á)', DUR);

    runArea.innerHTML = `
      <div style="width:min(560px,100%); display:flex; flex-direction:column; gap:10px; align-items:center;">
        <button class="primary" id="act" style="padding:16px 22px; font-size:16px; font-weight:1000;">INHALE</button>
        <div class="note" style="width:100%; text-align:center;">‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏µ‡πà‡∏û‡∏≠‡∏î‡∏µ (~1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡∏à‡∏∞‡πÑ‡∏î‡πâ Power ‡∏™‡∏π‡∏á</div>
      </div>
    `;
    const act = $('#act');
    const update = ()=>{
      const inhale = (S.step % 2) === 0;
      act.textContent = inhale ? 'INHALE (‡πÄ‡∏Ç‡πâ‡∏≤)' : 'EXHALE (‡∏≠‡∏≠‡∏Å)';
    };
    update();

    act.addEventListener('click', ()=>{
      S.hits++;
      S.step++;
      // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ~1 tap/sec => 20 taps ‡πÑ‡∏î‡πâ 100%
      setProgress(clamp((S.hits / DUR) * 100, 0, 100));
      update();
    });
  }

  function startFocus(){
    S.mode='focus';
    commonStart(`üß† Green Focus (${DUR}s)`, 'üßò', '‡πÅ‡∏ï‡∏∞ ‚Äú‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å!', DUR);

    runArea.innerHTML = `
      <div style="width:min(560px,100%); display:flex; flex-direction:column; gap:10px; align-items:center;">
        <div class="arena" id="arena">
          <div class="orb good" id="good"><span>üü¢</span></div>
          <div class="orb bad" id="bad"><span>üî¥</span></div>
        </div>
        <div class="note" style="width:100%; text-align:center;">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÇ‡∏î‡∏ô = +1 / ‡πÅ‡∏î‡∏á‡πÇ‡∏î‡∏ô = -1 (‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡∏´‡∏•‡∏≠‡∏Å)</div>
      </div>
    `;

    const arena = $('#arena');
    const good = $('#good');
    const bad = $('#bad');

    function place(el){
      const w = arena.clientWidth, h = arena.clientHeight;
      const ew = el.offsetWidth, eh = el.offsetHeight;
      const x = Math.random() * Math.max(1, (w - ew));
      const y = Math.random() * Math.max(1, (h - eh));
      el.style.left = `${x}px`;
      el.style.top  = `${y}px`;
    }
    place(good); place(bad);

    good.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      S.good++;
      place(good);
      // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ~ DUR ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = 100%
      const score = Math.max(0, S.good - S.bad);
      setProgress(clamp((score / DUR) * 100, 0, 100));
    });

    bad.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      S.bad++;
      place(bad);
      const score = Math.max(0, S.good - S.bad);
      setProgress(clamp((score / DUR) * 100, 0, 100));
    });

    tickId = setInterval(()=>{ place(good); place(bad); }, 600);
  }

  function startCharge(){
    S.mode='charge';
    commonStart(`‚ö° Charge Stretch (${DUR}s)`, 'ü§∏', '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏û‡∏•‡∏±‡∏á (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ö‡πà‡∏≠‡∏¢ Power ‡∏à‡∏∞‡∏ï‡∏Å)', DUR);

    runArea.innerHTML = `
      <div style="width:min(560px,100%); display:flex; flex-direction:column; gap:10px; align-items:center;">
        <button class="primary" id="hold" style="padding:18px 26px; font-size:16px; font-weight:1000;">
          HOLD TO CHARGE
        </button>
        <div class="note" style="width:100%; text-align:center;">‡∏ó‡∏£‡∏¥‡∏Ñ: ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‚Äî Power ‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏£‡πá‡∏ß</div>
      </div>
    `;
    const hold = $('#hold');

    const down = (e)=>{ e.preventDefault(); S.holding=true; hold.textContent='CHARGING... ‚ú®'; };
    const up = ()=>{ S.holding=false; hold.textContent='HOLD TO CHARGE'; };

    hold.addEventListener('pointerdown', down);
    window.addEventListener('pointerup', up);
    window.addEventListener('pointercancel', up);

    tickId = setInterval(()=>{
      if(S.holding) S.holdMs += 20;
      setProgress(clamp((S.holdMs / (DUR*1000)) * 100, 0, 100));
    }, 20);
  }

  function startCooldown(){
    S.mode='cooldown';
    commonStart(`üòå Cooldown Ritual (${CDUR}s)`, 'üòå', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞: ‡πÄ‡∏Ç‡πâ‡∏≤ 4 ‚Üí ‡∏≠‡∏≠‡∏Å 4 (‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏ï‡πá‡∏° Calm)', CDUR);

    runArea.innerHTML = `
      <div style="width:min(560px,100%); display:flex; flex-direction:column; gap:10px; align-items:center;">
        <div class="note bg-epic" style="color:#050614; font-weight:1000; width:100%; text-align:center; padding:12px 14px; border:none;">
          BOSS DOWN ‚úÖ  Now‚Ä¶ Calm your core.
        </div>
        <button class="primary" id="ok" style="padding:14px 18px; font-size:15px; font-weight:1000;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</button>
        <div class="note" id="step" style="width:100%; text-align:center;">‡πÄ‡∏Ç‡πâ‡∏≤... 4</div>
      </div>
    `;
    const ok = $('#ok');
    const step = $('#step');

    ok.addEventListener('click', ()=>{
      S.calm = clamp(S.calm + 3, 0, 100);
      setProgress(S.calm);
    });

    let phase='in', k=4;
    tickId = setInterval(()=>{
      k--;
      if(k<=0){ phase = (phase==='in')?'out':'in'; k=4; }
      step.textContent = (phase==='in') ? `‡πÄ‡∏Ç‡πâ‡∏≤... ${k}` : `‡∏≠‡∏≠‡∏Å... ${k}`;
      S.calm = clamp(S.calm + 1.2, 0, 100);
      setProgress(S.calm);
    }, 1000);
  }

  // -------------------------
  // UI init
  // -------------------------
  phaseBadge.textContent = PHASE;
  gameBadge.textContent = GAME || 'random';

  function renderRoute(){
    const pool = parsePool().join(', ');
    const nx = NEXT || '(auto)';
    routeMini.textContent =
      `phase=${PHASE}  game=${GAME||'(none)'}  dur=${DUR}  cdur=${CDUR}  next=${nx}  hub=${HUB||'(none)'}  pool=[${pool}]`;

    if(PHASE === 'cooldown'){
      topTitle.textContent = 'üíÄ BOSS DOWN ‚Üí COOLDOWN RITUAL';
      topSub.textContent = '‡∏û‡∏±‡∏Å‡πÉ‡∏à 20 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö HUB';
      routeNote.innerHTML =
        `‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå <b>${CDUR}s</b> ¬∑ ‡∏Å‡∏•‡∏±‡∏ö HUB: ${HUB ? `<span class="mono">${HUB}</span>` : `<span style="color:rgba(245,158,11,.95)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á hub=</span>`}`;
    }else{
      const will = ensureNext();
      topTitle.textContent = '‚öîÔ∏è WARMUP BEFORE THE BOSS';
      topSub.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏° 20 ‡∏ß‡∏¥ ‚Äî ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô';
      routeNote.innerHTML =
        `‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ <b>${DUR}s</b> ¬∑ ‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${
          will ? `<span class="mono">${will}</span>` : `<span style="color:rgba(245,158,11,.95)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ next= ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î autonext</span>`
        }${HUB ? `<br/>HUB: <span class="mono">${HUB}</span>` : ''}`;
    }
  }
  renderRoute();

  // -------------------------
  // Buttons
  // -------------------------
  btnBreath.addEventListener('click', startBreath);
  btnMeditate.addEventListener('click', startFocus);
  btnStretch.addEventListener('click', startCharge);
  btnCooldown.addEventListener('click', ()=>{
    // manual cooldown even in warmup phase (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏•‡∏≠‡∏á)
    startCooldown();
  });

  btnHub.addEventListener('click', goHub);
  btnGoHub.addEventListener('click', goHub);

  btnStop.addEventListener('click', ()=>{ stopTimers(); show('select'); });
  btnAgain.addEventListener('click', ()=>{ stopTimers(); show('select'); });
  btnGo.addEventListener('click', goNext);

  btnReroll.addEventListener('click', ()=>{
    // force reroll (clear last and pick fresh)
    try{ localStorage.removeItem(KEY_LAST_PICK); }catch(_){}
    NEXT = '';
    ensureNext();
    renderRoute();
    alert('‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß üé≤');
  });

  btnClear.addEventListener('click', ()=>{
    try{ localStorage.removeItem(KEY_LAST_PICK); }catch(_){}
    alert('‡∏•‡πâ‡∏≤‡∏á last pick ‡πÅ‡∏•‡πâ‡∏ß');
  });

  // -------------------------
  // Auto behavior
  // -------------------------
  if(PHASE === 'cooldown'){
    show('run');
    startCooldown();
  }else{
    show('select');
  }
})();
</script>
</body>
</html>
