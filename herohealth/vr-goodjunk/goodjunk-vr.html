<!-- === /herohealth/vr-goodjunk/goodjunk-vr.html ===
GoodJunkVR (Run) ‚Äî PRODUCTION SAFE
FULL v20260225p2-SAFE-SPAWNSAFE-cooldownBtn
‚úÖ Uses goodjunk.safe.js (export boot)
‚úÖ Computes HUD-safe spawn rect -> window.__HHA_SPAWN_SAFE__
‚úÖ Works PC/Mobile + view=cvr ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ hha:shoot (via /herohealth/vr/vr-ui.js)
‚úÖ End overlay shows cooldown button (injected by JS) + Back HUB button (always)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Ä¢ GoodJunkVR</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="stylesheet" href="./goodjunk-vr.css" />
</head>
<body class="view-mobile">
  <div class="gj-stage" id="stage">
    <!-- progress -->
    <div class="gj-progress" aria-hidden="false"><div id="gjProgressFill"></div></div>

    <!-- HUD -->
    <header class="gj-hud" id="hudRoot">
      <div class="gj-hud-row">
        <div class="gj-card">
          <div class="gj-stat">
            <span class="k">SCORE</span><span class="v" id="hud-score">0</span>
            <span class="k">TIME</span><span class="v" id="hud-time">0</span>
            <span class="k">MISS</span><span class="v" id="hud-miss">0</span>
            <span class="k">GRADE</span><span class="v" id="hud-grade">‚Äî</span>
          </div>

          <div class="gj-bars">
            <div class="gj-bar">
              <span style="min-width:60px;opacity:.9">FEVER</span>
              <div class="track"><div id="feverFill"></div></div>
              <span id="feverText">0%</span>
            </div>
            <div class="gj-bar">
              <span style="min-width:60px;opacity:.9">SHIELD</span>
              <div style="flex:1;opacity:.95;font-weight:1000" id="shieldPills">‚Äî</div>
            </div>
          </div>

          <div class="gj-mini">
            <span class="chip">üéØ <span id="hud-goal">‚Äî</span> <span style="opacity:.9">:</span>
              <span id="hud-goal-cur">0</span>/<span id="hud-goal-target">0</span>
              <span style="opacity:.85" id="goalDesc">‚Äî</span>
            </span>
            <span class="chip">‚è± <span id="hud-mini">‚Äî</span> <span id="miniTimer">‚Äî</span></span>
          </div>
        </div>

        <div class="gj-card" style="min-width:160px;text-align:right">
          <div style="font-weight:1100;letter-spacing:.2px;opacity:.92">GOOD vs JUNK</div>
          <div style="margin-top:6px;opacity:.9;font-size:12px;line-height:1.35">
            ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ü•¶üçé<br/>
            ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù üçüüçî<br/>
            view=cvr ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏á
          </div>
        </div>
      </div>
    </header>

    <!-- boss bar -->
    <div id="bossBar" aria-hidden="true">
      <div class="boss-wrap">
        <div class="boss-top">
          <div style="font-weight:1100">üëπ BOSS</div>
          <div style="opacity:.92" id="bossHint">‚Äî</div>
        </div>
        <div class="boss-track"><div id="bossFill"></div></div>
      </div>
    </div>

    <!-- layers -->
    <div id="gj-layer" aria-label="GoodJunk Layer"></div>
    <div id="gj-layer-r" aria-label="GoodJunk Layer R"></div>

    <!-- debug -->
    <div id="gjDebug" aria-hidden="true">debug</div>

    <!-- low time overlay -->
    <div id="lowTimeOverlay" aria-hidden="true">
      <div class="lowtime-pill"><span id="gj-lowtime-num">5</span></div>
    </div>

    <!-- end overlay -->
    <div id="endOverlay" aria-hidden="true">
      <div class="end-card panel">
        <div class="end-title" id="endTitle">Game Over</div>
        <div class="end-sub" id="endSub">‚Äî</div>

        <div class="end-grid">
          <div class="end-item"><div class="k">GRADE</div><div class="v" id="endGrade">‚Äî</div></div>
          <div class="end-item"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
          <div class="end-item"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
          <div class="end-item"><div class="k">PLAYED (s)</div><div class="v" id="endTime">0</div></div>
        </div>

        <div class="end-actions">
          <button class="btn" id="btnRestart" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          <button class="btn primary" id="btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        </div>
        <!-- NOTE: JS ‡∏à‡∏∞ inject ‡∏õ‡∏∏‡πà‡∏° "‡πÑ‡∏õ Cooldown (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)" ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô .panel -->
      </div>
    </div>
  </div>

  <script type="module">
    import { boot } from './goodjunk.safe.js';

    // ===== query helpers =====
    const qs = (k, d='')=>{ try{ return (new URL(location.href)).searchParams.get(k) ?? d; }catch(e){ return d; } };

    // ===== view class =====
    const view = String(qs('view','mobile')).toLowerCase();
    document.body.classList.remove('view-mobile','view-pc','view-vr','view-cvr');
    document.body.classList.add(`view-${view}`);

    // ===== debug toggle =====
    const dbg = qs('debug','0')==='1';
    const dbgEl = document.getElementById('gjDebug');
    if(dbgEl) dbgEl.setAttribute('aria-hidden', dbg ? 'false' : 'true');

    // ===== SPAWN SAFE RECT COMPUTE =====
    // This creates a viewport-safe rectangle excluding:
    // - top HUD block (hudRoot + bossBar area)
    // - bottom safe region for VR UI / coach / end buttons
    // Result stored in window.__HHA_SPAWN_SAFE__ (viewport coords)
    function computeSpawnSafe(){
      const layer = document.getElementById('gj-layer');
      if(!layer) return;

      const lr = layer.getBoundingClientRect();
      const hud = document.getElementById('hudRoot');
      const boss = document.getElementById('bossBar');

      const hudR = hud ? hud.getBoundingClientRect() : { bottom: lr.top + 140 };
      const bossR = boss && boss.getAttribute('aria-hidden')!=='true'
        ? boss.getBoundingClientRect()
        : null;

      const topBlock = Math.max(hudR.bottom, bossR ? bossR.bottom : 0);

      // conservative bottoms (VR buttons / coach)
      const sab = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sab')) || 0;
      const bottomBlock = window.innerHeight - (sab + 110);

      const padSide = 14;
      const padTop = 10;
      const padBot = 10;

      const xMin = Math.max(lr.left + padSide, 0);
      const xMax = Math.min(lr.right - padSide, window.innerWidth);
      const yMin = Math.max(topBlock + padTop, lr.top + 10);
      const yMax = Math.min(bottomBlock - padBot, lr.bottom - 10);

      const safe = { xMin, xMax, yMin, yMax };
      window.__HHA_SPAWN_SAFE__ = safe;

      if(typeof window.__GJ_SET_SPAWN_SAFE__ === 'function'){
        try{ window.__GJ_SET_SPAWN_SAFE__(safe); }catch(e){}
      }

      if(dbg && dbgEl){
        dbgEl.textContent =
          `safe x[${xMin|0},${xMax|0}] y[${yMin|0},${yMax|0}]  view=${view}`;
      }
    }

    window.addEventListener('resize', ()=> setTimeout(computeSpawnSafe, 60), { passive:true });
    window.addEventListener('orientationchange', ()=> setTimeout(computeSpawnSafe, 180), { passive:true });
    setTimeout(computeSpawnSafe, 30);

    // ===== Buttons =====
    const hub = qs('hub','../hub.html');
    const btnBackHub = document.getElementById('btnBackHub');
    const btnRestart = document.getElementById('btnRestart');
    if(btnBackHub) btnBackHub.addEventListener('click', ()=> location.href = hub);
    if(btnRestart) btnRestart.addEventListener('click', ()=> location.reload());

    // ===== Listen end summary (optional hook) =====
    window.addEventListener('hha:game-ended', (ev)=>{
      // keep last summary in localStorage too (optional, safe)
      try{
        localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(ev.detail||null));
      }catch(e){}
      setTimeout(computeSpawnSafe, 60);
    });

    // ===== VR UI (ENTER VR / RECENTER / crosshair -> hha:shoot) =====
    // If your repo already has this module, keep this import.
    // If not present yet, comment it out.
    try{
      await import('../vr/vr-ui.js');
    }catch(e){
      // no-op (still works on PC/Mobile)
    }

    // ===== Boot game =====
    boot({
      view,
      run: qs('run','play'),
      diff: qs('diff','normal'),
      time: qs('time','80'),
      seed: qs('seed', String(Date.now())),
      pid: qs('pid','anon'),
      hub
    });
  </script>
</body>
</html>