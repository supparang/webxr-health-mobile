<!-- === /herohealth/vr-goodjunk/goodjunk-vr.html ===
GoodJunkVR RUN ‚Äî PRODUCTION (v4.3-std compatible) ‚Äî FULL PATCH (Warmup/Cooldown Gate)
‚úÖ Uses: goodjunk-vr.css
‚úÖ Boot: goodjunk-vr.boot.js (strict auto view + safe-measure)
‚úÖ Engine: goodjunk.safe.js (v4.3-std) imported by boot
‚úÖ Optional: ai-hooks.js (Pack 1‚Äì4)
‚úÖ Optional: hha-cloud-logger.js (flush-hardened)
‚úÖ NO MENU / NO view override (boot ignores ?view)
‚úÖ ADD: Warmup (20s) gate before enter, Cooldown (20s) gate before Hub
   - gate=1 (default) => warmup -> back here -> game starts; end/backHub -> cooldown -> hub
   - gate=0 => skip gates
   - gateState=warmupdone => prevents warmup loop
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunkVR</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#020617" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./goodjunk-vr.css" />

  <style>
    html,body{ overscroll-behavior:none; }
  </style>
</head>

<body class="gj" data-game="goodjunk" data-pack="goodjunk-v4.3-std">

  <!-- ===== TOPBAR ===== -->
  <header class="gj-topbar" role="banner" aria-label="GoodJunkVR Topbar">
    <div class="left">
      <span class="gj-chip" aria-label="Game name">ü•ó GoodJunkVR</span>
      <span class="gj-chip" aria-label="Mode" id="chipMode">PLAY</span>
      <span class="gj-chip" aria-label="Difficulty" id="chipDiff">NORMAL</span>
    </div>

    <div class="right">
      <button class="gj-btn" id="btnMissions" type="button" aria-label="Show missions">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
      <button class="gj-btn" id="btnHideHud" type="button" aria-label="Toggle HUD">‡∏ã‡πà‡∏≠‡∏ô HUD</button>
      <button class="gj-btn primary" id="btnBackHub" type="button" aria-label="Back to Hub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
    </div>
  </header>

  <!-- ===== PROGRESS BAR ===== -->
  <div class="gj-progress" aria-label="Progress">
    <div class="gj-progress-fill" id="gjProgressFill"></div>
  </div>

  <!-- ===== HUD TOP ===== -->
  <section class="gj-hud-top" id="hud" aria-label="HUD Top">
    <div class="hud-row">
      <div class="hud-pill">
        <div class="hud-label">SCORE</div>
        <div class="hud-value" id="hud-score">0</div>
      </div>
      <div class="hud-pill warn">
        <div class="hud-label">TIME</div>
        <div class="hud-value" id="hud-time">‚Äî</div>
      </div>
      <div class="hud-pill">
        <div class="hud-label">MISS</div>
        <div class="hud-value" id="hud-miss">0</div>
      </div>
      <div class="hud-pill grade">
        <div class="hud-label">GRADE</div>
        <div class="hud-value" id="hud-grade">‚Äî</div>
      </div>
      <div class="hud-pill">
        <div class="hud-label">SHIELD</div>
        <div class="hud-value" id="shieldPills">‚Äî</div>
      </div>
    </div>

    <div class="gj-boss" id="bossBar" aria-hidden="true">
      <div class="gj-boss-title">üëæ BOSS</div>
      <div class="gj-boss-meter">
        <div class="gj-boss-fill" id="bossFill" style="width:100%"></div>
      </div>
      <div class="gj-boss-hint" id="bossHint">‚Äî</div>
    </div>

    <div class="quest-row" aria-label="Quests">
      <div class="quest-card">
        <div class="q-title">GOAL: <span id="hud-goal">‚Äî</span></div>
        <div class="q-desc" id="goalDesc">‚Äî</div>
        <div class="q-bar">
          <div class="q-num"><span id="hud-goal-cur">0</span> / <span id="hud-goal-target">0</span></div>
          <div class="q-hint">‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
        </div>
      </div>

      <div class="quest-card mini">
        <div class="q-title">MINI</div>
        <div class="q-desc" id="hud-mini">‚Äî</div>
        <div class="q-bar">
          <div class="q-num" id="miniTimer">‚Äî</div>
          <div class="q-hint">‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡πá‡∏ß ‡πÜ</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== PLAYFIELD ===== -->
  <div class="gj-field" id="playfield" aria-hidden="true"></div>

  <!-- ===== TARGET LAYERS ===== -->
  <div class="gj-layer" id="gj-layer" aria-label="Play layer left"></div>
  <div class="gj-layer gj-layer-r" id="gj-layer-r" aria-label="Play layer right" aria-hidden="true"></div>

  <!-- ===== FX Layer ===== -->
  <div class="hha-fx-layer" id="fxLayer" aria-hidden="true"></div>

  <!-- ===== BOTTOM HUD ===== -->
  <footer class="gj-hud-bot" id="gjHudBot" aria-label="HUD Bottom">
    <div class="meter" id="feverBox" aria-label="Fever meter">
      <div class="meter-title">FEVER</div>
      <div class="meter-bar">
        <div class="meter-fill" id="feverFill"></div>
      </div>
      <div class="meter-num">‡∏û‡∏•‡∏±‡∏á: <span id="feverText">0%</span></div>
      <div class="meter-tip" id="feverTip">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢!</div>
    </div>

    <div class="meter" id="howtoBox" aria-label="How to play">
      <div class="meter-title">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</div>
      <div class="meter-tip">
        ‡πÅ‡∏ï‡∏∞/‡∏¢‡∏¥‡∏á ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‚úÖ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö<br/>
        ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù ‚ùå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏•‡πà‡∏à‡∏∞ BLOCK ‡πÑ‡∏î‡πâ)<br/>
        ‚≠ê ‡∏•‡∏î MISS, üõ°Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏•‡πà (Shield)
      </div>
    </div>
  </footer>

  <!-- ===== Quick controls ===== -->
  <div class="hha-controls" aria-label="Quick controls">
    <button class="gj-btn" id="btnHideHud2" type="button">HUD</button>
    <button class="gj-btn" id="btnRestart" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <!-- ===== Missions Peek ===== -->
  <section class="gj-peek" id="missionsPeek" aria-label="Missions Overlay">
    <div class="peek-card" role="dialog" aria-modal="true" aria-label="Missions">
      <div class="peek-title">üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
      <div class="peek-sub" id="peekGoal">GOAL: ‚Äî</div>
      <div class="peek-mini" id="peekMini">MINI: ‚Äî</div>
      <div class="peek-tip">‡∏ó‡∏¥‡∏õ: ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢! (‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î)</div>
      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="gj-btn primary" id="btnClosePeek" type="button" style="flex:1;">‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠</button>
        <button class="gj-btn" id="btnShowHowto" type="button" style="flex:1;">‡πÅ‡∏™‡∏î‡∏á HOWTO</button>
      </div>
    </div>
  </section>

  <!-- ===== Low time overlay ===== -->
  <div class="gj-lowtime-overlay" id="lowTimeOverlay" aria-hidden="true">
    <div class="gj-lowtime-ring"></div>
    <div class="gj-lowtime-num" id="gj-lowtime-num">5</div>
  </div>

  <!-- ===== End overlay ===== -->
  <section id="endOverlay" aria-hidden="true"
    style="position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center; padding:16px;">
    <div style="width:min(720px, 94vw); background:rgba(2,6,23,.78); border:1px solid rgba(148,163,184,.18);
                border-radius:22px; padding:16px; box-shadow: 0 18px 60px rgba(0,0,0,.45);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:1000; font-size:18px;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div id="endBadge"
          style="display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px;
                 border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.55); font-weight:900;">
          ‚Äî
        </div>
      </div>

      <div id="endGrid"
        style="margin-top:12px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;">
        <div style="border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px; background:rgba(2,6,23,.35);">
          <div style="color:rgba(148,163,184,.92); font-size:11px; font-weight:900;">SCORE</div>
          <div id="endScore" style="font-size:18px; font-weight:1100;">0</div>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px; background:rgba(2,6,23,.35);">
          <div style="color:rgba(148,163,184,.92); font-size:11px; font-weight:900;">GRADE</div>
          <div id="endGrade" style="font-size:18px; font-weight:1100;">‚Äî</div>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px; background:rgba(2,6,23,.35);">
          <div style="color:rgba(148,163,184,.92); font-size:11px; font-weight:900;">MISS</div>
          <div id="endMiss" style="font-size:18px; font-weight:1100;">0</div>
        </div>
        <div style="border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px; background:rgba(2,6,23,.35);">
          <div style="color:rgba(148,163,184,.92); font-size:11px; font-weight:900;">ACCURACY</div>
          <div id="endAcc" style="font-size:18px; font-weight:1100;">‚Äî</div>
        </div>
      </div>

      <div style="margin-top:12px; color:rgba(229,231,235,.80); font-weight:900; font-size:12px; line-height:1.35;">
        ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏ñ‡πâ‡∏≤ ‚ÄúMISS ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‚Äù ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏ã‡πà‡∏≠‡∏ô HUD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏≤‡∏°‡πÇ‡∏•‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏î safe-area ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="gj-btn primary" id="btnEndRestart" type="button" style="flex:1 1 200px;">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="gj-btn" id="btnEndBackHub" type="button" style="flex:1 1 200px;">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </section>

  <!-- Optional AI hooks -->
  <script src="../vr/ai-hooks.js"></script>

  <!-- Optional Cloud Logger -->
  <script src="../vr/hha-cloud-logger.js"></script>

  <!-- Boot (ESM) -->
  <script type="module" src="./goodjunk-vr.boot.js"></script>

  <!-- UI wiring + Gate Router (single, loop-safe) -->
  <script>
  (function(){
    'use strict';
    const DOC = document;
    const WIN = window;

    const $ = (id)=>DOC.getElementById(id);

    function qs(k, def=null){
      try{ return new URL(location.href).searchParams.get(k) ?? def; }
      catch{ return def; }
    }
    function sp(){
      try{ return new URL(location.href).searchParams; }
      catch{ return new URLSearchParams(); }
    }
    function buildUrl(base, add){
      const u = new URL(base, location.href);
      Object.entries(add||{}).forEach(([k,v])=>{
        if(v===undefined || v===null || v==='') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }
    function withParams(add){
      return buildUrl(location.href, add||{});
    }

    // ---------------------------
    // Gate config
    // ---------------------------
    const GATE_ON = String(qs('gate','1') || '1'); // default ON
    const GATE_STATE = String(qs('gateState','') || '');
    const HUB = String(qs('hub','../hub.html'));
    const WARMUP_SEC = Number(qs('dur','20') || 20) || 20;
    const COOLDOWN_SEC = Number(qs('cdur','20') || 20) || 20;

    // Put your gate page path here (absolute path is OK on GitHub Pages)
    const GATE_PATH = '/herohealth/warmup-gate.html';

    // pass-through: keep gameplay params, but remove router internals
    function passthroughForGate(){
      const deny = new Set(['next','autonext','phase','dur','cdur','gateState']); // keep gate itself
      const out = {};
      sp().forEach((v,k)=>{ if(!deny.has(k)) out[k] = v; });
      // always preserve hub explicitly
      out.hub = HUB;
      return out;
    }

    function goWarmupThenBack(){
      // return to same page but mark warmup done => no loop
      const backHere = withParams({ gate: 1, gateState: 'warmupdone' });

      const url = buildUrl(GATE_PATH, {
        ...passthroughForGate(),
        phase: 'warmup',
        dur: WARMUP_SEC,
        next: backHere,
        autonext: 1
      });
      location.replace(url);
    }

    function goCooldownThenHub(){
      // prevent double-cooldown (e.g. end triggers + user clicks)
      if(String(qs('gateState','')) === 'cooldown') { location.href = HUB; return; }

      const url = buildUrl(GATE_PATH, {
        ...passthroughForGate(),
        phase: 'cooldown',
        cdur: COOLDOWN_SEC,
        next: HUB,
        autonext: 1,
        gateState: 'cooldown'
      });
      location.href = url;
    }

    // expose for debugging if needed
    WIN.HHA = WIN.HHA || {};
    WIN.HHA.goCooldownThenHub = goCooldownThenHub;

    // ---------------------------
    // Warmup gate (run once)
    // ---------------------------
    const gateEnabled = (GATE_ON === '1' || GATE_ON === 'true');
    if(gateEnabled && GATE_STATE !== 'warmupdone'){
      // avoid redirecting if we are already on gate page
      const p = String(location.pathname || '');
      if(!p.includes('warmup-gate')){
        goWarmupThenBack();
        return; // stop normal init, page will come back after warmup
      }
    }

    // ---------------------------
    // Chips
    // ---------------------------
    function setChips(){
      const run = String(qs('run','play')).toUpperCase();
      const diff = String(qs('diff','normal')).toUpperCase();
      const chipMode = $('chipMode');
      const chipDiff = $('chipDiff');
      if(chipMode) chipMode.textContent = run;
      if(chipDiff) chipDiff.textContent = diff;
    }
    setChips();

    // ---------------------------
    // HUD toggle
    // ---------------------------
    function toggleHud(){
      DOC.body.classList.toggle('hud-hidden');
    }
    const btnHideHud  = $('btnHideHud');
    const btnHideHud2 = $('btnHideHud2');
    if(btnHideHud)  btnHideHud.addEventListener('click', toggleHud, { passive:true });
    if(btnHideHud2) btnHideHud2.addEventListener('click', toggleHud, { passive:true });

    // ---------------------------
    // Missions peek
    // ---------------------------
    const btnMissions = $('btnMissions');
    const peek = $('missionsPeek');
    const btnClosePeek = $('btnClosePeek');
    const btnShowHowto = $('btnShowHowto');
    const peekGoal = $('peekGoal');
    const peekMini = $('peekMini');

    function openPeek(){
      DOC.body.classList.add('show-missions');
      const g = $('hud-goal')?.textContent || '‚Äî';
      const gd = $('goalDesc')?.textContent || '‚Äî';
      const mini = $('hud-mini')?.textContent || '‚Äî';
      if(peekGoal) peekGoal.textContent = `GOAL: ${g} ‚Äî ${gd}`;
      if(peekMini) peekMini.textContent = `MINI: ${mini}`;
    }
    function closePeek(){ DOC.body.classList.remove('show-missions'); }

    if(btnMissions) btnMissions.addEventListener('click', openPeek, { passive:true });
    if(btnClosePeek) btnClosePeek.addEventListener('click', closePeek, { passive:true });
    if(peek){
      peek.addEventListener('click', (e)=>{ if(e.target === peek) closePeek(); }, { passive:true });
    }
    if(btnShowHowto){
      btnShowHowto.addEventListener('click', ()=>{ DOC.body.classList.toggle('show-howto'); }, { passive:true });
    }

    // ---------------------------
    // Restart
    // ---------------------------
    function restart(){
      try{ location.replace(new URL(location.href).toString()); }
      catch(_){ location.reload(); }
    }
    const btnRestart = $('btnRestart');
    const btnEndRestart = $('btnEndRestart');
    if(btnRestart) btnRestart.addEventListener('click', restart, { passive:true });
    if(btnEndRestart) btnEndRestart.addEventListener('click', restart, { passive:true });

    // ---------------------------
    // Back HUB => cooldown gate (if enabled)
    // ---------------------------
    const btnBackHub = $('btnBackHub');
    const btnEndBackHub = $('btnEndBackHub');

    function backHubHandler(e){
      try{ e.preventDefault(); }catch(_){}
      if(gateEnabled) goCooldownThenHub();
      else location.href = HUB;
    }
    if(btnBackHub) btnBackHub.addEventListener('click', backHubHandler);
    if(btnEndBackHub) btnEndBackHub.addEventListener('click', backHubHandler);

    // ---------------------------
    // End overlay + cooldown on end
    // ---------------------------
    const endOverlay = $('endOverlay');
    const endScore = $('endScore');
    const endGrade = $('endGrade');
    const endMiss = $('endMiss');
    const endAcc = $('endAcc');
    const endBadge = $('endBadge');

    function showEnd(summary){
      try{
        if(!endOverlay) return;
        endOverlay.style.display = 'flex';
        endOverlay.setAttribute('aria-hidden','false');

        const score = summary?.scoreFinal ?? summary?.score ?? 0;
        const grade = summary?.grade ?? '‚Äî';
        const miss  = summary?.miss ?? summary?.misses ?? 0;
        const acc   = (summary?.accuracyPct != null) ? (String(summary.accuracyPct) + '%') : '‚Äî';
        const tier  = summary?.tier || '';

        if(endScore) endScore.textContent = String(score);
        if(endGrade) endGrade.textContent = String(grade);
        if(endMiss)  endMiss.textContent  = String(miss);
        if(endAcc)   endAcc.textContent   = String(acc);
        if(endBadge) endBadge.textContent = tier ? `${tier} ¬∑ ${grade}` : String(grade);
      }catch(_){}
    }

    WIN.addEventListener('hha:end', (e)=>{
      showEnd(e?.detail || {});
      // after showing end, go cooldown gate (autonext) if enabled
      if(gateEnabled) {
        // tiny delay so user sees overlay flash (optional)
        setTimeout(()=>{ goCooldownThenHub(); }, 350);
      }
    });

    // ---------------------------
    // Logger init (optional)
    // ---------------------------
    try{
      if(WIN.HHA_LOGGER && typeof WIN.HHA_LOGGER.init === 'function'){
        WIN.HHA_LOGGER.init({
          game:'goodjunk',
          pack:'goodjunk-v4.3-std',
          studyId: qs('studyId', qs('study','')),
          phase: qs('phase',''),
          conditionGroup: qs('conditionGroup', qs('cond','')),
          run: qs('run','play'),
          diff: qs('diff','normal')
        });
      }
    }catch(_){}
  })();
  </script>

</body>
</html>