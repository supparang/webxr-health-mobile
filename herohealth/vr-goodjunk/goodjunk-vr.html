<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- UI -->
  <link rel="stylesheet" href="./goodjunk-vr.css" />

  <!-- Global FX + Cloud Logger (ต้องอยู่ก่อน boot เพื่อให้พร้อม) -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>

  <!-- Boot (module) -->
  <script type="module" src="./goodjunk-vr.boot.js"></script>

  <!-- ✅ Layout variables (default baseline; engine will use #gj-stage rect anyway) -->
  <style>
    :root{
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);

      /* dynamic measured offsets (JS will update) */
      --gj-top-dyn: 0px;     /* reserved space above playfield (HUD etc.) */
      --gj-bot-dyn: 0px;     /* reserved space below playfield (controls etc.) */

      /* extra safety margin around play rect */
      --gj-pad-x: 12px;
      --gj-pad-y: 10px;
    }

    /* ✅ Stage is the ONLY spawn-safe playfield */
    #gj-stage{
      position: fixed;
      inset: 0;
      z-index: 20;
      overflow: hidden;

      /* Safe-area + dynamic reserved zones */
      padding-top:  calc(var(--sat) + var(--gj-top-dyn) + var(--gj-pad-y));
      padding-right:calc(var(--sar) + var(--gj-pad-x));
      padding-bottom:calc(var(--sab) + var(--gj-bot-dyn) + var(--gj-pad-y));
      padding-left: calc(var(--sal) + var(--gj-pad-x));

      /* let targets be positioned in layers inside */
      pointer-events: none;
    }

    /* layers catch clicks */
    #gj-layer, #gj-layer-r{ pointer-events:auto; }

    /* ✅ If HUD hidden, stage uses no top reserve */
    body.hud-hidden{
      --gj-top-dyn: 0px;
    }

    /* ✅ In VR/cVR, we keep playfield maximal (HUD hidden) */
    body.view-vr, body.view-cvr{
      --gj-top-dyn: 0px;
    }

    /* ✅ ensure overlays can sit above playfield */
    #startOverlay{ z-index: 200; }
  </style>
</head>

<body class="view-mobile">

  <!-- LOW TIME WARNING RING -->
  <div class="gj-warning-ring" aria-hidden="true"></div>

  <!-- VR MINI HUD (show only in VR/cVR) -->
  <div class="vr-mini-hud" id="vrMiniHud">
    <div class="mini-row">
      <div class="mini-pill"><span>SCORE</span><b id="miniScore">0</b></div>
      <div class="mini-pill"><span>TIME</span><b id="miniTime">0</b></div>
      <div class="mini-pill"><span>GRADE</span><b id="miniGrade">—</b></div>
      <button class="mini-btn" id="btnPeek" type="button">Missions</button>
    </div>
  </div>

  <!-- HUD -->
  <div class="hha-hud" id="hud">
    <div class="hud-top">
      <div class="hud-badge">
        <div class="hud-title">GoodJunkVR</div>
        <div class="hud-sub" id="hudSub">ยิงดีเลี่ยง “ขยะ”</div>

        <div class="viewbar">
          <button class="pill ghost" id="btnMissions" type="button">Missions</button>
          <button class="pill ghost" id="btnHideHud" type="button">Hide HUD</button>
        </div>
      </div>

      <div class="hud-stats">
        <div class="hud-stat"><div class="k">SCORE</div><div class="v" id="hud-score">0</div></div>
        <div class="hud-stat"><div class="k">TIME</div><div class="v" id="hud-time">0</div></div>
        <div class="hud-stat"><div class="k">MISS</div><div class="v" id="hud-miss">0</div></div>
        <div class="hud-stat"><div class="k">GRADE</div><div class="v" id="hud-grade">—</div></div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="hud-quest">
        <div class="q-row">
          <div class="q-title" id="hud-goal">—</div>
          <div class="q-count">
            <span id="hud-goal-cur">0</span>/<span id="hud-goal-target">0</span>
          </div>
        </div>
        <div class="q-progress" id="goalDesc">—</div>

        <div style="height:10px"></div>

        <div class="q-row">
          <div class="q-title mini">MINI</div>
          <div class="q-timer" id="miniTimer">—</div>
        </div>
        <div class="q-progress" id="hud-mini">—</div>

        <div style="display:none" id="hud-combo">0</div>
      </div>
    </div>
  </div>

  <!-- MISSIONS PEEK -->
  <div class="gj-peek" id="peek" aria-hidden="true">
    <div class="peek-card">
      <div class="peek-title">Missions</div>
      <div class="peek-sub" id="peekGoal">—</div>
      <div class="peek-mini" id="peekMini">—</div>
      <div class="peek-tip" id="peekTip">แตะ/ยิงเพื่อปิด</div>
    </div>
  </div>

  <!-- FEVER -->
  <div class="hha-fever" id="feverBox">
    <div class="fever-row">
      <div class="fever-label">FEVER</div>
      <div class="fever-bar"><div class="fever-fill" id="feverFill"></div></div>
      <div class="fever-text" id="feverText">0%</div>
    </div>

    <div class="shield-row">
      <div class="shield-label">SHIELD</div>
      <div class="shield-pills" id="shieldPills">—</div>
    </div>
  </div>

  <!-- ✅ STAGE = playfield safe rect (engine spawns inside this) -->
  <div id="gj-stage" aria-hidden="false">
    <div class="gj-eye eye-l">
      <div class="gj-layer" id="gj-layer"></div>
      <div class="gj-crosshair" id="crosshairL"></div>
    </div>

    <div class="gj-eye eye-r">
      <div class="gj-layer" id="gj-layer-r"></div>
      <div class="gj-crosshair" id="crosshairR"></div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="hha-controls" id="controlsBox">
    <button class="btn-shoot" id="btnShoot" type="button">ยิง / TAP</button>
  </div>

  <!-- LOWTIME BIG COUNTDOWN -->
  <div class="gj-lowtime-overlay" id="lowTimeOverlay" aria-hidden="true">
    <div class="gj-lowtime-num" id="gj-lowtime-num">5</div>
  </div>

  <!-- START OVERLAY -->
  <div id="startOverlay" style="
    position:fixed; inset:0; z-index:200;
    display:flex; align-items:center; justify-content:center;
    background: rgba(2,6,23,.86); backdrop-filter: blur(10px);
  ">
    <div style="
      width:min(720px,92vw);
      background: rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.20);
      border-radius: 22px;
      padding:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    ">
      <div style="font-size:26px;font-weight:1200;">GoodJunkVR</div>
      <div id="startMeta" style="margin-top:8px;color:#94a3b8;font-weight:900;font-size:12px;">—</div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="btnStart" type="button" style="
          border:1px solid rgba(34,197,94,.30);
          background: rgba(34,197,94,.16);
          color:#eafff3;
          border-radius: 14px;
          padding:12px 16px;
          font-weight:1200;
          font-size:16px;
        ">Start</button>

        <button id="btnStartVR" type="button" style="
          border:1px solid rgba(34,211,238,.30);
          background: rgba(34,211,238,.14);
          color:#e9fbff;
          border-radius: 14px;
          padding:12px 16px;
          font-weight:1200;
          font-size:16px;
        ">Enter VR</button>
      </div>

      <div style="margin-top:12px;color:#94a3b8;font-weight:900;font-size:12px;">
        Mobile: แตะเป้าได้ / VR(cVR): เล็งกลางจอแล้วแตะ “ยิง”
      </div>
    </div>
  </div>

  <!-- ✅ INLINE UI + LAYOUT WIRING -->
  <script>
  (function(){
    const qs = (k,d=null)=>{ try{return new URL(location.href).searchParams.get(k) ?? d;}catch{return d;} };

    const overlay   = document.getElementById('startOverlay');
    const meta      = document.getElementById('startMeta');
    const btnStart  = document.getElementById('btnStart');
    const btnStartVR= document.getElementById('btnStartVR');

    const peek = document.getElementById('peek');
    const btnMissions = document.getElementById('btnMissions');
    const btnPeek = document.getElementById('btnPeek');
    const btnHideHud = document.getElementById('btnHideHud');

    const hud = document.getElementById('hud');
    const fever = document.getElementById('feverBox');
    const controls = document.getElementById('controlsBox');

    const view = qs('view','mobile');
    const diff = qs('diff','normal');
    const run  = qs('run','play');
    meta.textContent = `view=${view} | run=${run} | diff=${diff}`;

    // --------- START overlay -> boot -----------
    function start(){
      overlay.style.display = 'none';
      window.__HHA_PENDING_START__ = { view };
      window.dispatchEvent(new CustomEvent('hha:start', { detail:{ view } }));
      // layout after overlay hides
      requestAnimationFrame(()=>measureAndApply());
      setTimeout(measureAndApply, 80);
    }
    btnStart.addEventListener('click', start);

    btnStartVR.addEventListener('click', ()=>{
      window.dispatchEvent(new CustomEvent('hha:enter-cvr'));
      start();
    });

    // shoot button => engine listens via event
    document.getElementById('btnShoot').addEventListener('click', ()=>{
      window.dispatchEvent(new CustomEvent('hha:shoot'));
    });

    // mission peek close by any tap
    if(peek) peek.addEventListener('click', ()=> peek.setAttribute('aria-hidden','true'));

    function openPeek(){
      if(!peek) return;
      peek.setAttribute('aria-hidden','false');
      try{
        document.getElementById('peekGoal').textContent =
          (document.getElementById('hud-goal')?.textContent || '—') + ' ' +
          (document.getElementById('hud-goal-cur')?.textContent || '0') + '/' +
          (document.getElementById('hud-goal-target')?.textContent || '0');
        document.getElementById('peekMini').textContent =
          document.getElementById('hud-mini')?.textContent || '—';
      }catch(_){}
    }

    if(btnMissions) btnMissions.addEventListener('click', openPeek);
    if(btnPeek) btnPeek.addEventListener('click', openPeek);

    if(btnHideHud) btnHideHud.addEventListener('click', ()=>{
      document.body.classList.toggle('hud-hidden');
      measureAndApply();
      setTimeout(measureAndApply, 60);
    });

    // ✅ sync mini HUD from main HUD (VR/cVR)
    setInterval(()=>{
      const s = document.getElementById('hud-score')?.textContent || '0';
      const t = document.getElementById('hud-time')?.textContent || '0';
      const g = document.getElementById('hud-grade')?.textContent || '—';
      const ms = document.getElementById('miniScore'); if(ms) ms.textContent = s;
      const mt = document.getElementById('miniTime');  if(mt) mt.textContent = t;
      const mg = document.getElementById('miniGrade'); if(mg) mg.textContent = g;
    }, 180);

    // --------- ✅ LAYOUT MEASURE: reserve space so targets never go under HUD/controls ----------
    function px(n){ return Math.max(0, Math.round(n)) + 'px'; }

    function rect(el){
      try{
        if(!el) return null;
        const st = getComputedStyle(el);
        if(st.display === 'none' || st.visibility === 'hidden' || Number(st.opacity)===0) return null;
        return el.getBoundingClientRect();
      }catch(_){ return null; }
    }

    function measureAndApply(){
      try{
        const b = document.body;
        const v = (b.classList.contains('view-vr') ? 'vr' :
                  b.classList.contains('view-cvr') ? 'cvr' :
                  b.classList.contains('view-pc') ? 'pc' : 'mobile');

        // In VR/cVR: we don’t reserve top dyn (HUD hidden in CSS)
        if(v==='vr' || v==='cvr' || b.classList.contains('hud-hidden')){
          document.documentElement.style.setProperty('--gj-top-dyn', '0px');
        }else{
          const rh = rect(hud);
          const rf = rect(fever);
          let top = 0;
          if(rh) top = Math.max(top, rh.bottom);
          // fever usually bottom-right; shouldn’t affect top reserved, but keep safety if it overlaps top
          if(rf && rf.top < top) top = Math.max(top, rf.bottom);
          // reserve until bottom edge of top overlays
          document.documentElement.style.setProperty('--gj-top-dyn', px(top));
        }

        // Bottom reserve from controls (shoot button), and any bottom overlays
        let bot = 0;
        const rc = rect(controls);
        if(rc){
          bot = Math.max(bot, (window.innerHeight - rc.top));
        }
        // low time overlay is center; ignore

        document.documentElement.style.setProperty('--gj-bot-dyn', px(bot));
      }catch(_){}
    }

    // run early (even before start)
    measureAndApply();
    window.addEventListener('resize', ()=>{ measureAndApply(); setTimeout(measureAndApply, 80); }, { passive:true });
    window.addEventListener('orientationchange', ()=>{ setTimeout(measureAndApply, 120); }, { passive:true });

    // if view class changes (boot.js), remeasure
    const mo = new MutationObserver(()=>{ measureAndApply(); });
    mo.observe(document.body, { attributes:true, attributeFilter:['class'] });

  })();
  </script>

</body>
</html>
