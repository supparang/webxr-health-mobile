<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — GoodJunkVR (RUN)</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- ✅ CSS (must match your provided goodjunk-vr.css) -->
  <link rel="stylesheet" href="./goodjunk-vr.css" />

  <!-- ✅ Optional Cloud Logger (reads ?log=...) -->
  <script defer src="../vr/hha-cloud-logger.js"></script>

  <!-- ✅ AI Pack 1–4 -->
  <script defer src="../vr/ai-hooks.js"></script>
</head>

<body class="gj view-mobile">
  <!-- =========================
       TOPBAR
  ========================== -->
  <header class="gj-topbar" role="banner" aria-label="GoodJunkVR Topbar">
    <div class="left">
      <div class="gj-chip" aria-label="Game">GoodJunkVR</div>
      <div class="gj-chip" aria-label="Mode" id="chipMode">PLAY</div>
      <div class="gj-chip" aria-label="Difficulty" id="chipDiff">NORMAL</div>
    </div>
    <div class="right">
      <button class="gj-btn" id="btnMissions" type="button" aria-label="Missions">MISSIONS</button>
      <button class="gj-btn" id="btnHideHud" type="button" aria-label="Toggle HUD">HUD</button>
      <button class="gj-btn primary" id="btnBackHub" type="button" aria-label="Back to HUB">HUB</button>
    </div>
  </header>

  <!-- ✅ Progress bar -->
  <div class="gj-progress" aria-hidden="true">
    <div class="gj-progress-fill" id="gjProgressFill"></div>
  </div>

  <!-- =========================
       HUD TOP (must match safe.js ids)
  ========================== -->
  <section class="gj-hud-top" id="hud" aria-label="HUD Top">
    <div class="hud-row" aria-label="HUD Main Row">
      <div class="hud-pill">
        <div class="hud-label">SCORE</div>
        <div class="hud-value" id="hud-score">0</div>
      </div>

      <div class="hud-pill">
        <div class="hud-label">TIME</div>
        <div class="hud-value" id="hud-time">0</div>
      </div>

      <div class="hud-pill warn">
        <div class="hud-label">MISS</div>
        <div class="hud-value" id="hud-miss">0</div>
      </div>

      <div class="hud-pill grade">
        <div class="hud-label">GRADE</div>
        <div class="hud-value" id="hud-grade">—</div>
      </div>

      <div class="hud-pill">
        <div class="hud-label">SHIELD</div>
        <div class="hud-value" id="shieldPills">—</div>
      </div>
    </div>

    <!-- ✅ Goals + Mini -->
    <div class="quest-row" aria-label="Quests">
      <div class="quest-card">
        <div class="q-title">GOAL: <span id="hud-goal">—</span></div>
        <div class="q-desc" id="goalDesc">—</div>
        <div class="q-bar">
          <div class="q-num"><span id="hud-goal-cur">0</span> / <span id="hud-goal-target">0</span></div>
          <div class="q-hint">ทำให้ครบเพื่อปลดล็อกความท้าทาย</div>
        </div>
      </div>

      <div class="quest-card mini">
        <div class="q-title">MINI QUEST</div>
        <div class="q-desc" id="hud-mini">ครบ 3 หมู่ใน 12 วิ (0/3)</div>
        <div class="q-bar">
          <div class="q-num" id="miniTimer">12s</div>
          <div class="q-hint">โบนัส: MISS-1 / SHIELD</div>
        </div>
      </div>
    </div>

    <!-- ✅ Boss UI (safe.js toggles aria-hidden) -->
    <div class="gj-boss" id="bossBar" aria-hidden="true">
      <div class="gj-boss-title">BOSS PHASE</div>
      <div class="gj-boss-meter">
        <div class="gj-boss-fill" id="bossFill"></div>
      </div>
      <div class="gj-boss-hint" id="bossHint">—</div>
    </div>
  </section>

  <!-- =========================
       PLAYFIELD / LAYERS (ids must match safe.js)
  ========================== -->
  <main class="gj-field" id="playfield" role="main" aria-label="Playfield">
    <div class="gj-layer" id="gj-layer" aria-label="Layer Left"></div>
    <div class="gj-layer-r" id="gj-layer-r" aria-label="Layer Right (cVR)"></div>
  </main>

  <!-- =========================
       HUD BOTTOM (Fever + Howto)
  ========================== -->
  <footer class="gj-hud-bot" id="gjHudBot" aria-label="HUD Bottom">
    <div class="meter" id="feverBox" aria-label="Fever Meter">
      <div class="meter-title">FEVER</div>
      <div class="meter-bar" aria-hidden="true">
        <div class="meter-fill" id="feverFill"></div>
      </div>
      <div class="meter-num" id="feverText">0%</div>
      <div class="meter-tip">เก็บของดีต่อเนื่องเพื่อทำคอมโบ / อย่าโดนของเสีย</div>
    </div>

    <div class="meter" id="howtoBox" aria-label="How to Play">
      <div class="meter-title">HOW TO</div>
      <div class="meter-tip">
        • แตะ/คลิก “ของดี” เพื่อเก็บคะแนน<br/>
        • หลีกเลี่ยง “ของเสีย” (โดนแล้ว MISS เพิ่ม)<br/>
        • VR/cVR: ยิงด้วย crosshair (vr-ui.js) หรือแตะจอ<br/>
        • ทำ GOAL + MINI เพื่อโบนัส!
      </div>
    </div>
  </footer>

  <!-- ✅ Quick controls cluster (boot measures this too) -->
  <div class="hha-controls" aria-label="Quick Controls">
    <button class="gj-btn" id="btnHideHud2" type="button">Toggle HUD</button>
  </div>

  <!-- ✅ Missions Peek overlay -->
  <section class="gj-peek" id="missionsPeek" aria-hidden="true">
    <div class="peek-card">
      <div class="peek-title">MISSIONS (Peek)</div>
      <div class="peek-sub" id="peekGoal">GOAL: —</div>
      <div class="peek-mini" id="peekMini">MINI: —</div>
      <div class="peek-tip">แตะที่พื้น/กด MISSIONS อีกครั้งเพื่อปิด</div>
    </div>
  </section>

  <!-- ✅ Low time overlay (safe.js uses these ids) -->
  <div class="gj-lowtime-overlay" id="lowTimeOverlay" aria-hidden="true">
    <div class="gj-lowtime-ring"></div>
    <div class="gj-lowtime-num" id="gj-lowtime-num">5</div>
  </div>

  <!-- ✅ Boot (module) -->
  <script type="module" src="./goodjunk-vr.boot.js"></script>

  <!-- ✅ Minimal UI glue: HUD toggle + Missions peek + Back HUB + live quest peek -->
  <script>
    (function(){
      'use strict';
      const qs = (k, d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch{ return d; } };
      const $ = (id)=>document.getElementById(id);

      const btnHideHud  = $('btnHideHud');
      const btnHideHud2 = $('btnHideHud2');
      const btnMissions = $('btnMissions');
      const btnBackHub  = $('btnBackHub');

      const chipMode = $('chipMode');
      const chipDiff = $('chipDiff');

      const run  = String(qs('run','play')).toUpperCase();
      const diff = String(qs('diff','normal')).toUpperCase();
      if(chipMode) chipMode.textContent = run;
      if(chipDiff) chipDiff.textContent = diff;

      function toggleHud(){ document.body.classList.toggle('hud-hidden'); }
      if(btnHideHud)  btnHideHud.addEventListener('click', toggleHud);
      if(btnHideHud2) btnHideHud2.addEventListener('click', toggleHud);

      function toggleMissions(){
        const on = document.body.classList.toggle('show-missions');
        const peek = $('missionsPeek');
        if(peek) peek.setAttribute('aria-hidden', on ? 'false' : 'true');
      }
      if(btnMissions) btnMissions.addEventListener('click', toggleMissions);

      // Close missions when tapping outside
      document.addEventListener('pointerdown', (e)=>{
        if(!document.body.classList.contains('show-missions')) return;
        const peek = $('missionsPeek');
        if(peek && peek.contains(e.target)) return;
        if(e.target === btnMissions) return;
        document.body.classList.remove('show-missions');
        if(peek) peek.setAttribute('aria-hidden','true');
      }, { passive:true });

      // Live update peek text from quest:update
      window.addEventListener('quest:update', (e)=>{
        const d = e.detail || {};
        const g = d.goal || {};
        const m = d.mini || {};
        const pg = $('peekGoal');
        const pm = $('peekMini');
        if(pg) pg.textContent = `GOAL: ${(g.title||'—')} (${g.cur||0}/${g.target||0})`;
        if(pm) pm.textContent = `MINI: ${(m.cur||0)}/${(m.target||0)} ${m.done ? '✅' : ''}`;
      }, { passive:true });

      // Back HUB
      function goHub(){
        const hub = qs('hub', null);
        if(hub) location.href = hub;
        else location.href = '../hub.html';
      }
      if(btnBackHub) btnBackHub.addEventListener('click', goHub);
    })();
  </script>
</body>
</html>