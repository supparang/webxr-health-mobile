// === /herohealth/vr-goodjunk/goodjunk-vr.boot.js ===
// GoodJunkVR Boot — PRODUCTION
// ✅ Auto-detect view WITHOUT overriding explicit ?view=
// ✅ Sets body view classes + eye layer (gj-layer-r) for vr/cvr
// ✅ Ensures vr-ui.js is loaded (if not already)
// ✅ Boots goodjunk.safe.js with payload from URL (hub/run/diff/time/seed/study params)

import { boot as engineBoot } from './goodjunk.safe.js';

const DOC = document;
const WIN = window;

function qs(k, def = null) {
  try { return new URL(location.href).searchParams.get(k) ?? def; }
  catch { return def; }
}

function isTouchDevice() {
  return ('ontouchstart' in WIN) || ((navigator.maxTouchPoints|0) > 0);
}

function detectViewNoOverride() {
  const explicit = String(qs('view','')).toLowerCase();
  if (explicit) return explicit; // ✅ do not override

  const isTouch = isTouchDevice();
  const w = Math.max(1, WIN.innerWidth || 1);
  const h = Math.max(1, WIN.innerHeight || 1);
  const landscape = w >= h;

  // Heuristic:
  // - PC: no touch or big screen
  // - cVR: touch + landscape + width >= ~740
  // - mobile: touch (portrait or smaller)
  if (!isTouch) return 'pc';
  if (landscape && w >= 740) return 'cvr';
  return 'mobile';
}

function normalizeView(v) {
  v = String(v || '').toLowerCase().trim();
  if (v === 'auto' || !v) return detectViewNoOverride();

  // allow aliases
  if (v === 'cardboard') return 'cvr';
  if (v === 'desktop') return 'pc';

  if (v !== 'pc' && v !== 'mobile' && v !== 'vr' && v !== 'cvr') {
    // unknown -> detect (but still respects explicit if user typed weird)
    return detectViewNoOverride();
  }
  return v;
}

function setBodyView(view) {
  const b = DOC.body;
  if (!b) return;

  b.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
  b.classList.add(
    view === 'pc' ? 'view-pc' :
    view === 'vr' ? 'view-vr' :
    view === 'cvr'? 'view-cvr' : 'view-mobile'
  );

  // helpful tags for CSS tweaks
  b.dataset.view = view;
}

function setEyeLayer(view) {
  const r = DOC.getElementById('gj-layer-r');
  if (!r) return;

  // show right-eye layer only for vr/cvr
  const on = (view === 'vr' || view === 'cvr');
  r.setAttribute('aria-hidden', on ? 'false' : 'true');
}

function ensureVrUiLoaded() {
  // If already loaded, ok
  if (WIN.__HHA_VRUI_LOADED__) return;

  // If script tag exists (defer), it will load soon; do nothing.
  const existing = DOC.querySelector('script[src*="/vr/vr-ui.js"],script[src$="vr-ui.js"]');
  if (existing) return;

  // Otherwise inject best-effort
  const s = DOC.createElement('script');
  s.src = '../vr/vr-ui.js';
  s.defer = true;
  DOC.head.appendChild(s);
}

function setChipMeta(view, run, diff, time) {
  const el = DOC.getElementById('gjChipMeta');
  if (!el) return;
  el.textContent = `view=${view} · run=${run} · diff=${diff} · time=${time}`;
}

function buildPayload(view) {
  const run  = String(qs('run','play') || 'play').toLowerCase();   // play|research
  const diff = String(qs('diff','normal') || 'normal').toLowerCase();
  const time = Number(qs('time','80') || 80) || 80;

  const hub  = (qs('hub', null) || null);
  const seed = (qs('seed', null) || null);

  // research context passthrough (optional)
  const studyId = qs('studyId', qs('study', null));
  const phase   = qs('phase', null);
  const conditionGroup = qs('conditionGroup', qs('cond', null));

  return {
    view,
    run,
    diff,
    time,
    hub,
    seed,

    // research fields (optional)
    studyId,
    phase,
    conditionGroup,
  };
}

function bootNow() {
  const view = normalizeView(qs('view','auto'));
  const payload = buildPayload(view);

  // ✅ UI mode
  setBodyView(view);
  setEyeLayer(view);
  ensureVrUiLoaded();
  setChipMeta(view, payload.run, payload.diff, payload.time);

  // Option: kid UI (looser layout) via ?ui=kid
  const ui = String(qs('ui','') || '').toLowerCase();
  if (ui === 'kid') DOC.body.classList.add('ui-kid');

  // ✅ Boot engine
  try {
    engineBoot(payload);
  } catch (err) {
    console.error('[GoodJunkVR boot] engineBoot failed:', err);
  }
}

// DOM ready
if (DOC.readyState === 'loading') {
  DOC.addEventListener('DOMContentLoaded', bootNow, { once: true });
} else {
  bootNow();
}

// Resize/orientation: keep eye-layer + view class stable
WIN.addEventListener('resize', ()=>{
  try {
    const view = normalizeView(qs('view','auto'));
    setBodyView(view);
    setEyeLayer(view);
  } catch(_){}
}, { passive:true });

WIN.addEventListener('orientationchange', ()=>{
  try {
    const view = normalizeView(qs('view','auto'));
    setBodyView(view);
    setEyeLayer(view);
  } catch(_){}
}, { passive:true });