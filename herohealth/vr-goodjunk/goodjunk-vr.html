<!-- === /herohealth/vr-goodjunk/goodjunk-vr.html ===
GoodJunkVR RUN ‚Äî FOLDER (PRODUCTION)
‚úÖ Uses: ./goodjunk-vr.css (playable layout)
‚úÖ Loads: ../vr/particles.js (optional FX) + ../vr/hha-fx-director.js (optional)
‚úÖ Loads: ../vr/hha-cloud-logger.js (optional logger)
‚úÖ Boots: ./goodjunk-vr.boot.js (module) -> boots ./goodjunk.safe.js (module)
‚úÖ Layers: #gj-layer + #gj-layer-r for cVR split
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunkVR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" />

  <!-- ‚úÖ PLAYABLE LAYOUT (must be this path) -->
  <link rel="stylesheet" href="./goodjunk-vr.css" />

  <!-- (Optional) FX core: creates .hha-fx-layer -->
  <script defer src="../vr/particles.js"></script>
  <script defer src="../vr/hha-fx-director.js"></script>

  <!-- (Optional) Cloud logger (flush-hardened) -->
  <script defer src="../vr/hha-cloud-logger.js"></script>

  <!-- ‚úÖ Boot (module) ‚Äî strict auto + safe-measure fix -->
  <script type="module" src="./goodjunk-vr.boot.js"></script>
</head>

<body class="gj view-mobile">
  <!-- ================= TOPBAR ================= -->
  <div class="gj-topbar" role="banner" aria-label="topbar">
    <div class="left">
      <div class="gj-chip" aria-label="game">ü•ó GoodJunkVR</div>
      <div class="gj-chip" id="modeChip" aria-label="mode">MODE: ‚Äî</div>
      <div class="gj-chip" id="diffChip" aria-label="difficulty">DIFF: ‚Äî</div>
    </div>

    <div class="right">
      <button class="gj-btn" id="btnMissions" type="button" aria-label="missions">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
      <button class="gj-btn" id="btnHideHud" type="button" aria-label="toggle hud">‡∏ã‡πà‡∏≠‡∏ô HUD</button>
      <button class="gj-btn primary" id="btnBackHub" type="button" aria-label="back hub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
    </div>
  </div>

  <!-- ================= PROGRESS ================= -->
  <div class="gj-progress" aria-label="progress">
    <div class="gj-progress-fill" id="gjProgressFill" style="width:0%"></div>
  </div>

  <!-- ================= HUD TOP ================= -->
  <div class="gj-hud-top" id="hud" aria-label="hud top">
    <div class="hud-row" aria-label="stats">
      <div class="hud-pill">
        <div class="hud-label">SCORE</div>
        <div class="hud-value" id="hud-score">0</div>
      </div>
      <div class="hud-pill warn">
        <div class="hud-label">TIME</div>
        <div class="hud-value" id="hud-time">‚Äî</div>
      </div>
      <div class="hud-pill">
        <div class="hud-label">MISS</div>
        <div class="hud-value" id="hud-miss">0</div>
      </div>
      <div class="hud-pill grade">
        <div class="hud-label">GRADE</div>
        <div class="hud-value" id="hud-grade">‚Äî</div>
      </div>
    </div>

    <!-- Boss bar (safe.js toggles aria-hidden) -->
    <div class="gj-boss" id="bossBar" aria-hidden="true" aria-label="boss bar">
      <div class="gj-boss-title">BOSS</div>
      <div class="gj-boss-meter">
        <div class="gj-boss-fill" id="bossFill" style="width:100%"></div>
      </div>
      <div class="gj-boss-hint" id="bossHint">‚Äî</div>
    </div>

    <div class="quest-row" aria-label="quests">
      <div class="quest-card" aria-label="main goal">
        <div class="q-title">GOAL: <span id="hud-goal">‚Äî</span></div>
        <div class="q-desc" id="goalDesc">‚Äî</div>
        <div class="q-bar">
          <div class="q-num"><span id="hud-goal-cur">0</span>/<span id="hud-goal-target">0</span></div>
          <div class="q-hint">‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
        </div>
      </div>

      <div class="quest-card mini" aria-label="mini quest">
        <div class="q-title">MINI</div>
        <div class="q-desc" id="hud-mini">‚Äî</div>
        <div class="q-bar">
          <div class="q-num" id="miniTimer">‚Äî</div>
          <div class="q-hint">‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ‚≠ê/üõ°Ô∏è</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= PLAYFIELD ================= -->
  <div class="gj-field" id="playfield" aria-label="playfield">
    <!-- IMPORTANT: targets spawn into these layers -->
    <div class="gj-layer" id="gj-layer" aria-label="layer left"></div>
    <div class="gj-layer gj-layer-r" id="gj-layer-r" aria-label="layer right" aria-hidden="true"></div>
  </div>

  <!-- ================= BOTTOM HUD ================= -->
  <div class="gj-hud-bot" id="gjHudBot" aria-label="hud bottom">
    <div class="meter" id="feverBox" aria-label="fever meter">
      <div class="meter-title">FEVER / BOOST</div>
      <div class="meter-bar">
        <div class="meter-fill" id="feverFill" style="width:18%"></div>
      </div>
      <div class="meter-num">FEVER: <span id="feverText">18%</span> | SHIELD: <span id="shieldPills">‚Äî</span></div>
      <div class="meter-tip">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢!</div>
    </div>

    <div class="meter" id="howtoBox" aria-label="how to">
      <div class="meter-title">HOW TO</div>
      <div class="meter-tip">
        ‚Ä¢ ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‚Äù ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶üçé<br/>
        ‚Ä¢ ‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ üçüü•§<br/>
        ‚Ä¢ ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/VR: ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ crosshair (ENTER VR ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠)
      </div>
    </div>
  </div>

  <!-- quick controls cluster (clickable, not blocking playfield) -->
  <div class="hha-controls" aria-label="controls">
    <button class="gj-btn" id="btnHideHud2" type="button">HUD</button>
    <button class="gj-btn" id="btnMissions2" type="button">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
  </div>

  <!-- ================= Missions Peek ================= -->
  <div class="gj-peek" id="missionsPeek" aria-label="missions overlay">
    <div class="peek-card" role="dialog" aria-modal="true" aria-label="missions">
      <div class="peek-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Missions)</div>
      <div class="peek-sub"><b>GOAL:</b> <span id="peekGoal">‚Äî</span></div>
      <div class="peek-mini"><b>MINI:</b> <span id="peekMini">‚Äî</span></div>
      <div class="peek-tip">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
    </div>
  </div>

  <!-- ================= Low Time Overlay ================= -->
  <div class="gj-lowtime-overlay" id="lowTimeOverlay" aria-hidden="true" aria-label="low time">
    <div class="gj-lowtime-ring" aria-hidden="true"></div>
    <div class="gj-lowtime-num" id="gj-lowtime-num">5</div>
  </div>

  <!-- ================= End Overlay (optional; safe.js emits hha:end anyway) ================= -->
  <div class="gj-end" id="endOverlay" aria-hidden="true" aria-label="end overlay">
    <div class="card">
      <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="sub" id="endSub">‚Äî</div>

      <div class="grid" aria-label="end stats">
        <div class="stat"><span>SCORE</span><b id="endScore">0</b></div>
        <div class="stat"><span>MISS</span><b id="endMiss">0</b></div>
        <div class="stat"><span>COMBO MAX</span><b id="endCombo">0</b></div>
        <div class="stat"><span>GRADE</span><b id="endGrade">‚Äî</b></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReplay" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn alt" id="btnBackHub2" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

<script>
/* === GoodJunkVR RUN UI glue (no deps) ===
- HUD toggle
- Missions overlay toggle
- Back HUB
- End overlay render from hha:end
- Keep everything non-blocking: playfield gets pointer events, HUD is pointer-events:none
*/
(function(){
  'use strict';
  const DOC = document;

  const qs = (k, def=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? def; }catch{ return def; } };
  const hub = qs('hub', null);

  function $(sel){ return DOC.querySelector(sel); }
  function on(id, fn){
    const el = DOC.getElementById(id);
    if(el) el.addEventListener('click', fn, { passive:true });
  }

  function toggleHud(){
    DOC.body.classList.toggle('hud-hidden');
    // boot listens clicks and remeasures; also safe.js can request gj:measureSafe
    try{ window.dispatchEvent(new CustomEvent('gj:measureSafe', { detail:{} })); }catch(_){}
  }

  function toggleMissions(){
    DOC.body.classList.toggle('show-missions');
    const open = DOC.body.classList.contains('show-missions');
    if(open){
      // read current texts from HUD
      const g = (DOC.getElementById('hud-goal')?.textContent||'‚Äî').trim();
      const m = (DOC.getElementById('hud-mini')?.textContent||'‚Äî').trim();
      const peekGoal = DOC.getElementById('peekGoal');
      const peekMini = DOC.getElementById('peekMini');
      if(peekGoal) peekGoal.textContent = g;
      if(peekMini) peekMini.textContent = m;
    }
  }

  function goHub(){
    if(hub){
      location.href = hub;
    }else{
      // fallback to root hub
      location.href = '../hub.html';
    }
  }

  // bind
  on('btnHideHud', toggleHud);
  on('btnHideHud2', toggleHud);

  on('btnMissions', toggleMissions);
  on('btnMissions2', toggleMissions);

  on('btnBackHub', goHub);
  on('btnBackHub2', goHub);

  // close missions by clicking backdrop
  const peek = DOC.getElementById('missionsPeek');
  if(peek){
    peek.addEventListener('click', (e)=>{
      // click outside card closes
      if(e && e.target === peek) toggleMissions();
    }, { passive:true });
  }

  // show mode chips
  const run = (qs('run','play')||'play').toLowerCase();
  const diff = (qs('diff','normal')||'normal').toLowerCase();
  const modeChip = DOC.getElementById('modeChip');
  const diffChip = DOC.getElementById('diffChip');
  if(modeChip) modeChip.textContent = `MODE: ${run.toUpperCase()}`;
  if(diffChip) diffChip.textContent = `DIFF: ${diff.toUpperCase()}`;

  // end overlay rendering
  window.addEventListener('hha:end', (e)=>{
    const d = (e && e.detail) ? e.detail : {};
    const end = DOC.getElementById('endOverlay');
    if(!end) return;

    DOC.getElementById('endScore').textContent = String(d.scoreFinal ?? d.score ?? 0);
    DOC.getElementById('endMiss').textContent  = String(d.miss ?? 0);
    DOC.getElementById('endCombo').textContent = String(d.comboMax ?? 0);
    DOC.getElementById('endGrade').textContent = String(d.grade ?? '‚Äî');

    const sub = DOC.getElementById('endSub');
    if(sub){
      const played = d.durationPlayedSec ?? '';
      const planned = d.durationPlannedSec ?? '';
      const boss = (d.bossCleared ? 'BOSS ‚úÖ' : 'BOSS ‚Äî');
      sub.textContent = `‡πÄ‡∏ß‡∏•‡∏≤ ${played}/${planned} ‡∏ß‡∏¥ ‚Ä¢ ${boss} ‚Ä¢ seed=${d.seed ?? '‚Äî'}`;
    }

    end.setAttribute('aria-hidden','false');
  }, { passive:true });

  // replay just reload (keeps qs)
  on('btnReplay', ()=> location.reload());
})();
</script>
</body>
</html>