<!-- === /herohealth/vr-goodjunk/goodjunk-vr.html ===
GoodJunkVR RUN ‚Äî PRODUCTION (HHA Standard)
‚úÖ Views: pc/mobile/vr/cvr (via body classes set by boot)
‚úÖ Uses: ../vr/vr-ui.js (auto load by boot if WebXR exists)
‚úÖ Engine: goodjunk.safe.js (v4.2 boss+layout)
‚úÖ Boot: goodjunk-vr.boot.js (STRICT AUTO + safe-measure fix)
‚úÖ CSS: goodjunk-vr.css
‚úÖ Optional: particles.js + hha-fx-director.js + hha-cloud-logger.js
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunkVR</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./goodjunk-vr.css?v=20260205a" />
</head>

<body class="gj view-mobile">
  <!-- ================= TOPBAR ================= -->
  <header class="gj-topbar" role="banner" aria-label="Top bar">
    <div class="left">
      <span class="gj-chip" aria-label="Game">ü•ó GoodJunkVR</span>
      <span class="gj-chip" id="chipMode" aria-label="Mode">AUTO</span>
    </div>
    <div class="right">
      <button class="gj-btn" id="btnMissions" type="button">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
      <button class="gj-btn" id="btnHideHud" type="button">‡∏ã‡πà‡∏≠‡∏ô HUD</button>
      <button class="gj-btn primary" id="btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
    </div>
  </header>

  <!-- ================= PROGRESS ================= -->
  <div class="gj-progress" aria-hidden="true">
    <div class="gj-progress-fill" id="gjProgressFill"></div>
  </div>

  <!-- ================= HUD TOP ================= -->
  <section class="gj-hud-top" id="hud" aria-label="HUD top">
    <div class="hud-row">
      <div class="hud-pill">
        <div class="hud-label">SCORE</div>
        <div class="hud-value" id="hud-score">0</div>
      </div>
      <div class="hud-pill warn">
        <div class="hud-label">TIME</div>
        <div class="hud-value" id="hud-time">0</div>
      </div>
      <div class="hud-pill">
        <div class="hud-label">MISS</div>
        <div class="hud-value" id="hud-miss">0</div>
      </div>
      <div class="hud-pill grade">
        <div class="hud-label">GRADE</div>
        <div class="hud-value" id="hud-grade">‚Äî</div>
      </div>
      <div class="hud-pill">
        <div class="hud-label">SHIELD</div>
        <div class="hud-value" id="shieldPills">‚Äî</div>
      </div>
    </div>

    <!-- boss (optional) -->
    <div class="gj-boss" id="bossBar" aria-hidden="true">
      <div class="gj-boss-title">BOSS</div>
      <div class="gj-boss-meter">
        <div class="gj-boss-fill" id="bossFill"></div>
      </div>
      <div class="gj-boss-hint" id="bossHint">‚Äî</div>
    </div>

    <!-- quests -->
    <div class="quest-row" aria-label="Quests">
      <div class="quest-card">
        <div class="q-title" id="hud-goal">‚Äî</div>
        <div class="q-desc" id="goalDesc">‚Äî</div>
        <div class="q-bar">
          <div class="q-num"><span id="hud-goal-cur">0</span>/<span id="hud-goal-target">0</span></div>
          <div class="q-hint">Goal</div>
        </div>
      </div>
      <div class="quest-card mini">
        <div class="q-title" id="hud-mini">‚Äî</div>
        <div class="q-desc">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏°‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
        <div class="q-bar">
          <div class="q-num" id="miniTimer">‚Äî</div>
          <div class="q-hint">Mini</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= PLAYFIELD + LAYERS ================= -->
  <main class="gj-field" id="playfield" aria-label="Playfield">
    <!-- LEFT (main) -->
    <div class="gj-layer" id="gj-layer" aria-label="Targets layer"></div>
    <!-- RIGHT eye for cVR -->
    <div class="gj-layer gj-layer-r" id="gj-layer-r" aria-hidden="true" aria-label="Targets layer right"></div>
  </main>

  <!-- ================= BOTTOM HUD ================= -->
  <footer class="gj-hud-bot" id="gjHudBot" aria-label="HUD bottom">
    <!-- fever -->
    <div class="meter" id="feverBox">
      <div class="meter-title">FEVER</div>
      <div class="meter-bar">
        <div class="meter-fill" id="feverFill"></div>
      </div>
      <div class="meter-num" id="feverText">0%</div>
      <div class="meter-tip">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢</div>
    </div>

    <!-- how-to (auto hide on small screens via CSS) -->
    <div class="meter" id="howtoBox">
      <div class="meter-title">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</div>
      <div class="meter-tip">
        ‚Ä¢ ‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <br/>
        ‚Ä¢ ‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô ‚Äú‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‚Äù (MISS ‡πÄ‡∏û‡∏¥‡πà‡∏°) <br/>
        ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î VR: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (crosshair) <br/>
        ‚Ä¢ Mini: ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏°‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î = ‡πÇ‡∏ö‡∏ô‡∏±‡∏™
      </div>
    </div>
  </footer>

  <!-- small controls (clickable) -->
  <div class="hha-controls" aria-label="Quick controls">
    <button class="gj-btn" id="btnHideHud2" type="button">HUD</button>
    <button class="gj-btn" id="btnMissions2" type="button">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
  </div>

  <!-- ================= Missions Peek Overlay ================= -->
  <section class="gj-peek" id="missionsPeek" aria-label="Missions peek">
    <div class="peek-card" role="dialog" aria-modal="true">
      <div class="peek-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="peek-sub"><b id="peekGoal">‚Äî</b></div>
      <div class="peek-mini" id="peekMini">‚Äî</div>
      <div class="peek-tip">‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î</div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="gj-btn primary" id="btnCloseMissions" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </section>

  <!-- ================= Low time overlay ================= -->
  <div class="gj-lowtime-overlay" id="lowTimeOverlay" aria-hidden="true">
    <div class="gj-lowtime-ring" aria-hidden="true"></div>
    <div class="gj-lowtime-num" id="gj-lowtime-num">5</div>
  </div>

  <!-- ================= OPTIONAL FX / LOGGER (defer ok) ================= -->
  <script defer src="../vr/particles.js"></script>
  <script defer src="../vr/hha-fx-director.js"></script>
  <script defer src="../vr/hha-cloud-logger.js"></script>

  <!-- ================= BOOT (MODULE) ================= -->
  <script type="module" src="./goodjunk-vr.boot.js?v=20260205a"></script>

  <!-- ================= UI WIRING (no engine deps) ================= -->
  <script>
    (function(){
      'use strict';
      const DOC = document;
      const WIN = window;

      const qs = (k, def=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? def; }catch{ return def; } };

      function flushLogger(reason){
        try{
          if(WIN.HHA_LOGGER && typeof WIN.HHA_LOGGER.flush === 'function'){
            WIN.HHA_LOGGER.flush(reason || 'nav');
          }
        }catch(_){}
      }

      function goHub(){
        const hub = qs('hub', null);
        flushLogger('backHub');
        // tiny delay to let sendBeacon fire
        setTimeout(()=>{
          if(hub) location.href = hub;
          else location.href = '../hub.html';
        }, 50);
      }

      function toggleHud(){
        DOC.body.classList.toggle('hud-hidden');
        // ask boot to re-measure
        try{ WIN.dispatchEvent(new CustomEvent('gj:measureSafe', {})); }catch(_){}
      }

      function toggleMissions(force){
        const on = (typeof force === 'boolean') ? force : !DOC.body.classList.contains('show-missions');
        DOC.body.classList.toggle('show-missions', on);
        // ask measure too (overlay can change perceived layout)
        try{ WIN.dispatchEvent(new CustomEvent('gj:measureSafe', {})); }catch(_){}
      }

      // show mode chip
      try{
        const chip = DOC.getElementById('chipMode');
        const run = String(qs('run','play')).toLowerCase();
        const diff = String(qs('diff','normal')).toLowerCase();
        const time = String(qs('time','80'));
        if(chip) chip.textContent = `${run.toUpperCase()} ‚Ä¢ ${diff.toUpperCase()} ‚Ä¢ ${time}s`;
      }catch(_){}

      // buttons
      const btnBack = DOC.getElementById('btnBackHub');
      const btnHide1 = DOC.getElementById('btnHideHud');
      const btnHide2 = DOC.getElementById('btnHideHud2');
      const btnMis1 = DOC.getElementById('btnMissions');
      const btnMis2 = DOC.getElementById('btnMissions2');
      const btnClose = DOC.getElementById('btnCloseMissions');

      if(btnBack) btnBack.addEventListener('click', goHub, { passive:true });
      if(btnHide1) btnHide1.addEventListener('click', toggleHud, { passive:true });
      if(btnHide2) btnHide2.addEventListener('click', toggleHud, { passive:true });

      if(btnMis1) btnMis1.addEventListener('click', ()=>toggleMissions(), { passive:true });
      if(btnMis2) btnMis2.addEventListener('click', ()=>toggleMissions(), { passive:true });
      if(btnClose) btnClose.addEventListener('click', ()=>toggleMissions(false), { passive:true });

      // close missions if tap backdrop
      const peek = DOC.getElementById('missionsPeek');
      if(peek){
        peek.addEventListener('click', (e)=>{
          if(e && e.target === peek) toggleMissions(false);
        }, { passive:true });
      }

      // keep peek text synced from quest:update (emitted by safe.js)
      WIN.addEventListener('quest:update', (e)=>{
        const d = (e && e.detail) || {};
        const g = d.goal || {};
        const m = d.mini || {};
        const elG = DOC.getElementById('peekGoal');
        const elM = DOC.getElementById('peekMini');
        if(elG) elG.textContent = `${g.title || g.name || '‚Äî'} (${g.cur||0}/${g.target||0})`;
        if(elM) elM.textContent = `${m.title || 'Mini'} (${m.cur||0}/${m.target||0})`;
      }, { passive:true });

      // flush on leaving (extra safety)
      WIN.addEventListener('pagehide', ()=>flushLogger('pagehide'), { capture:true });
      DOC.addEventListener('visibilitychange', ()=>{
        if(DOC.visibilityState === 'hidden') flushLogger('hidden');
      }, { capture:true });
    })();
  </script>
</body>
</html>