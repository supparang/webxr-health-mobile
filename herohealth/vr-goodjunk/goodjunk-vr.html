<!-- === /herohealth/vr-goodjunk/goodjunk-vr.html ===
GoodJunkVR RUN — PRODUCTION (HHA Standard)
✅ Views: pc/mobile/vr/cvr (auto detect in boot; DO NOT override)
✅ Uses: ../vr/vr-ui.js (ENTER VR/EXIT/RECENTER + crosshair + hha:shoot)
✅ Engine: goodjunk.safe.js (ESM)
✅ Boot: goodjunk-vr.boot.js (mount + start overlay hardened)
✅ Layers: #gj-layer (+ #gj-layer-r for cVR)
✅ HUD safe areas via CSS vars: --gj-top-safe / --gj-bottom-safe
✅ GATE FLOW:
   - if ?gate=1 => on hha:end => redirect to ../warmup-gate.html?phase=cooldown&cdur=20&autonext=1&next=<hub>
✅ PATCH v20260209pcfix: Start-click + fatal overlay
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth — GoodJunkVR</title>
  <meta name="color-scheme" content="dark light"/>
  <link rel="icon" href="../favicon.ico"/>

  <!-- CSS -->
  <link rel="stylesheet" href="./goodjunk-vr.css"/>

  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.72);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --amber:#f59e0b;

      /* SAFE for target spawns inside layer */
      --gj-top-safe: 92;    /* px */
      --gj-bottom-safe: 96; /* px */

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 0%, rgba(59,130,246,.12), transparent 60%),
                  radial-gradient(900px 520px at 90% 30%, rgba(34,211,238,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Thai", sans-serif;
    }

    /* =========================================================
       PATCH 1: Start overlay clickable (stop layer stealing clicks)
       ========================================================= */
    #startOverlay{
      position:absolute;
      inset:0;
      z-index: 9999;
      pointer-events:auto;
    }
    #startOverlay *{ pointer-events:auto; }

    /* layer เป้า: ยังไม่เริ่ม -> ห้ามกินคลิก */
    #gj-layer, #gj-layer-r{ pointer-events:none; }

    /* เริ่มแล้ว -> เปิดคลิกให้เป้า */
    body.gj-playing #gj-layer,
    body.gj-playing #gj-layer-r{ pointer-events:auto; }
  </style>
</head>

<body class="view-mobile">
  <!-- ===== PLAYFIELD ===== -->
  <div id="gj-playfield" class="gj-playfield">
    <!-- layers for spawning targets -->
    <div id="gj-layer" class="gj-layer" aria-hidden="false"></div>
    <div id="gj-layer-r" class="gj-layer gj-layer-r" aria-hidden="false"></div>

    <!-- ===== HUD ===== -->
    <header id="gj-hud" class="gj-hud" aria-label="HUD">
      <div class="gj-hud-left">
        <span class="gj-pill">HeroHealth · Nutrition</span>
        <span class="gj-pill gj-pill-view" id="gj-pill-view">—</span>
      </div>

      <div class="gj-hud-mid">
        <div class="gj-stat">
          <div class="gj-stat-k">SCORE</div>
          <div class="gj-stat-v" id="hud-score">0</div>
        </div>
        <div class="gj-stat">
          <div class="gj-stat-k">TIME</div>
          <div class="gj-stat-v" id="hud-time">0</div>
        </div>
        <div class="gj-stat">
          <div class="gj-stat-k">MISS</div>
          <div class="gj-stat-v" id="hud-miss">0</div>
        </div>
        <div class="gj-stat">
          <div class="gj-stat-k">GRADE</div>
          <div class="gj-stat-v" id="hud-grade">—</div>
        </div>
      </div>

      <div class="gj-hud-right">
        <div class="gj-mini">
          <div class="gj-mini-k">FEVER</div>
          <div class="gj-fever">
            <div id="feverFill" class="gj-fever-fill"></div>
          </div>
          <div id="feverText" class="gj-mini-v">0%</div>
        </div>
        <div class="gj-mini">
          <div class="gj-mini-k">SHIELD</div>
          <div id="shieldPills" class="gj-mini-v">—</div>
        </div>
      </div>
    </header>

    <!-- ===== QUEST PANEL ===== -->
    <aside id="gj-quest" class="gj-quest" aria-label="Quest">
      <div class="gj-quest-title" id="hud-goal">—</div>
      <div class="gj-quest-desc" id="goalDesc">—</div>

      <div class="gj-quest-row">
        <span class="gj-quest-k">Goal</span>
        <span class="gj-quest-v"><b id="hud-goal-cur">0</b>/<b id="hud-goal-target">0</b></span>
      </div>

      <div class="gj-quest-row">
        <span class="gj-quest-k">Mini</span>
        <span class="gj-quest-v"><span id="hud-mini">—</span> · <b id="miniTimer">—</b></span>
      </div>
    </aside>

    <!-- ===== PROGRESS BAR ===== -->
    <div class="gj-progress" aria-hidden="false">
      <div id="gjProgressFill" class="gj-progress-fill"></div>
    </div>

    <!-- ===== BOSS BAR (optional) ===== -->
    <div id="bossBar" class="gj-boss" aria-hidden="true">
      <div class="gj-boss-top">
        <span class="gj-boss-title">BOSS</span>
        <span id="bossHint" class="gj-boss-hint">—</span>
      </div>
      <div class="gj-boss-bar">
        <div id="bossFill" class="gj-boss-fill"></div>
      </div>
    </div>

    <!-- ===== LOW TIME OVERLAY ===== -->
    <div id="lowTimeOverlay" class="gj-lowtime" aria-hidden="true">
      <div class="gj-lowtime-inner">
        <div class="gj-lowtime-k">เหลือเวลา</div>
        <div id="gj-lowtime-num" class="gj-lowtime-num">5</div>
      </div>
    </div>

    <!-- ===== START OVERLAY ===== -->
    <div id="startOverlay" class="gj-start" aria-hidden="false">
      <div class="gj-start-card">
        <div class="gj-start-pill">GoodJunkVR</div>
        <h1 class="gj-start-title">แยก “ของดี” vs “ของเสีย”</h1>
        <p class="gj-start-sub">
          แตะเพื่อยิง • คุม MISS • เก็บคอมโบ • ช่วงท้ายมีบอส
        </p>
        <div class="gj-start-actions">
          <button id="btnStart" class="gj-btn gj-btn-primary">เริ่มเล่น</button>
          <button class="gj-btn btnBackHub">กลับ HUB</button>
        </div>
        <p class="gj-start-foot">
          Tip: โหมด cVR จะมี 2 เลเยอร์ (ซ้าย/ขวา) แต่ “นับเป้า” แค่ครั้งเดียวต่อ UID
        </p>
      </div>
    </div>
  </div>

  <!-- VR UI (Universal): ENTER VR/EXIT/RECENTER + Crosshair + tap-to-shoot -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Optional: tweak lockPx for GoodJunk -->
  <script>
    window.HHA_VRUI_CONFIG = Object.assign(
      { lockPx: 28, cooldownMs: 85 },
      window.HHA_VRUI_CONFIG || {}
    );
  </script>

  <!-- ✅ GATE FLOW: on end => cooldown gate => hub -->
  <script>
  (() => {
    'use strict';
    const QS = new URL(location.href).searchParams;
    const q = (k, d='') => (QS.get(k) ?? d);

    const gateOn = String(q('gate','0')) === '1';
    const hub = q('hub','') || '../hub.html';
    const cdur = Math.max(5, Math.min(60, Number(q('cdur','20') || 20)));

    function buildCooldownGateUrl(){
      const gate = new URL('../warmup-gate.html', location.href);
      gate.searchParams.set('phase', 'cooldown');
      gate.searchParams.set('cdur', String(cdur));
      gate.searchParams.set('hub', hub);
      gate.searchParams.set('next', hub);
      gate.searchParams.set('autonext', '1');

      const deny = new Set(['next','hub','phase','dur','cdur','games','autonext']);
      QS.forEach((v,k)=>{ if(!deny.has(k)) gate.searchParams.set(k, v); });

      return gate.toString();
    }

    window.addEventListener('hha:end', () => {
      if(!gateOn) return;
      if(window.__HHA_GJ_TO_COOLDOWN__) return;
      window.__HHA_GJ_TO_COOLDOWN__ = true;
      try{ location.href = buildCooldownGateUrl(); }catch(_){}
    }, { passive:true });
  })();
  </script>

  <!-- =========================================================
       PATCH 3: Fatal overlay (show errors instead of silent fail)
       ========================================================= -->
  <script>
    (function(){
      const pre = document.createElement('pre');
      pre.id = 'gj-fatal';
      pre.style.cssText =
        'position:fixed;left:12px;right:12px;bottom:12px;max-height:40vh;overflow:auto;z-index:10000;' +
        'padding:10px;border-radius:12px;background:rgba(0,0,0,.72);border:1px solid rgba(148,163,184,.25);' +
        'color:#e5e7eb;font:12px ui-monospace,Menlo,Consolas;display:none;';
      document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(pre));

      function show(msg){
        try{ pre.textContent = msg; pre.style.display = ''; }catch(_){}
      }
      window.addEventListener('error', (e)=> show('[error] ' + (e.message || e.error || 'unknown error')));
      window.addEventListener('unhandledrejection', (e)=>{
        const r = e && e.reason;
        show('[promise] ' + (r && r.message ? r.message : String(r || 'unhandled rejection')));
      });
    })();
  </script>

  <!-- =========================================================
       PATCH 2: Force Start binder (PC click always starts)
       - hide overlay + set body class gj-playing
       - dispatch hha:start
       - import boot and call start/boot/init/default if exists
       ========================================================= -->
  <script type="module">
    const QS = new URL(location.href).searchParams;
    const q = (k,d='') => (QS.get(k) ?? d);

    const btn = document.getElementById('btnStart');
    const overlay = document.getElementById('startOverlay');

    function hideOverlay(){
      try{ document.body.classList.add('gj-playing'); }catch(_){}
      try{
        if(overlay){
          overlay.style.display = 'none';
          overlay.setAttribute('aria-hidden','true');
        }
      }catch(_){}
    }

    function goHub(){
      const hub = q('hub','') || '../hub.html';
      try{ location.href = hub; }catch(_){}
    }
    document.querySelectorAll('.btnBackHub').forEach(el=>{
      el.addEventListener('click', (e)=>{ e.preventDefault(); goHub(); });
    });

    async function forceStart(){
      if(window.__HHA_GJ_FORCE_STARTED__) return;
      window.__HHA_GJ_FORCE_STARTED__ = true;

      hideOverlay();

      try{
        window.dispatchEvent(new CustomEvent('hha:start', { detail:{ source:'btnStart', forced:true } }));
      }catch(_){}

      try{
        const mod = await import('./goodjunk-vr.boot.js');
        const fn = mod.start || mod.boot || mod.init || mod.default;
        if(typeof fn === 'function') fn();
      }catch(e){
        console.error('[GoodJunkVR] boot import failed:', e);
        window.__HHA_GJ_FORCE_STARTED__ = false;
        alert('เริ่มเกมไม่สำเร็จ (boot import fail) — ดู Console/กล่อง error ด้านล่าง');
      }
    }

    if(btn){
      const on = (e)=>{ e.preventDefault(); e.stopPropagation(); forceStart(); };
      btn.addEventListener('click', on, { passive:false });
      btn.addEventListener('pointerup', on, { passive:false });
      btn.addEventListener('touchend', on, { passive:false });
    }
  </script>

  <!-- Boot (ESM) -->
  <script type="module" src="./goodjunk-vr.boot.js"></script>
</body>
</html>