// === /herohealth/vr-goodjunk/goodjunk-vr.boot.js (UPDATED) ===
import { boot as goodjunkBoot } from './goodjunk.safe.js';
import { makeQuestDirector } from './quest-director.js';
import { GOODJUNK_GOALS, GOODJUNK_MINIS } from './quest-defs-goodjunk.js';

export function boot(){
  'use strict';
  if (window.__GJ_PAGE_BOOTED__) return;
  window.__GJ_PAGE_BOOTED__ = true;

  const $ = (id)=>document.getElementById(id);
  const safeText = (el, txt)=>{ try{ if (el) el.textContent = (txt ?? ''); }catch(_){ } };

  const elScore = $('hud-score');
  const elCombo = $('hud-combo');
  const elMiss  = $('hud-miss');
  const elDiff  = $('hud-diff-label');
  const elChal  = $('hud-challenge-label');
  const elTime  = $('hud-time-label');
  const elJudge = $('hud-judge');

  const elQuestMain = $('hud-quest-main');
  const elQuestMini = $('hud-quest-mini');
  const elQuestMainBar = $('hud-quest-main-bar');
  const elQuestMiniBar = $('hud-quest-mini-bar');
  const elQuestMainCap = $('hud-quest-main-caption');
  const elQuestMiniCap = $('hud-quest-mini-caption');
  const elQuestHint = $('hud-quest-hint');
  const elMiniCount = $('hud-mini-count');

  const elCountdown = $('start-countdown');
  const btnVR      = $('btn-vr');
  const startOverlay = $('start-overlay');
  const btnStart2D = $('btn-start-2d');
  const btnStartVR = $('btn-start-vr');
  const selDiff = $('sel-diff');
  const selChallenge = $('sel-challenge');

  const logDot  = $('logdot');
  const logText = $('logtext');

  const elFeverFill = $('fever-fill');
  const elFeverPct  = $('fever-pct');
  const elShield    = $('shield-count');
  const elStunBadge = $('hud-stun');
  const elVortex = $('stun-vortex');

  // âœ… End overlay refs
  const endOverlay = $('end-overlay');
  const endScore = $('end-score');
  const endGood  = $('end-good');
  const endMiss  = $('end-miss');
  const endCombo = $('end-combo');
  const endGold  = $('end-gold');
  const endFever = $('end-fever');
  const endDiff  = $('end-diff');
  const endCh    = $('end-ch');
  const endGoals = $('end-goals');
  const endMinis = $('end-minis');
  const btnEndClose = $('btn-end-close');
  const btnEndRestart = $('btn-end-restart');

  const pageUrl = new URL(location.href);
  const URL_RUN = (pageUrl.searchParams.get('run') || 'play').toLowerCase();
  const URL_DIFF = (pageUrl.searchParams.get('diff') || 'normal').toLowerCase();
  const URL_CH = (pageUrl.searchParams.get('ch') || pageUrl.searchParams.get('challenge') || 'rush').toLowerCase();
  const URL_TIME_RAW = parseInt(pageUrl.searchParams.get('time') || '', 10);

  function clamp(v,min,max){ v=Number(v)||0; if(v<min) return min; if(v>max) return max; return v; }
  function normDiff(v){ v=String(v||'normal').toLowerCase(); return (v==='easy'||v==='hard'||v==='normal') ? v : 'normal'; }
  function normCh(v){ v=String(v||'rush').toLowerCase(); return (v==='rush'||v==='boss'||v==='survival') ? v : 'rush'; }
  function normRun(v){ v=String(v||'play').toLowerCase(); return (v==='research') ? 'research' : 'play'; }

  const RUN_MODE = normRun(URL_RUN);
  const DIFF_INIT = normDiff(URL_DIFF);
  const CH_INIT = normCh(URL_CH);

  const DEFAULT_TIME = { easy:80, normal:60, hard:50 };
  const DUR_INIT = clamp(
    (Number.isFinite(URL_TIME_RAW) ? URL_TIME_RAW : (DEFAULT_TIME[DIFF_INIT] || 60)),
    20, 180
  );

  function setLogBadge(state, text){
    if (!logDot || !logText) return;
    logDot.classList.remove('ok','bad');
    if (state === 'ok') logDot.classList.add('ok');
    else if (state === 'bad') logDot.classList.add('bad');
    safeText(logText, text || '');
  }

  function runCountdown(onDone){
    if (!elCountdown){ onDone && onDone(); return; }
    const steps = ['3','2','1','Go!'];
    let idx = 0;
    elCountdown.classList.remove('countdown-hidden');
    safeText(elCountdown, steps[0]);
    const t = setInterval(()=>{
      idx++;
      if (idx >= steps.length){
        clearInterval(t);
        elCountdown.classList.add('countdown-hidden');
        onDone && onDone();
      }else safeText(elCountdown, steps[idx]);
    }, 650);
  }

  async function tryEnterVR(){
    const scene = document.querySelector('a-scene');
    if (!scene) return false;
    try{ await scene.enterVR(); return true; }
    catch(_){ return false; }
  }
  function initVRButton(){
    if (!btnVR) return;
    const scene = document.querySelector('a-scene');
    if (!scene) return;
    btnVR.addEventListener('click', async ()=>{ try{ await scene.enterVR(); }catch(_){} });
  }

  // Aim center
  function setAimPoint(x, y){
    window.__GJ_AIM_POINT__ = { x: x|0, y: y|0, t: Date.now() };
    if (elVortex){
      elVortex.style.left = (x|0) + 'px';
      elVortex.style.top  = (y|0) + 'px';
    }
  }
  function defaultAim(){ setAimPoint(window.innerWidth*0.5, window.innerHeight*0.62); }
  function bindAimListeners(){
    const layer = document.getElementById('gj-layer');
    if (!layer) return;
    if (!window.__GJ_AIM_POINT__) defaultAim();
    layer.addEventListener('pointerdown', (e)=>{
      const t = e.target;
      if (t && t.closest && t.closest('.gj-target')) return;
      if (typeof e.clientX === 'number' && typeof e.clientY === 'number'){
        setAimPoint(e.clientX, e.clientY);
      }
    }, { passive:true });
  }

  // Logger IIFE
  function initLoggerIIFE(endpoint){
    try{
      if (window.HHACloudLogger && typeof window.HHACloudLogger.init === 'function'){
        window.HHACloudLogger.init({ endpoint, debug: true });
        setLogBadge('ok', 'logger: ok âœ“');
        return true;
      }
    }catch(_){}
    setLogBadge('bad', 'logger: missing (skip)');
    return false;
  }

  // Quest shared state (à¸ªà¸³à¸„à¸±à¸: goodHits à¸•à¹‰à¸­à¸‡ sync à¸ˆà¸²à¸ hha:score)
  const qState = {
    score:0, goodHits:0, miss:0, comboMax:0, timeLeft:0,
    streakGood:0,
    goldHitsThisMini:false,
    blocks:0,
    usedMagnet:false,
    timePlus:0,
    safeNoJunkSeconds:0,
    bossCleared:false,
    challenge: CH_INIT,
    runMode: RUN_MODE,
    final8Good: 0
  };

  window.addEventListener('quest:miniStart', ()=>{
    qState.goldHitsThisMini = false;
    qState.usedMagnet = false;
    qState.timePlus = 0;
    qState.blocks = 0;
    qState.safeNoJunkSeconds = 0;
    qState.streakGood = 0;
    qState.final8Good = 0;
  });

  let started = false;
  setInterval(()=>{
    if (!started) return;
    qState.safeNoJunkSeconds = (qState.safeNoJunkSeconds|0) + 1;
  }, 1000);

  let Q = null;

  window.addEventListener('hha:judge', (e)=>{
    safeText(elJudge, (e.detail||{}).label || '\u00A0');
  });

  window.addEventListener('hha:time', (e)=>{
    const sec = (e.detail||{}).sec;
    if (typeof sec === 'number' && sec >= 0){
      safeText(elTime, sec + 's');
      qState.timeLeft = sec|0;
      if (Q) Q.tick(qState);
    }
  });

  // âœ… FIX: sync goodHits into qState -> goal g1 pass à¹„à¸”à¹‰
  let lastMissSeen = 0;
  window.addEventListener('hha:score', (e)=>{
    const d = e.detail || {};
    if (typeof d.score === 'number'){ qState.score = d.score|0; safeText(elScore, String(qState.score)); }
    if (typeof d.goodHits === 'number'){ qState.goodHits = d.goodHits|0; } // âœ… à¸ªà¸³à¸„à¸±à¸
    if (typeof d.misses === 'number'){
      qState.miss = d.misses|0;
      safeText(elMiss, String(qState.miss));
      if (qState.miss > lastMissSeen){ qState.streakGood = 0; lastMissSeen = qState.miss; }
    }
    if (typeof d.comboMax === 'number'){ qState.comboMax = d.comboMax|0; safeText(elCombo, String(qState.comboMax)); }
    if (Q) Q.tick(qState);
  });

  // âœ… STUN edge-trigger: shake impact + vibrate
  let prevStun = false;
  window.addEventListener('hha:fever', (e)=>{
    const d = e.detail || {};
    const fever = Number(d.fever||0);
    const shield = Number(d.shield||0);
    const stunActive = !!d.stunActive;

    if (elFeverFill) elFeverFill.style.width = Math.max(0, Math.min(100, fever)) + '%';
    if (elFeverPct) safeText(elFeverPct, Math.round(Math.max(0, Math.min(100, fever))) + '%');
    if (elShield) safeText(elShield, String(shield|0));
    if (elStunBadge) elStunBadge.classList.toggle('show', stunActive);

    document.body.classList.toggle('stun-on', stunActive);

    // edge: OFF -> ON
    if (stunActive && !prevStun){
      document.body.classList.add('stun-impact');
      setTimeout(()=> document.body.classList.remove('stun-impact'), 550);
      try{ navigator.vibrate && navigator.vibrate([40, 30, 40]); }catch(_){}
    }
    prevStun = stunActive;

    if (elVortex){
      elVortex.classList.toggle('show', stunActive);
      const ap = window.__GJ_AIM_POINT__;
      if (ap && stunActive){
        elVortex.style.left = (ap.x|0) + 'px';
        elVortex.style.top  = (ap.y|0) + 'px';
      }
    }
  });

  // quest:update bars
  window.addEventListener('quest:update', (e)=>{
    const d = e.detail || {};
    const goal = d.goal || null;
    const mini = d.mini || null;
    const meta = d.meta || {};

    if (goal){
      const cur = (goal.cur|0), max = (goal.max|0);
      const pct = Math.max(0, Math.min(1, Number(goal.pct ?? (max>0?cur/max:0))));
      if (elQuestMain) elQuestMain.textContent = goal.title || 'à¸ à¸²à¸£à¸à¸´à¸ˆà¸«à¸¥à¸±à¸';
      if (elQuestMainBar) elQuestMainBar.style.width = Math.round(pct*100) + '%';
      if (elQuestMainCap) elQuestMainCap.textContent = `${cur} / ${max}`;
    } else {
      if (elQuestMain) elQuestMain.textContent = 'à¸ à¸²à¸£à¸à¸´à¸ˆà¸«à¸¥à¸±à¸ (à¸„à¸£à¸š) âœ…';
      if (elQuestMainBar) elQuestMainBar.style.width = '100%';
      if (elQuestMainCap) elQuestMainCap.textContent = '';
    }

    if (mini){
      const cur = (mini.cur|0), max = (mini.max|0);
      const pct = Math.max(0, Math.min(1, Number(mini.pct ?? (max>0?cur/max:0))));
      if (elQuestMini) elQuestMini.textContent = 'Mini: ' + (mini.title || '');
      if (elQuestMiniBar) elQuestMiniBar.style.width = Math.round(pct*100) + '%';
      if (elQuestMiniCap) elQuestMiniCap.textContent = `${cur} / ${max}`;
    } else {
      if (elQuestMini) elQuestMini.textContent = 'Mini quest (à¸„à¸£à¸š) âœ…';
      if (elQuestMiniBar) elQuestMiniBar.style.width = '100%';
      if (elQuestMiniCap) elQuestMiniCap.textContent = '';
    }

    const miniCount = (meta.miniCount|0);
    const minisCleared = (meta.minisCleared|0);
    if (elMiniCount) elMiniCount.textContent = `mini à¸œà¹ˆà¸²à¸™ ${minisCleared} â€¢ à¹€à¸¥à¹ˆà¸™à¸­à¸¢à¸¹à¹ˆ ${miniCount+1}`;

    let hint = '';
    if (goal && Number(goal.pct||0) >= 0.8) hint = 'à¹ƒà¸à¸¥à¹‰à¹à¸¥à¹‰à¸§! ðŸ”¥';
    else if (mini && Number(mini.pct||0) >= 0.8) hint = 'à¸­à¸µà¸à¸™à¸´à¸”à¹€à¸”à¸µà¸¢à¸§! âš¡';
    if (elQuestHint) elQuestHint.textContent = hint;
  });

  // âœ… à¸£à¸±à¸šà¸ˆà¸šà¹€à¸à¸¡ -> à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸ªà¸£à¸¸à¸›
  window.addEventListener('hha:end', (e)=>{
    const d = e.detail || {};
    if (endOverlay) endOverlay.classList.add('show');

    safeText(endScore, String(d.score|0));
    safeText(endGood,  String(d.goodHits|0));
    safeText(endMiss,  String(d.misses|0));
    safeText(endCombo, String(d.comboMax|0));
    safeText(endGold,  String(d.goldHits|0));
    safeText(endFever, String(Math.round(Number(d.fever||0))) + '%');

    safeText(endDiff, String(d.diff||DIFF_INIT).toUpperCase());
    safeText(endCh,   String(d.challenge||CH_INIT).toUpperCase());

    const qs = (window.__GJ_QUEST_STATE__ || {});
    safeText(endGoals, String(qs.goalsCleared|0));
    safeText(endMinis, String(qs.minisCleared|0));
  });

  btnEndClose && btnEndClose.addEventListener('click', ()=>{
    endOverlay && endOverlay.classList.remove('show');
  });
  btnEndRestart && btnEndRestart.addEventListener('click', ()=>{
    location.reload();
  });

  function prefill(){
    try{ selDiff.value = DIFF_INIT; }catch(_){}
    try{ selChallenge.value = CH_INIT; }catch(_){}
    safeText(elDiff, DIFF_INIT.toUpperCase());
    safeText(elChal, CH_INIT.toUpperCase());
    safeText(elTime, DUR_INIT + 's');
    setLogBadge(null, 'boot: ready');
  }

  function waitSceneReady(cb){
    const scene = document.querySelector('a-scene');
    if (!scene) { cb(); return; }
    const tryReady = ()=> (scene.hasLoaded && scene.camera);
    if (tryReady()) return cb();
    scene.addEventListener('loaded', ()=> cb(), { once:true });
  }

  async function bootOnce({ wantVR }){
    if (started) return;
    started = true;
    startOverlay && (startOverlay.style.display = 'none');

    const diff = normDiff(selDiff?.value || DIFF_INIT);
    const chal = normCh(selChallenge?.value || CH_INIT);
    const durationSec = clamp(DUR_INIT, 20, 180);

    safeText(elDiff, diff.toUpperCase());
    safeText(elChal, chal.toUpperCase());
    safeText(elTime, durationSec + 's');

    bindAimListeners();
    initVRButton();

    // logger
    const endpoint =
      (sessionStorage.getItem('HHA_LOGGER_ENDPOINT') || '') ||
      'https://script.google.com/macros/s/AKfycby7IBVmpmEydNDp5BR3CMaSAjvF7ljptaDwvow_L781iDLsbtpuiFmKviGUnugFerDtQg/exec';
    initLoggerIIFE(endpoint);

    // QuestDirector
    Q = makeQuestDirector({
      diff,
      goalDefs: GOODJUNK_GOALS,
      miniDefs: GOODJUNK_MINIS,
      maxGoals: 2,
      maxMini: 999,
      challenge: chal
    });
    Q.start(qState);

    // expose quest state for summary
    window.__GJ_QUEST_STATE__ = Q.getState();

    window.addEventListener('quest:cleared', ()=>{
      if (Q) window.__GJ_QUEST_STATE__ = Q.getState();
    });

    runCountdown(()=>{
      waitSceneReady(async ()=>{
        if (wantVR) await tryEnterVR();
        const ENGINE = goodjunkBoot({
          diff,
          run: RUN_MODE,
          challenge: chal,
          time: durationSec,
          layerEl: document.getElementById('gj-layer')
        });
        window.__GJ_ENGINE__ = ENGINE;
      });
    });
  }

  btnStart2D && btnStart2D.addEventListener('click', ()=> bootOnce({ wantVR:false }));
  btnStartVR && btnStartVR.addEventListener('click', ()=> bootOnce({ wantVR:true }));

  prefill();
}
