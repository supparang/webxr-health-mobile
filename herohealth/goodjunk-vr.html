<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>GoodJunkVR Launcher</title>
</head>
<body>
<script>
(function(){
  'use strict';
  const here = new URL(location.href);

  const qs = (k, def=null)=> here.searchParams.get(k) ?? def;
  const setIfMissing = (url,k,v)=>{ if(!url.searchParams.has(k) && v!=null) url.searchParams.set(k, String(v)); };

  // ✅ RUN file (จริง)
  const runUrl = new URL('./vr-goodjunk/goodjunk-vr.html', here);

  // passthrough ทุกอย่างก่อน
  for (const [k,v] of here.searchParams.entries()){
    runUrl.searchParams.set(k, v);
  }

  // ✅ defaults สำคัญ (กันเข้ามาแบบ view/run/diff/time หาย)
  setIfMissing(runUrl, 'view', 'mobile');
  setIfMissing(runUrl, 'run',  'play');
  setIfMissing(runUrl, 'diff', 'normal');
  setIfMissing(runUrl, 'time', '80');
  setIfMissing(runUrl, 'pid',  'anon');

  // ✅ hub back-link ต้องชี้ root hub เสมอ
  // ถ้าส่ง hub มาแล้วใช้ของเดิม ถ้าไม่ส่งมาให้เด้งกลับ root hub
  setIfMissing(runUrl, 'hub', './hub.html');

  // ✅ seed: play = now, research = เดิม (ถ้ามีส่งมาแล้วไม่ทับ)
  if(!runUrl.searchParams.has('seed')){
    const mode = String(qs('run','play')).toLowerCase();
    runUrl.searchParams.set('seed', mode==='research' ? (qs('seed','RESEARCH-SEED')) : String(Date.now()));
  }

  // กันวนลูป launcher->launcher
  if(runUrl.pathname.endsWith('/goodjunk-vr.html') && runUrl.pathname.includes('/vr-goodjunk/')){
    location.replace(runUrl.toString());
  }else{
    location.replace(runUrl.toString());
  }
})();
</script>
</body>
</html>