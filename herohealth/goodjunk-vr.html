<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR ‚Äî FULL HTML (PRODUCTION) ‚Äî PATCH C COMPAT (FULL UPDATE)
‚úÖ Script order: particles ‚Üí logger ‚Üí fever ‚Üí hud ‚Üí module boot
‚úÖ DOM targets layer (#gj-layer) + VR-feel playfield (drag + gyro)
‚úÖ Ring/Laser overlays (#atk-ring/#atk-laser) with CSS vars
‚úÖ Start overlay + Motion permission button
‚úÖ Fallback end summary (listen hha:end)
‚úÖ NEW: Hub Context Bridge (read profile/context from hub via storage/query)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core (for VR button + sky feel) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Global UI -->
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --ringGapStart: 0deg;
      --ringGapSize: 80deg;

      --safeTop: 128px;
      --safeBottom: 170px;
      --safeSide: 26px;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(900px 600px at 10% 80%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
      touch-action: none;
    }

    /* --- A-Frame behind --- */
    .vr-backdrop{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.95;
    }
    a-scene{ height:100%; width:100%; }

    /* --- HUD overlay wrapper --- */
    .hud{
      position:fixed; inset:0;
      z-index: 30;
      pointer-events:none;
    }

    /* topbar */
    .topbar{
      position:fixed;
      left:12px; right:12px; top:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      pointer-events:none;
      z-index: 40;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
    }
    .card.pad{ padding: 10px 12px; }

    .statrow{
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      letter-spacing:.2px;
    }
    .stat{
      display:flex; align-items:center; gap:6px;
      font-size: 13px;
      color: var(--text);
      opacity:.96;
      white-space:nowrap;
    }
    .stat span{ color: var(--muted); font-weight:800; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      font-weight: 950;
      font-size: 12px;
      opacity:.96;
    }
    .pill b{ font-size: 13px; }

    /* quest panel */
    .quest{
      position:fixed;
      left:12px;
      bottom:12px;
      width:min(460px, calc(100vw - 24px));
      pointer-events:none;
      z-index: 40;
    }
    .qwrap{ padding: 12px 12px; }
    .qtitle{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .qtitle small{
      color: var(--muted);
      font-weight: 850;
      font-size: 11px;
      opacity:.92;
    }
    .qline{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0; }
    .qname{ font-weight: 950; font-size: 12px; color: var(--text); opacity:.95; }
    .qcount{ font-weight: 950; font-size: 12px; color: var(--muted); }
    .bar{
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      margin-top: 6px;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,.92), rgba(245,158,11,.92));
      transition: width .12s linear;
    }

    /* coach */
    .coach{
      position:fixed;
      right:12px;
      bottom:12px;
      width: min(380px, calc(100vw - 24px));
      pointer-events:none;
      z-index: 40;
    }
    .coachwrap{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding: 10px 12px;
    }
    .coachimg{
      width: 70px; height: 70px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .coachtext{
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      opacity:.95;
      line-height: 1.25;
    }
    .coachtext .m{ color: var(--muted); font-weight: 850; display:block; margin-top: 2px; }

    /* crosshair */
    .crosshair{
      position:fixed;
      left:50%;
      top:62%;
      transform: translate(-50%,-50%);
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.78);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
      z-index: 35;
      pointer-events:none;
    }
    .crosshair:after{
      content:'';
      position:absolute;
      left:50%; top:50%;
      width: 3px; height: 3px;
      border-radius: 99px;
      background: rgba(255,255,255,.9);
      transform: translate(-50%,-50%);
    }

    /* shoot button (mobile) */
    .shoot{
      position:fixed;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 36;
      pointer-events:auto;
    }
    .shoot button{
      width: 68px; height: 68px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(2,6,23,.65);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-weight: 950;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .shoot button:active{ transform: scale(.98); }

    /* playfield layer for DOM targets */
    #gj-layer{
      position:fixed;
      inset:0;
      z-index: 20;
      pointer-events:auto;
      touch-action:none;
      transform: translate3d(0px,0px,0);
      will-change: transform;
    }
    .gj-target{
      position:absolute;
      transform: translate(-50%,-50%) scale(1);
      font-size: 48px;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.50));
      user-select:none;
      -webkit-user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      animation: floaty 1.05s ease-in-out infinite alternate;
    }
    .gj-target.spawn{ animation: pop .14s ease-out, floaty 1.05s ease-in-out infinite alternate; }
    .gj-target.gone{ opacity: 0; transform: translate(-50%,-50%) scale(.75); transition: opacity .14s ease, transform .14s ease; }

    .gj-junk{ filter: drop-shadow(0 14px 28px rgba(239,68,68,.18)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-fake{ filter: drop-shadow(0 14px 28px rgba(245,158,11,.14)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-gold{ filter: drop-shadow(0 18px 36px rgba(245,158,11,.24)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-power{ filter: drop-shadow(0 18px 36px rgba(34,197,94,.18)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-boss{ font-size: 64px; filter: drop-shadow(0 22px 44px rgba(255,255,255,.10)) drop-shadow(0 14px 28px rgba(0,0,0,.58)); }

    @keyframes pop{
      0%{ transform: translate(-50%,-50%) scale(.65); opacity: .2; }
      100%{ transform: translate(-50%,-50%) scale(1.0); opacity: 1; }
    }
    @keyframes floaty{
      0%{ transform: translate(-50%,-50%) scale(1.0) translateY(0px); }
      100%{ transform: translate(-50%,-50%) scale(1.0) translateY(-6px); }
    }

    /* Ring hazard overlay */
    #atk-ring{
      position:fixed;
      left:50%;
      top:50%;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      z-index: 33;
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
      background:
        radial-gradient(circle at 50% 50%,
          transparent 58%,
          rgba(239,68,68,.0) 58%,
          rgba(239,68,68,.0) 62%,
          transparent 62%
        ),
        conic-gradient(
          from var(--ringGapStart),
          rgba(239,68,68,.90) 0deg,
          rgba(239,68,68,.90) calc(360deg - var(--ringGapSize)),
          rgba(239,68,68,.0) 0deg
        );
      filter: drop-shadow(0 18px 50px rgba(239,68,68,.14));
      mix-blend-mode: screen;
    }
    #atk-ring.show{ opacity: .95; }

    /* Laser overlay */
    #atk-laser{
      position:fixed;
      left:0;
      width:100%;
      height: 18px;
      top: 50%;
      z-index: 33;
      pointer-events:none;
      opacity: 0;
      transition: opacity .10s ease;
      background: linear-gradient(90deg, rgba(239,68,68,0), rgba(239,68,68,.9), rgba(239,68,68,0));
      filter: drop-shadow(0 18px 50px rgba(239,68,68,.20));
    }
    #atk-laser.warn{ opacity: .55; }
    #atk-laser.fire{ opacity: 1; height: 22px; }

    /* Start overlay */
    .overlay{
      position:fixed;
      inset:0;
      z-index: 60;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: radial-gradient(900px 500px at 50% 0%, rgba(34,197,94,.16), transparent 60%),
                  rgba(2,6,23,.76);
      backdrop-filter: blur(10px);
    }
    .panel{
      width: min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.78);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 16px 16px;
    }
    .h1{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 18px;
      margin: 0 0 6px;
    }
    .sub{
      margin: 0 0 12px;
      color: var(--muted);
      font-weight: 850;
      line-height: 1.35;
      font-size: 12px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .btn{
      pointer-events:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(15,23,42,.72);
      color: var(--text);
      font-weight: 950;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.92), rgba(34,197,94,.68));
      border-color: rgba(34,197,94,.26);
      color:#03120a;
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(245,158,11,.92), rgba(245,158,11,.62));
      border-color: rgba(245,158,11,.26);
      color:#1a1002;
    }
    .btn:active{ transform: scale(.99); }

    /* End summary overlay (fallback + HUD) */
    #hhaEnd{
      position:fixed;
      inset:0;
      z-index: 80;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(2,6,23,.78);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    #hhaEnd .panel{ width:min(560px, 100%); }
    .endrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .kpi{
      flex: 1 1 160px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
    }
    .kpi .k{ color: var(--muted); font-weight: 900; font-size: 11px; }
    .kpi .v{ font-weight: 1000; font-size: 18px; margin-top: 2px; }
    .endbtns{ display:flex; gap:10px; margin-top: 12px; }
    .endbtns .btn{ width:100%; }

    /* debug pill */
    .debug{
      position:fixed;
      left: 12px;
      top: calc(10px + 64px);
      z-index: 55;
      pointer-events:none;
      opacity:.65;
      font-size: 11px;
    }
  </style>
</head>

<body>

  <!-- A-Frame background -->
  <div class="vr-backdrop">
    <a-scene embedded renderer="colorManagement: true; antialias: true" vr-mode-ui="enabled: true">
      <a-sky color="#050b1a"></a-sky>
      <a-entity position="0 1.6 0">
        <a-camera wasd-controls-enabled="false" look-controls="enabled: true"></a-camera>
      </a-entity>
    </a-scene>
  </div>

  <!-- DOM playfield -->
  <div id="gj-layer" aria-label="GoodJunk playfield"></div>

  <!-- Boss hazards -->
  <div id="atk-ring" aria-hidden="true"></div>
  <div id="atk-laser" aria-hidden="true"></div>

  <!-- Crosshair -->
  <div id="gj-crosshair" class="crosshair" aria-hidden="true"></div>

  <!-- Shoot button (mobile assist) -->
  <div class="shoot">
    <button id="btnShoot" type="button">üéØ<span style="font-weight:1000">‡∏¢‡∏¥‡∏á</span></button>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="topbar">
      <div class="card pad" style="flex:1">
        <div class="statrow">
          <div class="stat">üèÅ <span>Score</span> <b id="hhaScore">0</b></div>
          <div class="stat">üî• <span>Combo</span> <b id="hhaCombo">0</b></div>
          <div class="stat">üíî <span>Miss</span> <b id="hhaMiss">0</b></div>
          <div class="stat">‚è±Ô∏è <span>Time</span> <b id="hhaTime">0</b>s</div>
        </div>
      </div>

      <div class="pill">
        üèÖ Grade <b id="hhaGrade">‚Äî</b>
      </div>
    </div>

    <div class="quest card">
      <div class="qwrap">
        <div class="qtitle">
          <div>üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <small id="hhaQuestMeta">‚Äî</small>
        </div>

        <div class="qline">
          <div class="qname" id="qGoalTitle">Goal: ‚Äî</div>
          <div class="qcount"><span id="qGoalCur">0</span>/<span id="qGoalMax">0</span></div>
        </div>
        <div class="bar"><div class="fill" id="qGoalFill"></div></div>

        <div style="height:10px"></div>

        <div class="qline">
          <div class="qname" id="qMiniTitle">Mini: ‚Äî</div>
          <div class="qcount"><span id="qMiniCur">0</span>/<span id="qMiniMax">0</span></div>
        </div>
        <div class="bar"><div class="fill" id="qMiniFill"></div></div>

        <!-- optional mini timer -->
        <div style="margin-top:8px; color:var(--muted); font-weight:900; font-size:11px;">
          ‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span id="qMiniTLeft">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="coach card">
      <div class="coachwrap">
        <img id="hhaCoachImg" class="coachimg" src="./img/coach-neutral.png" alt="Coach" />
        <div class="coachtext">
          <span id="hhaCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ ü•¶üö´</span>
          <span class="m" id="hhaCoachSub">‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á / ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÇ‡∏•‡∏Å‚Äù ‡πÅ‡∏ö‡∏ö VR</span>
        </div>
      </div>
    </div>
  </div>

  <div class="debug pill">
    <span>DBG</span>
    <b id="dbgLine">‚Äî</b>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <div class="h1">ü•¶ GoodJunk VR</div>
      <p class="sub" id="startDesc">
        ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ô‡∏∏‡∏Å‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ / ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏¢‡∏∞ / ‡∏°‡∏µ FEVER + BOSS + ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô Ring/Laser ‚ö°
        <br/>‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö gyro ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
      </p>

      <div class="grid">
        <button class="btn primary" id="btnStart2D" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (2D)</button>
        <button class="btn warn" id="btnMotion" type="button">üì± ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion</button>
        <button class="btn" id="btnStartVR" type="button">üï∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤ VR ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
        <button class="btn" id="btnHow" type="button">‚ùì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-weight:850;font-size:11px;line-height:1.35">
        Query params: <b>?diff=easy|normal|hard&time=80&run=play|research&challenge=rush|boss|survival</b>
      </div>
    </div>
  </div>

  <!-- End summary (HUD may also use this) -->
  <div id="hhaEnd">
    <div class="panel">
      <div class="h1">üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <p class="sub">
        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡πÄ‡∏Å‡∏£‡∏î (SSS/SS/S/A/B/C)
      </p>

      <div class="endrow">
        <div class="kpi"><div class="k">GRADE</div><div class="v" id="endGrade">‚Äî</div></div>
        <div class="kpi"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="kpi"><div class="k">COMBO MAX</div><div class="v" id="endComboMax">0</div></div>
        <div class="kpi"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
      </div>

      <div class="endrow">
        <div class="kpi"><div class="k">GOALS</div><div class="v"><span id="endGoals">0</span>/<span id="endGoalsTotal">0</span></div></div>
        <div class="kpi"><div class="k">MINIS</div><div class="v"><span id="endMinis">0</span>/<span id="endMinisTotal">0</span></div></div>
        <div class="kpi"><div class="k">ACCURACY</div><div class="v"><span id="endAcc">0</span>%</div></div>
      </div>

      <div class="endbtns">
        <button class="btn primary" id="btnReplay" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn" id="btnCloseEnd" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- Boot module -->
  <script type="module">
    import { boot as goodjunkBoot } from './vr-goodjunk/goodjunk.safe.js';

    const $ = (id)=> document.getElementById(id);

    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }
    function qp(name, def=null){
      const u = new URL(location.href);
      const v = u.searchParams.get(name);
      return (v==null || v==='') ? def : v;
    }

    // --- Parse options ---
    const diff = String(qp('diff','normal')).toLowerCase();
    const run  = String(qp('run','play')).toLowerCase();
    const time = clamp(qp('time',80), 20, 180) | 0;
    const challenge = String(qp('challenge','rush')).toLowerCase();

    // --- UI refs ---
    const layer = $('gj-layer');
    const cross = $('gj-crosshair');
    const btnShoot = $('btnShoot');

    const startOverlay = $('startOverlay');
    const btnStart2D = $('btnStart2D');
    const btnStartVR = $('btnStartVR');
    const btnMotion = $('btnMotion');
    const btnHow = $('btnHow');

    const dbgLine = $('dbgLine');

    // --- Maintain layer offset + aim point for engine (PATCH C expects these globals) ---
    function updateOffsets(){
      const r = layer.getBoundingClientRect();
      window.__GJ_LAYER_OFFSET__ = { x: r.left, y: r.top };
      const c = cross.getBoundingClientRect();
      window.__GJ_AIM_POINT__ = { x: (c.left + c.width/2), y: (c.top + c.height/2) };
    }

    // --- VR-feel playfield: drag + gyro -> transform translate3d ---
    let dragOn=false, sx=0, sy=0;
    let baseX=0, baseY=0;
    let targetX=0, targetY=0;
    let gyroX=0, gyroY=0;
    let motionEnabled=false;

    const MAX_SHIFT = 120; // clamp safe
    function applyTransform(){
      // smooth follow
      baseX += (targetX - baseX) * 0.12;
      baseY += (targetY - baseY) * 0.12;

      const x = clamp(baseX + gyroX, -MAX_SHIFT, MAX_SHIFT);
      const y = clamp(baseY + gyroY, -MAX_SHIFT, MAX_SHIFT);
      layer.style.transform = `translate3d(${x.toFixed(1)}px, ${y.toFixed(1)}px, 0)`;
    }

    function onPointerDown(e){
      dragOn=true;
      sx = e.clientX; sy = e.clientY;
      layer.setPointerCapture?.(e.pointerId);
    }
    function onPointerMove(e){
      if(!dragOn) return;
      const dx = e.clientX - sx;
      const dy = e.clientY - sy;
      targetX = clamp(dx, -MAX_SHIFT, MAX_SHIFT);
      targetY = clamp(dy, -MAX_SHIFT, MAX_SHIFT);
    }
    function onPointerUp(e){
      dragOn=false;
      targetX *= 0.35;
      targetY *= 0.35;
    }

    layer.addEventListener('pointerdown', onPointerDown, { passive:true });
    layer.addEventListener('pointermove', onPointerMove, { passive:true });
    layer.addEventListener('pointerup', onPointerUp, { passive:true });
    layer.addEventListener('pointercancel', onPointerUp, { passive:true });

    async function enableMotion(){
      try{
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res !== 'granted') throw new Error('permission denied');
        }
        motionEnabled = true;

        window.addEventListener('deviceorientation', (ev)=>{
          if(!motionEnabled) return;
          const g = clamp(ev.gamma ?? 0, -35, 35);
          const b = clamp(ev.beta  ?? 0, -35, 35);
          gyroX = clamp(g * 1.5, -MAX_SHIFT, MAX_SHIFT);
          gyroY = clamp((b-10) * 1.2, -MAX_SHIFT, MAX_SHIFT);
        }, { passive:true });

        btnMotion.textContent = '‚úÖ Motion ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
      }catch(err){
        btnMotion.textContent = '‚ùå Motion ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
      }
    }

    btnMotion.addEventListener('click', enableMotion, { passive:true });

    btnHow.addEventListener('click', ()=>{
      alert(
        '‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô GoodJunkVR\n\n' +
        '1) ‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á (‡∏ß‡∏á‡∏Å‡∏•‡∏°)\n' +
        '2) ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏¢‡∏¥‡∏á‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ crosshair\n' +
        '3) ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶/‡∏ó‡∏≠‡∏á üü°/‡∏û‡∏•‡∏±‡∏á üß≤‚è≥üõ°Ô∏è\n' +
        '4) ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ üçüüçï ‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å üòàüß®\n' +
        '5) ‡πÇ‡∏´‡∏°‡∏î Boss ‡∏à‡∏∞‡∏°‡∏µ Ring/Laser/Storm ‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏ö\n\n' +
        '‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Motion)'
      );
    }, { passive:true });

    // =========================
    // NEW: Hub Context Bridge
    // =========================
    function readJSONStorage(key){
      try{
        const s = sessionStorage.getItem(key);
        if (s) return JSON.parse(s);
      }catch(_){}
      try{
        const s = localStorage.getItem(key);
        if (s) return JSON.parse(s);
      }catch(_){}
      return null;
    }
    function readHubContext(){
      const u = new URL(location.href);
      const pick = (k)=>{ const v=u.searchParams.get(k); return (v==null||v==='')?undefined:v; };

      const ctx = Object.assign(
        {},
        readJSONStorage('hha_context') || {},
        readJSONStorage('hha_profile') || {}
      );

      [
        'studyId','phase','conditionGroup','sessionOrder','blockLabel','siteCode','schoolYear','semester',
        'studentKey','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel',
        'heightCm','weightKg','bmi','bmiGroup','vrExperience','gameFrequency','handedness','visionIssue','healthDetail','consentParent',
        'sessionId'
      ].forEach((k)=>{
        const v = pick(k);
        if (v !== undefined) ctx[k] = v;
      });

      ['age','gradeLevel','heightCm','weightKg','bmi','schoolYear','semester','sessionOrder'].forEach((k)=>{
        if (ctx[k] != null && ctx[k] !== '' && !isNaN(ctx[k])) ctx[k] = Number(ctx[k]);
      });

      return ctx;
    }

    let __HHA_PROFILE_SENT__ = false;
    function emitProfileOnce(ctx){
      if (__HHA_PROFILE_SENT__) return;
      __HHA_PROFILE_SENT__ = true;
      try{
        window.dispatchEvent(new CustomEvent('hha:log_profile', {
          detail: { ts: Date.now(), ...ctx }
        }));
      }catch(_){}
    }

    // --- Start game ---
    let game = null;

    function startGame(){
      startOverlay.style.display = 'none';

      const ctx = readHubContext();
      emitProfileOnce(ctx);

      game = goodjunkBoot({
        diff,
        run,
        time,
        challenge,

        // ‚úÖ pass hub context into engine for logging/end payload
        context: ctx,

        // ‚úÖ if hub provides sessionId, unify it
        sessionId: ctx.sessionId || undefined,

        layerEl: layer,
        shootEl: btnShoot,
        safeMargins: {
          top: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeTop')) || 128,
          bottom: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeBottom')) || 170,
          left: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeSide')) || 26,
          right: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeSide')) || 26
        }
      });
    }

    btnStart2D.addEventListener('click', startGame, { passive:true });

    btnStartVR.addEventListener('click', ()=>{
      startGame();
    }, { passive:true });

    // --- Debug / offsets loop ---
    function raf(){
      applyTransform();
      updateOffsets();

      if (game && game.getState){
        const s = game.getState();
        dbgLine.textContent = `${diff}/${challenge} | score:${s.score} combo:${s.combo} miss:${s.misses} fever:${s.fever}% sh:${s.shield} boss:${s.bossAlive?('P'+s.bossPhase+' '+s.bossHp+'/'+s.bossHpMax):'‚Äî'}`;
      } else {
        dbgLine.textContent = `${diff}/${challenge} | ready`;
      }

      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // --- Fallback end summary (in case HUD overlay misses) ---
    const endBox = $('hhaEnd');
    const setTxt = (id, v)=>{ const el=$(id); if(el) el.textContent = String(v); };

    window.addEventListener('hha:end', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      setTxt('endGrade', d.grade ?? '‚Äî');
      setTxt('endScore', d.scoreFinal ?? d.score ?? 0);
      setTxt('endComboMax', d.comboMax ?? 0);
      setTxt('endMiss', d.misses ?? 0);

      setTxt('endGoals', d.goalsCleared ?? 0);
      setTxt('endGoalsTotal', d.goalsTotal ?? 0);

      setTxt('endMinis', d.miniCleared ?? d.minisCleared ?? 0);
      setTxt('endMinisTotal', d.miniTotal ?? d.minisTotal ?? 0);

      setTxt('endAcc', d.accuracy ?? 0);

      endBox.style.display = 'flex';
    });

    $('btnReplay').addEventListener('click', ()=>{
      location.reload();
    }, { passive:true });

    $('btnCloseEnd').addEventListener('click', ()=>{
      endBox.style.display = 'none';
    }, { passive:true });

    // initial offsets
    updateOffsets();
    window.addEventListener('resize', updateOffsets, { passive:true });

    // show desc with params
    $('startDesc').innerHTML =
      `‡πÇ‡∏´‡∏°‡∏î: <b>${diff}</b> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <b>${time}s</b> ‚Ä¢ challenge: <b>${challenge}</b> ‚Ä¢ run: <b>${run}</b><br/>` +
      `‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö gyro ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)`;
  </script>

</body>
</html>