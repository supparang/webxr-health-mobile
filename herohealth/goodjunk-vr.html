<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#fb7185;

      --crossY: 62vh; /* ‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏á */
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif; }
    *{ box-sizing:border-box; }
    #app{ position:fixed; inset:0; overflow:hidden; background: radial-gradient(1000px 700px at 50% 10%, rgba(37,99,235,.10), transparent 60%),
                                          radial-gradient(900px 700px at 50% 120%, rgba(34,197,94,.10), transparent 55%),
                                          linear-gradient(180deg, #020617, #020617); }

    /* A-Frame scene behind */
    #sceneWrap{ position:absolute; inset:0; z-index:1; }
    a-scene{ width:100%; height:100%; }
    canvas{ touch-action:none; }

    /* look-area: ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠ (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ targets) */
    #look-area{
      position:absolute; inset:0;
      z-index:2;
      background:transparent;
      touch-action:none;
    }

    /* Targets layer */
    #gj-layer{
      position:absolute; inset:0;
      z-index:3;
      pointer-events:auto;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .gj-target{
      position:absolute;
      transform: translate(-50%,-50%);
      font-size:56px;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      line-height:1;
      will-change: transform, opacity, left, top;
    }
    .gj-target.spawn{ animation: popIn .12s ease-out both; }
    .gj-target.gone{ animation: popOut .14s ease-in both; }
    @keyframes popIn{ from{ transform:translate(-50%,-50%) scale(.75); opacity:.2 } to{ transform:translate(-50%,-50%) scale(1); opacity:1 } }
    @keyframes popOut{ to{ transform:translate(-50%,-50%) scale(.55); opacity:0 } }

    /* Attack overlays */
    #atk-ring{
      position:absolute;
      width:520px; height:520px;
      border-radius:999px;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index:4;
      opacity:0;
      pointer-events:none;
      background:
        conic-gradient(from var(--ringGapStart, 0deg),
          rgba(255,255,255,.00) 0deg,
          rgba(255,255,255,.00) var(--ringGapSize, 50deg),
          rgba(248,113,113,.40) var(--ringGapSize, 50deg),
          rgba(248,113,113,.40) 360deg);
      mask: radial-gradient(circle, transparent 52%, #000 53% 64%, transparent 65%);
      filter: blur(.2px) drop-shadow(0 0 18px rgba(248,113,113,.35));
    }
    #atk-ring.show{ opacity:1; animation: ringPulse .18s ease-out both; }
    @keyframes ringPulse{ from{ transform:translate(-50%,-50%) scale(.92) } to{ transform:translate(-50%,-50%) scale(1) } }

    #atk-laser{
      position:absolute;
      left:0; width:100%; height:18px;
      z-index:4;
      pointer-events:none;
      opacity:0;
      background: linear-gradient(90deg, transparent, rgba(251,113,133,.95), transparent);
      filter: drop-shadow(0 0 18px rgba(251,113,133,.45));
    }
    #atk-laser.warn{ opacity:.65; animation: laserWarn .42s linear infinite; }
    #atk-laser.fire{ opacity:1; height:26px; }
    @keyframes laserWarn{ 50%{ opacity:.25 } }

    /* Crosshair */
    #cross{
      position:absolute;
      left:50%; top:var(--crossY);
      transform: translate(-50%,-50%);
      z-index:9;
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 0 8px rgba(255,255,255,.06);
      pointer-events:none;
    }

    /* HUD panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    #hud-top{
      position:absolute; left:12px; right:12px; top:10px;
      z-index:10;
      padding:10px 12px;
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    #hud-top .k{ font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }
    #hud-top .v{ font-size:20px; font-weight:800; }
    #hud-top .v.small{ font-size:16px; font-weight:700; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--accent); display:inline-block; }
    .muted{ color:var(--muted); }

    #hud-quest{
      position:absolute; left:12px; right:12px; top:108px;
      z-index:10;
      padding:12px;
      min-height:118px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .bar{
      height:10px; border-radius:999px;
      background:rgba(148,163,184,.15);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(59,130,246,.95));
    }
    #line-mini{ display:flex; justify-content:space-between; gap:10px; font-size:13px; }
    #line-mini b{ font-weight:800; }
    #line-mini .right{ color:var(--muted); }

    #hud-fever{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    #hud-fever .shield{ color:#cbd5e1; font-weight:800; }

    /* Footer */
    #footer{
      position:absolute; left:12px; right:12px; bottom:12px;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      pointer-events:none;
    }
    #badge{
      pointer-events:auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    #badge .lamp{ width:9px; height:9px; border-radius:999px; background:rgba(248,113,113,.9); }
    #badge.ok .lamp{ background:rgba(34,197,94,.95); }

    #enterVR{
      pointer-events:auto;
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(59,130,246,.35);
      background:rgba(37,99,235,.16);
      color:#e0f2fe;
      font-weight:800;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
    }
    #enterVR:disabled{ opacity:.55; cursor:not-allowed; }

    /* Start modal */
    #startModal{
      position:absolute; inset:0;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(900px 600px at 50% 30%, rgba(15,23,42,.50), rgba(2,6,23,.72));
    }
    #startCard{
      width:min(720px, 100%);
      padding:16px;
    }
    #startCard h1{ margin:2px 0 4px; font-size:22px; }
    #startCard p{ margin:0 0 10px; color:var(--muted); font-size:13px; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    label{ font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }
    select{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .actions{
      display:flex; gap:12px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;
    }
    .btn{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.18);
      color:#dcfce7;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Panic / FX */
    body.shake{ animation: shake .18s linear; }
    @keyframes shake{
      0%{ transform:translate(0,0) }
      20%{ transform:translate(-2px,1px) }
      40%{ transform:translate(2px,-1px) }
      60%{ transform:translate(-2px,-1px) }
      80%{ transform:translate(2px,1px) }
      100%{ transform:translate(0,0) }
    }
    #edge{
      position:absolute; inset:0;
      z-index:8;
      pointer-events:none;
      opacity:0;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08), inset 0 0 80px rgba(59,130,246,.18);
      transition: opacity .12s ease;
    }
    #edge.panic{ opacity:1; box-shadow: inset 0 0 0 2px rgba(255,255,255,.10), inset 0 0 110px rgba(251,113,133,.25); }
    #edge.final{ opacity:1; box-shadow: inset 0 0 0 2px rgba(255,255,255,.10), inset 0 0 140px rgba(245,158,11,.25); }

    /* Panic error box */
    #panicBox{
      position:absolute; left:12px; right:12px; bottom:72px;
      z-index:30;
      display:none;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(251,113,133,.35);
      background:rgba(2,6,23,.85);
      color:#fecdd3;
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      font-size:12px;
      white-space:pre-wrap;
    }
    #panicBox.show{ display:block; }
  </style>
</head>

<body>
<div id="app">

  <div id="sceneWrap">
    <a-scene embedded vr-mode-ui="enabled: false" renderer="colorManagement: true; physicallyCorrectLights: true;">
      <a-assets></a-assets>
      <a-entity id="gj-camera" camera position="0 1.6 0"></a-entity>
      <a-sky color="#020617"></a-sky>
      <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
      <a-entity light="type: directional; intensity: 0.7" position="1 2 1"></a-entity>
    </a-scene>
  </div>

  <div id="look-area"></div>

  <div id="gj-layer"></div>
  <div id="atk-ring"></div>
  <div id="atk-laser"></div>

  <div id="edge"></div>
  <div id="cross"></div>

  <div id="hud-top" class="panel">
    <div>
      <div class="k">mode</div>
      <div class="pill"><span class="dot"></span><b id="modeName">GOODJUNK</b>&nbsp;<span class="muted">‚Ä¢</span>&nbsp;<span id="runName">PLAY</span></div>
    </div>
    <div>
      <div class="k">score</div>
      <div class="v" id="uiScore">0</div>
    </div>
    <div>
      <div class="k">combo max</div>
      <div class="v small" id="uiComboMax">0</div>
    </div>
    <div>
      <div class="k">miss</div>
      <div class="v small" id="uiMiss">0</div>
    </div>
  </div>

  <div id="hud-quest" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div>
        <div class="k">time</div>
        <div class="v small"><span id="uiTime">--</span><span class="muted">s</span></div>
      </div>
      <div class="pill" id="uiDiffChallenge">Diff: NORMAL ‚Ä¢ Challenge: RUSH</div>
    </div>

    <div>
      <div class="k">quest</div>
      <div style="font-weight:900;font-size:16px; margin-top:4px;" id="qTitle">‚Äî</div>
      <div class="bar" style="margin-top:8px;"><i id="qBar"></i></div>
    </div>

    <div id="line-mini">
      <div><b id="miniText">Mini: ‚Äî</b></div>
      <div class="right" id="miniCount">mini ‡∏ú‡πà‡∏≤‡∏ô 0 ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà 0</div>
    </div>

    <div id="hud-fever">
      <div>FEVER <span id="uiFever">0</span>%</div>
      <div class="shield">üõ°Ô∏è Shield <span id="uiShield">0</span></div>
    </div>
  </div>

  <div id="footer">
    <div id="badge"><span class="lamp"></span><span id="badgeText">boot: idle</span></div>
    <button id="enterVR">ü•Ω Enter VR</button>
  </div>

  <div id="panicBox"></div>

  <div id="startModal">
    <div id="startCard" class="panel">
      <h1>GoodJunk VR</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å + ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚úÖ</p>

      <div class="grid2">
        <div>
          <label>Difficulty</label>
          <select id="selDiff">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div>
          <label>Challenge</label>
          <select id="selCh">
            <option value="rush" selected>Rush</option>
            <option value="boss">Boss</option>
            <option value="survival">Survival</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnStart2D">‚ñ∂ Start 2D</button>
        <button class="btn primary" id="btnStartVR">ü•Ω Start VR</button>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        * ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° <b>?ts=1</b> ‡∏ó‡πâ‡∏≤‡∏¢ URL ‡∏´‡∏£‡∏∑‡∏≠ Clear Storage ‡∏Ç‡∏≠‡∏á‡πÇ‡∏î‡πÄ‡∏°‡∏ô
      </div>
    </div>
  </div>

</div>

<script type="module">
  'use strict';

  const $ = (id)=>document.getElementById(id);

  const elLayer = $('gj-layer');
  const elCamEntity = $('gj-camera');
  const elLookArea = $('look-area');

  const elModal = $('startModal');
  const btn2D = $('btnStart2D');
  const btnVR = $('btnStartVR');
  const btnEnterVR = $('enterVR');

  const badge = $('badge');
  const badgeText = $('badgeText');
  const panicBox = $('panicBox');

  const uiScore = $('uiScore');
  const uiComboMax = $('uiComboMax');
  const uiMiss = $('uiMiss');
  const uiTime = $('uiTime');
  const uiFever = $('uiFever');
  const uiShield = $('uiShield');
  const uiDiffChallenge = $('uiDiffChallenge');

  const qTitle = $('qTitle');
  const qBar = $('qBar');
  const miniText = $('miniText');
  const miniCount = $('miniCount');

  const edge = $('edge');

  // ===== Debug badge =====
  function setBadge(ok, text){
    badge.classList.toggle('ok', !!ok);
    badgeText.textContent = String(text||'');
  }

  function showPanic(msg, err){
    const e = err ? (err?.stack || err?.message || String(err)) : '';
    panicBox.textContent = String(msg||'') + (e ? ('\n\n' + e) : '');
    panicBox.classList.add('show');
  }
  function hidePanic(){ panicBox.classList.remove('show'); }

  // ===== Simple tick sound (WebAudio) =====
  let AC=null, tickGain=null;
  function ensureAudio(){
    if (AC) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    AC = new Ctx();
    tickGain = AC.createGain();
    tickGain.gain.value = 0.04;
    tickGain.connect(AC.destination);
  }
  function beep(freq=880, ms=40){
    try{
      ensureAudio();
      if (!AC) return;
      const o = AC.createOscillator();
      o.type = 'square';
      o.frequency.value = freq;
      o.connect(tickGain);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(_){ } }, ms);
    }catch(_){}
  }

  // ===== Selector persist + URL override (fix "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å easy ‡πÅ‡∏ï‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥") =====
  (function initSelectors(){
    const U = new URL(location.href);
    const sDiff = $('selDiff');
    const sCh = $('selCh');

    const urlDiff = (U.searchParams.get('diff')||'').toLowerCase();
    const urlCh   = (U.searchParams.get('challenge')||'').toLowerCase();

    const savedDiff = localStorage.getItem('gj_diff') || '';
    const savedCh   = localStorage.getItem('gj_ch') || '';

    const setIfValid = (sel, v)=>{
      if (!v) return false;
      const ok = Array.from(sel.options).some(o => o.value === v);
      if (ok){ sel.value = v; return true; }
      return false;
    };

    if (!setIfValid(sDiff, urlDiff)) setIfValid(sDiff, savedDiff);
    if (!setIfValid(sCh, urlCh))     setIfValid(sCh, savedCh);

    sDiff.addEventListener('change', ()=> localStorage.setItem('gj_diff', sDiff.value));
    sCh.addEventListener('change',   ()=> localStorage.setItem('gj_ch', sCh.value));
  })();

  // ===== Module loading (anti-hang) =====
  let modSafe=null, modTouch=null;
  let engine=null;
  let touchCtl=null;

  async function importFirst(paths){
    let last=null;
    for (const p of paths){
      try{ return await import(p); }
      catch(e){ last=e; }
    }
    throw last || new Error('import failed');
  }

  async function ensureModules(){
    if (modSafe && modTouch) return { modSafe, modTouch };

    hidePanic();
    setBadge(false, 'boot: loading modules‚Ä¶');

    const watchdog = setTimeout(()=>{
      showPanic('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ô‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏≠‡∏≤‡∏à cache/404 (‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° ?ts=1 ‡∏´‡∏£‡∏∑‡∏≠ Clear storage)');
      setBadge(false, 'boot: stuck (cache/404?)');
    }, 6000);

    try{
      // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: /herohealth/goodjunk-vr.html + /herohealth/vr-goodjunk/*.js
      // fallback: /herohealth/*.js (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå)
      const safePaths  = ['./vr-goodjunk/goodjunk.safe.js', './goodjunk.safe.js'];
      const touchPaths = ['./vr-goodjunk/touch-look-goodjunk.js', './touch-look-goodjunk.js'];

      modSafe  = await importFirst(safePaths);
      modTouch = await importFirst(touchPaths);

      clearTimeout(watchdog);
      setBadge(true, 'boot: modules ready');

      // attach touch look (drag/gyro) ‚Äî pass look-area so targets still clickable
      try{ touchCtl?.destroy?.(); }catch(_){}
      touchCtl = modTouch.attachTouchLook(elCamEntity, { areaEl: elLookArea, sensitivity: 0.26 });

      startParallaxLoop();

      return { modSafe, modTouch };
    }catch(err){
      clearTimeout(watchdog);
      showPanic('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ path/‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô repo)', err);
      setBadge(false, 'boot: import failed');
      throw err;
    }
  }

  // ===== VR-like parallax: targets move when you look =====
  let rafPar=0;
  function startParallaxLoop(){
    cancelAnimationFrame(rafPar);
    const pxPerRadX = ()=> innerWidth * 0.38;
    const pxPerRadY = ()=> innerHeight * 0.22;

    function tick(){
      try{
        const r = elCamEntity?.object3D?.rotation;
        if (r){
          const ox = -r.y * pxPerRadX();
          const oy = -r.x * pxPerRadY();

          // ‚úÖ Move layer (visual VR feel)
          elLayer.style.transform = `translate3d(${ox.toFixed(1)}px, ${oy.toFixed(1)}px, 0)`;

          // ‚úÖ NEW: expose offset so goodjunk.safe.js can spawn/magnet correctly
          window.__GJ_LAYER_OFFSET__ = { x: ox, y: oy };
        }
        // aimpoint for hazards (crosshair at 62%)
        window.__GJ_AIM_POINT__ = { x: (innerWidth*0.5)|0, y: (innerHeight*0.62)|0 };
      }catch(_){}
      rafPar = requestAnimationFrame(tick);
    }
    rafPar = requestAnimationFrame(tick);
  }

  // ===== HUD updates from game events =====
  window.addEventListener('hha:score', (e)=>{
    const d = e.detail||{};
    uiScore.textContent = String(d.score ?? 0);
    uiComboMax.textContent = String(d.comboMax ?? 0);
    uiMiss.textContent = String(d.misses ?? 0);
  });

  window.addEventListener('hha:time', (e)=>{
    const d = e.detail||{};
    uiTime.textContent = String(d.sec ?? '--');
  });

  window.addEventListener('hha:fever', (e)=>{
    const d = e.detail||{};
    uiFever.textContent = String(Math.round(d.fever ?? 0));
    uiShield.textContent = String(d.shield ?? 0);
  });

  window.addEventListener('quest:update', (e)=>{
    const d = e.detail||{};
    qTitle.textContent = d.title || '‚Äî';
    const pct = Math.max(0, Math.min(100, Number(d.progressPct||0)));
    qBar.style.width = pct.toFixed(0)+'%';
    if (d.miniText) miniText.textContent = d.miniText;
    if (typeof d.miniCleared === 'number' || typeof d.miniLeft === 'number'){
      miniCount.textContent = `mini ‡∏ú‡πà‡∏≤‡∏ô ${d.miniCleared||0} ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ${d.miniLeft||0}`;
    }
  });

  // ===== FX bridge =====
  function kick(){
    document.body.classList.remove('shake');
    void document.body.offsetWidth;
    document.body.classList.add('shake');
  }
  window.addEventListener('hha:fx', (e)=>{
    const d = e.detail||{};
    if (d.type === 'kick') kick();
    if (d.type === 'chroma'){
      edge.classList.add('panic');
      setTimeout(()=> edge.classList.remove('panic'), Math.max(90, d.ms||150));
    }
    if (d.type === 'hero'){
      edge.classList.add('final');
      setTimeout(()=> edge.classList.remove('final'), Math.max(120, d.ms||220));
    }
  });

  window.addEventListener('hha:tick', (e)=>{
    const d = e.detail||{};
    const k = String(d.kind||'tick');
    const intensity = Number(d.intensity||1);
    if (k.includes('laser')) beep(980 + intensity*80, 26);
    else if (k.includes('ring')) beep(860 + intensity*60, 30);
    else if (k.includes('final')) beep(1200, 24);
    else beep(820, 28);

    if (intensity >= 1.6) kick();
  });

  window.addEventListener('hha:panic', (e)=>{
    const d = e.detail||{};
    const lv = Number(d.level||0);
    if (lv > 0.05) edge.classList.add('panic');
    else edge.classList.remove('panic');
  });

  window.addEventListener('hha:finalPulse', ()=>{
    edge.classList.add('final');
    setTimeout(()=> edge.classList.remove('final'), 260);
  });

  window.addEventListener('hha:bossAtk', (e)=>{
    const d = e.detail||{};
    setBadge(true, `boss atk: ${d.name||'?'}`);
    setTimeout(()=> setBadge(true, 'running‚Ä¶'), 520);
  });

  window.addEventListener('hha:storm', (e)=>{
    const d = e.detail||{};
    if (d.active){
      setBadge(true, `STORM x${(d.mul||1).toFixed(2)}`);
      edge.classList.add('panic');
    } else {
      setBadge(true, 'running‚Ä¶');
      edge.classList.remove('panic');
    }
  });

  // ===== Start =====
  function getSelected(){
    const diff = $('selDiff').value;
    const ch = $('selCh').value;
    return { diff, challenge: ch };
  }

  function calcSafeMargins(){
    // ‡πÉ‡∏ä‡πâ HUD ‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì safe zone (‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏±‡∏ö HUD)
    const questRect = $('hud-quest').getBoundingClientRect();
    const top = Math.ceil(questRect.bottom + 14);

    const footerRect = $('footer').getBoundingClientRect();
    const bottom = Math.ceil((innerHeight - footerRect.top) + 10);

    const left = 14;
    const right = 14;
    return { top, bottom, left, right };
  }

  async function startGame(runMode='play'){
    btn2D.disabled = true; btnVR.disabled = true;
    try{
      ensureAudio(); // unlock audio after user gesture
      await ensureModules();

      const { diff, challenge } = getSelected();
      uiDiffChallenge.textContent = `Diff: ${diff.toUpperCase()} ‚Ä¢ Challenge: ${challenge.toUpperCase()}`;

      // stop old
      try{ engine?.stop?.(); }catch(_){}
      engine = null;

      elModal.style.display = 'none';
      setBadge(true, 'starting‚Ä¶');

      // ‚úÖ call boot of goodjunk.safe.js
      engine = modSafe.boot({
        diff,
        challenge,
        run: runMode,
        time: 60,
        layerEl: elLayer,

        // ‚úÖ NEW: send safeMargins to safe.js
        safeMargins: calcSafeMargins()
      });

      setBadge(true, 'running‚Ä¶');
    }catch(err){
      showPanic('Start ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err);
      setBadge(false, 'start failed');
      elModal.style.display = 'flex';
    }finally{
      btn2D.disabled = false; btnVR.disabled = false;
    }
  }

  btn2D.addEventListener('click', ()=> startGame('play'));
  btnVR.addEventListener('click', ()=> startGame('play'));

  // Enter VR (A-Frame)
  btnEnterVR.addEventListener('click', async ()=>{
    try{
      ensureAudio();
      const scene = document.querySelector('a-scene');
      if (scene?.enterVR) scene.enterVR();
    }catch(e){
      showPanic('Enter VR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e);
    }
  });

  // initial
  setBadge(true, 'boot: idle');
</script>

</body>
</html>