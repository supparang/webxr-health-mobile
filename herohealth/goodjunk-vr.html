<!-- === /herohealth/goodjunk-vr.html === -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#fb7185;

      --crossY: 62vh;
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif; }
    *{ box-sizing:border-box; }
    #app{ position:fixed; inset:0; overflow:hidden; background: radial-gradient(1000px 700px at 50% 10%, rgba(37,99,235,.10), transparent 60%),
                                          radial-gradient(900px 700px at 50% 120%, rgba(34,197,94,.10), transparent 55%),
                                          linear-gradient(180deg, #020617, #020617); }

    /* A-Frame scene behind */
    #sceneWrap{ position:absolute; inset:0; z-index:1; }
    a-scene{ width:100%; height:100%; }
    canvas{ touch-action:none; }

    /* look-area: ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠ */
    #look-area{
      position:absolute; inset:0;
      z-index:2;
      background:transparent;
      touch-action:none;
    }

    /* Targets layer */
    #gj-layer{
      position:absolute; inset:0;
      z-index:3;
      pointer-events:auto;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .gj-target{
      position:absolute;
      transform: translate(-50%,-50%);
      font-size:56px;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      user-select:none;
      -webkit-user-select:none;
      cursor:pointer;
      line-height:1;
      will-change: transform, opacity, left, top;
    }
    .gj-target.spawn{ animation: popIn .12s ease-out both; }
    .gj-target.gone{ animation: popOut .14s ease-in both; }
    @keyframes popIn{ from{ transform:translate(-50%,-50%) scale(.75); opacity:.2 } to{ transform:translate(-50%,-50%) scale(1); opacity:1 } }
    @keyframes popOut{ to{ transform:translate(-50%,-50%) scale(.55); opacity:0 } }

    /* Attack overlays */
    #atk-ring{
      position:absolute;
      width:520px; height:520px;
      border-radius:999px;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index:4;
      opacity:0;
      pointer-events:none;
      background:
        conic-gradient(from var(--ringGapStart, 0deg),
          rgba(255,255,255,.00) 0deg,
          rgba(255,255,255,.00) var(--ringGapSize, 50deg),
          rgba(248,113,113,.40) var(--ringGapSize, 50deg),
          rgba(248,113,113,.40) 360deg);
      mask: radial-gradient(circle, transparent 52%, #000 53% 64%, transparent 65%);
      filter: blur(.2px) drop-shadow(0 0 18px rgba(248,113,113,.35));
    }
    #atk-ring.show{ opacity:1; animation: ringPulse .18s ease-out both; }
    @keyframes ringPulse{ from{ transform:translate(-50%,-50%) scale(.92) } to{ transform:translate(-50%,-50%) scale(1) } }

    #atk-laser{
      position:absolute;
      left:0; width:100%; height:18px;
      z-index:4;
      pointer-events:none;
      opacity:0;
      background: linear-gradient(90deg, transparent, rgba(251,113,133,.95), transparent);
      filter: drop-shadow(0 0 18px rgba(251,113,133,.45));
    }
    #atk-laser.warn{ opacity:.65; animation: laserWarn .42s linear infinite; }
    #atk-laser.fire{ opacity:1; height:26px; }
    @keyframes laserWarn{ 50%{ opacity:.25 } }

    /* Crosshair */
    #cross{
      position:absolute;
      left:50%; top:var(--crossY);
      transform: translate(-50%,-50%);
      z-index:9;
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 0 8px rgba(255,255,255,.06);
      pointer-events:none;
    }

    /* HUD panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    #hud-top{
      position:absolute; left:12px; right:12px; top:10px;
      z-index:10;
      padding:10px 12px;
      display:grid;
      grid-template-columns: 1.25fr 1fr 1fr 1fr .9fr;
      gap:10px;
      align-items:center;
    }
    #hud-top .k{ font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }
    #hud-top .v{ font-size:20px; font-weight:900; }
    #hud-top .v.small{ font-size:16px; font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--accent); display:inline-block; }
    .muted{ color:var(--muted); }

    /* Grade badge realtime */
    #uiGrade{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:64px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.14);
      font-weight:1000;
      letter-spacing:.04em;
    }
    #uiGrade.pop{ animation: gradePop .18s ease-out both; }
    @keyframes gradePop{
      from{ transform:scale(.92); filter:drop-shadow(0 0 0 rgba(0,0,0,0)); }
      to{ transform:scale(1); filter:drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
    }
    #uiGrade.sss{ box-shadow:0 0 0 2px rgba(245,158,11,.18), 0 16px 40px rgba(245,158,11,.18); }
    #uiGrade.ss { box-shadow:0 0 0 2px rgba(59,130,246,.18), 0 16px 40px rgba(59,130,246,.16); }
    #uiGrade.s  { box-shadow:0 0 0 2px rgba(34,197,94,.18), 0 16px 40px rgba(34,197,94,.14); }

    #hud-quest{
      position:absolute; left:12px; right:12px; top:108px;
      z-index:10;
      padding:12px;
      min-height:126px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .bar{
      height:10px; border-radius:999px;
      background:rgba(148,163,184,.15);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(59,130,246,.95));
    }

    #qTitle{ font-weight:1000;font-size:16px; margin-top:4px; }
    #qSub{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #qSub .left{ overflow:hidden; text-overflow:ellipsis; }
    #qSub .right{ opacity:.9; }

    #line-mini{ display:flex; justify-content:space-between; gap:10px; font-size:13px; }
    #line-mini b{ font-weight:1000; }
    #line-mini .right{ color:var(--muted); }

    #hud-fever{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    #hud-fever .shield{ color:#cbd5e1; font-weight:900; }

    /* Footer */
    #footer{
      position:absolute; left:12px; right:12px; bottom:12px;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      pointer-events:none;
    }
    #badge{
      pointer-events:auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    #badge .lamp{ width:9px; height:9px; border-radius:999px; background:rgba(248,113,113,.9); }
    #badge.ok .lamp{ background:rgba(34,197,94,.95); }

    #enterVR{
      pointer-events:auto;
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(59,130,246,.35);
      background:rgba(37,99,235,.16);
      color:#e0f2fe;
      font-weight:1000;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
    }
    #enterVR:disabled{ opacity:.55; cursor:not-allowed; }

    /* Start modal */
    #startModal, #endModal{
      position:absolute; inset:0;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(900px 600px at 50% 30%, rgba(15,23,42,.50), rgba(2,6,23,.72));
    }
    #endModal{ z-index:25; display:none; }
    #startCard, #endCard{
      width:min(760px, 100%);
      padding:16px;
    }
    #startCard h1, #endCard h1{ margin:2px 0 4px; font-size:22px; }
    #startCard p, #endCard p{ margin:0 0 10px; color:var(--muted); font-size:13px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    label{ font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }
    select{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .actions{
      display:flex; gap:12px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;
    }
    .btn{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn.primary{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.18);
      color:#dcfce7;
    }
    .btn.alt{
      border-color:rgba(59,130,246,.35);
      background:rgba(37,99,235,.16);
      color:#e0f2fe;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* End summary cards */
    .sumGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .sumCard{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.12);
    }
    .sumCard .k{ font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }
    .sumCard .v{ font-size:24px; font-weight:1100; margin-top:6px; }

    /* BIG grade */
    #gradeBig{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    #gradeBig .left{
      display:flex; align-items:center; gap:12px;
    }
    #gradeBigBadge{
      font-size:28px;
      font-weight:1200;
      padding:8px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.55);
      min-width:88px;
      text-align:center;
      letter-spacing:.06em;
      animation: gradePop2 .22s ease-out both;
    }
    @keyframes gradePop2{
      from{ transform:scale(.88); opacity:.6; }
      to{ transform:scale(1); opacity:1; }
    }
    #gradeBigText{
      font-weight:1000;
      font-size:14px;
      color:#e2e8f0;
    }
    #gradeBigHint{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }

    /* Panic / FX */
    body.shake{ animation: shake .18s linear; }
    @keyframes shake{
      0%{ transform:translate(0,0) }
      20%{ transform:translate(-2px,1px) }
      40%{ transform:translate(2px,-1px) }
      60%{ transform:translate(-2px,-1px) }
      80%{ transform:translate(2px,1px) }
      100%{ transform:translate(0,0) }
    }
    #edge{
      position:absolute; inset:0;
      z-index:8;
      pointer-events:none;
      opacity:0;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08), inset 0 0 80px rgba(59,130,246,.18);
      transition: opacity .12s ease;
    }
    #edge.panic{ opacity:1; box-shadow: inset 0 0 0 2px rgba(255,255,255,.10), inset 0 0 110px rgba(251,113,133,.25); }
    #edge.final{ opacity:1; box-shadow: inset 0 0 0 2px rgba(255,255,255,.10), inset 0 0 140px rgba(245,158,11,.25); }

    /* Panic error box */
    #panicBox{
      position:absolute; left:12px; right:12px; bottom:72px;
      z-index:30;
      display:none;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(251,113,133,.35);
      background:rgba(2,6,23,.85);
      color:#fecdd3;
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      font-size:12px;
      white-space:pre-wrap;
    }
    #panicBox.show{ display:block; }

    /* Floating Pop (fallback) */
    #floating-pop-layer{
      position:fixed; inset:0;
      z-index:999;
      pointer-events:none;
      display:block;
    }
    .fp{
      position:absolute;
      left:50%; top:48%;
      transform:translate(-50%,-50%) scale(.92);
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.72);
      color:#e5e7eb;
      font-weight:1100;
      letter-spacing:.02em;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      opacity:0;
      animation: fpIn .14s ease-out forwards, fpOut .24s ease-in forwards;
      animation-delay: 0ms, var(--fpHold, 900ms);
      white-space:nowrap;
      max-width:min(92vw, 820px);
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fp.bad{ border-color:rgba(251,113,133,.28); color:#fecdd3; }
    .fp.good{ border-color:rgba(34,197,94,.28); color:#dcfce7; }
    .fp.gold{ border-color:rgba(245,158,11,.30); color:#ffedd5; }
    @keyframes fpIn{ to{ opacity:1; transform:translate(-50%,-50%) scale(1); } }
    @keyframes fpOut{ to{ opacity:0; transform:translate(-50%,-58%) scale(.98); } }

    /* ‚úÖ Confetti (SSS/SS) */
    #confetti-layer{
      position:fixed; inset:0;
      z-index:998;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti{
      position:absolute;
      top:-10vh;
      width:10px; height:16px;
      border-radius:2px;
      opacity:.95;
      transform: translate3d(0,0,0) rotate(0deg);
      animation: confFall var(--cfDur, 1200ms) linear forwards;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    @keyframes confFall{
      to{
        transform: translate3d(var(--cfDx, 0px), 115vh, 0) rotate(var(--cfRot, 540deg));
        opacity:0.95;
      }
    }
    /* ‚úÖ Sparkle (S/A/B/C encouragement) */
    .sparkle{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%) scale(.9);
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.68);
      color:#e5e7eb;
      font-weight:1100;
      letter-spacing:.02em;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      animation: spIn .14s ease-out forwards, spOut .24s ease-in forwards;
      animation-delay: 0ms, 950ms;
    }
    @keyframes spIn{ to{ opacity:1; transform:translate(-50%,-50%) scale(1);} }
    @keyframes spOut{ to{ opacity:0; transform:translate(-50%,-58%) scale(.98);} }

    /* Mobile tweak */
    @media (max-width: 420px){
      #hud-top{ grid-template-columns: 1.25fr 1fr 1fr; }
      #hud-top .gHide{ display:none; } /* hide miss/grade */
      #hud-quest{ top:92px; }
      #coachText{ font-size:11px !important; }
    }
  </style>
</head>

<body>
<div id="app">

  <div id="sceneWrap">
    <a-scene embedded vr-mode-ui="enabled: false" renderer="colorManagement: true; physicallyCorrectLights: true;">
      <a-assets></a-assets>
      <a-entity id="gj-camera" camera position="0 1.6 0"></a-entity>
      <a-sky color="#020617"></a-sky>
      <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
      <a-entity light="type: directional; intensity: 0.7" position="1 2 1"></a-entity>
    </a-scene>
  </div>

  <div id="look-area"></div>

  <div id="gj-layer"></div>
  <div id="atk-ring"></div>
  <div id="atk-laser"></div>

  <div id="edge"></div>
  <div id="cross"></div>

  <div id="hud-top" class="panel">
    <div>
      <div class="k">mode</div>
      <div class="pill"><span class="dot"></span><b id="modeName">GOODJUNK</b>&nbsp;<span class="muted">‚Ä¢</span>&nbsp;<span id="runName">PLAY</span></div>
    </div>
    <div>
      <div class="k">score</div>
      <div class="v" id="uiScore">0</div>
    </div>
    <div>
      <div class="k">combo max</div>
      <div class="v small" id="uiComboMax">0</div>
    </div>
    <div class="gHide">
      <div class="k">miss</div>
      <div class="v small" id="uiMiss">0</div>
    </div>
    <div class="gHide">
      <div class="k">grade</div>
      <div id="uiGrade">C</div>
    </div>
  </div>

  <div id="hud-quest" class="panel">
    <div style="display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <div class="k">time</div>
          <div class="v small"><span id="uiTime">--</span><span class="muted">s</span></div>
        </div>
        <div class="pill" id="uiDiffChallenge">Diff: NORMAL ‚Ä¢ Challenge: RUSH</div>
      </div>

      <!-- ‚úÖ Coach HUD -->
      <div style="display:flex; align-items:center; gap:10px;">
        <img id="coachImg" alt="coach" src="./img/coach-neutral.png"
          style="width:54px;height:54px;object-fit:contain;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.14);" />
        <div style="max-width:180px;">
          <div class="k">coach</div>
          <div style="font-size:12px;font-weight:1000;color:#e2e8f0;line-height:1.2;" id="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ô‡∏∞ ü•¶</div>
        </div>
      </div>
    </div>

    <div>
      <div class="k">quest</div>
      <div id="qTitle">‚Äî</div>

      <div id="qSub">
        <div class="left" id="qSubLeft">Mini: ‚Äî</div>
        <div class="right" id="qSubRight">goals ‚Ä¢ minis</div>
      </div>

      <div class="bar" style="margin-top:8px;"><i id="qBar"></i></div>
    </div>

    <div id="line-mini">
      <div><b id="miniText">Mini: ‚Äî</b></div>
      <div class="right" id="miniCount">mini ‡∏ú‡πà‡∏≤‡∏ô 0 ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà 0</div>
    </div>

    <div id="hud-fever">
      <div>FEVER <span id="uiFever">0</span>%</div>
      <div class="shield">üõ°Ô∏è Shield <span id="uiShield">0</span></div>
    </div>
  </div>

  <div id="footer">
    <div id="badge"><span class="lamp"></span><span id="badgeText">boot: idle</span></div>
    <button id="enterVR">ü•Ω Enter VR</button>
  </div>

  <div id="panicBox"></div>
  <div id="floating-pop-layer"></div>
  <div id="confetti-layer" aria-hidden="true"></div>

  <!-- START -->
  <div id="startModal">
    <div id="startCard" class="panel">
      <h1>GoodJunk VR</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å + ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚úÖ</p>

      <div class="grid2">
        <div>
          <label>Difficulty</label>
          <select id="selDiff">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div>
          <label>Challenge</label>
          <select id="selCh">
            <option value="rush" selected>Rush</option>
            <option value="boss">Boss</option>
            <option value="survival">Survival</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnStart2D">‚ñ∂ Start 2D</button>
        <button class="btn primary" id="btnStartVR">ü•Ω Start VR</button>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        * ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° <b>?ts=1</b> ‡∏ó‡πâ‡∏≤‡∏¢ URL ‡∏´‡∏£‡∏∑‡∏≠ Clear Storage ‡∏Ç‡∏≠‡∏á‡πÇ‡∏î‡πÄ‡∏°‡∏ô
      </div>
    </div>
  </div>

  <!-- END SUMMARY -->
  <div id="endModal">
    <div id="endCard" class="panel">
      <h1>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• GoodJunk VR</h1>
      <p id="endSub" class="muted">‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å üéâ</p>

      <div id="gradeBig">
        <div class="left">
          <div id="gradeBigBadge">C</div>
          <div>
            <div id="gradeBigText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞ ü•¶</div>
            <div class="muted" style="margin-top:4px;font-size:12px;font-weight:900;" id="gradeBigStars">‚òÖ</div>
          </div>
        </div>
        <div id="gradeBigHint">‡∏Å‡∏î Replay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ï‡πà SSS!</div>
      </div>

      <div class="sumGrid">
        <div class="sumCard">
          <div class="k">score</div>
          <div class="v" id="endScore">0</div>
        </div>
        <div class="sumCard">
          <div class="k">combo max</div>
          <div class="v" id="endComboMax">0</div>
        </div>
        <div class="sumCard">
          <div class="k">good hits</div>
          <div class="v" id="endGoodHits">0</div>
        </div>
        <div class="sumCard">
          <div class="k">miss</div>
          <div class="v" id="endMiss">0</div>
        </div>
      </div>

      <div style="margin-top:10px; padding:10px 12px; border-radius:16px; border:1px solid var(--stroke); background:rgba(0,0,0,.16); display:flex; gap:10px; align-items:flex-start;">
        <img id="endCoachImg" alt="coach" src="./img/coach-neutral.png"
          style="width:64px;height:64px;object-fit:contain;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.12);" />
        <div>
          <div style="font-weight:1100;">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div class="muted" id="endCoach">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô üí™</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn alt" id="btnReplay">üîÅ Replay</button>
        <button class="btn primary" id="btnHub">üè† Hub</button>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        * Tip: ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ S/SS/SSS ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö + ‡∏•‡∏î‡πÇ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ üî•
      </div>
    </div>
  </div>

</div>

<script type="module">
  'use strict';

  const $ = (id)=>document.getElementById(id);

  const elLayer = $('gj-layer');
  const elCamEntity = $('gj-camera');
  const elLookArea = $('look-area');

  const elStart = $('startModal');
  const elEnd = $('endModal');

  const btn2D = $('btnStart2D');
  const btnVR = $('btnStartVR');
  const btnEnterVR = $('enterVR');

  const badge = $('badge');
  const badgeText = $('badgeText');
  const panicBox = $('panicBox');

  const uiScore = $('uiScore');
  const uiComboMax = $('uiComboMax');
  const uiMiss = $('uiMiss');
  const uiTime = $('uiTime');
  const uiFever = $('uiFever');
  const uiShield = $('uiShield');
  const uiDiffChallenge = $('uiDiffChallenge');
  const uiGrade = $('uiGrade');

  const qTitle = $('qTitle');
  const qBar = $('qBar');
  const miniText = $('miniText');
  const miniCount = $('miniCount');
  const qSubLeft = $('qSubLeft');
  const qSubRight = $('qSubRight');

  const edge = $('edge');
  const fpLayer = $('floating-pop-layer');
  const confLayer = $('confetti-layer');

  const coachImg = $('coachImg');
  const coachText = $('coachText');

  // End refs
  const endSub = $('endSub');
  const endScore = $('endScore');
  const endComboMax = $('endComboMax');
  const endGoodHits = $('endGoodHits');
  const endMiss = $('endMiss');
  const endCoach = $('endCoach');
  const endCoachImg = $('endCoachImg');
  const gradeBigBadge = $('gradeBigBadge');
  const gradeBigText = $('gradeBigText');
  const gradeBigStars = $('gradeBigStars');

  const btnReplay = $('btnReplay');
  const btnHub = $('btnHub');

  // ===== Debug badge (auto revert) =====
  let badgeTimer = 0;
  function setBadge(ok, text){
    badge.classList.toggle('ok', !!ok);
    badgeText.textContent = String(text||'');
  }
  function setBadgeTemp(ok, text, ms=900){
    clearTimeout(badgeTimer);
    setBadge(ok, text);
    badgeTimer = setTimeout(()=> setBadge(true, 'running‚Ä¶'), Math.max(300, ms|0));
  }

  function showPanic(msg, err){
    const e = err ? (err?.stack || err?.message || String(err)) : '';
    panicBox.textContent = String(msg||'') + (e ? ('\n\n' + e) : '');
    panicBox.classList.add('show');
  }
  function hidePanic(){ panicBox.classList.remove('show'); }

  // ===== Floating Pop helper =====
  function floatingPop(text, tone='good', holdMs=900){
    try{
      const P = (window.GAME_MODULES && window.GAME_MODULES.Particles) || window.Particles;
      if (P && typeof P.toast === 'function'){
        P.toast(String(text||''), { tone, ms: holdMs|0 });
        return;
      }
    }catch(_){}

    const el = document.createElement('div');
    el.className = `fp ${tone||''}`;
    el.style.setProperty('--fpHold', (holdMs|0)+'ms');
    el.textContent = String(text||'');
    fpLayer.appendChild(el);
    setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, (holdMs|0) + 500);
  }

  // ===== Simple tick sound (WebAudio) =====
  let AC=null;
  function ensureAudio(){
    if (AC) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    AC = new Ctx();
  }
  function tone(freq, ms, type='sine'){
    try{
      ensureAudio();
      if (!AC) return;
      const o = AC.createOscillator();
      const g = AC.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(AC.destination);

      const t0 = AC.currentTime;
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.05, t0+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+(ms/1000));

      o.start();
      setTimeout(()=>{ try{o.stop();}catch(_){ } }, ms+30);
    }catch(_){}
  }
  function beep(freq=880, ms=40){ tone(freq, ms, 'square'); }

  function playGradeSound(grade='C'){
    grade = String(grade||'C').toUpperCase();
    if (grade === 'SSS'){
      tone(784, 120, 'square');  setTimeout(()=>tone(988, 120, 'square'), 120);
      setTimeout(()=>tone(1175, 160, 'square'), 240);
      setTimeout(()=>tone(1568, 220, 'square'), 420);
      return;
    }
    if (grade === 'SS'){
      tone(880, 90, 'sine'); setTimeout(()=>tone(1175, 120, 'sine'), 90);
      setTimeout(()=>tone(1568, 160, 'sine'), 220);
      return;
    }
    if (grade === 'S'){
      tone(659, 90, 'sine'); setTimeout(()=>tone(880, 140, 'sine'), 90);
      return;
    }
    if (grade === 'A'){ tone(523, 120, 'triangle'); return; }
    if (grade === 'B'){ tone(440, 140, 'triangle'); return; }
    tone(392, 160, 'triangle');
  }

  // ===== Coach assets (‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ) =====
  const COACH_SRC = {
    happy: './img/coach-happy.png',
    neutral: './img/coach-neutral.png',
    sad: './img/coach-sad.png',
    fever: './img/coach-fever.png'
  };

  function setCoach(mood='neutral', text=''){
    const src = COACH_SRC[mood] || COACH_SRC.neutral;
    try{
      if (coachImg) coachImg.src = src;
      if (coachText && text) coachText.textContent = text;
    }catch(_){}
  }
  function setEndCoach(mood='neutral', text=''){
    const src = COACH_SRC[mood] || COACH_SRC.neutral;
    try{
      if (endCoachImg) endCoachImg.src = src;
      if (endCoach && text) endCoach.textContent = text;
    }catch(_){}
  }

  // ===== Confetti/Sparkle =====
  function confettiBurst(count=36){
    if (!confLayer) return;
    const w = innerWidth;
    const palette = ['rgba(34,197,94,.95)','rgba(59,130,246,.95)','rgba(245,158,11,.95)','rgba(251,113,133,.95)','rgba(226,232,240,.95)'];
    for (let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = (Math.random()*w) + 'px';
      el.style.setProperty('--cfDx', ((Math.random()*2-1)*160).toFixed(0)+'px');
      el.style.setProperty('--cfRot', (360 + Math.random()*900).toFixed(0)+'deg');
      el.style.setProperty('--cfDur', (900 + Math.random()*700).toFixed(0)+'ms');
      el.style.background = palette[(Math.random()*palette.length)|0];
      confLayer.appendChild(el);
      setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, 1900);
    }
  }
  function sparkle(text='‚ú® ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!'){
    if (!confLayer) return;
    const el = document.createElement('div');
    el.className = 'sparkle';
    el.textContent = text;
    confLayer.appendChild(el);
    setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, 1400);
  }

  // ===== Grade logic (‡πÄ‡∏î‡πá‡∏Å ‡∏õ.5 ‚Äî ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ + ‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à) =====
  function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }
  function starsFor(grade){
    grade = String(grade||'C').toUpperCase();
    if (grade==='SSS') return 3;
    if (grade==='SS') return 2;
    if (grade==='S') return 1;
    return 0;
  }
  function moodByGrade(grade){
    grade = String(grade||'C').toUpperCase();
    if (grade === 'SSS' || grade === 'SS' || grade === 'S') return 'happy';
    if (grade === 'A') return 'neutral';
    return 'sad';
  }

  // ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Å‡∏£‡∏î: ‡πÉ‡∏ä‡πâ "score + combo + miss + goodHits" (‡πÑ‡∏°‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)
  function calcGrade({score=0, comboMax=0, misses=0, goodHits=0, durationSec=60}){
    score = score|0; comboMax=comboMax|0; misses=misses|0; goodHits=goodHits|0; durationSec = Math.max(20, durationSec|0);

    // normalize by time
    const scorePerSec = score / durationSec;

    // thresholds tuned for‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô‡∏™‡πå: easy ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Å‡∏£‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å diffBias)
    let grade='C';

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏© "‡πÑ‡∏£‡πâ‡∏û‡∏•‡∏≤‡∏î" + ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÇ‡∏´‡∏î + ‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏á
    if (misses===0 && comboMax>=22 && scorePerSec>=26) grade='SSS';
    else if (misses<=1 && comboMax>=18 && scorePerSec>=22) grade='SS';
    else if (misses<=2 && comboMax>=14 && scorePerSec>=18) grade='S';
    else if (misses<=4 && comboMax>=10 && scorePerSec>=14) grade='A';
    else if (misses<=7 && comboMax>=6  && scorePerSec>=10) grade='B';
    else grade='C';

    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ hit ‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏ï‡πà score ‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏î‡πá‡∏Å)
    if (grade==='C' && goodHits>=18 && misses<=6) grade='B';

    const star = starsFor(grade);
    return { grade, stars: star };
  }

  function gradeText(grade){
    grade = String(grade||'C').toUpperCase();
    if (grade==='SSS') return 'üèÜ HERO ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô! ‡πÇ‡∏´‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏Å!';
    if (grade==='SS')  return 'üåü ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';
    if (grade==='S')   return '‚≠ê ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô SS!';
    if (grade==='A')   return 'üëç ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏•‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÑ‡∏î‡πâ S!';
    if (grade==='B')   return 'üôÇ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß! ‡∏ã‡πâ‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°!';
    return 'üí™ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£! ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!';
  }
  function coachLineFor(grade){
    grade = String(grade||'C').toUpperCase();
    if (grade==='SSS') return '‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏∑‡∏≠ HERO ‡∏Ç‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ß! ü•¶üî•';
    if (grade==='SS')  return '‡∏ß‡πâ‡∏≤‡∏ß! ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÅ‡∏ï‡∏∞‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏≠‡∏≠! ‚ú®';
    if (grade==='S')   return '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏ô‡∏∞!';
    if (grade==='A')   return '‡∏î‡∏µ‡πÄ‡∏•‡∏¢! ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞';
    if (grade==='B')   return '‡πÑ‡∏°‡πà‡πÅ‡∏¢‡πà! ‡∏•‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö!';
    return '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£! ‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô üí™';
  }

  function setGradeUI(grade){
    if (!uiGrade) return;
    const g = String(grade||'C').toUpperCase();
    uiGrade.textContent = g;

    uiGrade.classList.remove('sss','ss','s');
    if (g==='SSS') uiGrade.classList.add('sss');
    if (g==='SS')  uiGrade.classList.add('ss');
    if (g==='S')   uiGrade.classList.add('s');

    uiGrade.classList.remove('pop');
    void uiGrade.offsetWidth;
    uiGrade.classList.add('pop');
  }

  // ===== Selector persist + URL override =====
  (function initSelectors(){
    const U = new URL(location.href);
    const sDiff = $('selDiff');
    const sCh = $('selCh');

    const urlDiff = (U.searchParams.get('diff')||'').toLowerCase();
    const urlCh   = (U.searchParams.get('challenge')||'').toLowerCase();

    const savedDiff = localStorage.getItem('gj_diff') || '';
    const savedCh   = localStorage.getItem('gj_ch') || '';

    const setIfValid = (sel, v)=>{
      if (!v) return false;
      const ok = Array.from(sel.options).some(o => o.value === v);
      if (ok){ sel.value = v; return true; }
      return false;
    };

    if (!setIfValid(sDiff, urlDiff)) setIfValid(sDiff, savedDiff);
    if (!setIfValid(sCh, urlCh))     setIfValid(sCh, savedCh);

    sDiff.addEventListener('change', ()=> localStorage.setItem('gj_diff', sDiff.value));
    sCh.addEventListener('change',   ()=> localStorage.setItem('gj_ch', sCh.value));
  })();

  // ===== Module loading =====
  let modSafe=null, modTouch=null;
  let engine=null;
  let touchCtl=null;

  async function importFirst(paths){
    let last=null;
    for (const p of paths){
      try{ return await import(p); }
      catch(e){ last=e; }
    }
    throw last || new Error('import failed');
  }

  async function ensureModules(){
    if (modSafe && modTouch) return { modSafe, modTouch };

    hidePanic();
    setBadgeTemp(false, 'boot: loading modules‚Ä¶', 1200);

    const watchdog = setTimeout(()=>{
      showPanic('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ô‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏≠‡∏≤‡∏à cache/404 (‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° ?ts=1 ‡∏´‡∏£‡∏∑‡∏≠ Clear storage)');
      setBadgeTemp(false, 'boot: stuck (cache/404?)', 1600);
    }, 6000);

    try{
      const safePaths  = ['./vr-goodjunk/goodjunk.safe.js', './goodjunk.safe.js'];
      const touchPaths = ['./vr-goodjunk/touch-look-goodjunk.js', './touch-look-goodjunk.js'];

      modSafe  = await importFirst(safePaths);
      modTouch = await importFirst(touchPaths);

      clearTimeout(watchdog);
      setBadgeTemp(true, 'boot: modules ready', 900);

      try{ touchCtl?.destroy?.(); }catch(_){}
      touchCtl = modTouch.attachTouchLook(elCamEntity, { areaEl: elLookArea, sensitivity: 0.26 });

      startParallaxLoop();
      return { modSafe, modTouch };
    }catch(err){
      clearTimeout(watchdog);
      showPanic('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ path/‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô repo)', err);
      setBadgeTemp(false, 'boot: import failed', 1600);
      throw err;
    }
  }

  // ===== VR-like parallax =====
  let rafPar=0;
  function startParallaxLoop(){
    cancelAnimationFrame(rafPar);
    const pxPerRadX = ()=> innerWidth * 0.38;
    const pxPerRadY = ()=> innerHeight * 0.22;

    function tick(){
      try{
        const r = elCamEntity?.object3D?.rotation;
        if (r){
          const ox = -r.y * pxPerRadX();
          const oy = -r.x * pxPerRadY();
          elLayer.style.transform = `translate3d(${ox.toFixed(1)}px, ${oy.toFixed(1)}px, 0)`;
          window.__GJ_LAYER_OFFSET__ = { x: ox, y: oy };
        }
        window.__GJ_AIM_POINT__ = { x: (innerWidth*0.5)|0, y: (innerHeight*0.62)|0 };
      }catch(_){}
      rafPar = requestAnimationFrame(tick);
    }
    rafPar = requestAnimationFrame(tick);
  }

  // ===== FX bridge =====
  function kick(){
    document.body.classList.remove('shake');
    void document.body.offsetWidth;
    document.body.classList.add('shake');
  }
  window.addEventListener('hha:fx', (e)=>{
    const d = e.detail||{};
    if (d.type === 'kick') kick();
    if (d.type === 'chroma'){
      edge.classList.add('panic');
      setTimeout(()=> edge.classList.remove('panic'), Math.max(90, d.ms||150));
    }
    if (d.type === 'hero'){
      edge.classList.add('final');
      setTimeout(()=> edge.classList.remove('final'), Math.max(120, d.ms||220));
    }
  });

  window.addEventListener('hha:tick', (e)=>{
    const d = e.detail||{};
    const k = String(d.kind||'tick');
    const intensity = Number(d.intensity||1);
    if (k.includes('laser')) beep(980 + intensity*80, 26);
    else if (k.includes('ring'))  beep(860 + intensity*60, 30);
    else if (k.includes('final')) beep(1200, 24);
    else beep(820, 28);
    if (intensity >= 1.6) kick();
  });

  window.addEventListener('hha:panic', (e)=>{
    const d = e.detail||{};
    const lv = Number(d.level||0);
    if (lv > 0.05) edge.classList.add('panic');
    else edge.classList.remove('panic');
  });

  window.addEventListener('hha:finalPulse', ()=>{
    edge.classList.add('final');
    setTimeout(()=> edge.classList.remove('final'), 260);
  });

  window.addEventListener('hha:bossAtk', (e)=>{
    const d = e.detail||{};
    setBadgeTemp(true, `boss atk: ${d.name||'?'}`, 900);
  });

  window.addEventListener('hha:storm', (e)=>{
    const d = e.detail||{};
    if (d.active){
      setBadgeTemp(true, `STORM x${(d.mul||1).toFixed(2)}`, 1000);
      edge.classList.add('panic');
    } else {
      setBadgeTemp(true, 'running‚Ä¶', 400);
      edge.classList.remove('panic');
    }
  });

  // ===== Quest UI =====
  window.addEventListener('quest:update', (e)=>{
    const d = e.detail || {};

    // NEW SHAPE: { goal, mini, meta }
    if (d.goal || d.mini || d.meta){
      const g = d.goal || null;
      const m = d.mini || null;
      const meta = d.meta || {};

      if (g){
        qTitle.textContent = `${g.title || '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å'} ‚Äî ${g.cur ?? 0}/${g.max ?? 0}`;
        const pct = Math.max(0, Math.min(100, (Number(g.pct||0) * 100)));
        qBar.style.width = pct.toFixed(0) + '%';
      } else {
        qTitle.textContent = '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
        qBar.style.width = '100%';
      }

      if (m){
        const miniLine = `${m.title || 'Mini'} ‚Äî ${m.cur ?? 0}/${m.max ?? 0}`;
        qSubLeft.textContent = `Mini: ${miniLine}`;
        miniText.textContent = `Mini: ${miniLine}`;
      } else {
        qSubLeft.textContent = 'Mini: ‚Äî';
        miniText.textContent = 'Mini: ‚Äî';
      }

      // director compat: meta.minisCleared / meta.miniCount
      const mc = meta.minisCleared ?? 0;
      const mcount = meta.miniCount ?? 0;

      qSubRight.textContent = `minis ${mc} ‚Ä¢ run ${mcount}`;
      miniCount.textContent = `mini ‡∏ú‡πà‡∏≤‡∏ô ${mc} ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ${mcount}`;
      return;
    }

    // OLD fallback
    qTitle.textContent = d.title || '‚Äî';
    const pct = Math.max(0, Math.min(100, Number(d.progressPct||0)));
    qBar.style.width = pct.toFixed(0)+'%';
    if (d.miniText) miniText.textContent = d.miniText;
    if (typeof d.miniCleared === 'number' || typeof d.miniLeft === 'number'){
      miniCount.textContent = `mini ‡∏ú‡πà‡∏≤‡∏ô ${d.miniCleared||0} ‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ${d.miniLeft||0}`;
    }
  });

  window.addEventListener('quest:goalClear', (e)=>{
    const d = e.detail||{};
    setBadgeTemp(true, `GOAL CLEAR!`, 900);
    floatingPop(`‚úÖ GOAL CLEAR ‚Äî ${d.title||''}`, 'good', 1100);
  });

  window.addEventListener('quest:miniClear', (e)=>{
    const d = e.detail||{};
    setBadgeTemp(true, `MINI CLEAR!`, 850);
    floatingPop(`‚ö° MINI CLEAR ‚Äî ${d.title||''}`, 'gold', 950);
  });

  window.addEventListener('quest:badHit', (e)=>{
    const d = e.detail||{};
    setBadgeTemp(false, `HIT: ${d.kind||'bad'}`, 700);
    floatingPop(`üí• ‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß! (${d.kind||'hazard'})`, 'bad', 850);
  });

  window.addEventListener('quest:block', ()=>{
    setBadgeTemp(true, 'BLOCK!', 700);
    floatingPop('üõ°Ô∏è BLOCK!', 'good', 650);
  });

  window.addEventListener('quest:bossClear', ()=>{
    setBadgeTemp(true, 'BOSS CLEARED!', 1200);
    floatingPop('üëë BOSS CLEARED!', 'gold', 1400);
  });

  // ===== Runtime state for grade =====
  const RT = {
    diff:'normal',
    challenge:'rush',
    durationSec:60,
    score:0, comboMax:0, misses:0, goodHits:0,
    fever:0, stunActive:false,
    gradeNow:'C'
  };

  // ===== HUD updates =====
  window.addEventListener('hha:score', (e)=>{
    const d = e.detail||{};
    RT.score = (d.score ?? RT.score) | 0;
    RT.comboMax = (d.comboMax ?? RT.comboMax) | 0;
    RT.misses = (d.misses ?? RT.misses) | 0;
    RT.goodHits = (d.goodHits ?? RT.goodHits) | 0;
    RT.stunActive = !!d.stunActive;

    uiScore.textContent = String(RT.score);
    uiComboMax.textContent = String(RT.comboMax);
    uiMiss.textContent = String(RT.misses);

    // realtime grade
    const g = calcGrade({score:RT.score, comboMax:RT.comboMax, misses:RT.misses, goodHits:RT.goodHits, durationSec:RT.durationSec});
    if (g.grade !== RT.gradeNow){
      RT.gradeNow = g.grade;
      setGradeUI(g.grade);
      // voice on upgrade
      playGradeSound(g.grade);
      if (g.grade==='SSS') confettiBurst(22);
      else if (g.grade==='SS') confettiBurst(16);
      else if (g.grade==='S') sparkle('‚ú® S! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!');
    } else {
      setGradeUI(RT.gradeNow);
    }

    // coach realtime (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà stun)
    if (!RT.stunActive){
      const mood = moodByGrade(RT.gradeNow);
      setCoach(mood, coachLineFor(RT.gradeNow));
    }
  });

  window.addEventListener('hha:time', (e)=>{
    const d = e.detail||{};
    uiTime.textContent = String(d.sec ?? '--');
  });

  window.addEventListener('hha:fever', (e)=>{
    const d = e.detail||{};
    RT.fever = Math.round(d.fever ?? RT.fever);
    RT.stunActive = !!d.stunActive;

    uiFever.textContent = String(RT.fever);
    uiShield.textContent = String(d.shield ?? 0);

    // ‚úÖ ‡∏ñ‡πâ‡∏≤ stunActive ‚Üí coach fever
    if (RT.stunActive){
      setCoach('fever', '‡πÇ‡∏≠‡πä‡∏¢! ‡∏°‡∏∂‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ‡πÄ‡∏£‡πá‡∏ß! üòµ‚Äçüí´');
    }
  });

  // ===== Logger helpers (sessions/events/student-profile) =====
  function uuid(){
    try{
      return (crypto?.randomUUID && crypto.randomUUID()) || ('gj-'+Math.random().toString(16).slice(2)+Date.now().toString(16));
    }catch(_){
      return 'gj-'+Math.random().toString(16).slice(2)+Date.now().toString(16);
    }
  }
  const sessionId = uuid();

  function logEvent(name, extra={}){
    window.dispatchEvent(new CustomEvent('hha:log_event', {
      detail: Object.assign({
        sessionId,
        game:'GoodJunkVR',
        name,
        ts: Date.now()
      }, extra || {})
    }));
  }
  function logSessionFinal(payload){
    window.dispatchEvent(new CustomEvent('hha:log_session', {
      detail: Object.assign({
        sessionId,
        game:'GoodJunkVR',
        ts: Date.now()
      }, payload || {})
    }));
  }

  // ===== Start/End =====
  function getSelected(){
    const diff = $('selDiff').value;
    const ch = $('selCh').value;
    return { diff, challenge: ch };
  }

  function calcSafeMargins(){
    const questRect = $('hud-quest').getBoundingClientRect();
    const top = Math.ceil(questRect.bottom + 14);

    const footerRect = $('footer').getBoundingClientRect();
    const bottom = Math.ceil((innerHeight - footerRect.top) + 10);

    const left = 14;
    const right = 14;
    return { top, bottom, left, right };
  }

  let lastStart = null;

  async function startGame(runMode='play'){
    btn2D.disabled = true; btnVR.disabled = true;
    try{
      ensureAudio();
      await ensureModules();

      const { diff, challenge } = getSelected();
      RT.diff = diff; RT.challenge = challenge;

      uiDiffChallenge.textContent = `Diff: ${diff.toUpperCase()} ‚Ä¢ Challenge: ${challenge.toUpperCase()}`;
      $('runName').textContent = runMode.toUpperCase();

      // reset runtime
      RT.durationSec = 60;
      RT.score=0; RT.comboMax=0; RT.misses=0; RT.goodHits=0; RT.gradeNow='C';
      setGradeUI('C');
      setCoach('neutral', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ô‡∏∞ ü•¶');

      try{ engine?.stop?.(); }catch(_){}
      engine = null;

      elEnd.style.display = 'none';
      elStart.style.display = 'none';

      setBadgeTemp(true, 'starting‚Ä¶', 900);

      lastStart = { diff, challenge, runMode, time: 60 };

      // log start as event (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏∂‡πà‡∏á Apps Script ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß)
      logEvent('start', { diff, challenge, runMode, durationSec: 60 });

      engine = modSafe.boot({
        diff,
        challenge,
        run: runMode,
        time: 60,
        layerEl: elLayer,
        safeMargins: calcSafeMargins()
      });

      setBadgeTemp(true, 'running‚Ä¶', 500);
    }catch(err){
      showPanic('Start ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err);
      setBadgeTemp(false, 'start failed', 1400);
      elStart.style.display = 'flex';
    }finally{
      btn2D.disabled = false; btnVR.disabled = false;
    }
  }

  btn2D.addEventListener('click', ()=> startGame('play'));
  btnVR.addEventListener('click', ()=> startGame('play'));

  btnEnterVR.addEventListener('click', async ()=>{
    try{
      ensureAudio();
      const scene = document.querySelector('a-scene');
      if (scene?.enterVR) scene.enterVR();
    }catch(e){
      showPanic('Enter VR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e);
    }
  });

  btnReplay.addEventListener('click', ()=>{
    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ start modal ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    elEnd.style.display = 'none';
    elStart.style.display = 'flex';
    setBadgeTemp(true, 'replay ready', 700);
  });

  btnHub.addEventListener('click', ()=>{
    try{ location.href = './hub.html'; }catch(_){}
  });

  // ===== End summary (‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î: ‡πÄ‡∏Å‡∏£‡∏î+‡∏î‡∏≤‡∏ß+‡πÄ‡∏™‡∏µ‡∏¢‡∏á+confetti+‡πÇ‡∏Ñ‡πâ‡∏ä + log) =====
  function showEnd(d){
    // d ‡∏à‡∏≤‡∏Å safe.js: {score, goodHits, misses, comboMax, durationSec, diff, challenge, runMode}
    const score = (d.score ?? RT.score) | 0;
    const comboMax = (d.comboMax ?? RT.comboMax) | 0;
    const misses = (d.misses ?? RT.misses) | 0;
    const goodHits = (d.goodHits ?? RT.goodHits) | 0;
    const durationSec = Math.max(20, (d.durationSec ?? RT.durationSec) | 0);

    const out = calcGrade({ score, comboMax, misses, goodHits, durationSec });
    const grade = out.grade;
    const stars = out.stars;

    // UI
    endScore.textContent = String(score);
    endComboMax.textContent = String(comboMax);
    endGoodHits.textContent = String(goodHits);
    endMiss.textContent = String(misses);

    gradeBigBadge.textContent = grade;
    gradeBigStars.textContent = '‚òÖ'.repeat(Math.max(1, stars || 0)) + (stars ? '' : '‚òÖ');
    gradeBigText.textContent = gradeText(grade);

    const coachLine = coachLineFor(grade);
    setEndCoach(moodByGrade(grade), coachLine);

    endSub.textContent = `Diff: ${(d.diff||RT.diff||'normal').toUpperCase()} ‚Ä¢ Challenge: ${(d.challenge||RT.challenge||'rush').toUpperCase()}`;

    // FX + sound
    playGradeSound(grade);

    if (grade === 'SSS'){
      confettiBurst(70);
      floatingPop('üèÜ SSS!! ‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏∑‡∏≠ HERO OF HEALTH!!!', 'gold', 1500);
      kick();
    } else if (grade === 'SS'){
      confettiBurst(55);
      floatingPop('üåü SS!! ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏Å!', 'gold', 1300);
    } else if (grade === 'S'){
      sparkle('‚ú® S! ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô SS ‡πÅ‡∏•‡πâ‡∏ß!');
      floatingPop('‚≠ê S!! ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÇ‡∏´‡∏î‡∏°‡∏≤‡∏Å!', 'good', 1200);
    } else if (grade === 'A'){
      sparkle('üëç A! ‡∏•‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÑ‡∏î‡πâ S ‡πÅ‡∏ô‡πà!');
    } else if (grade === 'B'){
      sparkle('üôÇ B! ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô!');
    } else {
      sparkle('üí™ C! ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!');
    }

    // ‚úÖ log (sessions + events)
    logEvent('end', {
      diff: d.diff || RT.diff,
      challenge: d.challenge || RT.challenge,
      runMode: d.runMode || 'play',
      durationSec,
      score, comboMax, goodHits, misses,
      grade, stars
    });

    logSessionFinal({
      diff: d.diff || RT.diff,
      challenge: d.challenge || RT.challenge,
      runMode: d.runMode || 'play',
      durationSec,
      score, comboMax, goodHits, misses,
      grade, stars,
      coachLine
    });

    elEnd.style.display = 'flex';
    setBadgeTemp(true, 'ended', 900);
  }

  window.addEventListener('hha:end', (e)=>{
    try{
      // stop touch/look? keep okay
      showEnd(e.detail || {});
    }catch(err){
      showPanic('‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô (end handler error)', err);
      setBadgeTemp(false, 'end error', 1400);
    }
  });

  // ===== Init =====
  setBadge(true, 'boot: idle');
  setGradeUI('C');
  setCoach('neutral', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ô‡∏∞ ü•¶');
</script>

</body>
</html>