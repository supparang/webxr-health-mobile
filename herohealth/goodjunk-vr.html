<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR ‚Äî FULL HTML (PRODUCTION) ‚Äî PATCH C COMPAT + HARD FX PACK
‚úÖ Script order: particles ‚Üí logger ‚Üí fever ‚Üí hud ‚Üí module boot
‚úÖ DOM targets layer (#gj-layer) + VR-feel playfield (drag + gyro)
‚úÖ Ring/Laser overlays (#atk-ring/#atk-laser) with CSS vars
‚úÖ Start overlay + Motion permission button
‚úÖ Fallback end summary (listen hha:end)
‚úÖ NEW: Hub Context Bridge (read profile/context from hub via storage/query)
‚úÖ NEW: HARD FX PACK (shake/stun/vignette/warnline/shockwave/chroma + SFX)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame core (for VR button + sky feel) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + (optional) logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Global UI -->
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --ringGapStart: 0deg;
      --ringGapSize: 80deg;

      --safeTop: 128px;
      --safeBottom: 170px;
      --safeSide: 26px;

      /* HARD FX PACK vars */
      --shakeAmp: 0;      /* px */
      --chromaAmt: 0;     /* 0..1 */
      --panic: 0;         /* 0..1 */
    }

    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(900px 600px at 10% 80%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
      touch-action: none;
    }

    /* --- A-Frame behind --- */
    .vr-backdrop{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.95;
    }
    a-scene{ height:100%; width:100%; }

    /* --- HUD overlay wrapper --- */
    .hud{
      position:fixed; inset:0;
      z-index: 30;
      pointer-events:none;
    }

    /* topbar */
    .topbar{
      position:fixed;
      left:12px; right:12px; top:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      pointer-events:none;
      z-index: 40;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
    }
    .card.pad{ padding: 10px 12px; }

    .statrow{
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      letter-spacing:.2px;
    }
    .stat{
      display:flex; align-items:center; gap:6px;
      font-size: 13px;
      color: var(--text);
      opacity:.96;
      white-space:nowrap;
    }
    .stat span{ color: var(--muted); font-weight:800; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      font-weight: 950;
      font-size: 12px;
      opacity:.96;
    }
    .pill b{ font-size: 13px; }

    /* quest panel */
    .quest{
      position:fixed;
      left:12px;
      bottom:12px;
      width:min(460px, calc(100vw - 24px));
      pointer-events:none;
      z-index: 40;
    }
    .qwrap{ padding: 12px 12px; }
    .qtitle{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .qtitle small{
      color: var(--muted);
      font-weight: 850;
      font-size: 11px;
      opacity:.92;
    }
    .qline{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0; }
    .qname{ font-weight: 950; font-size: 12px; color: var(--text); opacity:.95; }
    .qcount{ font-weight: 950; font-size: 12px; color: var(--muted); }
    .bar{
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      margin-top: 6px;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,.92), rgba(245,158,11,.92));
      transition: width .12s linear;
    }

    /* coach */
    .coach{
      position:fixed;
      right:12px;
      bottom:12px;
      width: min(380px, calc(100vw - 24px));
      pointer-events:none;
      z-index: 40;
    }
    .coachwrap{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding: 10px 12px;
    }
    .coachimg{
      width: 70px; height: 70px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .coachtext{
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      opacity:.95;
      line-height: 1.25;
    }
    .coachtext .m{ color: var(--muted); font-weight: 850; display:block; margin-top: 2px; }

    /* crosshair */
    .crosshair{
      position:fixed;
      left:50%;
      top:62%;
      transform: translate(-50%,-50%);
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.78);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
      z-index: 35;
      pointer-events:none;
    }
    .crosshair:after{
      content:'';
      position:absolute;
      left:50%; top:50%;
      width: 3px; height: 3px;
      border-radius: 99px;
      background: rgba(255,255,255,.9);
      transform: translate(-50%,-50%);
    }

    /* shoot button (mobile) */
    .shoot{
      position:fixed;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 36;
      pointer-events:auto;
    }
    .shoot button{
      width: 68px; height: 68px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(2,6,23,.65);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-weight: 950;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .shoot button:active{ transform: scale(.98); }

    /* playfield layer for DOM targets */
    #gj-layer{
      position:fixed;
      inset:0;
      z-index: 20;
      pointer-events:auto;
      touch-action:none;
      transform: translate3d(0px,0px,0);
      will-change: transform;
    }
    .gj-target{
      position:absolute;
      transform: translate(-50%,-50%) scale(1);
      font-size: 48px;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.50));
      user-select:none;
      -webkit-user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      animation: floaty 1.05s ease-in-out infinite alternate;
    }
    .gj-target.spawn{ animation: pop .14s ease-out, floaty 1.05s ease-in-out infinite alternate; }
    .gj-target.gone{ opacity: 0; transform: translate(-50%,-50%) scale(.75); transition: opacity .14s ease, transform .14s ease; }

    .gj-junk{ filter: drop-shadow(0 14px 28px rgba(239,68,68,.18)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-fake{ filter: drop-shadow(0 14px 28px rgba(245,158,11,.14)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-gold{ filter: drop-shadow(0 18px 36px rgba(245,158,11,.24)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-power{ filter: drop-shadow(0 18px 36px rgba(34,197,94,.18)) drop-shadow(0 12px 22px rgba(0,0,0,.52)); }
    .gj-boss{ font-size: 64px; filter: drop-shadow(0 22px 44px rgba(255,255,255,.10)) drop-shadow(0 14px 28px rgba(0,0,0,.58)); }

    @keyframes pop{
      0%{ transform: translate(-50%,-50%) scale(.65); opacity: .2; }
      100%{ transform: translate(-50%,-50%) scale(1.0); opacity: 1; }
    }
    @keyframes floaty{
      0%{ transform: translate(-50%,-50%) scale(1.0) translateY(0px); }
      100%{ transform: translate(-50%,-50%) scale(1.0) translateY(-6px); }
    }

    /* Ring hazard overlay */
    #atk-ring{
      position:fixed;
      left:50%;
      top:50%;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      z-index: 33;
      pointer-events:none;
      opacity: 0;
      transition: opacity .12s ease;
      background:
        radial-gradient(circle at 50% 50%,
          transparent 58%,
          rgba(239,68,68,.0) 58%,
          rgba(239,68,68,.0) 62%,
          transparent 62%
        ),
        conic-gradient(
          from var(--ringGapStart),
          rgba(239,68,68,.90) 0deg,
          rgba(239,68,68,.90) calc(360deg - var(--ringGapSize)),
          rgba(239,68,68,.0) 0deg
        );
      filter: drop-shadow(0 18px 50px rgba(239,68,68,.14));
      mix-blend-mode: screen;
    }
    #atk-ring.show{ opacity: .95; }

    /* Laser overlay */
    #atk-laser{
      position:fixed;
      left:0;
      width:100%;
      height: 18px;
      top: 50%;
      z-index: 33;
      pointer-events:none;
      opacity: 0;
      transition: opacity .10s ease;
      background: linear-gradient(90deg, rgba(239,68,68,0), rgba(239,68,68,.9), rgba(239,68,68,0));
      filter: drop-shadow(0 18px 50px rgba(239,68,68,.20));
    }
    #atk-laser.warn{ opacity: .55; }
    #atk-laser.fire{ opacity: 1; height: 22px; }

    /* Start overlay */
    .overlay{
      position:fixed;
      inset:0;
      z-index: 60;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: radial-gradient(900px 500px at 50% 0%, rgba(34,197,94,.16), transparent 60%),
                  rgba(2,6,23,.76);
      backdrop-filter: blur(10px);
    }
    .panel{
      width: min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.78);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 16px 16px;
    }
    .h1{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 18px;
      margin: 0 0 6px;
    }
    .sub{
      margin: 0 0 12px;
      color: var(--muted);
      font-weight: 850;
      line-height: 1.35;
      font-size: 12px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .btn{
      pointer-events:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(15,23,42,.72);
      color: var(--text);
      font-weight: 950;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.92), rgba(34,197,94,.68));
      border-color: rgba(34,197,94,.26);
      color:#03120a;
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(245,158,11,.92), rgba(245,158,11,.62));
      border-color: rgba(245,158,11,.26);
      color:#1a1002;
    }
    .btn:active{ transform: scale(.99); }

    /* End summary overlay (fallback + HUD) */
    #hhaEnd{
      position:fixed;
      inset:0;
      z-index: 80;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(2,6,23,.78);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    #hhaEnd .panel{ width:min(560px, 100%); }
    .endrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .kpi{
      flex: 1 1 160px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
    }
    .kpi .k{ color: var(--muted); font-weight: 900; font-size: 11px; }
    .kpi .v{ font-weight: 1000; font-size: 18px; margin-top: 2px; }
    .endbtns{ display:flex; gap:10px; margin-top: 12px; }
    .endbtns .btn{ width:100%; }

    /* debug pill */
    .debug{
      position:fixed;
      left: 12px;
      top: calc(10px + 64px);
      z-index: 55;
      pointer-events:none;
      opacity:.65;
      font-size: 11px;
    }

    /* ===========================
       HARD FX PACK (VISUAL)
       =========================== */

    @media (prefers-reduced-motion: reduce){
      :root{ --shakeAmp: 0; }
      html.fx-kick, html.is-stun{ animation: none !important; }
      #hha-shockwave .sw{ animation: none !important; }
    }

    /* vignette (damage/stun) */
    #hha-vignette{
      position:fixed; inset:-2px;
      z-index: 34;
      pointer-events:none;
      opacity:0;
      transition: opacity .08s linear;
      background:
        radial-gradient(1200px 800px at 50% 55%,
          rgba(0,0,0,0) 40%,
          rgba(239,68,68,.22) 70%,
          rgba(0,0,0,.65) 100%);
      mix-blend-mode: screen;
    }

    /* warnline (urgent) */
    #hha-warnline{
      position:fixed;
      left:0; right:0;
      top: calc(var(--safeTop) - 8px);
      height: 4px;
      z-index: 41;
      pointer-events:none;
      opacity:0;
      background: linear-gradient(90deg, rgba(245,158,11,0), rgba(245,158,11,.98), rgba(245,158,11,0));
      filter: drop-shadow(0 14px 28px rgba(245,158,11,.20));
    }

    /* hit flash (red) */
    #hha-hitflash{
      position:fixed; inset:0;
      z-index: 32;
      pointer-events:none;
      opacity:0;
      background: radial-gradient(900px 520px at 50% 60%, rgba(239,68,68,.26), rgba(239,68,68,0) 62%);
      mix-blend-mode: screen;
    }

    /* hero flash (green) */
    #hha-heroFlash{
      position:fixed; inset:0;
      z-index: 32;
      pointer-events:none;
      opacity:0;
      background: radial-gradient(900px 520px at 50% 60%, rgba(34,197,94,.20), rgba(34,197,94,0) 62%);
      mix-blend-mode: screen;
    }

    /* shockwave */
    #hha-shockwave{
      position:fixed; inset:0;
      z-index: 33;
      pointer-events:none;
      opacity:0;
    }
    #hha-shockwave .sw{
      position:absolute;
      left:50%; top:60%;
      width: 40px; height: 40px;
      transform: translate(-50%,-50%) scale(0.3);
      border-radius: 999px;
      box-shadow:
        0 0 0 2px rgba(255,255,255,.10),
        0 0 0 10px rgba(245,158,11,.10),
        0 0 60px rgba(245,158,11,.10);
      background: radial-gradient(circle, rgba(255,255,255,.0) 58%, rgba(245,158,11,.18) 60%, rgba(245,158,11,0) 72%);
      opacity: 0;
    }

    /* boss pulse marker */
    #hha-bossPulse{
      position:fixed;
      left:50%; top:50%;
      width: 90px; height: 90px;
      transform: translate(-50%,-50%);
      z-index: 39;
      pointer-events:none;
      opacity:0;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.75);
      box-shadow:
        0 0 0 6px rgba(34,197,94,.15),
        0 0 40px rgba(34,197,94,.18);
      mix-blend-mode: screen;
    }

    /* toast */
    #hha-toast{
      position:fixed;
      left:50%;
      top: calc(var(--safeTop) + 44px);
      transform: translateX(-50%);
      z-index: 70;
      pointer-events:none;
      opacity:0;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(2,6,23,.70);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      font-weight: 1000;
      letter-spacing:.2px;
    }

    /* GLOBAL SHAKE + CHROMA */
    html.fx-kick body{
      animation: hhaShake .11s linear infinite;
    }
    @keyframes hhaShake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(calc(var(--shakeAmp)*1px), calc(var(--shakeAmp)*-0.7px), 0); }
      40%{ transform: translate3d(calc(var(--shakeAmp)*-0.9px), calc(var(--shakeAmp)*0.9px), 0); }
      60%{ transform: translate3d(calc(var(--shakeAmp)*0.7px), calc(var(--shakeAmp)*1.0px), 0); }
      80%{ transform: translate3d(calc(var(--shakeAmp)*-0.6px), calc(var(--shakeAmp)*-0.8px), 0); }
      100%{ transform: translate3d(0,0,0); }
    }

    html.fx-chroma #gj-layer,
    html.fx-chroma .vr-backdrop{
      filter:
        saturate(calc(1 + var(--chromaAmt)*1.25))
        contrast(calc(1 + var(--chromaAmt)*0.55))
        hue-rotate(calc(var(--chromaAmt)*18deg));
    }

    /* stun state */
    html.is-stun #hha-vignette{ opacity: 1; animation: hhaVFlash .12s infinite alternate; }
    html.is-stun #hha-warnline{ opacity: 1; animation: hhaWarn .10s infinite alternate; }
    html.is-stun body{ animation: hhaShake .10s linear infinite; }
    html.is-stun{ --shakeAmp: 2.4; }

    @keyframes hhaVFlash{ from{ opacity:.30 } to{ opacity:1 } }
    @keyframes hhaWarn{ from{ opacity:.12 } to{ opacity:1 } }

    /* ring/laser warning boost */
    #atk-ring.show{ animation: ringPulse .12s infinite alternate; }
    @keyframes ringPulse{ from{ transform: translate(-50%,-50%) scale(1.00); } to{ transform: translate(-50%,-50%) scale(1.02); } }

    #atk-laser.warn{ animation: laserWarn .10s infinite alternate; }
    #atk-laser.fire{ animation: laserFire .06s infinite alternate; }
    @keyframes laserWarn{ from{ opacity:.35 } to{ opacity:.85 } }
    @keyframes laserFire{ from{ opacity:.75 } to{ opacity:1 } }
  </style>
</head>

<body>

  <!-- A-Frame background -->
  <div class="vr-backdrop">
    <a-scene embedded renderer="colorManagement: true; antialias: true" vr-mode-ui="enabled: true">
      <a-sky color="#050b1a"></a-sky>
      <a-entity position="0 1.6 0">
        <a-camera wasd-controls-enabled="false" look-controls="enabled: true"></a-camera>
      </a-entity>
    </a-scene>
  </div>

  <!-- DOM playfield -->
  <div id="gj-layer" aria-label="GoodJunk playfield"></div>

  <!-- Boss hazards -->
  <div id="atk-ring" aria-hidden="true"></div>
  <div id="atk-laser" aria-hidden="true"></div>

  <!-- Crosshair -->
  <div id="gj-crosshair" class="crosshair" aria-hidden="true"></div>

  <!-- Shoot button (mobile assist) -->
  <div class="shoot">
    <button id="btnShoot" type="button">üéØ<span style="font-weight:1000">‡∏¢‡∏¥‡∏á</span></button>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="topbar">
      <div class="card pad" style="flex:1">
        <div class="statrow">
          <div class="stat">üèÅ <span>Score</span> <b id="hhaScore">0</b></div>
          <div class="stat">üî• <span>Combo</span> <b id="hhaCombo">0</b></div>
          <div class="stat">üíî <span>Miss</span> <b id="hhaMiss">0</b></div>
          <div class="stat">‚è±Ô∏è <span>Time</span> <b id="hhaTime">0</b>s</div>
        </div>
      </div>

      <div class="pill">
        üèÖ Grade <b id="hhaGrade">‚Äî</b>
      </div>
    </div>

    <div class="quest card">
      <div class="qwrap">
        <div class="qtitle">
          <div>üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
          <small id="hhaQuestMeta">‚Äî</small>
        </div>

        <div class="qline">
          <div class="qname" id="qGoalTitle">Goal: ‚Äî</div>
          <div class="qcount"><span id="qGoalCur">0</span>/<span id="qGoalMax">0</span></div>
        </div>
        <div class="bar"><div class="fill" id="qGoalFill"></div></div>

        <div style="height:10px"></div>

        <div class="qline">
          <div class="qname" id="qMiniTitle">Mini: ‚Äî</div>
          <div class="qcount"><span id="qMiniCur">0</span>/<span id="qMiniMax">0</span></div>
        </div>
        <div class="bar"><div class="fill" id="qMiniFill"></div></div>

        <!-- optional mini timer -->
        <div style="margin-top:8px; color:var(--muted); font-weight:900; font-size:11px;">
          ‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span id="qMiniTLeft">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="coach card">
      <div class="coachwrap">
        <img id="hhaCoachImg" class="coachimg" src="./img/coach-neutral.png" alt="Coach" />
        <div class="coachtext">
          <span id="hhaCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ ü•¶üö´</span>
          <span class="m" id="hhaCoachSub">‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á / ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÇ‡∏•‡∏Å‚Äù ‡πÅ‡∏ö‡∏ö VR</span>
        </div>
      </div>
    </div>
  </div>

  <div class="debug pill">
    <span>DBG</span>
    <b id="dbgLine">‚Äî</b>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <div class="h1">ü•¶ GoodJunk VR</div>
      <p class="sub" id="startDesc">
        ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ô‡∏∏‡∏Å‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ / ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏¢‡∏∞ / ‡∏°‡∏µ FEVER + BOSS + ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô Ring/Laser ‚ö°
        <br/>‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö gyro ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
      </p>

      <div class="grid">
        <button class="btn primary" id="btnStart2D" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (2D)</button>
        <button class="btn warn" id="btnMotion" type="button">üì± ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion</button>
        <button class="btn" id="btnStartVR" type="button">üï∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤ VR ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
        <button class="btn" id="btnHow" type="button">‚ùì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-weight:850;font-size:11px;line-height:1.35">
        Query params: <b>?diff=easy|normal|hard&time=80&run=play|research&challenge=rush|boss|survival</b>
      </div>
    </div>
  </div>

  <!-- End summary (HUD may also use this) -->
  <div id="hhaEnd">
    <div class="panel">
      <div class="h1">üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <p class="sub">
        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡πÄ‡∏Å‡∏£‡∏î (SSS/SS/S/A/B/C)
      </p>

      <div class="endrow">
        <div class="kpi"><div class="k">GRADE</div><div class="v" id="endGrade">‚Äî</div></div>
        <div class="kpi"><div class="k">SCORE</div><div class="v" id="endScore">0</div></div>
        <div class="kpi"><div class="k">COMBO MAX</div><div class="v" id="endComboMax">0</div></div>
        <div class="kpi"><div class="k">MISS</div><div class="v" id="endMiss">0</div></div>
      </div>

      <div class="endrow">
        <div class="kpi"><div class="k">GOALS</div><div class="v"><span id="endGoals">0</span>/<span id="endGoalsTotal">0</span></div></div>
        <div class="kpi"><div class="k">MINIS</div><div class="v"><span id="endMinis">0</span>/<span id="endMinisTotal">0</span></div></div>
        <div class="kpi"><div class="k">ACCURACY</div><div class="v"><span id="endAcc">0</span>%</div></div>
      </div>

      <div class="endbtns">
        <button class="btn primary" id="btnReplay" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn" id="btnCloseEnd" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- === HARD FX PACK layers === -->
  <div id="hha-vignette" aria-hidden="true"></div>
  <div id="hha-warnline" aria-hidden="true"></div>
  <div id="hha-hitflash" aria-hidden="true"></div>
  <div id="hha-heroFlash" aria-hidden="true"></div>

  <div id="hha-shockwave" aria-hidden="true">
    <div class="sw"></div>
  </div>

  <div id="hha-bossPulse" aria-hidden="true"></div>
  <div id="hha-toast" aria-hidden="true"></div>

  <!-- Boot module -->
  <script type="module">
    import { boot as goodjunkBoot } from './vr-goodjunk/goodjunk.safe.js';

    const $ = (id)=> document.getElementById(id);

    function clamp(v,a,b){ v=Number(v)||0; return v<a?a:(v>b?b:v); }
    function qp(name, def=null){
      const u = new URL(location.href);
      const v = u.searchParams.get(name);
      return (v==null || v==='') ? def : v;
    }

    // --- Parse options ---
    const diff = String(qp('diff','normal')).toLowerCase();
    const run  = String(qp('run','play')).toLowerCase();
    const time = clamp(qp('time',80), 20, 180) | 0;
    const challenge = String(qp('challenge','rush')).toLowerCase();

    // --- UI refs ---
    const layer = $('gj-layer');
    const cross = $('gj-crosshair');
    const btnShoot = $('btnShoot');

    const startOverlay = $('startOverlay');
    const btnStart2D = $('btnStart2D');
    const btnStartVR = $('btnStartVR');
    const btnMotion = $('btnMotion');
    const btnHow = $('btnHow');

    const dbgLine = $('dbgLine');

    // --- Maintain layer offset + aim point for engine (PATCH C expects these globals) ---
    function updateOffsets(){
      const r = layer.getBoundingClientRect();
      window.__GJ_LAYER_OFFSET__ = { x: r.left, y: r.top };
      const c = cross.getBoundingClientRect();
      window.__GJ_AIM_POINT__ = { x: (c.left + c.width/2), y: (c.top + c.height/2) };
    }

    // --- VR-feel playfield: drag + gyro -> transform translate3d ---
    let dragOn=false, sx=0, sy=0;
    let baseX=0, baseY=0;
    let targetX=0, targetY=0;
    let gyroX=0, gyroY=0;
    let motionEnabled=false;

    const MAX_SHIFT = 120; // clamp safe
    function applyTransform(){
      // smooth follow
      baseX += (targetX - baseX) * 0.12;
      baseY += (targetY - baseY) * 0.12;

      const x = clamp(baseX + gyroX, -MAX_SHIFT, MAX_SHIFT);
      const y = clamp(baseY + gyroY, -MAX_SHIFT, MAX_SHIFT);
      layer.style.transform = `translate3d(${x.toFixed(1)}px, ${y.toFixed(1)}px, 0)`;
    }

    function onPointerDown(e){
      dragOn=true;
      sx = e.clientX; sy = e.clientY;
      layer.setPointerCapture?.(e.pointerId);
    }
    function onPointerMove(e){
      if(!dragOn) return;
      const dx = e.clientX - sx;
      const dy = e.clientY - sy;
      targetX = clamp(dx, -MAX_SHIFT, MAX_SHIFT);
      targetY = clamp(dy, -MAX_SHIFT, MAX_SHIFT);
    }
    function onPointerUp(e){
      dragOn=false;
      targetX *= 0.35;
      targetY *= 0.35;
    }

    layer.addEventListener('pointerdown', onPointerDown, { passive:true });
    layer.addEventListener('pointermove', onPointerMove, { passive:true });
    layer.addEventListener('pointerup', onPointerUp, { passive:true });
    layer.addEventListener('pointercancel', onPointerUp, { passive:true });

    async function enableMotion(){
      try{
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res !== 'granted') throw new Error('permission denied');
        }
        motionEnabled = true;

        window.addEventListener('deviceorientation', (ev)=>{
          if(!motionEnabled) return;
          const g = clamp(ev.gamma ?? 0, -35, 35);
          const b = clamp(ev.beta  ?? 0, -35, 35);
          gyroX = clamp(g * 1.5, -MAX_SHIFT, MAX_SHIFT);
          gyroY = clamp((b-10) * 1.2, -MAX_SHIFT, MAX_SHIFT);
        }, { passive:true });

        btnMotion.textContent = '‚úÖ Motion ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
      }catch(err){
        btnMotion.textContent = '‚ùå Motion ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
      }
    }

    btnMotion.addEventListener('click', enableMotion, { passive:true });

    btnHow.addEventListener('click', ()=>{
      alert(
        '‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô GoodJunkVR\n\n' +
        '1) ‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á (‡∏ß‡∏á‡∏Å‡∏•‡∏°)\n' +
        '2) ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏¢‡∏¥‡∏á‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ crosshair\n' +
        '3) ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶/‡∏ó‡∏≠‡∏á üü°/‡∏û‡∏•‡∏±‡∏á üß≤‚è≥üõ°Ô∏è\n' +
        '4) ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ üçüüçï ‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å üòàüß®\n' +
        '5) ‡πÇ‡∏´‡∏°‡∏î Boss ‡∏à‡∏∞‡∏°‡∏µ Ring/Laser/Storm ‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏ö\n\n' +
        '‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Motion)'
      );
    }, { passive:true });

    // =========================
    // NEW: Hub Context Bridge
    // =========================
    function readJSONStorage(key){
      try{
        const s = sessionStorage.getItem(key);
        if (s) return JSON.parse(s);
      }catch(_){}
      try{
        const s = localStorage.getItem(key);
        if (s) return JSON.parse(s);
      }catch(_){}
      return null;
    }
    function readHubContext(){
      const u = new URL(location.href);
      const pick = (k)=>{ const v=u.searchParams.get(k); return (v==null||v==='')?undefined:v; };

      const ctx = Object.assign(
        {},
        readJSONStorage('hha_context') || {},
        readJSONStorage('hha_profile') || {}
      );

      [
        'studyId','phase','conditionGroup','sessionOrder','blockLabel','siteCode','schoolYear','semester',
        'studentKey','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel',
        'heightCm','weightKg','bmi','bmiGroup','vrExperience','gameFrequency','handedness','visionIssue','healthDetail','consentParent',
        'sessionId'
      ].forEach((k)=>{
        const v = pick(k);
        if (v !== undefined) ctx[k] = v;
      });

      ['age','gradeLevel','heightCm','weightKg','bmi','schoolYear','semester','sessionOrder'].forEach((k)=>{
        if (ctx[k] != null && ctx[k] !== '' && !isNaN(ctx[k])) ctx[k] = Number(ctx[k]);
      });

      return ctx;
    }

    let __HHA_PROFILE_SENT__ = false;
    function emitProfileOnce(ctx){
      if (__HHA_PROFILE_SENT__) return;
      __HHA_PROFILE_SENT__ = true;
      try{
        window.dispatchEvent(new CustomEvent('hha:log_profile', {
          detail: { ts: Date.now(), ...ctx }
        }));
      }catch(_){}
    }

    // --- Start game ---
    let game = null;

    function startGame(){
      startOverlay.style.display = 'none';

      const ctx = readHubContext();
      emitProfileOnce(ctx);

      game = goodjunkBoot({
        diff,
        run,
        time,
        challenge,

        // ‚úÖ pass hub context into engine for logging/end payload
        context: ctx,

        // ‚úÖ if hub provides sessionId, unify it
        sessionId: ctx.sessionId || undefined,

        layerEl: layer,
        shootEl: btnShoot,
        safeMargins: {
          top: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeTop')) || 128,
          bottom: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeBottom')) || 170,
          left: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeSide')) || 26,
          right: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safeSide')) || 26
        }
      });
    }

    btnStart2D.addEventListener('click', startGame, { passive:true });

    btnStartVR.addEventListener('click', ()=>{
      startGame();
    }, { passive:true });

    // --- Debug / offsets loop ---
    function raf(){
      applyTransform();
      updateOffsets();

      // extra: if laser/ring showing, push micro kick
      const ring = document.getElementById('atk-ring');
      const laser = document.getElementById('atk-laser');
      if(ring?.classList.contains('show')) {
        document.documentElement.style.setProperty('--shakeAmp', '1.4');
      }
      if(laser?.classList.contains('warn') || laser?.classList.contains('fire')) {
        document.documentElement.style.setProperty('--shakeAmp', '1.8');
      }

      if (game && game.getState){
        const s = game.getState();
        dbgLine.textContent = `${diff}/${challenge} | score:${s.score} combo:${s.combo} miss:${s.misses} fever:${s.fever}% sh:${s.shield} boss:${s.bossAlive?('P'+s.bossPhase+' '+s.bossHp+'/'+s.bossHpMax):'‚Äî'}`;
      } else {
        dbgLine.textContent = `${diff}/${challenge} | ready`;
      }

      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // --- Fallback end summary (in case HUD overlay misses) ---
    const endBox = $('hhaEnd');
    const setTxt = (id, v)=>{ const el=$(id); if(el) el.textContent = String(v); };

    window.addEventListener('hha:end', (ev)=>{
      const d = (ev && ev.detail) ? ev.detail : {};
      setTxt('endGrade', d.grade ?? '‚Äî');
      setTxt('endScore', d.scoreFinal ?? d.score ?? 0);
      setTxt('endComboMax', d.comboMax ?? 0);
      setTxt('endMiss', d.misses ?? 0);

      setTxt('endGoals', d.goalsCleared ?? 0);
      setTxt('endGoalsTotal', d.goalsTotal ?? 0);

      setTxt('endMinis', d.miniCleared ?? d.minisCleared ?? 0);
      setTxt('endMinisTotal', d.miniTotal ?? d.minisTotal ?? 0);

      setTxt('endAcc', d.accuracy ?? 0);

      endBox.style.display = 'flex';
    });

    $('btnReplay').addEventListener('click', ()=>{
      location.reload();
    }, { passive:true });

    $('btnCloseEnd').addEventListener('click', ()=>{
      endBox.style.display = 'none';
    }, { passive:true });

    // initial offsets
    updateOffsets();
    window.addEventListener('resize', updateOffsets, { passive:true });

    // show desc with params
    $('startDesc').innerHTML =
      `‡πÇ‡∏´‡∏°‡∏î: <b>${diff}</b> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <b>${time}s</b> ‚Ä¢ challenge: <b>${challenge}</b> ‚Ä¢ run: <b>${run}</b><br/>` +
      `‡∏ó‡∏¥‡∏õ: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö gyro ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)`;

    // ==========================================================
    // HARD FX PACK (LOGIC + SOUND) ‚Äî listens to existing events
    // ==========================================================

    const FX = {
      vig: document.getElementById('hha-vignette'),
      warn: document.getElementById('hha-warnline'),
      hit: document.getElementById('hha-hitflash'),
      hero: document.getElementById('hha-heroFlash'),
      swBox: document.getElementById('hha-shockwave'),
      sw: document.querySelector('#hha-shockwave .sw'),
      pulse: document.getElementById('hha-bossPulse'),
      toast: document.getElementById('hha-toast'),
    };

    const rootEl = document.documentElement;
    let _kickTO = 0, _chromaTO = 0, _toastTO = 0, _flashTO = 0, _pulseTO = 0, _swTO = 0;

    function clamp01(x){ x=Number(x)||0; return x<0?0:(x>1?1:x); }
    function setVar(name, val){ rootEl.style.setProperty(name, String(val)); }

    function flash(el, opacity=1, ms=120){
      if(!el) return;
      clearTimeout(_flashTO);
      el.style.opacity = String(opacity);
      _flashTO = setTimeout(()=>{ el.style.opacity = '0'; }, Math.max(40, ms|0));
    }

    // inject keyframe once (for shockwave)
    (function ensureSWKeyframe(){
      const id='__sw_key__';
      if(document.getElementById(id)) return;
      const st=document.createElement('style');
      st.id=id;
      st.textContent = `
      @keyframes swExpand{
        0%{ transform: translate(-50%,-50%) scale(.35); opacity:.2; }
        30%{ opacity: .95; }
        100%{ transform: translate(-50%,-50%) scale(6.2); opacity:0; }
      }`;
      document.head.appendChild(st);
    })();

    function shockwaveAt(x,y, strength=1){
      if(!FX.swBox || !FX.sw) return;
      clearTimeout(_swTO);
      FX.swBox.style.opacity = '1';
      FX.sw.style.left = (x|0)+'px';
      FX.sw.style.top  = (y|0)+'px';
      FX.sw.style.opacity = '1';

      FX.sw.style.animation = 'none';
      FX.sw.offsetHeight; // reflow
      const dur = 260 + Math.round(180*clamp01(strength));
      FX.sw.style.animation = `swExpand ${dur}ms ease-out 1`;

      _swTO = setTimeout(()=>{
        FX.swBox.style.opacity = '0';
        FX.sw.style.opacity = '0';
      }, dur + 60);
    }

    // inject pulse keyframe
    (function ensurePulseKeyframe(){
      const id='__pulse_key__';
      if(document.getElementById(id)) return;
      const st=document.createElement('style');
      st.id=id;
      st.textContent = `
      @keyframes pulsePop{
        0%{ transform: translate(-50%,-50%) scale(.85); opacity:.35; }
        20%{ transform: translate(-50%,-50%) scale(1.06); opacity:1; }
        60%{ transform: translate(-50%,-50%) scale(1.02); opacity:.9; }
        100%{ transform: translate(-50%,-50%) scale(1.22); opacity:0; }
      }`;
      document.head.appendChild(st);
    })();

    function bossPulseAt(x,y, ttl=1200){
      if(!FX.pulse) return;
      clearTimeout(_pulseTO);
      FX.pulse.style.left = (x|0)+'px';
      FX.pulse.style.top  = (y|0)+'px';
      FX.pulse.style.opacity = '1';
      FX.pulse.style.animation = 'none';
      FX.pulse.offsetHeight;
      FX.pulse.style.animation = `pulsePop ${Math.max(700, ttl|0)}ms ease-out 1`;
      _pulseTO = setTimeout(()=>{ FX.pulse.style.opacity='0'; }, Math.max(240, ttl|0));
    }

    function toast(msg, ms=780){
      if(!FX.toast) return;
      clearTimeout(_toastTO);
      FX.toast.textContent = msg;
      FX.toast.style.opacity = '1';
      _toastTO = setTimeout(()=>{ FX.toast.style.opacity='0'; }, Math.max(200, ms|0));
    }

    // --------------------
    // SFX (WebAudio) HEAVY
    // --------------------
    const SFX = (() => {
      let ctx=null, master=null;
      let unlocked=false;

      function ensure(){
        if(ctx) return true;
        try{
          const AC = window.AudioContext || window.webkitAudioContext;
          ctx = new AC();
          master = ctx.createGain();
          master.gain.value = 0.22; // master volume
          master.connect(ctx.destination);
          return true;
        }catch(e){
          return false;
        }
      }
      async function unlock(){
        if(unlocked) return true;
        if(!ensure()) return false;
        try{
          if(ctx.state !== 'running') await ctx.resume();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          g.gain.value = 0.0001;
          o.connect(g); g.connect(master);
          o.frequency.value = 440;
          o.start(); o.stop(ctx.currentTime + 0.01);
          unlocked = true;
          return true;
        }catch(e){
          return false;
        }
      }

      function blip(freq=880, dur=0.06, type='square', vol=1){
        if(!ctx || !master) return;
        const t0 = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, t0);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.16 * Math.max(0.2, Math.min(1.4, vol)), t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + Math.max(0.03, dur));
        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + Math.max(0.03, dur) + 0.02);
      }

      function thump(vol=1){
        if(!ctx || !master) return;
        const t0 = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='sine';
        o.frequency.setValueAtTime(120, t0);
        o.frequency.exponentialRampToValueAtTime(48, t0 + 0.12);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.25 * Math.min(1.4, vol), t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + 0.22);
      }

      return {
        unlock,
        tick(kind='tick', intensity=1){
          if(!unlocked) return;
          const k = String(kind||'tick');
          const I = Math.max(0.2, Math.min(3, Number(intensity)||1));
          if(k.includes('laser')){
            blip(980, 0.045, 'square', 0.9*I);
          } else if(k.includes('ring')){
            blip(720, 0.05, 'square', 0.85*I);
          } else if(k.includes('final')){
            blip(1100, 0.04, 'square', 1.0*I);
          } else {
            blip(860, 0.04, 'square', 0.75*I);
          }
        },
        warn(){
          if(!unlocked) return;
          blip(520, 0.09, 'sawtooth', 1.0);
          blip(660, 0.06, 'square', 0.9);
        },
        hit(){
          if(!unlocked) return;
          thump(1.05);
          blip(220, 0.08, 'sawtooth', 0.9);
        },
        hero(){
          if(!unlocked) return;
          blip(740, 0.06, 'triangle', 0.9);
          blip(980, 0.06, 'triangle', 0.9);
          thump(0.7);
        },
        stun(){
          if(!unlocked) return;
          blip(160, 0.16, 'sawtooth', 1.1);
          thump(1.2);
        }
      };
    })();

    // unlock SFX on first user action
    ['btnStart2D','btnStartVR','btnMotion','btnShoot'].forEach((id)=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('pointerdown', ()=>{ SFX.unlock(); }, { passive:true });
    });

    // --------------------
    // BIND ENGINE EVENTS
    // --------------------

    // STUN state (from safe.js)
    window.addEventListener('hha:fever', (e)=>{
      const d = e.detail || {};
      const on = !!d.stunActive;
      rootEl.classList.toggle('is-stun', on);
      if(on){
        toast('üí• STUN! ‡∏´‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÅ‡∏ï‡∏Å‚Äù ‡∏Ç‡∏¢‡∏∞‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß!', 900);
        SFX.stun();
      }
    });

    // TICK beeps (from safe.js hazards/final)
    window.addEventListener('hha:tick', (e)=>{
      const d = e.detail || {};
      SFX.tick(d.kind || 'tick', d.intensity || 1);
    });

    // PANIC level (optional)
    window.addEventListener('hha:panic', (e)=>{
      const d = e.detail || {};
      const lv = clamp01(d.level);
      setVar('--panic', lv);
    });

    // FX: kick / chroma / hero (from safe.js)
    window.addEventListener('hha:fx', (e)=>{
      const d = e.detail || {};
      const t = String(d.type||'');

      if(t === 'kick'){
        clearTimeout(_kickTO);
        const I = Math.max(0.2, Math.min(3, Number(d.intensity)||1));
        setVar('--shakeAmp', (1.2 + I*1.8).toFixed(2));
        rootEl.classList.add('fx-kick');
        _kickTO = setTimeout(()=>{
          rootEl.classList.remove('fx-kick');
          setVar('--shakeAmp', '0');
        }, 150);
      }

      if(t === 'chroma'){
        clearTimeout(_chromaTO);
        const ms = Math.max(80, (d.ms|0) || 160);
        setVar('--chromaAmt', '1');
        rootEl.classList.add('fx-chroma');
        _chromaTO = setTimeout(()=>{
          rootEl.classList.remove('fx-chroma');
          setVar('--chromaAmt', '0');
        }, ms);
      }

      if(t === 'hero'){
        const ms = Math.max(120, (d.ms|0) || 220);
        flash(FX.hero, 1, ms);
        shockwaveAt(window.innerWidth*0.5, window.innerHeight*0.62, 1);
        toast('‚ö° HERO BURST!', 520);
        SFX.hero();
      }
    });

    // Boss pulse marker (from safe.js)
    window.addEventListener('hha:bossPulse', (e)=>{
      const d = e.detail || {};
      bossPulseAt(d.x ?? (innerWidth*0.5), d.y ?? (innerHeight*0.6), d.ttlMs ?? 1200);
      SFX.warn();
    });

    // Boss attack announce (optional)
    window.addEventListener('hha:bossAtk', (e)=>{
      const d = e.detail || {};
      const name = String(d.name||'');
      if(name === 'ring') toast('üü• RING! ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ‚Äú‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!', 850);
      else if(name === 'laser') toast('üî¥ LASER! ‡∏´‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!', 850);
      else toast('üå™Ô∏è STORM! ‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á + ‡∏°‡∏±‡πà‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô!', 850);
      SFX.warn();
    });

    // Optional quest events (if engine emits; safe even if not)
    window.addEventListener('quest:badHit', ()=>{
      flash(FX.hit, 1, 140);
      shockwaveAt(window.__GJ_AIM_POINT__?.x || innerWidth*0.5, window.__GJ_AIM_POINT__?.y || innerHeight*0.62, 1);
      rootEl.classList.add('fx-chroma');
      setVar('--chromaAmt', '1');
      clearTimeout(_chromaTO);
      _chromaTO = setTimeout(()=>{ rootEl.classList.remove('fx-chroma'); setVar('--chromaAmt','0'); }, 140);
      SFX.hit();
    });

    window.addEventListener('quest:goodHit', ()=>{
      flash(FX.hero, 0.55, 70);
    });

    window.addEventListener('quest:stunBreak', ()=>{
      toast('‚ùÑÔ∏è STUN BREAK! ‡πÅ‡∏ï‡∏Å‡πÑ‡∏î‡πâ!', 650);
      shockwaveAt(window.__GJ_AIM_POINT__?.x || innerWidth*0.5, window.__GJ_AIM_POINT__?.y || innerHeight*0.62, 1);
      SFX.hero();
    });
  </script>

</body>
</html>