<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR (PRODUCTION) ‚Äî H++ FINAL (HTML LATEST + HUB PATCH)
‚úÖ Back-to-Hub button (hub=... override) + preserve params
‚úÖ Auto profile/context logging: hha:log_profile + context passed into hha:log_session/events
‚úÖ Works with: /vr/particles.js (IIFE) + /vr/ui-fever.js (IIFE) + /vr/hha-hud.js (IIFE)
‚úÖ Boots: /vr-goodjunk/goodjunk.safe.js (H++ FINAL PACK PATCH C)
‚úÖ Includes: atk-ring / atk-laser overlays for boss patterns
‚úÖ Includes: offset sync for aim point + layer offset + visualViewport/orientationchange
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR (H++)</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (optional background/VR button) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- IMPORTANT: particles.js should load BEFORE boot module -->
  <script src="./vr/particles.js"></script>

  <!-- Global UI binders (IIFE) -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/hha-hud.js"></script>

  <!-- Optional logger -->
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.64);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --ringGapStart: 0deg;
      --ringGapSize: 45deg;
    }
    html,body{
      margin:0; padding:0;
      width:100%; height:100%;
      background: radial-gradient(1200px 700px at 50% 25%, #0b1120 0%, #020617 60%, #020617 100%);
      color:var(--text);
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      touch-action: none;
    }

    /* --- A-Frame behind (optional) --- */
    .vr-stage{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:0.35;
      filter: saturate(1.1) contrast(1.05);
    }

    /* --- Target layer (DOM emoji engine) --- */
    #gj-layer{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      z-index: 2;
      pointer-events:auto;
      user-select:none;
      -webkit-user-select:none;
      transform: translateZ(0);
    }

    .gj-target{
      position:absolute;
      transform: translate(-50%,-50%) scale(1);
      font-size: 56px;
      line-height: 1;
      filter: drop-shadow(0 16px 22px rgba(0,0,0,.45));
      will-change: transform,left,top,opacity;
      opacity: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .gj-target.spawn{ animation: gjPop .12s ease-out; }
    @keyframes gjPop{
      from{ transform: translate(-50%,-50%) scale(.55); opacity:.55; }
      to{ transform: translate(-50%,-50%) scale(1); opacity:1; }
    }
    .gj-target.gone{ animation: gjGone .14s ease-in forwards; }
    @keyframes gjGone{
      to{ transform: translate(-50%,-50%) scale(.2); opacity:0; }
    }

    /* flavors */
    .gj-target.gj-junk{ filter: drop-shadow(0 16px 24px rgba(239,68,68,.22)) drop-shadow(0 16px 22px rgba(0,0,0,.45)); }
    .gj-target.gj-fake{ filter: drop-shadow(0 16px 24px rgba(245,158,11,.22)) drop-shadow(0 16px 22px rgba(0,0,0,.45)); }
    .gj-target.gj-gold{ filter: drop-shadow(0 18px 28px rgba(245,158,11,.28)) drop-shadow(0 16px 22px rgba(0,0,0,.45)); }
    .gj-target.gj-power{ filter: drop-shadow(0 18px 28px rgba(34,197,94,.18)) drop-shadow(0 16px 22px rgba(0,0,0,.45)); }
    .gj-target.gj-boss{
      font-size: 74px;
      filter:
        drop-shadow(0 0 26px rgba(245,158,11,.16))
        drop-shadow(0 22px 34px rgba(0,0,0,.55));
    }

    /* --- Aim + Shoot UI --- */
    #aim-dot{
      position:fixed;
      left:50%;
      top:62%;
      width:16px;
      height:16px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow:
        0 0 0 6px rgba(255,255,255,.06),
        0 0 32px rgba(34,197,94,.10);
      z-index: 5;
      pointer-events:none;
    }
    #aim-dot:after{
      content:'';
      position:absolute;
      left:50%; top:50%;
      width:4px; height:4px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: rgba(255,255,255,.9);
    }

    #btnShoot{
      position:fixed;
      right: 14px;
      bottom: 18px;
      z-index: 6;
      width: 86px;
      height: 86px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.62);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      letter-spacing:.2px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
    }
    #btnShoot span{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size: 12px;
      opacity: .95;
    }
    #btnShoot b{ font-size: 22px; line-height:1; }

    /* --- Hub button --- */
    #btnHub{
      position:fixed;
      right: 12px;
      top: 12px;
      z-index: 7;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.62);
      color: var(--text);
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
    }

    /* --- Boss hazards overlays (ring/laser) --- */
    #atk-ring{
      position:fixed;
      left:50%;
      top:50%;
      width: 460px;
      height: 460px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      z-index: 4;
      pointer-events:none;
      opacity:0;
      transition: opacity .10s ease;
      background:
        conic-gradient(
          from var(--ringGapStart),
          rgba(245,158,11,.00) 0deg,
          rgba(245,158,11,.00) var(--ringGapSize),
          rgba(245,158,11,.55) var(--ringGapSize),
          rgba(245,158,11,.55) 360deg
        );
      -webkit-mask: radial-gradient(circle, transparent 54%, #000 56%);
      mask: radial-gradient(circle, transparent 54%, #000 56%);
      filter: drop-shadow(0 0 30px rgba(245,158,11,.18));
    }
    #atk-ring.show{ opacity:.95; }

    #atk-laser{
      position:fixed;
      left:0;
      width:100vw;
      height: 10px;
      z-index: 4;
      pointer-events:none;
      opacity:0;
      transform: translateY(-50%);
    }
    #atk-laser.warn{
      opacity:.75;
      background: linear-gradient(90deg, rgba(239,68,68,0), rgba(239,68,68,.75), rgba(239,68,68,0));
      box-shadow: 0 0 30px rgba(239,68,68,.18);
      animation: laserWarn .38s linear infinite;
    }
    @keyframes laserWarn{ 50%{ opacity:.25; } }
    #atk-laser.fire{
      opacity: 1;
      height: 18px;
      background: linear-gradient(90deg, rgba(239,68,68,0), rgba(239,68,68,.95), rgba(239,68,68,0));
      box-shadow: 0 0 40px rgba(239,68,68,.32);
    }

    /* --- HUD --- */
    .hud{
      position:fixed;
      left:12px;
      top:12px;
      z-index: 6;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .hud-row{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      font-weight: 950;
      font-size: 12px;
      color: var(--text);
      letter-spacing:.2px;
    }
    .pill b{ font-size: 13px; font-weight: 1000; }
    .muted{ color: var(--muted); font-weight: 800; }

    /* Quest panel */
    .quest{
      position:fixed;
      left:12px;
      bottom:12px;
      z-index: 6;
      width: min(360px, calc(100vw - 24px));
      background: rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.22);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      padding: 12px;
      pointer-events:none;
    }
    .q-title{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 12px;
      opacity:.95;
      margin-bottom: 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .q-item{ margin-top: 10px; }
    .q-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-weight: 950;
      font-size: 12px;
      opacity:.95;
    }
    .q-head small{ font-weight: 900; color: var(--muted); }
    .bar{
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.92), rgba(59,130,246,.92));
      transition: width .08s linear;
    }

    /* Coach */
    .coach{
      position:fixed;
      right:12px;
      bottom: calc(18px + 96px);
      z-index: 6;
      width: min(360px, calc(100vw - 24px));
      display:flex;
      gap:12px;
      align-items:flex-start;
      pointer-events:none;
    }
    .coach img{
      width: 64px;
      height: 64px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.60);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      object-fit: cover;
    }
    .coach .bubble{
      flex:1;
      background: rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.22);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      padding: 12px;
    }
    .coach .line{
      font-weight: 1000;
      font-size: 13px;
      letter-spacing:.2px;
      margin-bottom: 4px;
    }
    .coach .sub{
      font-weight: 850;
      font-size: 12px;
      color: var(--muted);
    }

    /* Start overlay */
    .overlay{
      position:fixed;
      inset:0;
      z-index: 10;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(1200px 700px at 50% 25%, rgba(34,197,94,.08) 0%, rgba(2,6,23,.94) 55%, rgba(2,6,23,.98) 100%);
    }
    .card{
      width:min(560px, 100%);
      background: rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.22);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h1{
      margin: 4px 0 8px 0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .tile{
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 16px;
      padding: 10px;
    }
    .tile b{ font-weight: 1000; }
    .btns{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      min-width: 170px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(34,197,94,.18);
      color: var(--text);
      font-weight: 1000;
      letter-spacing:.2px;
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
    }
    .btn.secondary{ background: rgba(2,6,23,.62); }
    .small{
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
      line-height: 1.45;
    }

    /* End overlay */
    #hhaEnd{
      position:fixed;
      inset:0;
      z-index: 11;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(2,6,23,.92);
    }
    #hhaEnd .card{ width:min(620px, 100%); }
    .endGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .endGrid .tile{ background: rgba(15,23,42,.55); }
    .bigGrade{
      font-size: 42px;
      font-weight: 1100;
      letter-spacing: .6px;
      margin: 8px 0 0;
    }

    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .endGrid{ grid-template-columns: 1fr; }
      #btnShoot{ width: 82px; height:82px; }
      .gj-target{ font-size: 52px; }
    }
  </style>
</head>

<body>

  <!-- Back to HUB -->
  <button id="btnHub" type="button" aria-label="Back to Hub">üè† HUB</button>

  <!-- optional: subtle VR background -->
  <div class="vr-stage" aria-hidden="true">
    <a-scene embedded vr-mode-ui="enabled: true" renderer="colorManagement: true; physicallyCorrectLights: true">
      <a-entity light="type: ambient; intensity: 0.55"></a-entity>
      <a-entity light="type: point; intensity: 1.2; distance: 50" position="0 5 4"></a-entity>
      <a-sky color="#071022"></a-sky>
    </a-scene>
  </div>

  <!-- DOM targets layer -->
  <div id="gj-layer" aria-label="GoodJunk targets layer"></div>

  <!-- Boss overlays -->
  <div id="atk-ring" aria-hidden="true"></div>
  <div id="atk-laser" aria-hidden="true"></div>

  <!-- Aim + Shoot -->
  <div id="aim-dot" aria-hidden="true"></div>
  <button id="btnShoot" type="button" aria-label="Shoot">
    <span><b>üéØ</b>SHOOT</span>
  </button>

  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <div class="hud-row">
      <div class="pill">üèÜ <span class="muted">Score</span> <b id="hhaScore">0</b></div>
      <div class="pill">‚ö° <span class="muted">Combo</span> <b id="hhaCombo">0</b></div>
      <div class="pill">üíî <span class="muted">Miss</span> <b id="hhaMiss">0</b></div>
    </div>
    <div class="hud-row">
      <div class="pill">‚è±Ô∏è <span class="muted">Time</span> <b id="hhaTime">0</b></div>
      <div class="pill">üëë <span class="muted">Rank</span> <b id="hhaGrade">‚Äî</b></div>
    </div>
  </div>

  <!-- Quest panel -->
  <div class="quest" aria-hidden="true">
    <div class="q-title">
      <span>üéØ QUEST</span>
      <span class="small">Goal √ó2 | Mini ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</span>
    </div>

    <div class="q-item">
      <div class="q-head">
        <div id="qGoalTitle">Goal: ‚Äî</div>
        <small><span id="qGoalCur">0</span>/<span id="qGoalMax">0</span></small>
      </div>
      <div class="bar"><div class="fill" id="qGoalFill"></div></div>
    </div>

    <div class="q-item">
      <div class="q-head">
        <div id="qMiniTitle">Mini: ‚Äî</div>
        <small>
          <span id="qMiniCur">0</span>/<span id="qMiniMax">0</span>
          <span class="muted" style="margin-left:8px">‚è≥ <span id="qMiniTLeft">‚Äî</span></span>
        </small>
      </div>
      <div class="bar"><div class="fill" id="qMiniFill"></div></div>
    </div>
  </div>

  <!-- Coach -->
  <div class="coach" aria-hidden="true">
    <img id="hhaCoachImg" src="./img/coach-neutral.png" alt="Coach" />
    <div class="bubble">
      <div class="line" id="hhaCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô ‚Äú‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á ‚Äú‡∏Ç‡∏¢‡∏∞‚Äù üí•</div>
      <div class="sub" id="hhaCoachSub">Tip: ‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏° SHOOT ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡∏ß‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á</div>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <h1>ü•¶üçü GoodJunkVR ‚Äî H++ FINAL</h1>
      <div class="small" id="runInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>

      <div class="grid">
        <div class="tile">
          <b>‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ Miss</b><br/>
          <span class="small">miss = goodExpired + junkHit (Shield block junk = ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô miss)</span>
        </div>
        <div class="tile">
          <b>‡πÇ‡∏´‡∏°‡∏î Boss (Phase 2)</b><br/>
          <span class="small">‡∏°‡∏µ Ring / Laser / Storm + Pulse Challenge + Counter Window</span>
        </div>
      </div>

      <div class="btns">
        <button class="btn" id="btnStart" type="button">üöÄ START</button>
        <button class="btn secondary" id="btnReload" type="button">üîÅ RELOAD</button>
      </div>

      <div class="small" style="margin-top:10px">
        ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå: <b>?diff=easy|normal|hard</b> & <b>time=60..180</b> & <b>challenge=rush|survival|boss</b> & <b>run=play|study</b>
        <br/>Hub: <b>&hub=./hub.html</b> (‡∏´‡∏£‡∏∑‡∏≠ path ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      </div>
    </div>
  </div>

  <!-- End overlay -->
  <div id="hhaEnd">
    <div class="card">
      <h1>üéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h1>
      <div class="bigGrade">RANK: <span id="endGrade">‚Äî</span></div>

      <div class="endGrid">
        <div class="tile">
          <b>Score</b><br/>
          <span class="bigGrade" style="font-size:28px" id="endScore">0</span>
        </div>
        <div class="tile">
          <b>Accuracy</b><br/>
          <span class="bigGrade" style="font-size:28px"><span id="endAcc">0</span>%</span>
        </div>
        <div class="tile">
          <b>Combo Max</b><br/>
          <span class="bigGrade" style="font-size:28px" id="endComboMax">0</span>
        </div>
        <div class="tile">
          <b>Miss</b><br/>
          <span class="bigGrade" style="font-size:28px" id="endMiss">0</span>
        </div>
        <div class="tile">
          <b>Goals</b><br/>
          <span class="bigGrade" style="font-size:24px"><span id="endGoals">0</span>/<span id="endGoalsTotal">0</span></span>
        </div>
        <div class="tile">
          <b>Minis</b><br/>
          <span class="bigGrade" style="font-size:24px"><span id="endMinis">0</span>/<span id="endMinisTotal">0</span></span>
        </div>
      </div>

      <div class="btns" style="margin-top:14px">
        <button class="btn" id="btnPlayAgain" type="button">üî• PLAY AGAIN</button>
        <button class="btn secondary" id="btnCloseEnd" type="button">‚úÖ CLOSE</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { boot as goodjunkBoot } from './vr-goodjunk/goodjunk.safe.js';

    const qs = new URLSearchParams(location.search);

    const diff = (qs.get('diff') || 'normal').toLowerCase();
    const time = Number(qs.get('time') || 70);
    const run  = (qs.get('run') || 'play').toLowerCase();
    const challenge = (qs.get('challenge') || 'rush').toLowerCase();

    const hubUrl = (qs.get('hub') || './hub.html').toString();

    const layer = document.getElementById('gj-layer');
    const aimDot = document.getElementById('aim-dot');
    const shootBtn = document.getElementById('btnShoot');

    const startOverlay = document.getElementById('startOverlay');
    const btnStart = document.getElementById('btnStart');
    const btnReload = document.getElementById('btnReload');
    const btnPlayAgain = document.getElementById('btnPlayAgain');
    const btnCloseEnd = document.getElementById('btnCloseEnd');

    const btnHub = document.getElementById('btnHub');
    const runInfo = document.getElementById('runInfo');

    let engine = null;

    // ---------------- Profile/Context (Hub Patch) ----------------
    // Accept from:
    // 1) query params (studyId/phase/conditionGroup/... etc)
    // 2) localStorage key "hha_profile" or "HHA_PROFILE" (JSON)
    // 3) window.postMessage {type:'hha_profile', payload:{...}} or {hha_profile:{...}}
    const PROFILE_KEYS = [
      // research meta
      'timestampIso','projectTag','runMode','studyId','phase','conditionGroup','sessionOrder','blockLabel',
      'siteCode','schoolYear','semester','sessionId','gameMode','diff','durationPlannedSec',
      // student profile
      'studentKey','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel',
      'heightCm','weightKg','bmi','bmiGroup','vrExperience','gameFrequency','handedness','visionIssue','healthDetail',
      'consentParent'
    ];

    function safeJsonParse(s){
      try{ return JSON.parse(s); }catch(_){ return null; }
    }

    function pickQSProfile(){
      const p = {};
      for (const k of PROFILE_KEYS){
        if (!qs.has(k)) continue;
        const v = qs.get(k);
        if (v === null || v === '') continue;
        p[k] = v;
      }
      // normalize a few numeric fields
      const numKeys = ['sessionOrder','schoolYear','semester','studentNo','age','gradeLevel','heightCm','weightKg','bmi','durationPlannedSec'];
      for (const nk of numKeys){
        if (p[nk] != null){
          const n = Number(p[nk]);
          if (Number.isFinite(n)) p[nk] = n;
        }
      }
      return p;
    }

    function readStoredProfile(){
      const a = safeJsonParse(localStorage.getItem('hha_profile') || '');
      const b = safeJsonParse(localStorage.getItem('HHA_PROFILE') || '');
      const c = safeJsonParse(sessionStorage.getItem('hha_profile') || '');
      const d = safeJsonParse(sessionStorage.getItem('HHA_PROFILE') || '');
      return (a && typeof a==='object') ? a :
             (b && typeof b==='object') ? b :
             (c && typeof c==='object') ? c :
             (d && typeof d==='object') ? d : null;
    }

    let liveProfile = {};
    function mergeProfile(base, patch){
      if (!patch || typeof patch !== 'object') return base;
      for (const k of Object.keys(patch)){
        const v = patch[k];
        if (v === undefined || v === null || v === '') continue;
        base[k] = v;
      }
      return base;
    }

    function buildProfile(){
      const stored = readStoredProfile();
      const fromQS = pickQSProfile();

      const p = {};
      mergeProfile(p, stored);
      mergeProfile(p, fromQS);

      // fill helpful defaults
      p.gameMode = p.gameMode || 'goodjunk';
      p.runMode = p.runMode || run;
      p.diff = p.diff || diff;
      p.durationPlannedSec = p.durationPlannedSec || Math.max(20, Math.min(180, (Number(time)||70)|0));
      p.projectTag = p.projectTag || 'HeroHealth';
      p.timestampIso = p.timestampIso || new Date().toISOString();

      return p;
    }

    function emitProfileOnce(profile){
      if (!profile || typeof profile !== 'object') return;
      // store for other pages too
      try{
        sessionStorage.setItem('hha_profile', JSON.stringify(profile));
        localStorage.setItem('hha_profile', JSON.stringify(profile));
      }catch(_){}

      // logger listens this
      try{
        window.dispatchEvent(new CustomEvent('hha:log_profile', { detail: { ts: Date.now(), ...profile } }));
      }catch(_){}
    }

    window.addEventListener('message', (ev)=>{
      const data = ev && ev.data;
      if (!data) return;
      const payload =
        (data.type === 'hha_profile' && data.payload && typeof data.payload === 'object') ? data.payload :
        (data.hha_profile && typeof data.hha_profile === 'object') ? data.hha_profile :
        null;
      if (!payload) return;
      liveProfile = mergeProfile(liveProfile, payload);
      const merged = mergeProfile(buildProfile(), liveProfile);
      emitProfileOnce(merged);
    }, { passive:true });

    // ---------------- offsets (layer / aim) for GoodJunk engine ----------------
    function updateOffsets(){
      try{
        const r = aimDot.getBoundingClientRect();
        window.__GJ_AIM_POINT__ = { x: (r.left + r.width/2), y: (r.top + r.height/2) };
      }catch(_){
        window.__GJ_AIM_POINT__ = { x: innerWidth*0.5, y: innerHeight*0.62 };
      }
      try{
        const lr = layer.getBoundingClientRect();
        window.__GJ_LAYER_OFFSET__ = { x: lr.left, y: lr.top };
      }catch(_){
        window.__GJ_LAYER_OFFSET__ = { x: 0, y: 0 };
      }
    }

    window.addEventListener('resize', () => setTimeout(updateOffsets, 80), { passive:true });
    window.addEventListener('orientationchange', () => setTimeout(updateOffsets, 250), { passive:true });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => setTimeout(updateOffsets, 80), { passive:true });
    }

    // show param info
    function fmt(){
      const t = Math.max(20, Math.min(180, (Number(time)||70)|0));
      return `‡πÇ‡∏´‡∏°‡∏î: ${run.toUpperCase()} ‚Ä¢ Difficulty: ${diff.toUpperCase()} ‚Ä¢ Challenge: ${challenge.toUpperCase()} ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ${t}s`;
    }
    runInfo.textContent = fmt();

    function coach(line, sub, mood){
      window.dispatchEvent(new CustomEvent('hha:coach', { detail: { line, sub, mood } }));
    }

    function resetEnd(){
      const end = document.getElementById('hhaEnd');
      if (end) end.style.display = 'none';
    }

    // --------------- HUB NAV (preserve params) ---------------
    function goHub(){
      // preserve all params + keep run context
      const p = new URLSearchParams(location.search);
      p.set('from', 'goodjunk');
      p.set('ts', String(Date.now()));
      // ensure current mode snapshot in params (handy for hub)
      p.set('diff', diff);
      p.set('time', String(Math.max(20, Math.min(180, (Number(time)||70)|0))));
      p.set('run', run);
      p.set('challenge', challenge);
      // always keep hub param too
      p.set('hub', hubUrl);

      const url = hubUrl.includes('?')
        ? (hubUrl + '&' + p.toString())
        : (hubUrl + '?' + p.toString());

      location.href = url;
    }
    btnHub.addEventListener('pointerdown', (e)=>{ e.preventDefault(); goHub(); }, { passive:false });

    function startGame(){
      resetEnd();
      startOverlay.style.display = 'none';

      updateOffsets();

      // Ensure fever UI exists
      try{ window.FeverUI?.ensureFeverBar?.(); }catch(_){}

      // build + emit profile BEFORE boot (‡πÉ‡∏´‡πâ logger ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
      const mergedProfile = mergeProfile(buildProfile(), liveProfile);
      emitProfileOnce(mergedProfile);

      coach(
        '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô ‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏ß üî•',
        'Tip: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤ = ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤ | ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡∏ß‡πà‡∏≤‡∏á/SHOOT = ‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏á',
        'neutral'
      );

      // Boot engine
      engine = goodjunkBoot({
        diff,
        time,
        run,
        challenge,

        layerEl: layer,
        shootEl: shootBtn,

        // Safe margins (‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö HUD/‡∏õ‡∏∏‡πà‡∏°/fever)
        safeMargins: {
          top: 130,      // ‡∏Å‡∏±‡∏ô HUD ‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ + toast
          bottom: 190,   // ‡∏Å‡∏±‡∏ô quest + ‡∏õ‡∏∏‡πà‡∏°
          left: 26,
          right: 26
        }
      });

      // initial emit (HUD)
      window.dispatchEvent(new CustomEvent('hha:score', { detail: { score:0, combo:0, misses:0, goodHits:0 } }));
      window.dispatchEvent(new CustomEvent('hha:time',  { detail: { sec: Math.max(20, Math.min(180, (Number(time)||70)|0)) } }));

      // keep offsets fresh (especially after overlay close)
      setTimeout(updateOffsets, 120);
      setTimeout(updateOffsets, 420);
    }

    btnStart.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startGame(); }, { passive:false });
    btnReload.addEventListener('pointerdown', (e)=>{ e.preventDefault(); location.reload(); }, { passive:false });

    btnPlayAgain.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      const p = new URLSearchParams(location.search);
      p.set('diff', diff);
      p.set('time', String((Math.max(20, Math.min(180, (Number(time)||70)|0)))|0));
      p.set('run', run);
      p.set('challenge', challenge);
      p.set('hub', hubUrl);
      p.set('ts', String(Date.now()));
      location.href = location.pathname + '?' + p.toString();
    }, { passive:false });

    btnCloseEnd.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      document.getElementById('hhaEnd').style.display = 'none';
    }, { passive:false });

    // Optional: press anywhere to hide end (comfort)
    document.getElementById('hhaEnd').addEventListener('pointerdown', (e)=>{
      if (e.target && (e.target.id === 'hhaEnd')) e.currentTarget.style.display = 'none';
    });

    // Pre-emit profile (even before start) so hub->game flow records early
    (function primeProfile(){
      const mergedProfile = mergeProfile(buildProfile(), liveProfile);
      emitProfileOnce(mergedProfile);
    })();

    // Auto start? (if ?autostart=1)
    if (qs.get('autostart') === '1'){
      setTimeout(startGame, 250);
    } else {
      // keep offsets while on overlay
      updateOffsets();
      setInterval(updateOffsets, 600);
    }
  </script>
</body>
</html>