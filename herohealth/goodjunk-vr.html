<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR (PRODUCTION) ‚Äî HHA Standard (VR Layout + Start Gate)
‚úÖ Gate start: starts only after "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô"
‚úÖ VR/cVR: dual-eye split (stable)
‚úÖ Fullscreen support + layout adapt (body.is-fs)
‚úÖ Quest Peek button (VR HUD collapsed but missions still visible)
‚úÖ NEW: Quest Float L/R for Cardboard + vr-ui.js shoot bridge
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- ‚úÖ IMPORTANT (GitHub Pages): fix relative paths even if user opens wrong route -->
  <base href="/webxr-health-mobile/herohealth/" />

  <!-- UI -->
  <link rel="stylesheet" href="./vr-goodjunk/goodjunk-vr.css?v=2025-12-31d" />

  <!-- Global FX + Fever + Universal VR UI + HUD + Logger (ORDER MATTERS) -->
  <script src="./vr/particles.js?v=2025-12-31d" defer></script>
  <script src="./vr/ui-fever.js?v=2025-12-31d" defer></script>

  <!-- ‚úÖ Universal VR UI (ENTER VR/EXIT/RECENTER + crosshair/tap-to-shoot -> hha:shoot) -->
  <script src="./vr/vr-ui.js?v=2025-12-31d" defer></script>

  <script src="./vr/hha-hud.js?v=2025-12-31d" defer></script>
  <script src="./vr/hha-cloud-logger.js?v=2025-12-31d" defer></script>

  <!-- Boot (ESM) -->
  <script type="module" src="./vr-goodjunk/goodjunk-vr.boot.js?v=2025-12-31d"></script>

  <style>
    html,body{
      margin:0;height:100dvh;overflow:hidden;
      background:#020617;color:#e5e7eb;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    /* ===== Quest Float (Cardboard L/R) ===== */
    .gj-quest-float{ display:none; }

    body.view-cvr .gj-quest-float{
      display:block;
      position:absolute;
      top:12px;
      left:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(2,6,23,.65);
      border:1px solid rgba(148,163,184,.18);
      color:#e5e7eb;
      pointer-events:none;
      max-width:min(70vw, 360px);
      z-index:30;
    }
    body.view-cvr .gj-quest-float .qf-title{ font:900 14px/1.2 system-ui; }
    body.view-cvr .gj-quest-float .qf-sub{ margin-top:4px; opacity:.9; font:800 12px/1.2 system-ui; }
    body.view-cvr .gj-quest-float .qf-timer{ margin-top:6px; font:900 14px/1.1 system-ui; }

    /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ VR (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà cVR) ‡πÄ‡∏´‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ:
    body.view-vr .gj-quest-float{ display:block; }
    */
  </style>
</head>

<body>
  <!-- ===== HUD ===== -->
  <div class="hha-hud" id="hudRoot">
    <div class="hud-top">
      <div class="hud-badge">
        <div class="hud-title">GoodJunkVR</div>
        <div class="hud-sub" id="hudMeta">‚Äî</div>

        <div class="viewbar" id="viewbar">
          <button class="pill" id="btnViewPC" type="button">PC</button>
          <button class="pill" id="btnViewMobile" type="button">Mobile</button>
          <button class="pill" id="btnViewVR" type="button">VR</button>
          <button class="pill" id="btnViewCVR" type="button">cVR</button>
          <button class="pill ghost" id="btnEnterFS" type="button">Enter Fullscreen</button>
          <button class="pill ghost" id="btnEnterVR" type="button">Enter VR</button>
        </div>
      </div>

      <div class="hud-stats">
        <div class="hud-stat"><div class="k">Score</div><div class="v" id="hhaScore">0</div></div>
        <div class="hud-stat"><div class="k">Combo</div><div class="v" id="hhaCombo">0</div></div>
        <div class="hud-stat"><div class="k">Miss</div><div class="v" id="hhaMiss">0</div></div>
        <div class="hud-stat"><div class="k">Time</div><div class="v" id="hhaTime">0</div></div>
        <div class="hud-stat grade"><div class="k">Grade</div><div class="v" id="hhaGrade">‚Äî</div></div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="hud-quest" id="hudQuestPanel">
        <div class="q-row">
          <div class="q-title" id="hudGoalTitle">Goal: ‚Äî</div>
          <div class="q-count" id="hudGoalCount">0/0</div>
        </div>
        <div class="q-row">
          <div class="q-title mini" id="hudMiniTitle">Mini: ‚Äî</div>
          <div class="q-count" id="hudMiniCount">0/0</div>
          <div class="q-timer" id="hudMiniTimer"></div>
        </div>
        <div class="q-progress" id="hudQProgress">Goals 0/0 ‚Ä¢ Minis 0/0</div>
      </div>

      <div class="hud-coach">
        <img id="hudCoachImg" class="coach-img" src="./img/coach-neutral.png" alt="coach" />
        <div class="coach-talk">
          <div class="coach-line" id="hudCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ ü•¶üö´</div>
          <div class="coach-sub" id="hudCoachSub">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏¥‡∏á / ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== VR Mini HUD (shown only in VR/cVR) ===== -->
  <div class="vr-mini-hud" id="vrMiniHud" hidden>
    <div class="mini-row">
      <div class="mini-pill"><span>Score</span><b id="mScore">0</b></div>
      <div class="mini-pill"><span>Miss</span><b id="mMiss">0</b></div>
      <div class="mini-pill"><span>Time</span><b id="mTime">0</b></div>
      <button class="mini-btn" id="btnQuestPeek" type="button">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
    </div>
  </div>

  <!-- ===== Quest Peek Overlay (VR) ===== -->
  <div class="quest-peek" id="questPeek" hidden>
    <div class="peek-card">
      <div class="peek-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="peek-line" id="peekGoal">Goal: ‚Äî</div>
      <div class="peek-line" id="peekMini">Mini: ‚Äî</div>
      <div class="peek-sub" id="peekProgress">Goals 0/0 ‚Ä¢ Minis 0/0</div>
      <button class="btn-start" id="btnPeekClose" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- ===== Quest Toast (VR) ===== -->
  <div class="quest-toast" id="questToast" hidden>
    <div class="toast-card">
      <div class="toast-title" id="toastTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</div>
      <div class="toast-line" id="toastLine">‚Äî</div>
    </div>
  </div>

  <!-- ===== Fever/Shield UI ===== -->
  <div class="hha-fever" id="hhaFever">
    <div class="fever-row">
      <div class="fever-label">FEVER</div>
      <div class="fever-bar"><div class="fever-fill" id="feverBar"></div></div>
      <div class="fever-text" id="feverText">0%</div>
    </div>
    <div class="shield-row">
      <div class="shield-label">SHIELD</div>
      <div class="shield-pills" id="shieldPills"></div>
    </div>
  </div>

  <!-- ===== Playfield wrapper (for vr-ui.js compatibility recognizes #playfield) ===== -->
  <div id="playfield" aria-label="playfield">
    <!-- ===== Dual-eye stage ===== -->
    <div id="gj-stage">
      <div class="gj-eye eye-l" id="eyeL">
        <!-- ‚úÖ Quest Float (LEFT) -->
        <div class="gj-quest-float" id="gjQuestFloatL" aria-hidden="true">
          <div class="qf-title" id="qfMiniL">Mini: ‚Äî</div>
          <div class="qf-sub" id="qfGoalL">Goal: ‚Äî</div>
          <div class="qf-timer" id="qfTimeL"></div>
        </div>

        <div class="gj-layer" id="gj-layer-l" aria-label="targets layer left"></div>
        <div class="gj-crosshair" id="gj-crosshair-l" aria-hidden="true"></div>
      </div>

      <div class="gj-eye eye-r" id="eyeR" aria-hidden="true">
        <!-- ‚úÖ Quest Float (RIGHT) -->
        <div class="gj-quest-float" id="gjQuestFloatR" aria-hidden="true">
          <div class="qf-title" id="qfMiniR">Mini: ‚Äî</div>
          <div class="qf-sub" id="qfGoalR">Goal: ‚Äî</div>
          <div class="qf-timer" id="qfTimeR"></div>
        </div>

        <div class="gj-layer" id="gj-layer-r" aria-label="targets layer right"></div>
        <div class="gj-crosshair" id="gj-crosshair-r" aria-hidden="true"></div>
      </div>

      <div id="end-summary"></div>
    </div>
  </div>

  <!-- ===== Controls ===== -->
  <div class="hha-controls">
    <button id="btnShoot" class="btn-shoot" type="button">‡∏¢‡∏¥‡∏á</button>
  </div>

  <!-- ===== Start Overlay ===== -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">GoodJunk VR</div>
      <div class="start-desc">
        ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶ ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ üçü<br/>
        <span class="muted">‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å‡∏ô‡∏∏‡πà‡∏° ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏≠‡∏á</span>
      </div>
      <div class="start-meta" id="startMeta">‚Äî</div>
      <button id="btnStart" class="btn-start" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
    </div>
  </div>

  <!-- ===== VR Hint Overlay ===== -->
  <div id="vrHint" class="vr-hint" hidden>
    <div class="vr-card">
      <div class="vr-title">‡πÇ‡∏´‡∏°‡∏î VR/‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
      <div class="vr-desc">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô <b>‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡∏ï‡∏≤<br/>
        <span class="muted">Tip: ‡∏Å‡∏î ‚ÄúEnter Fullscreen‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ VR/cVR ‡∏à‡∏∞‡∏ô‡∏¥‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤</span>
      </div>
      <button id="btnVrOk" class="btn-start" type="button">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  </div>

  <!-- ===== Bridge: sync Quest/Score/Time to VR floats + mini HUD + peek + shoot ===== -->
  <script type="module">
    (() => {
      const DOC = document;
      const ROOT = window;

      function $(id){ return DOC.getElementById(id); }
      function setTxt(id, txt){
        const el = $(id);
        if (el) el.textContent = (txt ?? '');
      }

      function setQuestFloat(miniText, goalText, timeText=''){
        // L
        setTxt('qfMiniL', miniText);
        setTxt('qfGoalL', goalText);
        setTxt('qfTimeL', timeText);

        // R
        setTxt('qfMiniR', miniText);
        setTxt('qfGoalR', goalText);
        setTxt('qfTimeR', timeText);

        // Peek overlay
        setTxt('peekMini', miniText);
        setTxt('peekGoal', goalText);
      }

      // Cache current quest strings
      const Q = { mini: 'Mini: ‚Äî', goal: 'Goal: ‚Äî', progress: 'Goals 0/0 ‚Ä¢ Minis 0/0', miniLeft: '' };

      // quest:update should carry goal/mini/progress; we accept many shapes safely
      ROOT.addEventListener('quest:update', (ev) => {
        const d = ev.detail || {};

        const goalTitle = d.goalTitle ?? d.goal ?? d.goalText ?? '';
        const miniTitle = d.miniTitle ?? d.mini ?? d.miniText ?? '';

        const goal = goalTitle ? (String(goalTitle).startsWith('Goal:') ? String(goalTitle) : `Goal: ${goalTitle}`) : 'Goal: ‚Äî';
        const mini = miniTitle ? (String(miniTitle).startsWith('Mini:') ? String(miniTitle) : `Mini: ${miniTitle}`) : 'Mini: ‚Äî';

        Q.goal = goal;
        Q.mini = mini;

        // progress
        if (d.progressText) Q.progress = String(d.progressText);
        else if (typeof d.goalsCleared === 'number' && typeof d.goalsTotal === 'number') {
          const g = `Goals ${d.goalsCleared}/${d.goalsTotal}`;
          const m = (typeof d.miniCleared === 'number' && typeof d.miniTotal === 'number') ? ` ‚Ä¢ Minis ${d.miniCleared}/${d.miniTotal}` : '';
          Q.progress = g + m;
        }

        // mini timer
        if (typeof d.miniTimeLeftSec === 'number') {
          Q.miniLeft = `${Math.max(0, Math.ceil(d.miniTimeLeftSec))}s`;
        } else if (typeof d.miniLeftSec === 'number') {
          Q.miniLeft = `${Math.max(0, Math.ceil(d.miniLeftSec))}s`;
        }

        setQuestFloat(Q.mini, Q.goal, Q.miniLeft);
        setTxt('peekProgress', Q.progress);

        // Optional toast
        const toast = $('questToast');
        if (toast && DOC.body.classList.contains('view-cvr')) {
          setTxt('toastLine', `${Q.goal} ‚Ä¢ ${Q.mini}`);
          toast.hidden = false;
          clearTimeout(toast._t);
          toast._t = setTimeout(() => { toast.hidden = true; }, 1200);
        }
      });

      // time event (sync mini HUD time)
      ROOT.addEventListener('hha:time', (ev) => {
        const d = ev.detail || {};
        if (typeof d.timeLeftSec === 'number') setTxt('mTime', `${Math.max(0, Math.ceil(d.timeLeftSec))}`);
        if (typeof d.miniTimeLeftSec === 'number') {
          Q.miniLeft = `${Math.max(0, Math.ceil(d.miniTimeLeftSec))}s`;
          setQuestFloat(Q.mini, Q.goal, Q.miniLeft);
        }
      });

      // score event (sync mini HUD quick stats)
      ROOT.addEventListener('hha:score', (ev) => {
        const d = ev.detail || {};
        if (typeof d.score === 'number') setTxt('mScore', String(d.score));
        if (typeof d.miss === 'number') setTxt('mMiss', String(d.miss));
      });

      // ‚úÖ Shoot bridge: vr-ui.js emits hha:shoot -> click Shoot button
      ROOT.addEventListener('hha:shoot', () => {
        const btn = $('btnShoot');
        if (btn) btn.click();
      });

      // Quest Peek buttons (guard double bind)
      if (!$('questPeek')?.dataset.bound) {
        const peek = $('questPeek');
        if (peek) peek.dataset.bound = '1';

        $('btnQuestPeek')?.addEventListener('click', () => { if (peek) peek.hidden = false; });
        $('btnPeekClose')?.addEventListener('click', () => { if (peek) peek.hidden = true; });
      }

      // Show mini HUD only in VR/cVR (depends on body class set by your boot)
      function syncMiniHud(){
        const on = DOC.body.classList.contains('view-vr') || DOC.body.classList.contains('view-cvr');
        const el = $('vrMiniHud');
        if (el) el.hidden = !on;
      }
      syncMiniHud();
      const mo = new MutationObserver(syncMiniHud);
      mo.observe(DOC.body, { attributes:true, attributeFilter:['class'] });
    })();
  </script>
</body>
</html>