<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR (PRODUCTION) ‚Äî HHA Standard
‚úÖ DOM emoji targets (dual-eye for VR/cVR)
‚úÖ HUD + Quest + Coach + Fever/Shield
‚úÖ Boot gate: engine starts ONLY after pressing "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô"
‚úÖ Quest Peek (missions visible even when HUD is hidden in VR)
‚úÖ VR Compact HUD + VR low-time tick (hha:vr_tick) ‚Äî non-nausea
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Base UI -->
  <link rel="stylesheet" href="./vr-goodjunk/goodjunk-vr.css" />

  <!-- Global FX + Fever + HUD + Logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Boot (ESM) -->
  <script type="module" src="./vr-goodjunk/goodjunk-vr.boot.js"></script>

  <!-- ===== PATCH CSS: VR compact HUD + low-time tick toast (non-nausea) ===== -->
  <style>
    /* each eye clips its own targets (important in VR/cVR) */
    .gj-eye{ overflow:hidden; }

    /* when HUD hidden: fully hide panels (quest peek still show) */
    body.hud-hidden .hha-hud{
      opacity:0;
      pointer-events:none;
    }
    body.hud-hidden .hha-fever{ opacity:.88; }

    /* -------- VR Compact HUD --------
       Goal: not clutter, still keep Score/Time/Grade visible
    */
    body.view-vr .hha-hud,
    body.view-cvr .hha-hud{
      padding: 8px 10px;
    }

    /* hide heavy sections in VR for readability */
    body.view-vr .hud-mid,
    body.view-cvr .hud-mid{
      display:none !important;
    }

    /* compact top row: keep title/meta + viewbar minimal */
    body.view-vr .hud-top,
    body.view-cvr .hud-top{
      align-items: flex-start;
      gap: 8px;
    }

    /* viewbar compress in VR */
    body.view-vr .viewbar,
    body.view-cvr .viewbar{
      gap: 6px;
      flex-wrap: wrap;
    }
    body.view-vr .viewbar .pill,
    body.view-cvr .viewbar .pill{
      height: 34px;
      padding: 0 10px;
      font-size: 12px;
      border-radius: 999px;
      font-weight: 900;
    }

    /* compact stats: show only Score/Time/Grade in VR */
    body.view-vr .hud-stats,
    body.view-cvr .hud-stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-left: auto;
      align-self: flex-start;
    }
    body.view-vr .hud-stats .hud-stat,
    body.view-cvr .hud-stats .hud-stat{
      padding: 8px 10px;
      border-radius: 14px;
    }
    body.view-vr .hud-stats .hud-stat:nth-child(2), /* Combo */
    body.view-vr .hud-stats .hud-stat:nth-child(3), /* Miss */
    body.view-cvr .hud-stats .hud-stat:nth-child(2),
    body.view-cvr .hud-stats .hud-stat:nth-child(3){
      display:none !important;
    }
    body.view-vr .hud-stats .hud-stat .k,
    body.view-cvr .hud-stats .hud-stat .k{
      font-size: 10px;
      opacity: .92;
      font-weight: 900;
      letter-spacing: .2px;
    }
    body.view-vr .hud-stats .hud-stat .v,
    body.view-cvr .hud-stats .hud-stat .v{
      font-size: 18px;
      font-weight: 1100;
      margin-top: 2px;
    }

    /* compact title area */
    body.view-vr .hud-badge .hud-title,
    body.view-cvr .hud-badge .hud-title{
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    body.view-vr .hud-badge .hud-sub,
    body.view-cvr .hud-badge .hud-sub{
      font-size: 11px;
      font-weight: 850;
      opacity: .92;
      margin-top: 2px;
    }

    /* -------- VR low-time toast (per-eye) -------- */
    .vr-tick{
      position:absolute;
      left:50%;
      top: 18%;
      transform: translate(-50%,-50%);
      z-index: 120;
      pointer-events:none;

      min-width: 92px;
      height: 56px;
      padding: 8px 12px;

      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;

      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.68);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 56px rgba(0,0,0,.55);

      opacity: 0;
    }
    .vr-tick .n{
      font-size: 26px;
      font-weight: 1100;
      letter-spacing: .2px;
      line-height: 1;
    }
    .vr-tick .s{
      font-size: 11px;
      font-weight: 950;
      opacity: .92;
      line-height: 1;
      transform: translateY(1px);
    }

    /* soft pulse animation ‚Äî no shake */
    @keyframes vrTickPop{
      0%   { opacity: 0; transform: translate(-50%,-50%) scale(.92); }
      18%  { opacity: 1; transform: translate(-50%,-50%) scale(1.02); }
      55%  { opacity: 1; transform: translate(-50%,-50%) scale(1.00); }
      100% { opacity: 0; transform: translate(-50%,-50%) scale(.98); }
    }
    .vr-tick.show{
      animation: vrTickPop 520ms ease-out 1;
    }

    /* low-time tone color (visual only) */
    body.gj-lowtime .vr-tick{
      border-color: rgba(245,158,11,.26);
      box-shadow: 0 18px 60px rgba(0,0,0,.55), 0 0 0 1px rgba(245,158,11,.08) inset;
    }

    /* make toast a bit lower in cVR to avoid notch top */
    body.view-cvr .vr-tick{ top: 20%; }

    /* -------- End overlay (kept) -------- */
    .end-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:140;
      background: rgba(2,6,23,.62);
      backdrop-filter: blur(10px);
    }
    .end-overlay[hidden]{ display:none !important; }
    .end-card{
      width:min(780px, 94vw);
      background: rgba(2,6,23,.86);
      border:1px solid rgba(148,163,184,.22);
      border-radius: 24px;
      padding:18px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    .end-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .end-title{ font-size:24px; font-weight:1000; letter-spacing:.2px; }
    .end-sub{ margin-top:6px; color: rgba(148,163,184,.95); font-weight:800; font-size:12px; }
    .end-grade{
      min-width:88px;
      text-align:center;
      font-weight:1100;
      font-size:28px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
    }
    .end-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .end-item{
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      padding:10px 12px;
    }
    .end-item .k{ color: rgba(148,163,184,.95); font-weight:850; font-size:12px; }
    .end-item .v{ margin-top:4px; font-weight:1100; font-size:20px; }
    .end-actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn-primary, .btn-ghost{
      height:54px;
      border-radius:16px;
      font-weight:1000;
      font-size:16px;
      border:1px solid rgba(148,163,184,.20);
      padding:0 16px;
      cursor:pointer;
    }
    .btn-primary{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
      color:#eafff3;
    }
    .btn-ghost{ background: rgba(2,6,23,.55); color: var(--text, #e5e7eb); }
    .btn-primary:active, .btn-ghost:active{ transform: translateY(1px); }
    .end-foot{ margin-top:10px; color: rgba(148,163,184,.95); font-weight:850; font-size:12px; }
    @media (max-width:700px){
      .end-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
  <!-- ===== HUD ===== -->
  <div class="hha-hud">
    <div class="hud-top">
      <div class="hud-badge">
        <div class="hud-title">GoodJunkVR</div>
        <div class="hud-sub" id="hudMeta">‚Äî</div>

        <div class="viewbar" id="viewbar">
          <button class="pill" id="btnViewPC" type="button">PC</button>
          <button class="pill" id="btnViewMobile" type="button">Mobile</button>
          <button class="pill" id="btnViewVR" type="button">VR</button>
          <button class="pill" id="btnViewCVR" type="button">cVR</button>

          <button class="pill ghost" id="btnPeek" type="button">Missions</button>
          <button class="pill ghost" id="btnToggleHud" type="button">HUD</button>

          <button class="pill ghost" id="btnEnterFS" type="button">Enter Fullscreen</button>
          <button class="pill ghost" id="btnEnterVR" type="button">Enter VR</button>
        </div>
      </div>

      <div class="hud-stats">
        <div class="hud-stat"><div class="k">Score</div><div class="v" id="hhaScore">0</div></div>
        <div class="hud-stat"><div class="k">Combo</div><div class="v" id="hhaCombo">0</div></div>
        <div class="hud-stat"><div class="k">Miss</div><div class="v" id="hhaMiss">0</div></div>
        <div class="hud-stat"><div class="k">Time</div><div class="v" id="hhaTime">0</div></div>
        <div class="hud-stat grade"><div class="k">Grade</div><div class="v" id="hhaGrade">‚Äî</div></div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="hud-quest">
        <div class="q-row">
          <div class="q-title" id="hudGoalTitle">Goal: ‚Äî</div>
          <div class="q-count" id="hudGoalCount">0/0</div>
        </div>
        <div class="q-row">
          <div class="q-title mini" id="hudMiniTitle">Mini: ‚Äî</div>
          <div class="q-count" id="hudMiniCount">0/0</div>
          <div class="q-timer" id="hudMiniTimer"></div>
        </div>
        <div class="q-progress" id="hudQProgress">Goals 0/0 ‚Ä¢ Minis 0/0</div>
      </div>

      <div class="hud-coach">
        <img id="hudCoachImg" class="coach-img" src="./img/coach-neutral.png" alt="coach" />
        <div class="coach-talk">
          <div class="coach-line" id="hudCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ ü•¶üö´</div>
          <div class="coach-sub" id="hudCoachSub">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏¥‡∏á / ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Fever/Shield UI ===== -->
  <div class="hha-fever" id="hhaFever">
    <div class="fever-row">
      <div class="fever-label">FEVER</div>
      <div class="fever-bar"><div class="fever-fill" id="feverBar"></div></div>
      <div class="fever-text" id="feverText">0%</div>
    </div>
    <div class="shield-row">
      <div class="shield-label">SHIELD</div>
      <div class="shield-pills" id="shieldPills"></div>
    </div>
  </div>

  <!-- ===== Quest Peek (always available) ===== -->
  <div class="gj-peek" id="gjPeek" aria-hidden="true">
    <div class="peek-card">
      <div class="peek-title">üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="peek-sub" id="gjPeekGoal">Goal: ‚Äî</div>
      <div class="peek-mini" id="gjPeekMini">Mini: ‚Äî</div>
      <div class="peek-tip">Tip: ‡πÇ‡∏´‡∏°‡∏î VR ‡∏ã‡πà‡∏≠‡∏ô HUD ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Å‡∏î ‚ÄúMissions‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î</div>
    </div>
  </div>

  <!-- ===== Playfield (dual-eye) ===== -->
  <div id="gj-stage" aria-label="playfield">
    <div class="gj-eye eye-l" id="eyeL">
      <div class="gj-layer" id="gj-layer-l" aria-label="targets layer left"></div>
      <div class="gj-crosshair" id="gj-crosshair-l" aria-hidden="true"></div>
      <div class="atk-ring" id="atk-ring-l" aria-hidden="true"></div>
      <div class="atk-laser" id="atk-laser-l" aria-hidden="true"></div>

      <!-- VR tick toast (left eye) -->
      <div class="vr-tick" id="vrTickL" hidden>
        <div class="n" id="vrTickNumL">10</div>
        <div class="s">SEC</div>
      </div>
    </div>

    <div class="gj-eye eye-r" id="eyeR" aria-hidden="true">
      <div class="gj-layer" id="gj-layer-r" aria-label="targets layer right"></div>
      <div class="gj-crosshair" id="gj-crosshair-r" aria-hidden="true"></div>
      <div class="atk-ring" id="atk-ring-r" aria-hidden="true"></div>
      <div class="atk-laser" id="atk-laser-r" aria-hidden="true"></div>

      <!-- VR tick toast (right eye) -->
      <div class="vr-tick" id="vrTickR" hidden>
        <div class="n" id="vrTickNumR">10</div>
        <div class="s">SEC</div>
      </div>
    </div>

    <!-- end summary placeholder -->
    <div id="end-summary"></div>
  </div>

  <!-- ===== Controls ===== -->
  <div class="hha-controls">
    <button id="btnShoot" class="btn-shoot" type="button">‡∏¢‡∏¥‡∏á</button>
  </div>

  <!-- ===== Start Overlay ===== -->
  <div id="startOverlay" class="start-overlay" hidden>
    <div class="start-card">
      <div class="start-title">GoodJunk VR</div>
      <div class="start-desc">
        ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶ ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ üçü<br/>
        <span class="muted">‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å‡∏ô‡∏∏‡πà‡∏° ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏≠‡∏á</span>
      </div>
      <div class="start-meta" id="startMeta">‚Äî</div>
      <button id="btnStart" class="btn-start" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
    </div>
  </div>

  <!-- ===== VR Hint Overlay ===== -->
  <div id="vrHint" class="vr-hint" hidden>
    <div class="vr-card">
      <div class="vr-title">‡πÇ‡∏´‡∏°‡∏î VR/‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
      <div class="vr-desc">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô <b>‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡∏ï‡∏≤<br/>
        <span class="muted">Tip: ‡∏Å‡∏î ‚ÄúEnter Fullscreen‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ VR/cVR ‡∏à‡∏∞‡∏ô‡∏¥‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤</span>
      </div>
      <button id="btnVrOk" class="btn-start" type="button">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  </div>

  <!-- ===== PATCH JS: listen hha:vr_tick + gentle beep (non-nausea) ===== -->
  <script>
    (function(){
      const doc = document;
      const tickL = doc.getElementById('vrTickL');
      const tickR = doc.getElementById('vrTickR');
      const numL  = doc.getElementById('vrTickNumL');
      const numR  = doc.getElementById('vrTickNumR');

      let audioCtx = null;
      let audioUnlocked = false;

      function unlockAudio(){
        if (audioUnlocked) return;
        audioUnlocked = true;
        try{
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return;
          audioCtx = new AC();
          if (audioCtx.state === 'suspended') audioCtx.resume?.();
        }catch(_){}
      }

      // unlock on first user gesture (Start is best)
      const btnStart = doc.getElementById('btnStart');
      if (btnStart) btnStart.addEventListener('click', unlockAudio, { passive:true });
      doc.addEventListener('pointerdown', unlockAudio, { passive:true, once:true });

      function beep(sec){
        if (!audioCtx) return;
        try{
          const t0 = audioCtx.currentTime;
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();

          const f = (sec === 1) ? 520 : 740; // last second slightly lower
          o.frequency.setValueAtTime(f, t0);
          o.type = 'sine';

          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.06, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.10);

          o.connect(g);
          g.connect(audioCtx.destination);
          o.start(t0);
          o.stop(t0 + 0.11);
        }catch(_){}
      }

      function showToast(sec){
        // show only in VR/cVR (dual-eye layout)
        const b = doc.body;
        const isVR = b.classList.contains('view-vr') || b.classList.contains('view-cvr');
        if (!isVR) return;

        if (numL) numL.textContent = String(sec);
        if (numR) numR.textContent = String(sec);

        [tickL, tickR].forEach(el=>{
          if (!el) return;
          el.hidden = false;
          el.classList.remove('show');
          // restart animation
          void el.offsetWidth;
          el.classList.add('show');
        });

        // gentle sound
        beep(sec);

        // auto hide
        setTimeout(()=>{
          [tickL, tickR].forEach(el=>{
            if (!el) return;
            el.hidden = true;
            el.classList.remove('show');
          });
        }, 560);
      }

      // listen to SAFE engine tick event (10..1)
      window.addEventListener('hha:vr_tick', (e)=>{
        try{
          const sec = Math.max(1, Math.min(10, Number(e.detail && e.detail.sec) || 0));
          if (!sec) return;
          showToast(sec);
        }catch(_){}
      }, { passive:true });
    })();
  </script>
</body>
</html>