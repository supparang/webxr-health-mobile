<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR LAUNCHER — ROOT (FAIR PACK S)
✅ Redirect -> ./vr-goodjunk/goodjunk-vr.html
✅ Auto-detect view (pc/mobile/vr) BUT:
   - If URL already has ?view=... -> DO NOT override
✅ Pass-through: hub/run/diff/time/seed/studyId/phase/conditionGroup/ts/log/style
✅ Optional remember last view via localStorage (safe)
✅ Tap-to-start default (prevents autoplay/VR permission issues)
✅ Guard redirect loop (hha_from=launcher)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — GoodJunkVR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg:#020617; --panel:rgba(2,6,23,.78); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --r:22px;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; width:100%; height:100%; overflow:hidden;
      background:
        radial-gradient(circle at top left, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(circle at bottom right, rgba(34,211,238,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans Thai",sans-serif;
    }
    .wrap{
      min-height:100%;
      display:flex; align-items:center; justify-content:center;
      padding: calc(18px + var(--sat)) calc(16px + var(--sar)) calc(18px + var(--sab)) calc(16px + var(--sal));
    }
    .card{
      width:min(720px, 94vw);
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      padding:18px;
      box-shadow:0 18px 55px rgba(0,0,0,.45);
    }
    .title{ font-size:22px; font-weight:1200; }
    .sub{ margin-top:6px; color:var(--muted); font-weight:900; }
    .row{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:999px;
      background:rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      color:var(--text);
      font-weight:1000;
      font-size:12px;
    }
    .go{
      margin-top:14px;
      height:54px; width:100%;
      border-radius:16px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.16);
      color:#eafff3;
      font-weight:1200;
      font-size:16px;
      cursor:pointer;
    }
    .go:active{ transform: translateY(1px); }
    .muted{ color:var(--muted); font-weight:900; font-size:12px; margin-top:10px; line-height:1.45; }
    .tiny{ font-size:11px; color:rgba(148,163,184,.85); font-weight:900; margin-top:8px; line-height:1.35; word-break:break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="title">GoodJunkVR</div>
      <div class="sub">พร้อมเข้าเกม (auto-detect แบบแฟร์, ไม่ override ถ้ามี ?view=)</div>

      <div class="row">
        <div class="pill">view: <span id="pView">auto</span></div>
        <div class="pill">run: <span id="pRun">play</span></div>
        <div class="pill">diff: <span id="pDiff">normal</span></div>
        <div class="pill">time: <span id="pTime">80</span>s</div>
      </div>

      <button class="go" id="btnGo" type="button">Tap to Start</button>

      <div class="muted">
        • ถ้าเข้า VR: ไปหน้าเกมแล้วกด ENTER VR (ปุ่มมาจาก vr-ui.js)<br/>
        • บังคับโหมด: <b>?view=pc</b> / <b>?view=mobile</b> / <b>?view=vr</b> / <b>?view=cvr</b><br/>
        • โหมดวิจัย/ล็อก: ใช้ <b>?run=research&amp;seed=...</b>
      </div>

      <div class="tiny" id="dbg">…</div>
    </div>
  </div>

<script>
(function(){
  const DEST = './vr-goodjunk/goodjunk-vr.html';

  const qs = (k, d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } };
  const has = (k)=>{ try{ return new URL(location.href).searchParams.has(k); }catch(_){ return false; } };

  function isLikelyMobileUA(){
    const ua = (navigator.userAgent||'').toLowerCase();
    return /android|iphone|ipad|ipod|mobile|silk/.test(ua);
  }

  function normalizeView(v){
    v = String(v||'').toLowerCase();
    if(v==='cardboard') return 'vr';
    if(v==='vr') return 'vr';
    if(v==='cvr' || v==='view-cvr') return 'cvr';
    if(v==='pc') return 'pc';
    if(v==='mobile') return 'mobile';
    return 'auto';
  }

  // ✅ FAIR detect: never force 'vr' unless immersive-vr supported
  async function detectView(){
    // 1) do not override if user provided view
    if(has('view')) return normalizeView(qs('view','auto'));

    // 2) optional remember last view (soft)
    try{
      const last = localStorage.getItem('HHA_LAST_VIEW');
      if(last) return normalizeView(last);
    }catch(_){}

    // 3) base guess
    let guess = isLikelyMobileUA() ? 'mobile' : 'pc';

    // 4) only promote to 'vr' if WebXR immersive-vr supported
    try{
      if(navigator.xr && typeof navigator.xr.isSessionSupported === 'function'){
        const ok = await navigator.xr.isSessionSupported('immersive-vr');
        if(ok && isLikelyMobileUA()) guess = 'vr';
      }
    }catch(_){}

    return normalizeView(guess);
  }

  function carryParams(url){
    const src = new URL(location.href);
    const dst = new URL(url, location.href);

    // Pass-through list (safe + research)
    const keep = [
      'hub','run','diff','time','seed','ts','studyId','study','phase','conditionGroup','cond',
      'log','style'
    ];
    for(const k of keep){
      if(src.searchParams.has(k)){
        dst.searchParams.set(k, src.searchParams.get(k));
      }
    }

    // normalize common aliases
    if(dst.searchParams.get('study') && !dst.searchParams.get('studyId')){
      dst.searchParams.set('studyId', dst.searchParams.get('study'));
    }
    if(dst.searchParams.get('cond') && !dst.searchParams.get('conditionGroup')){
      dst.searchParams.set('conditionGroup', dst.searchParams.get('cond'));
    }

    return dst;
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(el) el.textContent = String(v);
  }

  function setDbg(s){
    const el = document.getElementById('dbg');
    if(el) el.textContent = s;
  }

  let finalUrl = null;

  async function build(){
    const v = await detectView();
    const run  = String(qs('run','play')||'play');
    const diff = String(qs('diff','normal')||'normal');
    const time = String(qs('time','80')||'80');

    setText('pRun', run);
    setText('pDiff', diff);
    setText('pTime', time);

    const u = carryParams(DEST);

    // ✅ redirect loop guard: mark that we came from launcher
    if(!u.searchParams.get('hha_from')) u.searchParams.set('hha_from', 'launcher');

    // Only set view param if not already provided
    if(!has('view') && v && v !== 'auto'){
      u.searchParams.set('view', v);
      try{ localStorage.setItem('HHA_LAST_VIEW', v); }catch(_){}
    }
    setText('pView', has('view') ? normalizeView(qs('view','auto')) : (v || 'auto'));

    // ensure seed if research but missing
    const runMode = (u.searchParams.get('run')||'play').toLowerCase();
    if(runMode === 'research' && !u.searchParams.get('seed')){
      u.searchParams.set('seed', String(qs('ts', null) || Date.now()));
    }

    finalUrl = u.toString();
    setDbg(finalUrl);
  }

  function go(){
    if(!finalUrl){
      location.href = carryParams(DEST).toString();
      return;
    }
    location.href = finalUrl;
  }

  document.getElementById('btnGo')?.addEventListener('click', go);

  // ✅ FAIR: no auto-redirect by default (prevents autoplay/VR permission + “เด้งไว”)
  // If you REALLY want auto-redirect, uncomment below:
  // build().then(()=> setTimeout(go, 300));

  build();
})();
</script>
</body>
</html>