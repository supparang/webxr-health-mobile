<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR LAUNCHER ‚Äî ROOT (PRODUCTION) ‚Äî PATCH v20260208-gateA
‚úÖ Redirects to: ./vr-goodjunk/goodjunk-vr.html
‚úÖ Auto-detect view (pc/mobile/cvr/vr) ‚Äî BUT never override if ?view exists
‚úÖ Pass-through: hub/run/diff/time/seed/studyId/phase/conditionGroup/log/...
‚úÖ NEW: Warmup/Cooldown Gate routing (optional)
   - preGate=1 or gate=warmup => go to gate first (next=RUN)
   - If wType/wPct exists => assume already passed gate => go RUN
   - gateUrl=... (default ./warmup-gate.html) + dur/cdur + games list
‚úÖ NEW: Cooldown policy passthrough hints for RUN
   - cdGateUrl, cdur, cdDailyKey (RUN can use to force ‚Äúcooldown once per day‚Äù)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunkVR (Launcher)</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#020617" />
  <link rel="icon" href="./favicon.ico" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    html,body{
      height:100%; margin:0;
      background: radial-gradient(1200px 900px at 20% 10%, rgba(34,197,94,.16), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(34,211,238,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      overscroll-behavior:none;
    }
    .wrap{
      min-height:100%;
      display:flex; align-items:center; justify-content:center;
      padding: calc(16px + var(--sat)) calc(16px + var(--sar)) calc(16px + var(--sab)) calc(16px + var(--sal));
    }
    .card{
      width:min(720px, 96vw);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.55));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-weight: 1000; letter-spacing:.2px;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.45);
      font-weight:900;
      color: var(--text);
      user-select:none;
    }
    .sub{ color: var(--muted); font-weight:800; font-size:12px; margin-top:8px; line-height:1.35; }
    .bar{
      height:10px; border-radius:999px;
      background: rgba(148,163,184,.16);
      overflow:hidden;
      margin-top: 14px;
      border:1px solid rgba(148,163,184,.14);
    }
    .bar > i{
      display:block; height:100%;
      width: 62%;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.85));
      border-radius:999px;
      animation: ind 1.2s ease-in-out infinite;
    }
    @keyframes ind{
      0%{ transform: translateX(-60%); opacity:.55; }
      50%{ opacity:1; }
      100%{ transform: translateX(120%); opacity:.55; }
    }
    .kv{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .k{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
      border-radius:16px;
      padding:10px 12px;
    }
    .k .h{ color:rgba(148,163,184,.9); font-size:11px; font-weight:900; }
    .k .v{ font-size:13px; font-weight:950; margin-top:3px; word-break:break-word; }
    .hint{
      margin-top:12px;
      color: rgba(229,231,235,.82);
      font-size:12px;
      font-weight:850;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="status" aria-live="polite">
      <div class="row">
        <div class="title">
          <span class="pill">ü•ó GoodJunkVR</span>
          <span class="pill" id="pillView">VIEW: ‚Ä¶</span>
          <span class="pill" id="pillMode">MODE: ‚Ä¶</span>
          <span class="pill" id="pillRoute">ROUTE: ‚Ä¶</span>
        </div>
        <div class="pill" style="border-color:rgba(34,197,94,.35);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‚Ä¶</div>
      </div>

      <div class="sub" id="subLine">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏¥‡∏à‡∏±‡∏¢/‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ RUN
      </div>

      <div class="bar" aria-hidden="true"><i></i></div>

      <div class="kv" aria-label="debug params">
        <div class="k"><div class="h">target</div><div class="v" id="vTarget">‚Äî</div></div>
        <div class="k"><div class="h">hub</div><div class="v" id="vHub">‚Äî</div></div>
        <div class="k"><div class="h">diff</div><div class="v" id="vDiff">‚Äî</div></div>
        <div class="k"><div class="h">time</div><div class="v" id="vTime">‚Äî</div></div>
        <div class="k"><div class="h">seed</div><div class="v" id="vSeed">‚Äî</div></div>
        <div class="k"><div class="h">gate</div><div class="v" id="vGate">‚Äî</div></div>
      </div>

      <div class="hint">
        ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏° <b>?view=pc</b> / <b>?view=mobile</b> / <b>?view=cvr</b> / <b>?view=vr</b>
        (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ view ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß Launcher ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏õ override)
      </div>
    </div>
  </div>

  <!-- Optional ctx helpers (if you already have them) -->
  <script src="./vr/hha-ctx.js"></script>
  <script src="./vr/hha-launch.js"></script>

  <script>
  (function(){
    'use strict';

    // -----------------------------
    // Paths (edit once, use everywhere)
    // -----------------------------
    const RUN_URL_DEFAULT     = './vr-goodjunk/goodjunk-vr.html';

    // Your Warmup/Cooldown gate page (the big file you pasted)
    // Put it at /herohealth/warmup-gate.html (recommended) or set gateUrl=... in query.
    const GATE_URL_DEFAULT    = './warmup-gate.html';

    // Optional: default games list for gate "next=random"
    const GATE_GAMES_DEFAULT  = 'goodjunk-vr.html,groups-vr.html,hydration-vr.html,plate-vr.html';

    // Cooldown daily key (RUN can use this to enforce ‚Äúonce per day‚Äù)
    const CD_DAILY_KEY_DEFAULT = 'HHA_COOLDOWN_DONE_DAY';

    // -----------------------------
    // QS utils
    // -----------------------------
    function getQS(){
      try { return new URL(location.href).searchParams; }
      catch { return new URLSearchParams(); }
    }
    const QS = getQS();
    const q = (k, def='') => (QS.get(k) ?? def);

    function clampInt(v, a, b, def){
      const n = Number(v);
      if(!Number.isFinite(n)) return def;
      return Math.max(a, Math.min(b, Math.floor(n)));
    }

    function hasViewInUrl(){
      const v = String(q('view','')).trim();
      return !!v;
    }

    function detectView(){
      // Never override if ?view exists
      try{
        const hint = String(q('hint','')).toLowerCase();
        if(hint.includes('cvr') || hint.includes('cardboard')) return 'cvr';
      }catch(_){}

      const ua = navigator.userAgent || '';
      const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);

      if(String(q('view','')).toLowerCase() === 'cvr') return 'cvr';
      if(isMobile) return 'mobile';
      return 'pc';
    }

    function collectCtx(){
      try{
        if(window.HHA_CTX && typeof window.HHA_CTX.readCtx === 'function'){
          return window.HHA_CTX.readCtx() || null;
        }
      }catch(_){}
      return null;
    }

    function mergeParams(){
      const ctx = collectCtx();

      // Start with current URL params (user-provided > ctx)
      const out = {};
      QS.forEach((v,k)=>{ out[k] = v; });

      // Fill missing from ctx (only if not present)
      if(ctx && typeof ctx === 'object'){
        const map = {
          run: 'run',
          diff: 'diff',
          time: 'time',
          seed: 'seed',
          studyId: 'studyId',
          phase: 'phase',
          conditionGroup: 'conditionGroup',
          log: 'log',
          hub: 'hub'
        };
        Object.keys(map).forEach((k)=>{
          const key = map[k];
          if(out[key] == null || out[key] === ''){
            const v = ctx[k];
            if(v != null && v !== '') out[key] = String(v);
          }
        });
      }

      return out;
    }

    function buildUrl(base, params){
      const u = new URL(base, location.href);
      Object.entries(params||{}).forEach(([k,v])=>{
        if(v === undefined || v === null || v === '') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    function absUrlMaybe(url){
      if(!url) return '';
      try{ return new URL(url, location.href).toString(); }
      catch(_){ return url; }
    }

    // -----------------------------
    // Gate routing rules
    // -----------------------------
    function hasGateBuff(params){
      // If already passed warmup gate, it will send wType/wPct/... (at least wType or wPct)
      return !!(params.wType || params.wPct || params.rank || params.wCrit || params.wDmg || params.wHeal || params.calm);
    }

    function wantsPreGate(params){
      // preGate=1 OR gate=warmup OR gate=1
      const pre = String(params.preGate || '').toLowerCase();
      const g   = String(params.gate || '').toLowerCase();
      if(pre === '1' || pre === 'true' || pre === 'yes') return true;
      if(g === 'warmup' || g === '1' || g === 'true' || g === 'yes') return true;
      return false;
    }

    function shouldGoGateFirst(params){
      // If user wants gate AND we don't already have gate buff
      return wantsPreGate(params) && !hasGateBuff(params);
    }

    function makeGateParams(params){
      // Use same research params, but set gate-specific fields:
      // gate page uses: phase=warmup|cooldown, next=..., hub=..., dur/cdur, games
      const gateUrl = params.gateUrl || params.gate_page || GATE_URL_DEFAULT;

      const dur  = clampInt(params.dur  || q('dur','20'),  5, 60, 20);
      const cdur = clampInt(params.cdur || q('cdur','20'), 5, 60, 20);

      // IMPORTANT: Gate should NOT receive preGate/gate flags again (avoid loops)
      const deny = new Set(['preGate','gate','gateUrl','gate_page']);
      const pass = {};
      Object.entries(params).forEach(([k,v])=>{
        if(deny.has(k)) return;
        // also gate page itself uses next/hub/phase/dur/cdur/games; we will set those explicitly below.
        if(['next','hub','phase','dur','cdur','games'].includes(k)) return;
        pass[k] = v;
      });

      // Force warmup phase when used as preGate for a game
      // (Cooldown is typically used POST-game; RUN will open it later)
      const gateParams = {
        ...pass,
        phase: 'warmup',
        dur: String(dur),
        cdur: String(cdur),
        // next points to RUN page
        next: absUrlMaybe(params.runUrl || RUN_URL_DEFAULT),
        // hub passthrough
        hub: absUrlMaybe(params.hub || ''),
        // games list for next=random support
        games: String(params.games || GATE_GAMES_DEFAULT)
      };

      return { gateUrl: absUrlMaybe(gateUrl), gateParams };
    }

    // -----------------------------
    // Main
    // -----------------------------
    const params = mergeParams();

    // allow overriding RUN url from query if you want to A/B
    const RUN_URL = params.runUrl || RUN_URL_DEFAULT;

    // Decide view (never override if ?view exists)
    if(!hasViewInUrl()){
      params.view = detectView();
    }

    // Provide cooldown hints for RUN (RUN decides enforcement)
    // If you already implemented end-summary->cooldown flow in goodjunk.safe.js,
    // it can read these:
    //  - cdGateUrl: where cooldown gate page is
    //  - cdur: cooldown seconds
    //  - cdDailyKey: storage key name
    params.cdGateUrl  = params.cdGateUrl || params.gateUrl || GATE_URL_DEFAULT;
    params.cdur       = params.cdur || q('cdur','20') || '20';
    params.cdDailyKey = params.cdDailyKey || CD_DAILY_KEY_DEFAULT;

    // Debug UI
    try{
      const pillView  = document.getElementById('pillView');
      const pillMode  = document.getElementById('pillMode');
      const pillRoute = document.getElementById('pillRoute');

      const vTarget = document.getElementById('vTarget');
      const vHub    = document.getElementById('vHub');
      const vDiff   = document.getElementById('vDiff');
      const vTime   = document.getElementById('vTime');
      const vSeed   = document.getElementById('vSeed');
      const vGate   = document.getElementById('vGate');
      const subLine = document.getElementById('subLine');

      const view = String(params.view || '').toUpperCase();
      const run  = String(params.run || 'play').toUpperCase();

      if(pillView)  pillView.textContent = 'VIEW: ' + (view || 'AUTO');
      if(pillMode)  pillMode.textContent = 'MODE: ' + run;

      const preGateOn = wantsPreGate(params);
      const gateBuff  = hasGateBuff(params);
      const routeText = preGateOn ? (gateBuff ? 'GATE: done ‚Üí RUN' : 'GATE: warmup ‚Üí RUN') : 'DIRECT ‚Üí RUN';
      if(pillRoute) pillRoute.textContent = 'ROUTE: ' + routeText;

      if(vHub)  vHub.textContent  = String(params.hub || '(none)');
      if(vDiff) vDiff.textContent = String(params.diff || 'normal');
      if(vTime) vTime.textContent = String(params.time || '80');
      if(vSeed) vSeed.textContent = String(params.seed || '');
      if(vGate) vGate.textContent = preGateOn ? (gateBuff ? 'passed' : 'pending') : 'off';

      if(subLine){
        subLine.textContent = preGateOn
          ? (gateBuff
              ? '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ú‡∏•‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ RUN'
              : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Warmup Gate ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á‚Ä¶')
          : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ RUN‚Ä¶';
      }

      if(vTarget){
        vTarget.textContent = shouldGoGateFirst(params) ? String(params.gateUrl || GATE_URL_DEFAULT) : String(RUN_URL);
      }
    }catch(_){}

    // Prefer using HHA_LAUNCH if available (keeps behavior consistent across games)
    function go(url){
      try{
        if(window.HHA_LAUNCH && typeof window.HHA_LAUNCH.go === 'function'){
          window.HHA_LAUNCH.go(url);
          return;
        }
      }catch(_){}
      location.replace(url);
    }

    // Route: Gate first (warmup) OR direct to RUN
    if(shouldGoGateFirst(params)){
      const { gateUrl, gateParams } = makeGateParams(params);
      const urlGate = buildUrl(gateUrl, gateParams);
      go(urlGate);
      return;
    }

    // Direct to RUN (or after gate with wType/wPct already present)
    const urlRun = buildUrl(RUN_URL, params);
    go(urlRun);
  })();
  </script>
</body>
</html>