<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR (PRODUCTION) ‚Äî HHA Standard
‚úÖ HUD + Quest + Coach + Fever/Shield
‚úÖ Start overlay
‚úÖ PC/Mobile/VR/cVR view switch (split stereo for VR/cVR)
‚úÖ Keeps URL params (hub/run/diff/time/end/challenge/seed/sessionId/log/...)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Game CSS -->
  <link rel="stylesheet" href="./vr-goodjunk/goodjunk-vr.css" />

  <!-- Global FX + Fever + HUD + Logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Boot (ESM) -->
  <script type="module" src="./vr-goodjunk/goodjunk-vr.boot.js"></script>

  <style>
    /* --- Minimal view switch styles (safe) --- */
    .view-switch{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:auto;
    }
    .view-btn{
      height:30px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color:#e5e7eb;
      font-weight:900;
      font-size:12px;
      letter-spacing:.2px;
      cursor:pointer;
    }
    .view-btn.on{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }

    /* --- VR Split overlay (no dependency on external css) --- */
    body.is-vr #gj-stage{
      position:fixed;
      inset:0;
      overflow:hidden;
    }
    body.is-vr #gj-stage::before{
      content:'';
      position:fixed;
      top:0; bottom:0;
      left:50%;
      width:2px;
      transform:translateX(-1px);
      background: rgba(255,255,255,.06);
      pointer-events:none;
      z-index: 9;
    }
    body.is-vr #gj-layer,
    body.is-vr #gj-crosshair,
    body.is-vr #atk-ring,
    body.is-vr #atk-laser{
      /* make sure playfield is under HUD */
      z-index: 10;
    }

    /* Duplicate HUD text/blocks into both eyes (CSS-only mirror) */
    body.is-vr .hha-hud,
    body.is-vr .hha-fever,
    body.is-vr .hha-controls{
      width: calc(50vw - 18px);
    }
    body.is-vr .hha-hud{
      left: 10px;
      right: auto;
    }
    body.is-vr .hha-fever{
      left: 12px;
      right: auto;
    }
    body.is-vr .hha-controls{
      left: 0;
      right: auto;
      justify-content:center;
    }

    body.is-vr .vr-eye-dup{
      display:none;
    }
    body.is-vr .vr-eye-dup{
      display:block;
      position:fixed;
      top:0; left:50vw;
      width: calc(50vw - 18px);
      pointer-events:none;
      z-index: 80;
    }
    body.is-vr .vr-eye-dup .hha-hud{
      position:fixed;
      left: calc(50vw + 10px);
      right:auto;
      top: calc(10px + var(--safeTop, 0px));
    }
    body.is-vr .vr-eye-dup .hha-fever{
      position:fixed;
      left: calc(50vw + 12px);
      right:auto;
      bottom: calc(86px + var(--safeBottom, 0px));
    }
    body.is-vr .vr-eye-dup .hha-controls{
      position:fixed;
      left: 50vw;
      right:auto;
      bottom: calc(14px + var(--safeBottom, 0px));
      width: 50vw;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 90;
    }
    body.is-vr .vr-eye-dup .hha-controls .btn-shoot{
      pointer-events:auto;
    }

    /* Crosshair duplicated by CSS: original at center of each half */
    body.is-vr #gj-crosshair{
      left: 25%;
    }
    body.is-vr #gj-crosshair.vr-right{
      display:block;
      position:fixed;
      left: 75%;
      top: 62%;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      border: 2px solid rgba(255,255,255,.65);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12), 0 0 22px rgba(148,163,184,.14);
      z-index: 40;
      pointer-events:none;
    }
    body.is-vr #gj-crosshair.vr-right::before{
      content:'';
      position:absolute;
      left:50%; top:50%;
      width:7px; height:7px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      transform: translate(-50%,-50%);
    }
    body.is-vr #gj-crosshair.vr-right::after{
      content:'';
      position:absolute;
      left:50%; top:50%;
      width:64px; height:64px;
      border-radius:999px;
      border:2px dashed rgba(148,163,184,.22);
      transform: translate(-50%,-50%);
      opacity:.85;
    }

    /* In VR, keep targets inside each eye area via transform scaling on layer */
    body.is-vr #gj-layer{
      width: 50vw;
      overflow: hidden;
    }
    body.is-vr #gj-layer{
      left:0;
    }
    body.is-vr #gj-layer.vr-right-layer{
      display:block;
      position:fixed;
      top:0; bottom:0;
      left:50vw;
      width:50vw;
      overflow:hidden;
      pointer-events:none; /* keep main layer interactive */
      z-index: 10;
    }
  </style>
</head>

<body>
  <!-- ===== HUD ===== -->
  <div class="hha-hud">
    <div class="hud-top">
      <div class="hud-badge">
        <div class="hud-title">GoodJunkVR</div>
        <div class="hud-sub" id="hudMeta">‚Äî</div>

        <!-- View switch -->
        <div class="view-switch" id="viewSwitch">
          <button class="view-btn" data-view="pc">PC</button>
          <button class="view-btn" data-view="mobile">Mobile</button>
          <button class="view-btn" data-view="vr">VR</button>
          <button class="view-btn" data-view="cvr">cVR</button>
        </div>
      </div>

      <div class="hud-stats">
        <div class="hud-stat"><div class="k">Score</div><div class="v" id="hhaScore">0</div></div>
        <div class="hud-stat"><div class="k">Combo</div><div class="v" id="hhaCombo">0</div></div>
        <div class="hud-stat"><div class="k">Miss</div><div class="v" id="hhaMiss">0</div></div>
        <div class="hud-stat"><div class="k">Time</div><div class="v" id="hhaTime">0</div></div>
        <div class="hud-stat grade"><div class="k">Grade</div><div class="v" id="hhaGrade">‚Äî</div></div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="hud-quest">
        <div class="q-row">
          <div class="q-title" id="hudGoalTitle">Goal: ‚Äî</div>
          <div class="q-count" id="hudGoalCount">0/0</div>
        </div>
        <div class="q-row">
          <div class="q-title mini" id="hudMiniTitle">Mini: ‚Äî</div>
          <div class="q-count" id="hudMiniCount">0/0</div>
          <div class="q-timer" id="hudMiniTimer"></div>
        </div>
        <div class="q-progress" id="hudQProgress">Goals 0/0 ‚Ä¢ Minis 0/0</div>
      </div>

      <div class="hud-coach">
        <img id="hudCoachImg" class="coach-img" src="./img/coach-neutral.png" alt="coach" />
        <div class="coach-talk">
          <div class="coach-line" id="hudCoachLine">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ ü•¶üö´</div>
          <div class="coach-sub" id="hudCoachSub">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏¥‡∏á / ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Fever/Shield UI ===== -->
  <div class="hha-fever" id="hhaFever">
    <div class="fever-row">
      <div class="fever-label">FEVER</div>
      <div class="fever-bar"><div class="fever-fill" id="feverBar"></div></div>
      <div class="fever-text" id="feverText">0%</div>
    </div>
    <div class="shield-row">
      <div class="shield-label">SHIELD</div>
      <div class="shield-pills" id="shieldPills"></div>
    </div>
  </div>

  <!-- ===== Playfield ===== -->
  <div id="gj-stage">
    <div id="gj-layer" aria-label="targets layer"></div>
    <div id="gj-crosshair" aria-hidden="true"></div>

    <!-- VR-only clones -->
    <div id="gj-layer-right" class="vr-right-layer" aria-hidden="true"></div>
    <div id="gj-crosshair-right" class="vr-right" aria-hidden="true"></div>

    <div id="atk-ring" aria-hidden="true"></div>
    <div id="atk-laser" aria-hidden="true"></div>

    <!-- optional end summary container -->
    <div id="end-summary"></div>
  </div>

  <!-- ===== Controls ===== -->
  <div class="hha-controls">
    <button id="btnShoot" class="btn-shoot">‡∏¢‡∏¥‡∏á</button>
  </div>

  <!-- ===== Right-eye duplicated UI wrapper (VR) ===== -->
  <div class="vr-eye-dup" id="vrEyeDup" aria-hidden="true">
    <div class="hha-hud" id="hudDup"></div>
    <div class="hha-fever" id="feverDup"></div>
    <div class="hha-controls" id="controlsDup"></div>
  </div>

  <!-- ===== Start Overlay ===== -->
  <div id="startOverlay" class="start-overlay">
    <div class="start-card">
      <div class="start-title">GoodJunk VR</div>
      <div class="start-desc">
        ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ü•¶ ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡∏Ç‡∏¢‡∏∞ üçü<br/>
        <span class="muted">‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å‡∏ô‡∏∏‡πà‡∏° ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏≠‡∏á</span>
      </div>
      <div class="start-meta" id="startMeta">‚Äî</div>
      <button id="btnStart" class="btn-start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
    </div>
  </div>

  <script>
    // ---------- View / VR helpers (no module needed) ----------
    function qp(name, fallback=null){
      try{
        const u = new URL(location.href);
        const v = u.searchParams.get(name);
        return (v == null || v === '') ? fallback : v;
      }catch(_){ return fallback; }
    }
    function setParamAndReload(key, val){
      const u = new URL(location.href);
      u.searchParams.set(key, val);
      // bump cache buster
      u.searchParams.set('v', String(Date.now()));
      location.href = u.toString();
    }
    function currentView(){
      return String(qp('view', '') || '').toLowerCase() || (
        matchMedia && matchMedia('(pointer: coarse)').matches ? 'mobile' : 'pc'
      );
    }

    // Set view switch active
    (function initViewSwitch(){
      const v = currentView();
      const wrap = document.getElementById('viewSwitch');
      if (!wrap) return;
      wrap.querySelectorAll('.view-btn').forEach(btn=>{
        const tv = btn.getAttribute('data-view');
        if (tv === v) btn.classList.add('on');
        btn.addEventListener('click', ()=> setParamAndReload('view', tv));
      });
    })();

    // Apply VR layout if view=vr or view=cvr
    (function initVRMode(){
      const v = currentView();
      const isVR = (v === 'vr' || v === 'cvr');
      if (!isVR) return;

      document.body.classList.add('is-vr');

      // Duplicate HUD blocks into right eye (simple DOM clone)
      const hud = document.querySelector('.hha-hud');
      const fever = document.getElementById('hhaFever');
      const controls = document.querySelector('.hha-controls');

      const hudDup = document.getElementById('hudDup');
      const feverDup = document.getElementById('feverDup');
      const controlsDup = document.getElementById('controlsDup');

      if (hud && hudDup) hudDup.innerHTML = hud.innerHTML;
      if (fever && feverDup) feverDup.innerHTML = fever.innerHTML;
      if (controls && controlsDup) controlsDup.innerHTML = controls.innerHTML;

      // Hide duplicated view switch buttons in right eye (avoid confusing double)
      try{
        const vs = hudDup && hudDup.querySelector('#viewSwitch');
        if (vs) vs.style.display = 'none';
      }catch(_){}

      // Right-eye shoot button should trigger the real one
      try{
        const realShoot = document.getElementById('btnShoot');
        const dupShoot = controlsDup && controlsDup.querySelector('#btnShoot');
        if (dupShoot && realShoot){
          dupShoot.onclick = ()=> realShoot.click();
        }
      }catch(_){}

      // Create non-interactive mirror layer for right eye (visual only)
      const leftLayer = document.getElementById('gj-layer');
      const rightLayer = document.getElementById('gj-layer-right');
      if (leftLayer && rightLayer){
        // Mirror targets visually by cloning frequently (cheap & safe)
        setInterval(()=>{
          try{
            rightLayer.innerHTML = leftLayer.innerHTML;
          }catch(_){}
        }, 120);
      }

      // Encourage landscape & fullscreen after Start
      const btnStart = document.getElementById('btnStart');
      if (btnStart){
        btnStart.addEventListener('click', async ()=>{
          try{
            if (screen && screen.orientation && screen.orientation.lock){
              await screen.orientation.lock('landscape');
            }
          }catch(_){}
          try{
            const el = document.documentElement;
            if (el.requestFullscreen) await el.requestFullscreen();
          }catch(_){}
        }, { once:true });
      }
    })();
  </script>
</body>
</html>