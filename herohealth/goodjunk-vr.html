<!-- === /herohealth/goodjunk-vr.html ===
GoodJunkVR ‚Äî FULL HTML (HUD+Quest+End+Boss+Aim compat) ‚Äî FINAL (PATCH: z-index + restart/menu works + EnterVR)
‚úÖ FIX: #gj-layer z-index < HUD (HUD ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
‚úÖ FIX: ‡∏Å‡∏î ‚Ü©Ô∏è ‡πÄ‡∏°‡∏ô‡∏π ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ (startedOnce ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ñ‡∏π‡∏Å)
‚úÖ Add: ‡∏õ‡∏∏‡πà‡∏° Enter VR ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (best-effort)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunk VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (VR) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + logger + UI binders (IIFE) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- Boot (module) -->
  <script type="module" src="./vr-goodjunk/goodjunk-vr.boot.js"></script>

  <style>
    :root{
      color-scheme: light dark;
      --bg:#020617;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.58);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);

      --hudH: 40px;
      --pad: 10px;
      --radius: 18px;

      --ringGapStart: 0deg;
      --ringGapSize: 60deg;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 10%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans",
                   Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* ---------- A-Frame background ---------- */
    .sceneWrap{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
    }
    a-scene{ width:100%; height:100%; }

    /* ---------- Gameplay DOM layer ---------- */
    #gj-layer{
      position:fixed; inset:0;
      z-index:7000; /* ‚úÖ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ HUD(9100) / aim(9000) / FX(8000+) */
      overflow:hidden;
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
      pointer-events:auto;
      transform: translateZ(0);
    }

    .gj-target{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%,-50%) scale(1);
      transform-origin:center;
      font-size:56px;
      line-height:1;
      padding: 6px 8px;
      border-radius: 18px;
      background: rgba(2,6,23,.18);
      border: 1px solid rgba(148,163,184,.14);
      box-shadow: 0 16px 50px rgba(0,0,0,.32);
      filter: drop-shadow(0 12px 20px rgba(0,0,0,.42));
      opacity:0;
      transition: transform .14s ease, opacity .14s ease, filter .14s ease;
      will-change: transform, opacity, left, top;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      pointer-events:auto;
      visibility: visible;
    }
    .gj-target.spawn{ opacity:1; }
    .gj-target.gone{
      opacity:0;
      transform: translate(-50%,-50%) scale(.72);
      filter: blur(2px);
    }

    .gj-junk{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.08); }
    .gj-fake{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.06); }
    .gj-gold{
      border-color: rgba(245,158,11,.38);
      background: rgba(245,158,11,.10);
      box-shadow: 0 0 0 2px rgba(245,158,11,.10), 0 16px 50px rgba(0,0,0,.32);
      animation: goldPulse 1.1s ease-in-out infinite;
    }
    @keyframes goldPulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1); }
      50%{ transform: translate(-50%,-50%) scale(1.08); }
    }
    .gj-power{
      border-color: rgba(59,130,246,.34);
      background: rgba(59,130,246,.10);
      animation: powerFloat 1.0s ease-in-out infinite;
    }
    @keyframes powerFloat{
      0%,100%{ transform: translate(-50%,-50%) scale(1) translateY(0); }
      50%{ transform: translate(-50%,-50%) scale(1.05) translateY(-3px); }
    }
    .gj-boss{
      font-size: 66px;
      border-color: rgba(148,163,184,.28);
      background: rgba(148,163,184,.10);
      box-shadow: 0 0 0 3px rgba(148,163,184,.08), 0 18px 60px rgba(0,0,0,.38);
    }

    /* ---------- FX overlay hooks ---------- */
    #fx-chroma{
      position:fixed; inset:0;
      z-index:8000;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      background: radial-gradient(700px 380px at 50% 52%, rgba(59,130,246,.18), transparent 65%);
      mix-blend-mode: screen;
    }
    #fx-chroma.show{ opacity:1; }
    #fx-chroma.hero{
      background: radial-gradient(700px 380px at 50% 52%, rgba(34,197,94,.22), transparent 65%);
    }

    /* ---------- Attack overlays ---------- */
    #atk-ring{
      position:fixed;
      left:50%; top:50%;
      width: 520px; height:520px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      z-index:8500;
      pointer-events:none;
      opacity:0;
      transition: opacity .10s ease;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.45));
    }
    #atk-ring.show{ opacity:1; }
    #atk-ring::before{
      content:"";
      position:absolute; inset:0;
      border-radius:999px;
      background:
        conic-gradient(
          from var(--ringGapStart),
          rgba(239,68,68,.0) 0deg,
          rgba(239,68,68,.0) var(--ringGapSize),
          rgba(239,68,68,.55) var(--ringGapSize),
          rgba(239,68,68,.55) 360deg
        );
      -webkit-mask: radial-gradient(circle, transparent 56%, #000 57%);
      mask: radial-gradient(circle, transparent 56%, #000 57%);
      box-shadow: 0 0 0 10px rgba(239,68,68,.10);
    }

    #atk-laser{
      position:fixed;
      left:0; right:0;
      height: 26px;
      top:50%;
      transform: translateY(-50%);
      z-index:8600;
      pointer-events:none;
      opacity:0;
      transition: opacity .10s ease;
      background: linear-gradient(90deg, transparent, rgba(239,68,68,.38), transparent);
      box-shadow: 0 0 0 10px rgba(239,68,68,.08);
      border-top: 1px solid rgba(239,68,68,.25);
      border-bottom: 1px solid rgba(239,68,68,.25);
    }
    #atk-laser.warn{ opacity:1; animation: laserWarn .22s linear infinite; }
    #atk-laser.fire{ opacity:1; background: linear-gradient(90deg, transparent, rgba(239,68,68,.75), transparent); }
    @keyframes laserWarn{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.5); }
      100%{ filter: brightness(1); }
    }

    /* ---------- Crosshair ---------- */
    #aim{
      position:fixed;
      left:50%;
      top:62%;
      transform: translate(-50%,-50%);
      width: 44px; height:44px;
      border-radius: 999px;
      z-index:9000;
      pointer-events:none;
      opacity:.92;
      border: 2px solid rgba(229,231,235,.35);
      box-shadow: 0 0 0 10px rgba(2,6,23,.10);
    }
    #aim::before, #aim::after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      background: rgba(229,231,235,.35);
    }
    #aim::before{ width: 26px; height:2px; }
    #aim::after{ width: 2px; height:26px; }

    /* ---------- HUD TOP ---------- */
    .hud-top{
      position:fixed;
      left:var(--pad); right:var(--pad);
      top: calc(var(--safeTop) + 8px);
      height: var(--hudH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding: 4px 8px;
      border:1px solid rgba(148,163,184,.14);
      border-radius:999px;
      background: rgba(2,6,23,.40);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 40px rgba(0,0,0,.22);
      z-index:9100;
      min-width:0;
      pointer-events:auto;
    }
    #hud-pill.research{
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 2px rgba(34,197,94,.08), 0 10px 40px rgba(0,0,0,.22);
    }

    .hud-group{ display:flex; align-items:center; gap:8px; min-width:0; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.26);
      white-space:nowrap;
      min-width:0;
    }
    .dot{ width:7px; height:7px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(34,197,94,.45); }
    .kv{ display:flex; flex-direction:column; gap:0; min-width:0; }
    .kv .label{ font-size:9px; color:rgba(148,163,184,.92); letter-spacing:.06em; }
    .kv .big{ font-size:16px; font-weight:1000; line-height:1; }

    /* meta pills */
    .hud-meta{
      position:fixed;
      left:var(--pad); right:var(--pad);
      top: calc(var(--safeTop) + 8px + var(--hudH) + 6px);
      z-index:9100;
      display:flex;
      justify-content:flex-start;
      gap:8px;
      pointer-events:none;
      flex-wrap:wrap;
    }
    .meta-pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.30);
      backdrop-filter: blur(10px);
      color: rgba(148,163,184,.95);
      font-size:11px;
      font-weight:900;
    }
    .meta-pill b{ color: var(--text); }

    /* judge label */
    #hud-judge{
      position:fixed;
      left:0; right:0;
      top: calc(var(--safeTop) + 70px);
      z-index:9100;
      text-align:center;
      font-weight:1000;
      letter-spacing:.02em;
      color: rgba(229,231,235,.92);
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
      pointer-events:none;
      opacity:0;
      transform: translateY(4px);
      transition: opacity .14s ease, transform .14s ease;
    }
    #hud-judge.show{ opacity:1; transform: translateY(0); }

    /* fever/shield panel */
    .hud-right{
      position:fixed;
      right:var(--pad);
      top: calc(var(--safeTop) + 8px + var(--hudH) + 8px);
      z-index:9100;
      display:flex;
      flex-direction:column;
      gap:8px;
      width: min(240px, 48vw);
      transform: translateZ(0);
      pointer-events:auto;
    }
    .card{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.36);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 8px 10px;
      box-shadow: 0 14px 50px rgba(0,0,0,.22);
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .card h4{
      margin:0;
      font-size:11px;
      letter-spacing:.08em;
      color: rgba(148,163,184,.95);
      font-weight:1000;
    }
    .pct{ font-weight:1000; color:var(--text); font-size:11px; }
    .bar{
      margin-top:7px;
      height:9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(148,163,184,.08);
      overflow:hidden;
      position:relative;
    }
    #fever-fill{
      position:absolute; inset:0 auto 0 0;
      width:0%;
      background: linear-gradient(90deg, rgba(245,158,11,.9), rgba(239,68,68,.85));
      border-radius:999px;
      box-shadow:0 0 18px rgba(239,68,68,.18);
    }
    #shield-count{
      font-weight:1100;
      font-size:15px;
      color: var(--text);
    }
    #hud-stun{
      display:none;
      margin-top:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(239,68,68,.16);
      background: rgba(239,68,68,.08);
      font-weight:1000;
      font-size:11px;
      color: rgba(255,255,255,.92);
    }
    #hud-stun.show{ display:inline-flex; gap:8px; align-items:center; }

    /* coach bubble */
    #coach-bubble{
      position:fixed;
      left:var(--pad);
      bottom: calc(var(--safeBottom) + 78px);
      z-index:9100;
      max-width: min(72vw, 420px);
      display:flex;
      gap:10px;
      align-items:center;
      padding:7px 9px;
      border-radius:16px;
      background: rgba(2,6,23,.42);
      border: 1px solid rgba(148,163,184,.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.26);
      opacity:0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    #coach-bubble.show{ opacity:1; transform: translateY(0); }

    #hud-coach-img{
      width:34px; height:34px;
      border-radius:12px;
      object-fit: contain;
      background: rgba(15,23,42,.20);
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      flex: 0 0 auto;
    }
    #hud-coach{
      font-size:12px;
      line-height:1.25;
      font-weight:900;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
    }

    /* quest HUD bottom */
    .hud-bottom{
      position:fixed;
      left:var(--pad); right:var(--pad);
      bottom: calc(var(--safeBottom) + 10px);
      z-index:9100;
      border-radius: var(--radius);
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.44);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.28);
      padding: 9px 10px;
      max-height: 112px;
      overflow:hidden;
      cursor:pointer;
      pointer-events:auto;
    }
    .qtitle{
      font-size:12.5px;
      font-weight:1100;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .qcap{
      font-size:11.5px;
      color: rgba(148,163,184,.95);
      font-weight:900;
      white-space:nowrap;
      min-width: 64px;
      text-align:right;
    }
    .qline{ margin-top:7px; display:flex; align-items:center; gap:9px; }
    .qbar{
      flex:1;
      height:9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(148,163,184,.08);
      overflow:hidden;
      position:relative;
    }
    #hud-goal-bar, #hud-mini-bar{
      position:absolute; inset:0 auto 0 0;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(59,130,246,.85));
      box-shadow:0 0 18px rgba(59,130,246,.18);
    }
    #hud-mini-bar{
      background: linear-gradient(90deg, rgba(245,158,11,.9), rgba(34,197,94,.80));
      box-shadow:0 0 18px rgba(245,158,11,.16);
    }
    #hud-quest-hint{ margin-top:6px; font-size:11.5px; font-weight:1100; color: rgba(229,231,235,.92); }
    #hud-mini-count{ margin-top:6px; font-size:11.5px; font-weight:900; color: rgba(148,163,184,.95); }

    /* compact mode */
    body.hha-compact .hud-meta{ display:none; }
    body.hha-compact #logBadge{ display:none; }
    body.hha-compact #hud-judge{ opacity:0; }
    body.hha-compact .hud-top{
      opacity:.82;
      background: rgba(2,6,23,.30);
      border-color: rgba(148,163,184,.10);
      padding: 3px 6px;
      height: 34px;
    }
    body.hha-compact .hud-top .pill{ padding:4px 7px; }
    body.hha-compact .kv .label{ display:none; }
    body.hha-compact .kv .big{ font-size:15px; }
    body.hha-compact .hud-right{
      width: min(210px, 44vw);
      opacity:.78;
      gap:7px;
    }
    body.hha-compact .card{ padding: 7px 9px; }
    body.hha-compact .hud-bottom{
      max-height: 54px;
      padding: 7px 9px;
      opacity:.86;
    }
    body.hha-compact #coach-bubble{ opacity:0; transform: translateY(10px); }

    body.hha-compact.hha-peek .hud-bottom{ max-height: 112px; opacity:1; }
    body.hha-compact.hha-peek #coach-bubble{ opacity:1; transform: translateY(0); }

    /* start overlay */
    #start-overlay{
      position:fixed; inset:0;
      z-index:20000;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 22px 16px calc(var(--safeBottom) + 18px);
      background:
        radial-gradient(900px 500px at 50% 5%, rgba(59,130,246,.18), transparent 60%),
        rgba(2,6,23,.80);
      backdrop-filter: blur(12px);
    }
    .startCard{
      width:min(680px, 100%);
      border:1px solid rgba(148,163,184,.18);
      border-radius:24px;
      background: rgba(2,6,23,.68);
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      padding: 16px 16px 14px;
    }
    .startTitle{ font-size:20px; font-weight:1100; margin:0 0 6px 0; }
    #start-sub{ margin:0 0 12px 0; color:rgba(148,163,184,.95); font-size:13px; line-height:1.3; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    select{
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.40);
      color: var(--text);
      border-radius:14px;
      padding: 10px 12px;
      font-weight:1000;
      font-size:14px;
      outline:none;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      color:var(--text);
      border-radius:14px;
      padding: 12px 14px;
      font-weight:1100;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
    }
    button.primary{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(34,197,94,.28), rgba(34,197,94,.10));
    }
    button:active{ transform: translateY(1px); }
    #start-countdown{
      margin-top:10px;
      font-size:40px;
      font-weight:1200;
      text-align:center;
      letter-spacing:1px;
    }
    .countdown-hidden{ display:none; }

    /* logger badge */
    #logBadge{
      position:fixed;
      left:var(--pad);
      top: calc(var(--safeTop) + 8px + var(--hudH) + 8px);
      z-index:9100;
      display:flex;
      align-items:center;
      gap:8px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.28);
      backdrop-filter: blur(10px);
      color: rgba(148,163,184,.95);
      font-size:11px;
      font-weight:900;
      pointer-events:none;
    }
    #logdot{ width:8px; height:8px; border-radius:50%; background:#9ca3af; }
    #logtext{ white-space:nowrap; }

    /* boss HUD */
    #boss-wrap{
      position:fixed;
      left:50%;
      top: calc(var(--safeTop) + 8px + var(--hudH) + 42px);
      transform: translateX(-50%);
      z-index:9100;
      display:none;
      gap:10px;
      align-items:center;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.28);
      backdrop-filter: blur(10px);
      color: rgba(148,163,184,.95);
      font-size:11px;
      font-weight:1100;
      pointer-events:none;
    }
    #boss-wrap.show{ display:flex; }
    .bossbar{
      width: 150px;
      height:9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(148,163,184,.08);
      overflow:hidden;
      position:relative;
    }
    #boss-fill{
      position:absolute; inset:0 auto 0 0;
      width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(245,158,11,.85));
      border-radius:999px;
    }

    /* summary overlay */
    #sum-overlay{
      position:fixed; inset:0;
      z-index:30000;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      background: rgba(2,6,23,.78);
      backdrop-filter: blur(14px);
    }
    #sum-overlay.show{ display:flex; }
    .sumCard{
      width:min(720px, 100%);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.70);
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      padding: 16px;
    }
    .sumTitle{ font-size:22px; font-weight:1200; margin:0 0 10px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid rgba(148,163,184,.12);
      background: rgba(15,23,42,.32);
      border-radius:18px;
      padding: 12px 12px;
    }
    .stat .k{
      font-size:11px;
      color: rgba(148,163,184,.95);
      font-weight:1100;
      letter-spacing:.08em;
    }
    .stat .v{
      margin-top:6px;
      font-size:26px;
      font-weight:1200;
      line-height:1;
    }
    .sumActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    @media (max-width: 420px){
      .hud-right{ width: min(210px, 52vw); }
      .grid{ grid-template-columns: 1fr; }
      .gj-target{ font-size:52px; }
    }

    /* tiny hidden compat nodes */
    .hha-hidden{ position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; overflow:hidden; opacity:0; }
  </style>
</head>

<body>

  <!-- A-Frame bg -->
  <div class="sceneWrap" aria-hidden="true">
    <a-scene embedded renderer="antialias: true; colorManagement: true" vr-mode-ui="enabled: true">
      <a-entity id="gj-camera" camera position="0 1.6 0" look-controls="enabled:true"></a-entity>
      <a-sky color="#050b1a"></a-sky>
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-scene>
  </div>

  <!-- Gameplay DOM layer -->
  <div id="gj-layer" aria-label="GoodJunk gameplay layer"></div>

  <!-- FX -->
  <div id="fx-chroma" aria-hidden="true"></div>

  <!-- boss atk overlays -->
  <div id="atk-ring" aria-hidden="true"></div>
  <div id="atk-laser" aria-hidden="true"></div>

  <!-- crosshair -->
  <div id="aim" aria-hidden="true"></div>

  <!-- HUD TOP -->
  <div id="hud-pill" class="hud-top" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠ Peek HUD 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ">
    <div class="hud-group" style="min-width:0">
      <div class="pill">
        <span class="dot"></span>
        <span style="font-weight:1100;font-size:12px;letter-spacing:.06em;">MODE</span>
        <span style="opacity:.65">‚Ä¢</span>
        <span style="font-weight:1100;font-size:12px;">GOODJUNK</span>
        <span style="opacity:.65">‚Ä¢</span>
        <span id="hud-run-label" style="font-weight:1100;font-size:12px;">PLAY</span>
      </div>
    </div>

    <div class="hud-group">
      <div class="pill"><div class="kv"><div class="label">SCORE</div><div class="big" id="hud-score">0</div></div></div>
      <div class="pill"><div class="kv"><div class="label">COMBO</div><div class="big" id="hud-combo">0</div></div></div>
      <div class="pill"><div class="kv"><div class="label">MISS</div><div class="big" id="hud-miss">0</div></div></div>
    </div>
  </div>

  <!-- meta pills -->
  <div class="hud-meta" aria-hidden="true">
    <div class="meta-pill">DIFF <b id="hud-diff-label">‚Äî</b></div>
    <div class="meta-pill">CH <b id="hud-challenge-label">‚Äî</b></div>
    <div class="meta-pill">TIME <b id="hud-time-label">‚Äî</b></div>
    <div class="meta-pill">MAX <b id="hud-comboMax">0</b></div>
    <div class="meta-pill"><b id="hud-rank">Grade: C</b></div>
  </div>

  <!-- logger badge -->
  <div id="logBadge" aria-hidden="true">
    <span id="logdot"></span>
    <span id="logtext">logger: ‚Äî</span>
  </div>

  <!-- judge label -->
  <div id="hud-judge">&nbsp;</div>

  <!-- fever/shield panel -->
  <div class="hud-right" id="hud-right" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠ Peek HUD 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ">
    <div class="card">
      <div class="row">
        <h4>üî• FEVER</h4>
        <div class="pct" id="fever-pct">0%</div>
      </div>
      <div class="bar"><i id="fever-fill"></i></div>
      <div id="hud-stun">‚ö° STUN</div>
    </div>

    <div class="card">
      <div class="row">
        <h4>üõ°Ô∏è SHIELD</h4>
        <div id="shield-count">0</div>
      </div>
      <div style="margin-top:8px; display:flex; gap:10px; justify-content:flex-end;">
        <button id="btn-vr" style="padding:9px 10px; border-radius:14px; font-weight:1100;">Enter VR</button>
      </div>
    </div>
  </div>

  <!-- boss HUD -->
  <div id="boss-wrap">
    <span style="opacity:.85">BOSS</span>
    <div class="bossbar"><i id="boss-fill"></i></div>
    <span id="boss-phase">P1</span>
  </div>

  <!-- coach bubble -->
  <div id="coach-bubble" aria-live="polite">
    <img id="hud-coach-img" src="./img/coach-neutral.png" alt="coach" />
    <div id="hud-coach">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏¢‡∏∞‡∏ô‡∏∞ üí™</div>
  </div>

  <!-- quest HUD bottom -->
  <div class="hud-bottom" id="hud-quest-wrap" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠ peek 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ">
    <div class="qtitle" id="hud-goal">Goal: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‚Ä¶</div>
    <div class="qline">
      <div class="qbar"><i id="hud-goal-bar"></i></div>
      <div class="qcap" id="hud-goal-prog"></div>
    </div>

    <div style="height:8px"></div>

    <div class="qtitle" id="hud-mini">Mini: ‚Äî</div>
    <div class="qline">
      <div class="qbar"><i id="hud-mini-bar"></i></div>
      <div class="qcap" id="hud-mini-prog"></div>
    </div>

    <div id="hud-quest-hint"></div>
    <div id="hud-mini-count"></div>
  </div>

  <!-- START overlay -->
  <div id="start-overlay">
    <div class="startCard">
      <h1 class="startTitle">GoodJunk VR ü•¶üóëÔ∏è</h1>
      <p id="start-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å + ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡∏ô‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚úÖ</p>

      <div class="controls">
        <select id="sel-diff" aria-label="difficulty">
          <option value="easy">easy</option>
          <option value="normal" selected>normal</option>
          <option value="hard">hard</option>
        </select>

        <select id="sel-challenge" aria-label="challenge">
          <option value="rush" selected>rush</option>
          <option value="boss">boss</option>
          <option value="survival">survival</option>
        </select>
      </div>

      <div class="btnRow">
        <button id="btn-start-2d" class="primary">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (2D)</button>
        <button id="btn-start-vr">ü•Ω ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (VR)</button>
      </div>

      <div id="start-countdown" class="countdown-hidden">3</div>
    </div>
  </div>

  <!-- SUMMARY overlay -->
  <div id="sum-overlay" aria-hidden="true">
    <div class="sumCard">
      <div class="sumTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>

      <div class="grid">
        <div class="stat"><div class="k">GRADE</div><div class="v" id="sum-grade">C</div></div>
        <div class="stat"><div class="k">SCORE</div><div class="v" id="sum-score">0</div></div>
        <div class="stat"><div class="k">COMBO MAX</div><div class="v" id="sum-combo">0</div></div>
        <div class="stat"><div class="k">GOOD HITS</div><div class="v" id="sum-good">0</div></div>
        <div class="stat"><div class="k">MISS</div><div class="v" id="sum-miss">0</div></div>
        <div class="stat"><div class="k">QUESTS</div><div class="v" id="sum-quests">0/0</div></div>
      </div>

      <div class="sumActions">
        <button id="btn-exit">‚Ü©Ô∏è ‡πÄ‡∏°‡∏ô‡∏π</button>
        <button id="btn-replay" class="primary">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- hidden compat nodes for hha-hud.js -->
  <div class="hha-hidden">
    <span id="hud-time">0</span>
    <span id="hud-shield">0</span>
    <span id="hud-group">‚Äî</span>
  </div>

  <!-- Layout helper + OFFSET + AIMPOINT + HUD glue -->
  <script>
    (function(){
      const body = document.body;

      const layer = document.getElementById('gj-layer');
      const aim = document.getElementById('aim');

      const qWrap = document.getElementById('hud-quest-wrap');
      const top = document.getElementById('hud-pill');
      const right = document.getElementById('hud-right');

      const b2d = document.getElementById('btn-start-2d');
      const bvr = document.getElementById('btn-start-vr');

      // meta
      const elDiff = document.getElementById('hud-diff-label');
      const elCh   = document.getElementById('hud-challenge-label');
      const elTimeLabel = document.getElementById('hud-time-label');
      const elComboMax = document.getElementById('hud-comboMax');

      // judge
      const elJudge = document.getElementById('hud-judge');

      // quest bars + captions
      const goalBar = document.getElementById('hud-goal-bar');
      const miniBar = document.getElementById('hud-mini-bar');

      // shield display (ui-fever may also set it; we keep in sync)
      const shieldCount = document.getElementById('shield-count');
      const hudShield = document.getElementById('hud-shield');
      const hudTime = document.getElementById('hud-time');

      // boss HUD
      const bossWrap = document.getElementById('boss-wrap');
      const bossFill = document.getElementById('boss-fill');
      const bossPhase = document.getElementById('boss-phase');

      // summary
      const sumOverlay = document.getElementById('sum-overlay');
      const sumGrade = document.getElementById('sum-grade');
      const sumScore = document.getElementById('sum-score');
      const sumCombo = document.getElementById('sum-combo');
      const sumGood  = document.getElementById('sum-good');
      const sumMiss  = document.getElementById('sum-miss');
      const sumQuests= document.getElementById('sum-quests');
      const btnExit  = document.getElementById('btn-exit');
      const btnReplay= document.getElementById('btn-replay');

      // compact peek
      function peek(){
        body.classList.add('hha-peek');
        clearTimeout(window.__hhaPeekT);
        window.__hhaPeekT = setTimeout(()=> body.classList.remove('hha-peek'), 2000);
      }
      if (qWrap) qWrap.addEventListener('click', peek, { passive:true });
      if (top) top.addEventListener('click', peek, { passive:true });
      if (right) right.addEventListener('click', peek, { passive:true });

      function makeCompact(){
        body.classList.add('hha-compact');
        peek();
      }
      if (b2d) b2d.addEventListener('click', makeCompact, { passive:true });
      if (bvr) bvr.addEventListener('click', makeCompact, { passive:true });

      // ‚úÖ restart/menu-safe start overlay control
      let startedOnce = false;

      function showStartOverlay(){
        const start = document.getElementById('start-overlay');
        if (start) start.style.display = 'flex';
        startedOnce = false; // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô overlay ‡πÑ‡∏î‡πâ
      }
      function hideStartOverlay(){
        const start = document.getElementById('start-overlay');
        if (start) start.style.display = 'none';
      }

      window.addEventListener('hha:end', ()=> {
        body.classList.remove('hha-compact');
        body.classList.remove('hha-peek');
        startedOnce = true; // ‚úÖ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π/‡∏£‡∏µ‡πÄ‡∏û‡∏•‡∏¢‡πå
      });

      // layer offset (mobile safe)
      function refreshLayerOffset(){
        try{
          const r = layer.getBoundingClientRect();
          window.__GJ_LAYER_OFFSET__ = { x: r.left, y: r.top };
        }catch(e){}
      }

      // aim point for crosshair hit-test
      function refreshAimPoint(){
        try{
          const r = aim.getBoundingClientRect();
          window.__GJ_AIM_POINT__ = { x: (r.left + r.width/2)|0, y: (r.top + r.height/2)|0 };
        }catch(e){}
      }

      function refreshAll(){
        refreshLayerOffset();
        refreshAimPoint();
      }
      refreshAll();

      window.addEventListener('resize', refreshAll, { passive:true });
      window.addEventListener('scroll',  refreshAll, { passive:true });
      window.addEventListener('orientationchange', refreshAll, { passive:true });
      if (window.visualViewport){
        window.visualViewport.addEventListener('resize', refreshAll, { passive:true });
        window.visualViewport.addEventListener('scroll', refreshAll, { passive:true });
      }

      // fill meta from selectors (boot will also do its own; we just keep UI consistent)
      const selDiff = document.getElementById('sel-diff');
      const selCh = document.getElementById('sel-challenge');
      function syncMetaFromSel(){
        if (elDiff && selDiff) elDiff.textContent = (selDiff.value || '‚Äî');
        if (elCh && selCh) elCh.textContent = (selCh.value || '‚Äî');
      }
      if (selDiff) selDiff.addEventListener('change', syncMetaFromSel, { passive:true });
      if (selCh) selCh.addEventListener('change', syncMetaFromSel, { passive:true });
      syncMetaFromSel();

      // judge
      function showJudge(text){
        if (!elJudge) return;
        elJudge.textContent = text || '';
        elJudge.classList.add('show');
        clearTimeout(window.__gjJudgeT);
        window.__gjJudgeT = setTimeout(()=> elJudge.classList.remove('show'), 650);
      }
      window.addEventListener('hha:judge', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        showJudge(String(d.label || ''));
      });

      // fx overlay (optional)
      const fx = document.getElementById('fx-chroma');
      function fxChroma(ms=160, hero=false){
        if (!fx) return;
        fx.classList.toggle('hero', !!hero);
        fx.classList.add('show');
        clearTimeout(window.__fxT);
        window.__fxT = setTimeout(()=> fx.classList.remove('show','hero'), Math.max(60, ms|0));
      }
      function fxKick(intensity=1){
        const k = Math.max(0.2, Math.min(2.6, Number(intensity)||1));
        body.animate([
          { transform:'translate3d(0,0,0)' },
          { transform:`translate3d(${(Math.random()*2-1)*6*k}px, ${(Math.random()*2-1)*5*k}px, 0)` },
          { transform:'translate3d(0,0,0)' }
        ], { duration: 120, iterations: 1, easing:'ease-out' });
      }
      window.addEventListener('hha:fx', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        const t = String(d.type||'');
        if (t==='chroma') fxChroma(d.ms||160, false);
        if (t==='hero') fxChroma(d.ms||220, true);
        if (t==='kick') fxKick(d.intensity||1);
      });

      // quest bars
      function pct(cur, target){
        cur = Number(cur)||0; target = Number(target)||0;
        if (target <= 0) return 0;
        return Math.max(0, Math.min(100, (cur/target)*100));
      }
      window.addEventListener('quest:update', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        // use either object form or flat fallback
        const g = d.goal || null;
        const m = d.mini || null;

        const gCur = (g ? (g.cur ?? g.prog ?? 0) : (d.goalCur ?? 0));
        const gTgt = (g ? (g.target ?? 0) : (d.goalTarget ?? 0));
        const mCur = (m ? (m.cur ?? m.prog ?? 0) : (d.miniCur ?? 0));
        const mTgt = (m ? (m.target ?? 0) : (d.miniTarget ?? 0));

        if (goalBar) goalBar.style.width = pct(gCur, gTgt).toFixed(1) + '%';
        if (miniBar) miniBar.style.width = pct(mCur, mTgt).toFixed(1) + '%';
      });

      // time sync: hha-hud.js updates #hud-time, we mirror into meta
      window.addEventListener('hha:time', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        const sec = (d.left ?? d.sec ?? d.timeLeft ?? 0) | 0;
        if (hudTime) hudTime.textContent = String(Math.max(0, sec));
        if (elTimeLabel) elTimeLabel.textContent = String(Math.max(0, sec));
      });

      // score sync extras
      window.addEventListener('hha:score', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};

        // combo max
        if (elComboMax && d.comboMax != null) elComboMax.textContent = String(d.comboMax|0);

        // shield count (keep in sync even if hha-hud.js doesn't have #hud-shield visible)
        if (d.shield != null){
          const v = String(d.shield|0);
          if (hudShield) hudShield.textContent = v;
          if (shieldCount) shieldCount.textContent = v;
        }

        // boss HUD
        const alive = !!d.bossAlive;
        if (bossWrap){
          bossWrap.classList.toggle('show', alive);
          if (alive){
            const hp = Math.max(0, (d.bossHp|0));
            const hpMax = Math.max(1, (d.bossHpMax|0));
            const w = Math.max(0, Math.min(100, (hp/hpMax)*100));
            if (bossFill) bossFill.style.width = w.toFixed(1) + '%';
            if (bossPhase) bossPhase.textContent = 'P' + String(d.bossPhase|0 || 1);
          }
        }
      });

      // Enter VR (best-effort)
      const btnVR = document.getElementById('btn-vr');
      if (btnVR){
        btnVR.addEventListener('click', ()=>{
          try{
            const scene = document.querySelector('a-scene');
            if (scene && scene.enterVR) scene.enterVR();
          }catch(e){}
        });
      }

      // end summary
      window.addEventListener('hha:end', (ev)=>{
        const d = ev && ev.detail ? ev.detail : {};
        if (!sumOverlay) return;

        sumGrade.textContent = String((d.grade || 'C')).toUpperCase();
        sumScore.textContent = String(d.scoreFinal ?? d.score ?? 0);
        sumCombo.textContent = String(d.comboMax ?? 0);
        sumGood.textContent  = String(d.goodHits ?? 0);
        sumMiss.textContent  = String(d.misses ?? 0);

        const gC = (d.goalsCleared ?? 0)|0, gT = (d.goalsTotal ?? 0)|0;
        const mC = (d.miniCleared  ?? 0)|0, mT = (d.miniTotal  ?? 0)|0;
        const done = gC + mC, tot = gT + mT;
        sumQuests.textContent = String(done) + '/' + String(tot);

        sumOverlay.classList.add('show');
      });

      // summary actions
      function closeSummary(){
        if (sumOverlay) sumOverlay.classList.remove('show');
      }
      if (btnExit) btnExit.addEventListener('click', ()=>{
        closeSummary();
        showStartOverlay(); // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï startedOnce ‡∏î‡πâ‡∏ß‡∏¢
      });

      if (btnReplay) btnReplay.addEventListener('click', ()=>{
        // simplest: reload (keeps query params)
        location.reload();
      });

      // hide start overlay when game actually starts (best-effort: first score event)
      window.addEventListener('hha:score', ()=>{
        if (startedOnce) return;
        startedOnce = true;
        hideStartOverlay();
      });

    })();
  </script>

</body>
</html>