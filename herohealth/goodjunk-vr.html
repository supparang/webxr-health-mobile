<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
  <title>ü•¶ Good vs Junk VR ‚Äî Hero Health</title>
  <meta name="color-scheme" content="dark light"/>

  <link rel="icon" href="./favicon.ico" type="image/x-icon"/>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡πá‡∏Å ‡πÜ ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ ‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö inline CSS ‡πÑ‡∏î‡πâ -->
  <link rel="stylesheet" href="./css/hha-kid-bg.css"/>

  <style>
    :root{
      color-scheme: dark light;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      overflow:hidden;
      font-family:'IBM Plex Sans Thai',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡πá‡∏Å ‡∏õ.5 ‚Äî ‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• + ‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡∏° ‡πÜ */
      background:
        radial-gradient(circle at 0% 0%, #e0f2fe 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #fee2e2 0, transparent 55%),
        radial-gradient(circle at 0% 100%, #dcfce7 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #fef9c3 0, transparent 55%),
        #020617;
      color:#e5e7eb;
    }

    a-scene{
      position:fixed !important;
      inset:0;
    }

    /* ===== TOP HUD ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/‡∏û‡∏•‡∏≤‡∏î ===== */
    #hhaHudVR{
      position:fixed;
      left:12px;
      top:12px;
      z-index:950;
      padding:8px 12px;
      border-radius:18px;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.95);
      color:#e5e7eb;
      font:600 13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;
      box-shadow:0 14px 40px rgba(15,23,42,.9);
      backdrop-filter:blur(8px);
      min-width:160px;
    }
    #hhaHudVR .line{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-bottom:2px;
    }
    #hhaHudVR .line:last-child{ margin-bottom:0; }
    #hhaHudVR .big{ font-size:15px; }
    #hhaHudVR .pill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(56,189,248,.15);
    }
    #hhaHudVR .bad{ color:#fecaca; }

    @media (max-width:640px){
      #hhaHudVR{
        left:8px;
        top:8px;
        padding:6px 9px;
        font-size:12px;
      }
      #hhaHudVR .big{ font-size:13px; }
    }

    /* ===== ‡πÅ‡∏ñ‡∏ö Fever (‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô) + Mission & Mini Quest ===== */
    #hhaFeverBarWrap{
      position:fixed;
      left:50%;
      top:10px;
      transform:translateX(-50%);
      width:min(640px,90vw);
      padding:6px 10px 0;
      z-index:940;
    }
    #hhaFeverTrack{
      width:100%;
      height:10px;
      border-radius:999px;
      background:rgba(15,23,42,.75);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 10px 24px rgba(15,23,42,.8);
      overflow:hidden;
    }
    #hhaFeverFill{
      width:0%;
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#f97316,#ef4444);
      transition:width .18s ease-out;
    }
    #missionPanel{
      margin-top:6px;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.85);
      color:#e5e7eb;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:0 12px 30px rgba(15,23,42,.85);
    }
    #missionTitle{
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    #missionTitle span.icon{
      font-size:14px;
    }
    #missionGoal,#missionMini{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    @media (max-width:640px){
      #hhaFeverBarWrap{
        top:8px;
        padding:4px 8px 0;
      }
      #missionPanel{
        font-size:11px;
      }
    }

    /* ===== UI Overlay (Start + Result) ===== */
    #uiOverlay{
      position:fixed;
      inset:0;
      z-index:10000;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      padding:16px;
      text-align:center;
      color:#0f172a;
      transition:opacity .28s ease, visibility .28s ease;
    }
    #uiOverlay::before,
    #uiOverlay::after{
      content:"";
      position:absolute;
      inset:12%;
      border-radius:32px;
      background:
        radial-gradient(circle at 10% 20%, rgba(56,189,248,.25) 0, transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,.25) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(251,146,60,.25) 0, transparent 55%);
      filter:blur(2px);
      z-index:-2;
    }
    #uiOverlay::after{
      inset:20%;
      background:
        radial-gradient(circle at 0% 100%, rgba(129,140,248,.28) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(248,250,252,.5) 0, transparent 50%);
      opacity:.9;
    }
    #uiOverlay.hidden{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .ui-card{
      position:relative;
      max-width:520px;
      width:100%;
      padding:20px 20px 18px;
      border-radius:24px;
      background:rgba(15,23,42,.88);
      border:1px solid rgba(148,163,184,.9);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      color:#e5e7eb;
      backdrop-filter:blur(14px);
    }
    .ui-card h1{
      margin:0 0 6px;
      font-size:1.8rem;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.35em;
    }
    .ui-card h1 span.small{
      font-size:1.1rem;
      font-weight:400;
      opacity:.9;
    }
    .ui-card p{
      margin:4px 0 14px;
      font-size:.95rem;
      opacity:.9;
    }

    .kid-chip-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      font-size:.8rem;
      margin-bottom:10px;
    }
    .kid-chip{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.6);
      display:flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      margin-top:6px;
    }
    .game-button{
      font-family:'IBM Plex Sans Thai',system-ui;
      font-weight:700;
      font-size:.95rem;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      color:#f9fafb;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 10px 25px rgba(34,197,94,.45);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .game-button span.lvl{
      padding:1px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      font-size:.75rem;
    }
    .game-button:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
      box-shadow:0 16px 32px rgba(34,197,94,.55);
    }
    .game-button.hard{
      background:linear-gradient(135deg,#f97316,#ef4444);
      box-shadow:0 10px 25px rgba(239,68,68,.55);
    }

    #resultsScreen h2{
      margin:0 0 6px;
      font-size:1.5rem;
      color:#fbbf24;
    }
    #finalScore{
      margin:4px 0 4px;
      font-size:1.8rem;
      color:#f9fafb;
    }
    #gradeText{
      margin:4px 0 10px;
      font-size:1.1rem;
      color:#a5b4fc;
    }
    .result-line{
      font-size:.9rem;
      opacity:.9;
      margin-bottom:2px;
    }

    @media (max-width:600px){
      .ui-card{
        padding:16px 14px 14px;
        border-radius:20px;
      }
      .ui-card h1{
        font-size:1.45rem;
      }
      .ui-card p{
        font-size:.9rem;
      }
      .game-button{
        width:100%;
        justify-content:center;
      }
    }

    /* ===== Grade Bar ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ===== */
    #gradeBarWrap{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(680px,94vw);
      z-index:930;
      font-size:12px;
      color:#e5e7eb;
    }
    #gradeBarLabel{
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    #gradeBarLabel span.grade{
      font-weight:600;
      color:#facc15;
    }
    #gradeBarTrack{
      position:relative;
      width:100%;
      height:16px;
      border-radius:999px;
      background:linear-gradient(90deg,#4b5563,#22c55e,#f97316,#ec4899,#a855f7);
      overflow:hidden;
      box-shadow:0 10px 30px rgba(15,23,42,.9);
    }
    #gradeBarCursor{
      position:absolute;
      top:0;
      bottom:0;
      width:4px;
      border-radius:999px;
      background:#f9fafb;
      box-shadow:0 0 0 2px rgba(15,23,42,.9);
      transform:translateX(-50%);
    }
    #gradeBarTicks{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:1px 8px 0;
      font-size:9px;
      color:#f9fafb;
      text-shadow:0 1px 2px rgba(15,23,42,.9);
      pointer-events:none;
    }

    /* ===== ‡∏õ‡∏∏‡πà‡∏° VR ‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ ===== */
    #vrBtn{
      position:fixed;
      right:12px;
      bottom:14px;
      z-index:940;
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:.9rem;
      font-weight:600;
      background:rgba(15,23,42,.92);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      box-shadow:0 12px 32px rgba(15,23,42,.9);
    }
    #vrBtn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    @media (max-width:640px){
      #vrBtn{
        bottom:10px;
        right:10px;
      }
      #gradeBarWrap{
        bottom:44px;
      }
    }
  </style>
</head>
<body>

  <!-- ===== Fever + Mission/Mini HUD ===== -->
  <div id="hhaFeverBarWrap">
    <div id="hhaFeverTrack">
      <div id="hhaFeverFill"></div>
    </div>
    <div id="missionPanel">
      <div id="missionTitle">
        <span class="icon">üéØ</span>
        <span>Mission &amp; Mini Quest</span>
      </div>
      <div id="missionGoal">Goal: -</div>
      <div id="missionMini">Mini Quest: -</div>
    </div>
  </div>

  <!-- ===== HUD ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/‡∏û‡∏•‡∏≤‡∏î ===== -->
  <div id="hhaHudVR">
    <div class="line big">
      <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="hudScoreVR">0</span></span>
      <span class="pill">‡πÄ‡∏ß‡∏•‡∏≤: <span id="hudTimeVR">60</span>s</span>
    </div>
    <div class="line">
      <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: <span id="hudComboVR">0</span></span>
      <span>‡∏û‡∏•‡∏≤‡∏î: <span id="hudMissVR" class="bad">0</span></span>
    </div>
  </div>

  <!-- ===== Grade Bar ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ===== -->
  <div id="gradeBarWrap">
    <div id="gradeBarLabel">
      <span>‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="gradeNow" class="grade">-</span></span>
      <span id="gradeNowScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</span>
    </div>
    <div id="gradeBarTrack">
      <div id="gradeBarCursor" style="left:0%;"></div>
      <div id="gradeBarTicks">
        <span>C</span><span>B</span><span>A</span><span>S</span><span>SS</span><span>SSS</span>
      </div>
    </div>
  </div>

  <!-- ===== ‡∏õ‡∏∏‡πà‡∏° VR ===== -->
  <button id="vrBtn">VR ‚ñ∂</button>

  <!-- ===== UI Overlay (Start + Result) ===== -->
  <div id="uiOverlay">
    <div id="startScreen" class="ui-card">
      <h1>ü•¶ Good vs Junk VR <span class="small">Hero Health</span></h1>
      <p>
        ‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏¢‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡∏Å‡∏±‡∏ö ‚Äú‡∏û‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏õ‚Äù ‚≠êüíé<br/>
        ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞ üçüüç© ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
      </p>

      <div class="kid-chip-row">
        <div class="kid-chip">üçé ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ú‡∏±‡∏Å‚Äì‡∏ú‡∏•‡πÑ‡∏°‡πâ‚Äì‡∏ô‡∏° ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ</div>
        <div class="kid-chip">‚è± ‡πÄ‡∏Å‡∏°‡∏¢‡∏≤‡∏ß ~60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div class="kid-chip">üéØ ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á PC / Mobile / VR Headset</div>
      </div>

      <div class="btn-row">
        <button class="game-button" id="startButtonEasy">
          üå± ‡∏á‡πà‡∏≤‡∏¢
          <span class="lvl">Easy</span>
        </button>
        <button class="game-button" id="startButtonNormal">
          ‚öñÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥
          <span class="lvl">Normal</span>
        </button>
        <button class="game-button hard" id="startButtonHard">
          üî• ‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢
          <span class="lvl">Hard</span>
        </button>
      </div>
    </div>

    <div id="resultsScreen" class="ui-card" style="display:none;">
      <h2>‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
      <h1 id="finalScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</h1>
      <div id="gradeText">‡πÄ‡∏Å‡∏£‡∏î: -</div>

      <div class="result-line" id="resultDetailMain">
        ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏∞ üéØ
      </div>
      <div class="result-line" id="resultDetailCombo"></div>
      <div class="result-line" id="resultDetailMiss"></div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="game-button" id="playAgainButton">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- ===== A-Frame Scene (VR World) ===== -->
  <a-scene id="gameScene"
           renderer="colorManagement: true"
           loading-screen="dotsColor: white; backgroundColor: #0b1222"
           background="color: #020617">

    <!-- Ambient + Directional light -->
    <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.4" position="-0.5 1 1"></a-entity>

    <!-- Player Rig -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="camera" look-controls="pointerLockEnabled: true">
        <!-- Cursor ‡πÅ‡∏ö‡∏ö ring ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gaze/VR -->
        <a-cursor id="cursor"
                  raycaster="objects: [data-hha-tgt]; interval: 50"
                  fuse="true"
                  fuse-timeout="900"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.018"
                  material="color: #ffffff; shader: flat; opacity: 0.95"
                  position="0 0 -1">
        </a-cursor>
      </a-camera>

      <!-- Right-hand controller (VR) -->
      <a-entity id="rightHand"
                laser-controls="hand: right"
                raycaster="objects: [data-hha-tgt]; interval: 30">
      </a-entity>
    </a-entity>

  </a-scene>

  <!-- ===== HUD Script (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏û‡∏•‡∏≤‡∏î + Grade ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå) ===== -->
  <script>
  (function(){
    'use strict';

    const HUD_ID = 'hhaHudVR';
    const GAME_SECONDS = 60;

    const wrap   = document.getElementById(HUD_ID);
    const scoreEl= document.getElementById('hudScoreVR');
    const comboEl= document.getElementById('hudComboVR');
    const missEl = document.getElementById('hudMissVR');
    const timeEl = document.getElementById('hudTimeVR');

    const gradeNowEl   = document.getElementById('gradeNow');
    const gradeScoreEl = document.getElementById('gradeNowScore');
    const gradeCursor  = document.getElementById('gradeBarCursor');

    const feverFill = document.getElementById('hhaFeverFill');

    let timerId = null;
    let runningTimer = false;
    let timeLeft = GAME_SECONDS;

    function computeGrade(score){
      const s = score|0;
      if (s >= 1800) return 'SSS';
      if (s >= 1500) return 'SS';
      if (s >= 1200) return 'S';
      if (s >= 900)  return 'A';
      if (s >= 600)  return 'B';
      return 'C';
    }
    function gradePos(grade){
      switch(grade){
        case 'C':  return 5;
        case 'B':  return 22;
        case 'A':  return 40;
        case 'S':  return 60;
        case 'SS': return 78;
        case 'SSS':return 95;
        default:   return 5;
      }
    }

    function startTimer(sec){
      if (timerId) clearInterval(timerId);
      timeLeft = sec || GAME_SECONDS;
      timeEl.textContent = timeLeft;
      runningTimer = true;

      timerId = setInterval(function(){
        if (!runningTimer) return;
        timeLeft--;
        if (timeLeft < 0) timeLeft = 0;
        timeEl.textContent = timeLeft;
        if (timeLeft <= 0){
          clearInterval(timerId);
          timerId = null;
          runningTimer = false;
        }
      }, 1000);
    }

    function stopTimer(){
      runningTimer = false;
      if (timerId){
        clearInterval(timerId);
        timerId = null;
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏à‡∏≤‡∏Å launcher)
    window.addEventListener('hha:start', function(e){
      const d = (e && e.detail) || {};
      const dur = d.duration || GAME_SECONDS;
      startTimer(dur);
      scoreEl.textContent = '0';
      comboEl.textContent = '0';
      missEl.textContent  = '0';
      gradeNowEl.textContent = '-';
      gradeScoreEl.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
      gradeCursor.style.left = '5%';
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/Fever
    window.addEventListener('hha:score', function(e){
      const d = (e && e.detail) || {};
      if (typeof d.score === 'number') {
        scoreEl.textContent = d.score|0;
        const grade = computeGrade(d.score|0);
        gradeNowEl.textContent = grade;
        gradeScoreEl.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + (d.score|0);
        gradeCursor.style.left = gradePos(grade) + '%';
      } else if (typeof window.score === 'number') {
        const s = window.score|0;
        scoreEl.textContent = s;
        const grade = computeGrade(s);
        gradeNowEl.textContent = grade;
        gradeScoreEl.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + s;
        gradeCursor.style.left = gradePos(grade) + '%';
      }

      if (typeof d.combo === 'number') comboEl.textContent = d.combo|0;
      else if (typeof window.combo === 'number') comboEl.textContent = window.combo|0;

      if (!runningTimer) startTimer(GAME_SECONDS);
    });

    // ‡πÄ‡∏ß‡∏•‡∏≤ miss (‡∏ï‡∏µ‡πÇ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞)
    window.addEventListener('hha:miss', function(){
      if (typeof window.misses === 'number'){
        missEl.textContent = window.misses|0;
      }
      if (typeof window.combo === 'number'){
        comboEl.textContent = window.combo|0;
      }
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Fever bar
    window.addEventListener('hha:fever', function(e){
      const d = (e && e.detail) || {};
      if (typeof d.value === 'number'){
        const pct = Math.max(0, Math.min(100, d.value));
        feverFill.style.width = pct + '%';
      } else if (d.state === 'start'){
        feverFill.style.width = '100%';
      } else if (d.state === 'end'){
        feverFill.style.width = '0%';
      }
    });

    // ‡πÄ‡∏Å‡∏°‡∏à‡∏ö
    window.addEventListener('hha:end', function(e){
      const d = (e && e.detail) || {};
      if (typeof d.score === 'number'){
        scoreEl.textContent = d.score|0;
        const grade = computeGrade(d.score|0);
        gradeNowEl.textContent = grade;
        gradeScoreEl.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + (d.score|0);
        gradeCursor.style.left = gradePos(grade) + '%';
      } else if (typeof window.score === 'number'){
        const s = window.score|0;
        scoreEl.textContent = s;
        const grade = computeGrade(s);
        gradeNowEl.textContent = grade;
        gradeScoreEl.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + s;
        gradeCursor.style.left = gradePos(grade) + '%';
      }
      stopTimer();
    });

    window.addEventListener('beforeunload', stopTimer);
  })();
  </script>

  <!-- ===== Mission & Mini Quest Panel Script ===== -->
  <script>
  (function(){
    'use strict';
    const goalEl = document.getElementById('missionGoal');
    const miniEl = document.getElementById('missionMini');

    function renderLine(kind, obj){
      if (!obj) return kind + ': -';
      const label = obj.label || obj.title || '-';
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ progress/target ‡∏Å‡πá‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô (x/y)
      const cur = obj.current ?? obj.cur ?? obj.progress ?? null;
      const max = obj.target ?? obj.max ?? null;
      if (cur !== null && max !== null){
        return kind + ': ' + label + ' (' + cur + '/' + max + ')';
      }
      return kind + ': ' + label;
    }

    window.addEventListener('quest:update', function(e){
      const d = (e && e.detail) || {};
      goalEl.textContent = renderLine('Goal', d.goal || null);
      miniEl.textContent = renderLine('Mini Quest', d.mini || null);
    });
  })();
  </script>

  <!-- ===== Launcher + Cloud Logger (ES Module) ===== -->
  <script type="module">
    import { GameEngineVR } from './vr-goodjunk/game-engine-goodjunk-vr.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£ log ‡πÑ‡∏õ Google Sheet ‡∏ú‡πà‡∏≤‡∏ô Apps Script
    initCloudLogger({
      endpoint: 'https://script.google.com/macros/s/AKfycbxNor4osZ3NI_pGtYd8hGlwyMRTF9J2I4kCFiHUO-G_4VBj2ZqtTXiqsFU8KWDqRSTQ/exec',
      projectTag: 'HeroHealth-GoodJunkVR',
      debug: true
    });

    const uiOverlay     = document.getElementById('uiOverlay');
    const startScreen   = document.getElementById('startScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const finalScoreEl  = document.getElementById('finalScore');
    const gradeTextEl   = document.getElementById('gradeText');
    const resultComboEl = document.getElementById('resultDetailCombo');
    const resultMissEl  = document.getElementById('resultDetailMiss');

    const btnEasy   = document.getElementById('startButtonEasy');
    const btnNormal = document.getElementById('startButtonNormal');
    const btnHard   = document.getElementById('startButtonHard');
    const btnAgain  = document.getElementById('playAgainButton');
    const vrBtn     = document.getElementById('vrBtn');
    const sceneEl   = document.getElementById('gameScene');

    const GAME_DURATION_MS = 60000;
    const GAME_DURATION_SEC = 60;
    let gameTimer = null;
    let currentDifficulty = 'normal';

    function computeGrade(score){
      const s = score|0;
      if (s >= 1800) return 'SSS';
      if (s >= 1500) return 'SS';
      if (s >= 1200) return 'S';
      if (s >= 900)  return 'A';
      if (s >= 600)  return 'B';
      return 'C';
    }

    function hideOverlay(){
      uiOverlay.classList.add('hidden');
    }
    function showStart(){
      resultsScreen.style.display = 'none';
      startScreen.style.display   = 'block';
      uiOverlay.classList.remove('hidden');
    }
    function showResult(score, extra = {}){
      startScreen.style.display   = 'none';
      resultsScreen.style.display = 'block';
      uiOverlay.classList.remove('hidden');

      const s = score|0;
      const grade = computeGrade(s);

      finalScoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${s}`;
      gradeTextEl.textContent  = `‡πÄ‡∏Å‡∏£‡∏î: ${grade}`;

      if (typeof extra.comboMax === 'number'){
        resultComboEl.textContent = `‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: x${extra.comboMax|0}`;
      }else{
        resultComboEl.textContent = '';
      }
      if (typeof extra.misses === 'number'){
        resultMissEl.textContent = `‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${extra.misses|0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
      }else{
        resultMissEl.textContent = '';
      }
    }

    function clearGameTimer(){
      if (gameTimer){
        clearTimeout(gameTimer);
        gameTimer = null;
      }
    }

    function startGame(diff){
      currentDifficulty = diff || 'normal';
      clearGameTimer();

      hideOverlay();

      // ‡πÅ‡∏à‡πâ‡∏á HUD ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
      window.dispatchEvent(new CustomEvent('hha:start', {
        detail:{ duration: GAME_DURATION_SEC, difficulty: currentDifficulty }
      }));

      GameEngineVR.start(currentDifficulty);

      gameTimer = setTimeout(()=>{
        GameEngineVR.stop();
        const score  = (window.score|0)   || 0;
        const comboM = (window.comboMax|0)|| 0;
        const miss   = (window.misses|0)  || 0;
        showResult(score, { comboMax: comboM, misses: miss });
      }, GAME_DURATION_MS);
    }

    btnEasy  .addEventListener('click', ()=> startGame('easy'));
    btnNormal.addEventListener('click', ()=> startGame('normal'));
    btnHard  .addEventListener('click', ()=> startGame('hard'));

    btnAgain.addEventListener('click', ()=>{
      resultsScreen.style.display = 'none';
      startScreen.style.display   = 'block';
    });

    // ‡∏õ‡∏∏‡πà‡∏° VR ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å enterVR ‡∏Ç‡∏≠‡∏á scene
    vrBtn.addEventListener('click', ()=>{
      if (sceneEl && sceneEl.enterVR) sceneEl.enterVR();
    });

    // ‡∏ñ‡πâ‡∏≤ Engine ‡∏¢‡∏¥‡∏á hha:end ‡∏°‡∏≤‡πÄ‡∏≠‡∏á
    window.addEventListener('hha:end', (ev)=>{
      clearGameTimer();
      const d = ev && ev.detail ? ev.detail : {};
      const score  = (typeof d.score === 'number')    ? d.score    : ((window.score|0)   || 0);
      const comboM = (typeof d.comboMax === 'number') ? d.comboMax : ((window.comboMax|0)|| 0);
      const miss   = (typeof d.misses === 'number')   ? d.misses   : ((window.misses|0)  || 0);
      showResult(score, { comboMax: comboM, misses: miss });
    });

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå start screen ‡πÄ‡∏•‡∏¢
    showStart();
  </script>

</body>
</html>
