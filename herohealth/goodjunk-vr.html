<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
  <title>ü•¶ Good vs Junk VR ‚Äî Hero Health</title>
  <meta name="color-scheme" content="dark light"/>

  <link rel="icon" href="./favicon.ico" type="image/x-icon"/>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      color-scheme: dark light;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      overflow:hidden;
      font-family:'IBM Plex Sans Thai',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #e0f2fe 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #fee2e2 0, transparent 55%),
        radial-gradient(circle at 0% 100%, #dcfce7 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #fef9c3 0, transparent 55%),
        #020617;
      color:#e5e7eb;
    }

    /* ===== UI Overlay (Start / Result) ===== */
    #uiOverlay{
      position:fixed;
      inset:0;
      z-index:10000;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      padding:16px;
      text-align:center;
      color:#0f172a;
      transition:opacity .28s ease, visibility .28s ease;
    }
    #uiOverlay::before,
    #uiOverlay::after{
      content:"";
      position:absolute;
      inset:12%;
      border-radius:32px;
      background:
        radial-gradient(circle at 10% 20%, rgba(56,189,248,.25) 0, transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,.25) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(251,146,60,.25) 0, transparent 55%);
      filter:blur(2px);
      z-index:-2;
    }
    #uiOverlay::after{
      inset:20%;
      background:
        radial-gradient(circle at 0% 100%, rgba(129,140,248,.28) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(248,250,252,.5) 0, transparent 50%);
      opacity:.9;
    }
    #uiOverlay.hidden{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }

    .ui-card{
      position:relative;
      max-width:640px;
      width:100%;
      padding:22px 22px 18px;
      border-radius:28px;
      background:rgba(15,23,42,.94);
      border:1px solid rgba(148,163,184,.9);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      color:#e5e7eb;
      backdrop-filter:blur(14px);
    }

    .ui-card h1{
      margin:0 0 8px;
      font-size:2rem;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:.6em;
    }
    .ui-card h1 span.small{
      font-size:1.1rem;
      font-weight:400;
      opacity:.9;
    }
    .ui-subtitle{
      margin:0 0 14px;
      font-size:1rem;
      opacity:.95;
    }

    .kid-chip-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-start;
      gap:8px;
      font-size:.82rem;
      margin-bottom:10px;
    }
    .kid-chip{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.6);
      display:flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-start;
      gap:10px;
      margin-top:10px;
    }
    .game-button{
      font-family:'IBM Plex Sans Thai',system-ui;
      font-weight:700;
      font-size:.95rem;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      color:#f9fafb;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 10px 25px rgba(34,197,94,.45);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .game-button span.lvl{
      padding:1px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      font-size:.75rem;
    }
    .game-button:hover{
      transform:translateY(-1px);
      filter:brightness(1.03);
      box-shadow:0 16px 32px rgba(34,197,94,.55);
    }
    .game-button.hard{
      background:linear-gradient(135deg,#f97316,#ef4444);
      box-shadow:0 10px 25px rgba(239,68,68,.55);
    }

    #resultsScreen h2{
      margin:0 0 6px;
      font-size:1.7rem;
      color:#fbbf24;
      text-align:center;
    }
    #finalScore{
      margin:0 0 8px;
      font-size:2rem;
      color:#f9fafb;
      text-align:center;
    }
    #finalGrade{
      margin:0 0 12px;
      font-size:1.4rem;
      color:#f97316;
      text-align:center;
    }
    .result-line{
      font-size:.95rem;
      opacity:.9;
      margin-bottom:2px;
      text-align:center;
    }

    @media (max-width:640px){
      .ui-card{
        padding:18px 14px 14px;
        border-radius:22px;
      }
      .ui-card h1{
        font-size:1.6rem;
        flex-direction:column;
        align-items:flex-start;
      }
      .ui-subtitle{
        font-size:.95rem;
      }
      .game-button{
        width:100%;
        justify-content:center;
      }
    }

    /* ===== A-Frame Canvas full screen ===== */
    a-scene{
      position:fixed !important;
      inset:0;
    }

    /* ===== HUD ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö/‡∏û‡∏•‡∏≤‡∏î (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô) ===== */
    #hhaHudVR{
      position:fixed;
      left:12px;
      top:12px;
      z-index:950;
      padding:8px 12px;
      border-radius:14px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.95);
      color:#e5e7eb;
      font:600 13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;
      box-shadow:0 14px 40px rgba(15,23,42,.9);
      backdrop-filter:blur(8px);
    }
    #hhaHudVR .line{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-bottom:2px;
    }
    #hhaHudVR .line:last-child{ margin-bottom:0; }
    #hhaHudVR .big{ font-size:15px; }
    #hhaHudVR .pill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(56,189,248,.15);
    }
    #hhaHudVR .bad{ color:#fecaca; }

    @media (max-width:640px){
      #hhaHudVR{
        left:8px;
        top:8px;
        padding:6px 9px;
        font-size:12px;
      }
      #hhaHudVR .big{ font-size:13px; }
    }

    /* ===== Mission & Mini Quest HUD (‡∏ö‡∏ô‡∏Å‡∏•‡∏≤‡∏á) ===== */
    #missionHud{
      position:fixed;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      min-width:260px;
      max-width:520px;
      padding:8px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.9);
      color:#e5e7eb;
      font:600 13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;
      z-index:960;
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:0 16px 40px rgba(15,23,42,.9);
      backdrop-filter:blur(10px);
    }
    #missionHud .title{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      margin-bottom:2px;
    }
    #missionHud .label{
      font-weight:600;
    }
    #missionHud .text{
      font-weight:400;
    }

    @media (max-width:640px){
      #missionHud{
        top:6px;
        padding:6px 10px;
        font-size:12px;
      }
    }

    /* ===== Grade Bar (‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á) ===== */
    #gradeWrap{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      width:min(640px, 94vw);
      z-index:960;
      font-family:'IBM Plex Sans Thai',system-ui;
    }
    #gradeLabel{
      font-size:.9rem;
      color:#e5e7eb;
      margin-bottom:4px;
    }
    #gradeLabel span.grade{
      font-weight:700;
      color:#fbbf24;
    }
    .grade-bar{
      position:relative;
      height:18px;
      border-radius:999px;
      background:linear-gradient(90deg,#9ca3af,#22c55e,#22c55e,#f97316,#ef4444);
      overflow:hidden;
      box-shadow:0 10px 25px rgba(15,23,42,.9);
    }
    #gradeFill{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:5%;
      background:rgba(15,23,42,.15);
      border-right:2px solid #f9fafb;
    }
    .grade-marks{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding:0 8px 2px;
      font-size:.7rem;
      color:#111827;
      text-shadow:0 1px 2px rgba(248,250,252,.7);
      pointer-events:none;
    }

    /* ===== VR Button (‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á) ===== */
    #vrButton{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:970;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      background:rgba(15,23,42,.96);
      color:#f9fafb;
      font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(15,23,42,.9);
    }
    #vrButton span{
      margin-left:4px;
    }

  </style>
</head>
<body>

  <!-- ===== UI Overlay (Start + Result) ===== -->
  <div id="uiOverlay">
    <div id="startScreen" class="ui-card">
      <h1>ü•¶ Good vs Junk VR <span class="small">Hero Health</span></h1>
      <p class="ui-subtitle">
        ‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏¢‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‚Äù ‡∏Å‡∏±‡∏ö ‚Äú‡∏û‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏õ‚Äù ‚≠êüíé<br/>
        ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞ üçüüç© ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
      </p>

      <div class="kid-chip-row">
        <div class="kid-chip">üçé ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ú‡∏±‡∏Å‚Äì‡∏ú‡∏•‡πÑ‡∏°‡πâ‚Äì‡∏ô‡∏° ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ</div>
        <div class="kid-chip">‚è± ‡πÄ‡∏Å‡∏°‡∏¢‡∏≤‡∏ß ~60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div class="kid-chip">üéØ ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á PC / Mobile / VR Headset</div>
      </div>

      <div class="btn-row">
        <button class="game-button" id="startButtonEasy">
          üå± ‡∏á‡πà‡∏≤‡∏¢
          <span class="lvl">Easy</span>
        </button>
        <button class="game-button" id="startButtonNormal">
          ‚öñÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥
          <span class="lvl">Normal</span>
        </button>
        <button class="game-button hard" id="startButtonHard">
          üî• ‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢
          <span class="lvl">Hard</span>
        </button>
      </div>
    </div>

    <div id="resultsScreen" class="ui-card" style="display:none;">
      <h2>‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
      <h1 id="finalScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</h1>
      <div id="finalGrade">‡πÄ‡∏Å‡∏£‡∏î: -</div>

      <div class="result-line" id="resultDetailMain">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏∞ üéØ</div>
      <div class="result-line" id="resultDetailCombo"></div>
      <div class="result-line" id="resultDetailMiss"></div>

      <div class="btn-row" style="margin-top:12px; justify-content:center;">
        <button class="game-button" id="playAgainButton">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- ===== Mission & Mini Quest HUD ===== -->
  <div id="missionHud">
    <div class="title">üéØ Mission &amp; Mini Quest</div>
    <div><span class="label">Goal:</span> <span id="missionGoal" class="text">-</span></div>
    <div><span class="label">Mini Quest:</span> <span id="missionMini" class="text">-</span></div>
  </div>

  <!-- ===== Grade Bar ===== -->
  <div id="gradeWrap">
    <div id="gradeLabel">‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span class="grade">-</span></div>
    <div class="grade-bar">
      <div id="gradeFill"></div>
      <div class="grade-marks">
        <span>C</span><span>B</span><span>A</span><span>S</span><span>SS</span><span>SSS</span>
      </div>
    </div>
  </div>

  <!-- VR Button -->
  <button id="vrButton">VR<span>‚ñ∂</span></button>

  <!-- ===== A-Frame Scene (VR World) ===== -->
  <a-scene id="gameScene"
           renderer="colorManagement: true"
           loading-screen="dotsColor: white; backgroundColor: #0b1222"
           background="color: #020617">

    <!-- Ambient + Directional light -->
    <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.4" position="-0.5 1 1"></a-entity>

    <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô/‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="camera" look-controls="pointerLockEnabled: true">
        <!-- Cursor ‡πÅ‡∏ö‡∏ö ring ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gaze/VR -->
        <a-cursor id="cursor"
                  raycaster="objects: [data-hha-tgt]; interval: 50"
                  fuse="true"
                  fuse-timeout="900"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.018"
                  material="color: #ffffff; shader: flat; opacity: 0.95"
                  position="0 0 -1">
        </a-cursor>
      </a-camera>

      <!-- ‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤ (VR controller) -->
      <a-entity id="rightHand"
                laser-controls="hand: right"
                raycaster="objects: [data-hha-tgt]; interval: 30">
      </a-entity>
    </a-entity>

  </a-scene>

  <!-- ===== HUD Script (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / ‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö / ‡∏û‡∏•‡∏≤‡∏î) ===== -->
  <script>
  (function(){
    'use strict';

    const HUD_ID = 'hhaHudVR';
    const GAME_SECONDS = 60;

    let wrap, scoreEl, comboEl, missEl, timeEl;
    let running = false;
    let timerId = null;

    function createHud(){
      if (wrap && document.getElementById(HUD_ID)) return wrap;

      wrap = document.createElement('div');
      wrap.id = HUD_ID;
      wrap.setAttribute('data-hha-ui','');

      wrap.innerHTML = `
        <div class="line big">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="hudScoreVR">0</span></span>
          <span class="pill">‡πÄ‡∏ß‡∏•‡∏≤: <span id="hudTimeVR">${GAME_SECONDS}</span>s</span>
        </div>
        <div class="line">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: <span id="hudComboVR">0</span></span>
          <span>‡∏û‡∏•‡∏≤‡∏î: <span id="hudMissVR" class="bad">0</span></span>
        </div>
      `;
      document.body.appendChild(wrap);

      scoreEl = document.getElementById('hudScoreVR');
      comboEl = document.getElementById('hudComboVR');
      missEl  = document.getElementById('hudMissVR');
      timeEl  = document.getElementById('hudTimeVR');

      return wrap;
    }

    function startTimer(){
      createHud();
      if (timerId) clearInterval(timerId);
      let left = GAME_SECONDS;
      if (timeEl) timeEl.textContent = left;
      running = true;

      timerId = setInterval(function(){
        if (!running){
          clearInterval(timerId);
          timerId = null;
          return;
        }
        left--;
        if (left < 0) left = 0;
        if (timeEl) timeEl.textContent = left;
        if (left <= 0){
          clearInterval(timerId);
          timerId = null;
          running = false;
        }
      }, 1000);
    }

    function stopTimer(){
      running = false;
      if (timerId){
        clearInterval(timerId);
        timerId = null;
      }
    }

    window.addEventListener('hha:score', function(e){
      const d = (e && e.detail) || {};
      createHud();

      if (typeof d.score === 'number'){
        scoreEl.textContent = d.score;
      } else if (typeof d.total === 'number'){
        scoreEl.textContent = d.total;
      } else if (typeof window.score === 'number'){
        scoreEl.textContent = window.score|0;
      }

      let combo = 0;
      if (typeof d.combo === 'number') combo = d.combo;
      else if (typeof window.combo === 'number') combo = window.combo;
      comboEl.textContent = combo|0;

      if (!running){
        startTimer();
      }
    });

    window.addEventListener('hha:miss', function(){
      createHud();
      if (typeof window.misses === 'number'){
        missEl.textContent = window.misses|0;
      }
      if (typeof window.combo === 'number'){
        comboEl.textContent = window.combo|0;
      }
    });

    window.addEventListener('hha:end', function(e){
      const d = (e && e.detail) || {};
      createHud();
      if (typeof d.score === 'number'){
        scoreEl.textContent = d.score;
      } else if (typeof window.score === 'number'){
        scoreEl.textContent = window.score|0;
      }
      stopTimer();
    });

    window.addEventListener('beforeunload', stopTimer);
  })();
  </script>

  <!-- ===== Launcher + Cloud Logger (ES Module) ===== -->
  <script type="module">
    import { GameEngine } from './vr-goodjunk/GameEngine.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';

    const uiOverlay     = document.getElementById('uiOverlay');
    const startScreen   = document.getElementById('startScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const finalScoreEl  = document.getElementById('finalScore');
    const finalGradeEl  = document.getElementById('finalGrade');
    const resultComboEl = document.getElementById('resultDetailCombo');
    const resultMissEl  = document.getElementById('resultDetailMiss');

    const btnEasy   = document.getElementById('startButtonEasy');
    const btnNormal = document.getElementById('startButtonNormal');
    const btnHard   = document.getElementById('startButtonHard');
    const btnAgain  = document.getElementById('playAgainButton');

    const missionGoalEl = document.getElementById('missionGoal');
    const missionMiniEl = document.getElementById('missionMini');

    const gradeWrap   = document.getElementById('gradeWrap');
    const gradeLabel  = document.querySelector('#gradeLabel .grade');
    const gradeFill   = document.getElementById('gradeFill');

    const vrButton  = document.getElementById('vrButton');
    const sceneEl   = document.getElementById('gameScene');

    const GAME_DURATION_MS = 60_000;
    let gameTimer = null;
    let currentDifficulty = 'normal';

    function hideOverlay(){
      uiOverlay.classList.add('hidden');
    }
    function showStart(){
      resultsScreen.style.display = 'none';
      startScreen.style.display   = 'block';
      uiOverlay.classList.remove('hidden');
    }
    function gradeInfo(score){
      const s = score|0;
      let grade = 'C';
      if (s >= 1700) grade = 'SSS';
      else if (s >= 1400) grade = 'SS';
      else if (s >= 1100) grade = 'S';
      else if (s >= 800)  grade = 'A';
      else if (s >= 500)  grade = 'B';

      const min = 0;
      const max = 1800;
      let pct = (s - min) / (max - min);
      if (pct < 0) pct = 0;
      if (pct > 1) pct = 1;
      return { grade, pct };
    }
    function updateGradeBar(score){
      const info = gradeInfo(score);
      if (gradeLabel) gradeLabel.textContent = info.grade;
      if (gradeFill) gradeFill.style.width = (5 + info.pct * 95) + '%';
    }
    function showResultFromStats(stats){
      const score  = (stats && typeof stats.scoreFinal === 'number')
        ? stats.scoreFinal
        : ((window.score|0) || 0);
      const comboM = (stats && typeof stats.comboMax === 'number')
        ? stats.comboMax
        : ((window.comboMax|0) || 0);
      const miss   = (stats && typeof stats.misses === 'number')
        ? stats.misses
        : ((window.misses|0) || 0);

      const gInfo  = gradeInfo(score);

      startScreen.style.display   = 'none';
      resultsScreen.style.display = 'block';
      uiOverlay.classList.remove('hidden');

      finalScoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score|0}`;
      finalGradeEl.textContent = `‡πÄ‡∏Å‡∏£‡∏î: ${gInfo.grade}`;

      resultComboEl.textContent = `‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: x${comboM|0}`;
      resultMissEl.textContent  = `‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${miss|0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;

      updateGradeBar(score);
    }

    function clearGameTimer(){
      if (gameTimer){
        clearTimeout(gameTimer);
        gameTimer = null;
      }
    }

    function startGame(diff){
      currentDifficulty = diff || 'normal';
      clearGameTimer();

      hideOverlay();
      updateGradeBar(0);

      GameEngine.start(currentDifficulty);

      gameTimer = setTimeout(()=>{
        GameEngine.stop();
      }, GAME_DURATION_MS);
    }

    btnEasy  .addEventListener('click', ()=> startGame('easy'));
    btnNormal.addEventListener('click', ()=> startGame('normal'));
    btnHard  .addEventListener('click', ()=> startGame('hard'));

    btnAgain.addEventListener('click', ()=>{
      resultsScreen.style.display = 'none';
      startScreen.style.display   = 'block';
    });

    window.addEventListener('hha:end', (ev)=>{
      clearGameTimer();
      const d = ev && ev.detail ? ev.detail : null;
      showResultFromStats(d);
    });

    window.addEventListener('hha:score', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      const s = (typeof d.score === 'number')
        ? d.score
        : (typeof d.total === 'number'
           ? d.total
           : ((window.score|0) || 0));
      updateGradeBar(s);
    });

    window.addEventListener('quest:update', (ev)=>{
      const d = ev && ev.detail ? ev.detail : {};
      const goal = d.goal || null;
      const mini = d.mini || null;

      if (goal && goal.label){
        missionGoalEl.textContent = goal.label;
      } else {
        missionGoalEl.textContent = '-';
      }

      if (mini && mini.label){
        missionMiniEl.textContent = mini.label;
      } else {
        missionMiniEl.textContent = '-';
      }
    });

    if (vrButton && sceneEl){
      vrButton.addEventListener('click', ()=>{
        if (!sceneEl.is('vr-mode')){
          sceneEl.enterVR();
        } else {
          sceneEl.exitVR();
        }
      });
    }

    initCloudLogger({
      endpoint: 'https://script.google.com/macros/s/AKfycbxNor4osZ3NI_pGtYd8hGlwyMRTF9J2I4kCFiHUO-G_4VBj2ZqtTXiqsFU8KWDqRSTQ/exec',
      projectTag: 'HeroHealth-GoodJunkVR',
      debug: true
    });
  </script>
</body>
</html>
