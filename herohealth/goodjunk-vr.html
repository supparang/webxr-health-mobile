<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî GoodJunkVR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (for WebXR entry, but we use our own vr-ui.js buttons) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- FX + optional logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      color-scheme: light dark;
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:22px;
      --pill:999px;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html, body{
      margin:0; width:100%; height:100%;
      background: radial-gradient(circle at 20% 10%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(circle at 80% 20%, rgba(34,211,238,.14), transparent 60%),
                  radial-gradient(circle at 30% 90%, rgba(168,85,247,.12), transparent 60%),
                  var(--bg);
      overflow:hidden;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;
      color:var(--text);
    }

    /* --- A-Frame canvas behind DOM layer --- */
    .xr-stage{
      position:fixed; inset:0; z-index:0;
      pointer-events:none; /* we shoot via DOM/crosshair */
      opacity:.001; /* keep WebXR available, visually invisible */
    }

    /* --- DOM gameplay layer --- */
    #gj-layer{
      position:fixed; inset:0; z-index:5;
      pointer-events:none;
    }

    /* --- HUD (minimal, your existing JS can fill IDs) --- */
    .hud{
      position:fixed; left:0; right:0; top:0;
      padding: calc(10px + var(--sat)) 12px 10px;
      z-index:20;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      pointer-events:none;
    }
    .hud .box{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      pointer-events:none;
      min-width: 140px;
    }
    .hud .row{ display:flex; gap:10px; align-items:center; }
    .hud .k{ color:var(--muted); font-size:12px; }
    .hud .v{ font-weight:900; font-size:18px; letter-spacing:.2px; }
    .hud .mini{ font-size:12px; color:var(--muted); }

    /* --- READY overlay (device chooser) --- */
    .ready{
      position:fixed; inset:0; z-index:60;
      display:flex; align-items:center; justify-content:center;
      padding: 24px 14px calc(24px + var(--sab));
      background: radial-gradient(circle at 50% 20%, rgba(15,23,42,.55), rgba(2,6,23,.88));
      backdrop-filter: blur(8px);
    }
    .panel{
      width:min(980px, 96vw);
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(2,6,23,.82), rgba(2,6,23,.62));
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      padding: 18px 18px 16px;
      position:relative;
    }
    .title{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 6px 6px 12px;
    }
    .title h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size: 12.5px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .choice{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .chip{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: var(--pill);
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      padding: 14px 12px;
      font-weight:800;
      user-select:none;
      cursor:pointer;
    }
    .chip[data-on="1"]{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 2px rgba(34,197,94,.18) inset;
    }
    .chip.cvr[data-on="1"]{
      border-color: rgba(245,158,11,.65);
      box-shadow: 0 0 0 2px rgba(245,158,11,.18) inset;
    }
    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      margin-top: 12px;
      padding: 10px 6px 0;
    }
    .btn{
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.60);
      padding: 12px 14px;
      font-weight:900;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:10px;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.28), rgba(34,197,94,.14));
      border-color: rgba(34,197,94,.55);
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(245,158,11,.22), rgba(245,158,11,.12));
      border-color: rgba(245,158,11,.55);
    }
    .btn:disabled{
      opacity:.55; cursor:not-allowed;
    }
    .tips{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.4;
      padding: 0 6px 2px;
    }
    .toast{
      position:fixed; left:50%; bottom: calc(14px + var(--sab));
      transform: translateX(-50%);
      z-index: 99;
      background: rgba(2,6,23,.80);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight:800;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.on{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body class="view-mobile">
  <!-- Invisible XR scene (only to allow vr-ui.js Enter VR/Exit/Recenter) -->
  <a-scene class="xr-stage" embedded vr-mode-ui="enabled:false"></a-scene>

  <!-- DOM Layer for emoji targets -->
  <div id="gj-layer"></div>

  <!-- HUD placeholders (your JS already knows these IDs in previous builds) -->
  <div class="hud">
    <div class="box">
      <div class="k">Score</div>
      <div id="hud-score" class="v">0</div>
      <div class="mini"><span class="k">Combo</span> <span id="hud-combo">0</span> ¬∑ <span class="k">Miss</span> <span id="hud-miss">0</span></div>
    </div>
    <div class="box" style="text-align:right; min-width:170px;">
      <div class="k">Time</div>
      <div id="hud-time" class="v">‚Äî</div>
      <div class="mini"><span class="k">Grade</span> <span id="hud-grade">‚Äî</span></div>
    </div>
  </div>

  <!-- READY overlay -->
  <div id="ready" class="ready" aria-modal="true" role="dialog">
    <div class="panel">
      <div class="title">
        <div>
          <h1>ü•¶üçü GoodJunkVR ‚Äî Ready?</h1>
          <p id="paramsLine" class="sub">‚Äî</p>
        </div>
        <button id="btnStart" class="btn primary">‚ñ∂ START</button>
      </div>

      <div class="grid">
        <div class="choice">
          <div id="btnPC" class="chip" role="button" tabindex="0">üñ•Ô∏è PC</div>
          <div id="btnMobile" class="chip" role="button" tabindex="0">üì± Mobile</div>
          <div id="btnVR" class="chip" role="button" tabindex="0">üï∂Ô∏è VR</div>
          <div id="btnCVR" class="chip cvr" role="button" tabindex="0">üï∂Ô∏è cVR</div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center;">
          <button id="btnFs" class="btn">‚õ∂ Fullscreen</button>
          <button id="btnEnterCVR" class="btn warn">üï∂Ô∏è Enter cVR</button>
        </div>
      </div>

      <div class="tips">
        ‚Ä¢ cVR: ‡∏à‡∏≠‡πÅ‡∏¢‡∏Å 2 ‡∏ï‡∏≤ + ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡πÅ‡∏ï‡∏∞‡∏à‡∏≠/‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏¥‡∏á)<br/>
        ‚Ä¢ Research: ‡πÉ‡∏ä‡πâ <b>run=research</b> + <b>seed</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠ deterministic (‡∏õ‡∏¥‡∏î adaptive)<br/>
        ‚Ä¢ ‡∏Å‡∏±‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ß‡πä‡∏ö ‡πÜ‚Äù: ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° spawn ‡∏´‡∏•‡∏±‡∏á <b>START</b> ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      </div>
    </div>
  </div>

  <div id="toast" class="toast">‚Äî</div>

  <!-- Boot (IMPORTANT: engine will NOT start until START => fix "targets flash") -->
  <script type="module" src="./vr-goodjunk/goodjunk-vr.boot.js"></script>

  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);
      const qs = (k, def=null)=>{
        try { return new URL(location.href).searchParams.get(k) ?? def; } catch { return def; }
      };
      const setQS = (k,v)=>{
        const u = new URL(location.href);
        if(v==null) u.searchParams.delete(k); else u.searchParams.set(k, String(v));
        history.replaceState(null,'',u.toString());
      };

      const ready = $('#ready');
      const toast = $('#toast');
      const btnStart = $('#btnStart');
      const btnFs = $('#btnFs');
      const btnEnterCVR = $('#btnEnterCVR');

      const btnPC = $('#btnPC');
      const btnMobile = $('#btnMobile');
      const btnVR = $('#btnVR');
      const btnCVR = $('#btnCVR');

      let view = (qs('view') || qs('mode') || 'mobile').toLowerCase();
      if(view === 'cvr') view = 'cvr';
      if(view === 'vr') view = 'vr';
      if(view === 'pc') view = 'pc';
      if(view === 'mobile') view = 'mobile';

      function toastMsg(msg){
        toast.textContent = msg;
        toast.classList.add('on');
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>toast.classList.remove('on'), 1600);
      }

      function applyView(v){
        view = v;
        document.body.classList.remove('view-pc','view-mobile','view-vr','view-cvr');
        document.body.classList.add('view-'+v);

        btnPC.dataset.on = (v==='pc')?'1':'0';
        btnMobile.dataset.on = (v==='mobile')?'1':'0';
        btnVR.dataset.on = (v==='vr')?'1':'0';
        btnCVR.dataset.on = (v==='cvr')?'1':'0';

        setQS('view', v);
        // Enter cVR button only meaningful when cvr selected
        btnEnterCVR.disabled = (v!=='cvr');
      }

      applyView(view);

      // show params line
      const diff = qs('diff','normal');
      const time = qs('time','80');
      const run  = qs('run','play');
      const end  = qs('end','time');
      const ch   = qs('ch','rush');
      $('#paramsLine').textContent = `diff=${diff} ‚Ä¢ time=${time}s ‚Ä¢ run=${run} ‚Ä¢ end=${end} ‚Ä¢ ch=${ch}`;

      // Fullscreen (best effort)
      btnFs.addEventListener('click', async ()=>{
        try{
          if(!document.fullscreenElement){
            await document.documentElement.requestFullscreen?.();
          }
          toastMsg('Fullscreen ‚úì');
        }catch(e){
          toastMsg('Fullscreen ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      });

      // view buttons
      btnPC.addEventListener('click', ()=>applyView('pc'));
      btnMobile.addEventListener('click', ()=>applyView('mobile'));
      btnVR.addEventListener('click', ()=>applyView('vr'));
      btnCVR.addEventListener('click', ()=>applyView('cvr'));

      // Enter cVR: relies on vr-ui.js inside boot.js (it injects buttons and handles Enter VR)
      btnEnterCVR.addEventListener('click', ()=>{
        if(view!=='cvr') return;
        window.dispatchEvent(new CustomEvent('hha:enter-cvr'));
        toastMsg('Enter cVR‚Ä¶');
      });

      // START: This is the key fix. We *only* start engine/spawn after this.
      btnStart.addEventListener('click', ()=>{
        // If cVR chosen, strongly suggest entering cVR first (prevents flash/hide confusion)
        if(view==='cvr'){
          toastMsg('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î Enter cVR ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°');
        }
        ready.style.display = 'none';

        // Tell boot to start the game NOW (engine starts here, not before)
        window.dispatchEvent(new CustomEvent('hha:start', { detail:{ from:'ready', view } }));
      });

      // Allow auto-hide overlay only; do NOT autostart engine.
      // (Engine start is gated by 'hha:start' event in boot file.)
    })();
  </script>
</body>
</html>