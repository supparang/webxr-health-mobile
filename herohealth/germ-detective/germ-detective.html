<!-- === /herohealth/germ-detective/germ-detective.html ===
HeroHealth ‚Äî Germ Detective (Run)
‚úÖ PC / Mobile / Cardboard(cVR)
‚úÖ Universal VR UI (/herohealth/vr/vr-ui.js)
‚úÖ Query passthrough (hub/run/diff/time/seed/...)
‚úÖ HHA event hooks (local only; no App Script yet)
‚úÖ Root launcher path: /herohealth/germ-detective.html
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Germ Detective</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --bg2:#0b1220;
      --panel: rgba(2,6,23,.70);
      --panel2: rgba(15,23,42,.66);
      --line: rgba(148,163,184,.18);
      --txt: rgba(241,245,249,.96);
      --mut: rgba(148,163,184,.95);
      --good: rgba(16,185,129,.95);
      --warn: rgba(251,191,36,.95);
      --bad: rgba(244,63,94,.95);
      --acc: rgba(34,211,238,.95);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);

      --hud-top: calc(max(10px, var(--sat)) + 2px);
      --hud-left: calc(max(10px, var(--sal)) + 2px);
      --hud-right: calc(max(10px, var(--sar)) + 2px);
      --hud-bottom: calc(max(10px, var(--sab)) + 72px); /* ‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏´‡πâ vr-ui ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:
        radial-gradient(900px 600px at 0% 0%, rgba(99,102,241,.14), transparent 60%),
        radial-gradient(700px 500px at 100% 0%, rgba(34,211,238,.10), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color:var(--txt);
      font-family: system-ui,-apple-system,"Noto Sans Thai","Segoe UI",Roboto,sans-serif;
      overflow:hidden;
    }

    /* Game mount */
    #app{
      position:fixed; inset:0;
      overflow:hidden;
      touch-action:manipulation;
      -webkit-user-select:none; user-select:none;
    }

    /* World backdrop / scene */
    .gd-world{
      position:absolute; inset:0;
      background:
        radial-gradient(700px 340px at 20% 20%, rgba(255,255,255,.03), transparent 60%),
        radial-gradient(650px 300px at 80% 10%, rgba(255,255,255,.02), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
    }

    /* Header HUD */
    .gd-hud{
      position:fixed;
      left: var(--hud-left);
      right: var(--hud-right);
      top: var(--hud-top);
      z-index: 9000;
      display:grid;
      gap:8px;
      pointer-events:none;
    }
    .gd-hud-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:start;
    }
    .gd-panel{
      pointer-events:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(2,6,23,.72), rgba(2,6,23,.58));
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,.28);
      padding:10px 12px;
    }
    .gd-title{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .gd-title .icon{
      width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
      background:rgba(34,211,238,.12); border:1px solid rgba(34,211,238,.2);
    }
    .gd-title .name{
      font-weight:900; line-height:1.1; font-size:14px;
    }
    .gd-title .sub{
      color:var(--mut); font-size:11px; margin-top:2px;
    }

    .gd-metrics{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:8px;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 9px;
      background:rgba(255,255,255,.02);
      font-size:12px;
      color:var(--mut);
      display:inline-flex; gap:6px; align-items:center;
      white-space:nowrap;
    }
    .chip strong{ color:var(--txt); }

    .gd-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:1px solid var(--line); border-radius:999px;
      padding:8px 11px; cursor:pointer;
      background:rgba(2,6,23,.62); color:var(--txt);
      font:900 12px/1 system-ui,-apple-system,"Noto Sans Thai",sans-serif;
    }
    .btn.primary{
      background:linear-gradient(180deg, rgba(34,211,238,.15), rgba(34,211,238,.08));
      border-color:rgba(34,211,238,.25);
    }
    .btn.warn{
      background:linear-gradient(180deg, rgba(251,191,36,.12), rgba(251,191,36,.06));
      border-color:rgba(251,191,36,.22);
    }

    /* Side panels */
    .gd-side-left, .gd-side-right{
      position:fixed;
      z-index: 9000;
      top: calc(var(--hud-top) + 94px);
      bottom: var(--hud-bottom);
      width: min(320px, 38vw);
      display:grid; gap:8px;
      pointer-events:none;
    }
    .gd-side-left{
      left: var(--hud-left);
      align-content:start;
    }
    .gd-side-right{
      right: var(--hud-right);
      align-content:start;
    }
    .gd-side-left > *, .gd-side-right > *{ pointer-events:auto; }

    .section-title{
      font-size:12px;
      color:var(--mut);
      font-weight:900;
      letter-spacing:.03em;
      margin-bottom:6px;
    }

    /* Tool bar (big buttons for mobile/cVR) */
    .tool-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }
    .tool-btn{
      appearance:none; width:100%;
      border:1px solid var(--line); border-radius:14px;
      padding:10px 8px; cursor:pointer;
      background:rgba(255,255,255,.02);
      color:var(--txt);
      text-align:left;
      min-height:62px;
      display:grid; align-content:center; gap:3px;
    }
    .tool-btn .t1{font-weight:900; font-size:13px;}
    .tool-btn .t2{font-size:11px; color:var(--mut);}
    .tool-btn.active{
      border-color:rgba(34,211,238,.32);
      background:linear-gradient(180deg, rgba(34,211,238,.14), rgba(34,211,238,.06));
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.08);
    }

    /* Evidence list */
    #gdEvidenceList{
      display:grid; gap:6px;
      max-height: 34dvh;
      overflow:auto;
      padding-right:2px;
    }
    .gd-card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:8px;
      font-size:12px;
      line-height:1.3;
    }
    .gd-card .meta{ color:var(--mut); font-size:11px; margin-top:3px; }

    /* Chain panel */
    .chain-list{
      display:grid; gap:6px;
    }
    .chain-item{
      border:1px dashed rgba(148,163,184,.22);
      border-radius:12px;
      padding:8px;
      font-size:12px;
      background:rgba(255,255,255,.01);
    }

    /* AI coach */
    .coach{
      border:1px solid rgba(34,211,238,.22);
      background:linear-gradient(180deg, rgba(34,211,238,.10), rgba(34,211,238,.04));
      border-radius:14px;
      padding:10px;
    }
    .coach .head{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-bottom:6px;
    }
    .coach .head strong{ font-size:12px; }
    .coach .head small{ color:var(--mut); }
    .coach .body{ font-size:12px; line-height:1.35; }
    .coach .reason{ margin-top:6px; color:var(--mut); font-size:11px; }

    /* Center overlays */
    .gd-center-hint{
      position:fixed;
      left:50%; top: calc(50% + 80px);
      transform:translateX(-50%);
      z-index: 9001;
      background: rgba(2,6,23,.58);
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      color:var(--mut);
      pointer-events:none;
      backdrop-filter: blur(8px);
    }

    /* Scene hotspots (demo DOM world) */
    .gd-scene{
      position:absolute;
      left:0; right:0;
      top:130px; bottom:90px;
      overflow:hidden;
    }
    .gd-zone-label{
      position:absolute;
      left:16px; top:12px;
      z-index:2;
      color:var(--mut);
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.55);
      border-radius:999px; padding:6px 10px;
    }
    .gd-hotspot{
      position:absolute;
      min-width:90px;
      max-width:140px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(255,255,255,.03);
      color:var(--txt);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .18s ease, opacity .15s ease;
      box-shadow: 0 8px 22px rgba(0,0,0,.16);
    }
    .gd-hotspot:hover{ transform:translateY(-1px); }
    .gd-hotspot.is-hot{
      border-color: rgba(244,63,94,.35);
      box-shadow: 0 0 0 1px rgba(244,63,94,.12), 0 0 18px rgba(244,63,94,.18);
    }
    .gd-hotspot.is-scanned{
      border-color: rgba(34,211,238,.35);
      box-shadow: 0 0 0 1px rgba(34,211,238,.12), 0 0 18px rgba(34,211,238,.18);
    }
    .gd-hotspot.is-collected{
      border-color: rgba(16,185,129,.35);
      box-shadow: 0 0 0 1px rgba(16,185,129,.12), 0 0 18px rgba(16,185,129,.15);
    }
    .gd-hotspot.is-photo{
      border-color: rgba(251,191,36,.35);
      box-shadow: 0 0 0 1px rgba(251,191,36,.12), 0 0 18px rgba(251,191,36,.15);
    }
    .gd-hotspot.dim{
      opacity:.48;
    }

    /* Bottom action bar */
    .gd-bottom{
      position:fixed;
      left: var(--hud-left);
      right: var(--hud-right);
      bottom: calc(max(10px,var(--sab)) + 0px);
      z-index:9000;
      display:grid; gap:8px;
      pointer-events:none;
    }
    .gd-bottom > *{ pointer-events:auto; }

    .res-bar{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
    }
    .res-box{
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(2,6,23,.58);
      padding:8px 10px;
      font-size:12px;
    }
    .res-box .mut{font-size:11px}
    .bar{
      margin-top:6px;
      height:8px; border-radius:999px;
      background:rgba(255,255,255,.05);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.14);
    }
    .bar > i{
      display:block; height:100%; width:20%;
      background:linear-gradient(90deg, rgba(34,211,238,.85), rgba(16,185,129,.85));
    }

    /* Result modal */
    .result-mask{
      position:fixed; inset:0; z-index:10020;
      background:rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      display:none; place-items:center;
      padding:18px;
    }
    .result-card{
      width:min(760px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(2,6,23,.86));
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      padding:14px;
    }
    .result-card h2{ margin:0 0 8px; }
    .result-grid{
      display:grid; gap:10px;
      grid-template-columns:1fr 1fr;
    }
    .result-item{
      border:1px solid var(--line); border-radius:12px; padding:10px;
      background:rgba(255,255,255,.02);
    }
    .result-actions{
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px;
    }

    /* cVR strict mode helper */
    html[data-view="cvr"] .gd-hotspot{
      /* ‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô crosshair ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞ hotspot ‡∏ï‡∏£‡∏á‡πÜ */
      pointer-events:none;
    }

    /* mobile compact */
    @media (max-width: 900px){
      .gd-side-left, .gd-side-right{
        position:fixed;
        width:auto;
        left: var(--hud-left);
        right: var(--hud-right);
      }
      .gd-side-left{
        top: calc(var(--hud-top) + 104px);
        bottom:auto;
      }
      .gd-side-right{
        top:auto;
        bottom: calc(var(--hud-bottom) + 78px);
      }
      .gd-side-right .gd-panel{ max-height: 28dvh; overflow:auto; }

      .gd-scene{ top: 210px; bottom: 160px; }
      .res-bar{ grid-template-columns:1fr; }
      .result-grid{ grid-template-columns:1fr; }
    }

    /* very small */
    @media (max-width: 520px){
      .gd-actions{ justify-content:flex-start; }
      .gd-hud-row{ grid-template-columns:1fr; }
      .tool-grid{ grid-template-columns:1fr 1fr 1fr; }
      .tool-btn{ min-height:56px; padding:8px; }
      .gd-title .name{font-size:13px}
      .chip{font-size:11px;padding:5px 8px}
    }
  </style>
</head>
<body>
  <div id="app" aria-label="Germ Detective Game">
    <div class="gd-world"></div>

    <!-- HUD -->
    <div class="gd-hud">
      <div class="gd-hud-row">
        <div class="gd-panel">
          <div class="gd-title">
            <div class="icon">ü¶†</div>
            <div>
              <div class="name">Germ Detective</div>
              <div class="sub" id="gdScenarioLabel">Case: --</div>
            </div>
          </div>

          <div class="gd-metrics">
            <div class="chip">‡πÇ‡∏´‡∏°‡∏î <strong id="hudMode">play</strong></div>
            <div class="chip">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å <strong id="hudDiff">normal</strong></div>
            <div class="chip">‡πÄ‡∏ß‡∏•‡∏≤ <strong id="hudTime">180s</strong></div>
            <div class="chip">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô <strong id="hudEvidence">0</strong></div>
            <div class="chip">Chain <strong id="hudChain">0</strong></div>
            <div class="chip">Exposure ‚Üì <strong id="hudExposure">0%</strong></div>
            <div class="chip">R‚ÇÄ ‚Üì <strong id="hudR0">0.0</strong></div>
            <div class="chip">AI <strong id="hudAI">ON</strong></div>
          </div>
        </div>

        <div class="gd-actions">
          <button id="btnPause" class="btn warn" type="button">‚è∏ Pause</button>
          <button id="btnSubmit" class="btn primary" type="button">üìã ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          <button id="btnBack" class="btn" type="button">‚¨Ö HUB</button>
        </div>
      </div>
    </div>

    <!-- Left side -->
    <aside class="gd-side-left">
      <section class="gd-panel">
        <div class="section-title">TOOLS</div>
        <div class="tool-grid">
          <button class="tool-btn" id="toolUV" data-tool="uv" type="button">
            <span class="t1">UV</span><span class="t2">Reveal hotspot</span>
          </button>
          <button class="tool-btn" id="toolSwab" data-tool="swab" type="button">
            <span class="t1">Swab</span><span class="t2">Collect sample</span>
          </button>
          <button class="tool-btn" id="toolCam" data-tool="cam" type="button">
            <span class="t1">Camera</span><span class="t2">Photo evidence</span>
          </button>
        </div>
      </section>

      <section class="gd-panel">
        <div class="section-title">AI COACH / PREDICTION</div>
        <div class="coach" id="coachBox">
          <div class="head">
            <strong>Next Best Action</strong>
            <small id="coachLevel">Heuristic</small>
          </div>
          <div class="body" id="coachText">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏π‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î / ‡πÇ‡∏ï‡πä‡∏∞ / ‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà UV ‡πÄ‡∏à‡∏≠
          </div>
          <div class="reason" id="coachReason">
            ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏π‡∏á‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô node ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á chain ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà
          </div>
        </div>
      </section>
    </aside>

    <!-- Right side -->
    <aside class="gd-side-right">
      <section class="gd-panel">
        <div class="section-title">EVIDENCE BOARD</div>
        <div id="gdEvidenceList" aria-live="polite"></div>
      </section>

      <section class="gd-panel">
        <div class="section-title">CHAIN (A ‚Üí B ‚Üí C)</div>
        <div class="chain-list" id="gdChainList">
          <div class="chain-item">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ chain ‚Äî ‡πÄ‡∏Å‡πá‡∏ö photo + sample ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á</div>
        </div>
      </section>
    </aside>

    <!-- Main scene (DOM prototype scene) -->
    <section class="gd-scene" id="sceneRoot" aria-label="scene">
      <div class="gd-zone-label" id="gdZoneLabel">Scene</div>
      <!-- hotspots are injected by JS -->
    </section>

    <div class="gd-center-hint" id="gdHint">Tip: ‡πÉ‡∏ä‡πâ UV ‡∏´‡∏≤ hotspot ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ Swab/Camera</div>

    <!-- Bottom resource/status bar -->
    <div class="gd-bottom">
      <div class="res-bar">
        <div class="res-box">
          <div class="mut">UV Charges</div>
          <div><strong id="resUV">6</strong></div>
          <div class="bar"><i id="barUV" style="width:100%"></i></div>
        </div>
        <div class="res-box">
          <div class="mut">Swab Kits</div>
          <div><strong id="resSwab">4</strong></div>
          <div class="bar"><i id="barSwab" style="width:100%"></i></div>
        </div>
        <div class="res-box">
          <div class="mut">Camera Shots</div>
          <div><strong id="resCam">6</strong></div>
          <div class="bar"><i id="barCam" style="width:100%"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Result modal -->
  <div class="result-mask" id="resultMask" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
    <div class="result-card">
      <h2 id="resultTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏î‡∏µ üïµÔ∏è‚Äç‚ôÄÔ∏è</h2>
      <div class="mut" id="resultSubtitle">--</div>

      <div class="result-grid" style="margin-top:10px">
        <div class="result-item">
          <div class="section-title">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô</div>
          <div id="resScore" style="font-size:28px;font-weight:1000">0</div>
          <div class="mut" id="resBadge">Badge: --</div>
        </div>
        <div class="result-item">
          <div class="section-title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏ß‡∏∞</div>
          <div>Exposure ‡∏•‡∏î‡∏•‡∏á: <b id="resExposure">0%</b></div>
          <div>R‚ÇÄ ‡∏•‡∏î‡∏•‡∏á: <b id="resR0">0.0</b></div>
          <div>Chain ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡∏∞‡πÑ‡∏î‡πâ: <b id="resChainCount">0</b></div>
        </div>
        <div class="result-item">
          <div class="section-title">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</div>
          <div>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="resEvidenceCount">0</b></div>
          <div>Hotspot scan: <b id="resScanCount">0</b></div>
          <div>Swab sample: <b id="resSampleCount">0</b></div>
          <div>Photo: <b id="resPhotoCount">0</b></div>
        </div>
        <div class="result-item">
          <div class="section-title">AI Coach (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)</div>
          <div>Predictions used: <b id="resPredUsed">0</b></div>
          <div>Hints followed: <b id="resHintFollow">0</b></div>
          <div class="mut">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1: heuristic / prediction overlay (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>
        </div>
      </div>

      <div class="result-actions">
        <button class="btn" id="btnPlayAgain" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn primary" id="btnBackHub2" type="button">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- Universal VR UI config (must set BEFORE vr-ui.js) -->
  <script>
    window.HHA_VRUI_CONFIG = Object.assign({}, window.HHA_VRUI_CONFIG || {}, {
      lockPx: 28,
      cooldownMs: 90,
      showCrosshair: true,
      showButtons: true,
      cvrStrict: true
    });
  </script>

  <!-- Universal VR UI (Cardboard / cVR helper) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Optional compatibility stubs if plate.safe / logger bridge not loaded -->
  <script>
    (function(){
      'use strict';
      if(!window.PlateSafe){
        window.PlateSafe = {
          logEvent(name, payload){
            try{
              window.dispatchEvent(new CustomEvent('hha:event', { detail:{ name, payload: payload||{} } }));
            }catch{}
          },
          emitFeatures(){
            try{
              window.dispatchEvent(new CustomEvent('hha:features_1s', { detail:{ game:'germ-detective' } }));
            }catch{}
          },
          end(reason){
            try{
              window.dispatchEvent(new CustomEvent('hha:end', { detail:{ reason: String(reason||'end') } }));
            }catch{}
          }
        };
      }
      if(!window.PlateLogger){
        window.PlateLogger = {
          logEvent(){},
          sendEvidence(){},
          flush(){ return Promise.resolve(); }
        };
      }
    })();
  </script>

  <!-- Main game boot -->
  <script type="module">
    import GameApp from './germ-detective.js';

    (function(){
      'use strict';

      const $ = (s)=>document.querySelector(s);
      const $$ = (s)=>document.querySelectorAll(s);

      function qs(k, def=''){
        try { return new URL(location.href).searchParams.get(k) ?? def; }
        catch { return def; }
      }
      function clamp(v,a,b){
        v = Number(v);
        if(!Number.isFinite(v)) v = a;
        return Math.max(a, Math.min(b, v));
      }
      function asBool01(v, def=0){
        if(v == null || v === '') return !!def;
        const s = String(v).toLowerCase();
        return (s==='1' || s==='true' || s==='yes' || s==='on');
      }

      // ----- parse params (HHA style passthrough) -----
      const P = {
        hub: qs('hub', '../hub.html'),
        view: String(qs('view','pc')).toLowerCase(),
        run: String(qs('run','play')).toLowerCase(),
        diff: String(qs('diff','normal')).toLowerCase(),
        time: clamp(qs('time','180'), 60, 600),
        seed: String(qs('seed', String(Date.now()))),
        scene: String(qs('scene','classroom')).toLowerCase(),
        ai: asBool01(qs('ai','1'), 1),

        pid: qs('pid',''),
        studyId: qs('studyId',''),
        phase: qs('phase',''),
        conditionGroup: qs('conditionGroup',''),
        api: qs('api',''),
        log: qs('log',''),
      };

      // dataset for cVR strict helper + debug
      document.documentElement.dataset.view = P.view;
      document.documentElement.dataset.run = P.run;
      document.documentElement.dataset.diff = P.diff;

      // ----- local runtime state for UI/score/ai coach -----
      const R = {
        paused: false,
        ended: false,
        evidence: [],
        chains: [],
        coach: { predictions:0, followed:0, lastTarget:null, lastTool:null, coolUntil:0 },
        resources: { uv:6, swab:4, cam:6 },
        resourcesMax: { uv:6, swab:4, cam:6 },
        metrics: {
          exposureReduction: 0,
          r0Reduction: 0,
          score: 0,
          scanCount: 0,
          sampleCount: 0,
          photoCount: 0
        },
        hotspotsMeta: new Map(), // name -> {risk, zone, touched, scanned, swab, photo}
      };

      // difficulty presets (fun/challenging)
      const DIFF = {
        easy:   { uv:7, swab:5, cam:7, scoreMul:0.9, decay:0.6, aiHintInt:6000 },
        normal: { uv:6, swab:4, cam:6, scoreMul:1.0, decay:1.0, aiHintInt:5000 },
        hard:   { uv:5, swab:3, cam:5, scoreMul:1.18, decay:1.35, aiHintInt:4200 }
      }[P.diff] || { uv:6, swab:4, cam:6, scoreMul:1.0, decay:1.0, aiHintInt:5000 };

      R.resources = { uv:DIFF.uv, swab:DIFF.swab, cam:DIFF.cam };
      R.resourcesMax = { ...R.resources };

      // ----- simple seeded RNG (deterministic-ish) -----
      function hashSeed(s){
        s = String(s || '0');
        let h = 2166136261 >>> 0;
        for(let i=0;i<s.length;i++){
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }
      function mulberry32(a){
        return function(){
          a |= 0; a = a + 0x6D2B79F5 | 0;
          let t = Math.imul(a ^ a >>> 15, 1 | a);
          t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
      }
      const rand = mulberry32(hashSeed(P.seed + '|' + P.scene + '|' + P.diff));

      // ----- Scene catalogs -----
      const SCENES = {
        classroom: {
          label:'‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Ä¢ ‡πÄ‡∏î‡πá‡∏Å‡∏õ‡πà‡∏ß‡∏¢ 3 ‡∏Ñ‡∏ô',
          zone:'Classroom',
          hotspots:[
            { name:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π', x:12, y:22, risk:0.95, hot:true, node:'Door' },
            { name:'‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô A', x:33, y:34, risk:0.75, hot:true, node:'DeskA' },
            { name:'‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô B', x:48, y:39, risk:0.60, hot:false, node:'DeskB' },
            { name:'‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥', x:80, y:24, risk:0.92, hot:true, node:'Sink' },
            { name:'‡∏£‡∏≤‡∏ß‡∏ö‡∏±‡∏ô‡πÑ‡∏î', x:72, y:56, risk:0.78, hot:true, node:'Rail' },
            { name:'‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡πÅ‡∏≠‡∏£‡πå', x:26, y:14, risk:0.55, hot:false, node:'Remote' },
            { name:'‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞', x:64, y:68, risk:0.50, hot:false, node:'Bin' },
            { name:'‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏ü', x:8, y:46, risk:0.70, hot:true, node:'Switch' },
            { name:'‡∏™‡∏°‡∏∏‡∏î‡πÅ‡∏ä‡∏£‡πå', x:45, y:58, risk:0.66, hot:false, node:'Notebook' },
          ],
          chains:[
            ['‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π','‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô A','‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥'],
            ['‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏ü','‡∏£‡∏≤‡∏ß‡∏ö‡∏±‡∏ô‡πÑ‡∏î','‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô B']
          ]
        },
        home: {
          label:'‡∏ö‡πâ‡∏≤‡∏ô ‚Ä¢ ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÑ‡∏≠‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô',
          zone:'Home',
          hotspots:[
            { name:'‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô', x:16, y:24, risk:0.90, hot:true, node:'BedroomDoor' },
            { name:'‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß', x:47, y:36, risk:0.72, hot:true, node:'Dining' },
            { name:'‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ', x:64, y:52, risk:0.88, hot:true, node:'TVRemote' },
            { name:'‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠', x:82, y:28, risk:0.94, hot:true, node:'Sink' },
            { name:'‡∏£‡∏≤‡∏ß‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô', x:73, y:18, risk:0.79, hot:true, node:'Fridge' },
            { name:'‡πÇ‡∏ã‡∏ü‡∏≤‡πÅ‡∏Ç‡∏ô‡∏à‡∏±‡∏ö', x:34, y:60, risk:0.62, hot:false, node:'Sofa' },
            { name:'‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', x:52, y:44, risk:0.86, hot:true, node:'Phone' },
            { name:'‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á', x:24, y:12, risk:0.42, hot:false, node:'Window' },
          ],
          chains:[
            ['‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô','‡∏£‡∏µ‡πÇ‡∏°‡∏ï‡∏ó‡∏µ‡∏ß‡∏µ','‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß'],
            ['‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á','‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠','‡∏£‡∏≤‡∏ß‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô']
          ]
        },
        canteen: {
          label:'‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Ä¢ ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏π‡∏á',
          zone:'Canteen',
          hotspots:[
            { name:'‡∏ñ‡∏≤‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£', x:38, y:28, risk:0.88, hot:true, node:'Tray' },
            { name:'‡∏ä‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á', x:52, y:32, risk:0.92, hot:true, node:'Spoon' },
            { name:'‡∏£‡∏≤‡∏ß‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£', x:70, y:26, risk:0.84, hot:true, node:'QueueRail' },
            { name:'‡πÇ‡∏ï‡πä‡∏∞‡∏£‡∏ß‡∏°', x:44, y:56, risk:0.74, hot:true, node:'Table' },
            { name:'‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°', x:82, y:48, risk:0.90, hot:true, node:'DrinkingTap' },
            { name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô', x:18, y:42, risk:0.80, hot:true, node:'CashBox' },
            { name:'‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ï‡∏π', x:10, y:22, risk:0.76, hot:false, node:'DoorHandle' },
            { name:'‡∏ñ‡∏±‡∏á‡∏ä‡πâ‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á', x:62, y:64, risk:0.58, hot:false, node:'UtensilTub' },
          ],
          chains:[
            ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô','‡∏ñ‡∏≤‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡πÇ‡∏ï‡πä‡∏∞‡∏£‡∏ß‡∏°'],
            ['‡∏£‡∏≤‡∏ß‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏ä‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á','‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°']
          ]
        }
      };

      const SCENE = SCENES[P.scene] || SCENES.classroom;

      // ----- basic UI bindings -----
      const UI = {
        hudMode: $('#hudMode'),
        hudDiff: $('#hudDiff'),
        hudTime: $('#hudTime'),
        hudEvidence: $('#hudEvidence'),
        hudChain: $('#hudChain'),
        hudExposure: $('#hudExposure'),
        hudR0: $('#hudR0'),
        hudAI: $('#hudAI'),
        scenario: $('#gdScenarioLabel'),
        zoneLabel: $('#gdZoneLabel'),
        evidenceList: $('#gdEvidenceList'),
        chainList: $('#gdChainList'),
        hint: $('#gdHint'),

        resUV: $('#resUV'),
        resSwab: $('#resSwab'),
        resCam: $('#resCam'),
        barUV: $('#barUV'),
        barSwab: $('#barSwab'),
        barCam: $('#barCam'),

        coachText: $('#coachText'),
        coachReason: $('#coachReason'),
        coachLevel: $('#coachLevel'),

        btnPause: $('#btnPause'),
        btnSubmit: $('#btnSubmit'),
        btnBack: $('#btnBack'),
        btnPlayAgain: $('#btnPlayAgain'),
        btnBackHub2: $('#btnBackHub2'),
        resultMask: $('#resultMask'),

        resultSubtitle: $('#resultSubtitle'),
        resScore: $('#resScore'),
        resBadge: $('#resBadge'),
        resExposure: $('#resExposure'),
        resR0: $('#resR0'),
        resChainCount: $('#resChainCount'),
        resEvidenceCount: $('#resEvidenceCount'),
        resScanCount: $('#resScanCount'),
        resSampleCount: $('#resSampleCount'),
        resPhotoCount: $('#resPhotoCount'),
        resPredUsed: $('#resPredUsed'),
        resHintFollow: $('#resHintFollow'),

        sceneRoot: $('#sceneRoot')
      };

      UI.hudMode.textContent = P.run;
      UI.hudDiff.textContent = P.diff;
      UI.hudTime.textContent = P.time + 's';
      UI.hudAI.textContent = P.ai ? 'ON' : 'OFF';
      UI.scenario.textContent = 'Case: ' + SCENE.label;
      UI.zoneLabel.textContent = SCENE.zone;

      // ----- game app boot (your core file) -----
      const app = GameApp({
        mountId: 'app',
        timeSec: P.time,
        seed: P.seed,
        scene: P.scene,
        difficulty: P.diff,
        view: P.view,
        runMode: P.run,
      });

      // attach to window for debug
      window.GermDetectiveApp = app;

      // build prototype scene hotspots into #sceneRoot (instead of body)
      // We monkey-patch createHotspots target by providing a scene root helper through window
      window.__GD_SCENE_ROOT__ = UI.sceneRoot;

      // ----- Enhanced gameplay wrapper (fun/challenging + AI prediction) -----

      // inject scene hotspots (DOM prototype) and meta
      function spawnSceneHotspots(){
        const root = UI.sceneRoot;
        // clear existing except zone label
        [...root.querySelectorAll('.gd-hotspot')].forEach(n => n.remove());

        SCENE.hotspots.forEach((h, i)=>{
          const d = document.createElement('button');
          d.type = 'button';
          d.className = 'gd-hotspot' + (h.hot ? ' is-hot' : '');
          d.dataset.name = h.name;
          d.dataset.idx = String(i);
          d.style.left = `calc(${h.x}% - 48px)`;
          d.style.top  = `calc(${h.y}% - 18px)`;
          d.textContent = h.name;

          // tap/click direct (PC/mobile); cVR strict will disable pointer-events in CSS
          d.addEventListener('click', ()=> handleHotspotAction(h, d), {passive:true});

          root.appendChild(d);

          R.hotspotsMeta.set(h.name, {
            risk: h.risk, zone: SCENE.zone, touched:0, scanned:0, swab:0, photo:0, hot:!!h.hot, node:h.node
          });
        });
      }

      let currentTool = 'uv';

      function setToolLocal(t){
        currentTool = t;
        $$('.tool-btn').forEach(b=> b.classList.toggle('active', b.dataset.tool === t));
      }

      function resourceLeft(tool){
        if(tool === 'uv') return R.resources.uv;
        if(tool === 'swab') return R.resources.swab;
        return R.resources.cam;
      }

      function useResource(tool){
        if(tool === 'uv'){
          if(R.resources.uv <= 0) return false;
          R.resources.uv--;
          return true;
        }
        if(tool === 'swab'){
          if(R.resources.swab <= 0) return false;
          R.resources.swab--;
          return true;
        }
        if(tool === 'cam'){
          if(R.resources.cam <= 0) return false;
          R.resources.cam--;
          return true;
        }
        return true;
      }

      function updateResourceUI(){
        UI.resUV.textContent = R.resources.uv;
        UI.resSwab.textContent = R.resources.swab;
        UI.resCam.textContent = R.resources.cam;

        const pct = (v,m)=> (m<=0?0:Math.round((v/m)*100));
        UI.barUV.style.width   = pct(R.resources.uv,   R.resourcesMax.uv)   + '%';
        UI.barSwab.style.width = pct(R.resources.swab, R.resourcesMax.swab) + '%';
        UI.barCam.style.width  = pct(R.resources.cam,  R.resourcesMax.cam)  + '%';
      }

      function pushEvidenceCard(ev){
        const c = document.createElement('div');
        c.className = 'gd-card';
        c.innerHTML = `
          <div><b>${ev.type.toUpperCase()}</b> ‚Ä¢ ${ev.target}</div>
          <div>${ev.info || ''}</div>
          <div class="meta">${new Date(ev.t || Date.now()).toLocaleTimeString('th-TH')}</div>
        `;
        UI.evidenceList.prepend(c);
      }

      function refreshHUD(){
        UI.hudEvidence.textContent = String(R.evidence.length);
        UI.hudChain.textContent = String(R.chains.length);
        UI.hudExposure.textContent = Math.round(R.metrics.exposureReduction) + '%';
        UI.hudR0.textContent = R.metrics.r0Reduction.toFixed(1);
      }

      function setHint(text, ms=1800){
        if(!UI.hint) return;
        UI.hint.textContent = text;
        UI.hint.style.opacity = '1';
        clearTimeout(setHint._t);
        setHint._t = setTimeout(()=>{ try{ UI.hint.style.opacity='0.65'; }catch{} }, ms);
      }

      function addEvidenceLocal(rec){
        const ev = Object.assign({}, rec, { t: rec.t || Date.now() });
        R.evidence.push(ev);
        pushEvidenceCard(ev);

        if(ev.type === 'hotspot') R.metrics.scanCount++;
        else if(ev.type === 'sample') R.metrics.sampleCount++;
        else if(ev.type === 'photo') R.metrics.photoCount++;

        computeChainsAndScore();
        refreshHUD();

        // event hooks (HHA local)
        try{
          window.dispatchEvent(new CustomEvent('hha:event', { detail:{ name:'evidence_added', payload: ev } }));
        }catch{}
      }

      function computeChainsAndScore(){
        // chain unlock rule (fun + deterministic):
        // chain unlocks if at least 2 nodes in chain have evidence, including at least one photo or sample
        const has = new Map();
        let hasPhotoOrSample = new Set();

        for(const e of R.evidence){
          has.set(e.target, (has.get(e.target)||0)+1);
          if(e.type === 'sample' || e.type === 'photo') hasPhotoOrSample.add(e.target);
        }

        const unlocked = [];
        for(const chain of SCENE.chains){
          const cnt = chain.filter(n => has.has(n)).length;
          const ps  = chain.some(n => hasPhotoOrSample.has(n));
          if(cnt >= 2 && ps){
            unlocked.push(chain);
          }
        }
        R.chains = unlocked;

        // score model (arcade + reasoning)
        const uniqTargets = new Set(R.evidence.map(e=>e.target)).size;
        const scan = R.metrics.scanCount;
        const sample = R.metrics.sampleCount;
        const photo = R.metrics.photoCount;
        const chainPts = R.chains.length * 120;
        const diversityPts = uniqTargets * 18;
        const evidencePts = (scan*14 + sample*28 + photo*20);
        const resourceBonus = (R.resources.uv + R.resources.swab*2 + R.resources.cam) * 6;
        const followBonus = R.coach.followed * 20;

        let score = (chainPts + diversityPts + evidencePts + resourceBonus + followBonus) * DIFF.scoreMul;
        if(P.run === 'research') score *= 0.98; // tiny lock flavor (no advantage)
        R.metrics.score = Math.round(score);

        // pseudo public-health outcomes from evidence quality + chain coverage
        const chainCoverage = Math.min(1, R.chains.length / Math.max(1, SCENE.chains.length));
        const evidenceQuality = Math.min(1, (sample*1.2 + photo + scan*0.5) / 12);
        R.metrics.exposureReduction = Math.min(95, (chainCoverage*55 + evidenceQuality*35 + uniqTargets*2.2));
        R.metrics.r0Reduction = Math.max(0, Math.min(2.4, chainCoverage*1.5 + evidenceQuality*0.9));

        renderChainList();
      }

      function renderChainList(){
        UI.chainList.innerHTML = '';
        if(!R.chains.length){
          const d = document.createElement('div');
          d.className = 'chain-item';
          d.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ chain ‚Äî ‡πÄ‡∏Å‡πá‡∏ö photo + sample ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á';
          UI.chainList.appendChild(d);
          return;
        }
        R.chains.forEach((ch, i)=>{
          const d = document.createElement('div');
          d.className = 'chain-item';
          d.innerHTML = `<b>Chain ${i+1}</b>: ${ch.join(' ‚Üí ')}`;
          UI.chainList.appendChild(d);
        });
      }

      function tagHotspotVisual(el, tool){
        if(!el) return;
        if(tool === 'uv'){
          el.classList.add('is-scanned');
          el.animate?.([{transform:'scale(1)'},{transform:'scale(1.04)'},{transform:'scale(1)'}], {duration:220, easing:'ease-out'});
        }else if(tool === 'swab'){
          el.classList.add('is-collected');
          el.style.opacity = '0.85';
          setTimeout(()=>{ try{ el.style.opacity='1'; }catch{} }, 300);
        }else if(tool === 'cam'){
          el.classList.add('is-photo');
          el.animate?.([{filter:'brightness(1.8)'},{filter:'brightness(1)'}], {duration:220});
        }
      }

      function handleHotspotAction(h, el){
        if(R.ended || R.paused) return;

        const meta = R.hotspotsMeta.get(h.name);
        if(meta) meta.touched++;

        if(!currentTool){
          addEvidenceLocal({ type:'inspect', target:h.name, info:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' });
          setHint('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô: UV / Swab / Camera');
          return;
        }

        if(!useResource(currentTool)){
          setHint('‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
          try{ window.dispatchEvent(new CustomEvent('hha:event', { detail:{ name:'resource_empty', payload:{ tool:currentTool } } })); }catch{}
          return;
        }
        updateResourceUI();

        if(currentTool === 'uv'){
          if(meta) meta.scanned++;
          tagHotspotVisual(el, 'uv');
          addEvidenceLocal({ type:'hotspot', target:h.name, info:'‡∏û‡∏ö‡πÇ‡∏î‡∏¢ UV' });
          setHint(`UV reveal: ${h.name}`);
        } else if(currentTool === 'swab'){
          if(meta) meta.swab++;
          tagHotspotVisual(el, 'swab');
          addEvidenceLocal({ type:'sample', target:h.name, info:'swab ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
          setHint(`‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ${h.name}`);
        } else if(currentTool === 'cam'){
          if(meta) meta.photo++;
          tagHotspotVisual(el, 'cam');
          addEvidenceLocal({ type:'photo', target:h.name, info:'‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô' });
          setHint(`‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: ${h.name}`);
        }

        // reward following AI predicted target
        if(R.coach.lastTarget && R.coach.lastTarget === h.name){
          R.coach.followed++;
          R.coach.lastTarget = null;
          try{
            window.dispatchEvent(new CustomEvent('hha:event', { detail:{ name:'ai_hint_followed', payload:{ target:h.name } } }));
          }catch{}
        }
      }

      // ----- AI prediction / heuristic coach (level 1 usable now) -----
      function computeNextBestAction(){
        // heuristic = prioritize high risk hotspots not yet scanned
        // then scanned but not sampled/photo depending on evidence gap
        const rows = SCENE.hotspots.map(h => {
          const m = R.hotspotsMeta.get(h.name) || {};
          const scanned = m.scanned || 0;
          const swab = m.swab || 0;
          const photo = m.photo || 0;
          const touched = m.touched || 0;
          let priority = h.risk * 100;

          if(scanned === 0) priority += 28;
          if(scanned > 0 && swab === 0) priority += 22;
          if(scanned > 0 && photo === 0) priority += 16;
          if(touched > 1) priority -= 8; // explored enough, shift elsewhere
          if(R.resources.swab <= 1 && swab === 0) priority -= 6; // conserve
          if(R.resources.uv <= 1 && scanned === 0) priority -= 4;

          return { h, m, priority, scanned, swab, photo };
        }).sort((a,b)=> b.priority - a.priority);

        const top = rows[0];
        if(!top) return null;

        let tool = 'uv';
        let reason = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡∏µ‡πâ';
        if(top.scanned > 0 && top.swab === 0 && R.resources.swab > 0){
          tool = 'swab';
          reason = '‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô';
        } else if(top.scanned > 0 && top.photo === 0 && R.resources.cam > 0){
          tool = 'cam';
          reason = '‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å chain';
        } else if(R.resources.uv <= 0 && R.resources.cam > 0){
          tool = 'cam';
          reason = 'UV ‡∏´‡∏°‡∏î ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        }

        return {
          target: top.h.name,
          tool,
          riskScore: Math.round(top.h.risk * 100),
          reason,
          explain: `risk=${Math.round(top.h.risk*100)} ‚Ä¢ scanned=${top.scanned} ‚Ä¢ swab=${top.swab} ‚Ä¢ photo=${top.photo}`
        };
      }

      function updateCoachUI(force){
        if(!P.ai || R.ended) return;
        const now = performance.now();
        if(!force && now < R.coach.coolUntil) return;
        R.coach.coolUntil = now + DIFF.aiHintInt;

        const pred = computeNextBestAction();
        if(!pred) return;

        R.coach.predictions++;
        R.coach.lastTarget = pred.target;
        R.coach.lastTool = pred.tool;

        UI.coachText.textContent = `‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${pred.tool.toUpperCase()} ‡∏ó‡∏µ‡πà ‚Äú${pred.target}‚Äù ‡∏Å‡πà‡∏≠‡∏ô`;
        UI.coachReason.textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${pred.reason} (${pred.explain})`;
        UI.coachLevel.textContent = 'Heuristic / Prediction';

        try{
          window.dispatchEvent(new CustomEvent('hha:coach', { detail:{
            target: pred.target,
            tool: pred.tool,
            riskScore: pred.riskScore,
            reason: pred.reason,
            level: 1
          }}));
        }catch{}
      }

      // ----- hha:shoot support from vr-ui.js (crosshair -> nearest hotspot) -----
      function nearestHotspotFromPoint(x, y, lockPx){
        const nodes = [...document.querySelectorAll('.gd-hotspot')];
        let best = null;
        let bestD = Infinity;

        for(const n of nodes){
          const r = n.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const cy = r.top + r.height/2;
          const dx = cx - x;
          const dy = cy - y;
          const d = Math.hypot(dx, dy);
          if(d < bestD){
            bestD = d; best = n;
          }
        }
        if(!best) return null;

        // generous lock for cVR
        const thresh = Math.max(24, Number(lockPx)||28) + 18;
        if(bestD <= thresh) return best;
        return null;
      }

      window.addEventListener('hha:shoot', (ev)=>{
        if(R.ended || R.paused) return;
        const d = ev.detail || {};
        const x = Number(d.x), y = Number(d.y);
        const lockPx = Number(d.lockPx || 28);

        const n = nearestHotspotFromPoint(x, y, lockPx);
        if(!n){
          setHint('‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤ ‚Äî ‡∏Ç‡∏¢‡∏±‡∏ö crosshair ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á hotspot');
          return;
        }
        const idx = Number(n.dataset.idx || -1);
        const h = SCENE.hotspots[idx];
        if(!h) return;

        handleHotspotAction(h, n);
      });

      // ----- integrate with your core app API (kept, but UI is richer here) -----
      // We still call app.init() so base timers/events exist
      try{ app.init(); }catch(err){ console.warn('GameApp init warning:', err); }

      // cleanup default bare UI generated by prototype app.js (if any)
      // because run page already has full UI
      setTimeout(()=>{
        try{
          // remove prototype toolbar/evidence panel injected into body by old app.js
          document.querySelectorAll('.gd-toolbar, .gd-evidence, #gdTimer').forEach(n=>{
            if(n && n.closest && !n.closest('#app')) n.remove();
          });
          // remove bare spots accidentally appended to body by prototype
          [...document.body.children].forEach(n=>{
            if(n.classList && n.classList.contains('gd-spot')) n.remove();
          });
        }catch{}
      }, 50);

      // ----- manual UI controls -----
      $$('.tool-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const t = b.dataset.tool;
          setToolLocal(t);
          try{ app.setTool(t); }catch{}
          try{ window.PlateSafe.logEvent('tool_change', { tool:t }); }catch{}
          setHint('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠: ' + t.toUpperCase(), 900);
        });
      });

      UI.btnPause.addEventListener('click', ()=>{
        R.paused = !R.paused;
        UI.btnPause.textContent = R.paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        try{
          window.postMessage({ type:'command', action: R.paused ? 'pause' : 'resume' }, '*');
        }catch{}
        try{
          window.dispatchEvent(new CustomEvent('hha:event', { detail:{ name:'pause_toggle', payload:{ paused:R.paused } } }));
        }catch{}
      });

      UI.btnSubmit.addEventListener('click', ()=>{
        endGame('submitted');
      });

      function goHub(){
        location.href = P.hub || '../hub.html';
      }
      UI.btnBack.addEventListener('click', goHub);
      UI.btnBackHub2.addEventListener('click', goHub);

      UI.btnPlayAgain.addEventListener('click', ()=>{
        const u = new URL(location.href);
        u.searchParams.set('seed', String(Date.now()));
        location.href = u.toString();
      });

      // ----- timer sync from app state + 1s loops -----
      let lastTimeLeft = P.time;
      let globalTick = setInterval(()=>{
        if(R.ended) return;
        if(R.paused) return;

        try{
          const st = app.getState ? app.getState() : null;
          if(st && Number.isFinite(st.timeLeft)){
            lastTimeLeft = st.timeLeft;
            UI.hudTime.textContent = String(st.timeLeft) + 's';
            if(st.timeLeft <= 0){
              endGame('timeup');
            }
          } else {
            // fallback if app state unavailable
            lastTimeLeft = Math.max(0, lastTimeLeft - 1);
            UI.hudTime.textContent = String(lastTimeLeft) + 's';
            if(lastTimeLeft <= 0) endGame('timeup');
          }
        }catch{
          lastTimeLeft = Math.max(0, lastTimeLeft - 1);
          UI.hudTime.textContent = String(lastTimeLeft) + 's';
          if(lastTimeLeft <= 0) endGame('timeup');
        }

        // pressure/challenge: dim irrelevant spots on hard after some time
        if(P.diff === 'hard' && (lastTimeLeft % 7 === 0)){
          const nodes = [...document.querySelectorAll('.gd-hotspot')];
          nodes.forEach(n => n.classList.remove('dim'));
          const countDim = Math.min(2, Math.floor(rand()*3));
          for(let i=0;i<countDim;i++){
            const k = Math.floor(rand()*nodes.length);
            nodes[k]?.classList.add('dim');
          }
        }

        // AI coach periodic update
        updateCoachUI(false);

        // emit features event (local HHA)
        try{
          window.dispatchEvent(new CustomEvent('hha:features_1s', { detail:{
            game:'germ-detective',
            timeLeft:lastTimeLeft,
            evidenceCount:R.evidence.length,
            chainCount:R.chains.length,
            score:R.metrics.score,
            exposureReduction:R.metrics.exposureReduction,
            r0Reduction:R.metrics.r0Reduction
          }}));
        }catch{}
      }, 1000);

      // ----- Result / end -----
      function calcBadge(score){
        if(score >= 700) return 'üèÜ Super Sleuth';
        if(score >= 520) return 'ü•á Chain Cracker';
        if(score >= 360) return 'ü•à Smart Scanner';
        if(score >= 220) return 'ü•â Careful Investigator';
        return 'üìù Rookie Detective';
      }

      function saveLastSummary(reason){
        const summary = {
          game: 'germ-detective',
          title: 'Germ Detective',
          reason,
          ts: Date.now(),
          score: R.metrics.score,
          badge: calcBadge(R.metrics.score),
          evidenceCount: R.evidence.length,
          chainCount: R.chains.length,
          exposureReduction: Math.round(R.metrics.exposureReduction),
          r0Reduction: Number(R.metrics.r0Reduction.toFixed(1)),
          diff: P.diff,
          time: P.time,
          seed: P.seed,
          view: P.view,
          run: P.run,
          pid: P.pid || '',
          studyId: P.studyId || ''
        };
        try{
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(summary));
        }catch{}
      }

      function endGame(reason){
        if(R.ended) return;
        R.ended = true;
        clearInterval(globalTick);

        try{ app.stop && app.stop(); }catch{}
        try{ window.PlateSafe.end(reason); }catch{}
        try{ window.PlateLogger.logEvent('session_end', { reason }); }catch{}
        try{
          window.dispatchEvent(new CustomEvent('hha:labels', { detail:{
            type:'end',
            reason,
            score:R.metrics.score,
            exposureReduction:R.metrics.exposureReduction,
            r0Reduction:R.metrics.r0Reduction
          }}));
        }catch{}

        const badge = calcBadge(R.metrics.score);

        UI.resultSubtitle.textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏ö‡πÄ‡∏Å‡∏°: ${reason} ‚Ä¢ ${SCENE.label} ‚Ä¢ ${P.diff.toUpperCase()} ‚Ä¢ ${P.view.toUpperCase()}`;
        UI.resScore.textContent = String(R.metrics.score);
        UI.resBadge.textContent = 'Badge: ' + badge;
        UI.resExposure.textContent = Math.round(R.metrics.exposureReduction) + '%';
        UI.resR0.textContent = R.metrics.r0Reduction.toFixed(1);
        UI.resChainCount.textContent = String(R.chains.length);
        UI.resEvidenceCount.textContent = String(R.evidence.length);
        UI.resScanCount.textContent = String(R.metrics.scanCount);
        UI.resSampleCount.textContent = String(R.metrics.sampleCount);
        UI.resPhotoCount.textContent = String(R.metrics.photoCount);
        UI.resPredUsed.textContent = String(R.coach.predictions);
        UI.resHintFollow.textContent = String(R.coach.followed);

        saveLastSummary(reason);

        UI.resultMask.style.display = 'grid';
      }

      // ----- Back button / unload flush-hardening (local only for now) -----
      window.addEventListener('beforeunload', ()=>{
        try{
          const st = app.getState ? app.getState() : null;
          window.dispatchEvent(new CustomEvent('hha:event', { detail:{
            name:'flush_before_unload',
            payload:{
              evidenceCount: R.evidence.length,
              chainCount: R.chains.length,
              timeLeft: st ? st.timeLeft : lastTimeLeft
            }
          }}));
        }catch{}
      });

      // ----- scene init -----
      spawnSceneHotspots();
      setToolLocal('uv');
      try{ app.setTool('uv'); }catch{}
      updateResourceUI();
      refreshHUD();
      renderChainList();
      updateCoachUI(true);

      // show cVR hint if needed
      if(P.view === 'cvr'){
        setHint('Cardboard: ‡πÄ‡∏•‡πá‡∏á crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 2800);
      } else if(P.view === 'mobile'){
        setHint('‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏ä‡πâ UV ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ hotspot ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡πá‡∏ö sample/photo', 2200);
      }

      // bridge app's evidence into enhanced UI if prototype app emits directly
      window.addEventListener('hha:event', (ev)=>{
        const d = ev.detail || {};
        if(d.name === 'evidence_added' && d.payload){
          // avoid double-adding if event originated from enhanced path
          const p = d.payload;
          const duplicate = R.evidence.findLast?.(x => x.target===p.target && x.type===p.type && x.info===p.info);
          // heuristic duplicate guard: only add if last card not same in <150ms
          if(!duplicate){
            // ignore because enhanced path already adds locally; but keep hook here for compatibility
          }
        }
      });

      // debug info
      console.log('[GermDetective] boot', P);
    })();
  </script>
</body>
</html>