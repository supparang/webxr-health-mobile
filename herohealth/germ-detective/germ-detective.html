<!-- === /herohealth/germ-detective/germ-detective.html ===
Germ Detective RUN ‚Äî PC/Mobile/Cardboard (cVR)
‚úÖ Loads ../vr/vr-ui.js (Universal VR UI)
‚úÖ Query passthrough -> ctx for germ-detective.js
‚úÖ App mount + safe boot
‚úÖ Offline only (no app script)
-->
<!doctype html>
<html lang="th" data-view="pc">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Germ Detective (Run)</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="../favicon.ico" />
  <style>
    :root{
      --bg:#050814;
      --txt: rgba(229,231,235,.95);
      --mut: rgba(148,163,184,.95);
      --line: rgba(148,163,184,.18);
      --panel: rgba(2,6,23,.72);
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(99,102,241,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(34,211,238,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,"Noto Sans Thai",Segoe UI,Roboto,sans-serif;
    }

    .gd-shell{
      min-height:100%;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:10px;
      padding:
        max(10px, env(safe-area-inset-top, 0px))
        max(10px, env(safe-area-inset-right, 0px))
        max(10px, env(safe-area-inset-bottom, 0px))
        max(10px, env(safe-area-inset-left, 0px));
    }

    .gd-topbar{
      display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
      border:1px solid var(--line);
      background: var(--panel);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      z-index: 10;
    }
    .gd-topbar .left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .gd-topbar .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .gd-chip{
      display:inline-flex; align-items:center; gap:6px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(15,23,42,.55);
      padding:6px 10px;
      font-size:12px; font-weight:900;
    }
    .gd-btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:10px; padding:8px 10px;
      color:var(--txt); background: rgba(15,23,42,.75);
      border:1px solid var(--line); font-weight:900;
    }
    .gd-btn:active{ transform: translateY(1px); }

    #gdApp{
      min-height: 0;
      display:block;
    }

    .gd-bootErr{
      margin-top:10px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(127,29,29,.18);
      color: rgba(254,226,226,.95);
      border-radius:12px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
    }

    /* cVR strict helper: prevent accidental pointer on world objects if needed by game */
    html[data-view="cvr"] body{ overscroll-behavior:none; touch-action:manipulation; }

    @media (max-width: 880px){
      .gd-topbar{ padding:9px 10px; }
      .gd-chip{ font-size:11px; }
      .gd-btn{ padding:8px 9px; font-size:12px; }
    }
  </style>
</head>
<body>
  <div class="gd-shell">
    <header class="gd-topbar">
      <div class="left">
        <span class="gd-chip">üïµÔ∏è Germ Detective</span>
        <span class="gd-chip" id="chipCase">Case: -</span>
        <span class="gd-chip" id="chipDiff">Diff: -</span>
        <span class="gd-chip" id="chipView">View: -</span>
      </div>
      <div class="right">
        <button class="gd-btn" id="btnBackLauncher">‚Ü© Launcher</button>
        <button class="gd-btn" id="btnBackHub">üè† HUB</button>
      </div>
    </header>

    <main id="gdApp" aria-label="Germ Detective Game Mount"></main>
  </div>

  <div class="gd-bootErr" id="gdBootErr"></div>

  <!-- Universal VR UI (crosshair / hha:shoot / enterVR/exitVR/recenter) -->
  <script src="../vr/vr-ui.js"></script>

  <script type="module">
    import GameApp from './germ-detective.js';

    (function(){
      'use strict';

      function q(k, def=''){
        try{ return new URL(location.href).searchParams.get(k) ?? def; }
        catch{ return def; }
      }
      function clamp(v,a,b){
        v = Number(v); if(!Number.isFinite(v)) v = a;
        return Math.max(a, Math.min(b, v));
      }

      const ctx = {
        hub: q('hub', '../hub.html'),
        run: q('run', 'play'),
        view: String(q('view','pc')).toLowerCase(),
        diff: String(q('diff','normal')).toLowerCase(),
        caseId: String(q('caseId','classroom')).toLowerCase(),
        timeSec: clamp(q('time','240'), 90, 480),
        seed: q('seed', String(Date.now())),
        pid: q('pid', 'anon'),
        ai: Number(q('ai','1')) === 1 ? 1 : 0,
        gate: 1,
        quick: Number(q('quick','0')) === 1 ? 1 : 0
      };

      if(!['pc','mobile','cvr','cardboard'].includes(ctx.view)) ctx.view = 'pc';
      if(ctx.view === 'cardboard') ctx.view = 'cvr';
      if(!['easy','normal','hard'].includes(ctx.diff)) ctx.diff = 'normal';
      if(!['classroom','home'].includes(ctx.caseId)) ctx.caseId = 'classroom';

      document.documentElement.dataset.view = ctx.view;

      // VR UI config (works with ../vr/vr-ui.js)
      window.HHA_VRUI_CONFIG = {
        lockPx: ctx.view === 'cvr' ? 34 : 28,
        cooldownMs: ctx.view === 'cvr' ? 90 : 90,
        showCrosshair: true,
        showButtons: true,
        cvrStrict: true
      };

      // top chips
      const caseLabel = ctx.caseId === 'home' ? '‡∏ö‡πâ‡∏≤‡∏ô' : '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      document.getElementById('chipCase').textContent = 'Case: ' + caseLabel;
      document.getElementById('chipDiff').textContent = 'Diff: ' + ctx.diff;
      document.getElementById('chipView').textContent = 'View: ' + ctx.view.toUpperCase();

      // nav buttons
      document.getElementById('btnBackHub').addEventListener('click', ()=>{
        location.href = ctx.hub || '../hub.html';
      }, false);

      document.getElementById('btnBackLauncher').addEventListener('click', ()=>{
        const p = new URLSearchParams();
        p.set('hub', ctx.hub || '../hub.html');
        p.set('view', ctx.view);
        p.set('diff', ctx.diff);
        p.set('caseId', ctx.caseId);
        p.set('time', String(ctx.timeSec));
        p.set('seed', ctx.seed);
        p.set('pid', ctx.pid);
        p.set('ai', String(ctx.ai));
        location.href = '../germ-detective.html?' + p.toString();
      }, false);

      // helpful globals for debugging (optional)
      window.__GD_CTX__ = ctx;

      // boot app
      try{
        const app = GameApp({
          mountId: 'gdApp',
          dwellMs: 1200,
          ctx
        });

        window.__GD_APP__ = app;
        app.init();

        // keyboard shortcuts for quick navigation
        window.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){
            // soft pause toggle if app exposes state
            const st = app.getState && app.getState();
            if(!st) return;
            st.running = !st.running;
          }
        }, false);

      }catch(err){
        const box = document.getElementById('gdBootErr');
        box.style.display = 'block';
        box.textContent = 'BOOT ERROR (germ-detective):\\n' + (err && (err.stack || err.message) || String(err));
        console.error(err);
      }
    })();
  </script>
</body>
</html>