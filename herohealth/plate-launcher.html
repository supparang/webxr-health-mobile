<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Plate VR Launcher</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --radius:22px;
      --pill:999px;

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      background:
        radial-gradient(circle at 15% 10%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(circle at 85% 20%, rgba(167,139,250,.12), transparent 58%),
        radial-gradient(circle at 50% 95%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(18px + var(--sab)) calc(14px + var(--sal));
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(135deg, rgba(34,211,238,.25), rgba(167,139,250,.20));
      border:1px solid rgba(148,163,184,.20);
      box-shadow: 0 18px 48px rgba(0,0,0,.30);
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.25;
    }
    .sub{
      margin-top:4px;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.35;
    }

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: var(--radius);
      box-shadow: 0 18px 52px rgba(0,0,0,.32);
      overflow:hidden;
    }
    .cardHd{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:
        radial-gradient(circle at 20% 20%, rgba(34,211,238,.08), transparent 40%),
        rgba(2,6,23,.55);
      border-bottom: 1px solid rgba(148,163,184,.14);
    }
    .cardHd .title{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .cardBd{ padding: 14px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      outline: none;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.06), transparent 40%),
        rgba(15,23,42,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    input::placeholder{ color: rgba(148,163,184,.75); }
    input:focus, select:focus{
      border-color: rgba(34,211,238,.35);
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }

    .seg{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg .opt{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.62);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.2px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .seg .opt[aria-pressed="true"]{
      border-color: rgba(34,197,94,.35);
      background:
        radial-gradient(circle at 20% 20%, rgba(34,197,94,.16), transparent 50%),
        rgba(15,23,42,.72);
      box-shadow: 0 0 0 3px rgba(34,197,94,.10), inset 0 1px 0 rgba(255,255,255,.08);
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .btns{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 12px;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(148,163,184,.18);
      color: var(--text);
      background: rgba(15,23,42,.65);
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.15px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 16px 48px rgba(0,0,0,.28);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.08); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color: rgba(34,197,94,.30);
      background:
        radial-gradient(circle at 20% 20%, rgba(34,197,94,.16), transparent 48%),
        rgba(15,23,42,.70);
    }
    .btn.cyan{
      border-color: rgba(34,211,238,.32);
      background:
        radial-gradient(circle at 20% 20%, rgba(34,211,238,.16), transparent 48%),
        rgba(15,23,42,.70);
    }
    .btn.warn{
      border-color: rgba(245,158,11,.32);
      background:
        radial-gradient(circle at 20% 20%, rgba(245,158,11,.16), transparent 48%),
        rgba(15,23,42,.70);
    }
    .btn.bad{
      border-color: rgba(239,68,68,.30);
      background:
        radial-gradient(circle at 20% 20%, rgba(239,68,68,.16), transparent 48%),
        rgba(15,23,42,.70);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.35;
      word-break: break-all;
    }
    .previewBox{
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(148,163,184,.22);
      background: rgba(2,6,23,.40);
    }

    .status{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }

    .qrWrap{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 12px;
      align-items:center;
    }
    @media (max-width: 520px){
      .qrWrap{ grid-template-columns: 1fr; }
    }
    canvas{
      width: 160px;
      height: 160px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background:#fff;
    }
    .qrLink{
      display:block;
      color: var(--text);
      text-decoration:none;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.62);
      padding: 10px 12px;
    }
    .qrLink:hover{ filter:brightness(1.08); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background:
        radial-gradient(circle at 20% 20%, rgba(34,211,238,.10), transparent 42%),
        rgba(15,23,42,.68);
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 16px 48px rgba(0,0,0,.28);
      margin: 6px 8px 0 0;
    }

    pre{
      margin: 10px 0 0 0;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.50);
      color: var(--text);
      overflow:auto;
      max-height: 280px;
      display:none;
    }

    .tiny{
      font-size: 11.5px;
      color: var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>üçΩÔ∏è HeroHealth ‚Äî Balanced Plate VR Launcher</h1>
          <div class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô/‡∏ß‡∏¥‡∏à‡∏±‡∏¢ + ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå + ‡∏ó‡∏≥‡∏•‡∏¥‡∏á‡∏Å‡πå/QR ‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
        </div>
      </div>

      <div class="topActions">
        <button id="btnBackHubTop" class="btn cyan" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button id="btnPresetResearch" class="btn warn" type="button">üéì Preset ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏õ.5</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <div class="cardHd">
          <div class="title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°</div>
          <div class="tiny">plate-vr.html</div>
        </div>
        <div class="cardBd">
          <div>
            <label>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå / View</label>
            <div id="segView" class="seg" role="group" aria-label="View">
              <button class="opt" data-view="pc" type="button" aria-pressed="false">üñ•Ô∏è PC</button>
              <button class="opt" data-view="mobile" type="button" aria-pressed="true">üì± Mobile</button>
              <button class="opt" data-view="cvr" type="button" aria-pressed="false">üï∂Ô∏è Cardboard (cVR)</button>
            </div>
            <div id="viewHint" class="hint">üì± Mobile: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤ + ‡∏Ç‡∏¢‡∏±‡∏ö‡∏à‡∏≠ (gyro/drag) ‡πÑ‡∏î‡πâ</div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label>Run Mode</label>
              <select id="selRun">
                <option value="play">play (Adaptive ON)</option>
                <option value="study">study/research (deterministic)</option>
              </select>
              <div id="seedHint" class="hint">Play: seed ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á); ‡πÉ‡∏™‡πà seed ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ debug ‡∏Å‡πá‡πÑ‡∏î‡πâ</div>
            </div>

            <div>
              <label>Difficulty</label>
              <select id="selDiff">
                <option value="easy">easy</option>
                <option value="normal" selected>normal</option>
                <option value="hard">hard</option>
              </select>
              <div class="hint">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: normal (‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
              <input id="inpTime" type="number" min="20" max="9999" value="90" />
            </div>
            <div>
              <label>Seed (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏ô Play)</label>
              <input id="inpSeed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13579" value="" />
            </div>
          </div>

          <div>
            <label>Hub URL (‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö HUB ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)</label>
            <input id="inpHub" type="text" placeholder="https://‚Ä¶/herohealth/hub.html" value="" />
            <div class="btns">
              <button id="btnUseCurrentHub" class="btn" type="button">üß∑ ‡πÉ‡∏ä‡πâ hub ‡∏à‡∏≤‡∏Å URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
              <button id="btnReset" class="btn" type="button">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>
          </div>

          <div class="card" style="margin-top:14px;">
            <div class="cardHd">
              <div class="title">üîó Preview URL</div>
              <div class="tiny">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å/‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á QR</div>
            </div>
            <div class="cardBd">
              <div class="previewBox mono" id="previewUrl">‚Äî</div>
              <div class="btns">
                <button id="btnGo" class="btn primary" type="button">‚ñ∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô</button>
                <button id="btnCopy" class="btn" type="button">üìã Copy link</button>
                <button id="btnShowQR" class="btn cyan" type="button">üì∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR</button>
              </div>
              <div id="status" class="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div class="tiny">Tip: ‡∏ñ‡πâ‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå/‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå</div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: QR + Summary -->
      <section class="card">
        <div class="cardHd">
          <div class="title">üì∑ QR + ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="tiny">localStorage</div>
        </div>
        <div class="cardBd">
          <div class="card" style="margin-bottom:14px;">
            <div class="cardHd">
              <div class="title">üì∑ QR (‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)</div>
              <div class="tiny">Canvas QR</div>
            </div>
            <div class="cardBd">
              <div class="qrWrap">
                <canvas id="qrCanvas" width="320" height="320" aria-label="QR code"></canvas>
                <div>
                  <a id="qrLink" class="qrLink mono" href="#" target="_blank" rel="noopener">‚Äî</a>
                  <div class="btns" style="margin-top:10px;">
                    <button id="btnCopyQRLink" class="btn" type="button">üìã Copy link</button>
                  </div>
                  <div class="tiny">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHd">
              <div class="title">üßæ ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (LS_LAST)</div>
              <div class="tiny">HHA_LAST_SUMMARY</div>
            </div>
            <div class="cardBd">
              <div id="sumPills"></div>
              <div id="sumText" class="status">‚Äî</div>
              <div class="btns">
                <button id="btnCopySummary" class="btn" type="button">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å summary JSON</button>
                <button id="btnClearSummary" class="btn bad" type="button">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                <button id="btnToggleSummary" class="btn" type="button">üßæ ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô JSON</button>
              </div>
              <pre id="sumJson" class="mono"></pre>
              <div class="tiny" style="margin-top:10px;">
                * ‡∏ñ‡πâ‡∏≤ ‚Äú‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ß‡πà‡∏≤‡∏á‚Äù ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏ö‡πÄ‡∏Å‡∏° Plate ‡∏´‡∏£‡∏∑‡∏≠ LS ‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </div>

  <script>
  (function(){
    const LS_PREF = 'HHA_PLATE_LAUNCHER_PREFS';
    const LS_LAST = 'HHA_LAST_SUMMARY';

    const URLX = new URL(location.href);

    const segView = document.getElementById('segView');
    const selRun  = document.getElementById('selRun');
    const selDiff = document.getElementById('selDiff');
    const inpTime = document.getElementById('inpTime');
    const inpSeed = document.getElementById('inpSeed');
    const inpHub  = document.getElementById('inpHub');

    const viewHint = document.getElementById('viewHint');
    const seedHint = document.getElementById('seedHint');

    const btnGo = document.getElementById('btnGo');
    const btnCopy = document.getElementById('btnCopy');
    const btnReset = document.getElementById('btnReset');
    const btnUseCurrentHub = document.getElementById('btnUseCurrentHub');
    const btnBackHubTop = document.getElementById('btnBackHubTop');
    const btnPresetResearch = document.getElementById('btnPresetResearch');
    const btnShowQR = document.getElementById('btnShowQR');

    const status = document.getElementById('status');
    const previewUrl = document.getElementById('previewUrl');

    const sumPills = document.getElementById('sumPills');
    const sumText = document.getElementById('sumText');
    const sumJson = document.getElementById('sumJson');
    const btnCopySummary = document.getElementById('btnCopySummary');
    const btnClearSummary = document.getElementById('btnClearSummary');
    const btnToggleSummary = document.getElementById('btnToggleSummary');

    const qrCanvas = document.getElementById('qrCanvas');
    const qrLinkEl = document.getElementById('qrLink');
    const btnCopyQRLink = document.getElementById('btnCopyQRLink');

    function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

    function loadJson(key, fallback){
      try{
        const s = localStorage.getItem(key);
        if(!s) return fallback;
        return JSON.parse(s);
      }catch(e){ return fallback; }
    }
    function saveJson(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
    }

    function setPressed(btn){
      const buttons = segView.querySelectorAll('button.opt');
      buttons.forEach(b=> b.setAttribute('aria-pressed', b===btn ? 'true' : 'false'));
    }
    function getView(){
      const b = segView.querySelector('button.opt[aria-pressed="true"]');
      return b ? (b.getAttribute('data-view') || 'mobile') : 'mobile';
    }
    function setView(v){
      const btn = segView.querySelector(`button.opt[data-view="${v}"]`) || segView.querySelector('button.opt[data-view="mobile"]');
      if(btn) setPressed(btn);
    }

    function updateHints(){
      const v = getView();
      if(v === 'pc') viewHint.textContent = 'üñ•Ô∏è PC: ‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÅ‡∏ï‡∏∞‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á ‡πÜ (pointer)';
      else if(v === 'mobile') viewHint.textContent = 'üì± Mobile: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤ + ‡∏Ç‡∏¢‡∏±‡∏ö‡∏à‡∏≠ (gyro/drag) ‡πÑ‡∏î‡πâ';
      else viewHint.textContent = 'üï∂Ô∏è Cardboard (cVR): ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏ú‡πà‡∏≤‡∏ô vr-ui.js (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤)';

      const run = (selRun.value || 'play').toLowerCase();
      seedHint.textContent =
        (run === 'study')
          ? 'Study/Research: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏™‡πà seed ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 13579) ‡πÄ‡∏û‡∏∑‡πà‡∏≠ deterministic'
          : 'Play: seed ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á); ‡πÉ‡∏™‡πà seed ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ debug ‡∏Å‡πá‡πÑ‡∏î‡πâ';
    }

    function computeUrl(){
      const v = getView();
      const run = (selRun.value || 'play').toLowerCase();
      const diff = (selDiff.value || 'normal').toLowerCase();
      const time = clamp(inpTime.value || 90, 20, 9999);
      const seed = (inpSeed.value || '').trim();
      const hub  = (inpHub.value || '').trim();

      const u = new URL('./plate-vr.html', location.href);
      u.searchParams.set('view', v);
      u.searchParams.set('run', run);
      u.searchParams.set('diff', diff);
      u.searchParams.set('time', String(time));
      if(hub) u.searchParams.set('hub', hub);

      if(run === 'study'){
        u.searchParams.set('seed', seed || '13579');
      }else{
        if(seed) u.searchParams.set('seed', seed);
        else u.searchParams.delete('seed');
      }
      return u.toString();
    }

    function persistPrefs(){
      const prefs = {
        view: getView(),
        run: (selRun.value || 'play'),
        diff: (selDiff.value || 'normal'),
        time: String(clamp(inpTime.value || 90, 20, 9999)),
        seed: (inpSeed.value || '').trim(),
        hub: (inpHub.value || '').trim()
      };
      saveJson(LS_PREF, prefs);
    }

    function updatePreview(){
      const u = computeUrl();
      previewUrl.textContent = u;
      persistPrefs();
      updateQR(false);
    }

    function applyPrefs(){
      const p = loadJson(LS_PREF, null);
      if(!p) return;
      setView(p.view || 'mobile');
      selRun.value = p.run || 'play';
      selDiff.value = p.diff || 'normal';
      inpTime.value = p.time || '90';
      inpSeed.value = p.seed || '';
      inpHub.value  = p.hub || '';
    }

    function applyFromQuery(){
      const v = (URLX.searchParams.get('view') || '').toLowerCase();
      const run = (URLX.searchParams.get('run') || URLX.searchParams.get('runMode') || '').toLowerCase();
      const diff = (URLX.searchParams.get('diff') || '').toLowerCase();
      const time = URLX.searchParams.get('time');
      const seed = URLX.searchParams.get('seed');
      const hub = URLX.searchParams.get('hub');

      if(v) setView(v);
      if(run) selRun.value = run;
      if(diff) selDiff.value = diff;
      if(time) inpTime.value = clamp(time, 20, 9999);
      if(seed != null) inpSeed.value = String(seed);
      if(hub != null) inpHub.value = String(hub);
    }

    // -----------------------------
    // Last summary UI
    // -----------------------------
    function renderSummary(){
      sumPills.innerHTML = '';
      const s = loadJson(LS_LAST, null);
      if(!s){
        sumText.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ (HHA_LAST_SUMMARY ‡∏ß‡πà‡∏≤‡∏á)';
        sumJson.style.display = 'none';
        sumJson.textContent = '';
        return;
      }

      function addPill(text){
        const p = document.createElement('span');
        p.className = 'pill';
        p.textContent = text;
        sumPills.appendChild(p);
      }

      addPill('üéÆ ' + (s.gameMode || s.game || 'plate'));
      addPill('üß™ ' + (s.runMode || 'play'));
      addPill('üéöÔ∏è ' + (s.diff || 'normal'));
      addPill('üèÜ ' + (s.scoreFinal ?? 0));
      addPill('üî• max ' + (s.comboMax ?? 0));
      addPill('üí• miss ' + (s.misses ?? 0));
      addPill('üéØ acc ' + ((s.accuracyGoodPct ?? 0) + '%'));
      addPill('üèÖ ' + (s.grade || 'C'));
      addPill('üå± seed ' + (s.seed ?? ''));

      const when = s.endTimeIso || s.timestampIso || '';
      sumText.textContent =
        `‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${when ? when : '(unknown)'} ‚Ä¢ Goals ${s.goalsCleared ?? 0}/${s.goalsTotal ?? 0} ‚Ä¢ Minis ${s.miniCleared ?? 0}/${s.miniTotal ?? 0}`;

      sumJson.textContent = JSON.stringify(s, null, 2);
      sumJson.style.display = 'none';
    }

    // -----------------------------
    // REAL QR CODE (canvas) ‚Äî tiny embedded encoder
    // -----------------------------
    function makeQRMatrix(text){
      function utf8Bytes(str){
        const out = [];
        for (let i=0;i<str.length;i++){
          let c = str.charCodeAt(i);
          if (c < 0x80) out.push(c);
          else if (c < 0x800){ out.push(0xC0 | (c>>6), 0x80 | (c & 0x3F)); }
          else if (c >= 0xD800 && c <= 0xDBFF){
            const hi = c;
            const lo = str.charCodeAt(++i);
            const cp = 0x10000 + ((hi-0xD800)<<10) + (lo-0xDC00);
            out.push(
              0xF0 | (cp>>18),
              0x80 | ((cp>>12)&0x3F),
              0x80 | ((cp>>6)&0x3F),
              0x80 | (cp&0x3F)
            );
          }else{
            out.push(0xE0 | (c>>12), 0x80 | ((c>>6)&0x3F), 0x80 | (c&0x3F));
          }
        }
        return out;
      }

      const bytes = utf8Bytes(text);
      const ver = (bytes.length <= 86) ? 5 : 6; // v5/v6 level M
      const size = 17 + ver*4;

      // GF256 for RS
      const GF_EXP = new Uint8Array(512);
      const GF_LOG = new Uint8Array(256);
      (function initGF(){
        let x = 1;
        for(let i=0;i<255;i++){
          GF_EXP[i] = x;
          GF_LOG[x] = i;
          x <<= 1;
          if(x & 0x100) x ^= 0x11d;
        }
        for(let i=255;i<512;i++) GF_EXP[i] = GF_EXP[i-255];
      })();
      function gfMul(a,b){
        if(a===0||b===0) return 0;
        return GF_EXP[GF_LOG[a] + GF_LOG[b]];
      }
      function rsGenerator(deg){
        let poly = [1];
        for(let i=0;i<deg;i++){
          const a = GF_EXP[i];
          const next = new Array(poly.length+1).fill(0);
          for(let j=0;j<poly.length;j++){
            next[j] ^= gfMul(poly[j], a);
            next[j+1] ^= poly[j];
          }
          poly = next;
        }
        return poly;
      }
      function rsEncode(data, ecLen){
        const gen = rsGenerator(ecLen);
        const msg = data.slice();
        msg.push(...new Array(ecLen).fill(0));
        for(let i=0;i<data.length;i++){
          const coef = msg[i];
          if(coef===0) continue;
          for(let j=0;j<gen.length;j++){
            msg[i+j] ^= gfMul(gen[j], coef);
          }
        }
        return msg.slice(msg.length-ecLen);
      }

      // Version params (byte mode, EC=M) ‚Äî simplified 2 blocks
      const params = {
        5: { dataCW: 86, ecCW: 24, blocks: 2 },
        6: { dataCW: 108, ecCW: 28, blocks: 2 },
      }[ver];

      function pushBits(arr, val, n){
        for(let i=n-1;i>=0;i--) arr.push((val>>i)&1);
      }

      const bits = [];
      pushBits(bits, 0b0100, 4);                 // mode: byte
      pushBits(bits, bytes.length, (ver<=9)?8:16);
      for(const b of bytes) pushBits(bits, b, 8);
      pushBits(bits, 0, 4);                      // terminator
      while(bits.length % 8) bits.push(0);

      const cws = [];
      for(let i=0;i<bits.length;i+=8){
        let v=0;
        for(let j=0;j<8;j++) v = (v<<1) | bits[i+j];
        cws.push(v);
      }

      const PAD0 = 0xEC, PAD1 = 0x11;
      let padToggle = 0;
      while(cws.length < params.dataCW){
        cws.push(padToggle ? PAD1 : PAD0);
        padToggle ^= 1;
      }

      const blocks = [];
      const per = Math.floor(params.dataCW / params.blocks);
      let idx = 0;
      for(let b=0;b<params.blocks;b++){
        const take = (b===params.blocks-1) ? (params.dataCW-idx) : per;
        blocks.push(cws.slice(idx, idx+take));
        idx += take;
      }

      const ecBlocks = blocks.map(bl => rsEncode(bl, params.ecCW / params.blocks));

      // interleave
      const inter = [];
      const maxData = Math.max(...blocks.map(b=>b.length));
      for(let i=0;i<maxData;i++){
        for(const b of blocks) if(i<b.length) inter.push(b[i]);
      }
      const maxEc = Math.max(...ecBlocks.map(b=>b.length));
      for(let i=0;i<maxEc;i++){
        for(const b of ecBlocks) if(i<b.length) inter.push(b[i]);
      }

      const stream = [];
      for(const cw of inter) pushBits(stream, cw, 8);

      const m = Array.from({length:size}, ()=>Array(size).fill(null));
      function set(x,y,v){ if(x>=0&&y>=0&&x<size&&y<size) m[y][x]=v; }

      // finders
      function finder(x,y){
        for(let dy=-1;dy<=7;dy++){
          for(let dx=-1;dx<=7;dx++){
            const xx=x+dx, yy=y+dy;
            const on =
              (dx>=0&&dx<=6&&dy>=0&&dy<=6) &&
              (dx===0||dx===6||dy===0||dy===6 || (dx>=2&&dx<=4&&dy>=2&&dy<=4));
            set(xx,yy,on?1:0);
          }
        }
      }
      finder(0,0); finder(size-7,0); finder(0,size-7);

      // timing
      for(let i=8;i<size-8;i++){
        set(i,6, (i%2)?0:1);
        set(6,i, (i%2)?0:1);
      }

      // dark module
      set(8, size-8, 1);

      // reserve format areas
      for(let i=0;i<9;i++){
        if(m[8][i]===null) set(i,8,0);
        if(m[i][8]===null) set(8,i,0);
        if(m[8][size-1-i]===null) set(size-1-i,8,0);
        if(m[size-1-i][8]===null) set(8,size-1-i,0);
      }

      // alignment (v5: 6,30) (v6: 6,34)
      const ap = (ver===5) ? [6, 30] : [6, 34];
      function align(cx,cy){
        for(let dy=-2;dy<=2;dy++){
          for(let dx=-2;dx<=2;dx++){
            const xx=cx+dx, yy=cy+dy;
            const dist = Math.max(Math.abs(dx),Math.abs(dy));
            set(xx,yy, (dist===2 || (dx===0 && dy===0)) ? 1 : 0);
          }
        }
      }
      for(let i=0;i<ap.length;i++){
        for(let j=0;j<ap.length;j++){
          const cx=ap[i], cy=ap[j];
          const nearFinder =
            (cx===6 && cy===6) ||
            (cx===6 && cy===size-7) ||
            (cx===size-7 && cy===6);
          if(!nearFinder) align(cx,cy);
        }
      }

      // data placement with mask 0
      let bitIdx=0;
      let dirUp=true;
      for(let x=size-1; x>0; x-=2){
        if(x===6) x--;
        for(let k=0;k<size;k++){
          const y = dirUp ? (size-1-k) : k;
          for(let dx=0;dx<2;dx++){
            const xx = x-dx;
            if(m[y][xx]!==null) continue;
            const bit = (bitIdx < stream.length) ? stream[bitIdx++] : 0;
            const masked = ((xx + y) % 2 === 0) ? (bit ^ 1) : bit;
            m[y][xx] = masked;
          }
        }
        dirUp = !dirUp;
      }

      // format info for (EC=M, mask 0) => 0x5412
      const format = 0x5412;
      function formatBit(i){ return (format >> i) & 1; }

      const coords1 = [
        [0,8],[1,8],[2,8],[3,8],[4,8],[5,8],[7,8],[8,8],[8,7],[8,5],[8,4],[8,3],[8,2],[8,1],[8,0]
      ];
      for(let i=0;i<15;i++){
        const b = formatBit(14-i);
        const [x,y] = coords1[i];
        m[y][x] = b;
      }
      const coords2 = [
        [size-1,8],[size-2,8],[size-3,8],[size-4,8],[size-5,8],[size-6,8],[size-7,8],[size-8,8],
        [8,size-7],[8,size-6],[8,size-5],[8,size-4],[8,size-3],[8,size-2],[8,size-1]
      ];
      for(let i=0;i<15;i++){
        const b = formatBit(14-i);
        const [x,y] = coords2[i];
        m[y][x] = b;
      }

      return m;
    }

    function drawQR(canvas, text){
      const ctx = canvas.getContext('2d', { alpha:false });
      const W = canvas.width, H = canvas.height;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      const mat = makeQRMatrix(text);
      const N = mat.length;

      const pad = 12;
      const cell = Math.floor((Math.min(W,H) - pad*2) / N);
      const x0 = Math.floor((W - cell*N)/2);
      const y0 = Math.floor((H - cell*N)/2);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = '#000000';
      for(let y=0;y<N;y++){
        for(let x=0;x<N;x++){
          if(mat[y][x]===1){
            ctx.fillRect(x0 + x*cell, y0 + y*cell, cell, cell);
          }
        }
      }
    }

    function updateQR(draw){
      const u = computeUrl();
      qrLinkEl.textContent = u;
      qrLinkEl.href = u;
      if(draw){
        try{
          drawQR(qrCanvas, u);
          status.textContent = 'üì∑ QR (‡∏à‡∏£‡∏¥‡∏á) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß';
        }catch(e){
          status.textContent = '‚ö†Ô∏è ‡∏ß‡∏≤‡∏î QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå/‡∏•‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)';
        }
      }
    }

    async function copyText(t){
      try{ await navigator.clipboard.writeText(t); return true; }
      catch(e){ return false; }
    }

    // controls
    segView.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.opt');
      if(!btn) return;
      setPressed(btn);
      updateHints();
      updatePreview();
    }, {passive:true});

    [selRun, selDiff].forEach(el=>{
      el.addEventListener('change', ()=>{ updateHints(); updatePreview(); }, {passive:true});
    });
    [inpTime, inpSeed, inpHub].forEach(el=>{
      el.addEventListener('input', ()=>{ updateHints(); updatePreview(); }, {passive:true});
      el.addEventListener('change', ()=>{ updateHints(); updatePreview(); }, {passive:true});
    });

    btnUseCurrentHub.addEventListener('click', ()=>{
      const hub = URLX.searchParams.get('hub');
      if(hub){ inpHub.value = hub; status.textContent = '‚úÖ ‡∏î‡∏∂‡∏á hub ‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß'; }
      else{ status.textContent = '‚ö†Ô∏è URL ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ hub=‚Ä¶'; }
      updatePreview();
    }, {passive:true});

    btnBackHubTop.addEventListener('click', ()=>{
      const hub = (inpHub.value || '').trim();
      location.href = hub ? hub : './hub.html';
    }, {passive:true});

    btnPresetResearch.addEventListener('click', ()=>{
      setView('mobile');
      selRun.value = 'study';
      selDiff.value = 'normal';
      inpTime.value = '90';
      inpSeed.value = '13579';
      status.textContent = 'üéì Preset ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏õ.5 ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
      updateHints();
      updatePreview();
      updateQR(true);
    }, {passive:true});

    btnGo.addEventListener('click', ()=>{
      const u = computeUrl();
      status.textContent = '‚ñ∂ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°‚Ä¶';
      location.href = u;
    }, {passive:true});

    btnCopy.addEventListener('click', async ()=>{
      const u = computeUrl();
      const ok = await copyText(u);
      status.textContent = ok ? '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á preview ‡πÑ‡∏î‡πâ';
    }, {passive:true});

    btnShowQR.addEventListener('click', ()=> updateQR(true), {passive:true});

    btnReset.addEventListener('click', ()=>{
      setView('mobile');
      selRun.value = 'play';
      selDiff.value = 'normal';
      inpTime.value = '90';
      inpSeed.value = '';
      inpHub.value = URLX.searchParams.get('hub') || '';
      status.textContent = '‚ôª ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß';
      updateHints();
      updatePreview();
      updateQR(true);
    }, {passive:true});

    btnCopyQRLink.addEventListener('click', async ()=>{
      const u = computeUrl();
      const ok = await copyText(u);
      status.textContent = ok ? '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }, {passive:true});

    btnCopySummary.addEventListener('click', async ()=>{
      const s = loadJson(LS_LAST, null);
      if(!s){ status.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'; return; }
      const ok = await copyText(JSON.stringify(s));
      status.textContent = ok ? '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å summary ‡πÅ‡∏•‡πâ‡∏ß' : '‚ö†Ô∏è ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }, {passive:true});

    btnClearSummary.addEventListener('click', ()=>{
      try{ localStorage.removeItem(LS_LAST); }catch(e){}
      renderSummary();
      status.textContent = 'üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
    }, {passive:true});

    btnToggleSummary.addEventListener('click', ()=>{
      const show = (sumJson.style.display !== 'block');
      sumJson.style.display = show ? 'block' : 'none';
      status.textContent = show ? 'üßæ ‡πÅ‡∏™‡∏î‡∏á JSON ‡πÅ‡∏•‡πâ‡∏ß' : 'üßæ ‡∏ã‡πà‡∏≠‡∏ô JSON ‡πÅ‡∏•‡πâ‡∏ß';
    }, {passive:true});

    // init
    applyPrefs();
    applyFromQuery();

    if(!inpHub.value){
      const hub = URLX.searchParams.get('hub');
      if(hub) inpHub.value = hub;
    }
    if(!segView.querySelector('button.opt[aria-pressed="true"]')) setView('mobile');

    updateHints();
    updatePreview();
    renderSummary();
    updateQR(true);
  })();
  </script>
</body>
</html>
