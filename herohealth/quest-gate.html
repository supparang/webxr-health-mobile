<!-- === /herohealth/quest-gate.html ===
HeroHealth ‚Äî Quest Gate (Warm-up 3 Quests ‚Üí Zone Boss ‚Üí Cooldown ‚Üí Next Game)
‚úÖ Strict: must finish Quest 1‚Äì3 before Boss unlock
‚úÖ Must win zone boss to proceed
‚úÖ Cooldown auto after win, then redirect to next (next=...)
‚úÖ Pass-through: pid/run/diff/time/seed/studyId/phase/conditionGroup/log/view + hub
‚úÖ Never override existing params; only adds hub if missing on next
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Quest Gate</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --cyan:#22d3ee; --violet:#a78bfa;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1000px 600px at 85% 20%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(900px 520px at 55% 90%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      overflow:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ height:100%; max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 10px 10px 0 10px;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{ margin:0; font-size: clamp(20px, 2.0vw, 28px); letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size: 13px; line-height:1.4; max-width: 72ch; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .pill b{ color:var(--text); font-weight:800; }

    .panel{
      flex:1;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .bar{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
    }
    .leftbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color:var(--text);
      user-select:none;
      white-space:nowrap;
    }
    .badge .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 18px rgba(245,158,11,.35);
    }
    .badge.ok .dot{ background: var(--good); box-shadow: 0 0 18px rgba(34,197,94,.35); }
    .badge.bad .dot{ background: var(--bad); box-shadow: 0 0 18px rgba(239,68,68,.35); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      padding:10px 12px;
      border-radius: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.disabled{ opacity:.45; cursor:not-allowed; }
    .btn.good{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); color: var(--text); }
    .btn.ghost{ color:var(--muted); }

    .content{
      flex:1;
      display:grid;
      grid-template-columns: 1fr .95fr;
      gap: 12px;
      padding: 12px;
      min-height:0;
    }
    @media (max-width: 980px){
      .content{ grid-template-columns: 1fr; }
      .pillrow{ justify-content:flex-start; }
      .actions{ justify-content:flex-start; }
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.40);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      overflow:hidden;
      min-height: 180px;
      position:relative;
    }
    .card h3{ margin:0 0 6px 0; font-size:16px; letter-spacing:.2px; }
    .card p{ margin:0; color:var(--muted); font-size: 13px; line-height: 1.45; }
    .glow{
      position:absolute; inset:-40% -30% auto auto;
      width:240px; height:240px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.22), transparent 60%);
      filter: blur(10px);
      transform: rotate(14deg);
      pointer-events:none;
      opacity:.9;
    }
    .glow.green{ background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.24), transparent 60%); }
    .glow.violet{ background: radial-gradient(circle at 30% 30%, rgba(167,139,250,.22), transparent 60%); }

    .stepRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .step{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.32);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .step.ok{ color:var(--text); border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .step .n{
      width:20px; height:20px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:900;
      color:var(--text);
      background: rgba(255,255,255,.06);
    }

    .arena{
      border:1px dashed rgba(148,163,184,.26);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px;
      margin-top: 12px;
      min-height: 260px;
      position:relative;
      overflow:hidden;
    }
    .arenaTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .meter{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.30);
      border-radius: 14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 220px;
    }
    .meter .k{ color:var(--muted); font-size:12px; }
    .barWrap{ height:10px; background: rgba(0,0,0,.35); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.10); }
    .barFill{ height:100%; width:0%; background: rgba(34,211,238,.85); transition: width .15s ease; }
    .barFill.good{ background: rgba(34,197,94,.85); }
    .barFill.bad{ background: rgba(239,68,68,.85); }

    .big{
      font-size: clamp(28px, 4vw, 44px);
      font-weight: 900;
      letter-spacing: .5px;
      margin: 6px 0 2px 0;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:6px;
    }

    .ctaRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta{
      flex: 1 1 220px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .cta:hover{ border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.08); }
    .cta:active{ transform: translateY(1px); }
    .cta.disabled{ opacity:.45; cursor:not-allowed; }
    .cta .ico{ font-size:20px; }
    .cta .t{ font-weight:900; }
    .cta .d{ color:var(--muted); font-size:12px; line-height:1.35; margin-top:2px; }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,6,23,.66);
      backdrop-filter: blur(8px);
      z-index: 50;
      padding: 14px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(680px, 92vw);
      background: rgba(2,6,23,.80);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal h4{ margin:0 0 6px 0; font-size:16px; }
    .modal p{ margin:0; color:var(--muted); font-size:13px; line-height:1.45; }
    .modal .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:space-between; }
    .modal .btn{ flex: 1 1 220px; justify-content:center; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--sab));
      transform: translateX(-50%);
      background: rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 9999;
      max-width: 92vw;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity: 1; }

    /* mini ‚Äútargets‚Äù */
    .dotTarget{
      position:absolute;
      width:44px; height:44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 34px rgba(0,0,0,.35);
      transform: translate(-50%,-50%);
    }
    .dotTarget:active{ transform: translate(-50%,-50%) scale(.97); }
    .dotTarget .e{ font-size: 18px; }

    /* list buttons */
    .choices{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px; }
    @media (max-width:520px){ .choices{ grid-template-columns: 1fr; } }
    .choiceBtn{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.34);
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .choiceBtn:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); }
    .choiceBtn:active{ transform: translateY(1px); }
    .choiceBtn.good{ border-color: rgba(34,197,94,.28); }
    .choiceBtn.bad{ border-color: rgba(239,68,68,.28); }
    .choiceBtn .lhs{ display:flex; align-items:center; gap:10px; }
    .choiceBtn .emo{ font-size:20px; }
    .choiceBtn .txt{ font-weight:900; }
    .choiceBtn .sub{ color:var(--muted); font-size:12px; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 class="title">üõ°Ô∏è HeroHealth ‚Äî Quest Gate</h1>
        <p class="subtitle" id="subTitle">‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 Quest ‚Üí ‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÇ‡∏ã‡∏ô ‚Üí ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å (‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ç‡πâ‡∏° ‡πÑ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏°)</p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <div class="panel">
      <div class="bar">
        <div class="leftbar">
          <div class="badge" id="badgeState"><span class="dot"></span><span id="badgeText">LOCKED</span></div>
          <div class="badge ok" id="badgeZone"><span class="dot"></span><span id="zoneText">zone</span></div>
          <div class="badge" id="badgeNext"><span class="dot"></span><span id="nextText">next</span></div>
        </div>

        <div class="actions">
          <div class="btn ghost" id="btnBackHub">‚Ü©Ô∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</div>
          <div class="btn warn" id="btnRestart">‚ôªÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
          <div class="btn good disabled" id="btnGoNext">‚û°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å</div>
        </div>
      </div>

      <div class="content">
        <!-- LEFT: Flow card -->
        <div class="card" id="cardFlow">
          <div class="glow" id="flowGlow"></div>
          <h3 id="flowTitle">Warm-up Gate</h3>
          <p id="flowDesc">‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö 3 Quest ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏ö‡∏≠‡∏™‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏ä‡∏ô‡∏∞‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ</p>

          <div class="stepRow">
            <div class="step" id="s1"><span class="n">1</span> Quest: ‡∏´‡∏≤‡∏¢‡πÉ‡∏à</div>
            <div class="step" id="s2"><span class="n">2</span> Quest: ‡πÇ‡∏ü‡∏Å‡∏±‡∏™</div>
            <div class="step" id="s3"><span class="n">3</span> Quest: ‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î</div>
            <div class="step" id="sb"><span class="n">B</span> Boss ‡πÇ‡∏ã‡∏ô</div>
            <div class="step" id="sc"><span class="n">C</span> Cooldown</div>
          </div>

          <div class="ctaRow">
            <div class="cta" id="ctaQ1">
              <div class="ico">ü´Å</div>
              <div>
                <div class="t">Quest 1 ‚Äî Breathing</div>
                <div class="d">‡∏ó‡∏≥ ‚Äú‡∏£‡∏≠‡∏ö‡∏´‡∏≤‡∏¢‡πÉ‡∏à‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 8 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏á ‡πÜ</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaQ2">
              <div class="ico">üëÄ</div>
              <div>
                <div class="t">Quest 2 ‚Äî Focus</div>
                <div class="d">‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á) ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaQ3">
              <div class="ico">ü§∏</div>
              <div>
                <div class="t">Quest 3 ‚Äî Stretch</div>
                <div class="d">‡∏ó‡∏≥‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ (‡∏Ñ‡πâ‡∏≤‡∏á 4 ‡∏ß‡∏¥/‡∏ó‡πà‡∏≤) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaBoss">
              <div class="ico">üëë</div>
              <div>
                <div class="t">Zone Boss ‚Äî Challenge</div>
                <div class="d" id="bossBrief">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Quest 1‚Äì3 ‡∏Ñ‡∏£‡∏ö</div>
              </div>
            </div>
          </div>

          <div class="hint" id="hintStrict">
            üîí ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ç‡πâ‡∏°: ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô = ‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
          </div>
        </div>

        <!-- RIGHT: Arena -->
        <div class="card" id="cardArena">
          <div class="glow green" id="arenaGlow"></div>
          <h3 id="arenaTitle">‡∏™‡∏ô‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
          <p id="arenaDesc">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏à‡∏ô‡∏à‡∏ö</p>

          <div class="arena" id="arena">
            <div class="arenaTop">
              <div>
                <div class="big" id="arenaBig">READY</div>
                <div class="hint" id="arenaHint">‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1</div>
              </div>

              <div class="meter">
                <div class="k" id="meterLabel">progress</div>
                <div class="barWrap"><div class="barFill" id="barFill"></div></div>
                <div class="k"><span id="meterText">0%</span></div>
              </div>
            </div>

            <div id="arenaBody"></div>
          </div>

          <div class="hint" id="arenaFoot">
            ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h4 id="modalTitle">Modal</h4>
      <p id="modalDesc">‚Äî</p>
      <div class="row">
        <div class="btn ghost" id="modalCancel">‡∏õ‡∏¥‡∏î</div>
        <div class="btn good" id="modalOk">‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  'use strict';

  // -----------------------------
  // URL / Params (pass-through)
  // -----------------------------
  function pageUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(pageUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  function qs(k, def=null){ const q=parseQS(); const v=q.get(k); return (v==null||String(v).trim()==='') ? def : v; }
  function toObj(sp){ const o={}; for (const [k,v] of sp.entries()) o[k]=v; return o; }

  const ZONE = (qs('zone','nutrition')||'nutrition').toLowerCase();
  const NEXT = qs('next', './hub.html'); // relative ok
  const HUB  = qs('hub', null);

  // Pass-through keys we keep
  const PASS_KEYS = ['pid','run','diff','time','seed','studyId','phase','conditionGroup','log','view'];

  function hubUrl(){
    // If user passed hub=... keep it, else fallback to current directory hub.html (same as your project uses)
    if (HUB && String(HUB).trim()) return HUB;
    // default guess: ./hub.html in /herohealth/
    try{ return new URL('./hub.html', location.href).toString(); }catch(_){ return './hub.html'; }
  }

  function buildNextUrl(){
    const base = new URL(NEXT, location.href);
    const cur = parseQS();

    // copy pass-through (do NOT override if already on next)
    for (const k of PASS_KEYS){
      if (!base.searchParams.has(k) && cur.has(k)){
        const v = cur.get(k);
        if (v!=null && String(v).trim()!=='') base.searchParams.set(k, v);
      }
    }

    // ensure hub exists on next (do NOT override)
    if (!base.searchParams.has('hub') || String(base.searchParams.get('hub')||'').trim()===''){
      base.searchParams.set('hub', hubUrl());
    }
    return base.toString();
  }

  // -----------------------------
  // UI helpers
  // -----------------------------
  const $ = (s)=>document.querySelector(s);
  function setText(id, v){ const el=$(id); if(el) el.textContent = (v==null||String(v).trim()==='') ? '‚Äî' : String(v); }

  const toastEl = $('#toast');
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1400);
  }

  // overlay modal
  const overlay = $('#overlay');
  const modalTitle = $('#modalTitle');
  const modalDesc  = $('#modalDesc');
  const modalCancel = $('#modalCancel');
  const modalOk = $('#modalOk');
  let modalOkFn = null;

  function showModal(title, desc, okText, okFn){
    modalTitle.textContent = title;
    modalDesc.textContent  = desc || '';
    modalOk.textContent = okText || '‡πÄ‡∏£‡∏¥‡πà‡∏°';
    modalOkFn = okFn || null;
    overlay.classList.add('show');
  }
  function hideModal(){
    overlay.classList.remove('show');
    modalOkFn = null;
  }
  modalCancel.addEventListener('click', hideModal);
  modalOk.addEventListener('click', ()=>{
    const fn = modalOkFn;
    hideModal();
    if (typeof fn === 'function') fn();
  });

  // -----------------------------
  // Zone definitions
  // -----------------------------
  const ZONE_DEF = {
    nutrition: {
      icon:'ü•ó', name:'‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', glow:'green',
      bossName:'Food Flash Boss',
      bossBrief:'‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Äú‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚â• 6/8',
    },
    hygiene: {
      icon:'üßº', name:'‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', glow:'cyan',
      bossName:'Sequence Boss',
      bossBrief:'‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‚Äú‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‚â• 6/8',
    },
    fitness: {
      icon:'üèÉ', name:'‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', glow:'violet',
      bossName:'Reflex Mini-Boss',
      bossBrief:'‡∏ï‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤ (PUNCH/DUCK/JUMP/HOLD) ‡∏ñ‡∏π‡∏Å ‚â• 10/12',
    },
  };
  const Z = ZONE_DEF[ZONE] || ZONE_DEF.nutrition;

  // -----------------------------
  // Strict flow state
  // -----------------------------
  const st = {
    step: 0,         // 0=idle, 1=Q1,2=Q2,3=Q3,4=boss,5=cooldown,6=done
    q1:false, q2:false, q3:false,
    bossUnlocked:false,
    bossWin:false,
    cooldownDone:false,
  };

  // Steps pill
  const s1=$('#s1'), s2=$('#s2'), s3=$('#s3'), sb=$('#sb'), sc=$('#sc');
  function syncSteps(){
    s1.classList.toggle('ok', st.q1);
    s2.classList.toggle('ok', st.q2);
    s3.classList.toggle('ok', st.q3);
    sb.classList.toggle('ok', st.bossWin);
    sc.classList.toggle('ok', st.cooldownDone);
  }

  // Buttons / CTAs
  const ctaQ1=$('#ctaQ1'), ctaQ2=$('#ctaQ2'), ctaQ3=$('#ctaQ3'), ctaBoss=$('#ctaBoss');
  const btnGoNext=$('#btnGoNext');
  const badgeState=$('#badgeState');
  const badgeText=$('#badgeText');

  function setBadge(state){
    badgeState.classList.remove('ok','bad');
    if (state==='ok') badgeState.classList.add('ok');
    if (state==='bad') badgeState.classList.add('bad');
  }

  function lockCtas(){
    ctaQ1.classList.toggle('disabled', false);
    ctaQ2.classList.toggle('disabled', !st.q1);
    ctaQ3.classList.toggle('disabled', !(st.q1 && st.q2));
    ctaBoss.classList.toggle('disabled', !(st.q1 && st.q2 && st.q3));
    btnGoNext.classList.toggle('disabled', !(st.bossWin && st.cooldownDone));
  }

  // Progress meter
  const barFill = $('#barFill');
  const meterText = $('#meterText');
  const meterLabel = $('#meterLabel');
  function setProgress(pct, mode){
    const p = Math.max(0, Math.min(100, Number(pct)||0));
    barFill.style.width = p + '%';
    barFill.classList.remove('good','bad');
    if (mode==='good') barFill.classList.add('good');
    if (mode==='bad') barFill.classList.add('bad');
    meterText.textContent = Math.round(p) + '%';
  }

  // Arena UI
  const arenaBig = $('#arenaBig');
  const arenaHint = $('#arenaHint');
  const arenaBody = $('#arenaBody');

  function resetArena(){
    arenaBody.innerHTML = '';
    arenaBig.textContent = 'READY';
    arenaHint.textContent = '‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1';
    meterLabel.textContent = 'progress';
    setProgress(0);
    // remove any leftover targets
    const old = document.querySelectorAll('.dotTarget');
    old.forEach(x=>x.remove());
  }

  function setHeader(){
    setText('#zoneText', `${Z.icon} ${Z.name}`);
    setText('#nextText', 'next: ' + (NEXT || '‚Äî'));
    setText('#bossBrief', Z.bossBrief);

    // glows
    const g = $('#flowGlow');
    const a = $('#arenaGlow');
    g.classList.remove('green','violet');
    a.classList.remove('green','violet');
    if (Z.glow==='green'){ g.classList.add('green'); a.classList.add('green'); }
    if (Z.glow==='violet'){ g.classList.add('violet'); a.classList.add('violet'); }

    setText('#flowTitle', `Warm-up Gate ‚Äî ${Z.icon} ${Z.name}`);
    setText('#arenaTitle', `‡∏™‡∏ô‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚Äî ${Z.bossName}`);
  }

  function renderPills(){
    const q = parseQS();
    const pills = [
      {k:'zone', v:ZONE},
      {k:'next', v:(NEXT||'')},
      {k:'pid', v:q.get('pid')},
      {k:'run', v:q.get('run')},
      {k:'diff', v:q.get('diff')},
      {k:'time', v:q.get('time')},
      {k:'seed', v:q.get('seed')},
      {k:'studyId', v:q.get('studyId')},
      {k:'phase', v:q.get('phase')},
      {k:'conditionGroup', v:q.get('conditionGroup')},
      {k:'log', v:q.get('log')},
    ].filter(x => x.v != null && String(x.v).trim() !== '');
    $('#pillrow').innerHTML = pills
      .slice(0, 14)
      .map(x => `<span class="pill"><b>${x.k}</b>: ${String(x.v).replace(/</g,'&lt;')}</span>`)
      .join('') || `<span class="pill"><b>params</b>: none</span>`;
  }

  // -----------------------------
  // Quest 1 ‚Äî Breathing (8 cycles tap)
  // Strict: must complete; fail resets this quest only
  // -----------------------------
  function startQ1(){
    st.step = 1;
    resetArena();
    arenaBig.textContent = 'ü´Å BREATH';
    arenaHint.textContent = '‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞: IN ‚Üí OUT (‡∏Ñ‡∏£‡∏ö 8 ‡∏£‡∏≠‡∏ö)';
    meterLabel.textContent = 'breathing cycles';

    const total = 8;
    let done = 0;
    let phase = 'IN';

    const box = document.createElement('div');
    box.style.marginTop = '8px';
    box.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="btn good" id="breatheBtn" style="flex:1 1 240px; justify-content:center;">‡πÄ‡∏£‡∏¥‡πà‡∏° IN</div>
        <div class="pill" id="breatheState">‡∏£‡∏≠‡∏ö: 0/${total}</div>
      </div>
      <div class="hint" style="margin-top:10px;">Tip: ‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‚ÄúIN ‡πÅ‡∏•‡πâ‡∏ß OUT‚Äù ‡∏à‡∏∞‡∏ô‡∏±‡∏ö 1 ‡∏£‡∏≠‡∏ö</div>
    `;
    arenaBody.appendChild(box);

    const breatheBtn = box.querySelector('#breatheBtn');
    const breatheState = box.querySelector('#breatheState');

    function update(){
      breatheBtn.textContent = (phase==='IN') ? '‡∏Å‡∏î IN (‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤)' : '‡∏Å‡∏î OUT (‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å)';
      breatheState.textContent = `‡∏£‡∏≠‡∏ö: ${done}/${total}`;
      setProgress((done/total)*100, done>=total ? 'good' : null);
    }

    breatheBtn.addEventListener('click', ()=>{
      // toggle phase; count on completing OUT
      if (phase === 'IN'){
        phase = 'OUT';
        toast('‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏ï‡πà‡∏≠ OUT');
      } else {
        phase = 'IN';
        done++;
        toast('‡∏Ñ‡∏£‡∏ö 1 ‡∏£‡∏≠‡∏ö ‚úÖ');
      }
      update();

      if (done >= total){
        st.q1 = true;
        st.step = 0;
        setBadge('ok'); badgeText.textContent = 'Q1 DONE';
        syncSteps(); lockCtas();
        arenaBig.textContent = '‚úÖ Q1 COMPLETE';
        arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Quest 2 ‡πÅ‡∏•‡πâ‡∏ß';
        toast('‡∏ú‡πà‡∏≤‡∏ô Quest 1!');
      }
    });

    update();
  }

  // -----------------------------
  // Quest 2 ‚Äî Focus (10 taps targets in arena)
  // -----------------------------
  function startQ2(){
    if (!st.q1){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1 ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 2;
    resetArena();
    arenaBig.textContent = 'üëÄ FOCUS';
    arenaHint.textContent = '‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)';
    meterLabel.textContent = 'targets';

    const arena = $('#arena');
    const total = 10;
    let hit = 0;
    let alive = null;

    function spawn(){
      if (alive) alive.remove();

      const rect = arena.getBoundingClientRect();
      const pad = 46; // keep inside
      const x = pad + Math.random() * Math.max(1, (rect.width - pad*2));
      const y = 110 + Math.random() * Math.max(1, (rect.height - 140)); // avoid top UI

      const d = document.createElement('div');
      d.className = 'dotTarget';
      d.style.left = x + 'px';
      d.style.top  = y + 'px';
      d.innerHTML = `<div class="e">üéØ</div>`;
      d.addEventListener('click', ()=>{
        hit++;
        toast('Hit! ‚úÖ');
        setProgress((hit/total)*100, hit>=total ? 'good' : null);
        if (hit >= total){
          if (alive) alive.remove();
          st.q2 = true;
          st.step = 0;
          setBadge('ok'); badgeText.textContent = 'Q2 DONE';
          syncSteps(); lockCtas();
          arenaBig.textContent = '‚úÖ Q2 COMPLETE';
          arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Quest 3 ‡πÅ‡∏•‡πâ‡∏ß';
          return;
        }
        spawn();
      });
      arena.appendChild(d);
      alive = d;
    }

    const info = document.createElement('div');
    info.className = 'pill';
    info.textContent = `Hit: 0/${total}`;
    arenaBody.appendChild(info);

    const timer = setInterval(()=>{
      if (st.step !== 2){ clearInterval(timer); return; }
      info.textContent = `Hit: ${hit}/${total}`;
    }, 120);

    spawn();
  }

  // -----------------------------
  // Quest 3 ‚Äî Stretch (3 holds)
  // -----------------------------
  function startQ3(){
    if (!(st.q1 && st.q2)){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1‚Äì2 ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 3;
    resetArena();
    arenaBig.textContent = 'ü§∏ STRETCH';
    arenaHint.textContent = '‡∏ó‡∏≥‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ (‡∏Ñ‡πâ‡∏≤‡∏á 4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ó‡πà‡∏≤)';
    meterLabel.textContent = 'poses';

    const poses = [
      { emo:'üôÜ‚Äç‚ôÇÔ∏è', name:'‡∏¢‡∏∑‡∏î‡πÅ‡∏Ç‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏®‡∏µ‡∏£‡∏©‡∏∞' },
      { emo:'üßç‚Äç‚ôÇÔ∏è', name:'‡∏ö‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤' },
      { emo:'ü¶µ', name:'‡∏¢‡∏∑‡∏î‡∏Ç‡∏≤-‡∏ô‡πà‡∏≠‡∏á' },
    ];
    let idx = 0;
    let holding = false;
    let t = 0;
    let tick = null;

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill" id="poseName">‡∏ó‡πà‡∏≤ 1/3</div>
      <div class="big" id="poseEmo" style="margin-top:10px;">${poses[0].emo}</div>
      <div class="hint" id="poseHint">${poses[0].name}</div>
      <div class="btn good" id="holdBtn" style="margin-top:12px; justify-content:center;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (4 ‡∏ß‡∏¥)</div>
      <div class="hint" style="margin-top:10px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô = ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    `;
    arenaBody.appendChild(box);

    const poseName = box.querySelector('#poseName');
    const poseEmo = box.querySelector('#poseEmo');
    const poseHint = box.querySelector('#poseHint');
    const holdBtn = box.querySelector('#holdBtn');

    function updatePose(){
      poseName.textContent = `‡∏ó‡πà‡∏≤ ${idx+1}/3`;
      poseEmo.textContent = poses[idx].emo;
      poseHint.textContent = poses[idx].name;
      t = 0;
      setProgress((idx/poses.length)*100, null);
      holdBtn.textContent = '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (4 ‡∏ß‡∏¥)';
    }

    function startHold(){
      if (holding) return;
      holding = true;
      holdBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á...';
      tick = setInterval(()=>{
        t += 0.1;
        setProgress(((idx + Math.min(1, t/4)) / poses.length)*100, null);
        const left = Math.max(0, 4 - t);
        holdBtn.textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡∏Å ${left.toFixed(1)} ‡∏ß‡∏¥`;
        if (t >= 4){
          clearInterval(tick); tick=null;
          holding = false;
          idx++;
          toast('‡∏ú‡πà‡∏≤‡∏ô 1 ‡∏ó‡πà‡∏≤ ‚úÖ');
          if (idx >= poses.length){
            st.q3 = true;
            st.step = 0;
            setProgress(100,'good');
            setBadge('ok'); badgeText.textContent = 'Q3 DONE';
            syncSteps(); lockCtas();
            arenaBig.textContent = '‚úÖ Q3 COMPLETE';
            arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Zone Boss ‡πÅ‡∏•‡πâ‡∏ß';
            toast('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏≠‡∏™!');
            return;
          }
          updatePose();
        }
      }, 100);
    }

    function cancelHold(){
      if (!holding) return;
      holding = false;
      if (tick){ clearInterval(tick); tick=null; }
      t = 0;
      setProgress((idx/poses.length)*100, null);
      holdBtn.textContent = '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ';
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚ùó');
      setTimeout(()=>{ if(!holding) holdBtn.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (4 ‡∏ß‡∏¥)'; }, 550);
    }

    holdBtn.addEventListener('pointerdown', startHold);
    holdBtn.addEventListener('pointerup', cancelHold);
    holdBtn.addEventListener('pointercancel', cancelHold);
    holdBtn.addEventListener('mouseleave', cancelHold);

    updatePose();
  }

  // -----------------------------
  // Boss (must win)
  // -----------------------------
  function startBoss(){
    if (!(st.q1 && st.q2 && st.q3)){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1‚Äì3 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 4;
    st.bossUnlocked = true;
    resetArena();

    arenaBig.textContent = 'üëë ZONE BOSS';
    arenaHint.textContent = `${Z.bossName} ‚Äî ${Z.bossBrief}`;
    meterLabel.textContent = 'boss';

    if (ZONE === 'nutrition') return bossNutrition();
    if (ZONE === 'hygiene') return bossHygiene();
    return bossFitness();
  }

  // Nutrition Boss: 8 flashes ‚Äî choose ‡∏î‡∏µ/‡∏Ç‡∏¢‡∏∞; pass >=6
  function bossNutrition(){
    const items = [
      {emo:'üçé', name:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•', good:true},
      {emo:'ü•¶', name:'‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', good:true},
      {emo:'üêü', name:'‡∏õ‡∏•‡∏≤', good:true},
      {emo:'ü•õ', name:'‡∏ô‡∏°', good:true},
      {emo:'üç¨', name:'‡∏•‡∏π‡∏Å‡∏≠‡∏°', good:false},
      {emo:'üçü', name:'‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢‡∏™‡πå', good:false},
      {emo:'ü•§', name:'‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô', good:false},
      {emo:'üç©', name:'‡πÇ‡∏î‡∏ô‡∏±‡∏ó', good:false},
    ];
    // shuffle copy
    const seq = items.slice().sort(()=>Math.random()-0.5).slice(0,8);

    let i=0, correct=0;
    const need = 6;

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill" id="bossStat">‡∏Ç‡πâ‡∏≠ 1/8 ‚Ä¢ ‡∏ñ‡∏π‡∏Å 0 ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}</div>
      <div class="big" id="bossItem" style="margin-top:10px;">üçé</div>
      <div class="hint" id="bossName">‚Äî</div>
      <div class="choices">
        <div class="choiceBtn good" id="btnGood">
          <div class="lhs"><span class="emo">‚úÖ</span><div><div class="txt">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ</div><div class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</div></div></div>
          <div class="pill">GOOD</div>
        </div>
        <div class="choiceBtn bad" id="btnBad">
          <div class="lhs"><span class="emo">‚ö†Ô∏è</span><div><div class="txt">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞</div><div class="sub">‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡πá‡∏°‡∏à‡∏±‡∏î</div></div></div>
          <div class="pill">JUNK</div>
        </div>
      </div>
      <div class="hint">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 8 ‡∏Ç‡πâ‡∏≠ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${need} ‡∏Ç‡πâ‡∏≠</div>
    `;
    arenaBody.appendChild(box);

    const bossStat = box.querySelector('#bossStat');
    const bossItem = box.querySelector('#bossItem');
    const bossName = box.querySelector('#bossName');
    const btnGood = box.querySelector('#btnGood');
    const btnBad = box.querySelector('#btnBad');

    function show(){
      const it = seq[i];
      bossItem.textContent = it.emo;
      bossName.textContent = it.name;
      bossStat.textContent = `‡∏Ç‡πâ‡∏≠ ${i+1}/8 ‚Ä¢ ‡∏ñ‡∏π‡∏Å ${correct} ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}`;
      setProgress((i/8)*100, null);
    }

    function answer(isGood){
      const it = seq[i];
      const ok = (!!isGood) === (!!it.good);
      if (ok){ correct++; toast('‡∏ñ‡∏π‡∏Å ‚úÖ'); }
      else { toast('‡∏ú‡∏¥‡∏î ‚ùó'); }

      i++;
      if (i >= 8){
        const pass = correct >= need;
        if (!pass){
          setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
          setProgress(100,'bad');
          arenaBig.textContent = '‚ùå BOSS FAILED';
          arenaHint.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡∏π‡∏Å ${correct}/8) ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà`;
          toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
          // strict: boss can retry; quests remain complete
          lockCtas(); syncSteps();
          return;
        }
        // win
        st.bossWin = true;
        setBadge('ok'); badgeText.textContent = 'BOSS WIN';
        arenaBig.textContent = 'üèÜ BOSS CLEARED';
        arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
        setProgress(100,'good');
        syncSteps(); lockCtas();
        toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
        setTimeout(startCooldown, 650);
        return;
      }
      show();
    }

    btnGood.addEventListener('click', ()=>answer(true));
    btnBad.addEventListener('click', ()=>answer(false));
    show();
  }

  // Hygiene Boss: order 8 steps ‚Äî press in correct order; pass >=6 correct in streak of 8 presses
  function bossHygiene(){
    // simplified ‚Äúsequence boss‚Äù (no drag): player taps steps in order
    // Use 8 prompts (random mix from handwash/brush common)
    const steps = [
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏°‡∏∑‡∏≠', order:1},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏ü‡∏≠‡∏Å‡∏™‡∏ö‡∏π‡πà', order:2},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏ñ‡∏π‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß', order:3},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏ñ‡∏π‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠', order:4},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏ñ‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏°‡πà‡∏°‡∏∑‡∏≠', order:5},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏ñ‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß', order:6},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠: ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≥/‡πÄ‡∏ä‡πá‡∏î‡πÅ‡∏´‡πâ‡∏á', order:7},
      {k:'‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô: ‡∏õ‡∏±‡∏î‡∏Ñ‡∏£‡∏≤‡∏ö‡∏£‡∏≠‡∏ö ‡πÜ', order:8},
    ];
    const pool = steps.slice(); // already ordered 1..8
    // shuffle display order
    const display = pool.slice().sort(()=>Math.random()-0.5);

    let expected = 1;
    let correct = 0;
    const need = 6;

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill" id="bossStat">‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 1‚Üí8 ‚Ä¢ ‡∏ñ‡∏π‡∏Å 0 ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}</div>
      <div class="hint">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${need} ‡∏à‡∏≤‡∏Å 8)</div>
      <div class="choices" id="choiceList"></div>
    `;
    arenaBody.appendChild(box);

    const bossStat = box.querySelector('#bossStat');
    const choiceList = box.querySelector('#choiceList');

    function update(){
      bossStat.textContent = `‡πÅ‡∏ï‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö ${expected}/8 ‚Ä¢ ‡∏ñ‡∏π‡∏Å ${correct} ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}`;
      setProgress(((expected-1)/8)*100, null);
    }

    display.forEach(it=>{
      const b = document.createElement('div');
      b.className = 'choiceBtn';
      b.innerHTML = `
        <div class="lhs">
          <span class="emo">üßº</span>
          <div>
            <div class="txt">${it.k}</div>
            <div class="sub">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${it.order}</div>
          </div>
        </div>
        <div class="pill">TAP</div>
      `;
      b.addEventListener('click', ()=>{
        if (it.order === expected){
          correct++;
          toast('‡∏ñ‡∏π‡∏Å ‚úÖ');
          b.classList.add('good');
        } else {
          toast('‡∏ú‡∏¥‡∏î ‚ùó');
          b.classList.add('bad');
        }
        b.style.pointerEvents = 'none';
        expected++;
        update();

        if (expected > 8){
          const pass = correct >= need;
          if (!pass){
            setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
            setProgress(100,'bad');
            arenaBig.textContent = '‚ùå BOSS FAILED';
            arenaHint.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡∏π‡∏Å ${correct}/8) ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà`;
            toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
            return;
          }
          st.bossWin = true;
          setBadge('ok'); badgeText.textContent = 'BOSS WIN';
          arenaBig.textContent = 'üèÜ BOSS CLEARED';
          arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
          setProgress(100,'good');
          syncSteps(); lockCtas();
          toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
          setTimeout(startCooldown, 650);
        }
      });
      choiceList.appendChild(b);
    });

    update();
  }

  // Fitness Boss: 12 prompts ‚Äî choose correct action; pass >=10
  function bossFitness(){
    const actions = [
      {k:'PUNCH', emo:'ü•ä', hint:'‡∏ä‡∏Å'},
      {k:'DUCK', emo:'ü¶Ü', hint:'‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö'},
      {k:'JUMP', emo:'ü¶ò', hint:'‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î'},
      {k:'HOLD', emo:'üßò', hint:'‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß'},
    ];
    const prompts = [];
    for (let i=0;i<12;i++){
      prompts.push(actions[Math.floor(Math.random()*actions.length)]);
    }
    let i=0, correct=0;
    const need = 10;

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill" id="bossStat">‡∏Ç‡πâ‡∏≠ 1/12 ‚Ä¢ ‡∏ñ‡∏π‡∏Å 0 ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}</div>
      <div class="big" id="promptEmo" style="margin-top:10px;">ü•ä</div>
      <div class="hint" id="promptTxt">PUNCH</div>
      <div class="choices">
        <div class="choiceBtn" id="b1"><div class="lhs"><span class="emo">ü•ä</span><div><div class="txt">PUNCH</div><div class="sub">‡∏ä‡∏Å</div></div></div><div class="pill">1</div></div>
        <div class="choiceBtn" id="b2"><div class="lhs"><span class="emo">ü¶Ü</span><div><div class="txt">DUCK</div><div class="sub">‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö</div></div></div><div class="pill">2</div></div>
        <div class="choiceBtn" id="b3"><div class="lhs"><span class="emo">ü¶ò</span><div><div class="txt">JUMP</div><div class="sub">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î</div></div></div><div class="pill">3</div></div>
        <div class="choiceBtn" id="b4"><div class="lhs"><span class="emo">üßò</span><div><div class="txt">HOLD</div><div class="sub">‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß</div></div></div><div class="pill">4</div></div>
      </div>
      <div class="hint">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 ‡∏Ç‡πâ‡∏≠ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${need} ‡∏Ç‡πâ‡∏≠</div>
    `;
    arenaBody.appendChild(box);

    const bossStat=box.querySelector('#bossStat');
    const promptEmo=box.querySelector('#promptEmo');
    const promptTxt=box.querySelector('#promptTxt');
    const mapBtn = {
      PUNCH: box.querySelector('#b1'),
      DUCK:  box.querySelector('#b2'),
      JUMP:  box.querySelector('#b3'),
      HOLD:  box.querySelector('#b4'),
    };

    function show(){
      const p = prompts[i];
      promptEmo.textContent = p.emo;
      promptTxt.textContent = p.k + ' ‚Äî ' + p.hint;
      bossStat.textContent = `‡∏Ç‡πâ‡∏≠ ${i+1}/12 ‚Ä¢ ‡∏ñ‡∏π‡∏Å ${correct} ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‚â• ${need}`;
      setProgress((i/12)*100, null);
    }

    function answer(key){
      const p = prompts[i];
      const ok = key === p.k;
      if (ok){ correct++; toast('‡∏ñ‡∏π‡∏Å ‚úÖ'); }
      else { toast('‡∏ú‡∏¥‡∏î ‚ùó'); }
      i++;
      if (i>=12){
        const pass = correct >= need;
        if (!pass){
          setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
          setProgress(100,'bad');
          arenaBig.textContent = '‚ùå BOSS FAILED';
          arenaHint.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡∏π‡∏Å ${correct}/12) ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà`;
          toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
          return;
        }
        st.bossWin = true;
        setBadge('ok'); badgeText.textContent = 'BOSS WIN';
        arenaBig.textContent = 'üèÜ BOSS CLEARED';
        arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
        setProgress(100,'good');
        syncSteps(); lockCtas();
        toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
        setTimeout(startCooldown, 650);
        return;
      }
      show();
    }

    Object.keys(mapBtn).forEach(k=>{
      mapBtn[k].addEventListener('click', ()=>answer(k));
    });
    show();
  }

  // -----------------------------
  // Cooldown (15s auto) then unlock Go Next
  // -----------------------------
  function startCooldown(){
    st.step = 5;
    resetArena();
    arenaBig.textContent = 'üßò COOLDOWN';
    arenaHint.textContent = '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πâ‡∏≤ ‡πÜ + ‡∏¢‡∏∑‡∏î‡πÄ‡∏ö‡∏≤ ‡πÜ 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
    meterLabel.textContent = 'cooldown';

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="big">15</div>
      <div class="hint">‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div class="pill" style="margin-top:10px;">Tip: ‡∏™‡∏π‡∏î 4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡∏Å‡∏•‡∏±‡πâ‡∏ô 2 ‚Üí ‡∏ú‡πà‡∏≠‡∏ô 4</div>
    `;
    arenaBody.appendChild(box);
    const big = box.querySelector('.big');

    let t = 15;
    setProgress(0, null);

    const timer = setInterval(()=>{
      if (st.step !== 5){ clearInterval(timer); return; }
      t--;
      big.textContent = String(Math.max(0,t));
      setProgress(((15 - Math.max(0,t))/15)*100, 'good');
      if (t <= 0){
        clearInterval(timer);
        st.cooldownDone = true;
        st.step = 6;
        syncSteps(); lockCtas();
        setBadge('ok'); badgeText.textContent = 'READY';
        arenaBig.textContent = '‚úÖ READY';
        arenaHint.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß';
        toast('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å!');
        // auto redirect (strict)
        setTimeout(()=>goNext(true), 650);
      }
    }, 1000);
  }

  // -----------------------------
  // Navigation
  // -----------------------------
  function goBackHub(){
    const u = hubUrl();
    location.href = u;
  }

  function goNext(auto){
    if (!(st.bossWin && st.cooldownDone)){
      toast('‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå)');
      return;
    }
    const url = buildNextUrl();
    if (!auto){
      showModal('‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å', '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏°‡∏µ hub ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠', '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°', ()=> location.href = url);
      return;
    }
    location.href = url;
  }

  function restartAll(){
    // strict restart only gate progress (not query)
    st.step=0; st.q1=false; st.q2=false; st.q3=false;
    st.bossUnlocked=false; st.bossWin=false; st.cooldownDone=false;
    setBadge(); badgeText.textContent='LOCKED';
    resetArena();
    syncSteps(); lockCtas();
    toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
  }

  // -----------------------------
  // Bind CTAs
  // -----------------------------
  ctaQ1.addEventListener('click', ()=> showModal('Quest 1 ‚Äî Breathing', '‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ IN/OUT ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 8 ‡∏£‡∏≠‡∏ö', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1', startQ1));
  ctaQ2.addEventListener('click', ()=>{
    if (!st.q1) return;
    showModal('Quest 2 ‚Äî Focus', '‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 2', startQ2);
  });
  ctaQ3.addEventListener('click', ()=>{
    if (!(st.q1 && st.q2)) return;
    showModal('Quest 3 ‚Äî Stretch', '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ (4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ó‡πà‡∏≤)', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 3', startQ3);
  });
  ctaBoss.addEventListener('click', ()=>{
    if (!(st.q1 && st.q2 && st.q3)) return;
    showModal('Zone Boss', `${Z.bossName} ‚Äî ${Z.bossBrief}`, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™', startBoss);
  });

  $('#btnBackHub').addEventListener('click', goBackHub);
  $('#btnRestart').addEventListener('click', restartAll);
  $('#btnGoNext').addEventListener('click', ()=>goNext(false));

  // -----------------------------
  // Init
  // -----------------------------
  function init(){
    setHeader();
    renderPills();

    badgeText.textContent = 'LOCKED';
    setBadge(); // neutral
    $('#bossBrief').textContent = Z.bossBrief;

    syncSteps(); lockCtas();
    resetArena();

    // label badges
    $('#badgeZone').classList.add('ok');
    $('#badgeNext').classList.add('ok');
    $('#subTitle').textContent = `‡πÇ‡∏ã‡∏ô: ${Z.icon} ${Z.name} ‚Ä¢ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: 3 Quest ‚Üí ‡∏ä‡∏ô‡∏∞ ${Z.bossName} ‚Üí Cooldown ‚Üí Next`;

    // show next name shortened
    const nx = (NEXT||'').toString();
    $('#nextText').textContent = 'next: ' + (nx.length>34 ? (nx.slice(0,34)+'‚Ä¶') : nx);

    // strict: focus first CTA
    setTimeout(()=> toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà Quest 1 ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'), 120);
  }
  init();

})();
</script>
</body>
</html>
