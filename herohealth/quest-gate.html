<!-- === /herohealth/quest-gate.html ===
HeroHealth ‚Äî Quest Gate (Daily Zone Warm-up: 3 Mini Quests ‚Üí Zone Boss ‚Üí Cooldown)
‚úÖ Daily-per-zone: 1 time/day/zone (nutrition/hygiene/fitness)
‚úÖ Strict: must finish Quest 1‚Äì3 before Boss unlock; must WIN boss; cooldown then DONE
‚úÖ Sets localStorage:
   - HHA_ZONE_DONE::<zone>::YYYY-MM-DD = "1"
‚úÖ Pass-through: pid/run/diff/time/seed/studyId/phase/conditionGroup/log/view + hub
‚úÖ Never override existing params; only adds hub if missing on next
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Quest Gate</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --cyan:#22d3ee; --violet:#a78bfa;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1000px 600px at 85% 20%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(900px 520px at 55% 90%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      overflow:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ height:100%; max-width:1120px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 10px 10px 0 10px;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{ margin:0; font-size: clamp(20px, 2.0vw, 28px); letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size: 13px; line-height:1.4; max-width: 74ch; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .pill b{ color:var(--text); font-weight:800; }

    .panel{
      flex:1;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .bar{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
    }
    .leftbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color:var(--text);
      user-select:none;
      white-space:nowrap;
    }
    .badge .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 18px rgba(245,158,11,.35);
    }
    .badge.ok .dot{ background: var(--good); box-shadow: 0 0 18px rgba(34,197,94,.35); }
    .badge.bad .dot{ background: var(--bad); box-shadow: 0 0 18px rgba(239,68,68,.35); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      padding:10px 12px;
      border-radius: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.disabled{ opacity:.45; cursor:not-allowed; }
    .btn.good{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); color: var(--text); }
    .btn.ghost{ color:var(--muted); }

    .content{
      flex:1;
      display:grid;
      grid-template-columns: 1fr .95fr;
      gap: 12px;
      padding: 12px;
      min-height:0;
    }
    @media (max-width: 980px){
      .content{ grid-template-columns: 1fr; }
      .pillrow{ justify-content:flex-start; }
      .actions{ justify-content:flex-start; }
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.40);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      overflow:hidden;
      min-height: 180px;
      position:relative;
    }
    .card h3{ margin:0 0 6px 0; font-size:16px; letter-spacing:.2px; }
    .card p{ margin:0; color:var(--muted); font-size: 13px; line-height: 1.45; }
    .glow{
      position:absolute; inset:-40% -30% auto auto;
      width:240px; height:240px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.22), transparent 60%);
      filter: blur(10px);
      transform: rotate(14deg);
      pointer-events:none;
      opacity:.9;
    }
    .glow.green{ background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.24), transparent 60%); }
    .glow.violet{ background: radial-gradient(circle at 30% 30%, rgba(167,139,250,.22), transparent 60%); }

    .stepRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .step{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.32);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .step.ok{ color:var(--text); border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .step .n{
      width:20px; height:20px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:900;
      color:var(--text);
      background: rgba(255,255,255,.06);
    }

    .arena{
      border:1px dashed rgba(148,163,184,.26);
      background: rgba(2,6,23,.22);
      border-radius: 16px;
      padding: 12px;
      margin-top: 12px;
      min-height: 260px;
      position:relative;
      overflow:hidden;
    }
    .arenaTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .meter{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.30);
      border-radius: 14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .meter .k{ color:var(--muted); font-size:12px; }
    .barWrap{ height:10px; background: rgba(0,0,0,.35); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.10); }
    .barFill{ height:100%; width:0%; background: rgba(34,211,238,.85); transition: width .12s ease; }
    .barFill.good{ background: rgba(34,197,94,.85); }
    .barFill.bad{ background: rgba(239,68,68,.85); }

    .big{
      font-size: clamp(28px, 4vw, 44px);
      font-weight: 900;
      letter-spacing: .5px;
      margin: 6px 0 2px 0;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:6px;
    }

    .ctaRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta{
      flex: 1 1 220px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex;
      gap:10px;
      align-items:flex-start;
      position:relative;
      overflow:hidden;
    }
    .cta:hover{ border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.08); }
    .cta:active{ transform: translateY(1px); }
    .cta.disabled{ opacity:.45; cursor:not-allowed; }
    .cta .ico{ font-size:20px; }
    .cta .t{ font-weight:900; }
    .cta .d{ color:var(--muted); font-size:12px; line-height:1.35; margin-top:2px; }
    .cta .spark{
      position:absolute; inset:-40% -50% auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.18), transparent 60%);
      filter: blur(10px);
      transform: rotate(10deg);
      pointer-events:none;
      opacity:.9;
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,6,23,.66);
      backdrop-filter: blur(8px);
      z-index: 50;
      padding: 14px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(720px, 92vw);
      background: rgba(2,6,23,.82);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal h4{ margin:0 0 6px 0; font-size:16px; }
    .modal p{ margin:0; color:var(--muted); font-size:13px; line-height:1.45; }
    .modal .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:space-between; }
    .modal .btn{ flex: 1 1 220px; justify-content:center; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--sab));
      transform: translateX(-50%);
      background: rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 9999;
      max-width: 92vw;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity: 1; }

    /* targets */
    .tgt{
      position:absolute;
      width:48px; height:48px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 34px rgba(0,0,0,.35);
      transform: translate(-50%,-50%);
      transition: transform .08s ease, opacity .12s ease;
    }
    .tgt:active{ transform: translate(-50%,-50%) scale(.96); }
    .tgt .e{ font-size: 18px; }
    .pop{
      position:absolute;
      transform: translate(-50%,-50%);
      font-weight: 900;
      font-size: 14px;
      opacity: 0;
      animation: pop 520ms ease forwards;
      pointer-events:none;
      text-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    @keyframes pop{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.8); }
      15%{ opacity:1; }
      100%{ opacity:0; transform: translate(-50%,-76%) scale(1.08); }
    }

    .statRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.34);
      border-radius: 999px;
      padding:7px 10px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .chip b{ color: var(--text); }

    .choiceGrid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px; }
    @media (max-width:520px){ .choiceGrid{ grid-template-columns: 1fr; } }
    .choiceBtn{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.34);
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .choiceBtn:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); }
    .choiceBtn:active{ transform: translateY(1px); }
    .choiceBtn.good{ border-color: rgba(34,197,94,.28); }
    .choiceBtn.bad{ border-color: rgba(239,68,68,.28); }
    .choiceBtn .lhs{ display:flex; align-items:center; gap:10px; }
    .choiceBtn .emo{ font-size:20px; }
    .choiceBtn .txt{ font-weight:900; }
    .choiceBtn .sub{ color:var(--muted); font-size:12px; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 class="title">üõ°Ô∏è HeroHealth ‚Äî Quest Gate</h1>
        <p class="subtitle" id="subTitle">Daily gate: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡∏ó‡∏≥ 3 Mini Quest ‚Üí ‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‚Üí Cooldown ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å</p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <div class="panel">
      <div class="bar">
        <div class="leftbar">
          <div class="badge" id="badgeState"><span class="dot"></span><span id="badgeText">LOCKED</span></div>
          <div class="badge ok" id="badgeZone"><span class="dot"></span><span id="zoneText">zone</span></div>
          <div class="badge" id="badgeNext"><span class="dot"></span><span id="nextText">next</span></div>
        </div>

        <div class="actions">
          <div class="btn ghost" id="btnBackHub">‚Ü©Ô∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</div>
          <div class="btn warn" id="btnRestart">‚ôªÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
          <div class="btn good disabled" id="btnGoNext">‚û°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å</div>
        </div>
      </div>

      <div class="content">
        <!-- LEFT -->
        <div class="card" id="cardFlow">
          <div class="glow" id="flowGlow"></div>
          <h3 id="flowTitle">Daily Warm-up</h3>
          <p id="flowDesc">‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö 3 Mini Quest (‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏£‡πá‡∏ß ‡πÜ) ‚Üí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏≠‡∏™‡πÇ‡∏ã‡∏ô ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏∞ ‚Üí ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å</p>

          <div class="stepRow">
            <div class="step" id="s1"><span class="n">1</span> Power Tap</div>
            <div class="step" id="s2"><span class="n">2</span> Focus Rush</div>
            <div class="step" id="s3"><span class="n">3</span> Pose Hold</div>
            <div class="step" id="sb"><span class="n">B</span> Zone Boss</div>
            <div class="step" id="sc"><span class="n">C</span> Cooldown</div>
          </div>

          <div class="ctaRow">
            <div class="cta" id="ctaQ1">
              <div class="spark"></div>
              <div class="ico">‚ö°</div>
              <div>
                <div class="t">Quest 1 ‚Äî Power Tap</div>
                <div class="d">‡πÅ‡∏ï‡∏∞ ‚Äú‡∏≠‡∏≠‡∏£‡πå‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 ‡∏ä‡∏¥‡πâ‡∏ô (‡πÄ‡∏õ‡πâ‡∏≤‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaQ2">
              <div class="spark"></div>
              <div class="ico">üéØ</div>
              <div>
                <div class="t">Quest 2 ‚Äî Focus Rush</div>
                <div class="d">‡∏¢‡∏¥‡∏á/‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö ‚Äú‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ streak ‚â• 6</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaQ3">
              <div class="spark"></div>
              <div class="ico">üßò</div>
              <div>
                <div class="t">Quest 3 ‚Äî Pose Hold</div>
                <div class="d">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ (‡∏ó‡πà‡∏≤‡∏•‡∏∞ 3 ‡∏ß‡∏¥) ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô</div>
              </div>
            </div>

            <div class="cta disabled" id="ctaBoss">
              <div class="spark"></div>
              <div class="ico">üëë</div>
              <div>
                <div class="t">Zone Boss</div>
                <div class="d" id="bossBrief">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Quest 1‚Äì3 ‡∏Ñ‡∏£‡∏ö</div>
              </div>
            </div>
          </div>

          <div class="hint" id="hintStrict">
            üîí ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ç‡πâ‡∏°: ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô = ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ô‡∏±‡πâ‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) ‚Ä¢ ‡∏ö‡∏≠‡∏™‡πÅ‡∏û‡πâ = ‡∏£‡∏µ‡∏ö‡∏≠‡∏™‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏ß‡∏™)
          </div>

          <div class="hint" id="hintDaily">
            üìå Daily: ‡∏ú‡πà‡∏≤‡∏ô‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô gate ‡∏ã‡πâ‡∏≥)
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card" id="cardArena">
          <div class="glow green" id="arenaGlow"></div>
          <h3 id="arenaTitle">‡∏™‡∏ô‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
          <p id="arenaDesc">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Quest 1 ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>

          <div class="arena" id="arena">
            <div class="arenaTop">
              <div>
                <div class="big" id="arenaBig">READY</div>
                <div class="hint" id="arenaHint">‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1</div>
                <div class="statRow" id="statRow"></div>
              </div>

              <div class="meter">
                <div class="k" id="meterLabel">progress</div>
                <div class="barWrap"><div class="barFill" id="barFill"></div></div>
                <div class="k"><span id="meterText">0%</span></div>
              </div>
            </div>

            <div id="arenaBody"></div>
          </div>

          <div class="hint" id="arenaFoot">
            ‚úÖ ‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå 12 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ ‚Äúmark ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ = DONE‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h4 id="modalTitle">Modal</h4>
      <p id="modalDesc">‚Äî</p>
      <div class="row">
        <div class="btn ghost" id="modalCancel">‡∏õ‡∏¥‡∏î</div>
        <div class="btn good" id="modalOk">‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  'use strict';

  // -----------------------------
  // URL / Params (pass-through)
  // -----------------------------
  function pageUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(pageUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  function qs(k, def=null){ const q=parseQS(); const v=q.get(k); return (v==null||String(v).trim()==='') ? def : v; }
  function toObj(sp){ const o={}; for (const [k,v] of sp.entries()) o[k]=v; return o; }

  const ZONE = (qs('zone','nutrition')||'nutrition').toLowerCase();
  const NEXT = qs('next', './hub.html'); // relative ok
  const HUB  = qs('hub', null);

  const PASS_KEYS = ['pid','run','diff','time','seed','studyId','phase','conditionGroup','log','view'];

  function hubUrl(){
    if (HUB && String(HUB).trim()) return HUB;
    try{ return new URL('./hub.html', location.href).toString(); }catch(_){ return './hub.html'; }
  }

  function buildNextUrl(){
    const base = new URL(NEXT, location.href);
    const cur = parseQS();

    for (const k of PASS_KEYS){
      if (!base.searchParams.has(k) && cur.has(k)){
        const v = cur.get(k);
        if (v!=null && String(v).trim()!=='') base.searchParams.set(k, v);
      }
    }
    if (!base.searchParams.has('hub') || String(base.searchParams.get('hub')||'').trim()===''){
      base.searchParams.set('hub', hubUrl());
    }
    return base.toString();
  }

  // -----------------------------
  // Daily key
  // -----------------------------
  function ymdLocal(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function zoneDoneKey(zone){ return `HHA_ZONE_DONE::${zone}::${ymdLocal()}`; }
  function isZoneDoneToday(zone){
    try{ return localStorage.getItem(zoneDoneKey(zone)) === '1'; }catch(_){ return false; }
  }
  function markZoneDoneToday(zone){
    try{ localStorage.setItem(zoneDoneKey(zone), '1'); }catch(_){}
  }

  // -----------------------------
  // UI helpers
  // -----------------------------
  const $ = (s)=>document.querySelector(s);
  function setText(id, v){ const el=$(id); if(el) el.textContent = (v==null||String(v).trim()==='') ? '‚Äî' : String(v); }

  const toastEl = $('#toast');
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1400);
  }

  // overlay modal
  const overlay = $('#overlay');
  const modalTitle = $('#modalTitle');
  const modalDesc  = $('#modalDesc');
  const modalCancel = $('#modalCancel');
  const modalOk = $('#modalOk');
  let modalOkFn = null;

  function showModal(title, desc, okText, okFn){
    modalTitle.textContent = title;
    modalDesc.textContent  = desc || '';
    modalOk.textContent = okText || '‡πÄ‡∏£‡∏¥‡πà‡∏°';
    modalOkFn = okFn || null;
    overlay.classList.add('show');
  }
  function hideModal(){
    overlay.classList.remove('show');
    modalOkFn = null;
  }
  modalCancel.addEventListener('click', hideModal);
  modalOk.addEventListener('click', ()=>{ const fn = modalOkFn; hideModal(); if (typeof fn === 'function') fn(); });

  // -----------------------------
  // Zone definitions (Boss flavor)
  // -----------------------------
  const ZONE_DEF = {
    nutrition: {
      icon:'ü•ó', name:'‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', glow:'green',
      bossName:'Food Rush Boss',
      bossBrief:'‡∏ï‡∏≠‡∏ö ‚Äú‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß ‚Ä¢ ‡∏ó‡∏≥ streak ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ (HP ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)',
    },
    hygiene: {
      icon:'üßº', name:'‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', glow:'cyan',
      bossName:'Sequence Boss',
      bossBrief:'‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏û‡∏•‡∏≤‡∏î HP ‡∏•‡∏î)',
    },
    fitness: {
      icon:'üèÉ', name:'‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', glow:'violet',
      bossName:'Reflex Boss',
      bossBrief:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ (‡∏ñ‡∏π‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á = boost)',
    },
  };
  const Z = ZONE_DEF[ZONE] || ZONE_DEF.nutrition;

  // -----------------------------
  // State
  // -----------------------------
  const st = {
    step: 0,
    q1:false, q2:false, q3:false,
    bossWin:false,
    cooldownDone:false,
  };

  const s1=$('#s1'), s2=$('#s2'), s3=$('#s3'), sb=$('#sb'), sc=$('#sc');
  function syncSteps(){
    s1.classList.toggle('ok', st.q1);
    s2.classList.toggle('ok', st.q2);
    s3.classList.toggle('ok', st.q3);
    sb.classList.toggle('ok', st.bossWin);
    sc.classList.toggle('ok', st.cooldownDone);
  }

  const ctaQ1=$('#ctaQ1'), ctaQ2=$('#ctaQ2'), ctaQ3=$('#ctaQ3'), ctaBoss=$('#ctaBoss');
  const btnGoNext=$('#btnGoNext');
  function lockCtas(){
    ctaQ1.classList.toggle('disabled', false);
    ctaQ2.classList.toggle('disabled', !st.q1);
    ctaQ3.classList.toggle('disabled', !(st.q1 && st.q2));
    ctaBoss.classList.toggle('disabled', !(st.q1 && st.q2 && st.q3));
    btnGoNext.classList.toggle('disabled', !(st.bossWin && st.cooldownDone));
  }

  const badgeState=$('#badgeState');
  const badgeText=$('#badgeText');
  function setBadge(state){
    badgeState.classList.remove('ok','bad');
    if (state==='ok') badgeState.classList.add('ok');
    if (state==='bad') badgeState.classList.add('bad');
  }

  // Progress meter
  const barFill = $('#barFill');
  const meterText = $('#meterText');
  const meterLabel = $('#meterLabel');
  function setProgress(pct, mode){
    const p = Math.max(0, Math.min(100, Number(pct)||0));
    barFill.style.width = p + '%';
    barFill.classList.remove('good','bad');
    if (mode==='good') barFill.classList.add('good');
    if (mode==='bad') barFill.classList.add('bad');
    meterText.textContent = Math.round(p) + '%';
  }

  const arenaBig = $('#arenaBig');
  const arenaHint = $('#arenaHint');
  const arenaBody = $('#arenaBody');
  const statRow = $('#statRow');

  function clearTargets(){
    const old = document.querySelectorAll('.tgt, .pop');
    old.forEach(x=>x.remove());
  }
  function resetArena(){
    arenaBody.innerHTML = '';
    statRow.innerHTML = '';
    arenaBig.textContent = 'READY';
    arenaHint.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1';
    meterLabel.textContent = 'progress';
    setProgress(0);
    clearTargets();
  }

  function addChip(key, val){
    const el = document.createElement('div');
    el.className = 'chip';
    el.innerHTML = `<b>${key}</b>: ${String(val)}`;
    statRow.appendChild(el);
    return el;
  }

  function popText(x,y,txt){
    const p = document.createElement('div');
    p.className = 'pop';
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.textContent = txt;
    $('#arena').appendChild(p);
    setTimeout(()=>p.remove(), 650);
  }

  function setHeader(){
    setText('#zoneText', `${Z.icon} ${Z.name}`);
    const nx = (NEXT||'').toString();
    $('#nextText').textContent = 'next: ' + (nx.length>34 ? (nx.slice(0,34)+'‚Ä¶') : nx);

    const g = $('#flowGlow');
    const a = $('#arenaGlow');
    g.classList.remove('green','violet');
    a.classList.remove('green','violet');
    if (Z.glow==='green'){ g.classList.add('green'); a.classList.add('green'); }
    if (Z.glow==='violet'){ g.classList.add('violet'); a.classList.add('violet'); }

    setText('#flowTitle', `Daily Gate ‚Äî ${Z.icon} ${Z.name}`);
    setText('#arenaTitle', `‡∏™‡∏ô‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚Äî ${Z.bossName}`);
    setText('#bossBrief', Z.bossBrief);
    $('#subTitle').textContent = `‡πÇ‡∏ã‡∏ô: ${Z.icon} ${Z.name} ‚Ä¢ Daily: ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÇ‡∏ã‡∏ô ‚Ä¢ 3 Quest ‚Üí ‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‚Üí Cooldown ‚Üí Next`;
  }

  function renderPills(){
    const q = parseQS();
    const pills = [
      {k:'zone', v:ZONE},
      {k:'today', v:ymdLocal()},
      {k:'done', v:isZoneDoneToday(ZONE) ? 'YES' : ''},
      {k:'pid', v:q.get('pid')},
      {k:'run', v:q.get('run')},
      {k:'diff', v:q.get('diff')},
      {k:'time', v:q.get('time')},
      {k:'seed', v:q.get('seed')},
      {k:'studyId', v:q.get('studyId')},
      {k:'phase', v:q.get('phase')},
      {k:'conditionGroup', v:q.get('conditionGroup')},
      {k:'log', v:q.get('log')},
    ].filter(x => x.v != null && String(x.v).trim() !== '');
    $('#pillrow').innerHTML = pills
      .slice(0, 14)
      .map(x => `<span class="pill"><b>${x.k}</b>: ${String(x.v).replace(/</g,'&lt;')}</span>`)
      .join('') || `<span class="pill"><b>params</b>: none</span>`;
  }

  // -----------------------------
  // Quest 1 ‚Äî Power Tap (12 orbs, speed-up)
  // -----------------------------
  function startQ1(){
    st.step = 1;
    resetArena();
    arenaBig.textContent = '‚ö° POWER TAP';
    arenaHint.textContent = '‡πÅ‡∏ï‡∏∞‡∏≠‡∏≠‡∏£‡πå‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 (‡πÇ‡∏ú‡∏•‡πà‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ)';
    meterLabel.textContent = 'orbs';

    const arena = $('#arena');
    const total = 12;
    let hit = 0;
    let alive = null;
    let lifeMs = 1100;

    const chip = addChip('hit', `0/${total}`);
    addChip('speed', 'x1');

    function spawn(){
      if (alive) alive.remove();
      const rect = arena.getBoundingClientRect();
      const pad = 56;
      const x = pad + Math.random() * Math.max(1, (rect.width - pad*2));
      const y = 120 + Math.random() * Math.max(1, (rect.height - 150));

      const d = document.createElement('div');
      d.className = 'tgt';
      d.style.left = x + 'px';
      d.style.top  = y + 'px';
      d.innerHTML = `<div class="e">‚ö°</div>`;
      arena.appendChild(d);
      alive = d;

      let dead = false;
      const t0 = performance.now();

      function miss(){
        if (dead) return;
        dead = true;
        popText(x,y,'MISS');
        toast('‡∏û‡∏•‡∏≤‡∏î! ‡πÇ‡∏ú‡∏•‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        d.remove();
        spawn();
      }

      const tm = setTimeout(miss, lifeMs);

      d.addEventListener('click', ()=>{
        if (dead) return;
        dead = true;
        clearTimeout(tm);
        hit++;
        popText(x,y,'+1');
        toast('Nice!');
        d.remove();

        lifeMs = Math.max(420, Math.floor(lifeMs * 0.90));
        chip.innerHTML = `<b>hit</b>: ${hit}/${total}`;
        setProgress((hit/total)*100, hit>=total ? 'good' : null);

        if (hit >= total){
          st.q1 = true; st.step = 0;
          setBadge('ok'); badgeText.textContent = 'Q1 DONE';
          syncSteps(); lockCtas();
          arenaBig.textContent = '‚úÖ Q1 COMPLETE';
          arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Quest 2 ‡πÅ‡∏•‡πâ‡∏ß';
          toast('‡∏ú‡πà‡∏≤‡∏ô Quest 1!');
          return;
        }
        spawn();
      });
    }

    spawn();
  }

  // -----------------------------
  // Quest 2 ‚Äî Focus Rush (need streak >=6)
  // -----------------------------
  function startQ2(){
    if (!st.q1){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1 ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 2;
    resetArena();
    arenaBig.textContent = 'üéØ FOCUS RUSH';
    arenaHint.textContent = '‡∏ó‡∏≥ streak ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 6 (‡∏û‡∏•‡∏≤‡∏î = streak ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)';
    meterLabel.textContent = 'streak';

    const arena = $('#arena');
    const need = 6;
    let streak = 0;
    let best = 0;
    let alive = null;
    let lifeMs = 900;

    const chipS = addChip('streak', `0/${need}`);
    const chipB = addChip('best', '0');

    function spawn(){
      if (alive) alive.remove();
      const rect = arena.getBoundingClientRect();
      const pad = 56;
      const x = pad + Math.random() * Math.max(1, (rect.width - pad*2));
      const y = 120 + Math.random() * Math.max(1, (rect.height - 150));

      const d = document.createElement('div');
      d.className = 'tgt';
      d.style.left = x + 'px';
      d.style.top  = y + 'px';
      d.innerHTML = `<div class="e">üéØ</div>`;
      arena.appendChild(d);
      alive = d;

      let dead = false;
      const tm = setTimeout(()=>{
        if (dead) return;
        dead = true;
        popText(x,y,'-streak');
        streak = 0;
        chipS.innerHTML = `<b>streak</b>: ${streak}/${need}`;
        setProgress((streak/need)*100, 'bad');
        d.remove();
        toast('‡∏û‡∏•‡∏≤‡∏î! streak ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï');
        spawn();
      }, lifeMs);

      d.addEventListener('click', ()=>{
        if (dead) return;
        dead = true;
        clearTimeout(tm);
        streak++;
        best = Math.max(best, streak);
        chipS.innerHTML = `<b>streak</b>: ${streak}/${need}`;
        chipB.innerHTML = `<b>best</b>: ${best}`;
        popText(x,y,`STREAK ${streak}`);
        setProgress((streak/need)*100, streak>=need ? 'good' : null);
        d.remove();

        lifeMs = Math.max(380, Math.floor(lifeMs * 0.92));

        if (streak >= need){
          st.q2 = true; st.step = 0;
          setBadge('ok'); badgeText.textContent = 'Q2 DONE';
          syncSteps(); lockCtas();
          arenaBig.textContent = '‚úÖ Q2 COMPLETE';
          arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Quest 3 ‡πÅ‡∏•‡πâ‡∏ß';
          toast('‡∏ú‡πà‡∏≤‡∏ô Quest 2!');
          return;
        }
        spawn();
      });
    }

    spawn();
  }

  // -----------------------------
  // Quest 3 ‚Äî Pose Hold (3 poses, 3s each)
  // -----------------------------
  function startQ3(){
    if (!(st.q1 && st.q2)){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1‚Äì2 ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 3;
    resetArena();
    arenaBig.textContent = 'üßò POSE HOLD';
    arenaHint.textContent = '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ (‡∏ó‡πà‡∏≤‡∏•‡∏∞ 3 ‡∏ß‡∏¥) ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô';
    meterLabel.textContent = 'poses';

    const poses = [
      { emo:'üôÜ‚Äç‚ôÇÔ∏è', name:'‡∏¢‡∏∑‡∏î‡πÅ‡∏Ç‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏®‡∏µ‡∏£‡∏©‡∏∞' },
      { emo:'üßç‚Äç‚ôÇÔ∏è', name:'‡∏ö‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤' },
      { emo:'ü¶µ', name:'‡∏¢‡∏∑‡∏î‡∏ô‡πà‡∏≠‡∏á/‡∏Ç‡∏≤' },
    ];
    let idx = 0;
    let holding = false;
    let t = 0;
    let tick = null;

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="chip"><b>pose</b>: <span id="poseIdx">1</span>/3</div>
      <div class="big" id="poseEmo" style="margin-top:10px;">${poses[0].emo}</div>
      <div class="hint" id="poseHint">${poses[0].name}</div>
      <div class="btn good" id="holdBtn" style="margin-top:12px; justify-content:center;">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (3 ‡∏ß‡∏¥)</div>
      <div class="hint" style="margin-top:10px;">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ = ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    `;
    arenaBody.appendChild(box);

    const poseIdx = box.querySelector('#poseIdx');
    const poseEmo = box.querySelector('#poseEmo');
    const poseHint = box.querySelector('#poseHint');
    const holdBtn = box.querySelector('#holdBtn');

    function updatePose(){
      poseIdx.textContent = String(idx+1);
      poseEmo.textContent = poses[idx].emo;
      poseHint.textContent = poses[idx].name;
      t = 0;
      setProgress((idx/poses.length)*100, null);
      holdBtn.textContent = '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (3 ‡∏ß‡∏¥)';
    }

    function startHold(){
      if (holding) return;
      holding = true;
      holdBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á...';
      tick = setInterval(()=>{
        t += 0.1;
        setProgress(((idx + Math.min(1, t/3)) / poses.length)*100, null);
        const left = Math.max(0, 3 - t);
        holdBtn.textContent = `‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡∏Å ${left.toFixed(1)} ‡∏ß‡∏¥`;
        if (t >= 3){
          clearInterval(tick); tick=null;
          holding = false;
          toast('‡∏ú‡πà‡∏≤‡∏ô 1 ‡∏ó‡πà‡∏≤ ‚úÖ');
          idx++;
          if (idx >= poses.length){
            st.q3 = true; st.step = 0;
            setProgress(100,'good');
            setBadge('ok'); badgeText.textContent = 'Q3 DONE';
            syncSteps(); lockCtas();
            arenaBig.textContent = '‚úÖ Q3 COMPLETE';
            arenaHint.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏≠‡∏™‡πÅ‡∏•‡πâ‡∏ß!';
            toast('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏≠‡∏™!');
            return;
          }
          updatePose();
        }
      }, 100);
    }

    function cancelHold(){
      if (!holding) return;
      holding = false;
      if (tick){ clearInterval(tick); tick=null; }
      t = 0;
      setProgress((idx/poses.length)*100, null);
      holdBtn.textContent = '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ';
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚ùó');
      setTimeout(()=>{ if(!holding) holdBtn.textContent='‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (3 ‡∏ß‡∏¥)'; }, 520);
    }

    holdBtn.addEventListener('pointerdown', startHold);
    holdBtn.addEventListener('pointerup', cancelHold);
    holdBtn.addEventListener('pointercancel', cancelHold);
    holdBtn.addEventListener('mouseleave', cancelHold);

    updatePose();
  }

  // -----------------------------
  // Boss (Nutrition = fast classify with HP/streak)
  // -----------------------------
  function startBoss(){
    if (!(st.q1 && st.q2 && st.q3)){ toast('‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Quest 1‚Äì3 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
    st.step = 4;
    resetArena();

    arenaBig.textContent = 'üëë ZONE BOSS';
    arenaHint.textContent = `${Z.bossName} ‚Äî ${Z.bossBrief}`;
    meterLabel.textContent = 'boss';

    if (ZONE === 'nutrition') return bossNutrition();
    if (ZONE === 'hygiene') return bossHygiene();
    return bossFitness();
  }

  function bossNutrition(){
    // timed + streak ‚Üí reduce HP
    const pool = [
      {emo:'üçé', name:'‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•', good:true},
      {emo:'ü•¶', name:'‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ', good:true},
      {emo:'üêü', name:'‡∏õ‡∏•‡∏≤', good:true},
      {emo:'ü•õ', name:'‡∏ô‡∏°', good:true},
      {emo:'üçö', name:'‡∏Ç‡πâ‡∏≤‡∏ß', good:true},
      {emo:'ü•ú', name:'‡∏ñ‡∏±‡πà‡∏ß', good:true},
      {emo:'üç¨', name:'‡∏•‡∏π‡∏Å‡∏≠‡∏°', good:false},
      {emo:'üçü', name:'‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢‡∏™‡πå', good:false},
      {emo:'ü•§', name:'‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô', good:false},
      {emo:'üç©', name:'‡πÇ‡∏î‡∏ô‡∏±‡∏ó', good:false},
      {emo:'üçï', name:'‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤', good:false},
      {emo:'üå≠', name:'‡∏Æ‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å', good:false},
    ];

    let hp = 100;
    let streak = 0;
    let score = 0;
    let left = 18; // seconds
    let cur = null;

    const chipHP = addChip('HP', '100');
    const chipSt = addChip('streak', '0');
    const chipSc = addChip('score', '0');
    const chipT  = addChip('time', left + 's');

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill" id="bossStat">‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß: ‡∏ñ‡∏π‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á = ‡∏•‡∏î HP ‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</div>
      <div class="big" id="bossItem" style="margin-top:10px;">üçé</div>
      <div class="hint" id="bossName">‚Äî</div>
      <div class="choiceGrid">
        <div class="choiceBtn good" id="btnGood">
          <div class="lhs"><span class="emo">‚úÖ</span><div><div class="txt">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ</div><div class="sub">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</div></div></div>
          <div class="pill">GOOD</div>
        </div>
        <div class="choiceBtn bad" id="btnBad">
          <div class="lhs"><span class="emo">‚ö†Ô∏è</span><div><div class="txt">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞</div><div class="sub">‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡πá‡∏°‡∏à‡∏±‡∏î</div></div></div>
          <div class="pill">JUNK</div>
        </div>
      </div>
      <div class="hint">‡∏ä‡∏ô‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ HP ‡∏ö‡∏≠‡∏™‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0 ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (18s)</div>
    `;
    arenaBody.appendChild(box);

    const bossStat = box.querySelector('#bossStat');
    const bossItem = box.querySelector('#bossItem');
    const bossName = box.querySelector('#bossName');
    const btnGood = box.querySelector('#btnGood');
    const btnBad = box.querySelector('#btnBad');

    function pick(){
      cur = pool[Math.floor(Math.random()*pool.length)];
      bossItem.textContent = cur.emo;
      bossName.textContent = cur.name;
    }
    function sync(){
      chipHP.innerHTML = `<b>HP</b>: ${Math.max(0,Math.round(hp))}`;
      chipSt.innerHTML = `<b>streak</b>: ${streak}`;
      chipSc.innerHTML = `<b>score</b>: ${score}`;
      chipT.innerHTML  = `<b>time</b>: ${left}s`;
      setProgress(100 - Math.max(0, hp), hp<=0 ? 'good' : null);
    }

    function endFail(){
      setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
      setProgress(100,'bad');
      arenaBig.textContent = '‚ùå BOSS FAILED';
      arenaHint.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Äî ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ';
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
      st.step = 0;
      syncSteps(); lockCtas();
    }

    function endWin(){
      st.bossWin = true;
      setBadge('ok'); badgeText.textContent = 'BOSS WIN';
      arenaBig.textContent = 'üèÜ BOSS CLEARED';
      arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
      setProgress(100,'good');
      syncSteps(); lockCtas();
      toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
      setTimeout(startCooldown, 550);
    }

    function hit(isGood, ev){
      const ok = (!!isGood) === (!!cur.good);
      const rect = $('#arena').getBoundingClientRect();
      const px = Math.max(20, Math.min(rect.width-20, (ev?.clientX||rect.left+rect.width/2) - rect.left));
      const py = Math.max(120, Math.min(rect.height-20, (ev?.clientY||rect.top+rect.height/2) - rect.top));
      if (ok){
        streak++;
        score += 10 + Math.min(10, streak);
        const dmg = 7 + Math.min(10, Math.floor(streak/2)); // streak => more dmg
        hp -= dmg;
        popText(px, py, `-${dmg}HP`);
        toast('‡∏ñ‡∏π‡∏Å ‚úÖ');
      } else {
        streak = 0;
        score = Math.max(0, score - 6);
        hp -= 2; // still chip boss slightly to keep flow
        popText(px, py, 'OOPS');
        toast('‡∏ú‡∏¥‡∏î ‚ùó streak ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï');
      }
      if (hp <= 0){ sync(); return endWin(); }
      pick(); sync();
    }

    btnGood.addEventListener('click', (e)=>hit(true,e));
    btnBad.addEventListener('click', (e)=>hit(false,e));

    pick(); sync();

    const timer = setInterval(()=>{
      if (st.step !== 4){ clearInterval(timer); return; }
      left--;
      chipT.innerHTML  = `<b>time</b>: ${Math.max(0,left)}s`;
      if (left <= 0){
        clearInterval(timer);
        if (hp > 0) endFail();
      }
    }, 1000);
  }

  function bossHygiene(){
    // quick sequence (8 taps) with HP
    const steps = [
      {k:'‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏°‡∏∑‡∏≠', order:1},
      {k:'‡∏ü‡∏≠‡∏Å‡∏™‡∏ö‡∏π‡πà', order:2},
      {k:'‡∏ñ‡∏π‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß', order:3},
      {k:'‡∏ñ‡∏π‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠', order:4},
      {k:'‡∏ñ‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏°‡πà‡∏°‡∏∑‡∏≠', order:5},
      {k:'‡∏ñ‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß', order:6},
      {k:'‡∏•‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≥', order:7},
      {k:'‡πÄ‡∏ä‡πá‡∏î‡πÅ‡∏´‡πâ‡∏á', order:8},
    ];
    const display = steps.slice().sort(()=>Math.random()-0.5);

    let expected = 1;
    let hp = 100;

    addChip('HP', '100');
    addChip('need', '0');

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill">‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 1‚Üí8 ‚Ä¢ ‡∏ñ‡∏π‡∏Å = ‡∏•‡∏î HP ‚Ä¢ ‡∏ú‡∏¥‡∏î = HP ‡πÑ‡∏°‡πà‡∏•‡∏î</div>
      <div class="choiceGrid" id="choiceList"></div>
    `;
    arenaBody.appendChild(box);

    const choiceList = box.querySelector('#choiceList');

    function sync(){
      statRow.children[0].innerHTML = `<b>HP</b>: ${Math.max(0,Math.round(hp))}`;
      setProgress(100 - Math.max(0,hp), hp<=0 ? 'good' : null);
    }

    function win(){
      st.bossWin = true;
      setBadge('ok'); badgeText.textContent = 'BOSS WIN';
      arenaBig.textContent = 'üèÜ BOSS CLEARED';
      arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
      setProgress(100,'good');
      syncSteps(); lockCtas();
      toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
      setTimeout(startCooldown, 550);
    }

    display.forEach(it=>{
      const b = document.createElement('div');
      b.className = 'choiceBtn';
      b.innerHTML = `
        <div class="lhs">
          <span class="emo">üßº</span>
          <div><div class="txt">${it.k}</div><div class="sub">‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö ${it.order}</div></div>
        </div>
        <div class="pill">TAP</div>
      `;
      b.addEventListener('click', (e)=>{
        const ok = it.order === expected;
        if (ok){
          const dmg = 14;
          hp -= dmg;
          toast('‡∏ñ‡∏π‡∏Å ‚úÖ');
          b.classList.add('good');
        } else {
          toast('‡∏ú‡∏¥‡∏î ‚ùó');
          b.classList.add('bad');
        }
        b.style.pointerEvents='none';
        expected++;
        sync();
        if (hp <= 0 || expected > 8){
          if (hp <= 0) return win();
          // if didn't drop to 0, fail ‚Üí retry boss
          setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
          arenaBig.textContent = '‚ùå BOSS FAILED';
          arenaHint.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Äî ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ';
          toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
          st.step=0;
          syncSteps(); lockCtas();
        }
      });
      choiceList.appendChild(b);
    });

    sync();
  }

  function bossFitness(){
    const actions = [
      {k:'PUNCH', emo:'ü•ä', hint:'‡∏ä‡∏Å'},
      {k:'DUCK', emo:'ü¶Ü', hint:'‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö'},
      {k:'JUMP', emo:'ü¶ò', hint:'‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î'},
      {k:'HOLD', emo:'üßò', hint:'‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß'},
    ];
    let hp = 100;
    let left = 14;

    const chipHP = addChip('HP','100');
    const chipT  = addChip('time', left+'s');

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="pill">‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏•‡∏î HP ‡∏ö‡∏≠‡∏™ ‚Ä¢ 14s</div>
      <div class="big" id="promptEmo" style="margin-top:10px;">ü•ä</div>
      <div class="hint" id="promptTxt">PUNCH</div>
      <div class="choiceGrid">
        <div class="choiceBtn" data-k="PUNCH"><div class="lhs"><span class="emo">ü•ä</span><div><div class="txt">PUNCH</div><div class="sub">‡∏ä‡∏Å</div></div></div><div class="pill">1</div></div>
        <div class="choiceBtn" data-k="DUCK"><div class="lhs"><span class="emo">ü¶Ü</span><div><div class="txt">DUCK</div><div class="sub">‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö</div></div></div><div class="pill">2</div></div>
        <div class="choiceBtn" data-k="JUMP"><div class="lhs"><span class="emo">ü¶ò</span><div><div class="txt">JUMP</div><div class="sub">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î</div></div></div><div class="pill">3</div></div>
        <div class="choiceBtn" data-k="HOLD"><div class="lhs"><span class="emo">üßò</span><div><div class="txt">HOLD</div><div class="sub">‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß</div></div></div><div class="pill">4</div></div>
      </div>
    `;
    arenaBody.appendChild(box);

    const promptEmo = box.querySelector('#promptEmo');
    const promptTxt = box.querySelector('#promptTxt');
    const buttons = [...box.querySelectorAll('.choiceBtn')];

    let cur = null;

    function pick(){
      cur = actions[Math.floor(Math.random()*actions.length)];
      promptEmo.textContent = cur.emo;
      promptTxt.textContent = cur.k + ' ‚Äî ' + cur.hint;
    }
    function sync(){
      chipHP.innerHTML = `<b>HP</b>: ${Math.max(0,Math.round(hp))}`;
      chipT.innerHTML = `<b>time</b>: ${Math.max(0,left)}s`;
      setProgress(100 - Math.max(0,hp), hp<=0 ? 'good' : null);
    }
    function win(){
      st.bossWin = true;
      setBadge('ok'); badgeText.textContent = 'BOSS WIN';
      arenaBig.textContent = 'üèÜ BOSS CLEARED';
      arenaHint.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Cooldown';
      setProgress(100,'good');
      syncSteps(); lockCtas();
      toast('‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
      setTimeout(startCooldown, 550);
    }
    function fail(){
      setBadge('bad'); badgeText.textContent = 'BOSS FAIL';
      setProgress(100,'bad');
      arenaBig.textContent = '‚ùå BOSS FAILED';
      arenaHint.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Äî ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ';
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà');
      st.step=0;
      syncSteps(); lockCtas();
    }

    buttons.forEach(b=>{
      b.addEventListener('click', ()=>{
        const k = b.getAttribute('data-k');
        const ok = k === cur.k;
        if (ok){ hp -= 18; toast('‡∏ñ‡∏π‡∏Å ‚úÖ'); }
        else { hp -= 4; toast('‡∏ú‡∏¥‡∏î ‚ùó'); }
        if (hp <= 0){ sync(); return win(); }
        pick(); sync();
      });
    });

    pick(); sync();

    const timer = setInterval(()=>{
      if (st.step !== 4){ clearInterval(timer); return; }
      left--;
      sync();
      if (left<=0){
        clearInterval(timer);
        if (hp>0) fail();
      }
    }, 1000);
  }

  // -----------------------------
  // Cooldown then DONE + Next
  // -----------------------------
  function startCooldown(){
    st.step = 5;
    resetArena();
    arenaBig.textContent = 'üßò COOLDOWN';
    arenaHint.textContent = '‡∏û‡∏±‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à 12 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
    meterLabel.textContent = 'cooldown';

    const box = document.createElement('div');
    box.innerHTML = `
      <div class="big">12</div>
      <div class="hint">‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ mark ‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤ DONE ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div class="pill" style="margin-top:10px;">Tip: ‡∏™‡∏π‡∏î 4 ‚Üí ‡∏Å‡∏•‡∏±‡πâ‡∏ô 2 ‚Üí ‡∏ú‡πà‡∏≠‡∏ô 4</div>
    `;
    arenaBody.appendChild(box);
    const big = box.querySelector('.big');

    let t = 12;
    setProgress(0, null);

    const timer = setInterval(()=>{
      if (st.step !== 5){ clearInterval(timer); return; }
      t--;
      big.textContent = String(Math.max(0,t));
      setProgress(((12 - Math.max(0,t))/12)*100, 'good');
      if (t <= 0){
        clearInterval(timer);
        st.cooldownDone = true;
        st.step = 6;
        syncSteps(); lockCtas();
        setBadge('ok'); badgeText.textContent = 'READY';
        arenaBig.textContent = '‚úÖ READY';
        arenaHint.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß';
        toast('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å!');

        // IMPORTANT: mark zone done today (daily)
        markZoneDoneToday(ZONE);

        setTimeout(()=>goNext(true), 550);
      }
    }, 1000);
  }

  // -----------------------------
  // Navigation
  // -----------------------------
  function goBackHub(){ location.href = hubUrl(); }

  function goNext(auto){
    if (!(st.bossWin && st.cooldownDone)){
      toast('‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡∏ö‡∏≠‡∏™‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå)');
      return;
    }
    const url = buildNextUrl();
    if (!auto){
      showModal('‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å', '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏°‡∏µ hub ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠', '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°', ()=> location.href = url);
      return;
    }
    location.href = url;
  }

  function restartAll(){
    st.step=0; st.q1=false; st.q2=false; st.q3=false;
    st.bossWin=false; st.cooldownDone=false;
    setBadge(); badgeText.textContent='LOCKED';
    resetArena();
    syncSteps(); lockCtas();
    toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
  }

  // -----------------------------
  // Bind CTAs
  // -----------------------------
  ctaQ1.addEventListener('click', ()=> showModal('Quest 1 ‚Äî Power Tap', '‡πÅ‡∏ï‡∏∞‡∏≠‡∏≠‡∏£‡πå‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 (‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö)', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1', startQ1));
  ctaQ2.addEventListener('click', ()=>{ if (!st.q1) return; showModal('Quest 2 ‚Äî Focus Rush', '‡∏ó‡∏≥ streak ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 6 (‡∏û‡∏•‡∏≤‡∏î = ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 2', startQ2); });
  ctaQ3.addEventListener('click', ()=>{ if (!(st.q1 && st.q2)) return; showModal('Quest 3 ‚Äî Pose Hold', '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≤ 3 ‡∏ó‡πà‡∏≤ ‡∏ó‡πà‡∏≤‡∏•‡∏∞ 3 ‡∏ß‡∏¥ ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô', '‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 3', startQ3); });
  ctaBoss.addEventListener('click', ()=>{ if (!(st.q1 && st.q2 && st.q3)) return; showModal('Zone Boss', `${Z.bossName}\n${Z.bossBrief}`, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™', startBoss); });

  $('#btnBackHub').addEventListener('click', goBackHub);
  $('#btnRestart').addEventListener('click', restartAll);
  $('#btnGoNext').addEventListener('click', ()=>goNext(false));

  // -----------------------------
  // Init
  // -----------------------------
  function init(){
    setHeader();
    renderPills();

    badgeText.textContent = 'LOCKED';
    setBadge();
    syncSteps(); lockCtas();
    resetArena();

    $('#badgeZone').classList.add('ok');
    $('#badgeNext').classList.add('ok');

    // If zone already done today, gate should not really be needed,
    // but in case user lands here directly, offer to go next immediately.
    if (isZoneDoneToday(ZONE)){
      st.q1 = st.q2 = st.q3 = true;
      st.bossWin = true;
      st.cooldownDone = true;
      syncSteps(); lockCtas();
      setBadge('ok'); badgeText.textContent = 'DONE TODAY';
      arenaBig.textContent = '‚úÖ DONE TODAY';
      arenaHint.textContent = '‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
      toast('‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
    } else {
      setTimeout(()=> toast('‡πÄ‡∏£‡∏¥‡πà‡∏° Quest 1 ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚ö°'), 120);
    }
  }
  init();

})();
</script>
</body>
</html>
