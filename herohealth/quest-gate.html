<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî Warmup & Cooldown (20s)</title>
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel: rgba(2,6,23,.72);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --good:#22c55e; --cyan:#22d3ee; --violet:#a78bfa; --amber:#f59e0b;
      --radius:22px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      font-synthesis-weight: none;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 800px at 20% 10%, #10224b 0%, transparent 55%),
                               radial-gradient(1100px 700px at 80% 30%, #2a1646 0%, transparent 55%),
                               linear-gradient(180deg, var(--bg2), var(--bg1));
             color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif; }
    a{ color:inherit; }

    .wrap{ min-height:100%; padding: calc(14px + var(--sat)) 14px calc(14px + var(--sab)); display:flex; justify-content:center; }
    .card{
      width:min(920px, 100%);
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      overflow:hidden;
    }

    header{ padding:18px 18px 12px; border-bottom:1px solid var(--stroke); display:flex; gap:14px; align-items:center; justify-content:space-between; }
    .title{ display:flex; flex-direction:column; gap:4px; }
    .title h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .title p{ margin:0; color:var(--muted); font-size:12.5px; }

    .pill{ display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border:1px solid var(--stroke);
           border-radius: 999px; font-size:12px; color:var(--muted); background: rgba(15,23,42,.40); }
    .pill b{ color:var(--text); font-weight:700; }

    main{ padding:16px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media (max-width: 820px){ main{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(15,23,42,.55);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding:14px;
    }

    .grid3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 520px){ .grid3{ grid-template-columns: 1fr; } }

    button{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      color:var(--text);
      padding:12px 12px;
      border-radius: 16px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(2,6,23,.72); border-color: rgba(148,163,184,.32); transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); }
    button[disabled]{ opacity:.5; cursor:not-allowed; transform:none; }

    .modeBtn{ text-align:left; display:flex; gap:12px; align-items:center; }
    .modeIcon{ width:46px; height:46px; border-radius: 14px; display:flex; align-items:center; justify-content:center;
               background: rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.25); font-size:22px; }
    .modeMeta{ display:flex; flex-direction:column; gap:2px; }
    .modeMeta .name{ font-weight:800; }
    .modeMeta .desc{ font-size:12px; color:var(--muted); }
    .modeMeta .tag{ font-size:11px; color:rgba(229,231,235,.86); }

    .big{
      display:flex; flex-direction:column; gap:10px;
      align-items:center; justify-content:center;
      min-height: 260px;
      text-align:center;
      padding: 12px;
    }
    .emoji{
      font-size: 64px; line-height:1;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
    }
    .h2{ font-size: 22px; margin: 0; }
    .hint{ margin:0; color:var(--muted); font-size: 13px; }

    .timerRow{ width:min(520px,100%); display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .timeBox{
      flex:0 0 auto;
      padding: 8px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      font-weight: 800;
    }

    .bar{
      width:min(520px,100%);
      height: 14px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.55);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.92));
      transition: width .12s linear;
    }

    .actionRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top: 6px; }
    .primary{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.32);
    }
    .primary:hover{ background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.45); }
    .danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.28);
    }

    .side h3{ margin:0 0 8px; font-size: 14px; color: rgba(229,231,235,.95); }
    .side p{ margin:0 0 10px; color:var(--muted); font-size: 12.5px; line-height:1.45; }
    .kv{ display:grid; grid-template-columns: 1fr auto; gap:8px; margin-top:10px; }
    .kv div{ padding:10px 10px; border:1px solid var(--stroke); border-radius: 14px; background: rgba(2,6,23,.45); font-size: 12.5px; }
    .kv b{ font-weight:900; }
    .muted{ color:var(--muted); }

    footer{ padding: 12px 16px; border-top:1px solid var(--stroke); display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap; }
    .mini{ font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card" id="app">
    <header>
      <div class="title">
        <h1>üåü Warmup + Cooldown (20 ‡∏ß‡∏¥)</h1>
        <p>‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° 20 ‡∏ß‡∏¥ ‚Üí ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡∏û‡∏≠‡∏î‡∏µ ‡πÜ / ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå 20 ‡∏ß‡∏¥ ‚Üí ‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏õ‡∏ï‡πà‡∏≠</p>
      </div>
      <div class="pill">
        ‡πÇ‡∏´‡∏°‡∏î: <b id="modeBadge">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</b>
      </div>
    </header>

    <main>
      <!-- LEFT: main stage -->
      <section class="panel">
        <div id="screen-select">
          <div class="panel" style="margin-bottom:12px;">
            <div class="mini">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: Breathing ‡∏Å‡πà‡∏≠‡∏ô) ‚Äî ‡πÄ‡∏ß‡∏•‡∏≤ 20 ‡∏ß‡∏¥‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö</div>
          </div>

          <div class="grid3">
            <button class="modeBtn" id="btn-breath">
              <div class="modeIcon" style="background: rgba(34,211,238,.10); border-color: rgba(34,211,238,.25);">üå¨Ô∏è</div>
              <div class="modeMeta">
                <div class="name">Breathing</div>
                <div class="desc">‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ ‚Äú‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‚Äù</div>
                <div class="tag">‡∏ö‡∏±‡∏ü: ‚≠ê Critical +</div>
              </div>
            </button>

            <button class="modeBtn" id="btn-meditate">
              <div class="modeIcon" style="background: rgba(167,139,250,.10); border-color: rgba(167,139,250,.25);">üßò</div>
              <div class="modeMeta">
                <div class="name">Meditation</div>
                <div class="desc">‡πÅ‡∏ï‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù</div>
                <div class="tag">‡∏ö‡∏±‡∏ü: üõ°Ô∏è Damage ‡∏•‡∏î</div>
              </div>
            </button>

            <button class="modeBtn" id="btn-stretch">
              <div class="modeIcon" style="background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25);">ü§∏</div>
              <div class="modeMeta">
                <div class="name">Stretching</div>
                <div class="desc">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                <div class="tag">‡∏ö‡∏±‡∏ü: üíö Heal +</div>
              </div>
            </button>
          </div>

          <div class="actionRow" style="margin-top:14px;">
            <button id="btn-cooldown" class="primary">üòå ‡πÑ‡∏õ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå 20 ‡∏ß‡∏¥</button>
          </div>
        </div>

        <div id="screen-run" class="big" style="display:none;">
          <div class="emoji" id="run-emoji">üå¨Ô∏è</div>
          <h2 class="h2" id="run-title">Warmup</h2>
          <p class="hint" id="run-hint">‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>

          <div class="timerRow">
            <div class="timeBox" id="run-time">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: 20 ‡∏ß‡∏¥</div>
            <div class="timeBox" id="run-score">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: 0%</div>
          </div>

          <div class="bar"><i id="run-bar"></i></div>

          <!-- interaction zone -->
          <div class="actionRow" id="run-actions" style="margin-top:10px;"></div>

          <div class="actionRow" style="margin-top:10px;">
            <button id="btn-stop" class="danger">‡∏´‡∏¢‡∏∏‡∏î</button>
          </div>
        </div>

        <div id="screen-done" class="big" style="display:none;">
          <div class="emoji">üéâ</div>
          <h2 class="h2">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
          <p class="hint" id="done-text">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü</p>

          <div class="panel" style="width:min(520px,100%); text-align:left;">
            <div class="mini muted">BUFF ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</div>
            <pre id="done-json" style="margin:10px 0 0; white-space:pre-wrap; color:#e5e7eb; font-size:12px;"></pre>
          </div>

          <div class="actionRow">
            <button id="btn-again">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
            <button id="btn-go-cooldown" class="primary">‡πÑ‡∏õ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå 20 ‡∏ß‡∏¥</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: info -->
      <aside class="panel side">
        <h3>‚ú® ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£</h3>
        <p>
          Warmup 20 ‡∏ß‡∏¥ ‡∏Ñ‡∏∑‡∏≠ ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‚Äù ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          ‡πÅ‡∏•‡∏∞ Cooldown 20 ‡∏ß‡∏¥ ‡∏ä‡πà‡∏ß‡∏¢ ‚Äú‡∏à‡∏ö‡πÅ‡∏ö‡∏ö‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á‚Äù ‡πÄ‡∏î‡πá‡∏Å‡πÑ‡∏°‡πà‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô
        </p>

        <h3>üéØ ‡∏ö‡∏±‡∏ü (‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 20 ‡∏ß‡∏¥)</h3>
        <div class="kv">
          <div>‚≠ê Critical Bonus</div><div><b>3% ‚Üí 7%</b></div>
          <div>üõ°Ô∏è Damage Reduce</div><div><b>6% ‚Üí 16%</b></div>
          <div>üíö Heal Bonus</div><div><b>+4 ‚Üí +10</b></div>
        </div>

        <h3 style="margin-top:14px;">üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•</h3>
        <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà <span class="muted">localStorage["HHA_WARMUP_LAST"]</span></p>

        <div class="actionRow" style="justify-content:flex-start;">
          <button id="btn-clear-last">‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        </div>
      </aside>
    </main>

    <footer>
      <div class="mini">HeroHealth ¬∑ Warmup/Cooldown Gate</div>
      <div class="mini">Tip: ‡πÉ‡∏ä‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ ‚Äú‡πÅ‡∏ï‡∏∞‚Äù ‡πÑ‡∏î‡πâ‡∏•‡∏∑‡πà‡∏ô ‡πÜ</div>
    </footer>
  </div>
</div>

<script>
(() => {
  'use strict';

  // ------------------------------
  // Config
  // ------------------------------
  const WARMUP_SECONDS = 20;
  const COOLDOWN_SECONDS = 20;

  const KEY_LAST = 'HHA_WARMUP_LAST';

  // ------------------------------
  // DOM helpers
  // ------------------------------
  const $ = (s) => document.querySelector(s);
  const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));

  const screenSelect = $('#screen-select');
  const screenRun    = $('#screen-run');
  const screenDone   = $('#screen-done');

  const modeBadge = $('#modeBadge');

  const runEmoji = $('#run-emoji');
  const runTitle = $('#run-title');
  const runHint  = $('#run-hint');
  const runTime  = $('#run-time');
  const runScore = $('#run-score');
  const runBar   = $('#run-bar');
  const runActions = $('#run-actions');

  const doneText = $('#done-text');
  const doneJson = $('#done-json');

  // ------------------------------
  // State
  // ------------------------------
  let timerId = null;
  let tickId = null;

  const state = {
    mode: null,       // 'breathing' | 'meditation' | 'stretching' | 'cooldown'
    tLeft: 0,
    pct: 0,
    // breathing
    step: 0,          // 0 inhale, 1 exhale
    hits: 0,
    // meditation
    focusGood: 0,
    // stretching
    holding: false,
    holdMs: 0,
    // cooldown
    calm: 0
  };

  function resetRunState(){
    state.tLeft = WARMUP_SECONDS;
    state.pct = 0;
    state.step = 0;
    state.hits = 0;
    state.focusGood = 0;
    state.holding = false;
    state.holdMs = 0;
    state.calm = 0;
  }

  function show(which){
    screenSelect.style.display = (which==='select') ? '' : 'none';
    screenRun.style.display    = (which==='run') ? '' : 'none';
    screenDone.style.display   = (which==='done') ? '' : 'none';
  }

  function setProgress(pct){
    state.pct = clamp(pct,0,100);
    runScore.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${Math.round(state.pct)}%`;
    runBar.style.width = `${state.pct}%`;
  }

  function setTimeLeft(sec){
    state.tLeft = sec;
    runTime.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${sec} ‡∏ß‡∏¥`;
  }

  function stopTimers(){
    if (timerId){ clearInterval(timerId); timerId = null; }
    if (tickId){ clearInterval(tickId); tickId = null; }
  }

  function finishRun(){
    stopTimers();

    const pct = clamp(state.pct,0,100);

    // Balanced for 20s:
    // critBonus: 3%..7%
    // dmgReduce: 6%..16%
    // healBonus: +4..+10
    let buff = { type: state.mode, pct };

    if (state.mode === 'breathing'){
      buff = {
        type: 'breathing',
        pct,
        critBonus: +(0.03 + (pct/100)*0.04).toFixed(3) // 0.03..0.07
      };
    } else if (state.mode === 'meditation'){
      buff = {
        type: 'meditation',
        pct,
        dmgReduce: +(0.06 + (pct/100)*0.10).toFixed(3) // 0.06..0.16
      };
    } else if (state.mode === 'stretching'){
      buff = {
        type: 'stretching',
        pct,
        healBonus: Math.round(4 + (pct/100)*6) // 4..10
      };
    } else if (state.mode === 'cooldown'){
      buff = {
        type: 'cooldown',
        pct,
        calm: Math.round(pct) // 0..100
      };
    }

    // Save last
    try{
      localStorage.setItem(KEY_LAST, JSON.stringify({
        ...buff,
        at: new Date().toISOString()
      }));
    }catch(_){}

    doneText.textContent = (state.mode === 'cooldown')
      ? '‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡πÉ‡∏à‡∏ô‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô!'
      : '‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ü‡πÑ‡∏õ‡∏•‡∏∏‡∏¢‡πÄ‡∏Å‡∏°!';

    doneJson.textContent = JSON.stringify(buff, null, 2);

    modeBadge.textContent = (state.mode === 'cooldown') ? 'Cooldown' : 'Warmup';
    show('done');

    // Optional: dispatch event to parent/game
    try{
      window.dispatchEvent(new CustomEvent('hha:warmup_done', { detail: buff }));
    }catch(_){}
  }

  // ------------------------------
  // Modes
  // ------------------------------
  function startBreathing(){
    stopTimers();
    resetRunState();
    state.mode = 'breathing';
    modeBadge.textContent = 'Breathing';
    runEmoji.textContent = 'üå¨Ô∏è';
    runTitle.textContent = 'Warmup: Breathing (20 ‡∏ß‡∏¥)';
    runHint.textContent = '‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ‚Äú‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‚Äù ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å‚Äù ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏õ';

    runActions.innerHTML = `
      <button class="primary" id="btn-breath-act">‡πÄ‡∏£‡∏¥‡πà‡∏°!</button>
    `;

    const actBtn = $('#btn-breath-act');

    function updatePrompt(){
      const inhale = (state.step % 2) === 0;
      actBtn.textContent = inhale ? '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å';
      actBtn.dataset.want = inhale ? 'in' : 'out';
    }

    updatePrompt();
    setTimeLeft(WARMUP_SECONDS);
    setProgress(0);
    show('run');

    actBtn.addEventListener('click', () => {
      // every tap counts if correct sequence; encourage rhythm
      state.hits++;
      state.step++;

      // Score: hits per second (cap 100)
      const ideal = WARMUP_SECONDS * 1.0; // ~1 tap per sec
      const pct = clamp((state.hits / ideal) * 100, 0, 100);
      setProgress(pct);

      updatePrompt();
    });

    // Timer
    let t = WARMUP_SECONDS;
    timerId = setInterval(() => {
      t--;
      setTimeLeft(t);
      if (t <= 0) finishRun();
    }, 1000);
  }

  function startMeditation(){
    stopTimers();
    resetRunState();
    state.mode = 'meditation';
    modeBadge.textContent = 'Meditation';
    runEmoji.textContent = 'üßò';
    runTitle.textContent = 'Warmup: Meditation (20 ‡∏ß‡∏¥)';
    runHint.textContent = '‡πÅ‡∏ï‡∏∞ ‚Äú‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ)';

    runActions.innerHTML = `
      <div id="med-box" style="position:relative; width:min(520px,100%); height:180px; border-radius:18px; border:1px dashed rgba(148,163,184,.35); background:rgba(2,6,23,.35); overflow:hidden;">
        <button id="med-dot" class="primary" style="position:absolute; left:40%; top:40%; width:70px; height:70px; border-radius:999px; font-weight:900;">‚óè</button>
        <button id="bad-dot" style="position:absolute; left:70%; top:20%; width:56px; height:56px; border-radius:999px; border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10);">‚óè</button>
      </div>
    `;

    const box = $('#med-box');
    const good = $('#med-dot');
    const bad = $('#bad-dot');

    function place(el){
      const w = box.clientWidth, h = box.clientHeight;
      const ew = el.offsetWidth, eh = el.offsetHeight;
      const x = Math.random() * (w - ew);
      const y = Math.random() * (h - eh);
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
    }

    const onGood = () => {
      state.focusGood++;
      place(good);
      // pct based on hits / seconds (20)
      setProgress(clamp((state.focusGood / WARMUP_SECONDS) * 100, 0, 100));
    };

    const onBad = () => {
      // small penalty
      state.focusGood = Math.max(0, state.focusGood - 1);
      place(bad);
      setProgress(clamp((state.focusGood / WARMUP_SECONDS) * 100, 0, 100));
    };

    good.addEventListener('click', onGood);
    bad.addEventListener('click', onBad);

    // move targets periodically
    tickId = setInterval(() => { place(good); place(bad); }, 650);

    setTimeLeft(WARMUP_SECONDS);
    setProgress(0);
    show('run');

    let t = WARMUP_SECONDS;
    timerId = setInterval(() => {
      t--;
      setTimeLeft(t);
      if (t <= 0) finishRun();
    }, 1000);
  }

  function startStretching(){
    stopTimers();
    resetRunState();
    state.mode = 'stretching';
    modeBadge.textContent = 'Stretching';
    runEmoji.textContent = 'ü§∏';
    runTitle.textContent = 'Warmup: Stretching (20 ‡∏ß‡∏¥)';
    runHint.textContent = '‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏¢‡∏∑‡∏î!‚Äù ‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î)';

    runActions.innerHTML = `
      <button class="primary" id="btn-hold" style="padding:16px 22px; font-size:16px; font-weight:900;">‡∏¢‡∏∑‡∏î! (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á)</button>
      <div class="mini muted">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
    `;

    const hold = $('#btn-hold');

    const down = () => { state.holding = true; hold.textContent='‡∏¢‡∏∑‡∏î‡∏≠‡∏¢‡∏π‡πà... ‚ú®'; };
    const up   = () => { state.holding = false; hold.textContent='‡∏¢‡∏∑‡∏î! (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á)'; };

    hold.addEventListener('pointerdown', (e)=>{ e.preventDefault(); down(); });
    window.addEventListener('pointerup', up);
    window.addEventListener('pointercancel', up);

    // 20ms tick for hold
    tickId = setInterval(() => {
      if (state.holding) state.holdMs += 20;
      // pct based on hold ms / 20s
      setProgress(clamp((state.holdMs / (WARMUP_SECONDS*1000)) * 100, 0, 100));
    }, 20);

    setTimeLeft(WARMUP_SECONDS);
    setProgress(0);
    show('run');

    let t = WARMUP_SECONDS;
    timerId = setInterval(() => {
      t--;
      setTimeLeft(t);
      if (t <= 0) finishRun();
    }, 1000);
  }

  function startCooldown(){
    stopTimers();
    resetRunState();
    state.mode = 'cooldown';
    state.tLeft = COOLDOWN_SECONDS;

    modeBadge.textContent = 'Cooldown';
    runEmoji.textContent = 'üòå';
    runTitle.textContent = 'Cooldown: ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πâ‡∏≤ ‡πÜ (20 ‡∏ß‡∏¥)';
    runHint.textContent = '‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞: ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤ 4 ‡∏ß‡∏¥‚Äù ‚Üí ‚Äú‡∏≠‡∏≠‡∏Å 4 ‡∏ß‡∏¥‚Äù (‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)';

    runActions.innerHTML = `
      <button class="primary" id="btn-calm" style="padding:14px 18px; font-size:15px; font-weight:900;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</button>
      <div class="mini muted" id="calm-step">‡πÄ‡∏Ç‡πâ‡∏≤... 4</div>
    `;

    const calmBtn = $('#btn-calm');
    const calmStep = $('#calm-step');

    let phase = 'in';
    let k = 4;
    calmBtn.addEventListener('click', () => {
      // tiny interaction to keep attention; increases calm slightly
      state.calm = clamp(state.calm + 2, 0, 100);
      setProgress(state.calm);
    });

    setTimeLeft(COOLDOWN_SECONDS);
    setProgress(0);
    show('run');

    // breath cue tick
    tickId = setInterval(() => {
      k--;
      if (k <= 0){
        phase = (phase === 'in') ? 'out' : 'in';
        k = 4;
      }
      calmStep.textContent = (phase === 'in') ? `‡πÄ‡∏Ç‡πâ‡∏≤... ${k}` : `‡∏≠‡∏≠‡∏Å... ${k}`;

      // passive calm gain
      state.calm = clamp(state.calm + 1.2, 0, 100);
      setProgress(state.calm);
    }, 1000);

    let t = COOLDOWN_SECONDS;
    timerId = setInterval(() => {
      t--;
      setTimeLeft(t);
      if (t <= 0) finishRun();
    }, 1000);
  }

  // ------------------------------
  // Buttons
  // ------------------------------
  $('#btn-breath').addEventListener('click', startBreathing);
  $('#btn-meditate').addEventListener('click', startMeditation);
  $('#btn-stretch').addEventListener('click', startStretching);

  $('#btn-cooldown').addEventListener('click', startCooldown);

  $('#btn-stop').addEventListener('click', () => {
    stopTimers();
    show('select');
    modeBadge.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
  });

  $('#btn-again').addEventListener('click', () => {
    stopTimers();
    show('select');
    modeBadge.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
  });

  $('#btn-go-cooldown').addEventListener('click', startCooldown);

  $('#btn-clear-last').addEventListener('click', () => {
    try{ localStorage.removeItem(KEY_LAST); }catch(_){}
    alert('‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  });

  // init
  show('select');
})();
</script>
</body>
</html>
