<!-- === /herohealth/hub.html ===
HeroHealth ‚Äî Hub (3 Zones) ‚Äî PRODUCTION (Big Zone Status + Reset today)
‚úÖ No forced ordering: play any game anytime
‚úÖ Shows BIG zone status bars/icons
‚úÖ Reset today clears all 3 zone daily gates
‚úÖ Links to ROOT launchers in /herohealth (root) where available
‚úÖ Pass-through hub/run/diff/time/seed/studyId/phase/conditionGroup/log/view (+ auto view detect if missing)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hub</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel:rgba(2,6,23,.70);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;

      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --cyan:#22d3ee; --violet:#a78bfa;

      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1000px 600px at 85% 20%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(900px 520px at 55% 90%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
      overflow:auto;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:1160px; margin:0 auto; display:flex; flex-direction:column; gap:12px; }

    /* Top header */
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 6px 6px 0 6px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{
      margin:0;
      font-size: clamp(22px, 2.2vw, 30px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.4;
      max-width: 78ch;
    }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
    }
    .pill b{ color:var(--text); font-weight:900; }

    /* Big zone status bar */
    .zonebar{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .zonebarHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      flex-wrap:wrap;
    }
    .zonebarHead .left{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .bigPill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
    }
    .bigPill .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 18px rgba(245,158,11,.35);
    }
    .bigPill.ok .dot{ background: var(--good); box-shadow: 0 0 18px rgba(34,197,94,.35); }
    .bigPill.bad .dot{ background: var(--bad); box-shadow: 0 0 18px rgba(239,68,68,.35); }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      padding:10px 12px;
      border-radius: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
      font-weight:900;
      font-size:13px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); }
    .btn.ghost{ color:var(--muted); }
    .btn.disabled{ opacity:.5; cursor:not-allowed; }

    .zonebarBody{
      padding: 12px 12px 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 980px){
      .zonebarBody{ grid-template-columns: 1fr; }
      .pillrow{ justify-content:flex-start; }
      .actions{ justify-content:flex-start; }
    }
    .zoneCard{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.40);
      border-radius: 18px;
      padding: 14px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      min-height: 160px;
    }
    .zoneCard h3{
      margin:0 0 6px 0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .zoneCard p{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.45;
    }
    .glow{
      position:absolute; inset:-40% -35% auto auto;
      width:240px; height:240px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.22), transparent 60%);
      filter: blur(10px);
      transform: rotate(14deg);
      pointer-events:none;
      opacity:.9;
    }
    .glow.cyan{ background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.22), transparent 60%); }
    .glow.violet{ background: radial-gradient(circle at 30% 30%, rgba(167,139,250,.22), transparent 60%); }

    .miniStatus{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.28);
      color:var(--muted);
      font-size: 12px;
      font-weight:800;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{ color:var(--text); font-weight:900; }
    .meter{
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      margin-top:10px;
    }
    .fill{
      height:100%;
      width:0%;
      background: rgba(34,197,94,.85);
      transition: width .14s ease;
    }
    .fill.cyan{ background: rgba(34,211,238,.85); }
    .fill.violet{ background: rgba(167,139,250,.85); }
    .fill.warn{ background: rgba(245,158,11,.88); }

    /* Game grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 560px){ .grid{ grid-template-columns: 1fr; } }

    .game{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.46);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      min-height: 132px;
    }
    .game:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.06); }
    .game:active{ transform: translateY(1px); }
    .gameTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .gameTitle{ font-weight:900; letter-spacing:.2px; margin:0; font-size: 15px; }
    .gameSub{ margin:6px 0 0 0; color:var(--muted); font-size: 12px; line-height:1.35; }
    .tag{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      color: var(--text);
      font-weight:900;
      white-space:nowrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--sab));
      transform: translateX(-50%);
      background: rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 9999;
      max-width: 92vw;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 class="title">üè∞ HeroHealth ‚Äî Hub</h1>
        <p class="subtitle">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏´‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö Daily Gate ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° ‚Äú‡πÇ‡∏ã‡∏ô‚Äù ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÇ‡∏ã‡∏ô
        </p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <!-- BIG ZONE STATUS + RESET -->
    <section class="zonebar" aria-label="Zone status">
      <div class="zonebarHead">
        <div class="left">
          <div class="bigPill" id="pillNutrition"><span class="dot"></span><span id="tNutrition">ü•ó Nutrition: ‚Äî</span></div>
          <div class="bigPill" id="pillHygiene"><span class="dot"></span><span id="tHygiene">üßº Hygiene: ‚Äî</span></div>
          <div class="bigPill" id="pillFitness"><span class="dot"></span><span id="tFitness">üèÉ Fitness: ‚Äî</span></div>
          <span class="pill"><b>today</b>: <span id="todayText">‚Äî</span></span>
        </div>
        <div class="actions">
          <div class="btn ghost" id="btnHow">‚ùì ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ú‡πà‡∏≤‡∏ô Daily Gate</div>
          <div class="btn warn" id="btnResetToday">‚ôªÔ∏è Reset today (‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á 3 ‡πÇ‡∏ã‡∏ô)</div>
        </div>
      </div>

      <div class="zonebarBody">
        <div class="zoneCard">
          <div class="glow"></div>
          <h3>ü•ó Nutrition</h3>
          <p>‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£: GoodJunk / Groups / Hydration / Plate</p>
          <div class="miniStatus">
            <span class="chip"><b>Gate</b>: <span id="cNutGate">‚Äî</span></span>
            <span class="chip"><b>Key</b>: HHA_ZONE_DONE::nutrition</span>
          </div>
          <div class="meter"><div class="fill" id="mNut"></div></div>
        </div>

        <div class="zoneCard">
          <div class="glow cyan"></div>
          <h3>üßº Hygiene</h3>
          <p>‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢: Hygiene VR / MaskCough</p>
          <div class="miniStatus">
            <span class="chip"><b>Gate</b>: <span id="cHygGate">‚Äî</span></span>
            <span class="chip"><b>Key</b>: HHA_ZONE_DONE::hygiene</span>
          </div>
          <div class="meter"><div class="fill cyan" id="mHyg"></div></div>
        </div>

        <div class="zoneCard">
          <div class="glow violet"></div>
          <h3>üèÉ Fitness</h3>
          <p>‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢: Shadow / Rhythm / Jump-Duck / Balance Hold / Planner</p>
          <div class="miniStatus">
            <span class="chip"><b>Gate</b>: <span id="cFitGate">‚Äî</span></span>
            <span class="chip"><b>Key</b>: HHA_ZONE_DONE::fitness</span>
          </div>
          <div class="meter"><div class="fill violet" id="mFit"></div></div>
        </div>
      </div>
    </section>

    <!-- ===== NUTRITION ===== -->
    <section aria-label="Nutrition">
      <div class="pill" style="width:fit-content;"><b>ü•ó Nutrition games</b> (Root launcher ‡πÉ‡∏ô /herohealth)</div>
      <div class="grid">
        <div class="game" data-href="./goodjunk-vr-launcher.html" data-zone="nutrition">
          <div class="gameTop">
            <h3 class="gameTitle">üç≠ GoodJunk VR</h3>
            <span class="tag">Launcher</span>
          </div>
          <p class="gameSub">‡∏¢‡∏¥‡∏á/‡πÅ‡∏ï‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ-‡∏Ç‡∏¢‡∏∞ ‚Ä¢ missions/summary ‚Ä¢ Daily Gate ‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô</p>
        </div>

        <div class="game" data-href="./groups-vr.html" data-zone="nutrition">
          <div class="gameTop">
            <h3 class="gameTitle">üß© Food Groups VR</h3>
            <span class="tag">Launcher</span>
          </div>
          <p class="gameSub">‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏õ.5 ‚Ä¢ Daily Gate ‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô</p>
        </div>

        <div class="game" data-href="./hydration-vr.html" data-zone="nutrition">
          <div class="gameTop">
            <h3 class="gameTitle">üíß Hydration VR</h3>
            <span class="tag">Launcher</span>
          </div>
          <p class="gameSub">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‚Ä¢ Daily Gate ‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô</p>
        </div>

        <div class="game" data-href="./plate-vr.html" data-zone="nutrition">
          <div class="gameTop">
            <h3 class="gameTitle">üçΩÔ∏è Plate VR</h3>
            <span class="tag">Launcher</span>
          </div>
          <p class="gameSub">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà ‚Ä¢ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î ‚Ä¢ Daily Gate ‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô</p>
        </div>
      </div>
    </section>

    <!-- ===== HYGIENE ===== -->
    <section aria-label="Hygiene">
      <div class="pill" style="width:fit-content; margin-top:2px;"><b>üßº Hygiene games</b> (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /herohealth)</div>
      <div class="grid">
        <div class="game" data-href="./hygiene-vr.html" data-zone="hygiene">
          <div class="gameTop">
            <h3 class="gameTitle">üßº Hygiene VR</h3>
            <span class="tag">Root</span>
          </div>
          <p class="gameSub">Handwash / Brush ‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö launcher ‡πÑ‡∏î‡πâ (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö auto view)</p>
        </div>

        <div class="game" data-href="./maskcough-vr.html" data-zone="hygiene">
          <div class="gameTop">
            <h3 class="gameTitle">üò∑ Mask &amp; Cough VR</h3>
            <span class="tag">Root</span>
          </div>
          <p class="gameSub">‡∏ù‡∏∂‡∏Å‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å + ‡∏°‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏Å‡∏≤‡∏£‡πÑ‡∏≠ ‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Hub ‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
      </div>
    </section>

    <!-- ===== FITNESS ===== -->
    <section aria-label="Fitness">
      <div class="pill" style="width:fit-content; margin-top:2px;"><b>üèÉ Fitness games</b> (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô /fitness)</div>
      <div class="grid">
        <div class="game" data-href="../fitness/shadow-breaker.html" data-zone="fitness">
          <div class="gameTop">
            <h3 class="gameTitle">üï∂Ô∏è Shadow Breaker</h3>
            <span class="tag">Run</span>
          </div>
          <p class="gameSub">‡∏™‡∏≤‡∏¢ reflex + combo ‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ</p>
        </div>

        <div class="game" data-href="../fitness/rhythm-boxer.html" data-zone="fitness">
          <div class="gameTop">
            <h3 class="gameTitle">ü•ä Rhythm Boxer</h3>
            <span class="tag">Run</span>
          </div>
          <p class="gameSub">‡∏ï‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ ‚Ä¢ ‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î VR/cVR ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ</p>
        </div>

        <div class="game" data-href="../fitness/jump-duck.html" data-zone="fitness">
          <div class="gameTop">
            <h3 class="gameTitle">ü¶ò Jump-Duck</h3>
            <span class="tag">Run</span>
          </div>
          <p class="gameSub">‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î/‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö ‚Ä¢ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÄ‡∏£‡πá‡∏ß ‡∏™‡∏ô‡∏∏‡∏Å‡πÇ‡∏´‡∏î‡πÑ‡∏î‡πâ</p>
        </div>

        <div class="game" data-href="../fitness/balance-hold.html" data-zone="fitness">
          <div class="gameTop">
            <h3 class="gameTitle">üßò Balance Hold</h3>
            <span class="tag">Run</span>
          </div>
          <p class="gameSub">‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß ‚Ä¢ ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á/‡πÄ‡∏ß‡∏•‡∏≤</p>
        </div>

        <div class="game" data-href="./fitness-planner/planner.html" data-zone="fitness">
          <div class="gameTop">
            <h3 class="gameTitle">üó∫Ô∏è Fitness Planner</h3>
            <span class="tag">Tool</span>
          </div>
          <p class="gameSub">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô/‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ</p>
        </div>
      </div>

      <p class="subtitle" style="margin:10px 6px 0;">
        Tip: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Hygiene/Fitness ‚Äú‡∏°‡∏µ Root launcher + Gate‚Äù ‡πÅ‡∏ö‡∏ö Nutrition (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ‡∏ú‡∏°‡∏à‡∏±‡∏î‡πÅ‡∏û‡πá‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      </p>
    </section>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  'use strict';

  // --- params ---
  function pageUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(pageUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  const QS = parseQS();

  // pass-through keys
  const PASS_KEYS = ['pid','run','diff','time','seed','studyId','phase','conditionGroup','log','view','category','wType','wPct','rank','calm'];

  // --- simple auto view detect (only used if target doesn't already have view and current QS doesn't have view) ---
  function detectAutoView(){
    try{
      if (QS.has('view') && String(QS.get('view')||'').trim() !== '') return String(QS.get('view'));
      const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const small = Math.min(window.innerWidth||9999, window.innerHeight||9999) <= 820;
      const ua = navigator.userAgent || '';
      const isMobileUA = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
      if (coarse || small || isMobileUA) return 'mobile';
      return 'pc';
    }catch(_){
      return 'mobile';
    }
  }
  const AUTO_VIEW = detectAutoView();

  function ymdLocal(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function zoneDoneKey(zone){ return `HHA_ZONE_DONE::${zone}::${ymdLocal()}`; }
  function isZoneDoneToday(zone){
    try{ return localStorage.getItem(zoneDoneKey(zone)) === '1'; }catch(_){ return false; }
  }
  function clearZoneToday(zone){
    try{ localStorage.removeItem(zoneDoneKey(zone)); }catch(_){}
  }

  // toast
  const toastEl = document.getElementById('toast');
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1400);
  }

  function setPill(el, done){
    el.classList.remove('ok','bad');
    el.classList.add(done ? 'ok' : 'bad');
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if(el) el.textContent = v;
  }

  function syncBars(){
    const today = ymdLocal();
    setText('todayText', today);

    const nut = isZoneDoneToday('nutrition');
    const hyg = isZoneDoneToday('hygiene');
    const fit = isZoneDoneToday('fitness');

    const pillNut = document.getElementById('pillNutrition');
    const pillHyg = document.getElementById('pillHygiene');
    const pillFit = document.getElementById('pillFitness');

    setPill(pillNut, nut);
    setPill(pillHyg, hyg);
    setPill(pillFit, fit);

    setText('tNutrition', `ü•ó Nutrition: ${nut ? 'DONE TODAY' : 'NOT DONE'}`);
    setText('tHygiene',  `üßº Hygiene: ${hyg ? 'DONE TODAY' : 'NOT DONE'}`);
    setText('tFitness',  `üèÉ Fitness: ${fit ? 'DONE TODAY' : 'NOT DONE'}`);

    setText('cNutGate', nut ? 'DONE TODAY' : 'NEED GATE');
    setText('cHygGate', hyg ? 'DONE TODAY' : 'NEED GATE');
    setText('cFitGate', fit ? 'DONE TODAY' : 'NEED GATE');

    const mNut = document.getElementById('mNut');
    const mHyg = document.getElementById('mHyg');
    const mFit = document.getElementById('mFit');

    mNut.style.width = (nut ? 100 : 35) + '%';
    mHyg.style.width = (hyg ? 100 : 35) + '%';
    mFit.style.width = (fit ? 100 : 35) + '%';

    mNut.classList.toggle('warn', !nut);
    mHyg.classList.toggle('warn', !hyg);
    mFit.classList.toggle('warn', !fit);
  }

  // pass-through helper: attach params to any href
  function applyPassThrough(href){
    const u = new URL(href, location.href);

    // pass params from current hub url
    for (const k of PASS_KEYS){
      if (!u.searchParams.has(k) && QS.has(k)){
        const v = QS.get(k);
        if (v != null && String(v).trim() !== '') u.searchParams.set(k, v);
      }
    }

    // auto add view if missing (and hub doesn't already have view)
    if (!u.searchParams.has('view') || String(u.searchParams.get('view')||'').trim()===''){
      if (!(QS.has('view') && String(QS.get('view')||'').trim() !== '')){
        u.searchParams.set('view', AUTO_VIEW);
      }
    }

    // always give hub param (so games can go back)
    if (!u.searchParams.has('hub') || String(u.searchParams.get('hub')||'').trim()===''){
      u.searchParams.set('hub', location.href);
    }
    return u.toString();
  }

  function renderPills(){
    const pills = [
      ['pid', QS.get('pid')],
      ['run', QS.get('run')],
      ['diff', QS.get('diff')],
      ['time', QS.get('time')],
      ['seed', QS.get('seed')],
      ['studyId', QS.get('studyId')],
      ['phase', QS.get('phase')],
      ['conditionGroup', QS.get('conditionGroup')],
      ['log', QS.get('log')],
      ['view', QS.get('view') || AUTO_VIEW],
    ].filter(x => x[1] != null && String(x[1]).trim() !== '');

    const el = document.getElementById('pillrow');
    el.innerHTML = (pills.length ? pills : [['ctx','none']])
      .slice(0, 12)
      .map(([k,v]) => `<span class="pill"><b>${k}</b>: ${String(v).replace(/</g,'&lt;')}</span>`)
      .join('');
  }

  // click game cards
  function bindGames(){
    const cards = document.querySelectorAll('.game[data-href]');
    cards.forEach(card=>{
      card.addEventListener('click', ()=>{
        const href = card.getAttribute('data-href');
        if(!href) return;
        const url = applyPassThrough(href);
        location.href = url;
      }, { passive:true });
    });
  }

  // reset today button
  function bindReset(){
    const btn = document.getElementById('btnResetToday');
    btn.addEventListener('click', ()=>{
      clearZoneToday('nutrition');
      clearZoneToday('hygiene');
      clearZoneToday('fitness');
      syncBars();
      toast('Reset today ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á 3 ‡πÇ‡∏ã‡∏ô)');
    });

    const btnHow = document.getElementById('btnHow');
    btnHow.addEventListener('click', ()=>{
      toast('Daily Gate: ‡∏ó‡∏≥ Quest Gate ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô (Q1‚ÄìQ3 + Boss + Cooldown) ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÇ‡∏ã‡∏ô');
    });
  }

  // init
  renderPills();
  syncBars();
  bindGames();
  bindReset();

})();
</script>

</body>
</html>