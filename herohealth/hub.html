<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hub (3 Zones)</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1226;
      --panel:rgba(2,6,23,.70);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --cyan:#22d3ee; --violet:#a78bfa;
      --radius:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1000px 600px at 85% 20%, rgba(34,211,238,.12), transparent 55%),
        radial-gradient(900px 520px at 55% 90%, rgba(167,139,250,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: calc(14px + var(--sat)) calc(14px + var(--sar)) calc(14px + var(--sab)) calc(14px + var(--sal));
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:1260px; margin:0 auto; }

    .top{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; padding: 14px 14px 0 14px; }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{ font-size: clamp(22px, 2.2vw, 30px); margin:0; letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size: 14px; line-height:1.4; }

    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    .pill{
      background: rgba(2,6,23,.55);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }
    .pill b{ color:var(--text); font-weight:700; }

    .panel{
      margin-top:14px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .zonebar{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(2,6,23,.35);
    }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      display:flex; gap:8px; align-items:center;
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .tab:active{ transform: translateY(1px); }
    .tab.active{ color: var(--text); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.42);
      padding:10px 12px;
      border-radius: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, opacity .12s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn.secondary{ color: var(--muted); }
    .btn:active{ transform: translateY(1px); }
    .btn.disabled{ opacity:.45; cursor:not-allowed; }
    .btn.small{ padding:9px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .btn.small strong{ color:var(--text); }

    .sep{ width:1px; height:28px; background: rgba(148,163,184,.18); margin:0 2px; }

    .content{
      padding: 14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .content{ grid-template-columns: 1fr; }
      .pillrow{ justify-content:flex-start; }
      .actions{ justify-content:flex-start; }
    }

    .cards{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 560px){ .cards{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.40);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      min-height: 132px;
    }
    .card:hover{ transform: translateY(-1px); background: rgba(255,255,255,.045); border-color: rgba(255,255,255,.18); }
    .card:active{ transform: translateY(1px); }
    .card h3{ margin:0 0 6px 0; font-size:16px; letter-spacing:.2px; }
    .card p{ margin:0; color:var(--muted); font-size: 13px; line-height: 1.45; }
    .tags{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{ border:1px solid var(--stroke); padding:6px 8px; border-radius:999px; color:var(--muted); font-size:12px; background: rgba(2,6,23,.30); }

    .glow{
      position:absolute; inset:-40% -30% auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.35), transparent 60%);
      filter: blur(8px);
      transform: rotate(18deg);
      pointer-events:none;
      opacity:.9;
    }
    .glow.cyan{ background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.32), transparent 60%); }
    .glow.violet{ background: radial-gradient(circle at 30% 30%, rgba(167,139,250,.32), transparent 60%); }

    .side{
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.34);
      border-radius:18px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 220px;
    }
    .side h4{ margin:0; font-size:14px; color: var(--text); }

    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kv .box{ border:1px solid var(--stroke); background: rgba(2,6,23,.30); border-radius:14px; padding:10px; }
    .kv .k{ color:var(--muted); font-size:12px; }
    .kv .v{ margin-top:4px; font-weight:700; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .note{
      border:1px dashed rgba(148,163,184,.28);
      background: rgba(2,6,23,.24);
      border-radius:14px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }

    .footer{
      padding: 12px 14px 16px 14px;
      border-top:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(2,6,23,.25);
    }
    .linklike{ text-decoration: underline; cursor:pointer; color: var(--text); opacity:.9; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 class="title">üè´ HeroHealth ‚Äî Hub</h1>
        <p class="subtitle">3 ‡πÇ‡∏ã‡∏ô: ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‚Ä¢ ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏£‡∏ö + ‡∏Å‡∏•‡∏±‡∏ö Hub ‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠)</p>
      </div>
      <div class="pillrow" id="pillrow"></div>
    </div>

    <div class="panel">
      <div class="zonebar">
        <div class="tabs" id="tabs"></div>

        <div class="actions">
          <div class="btn" id="btnResume">‚ñ∂Ô∏è Resume</div>

          <div class="sep"></div>

          <div class="btn" id="btnPlay">‚ñ∂Ô∏è Play</div>
          <div class="btn" id="btnResearch">üß™ Research</div>

          <div class="sep"></div>

          <div class="btn small" id="btnDiffEasy">diff=<strong>easy</strong></div>
          <div class="btn small" id="btnDiffNormal">diff=<strong>normal</strong></div>
          <div class="btn small" id="btnDiffHard">diff=<strong>hard</strong></div>

          <div class="sep"></div>

          <div class="btn small" id="btnTime60">time=<strong>60</strong></div>
          <div class="btn small" id="btnTime90">time=<strong>90</strong></div>
          <div class="btn small" id="btnTime120">time=<strong>120</strong></div>

          <div class="sep"></div>

          <div class="btn small" id="btnSeedAuto">seed=<strong>auto</strong></div>

          <div class="sep"></div>

          <div class="btn" id="btnPresetResearchA">üß™ Preset-A</div>
          <div class="btn" id="btnPresetResearchB">üß™ Preset-B</div>

          <div class="sep"></div>

          <div class="btn small" id="btnPhaseFollowup">phase=<strong>followup</strong></div>
          <div class="btn small" id="btnCondC">cond=<strong>C</strong></div>
          <div class="btn small" id="btnCondD">cond=<strong>D</strong></div>

          <div class="sep"></div>

          <div class="btn" id="btnNewPid">üÜî New participant</div>
          <div class="btn secondary" id="btnClearPid">üßπ Clear pid</div>

          <div class="sep"></div>

          <div class="btn secondary" id="btnClearRDT">üßπ Clear run/diff/time</div>

          <div class="sep"></div>

          <div class="btn secondary" id="btnCopyLink">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Hub</div>
          <div class="btn secondary" id="btnReset">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏ã‡∏ô</div>
        </div>
      </div>

      <div class="content">
        <div>
          <div class="cards" id="cards"></div>
        </div>
        <aside class="side">
          <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
          <div class="kv" id="kv"></div>
          <div class="note" id="note">
            ‚úÖ ‡πÑ‡∏°‡πà override ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)<br/>
            ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏à‡∏∞ ‚Äú‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ param ‡∏ô‡∏±‡πâ‡∏ô<br/>
            ‚úÖ Preset ‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏ï‡∏¥‡∏°: <b>studyId/phase/conditionGroup/log</b> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á<br/>
            ‚úÖ New participant ‡πÄ‡∏ï‡∏¥‡∏° <b>pid</b> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÑ‡∏°‡πà override)
          </div>
        </aside>
      </div>

      <div class="footer">
        <div>¬© HeroHealth ‚Äî 3 Zones Hub</div>
        <div><span class="linklike" id="btnShowDebug">‡∏î‡∏π Debug</span></div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // ========= CONFIG: 3 ZONES =========
  const ZONES = [
    {
      id: 'nutrition', icon:'ü•ó', name:'‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', color:'green',
      games: [
        { title:'Food Groups VR', icon:'üß©', desc:'‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô', href:'./groups-vr.html', tags:['Launcher@root','PC/Mobile/VR','FX+HUD'] },
        { title:'Balanced Plate VR', icon:'üçΩÔ∏è', desc:'‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏π‡πà', href:'./plate-vr.html', tags:['Launcher@root','5 ‡∏´‡∏°‡∏π‡πà','Quest'] },
        { title:'Hydration Quest VR', icon:'üíß', desc:'‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', href:'./hydration-vr.html', tags:['Launcher@root','Streak','Logging'] },
        { title:'GoodJunkVR', icon:'üçé', desc:'‡πÅ‡∏¢‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ/‡∏Ç‡∏¢‡∏∞ + ‡πÄ‡∏Ñ‡∏ß‡∏™ + ‡∏ö‡∏≠‡∏™', href:'./goodjunk-vr.html', tags:['Launcher@root','Boss','Research'] },
      ]
    },
    {
      id: 'hygiene', icon:'üßº', name:'‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', color:'cyan',
      games: [
        { title:'Handwash VR', icon:'ü´ß', desc:'‡∏ù‡∏∂‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠ + ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ + ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö', href:'./hygiene-vr.html', tags:['Launcher@root','7 Steps','Quiz'] },
        { title:'Brush VR', icon:'ü¶∑', desc:'‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏≤‡∏ö + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ô‡∏µ‡πä‡∏¢‡∏ö', href:'./brush-vr.html', tags:['Launcher@root','Combo','Boss-ready'] },
      ]
    },
    {
      id: 'fitness', icon:'üèÉ', name:'‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', color:'violet',
      games: [
        { title:'Shadow Breaker', icon:'ü•ä', desc:'‡∏ï‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô + ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö + ‡∏ö‡∏≠‡∏™', href:'../fitness/shadow-breaker.html', tags:['Boss','Reflex','VR Ready'] },
        { title:'Jump-Duck', icon:'ü¶ò', desc:'‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î/‡∏Å‡πâ‡∏°‡∏´‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ + ‡∏ö‡∏≠‡∏™ 3 ‡πÄ‡∏ü‡∏™', href:'../fitness/jump-duck.html', tags:['Boss 3 Phases','Agility','Fast'] },
        { title:'Rhythm Boxer', icon:'üéµ', desc:'‡∏ä‡∏Å‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ (lane-based) ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°', href:'../fitness/rhythm-boxer.html', tags:['Rhythm','Timing','cVR'] },
        { title:'Balance Hold', icon:'üßò', desc:'‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≤ + ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∂‡∏î', href:'../fitness/balance-hold.html', tags:['Balance','Stability','Endurance'] },
      ]
    }
  ];

  // ========= STORAGE KEYS =========
  const LS_LAST_ZONE = 'HHA_HUB_LAST_ZONE';
  const LS_LAST_GAME_URL = 'HHA_HUB_LAST_GAME_URL';
  const LS_LAST_GAME_TITLE = 'HHA_HUB_LAST_GAME_TITLE';

  // ========= DOM =========
  const $ = (sel)=>document.querySelector(sel);
  const tabsEl = $('#tabs');
  const cardsEl = $('#cards');
  const kvEl = $('#kv');
  const pillRow = $('#pillrow');
  const state = { zoneId: null, debug:false };

  // ========= URL =========
  function hubUrl(){ return location.href.split('#')[0]; }
  function parseQS(){ try{ return new URL(hubUrl()).searchParams; }catch{ return new URLSearchParams(); } }
  function toObj(sp){ const o={}; for (const [k,v] of sp.entries()) o[k]=v; return o; }
  function safeText(v, fallback='‚Äî'){ const s=(v==null?'':String(v)).trim(); return s?s:fallback; }

  function detectView(){
    const q = parseQS();
    const v = (q.get('view')||'').toLowerCase();
    if (v) return v;
    const ua = navigator.userAgent || '';
    const isMobile = /Android|iPhone|iPad|iPod/i.test(ua) || (Math.min(screen.width, screen.height) <= 480);
    return isMobile ? 'mobile' : 'pc';
  }

  function buildTargetUrl(baseHref){
    const base = new URL(baseHref, location.href);
    const cur = parseQS();
    for (const [k,v] of cur.entries()){
      if (k === 'hub') continue;
      base.searchParams.set(k, v);
    }
    base.searchParams.set('hub', hubUrl());
    return base.toString();
  }

  function setParamIfMissing(key, value){
    const u = new URL(hubUrl());
    const q = u.searchParams;
    if (q.has(key) && String(q.get(key)||'').trim() !== ''){
      return { changed:false, url:u.toString(), current:q.get(key) };
    }
    q.set(key, value);
    return { changed:true, url:u.toString(), current:value };
  }

  function setManyIfMissing(pairs){
    const u = new URL(hubUrl());
    const q = u.searchParams;
    const changedKeys = [];
    for (const [k,v] of Object.entries(pairs)){
      if (q.has(k) && String(q.get(k)||'').trim() !== '') continue;
      q.set(k, String(v));
      changedKeys.push(k);
    }
    return { changed: changedKeys.length>0, url:u.toString(), changedKeys, current: toObj(q) };
  }

  function removeKeys(keys){
    const u = new URL(hubUrl());
    const q = u.searchParams;
    let changed = false;
    keys.forEach(k=>{
      if (q.has(k)){ q.delete(k); changed = true; }
    });
    return { changed, url: u.toString() };
  }

  function normalizeResumeUrl(storedUrl){
    const u = new URL(storedUrl, location.href);
    u.searchParams.set('hub', hubUrl());
    return u.toString();
  }

  // ========= PID generator =========
  function makePid(){
    // short, readable, unique-enough (no deps)
    // example: P-8K2FQ-7D
    const a = Math.random().toString(36).slice(2,7).toUpperCase();
    const b = Math.random().toString(36).slice(2,4).toUpperCase();
    return `P-${a}-${b}`;
  }

  // ========= Presets =========
  const PRESET_A = { run:'research', studyId:'HHA-Study-001', phase:'pre',  conditionGroup:'A', log:'1' };
  const PRESET_B = { run:'research', studyId:'HHA-Study-001', phase:'post', conditionGroup:'B', log:'1' };

  function getPresetLabel(q){
    const o = toObj(q);
    const isA =
      (o.run||'')===PRESET_A.run &&
      (o.studyId||'')===PRESET_A.studyId &&
      (o.phase||'')===PRESET_A.phase &&
      (o.conditionGroup||'')===PRESET_A.conditionGroup &&
      (o.log||'')===PRESET_A.log;

    const isB =
      (o.run||'')===PRESET_B.run &&
      (o.studyId||'')===PRESET_B.studyId &&
      (o.phase||'')===PRESET_B.phase &&
      (o.conditionGroup||'')===PRESET_B.conditionGroup &&
      (o.log||'')===PRESET_B.log;

    if (isA) return 'Preset-A';
    if (isB) return 'Preset-B';
    return '';
  }

  // ========= RENDER =========
  function renderPills(){
    const q = parseQS();
    const presetLabel = getPresetLabel(q);

    const pills = [
      {k:'view', v:detectView()},
      presetLabel ? {k:'preset', v:presetLabel} : null,
      {k:'pid', v:q.get('pid')},
      {k:'run', v:q.get('run')},
      {k:'diff', v:q.get('diff')},
      {k:'time', v:q.get('time')},
      {k:'seed', v:q.get('seed')},
      {k:'studyId', v:q.get('studyId')},
      {k:'phase', v:q.get('phase')},
      {k:'condition', v:q.get('conditionGroup')},
      {k:'log', v:q.get('log')},
    ].filter(Boolean);

    pillRow.innerHTML = pills
      .filter(x => x.v != null && String(x.v).trim() !== '')
      .slice(0, 14)
      .map(x => `<span class="pill"><b>${x.k}</b>: ${String(x.v).replace(/</g,'&lt;')}</span>`)
      .join('') || `<span class="pill"><b>params</b>: none</span>`;
  }

  function renderKV(){
    const q = parseQS();
    const data = [
      ['view', detectView()],
      ['preset', getPresetLabel(q)],
      ['pid', q.get('pid')],
      ['run', q.get('run')],
      ['diff', q.get('diff')],
      ['time', q.get('time')],
      ['seed', q.get('seed')],
      ['studyId', q.get('studyId')],
      ['phase', q.get('phase')],
      ['conditionGroup', q.get('conditionGroup')],
      ['log', q.get('log')],
      ['hub', hubUrl()],
    ];
    kvEl.innerHTML = data.map(([k,v]) => `
      <div class="box">
        <div class="k">${k}</div>
        <div class="v" title="${String(v||'')}">${safeText(v)}</div>
      </div>
    `).join('');
  }

  function renderTabs(){
    tabsEl.innerHTML = '';
    ZONES.forEach(z => {
      const div = document.createElement('div');
      div.className = 'tab' + (z.id === state.zoneId ? ' active' : '');
      div.textContent = `${z.icon} ${z.name}`;
      div.addEventListener('click', ()=> setZone(z.id, true));
      tabsEl.appendChild(div);
    });
  }

  function zoneGlowClass(zone){
    if (!zone) return '';
    if (zone.color === 'cyan') return 'cyan';
    if (zone.color === 'violet') return 'violet';
    return '';
  }

  function updateResumeBtn(){
    const btn = $('#btnResume');
    let lastUrl=null, lastTitle=null;
    try{
      lastUrl = localStorage.getItem(LS_LAST_GAME_URL);
      lastTitle = localStorage.getItem(LS_LAST_GAME_TITLE);
    }catch{}
    if (lastUrl && String(lastUrl).trim()){
      btn.classList.remove('disabled');
      const t = (lastTitle && String(lastTitle).trim()) ? lastTitle : 'last game';
      btn.textContent = `‚ñ∂Ô∏è Resume: ${t}`;
      btn.title = '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
    } else {
      btn.classList.add('disabled');
      btn.textContent = '‚ñ∂Ô∏è Resume';
      btn.title = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
    }
  }

  function renderCards(){
    const zone = ZONES.find(z => z.id === state.zoneId) || ZONES[0];
    cardsEl.innerHTML = '';

    zone.games.forEach(g => {
      const card = document.createElement('div');
      card.className = 'card';
      const glowCls = zoneGlowClass(zone);

      card.innerHTML = `
        <div class="glow ${glowCls}"></div>
        <h3>${g.icon} ${g.title}</h3>
        <p>${g.desc}</p>
        <div class="tags">${(g.tags||[]).slice(0,6).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      `;

      const href = (g.href || '#').trim();
      card.addEventListener('click', ()=>{
        if (!href || href === '#'){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ'); return; }
        const finalUrl = buildTargetUrl(href);
        try{
          localStorage.setItem(LS_LAST_GAME_URL, finalUrl);
          localStorage.setItem(LS_LAST_GAME_TITLE, g.title);
        }catch{}
        updateResumeBtn();
        location.href = finalUrl;
      });

      cardsEl.appendChild(card);
    });
  }

  function setZone(zoneId, save){
    state.zoneId = zoneId;
    if (save){
      try{ localStorage.setItem(LS_LAST_ZONE, zoneId); }catch{}
    }
    renderTabs();
    renderCards();
    renderPills();
    renderKV();
    updateResumeBtn();
  }

  // ========= TOAST =========
  let toastTimer=null;
  function toast(msg){
    clearTimeout(toastTimer);
    let el = document.getElementById('hh-toast');
    if (!el){
      el = document.createElement('div');
      el.id = 'hh-toast';
      el.style.position='fixed';
      el.style.left='50%';
      el.style.bottom='18px';
      el.style.transform='translateX(-50%)';
      el.style.background='rgba(2,6,23,.85)';
      el.style.border='1px solid rgba(148,163,184,.22)';
      el.style.color='var(--text)';
      el.style.padding='10px 12px';
      el.style.borderRadius='14px';
      el.style.boxShadow='0 12px 40px rgba(0,0,0,.35)';
      el.style.backdropFilter='blur(8px)';
      el.style.zIndex='9999';
      el.style.maxWidth='92vw';
      el.style.fontSize='13px';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity='1';
    toastTimer = setTimeout(()=>{ el.style.opacity='0'; }, 1700);
  }

  // ========= BUTTONS =========
  $('#btnCopyLink').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(hubUrl()); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå Hub ‡πÅ‡∏•‡πâ‡∏ß'); }
    catch{ toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
  });

  $('#btnReset').addEventListener('click', ()=>{
    try{ localStorage.removeItem(LS_LAST_ZONE); }catch{}
    setZone(ZONES[0].id, false);
    toast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏ã‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
  });

  $('#btnShowDebug').addEventListener('click', ()=>{
    state.debug = !state.debug;
    const obj = toObj(parseQS());
    if (state.debug) alert('DEBUG ‚Äî params:\n\n' + JSON.stringify(obj, null, 2));
    else toast('‡∏õ‡∏¥‡∏î Debug ‡πÅ‡∏•‡πâ‡∏ß');
  });

  $('#btnResume').addEventListener('click', ()=>{
    const btn = $('#btnResume');
    if (btn.classList.contains('disabled')){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Äî ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô'); return; }
    let lastUrl=null;
    try{ lastUrl = localStorage.getItem(LS_LAST_GAME_URL); }catch{}
    if (!lastUrl){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'); updateResumeBtn(); return; }
    location.href = normalizeResumeUrl(lastUrl);
  });

  function bindSetIfMissing(btnId, key, value){
    const el = $(btnId);
    el.addEventListener('click', ()=>{
      const res = setParamIfMissing(key, value);
      if (!res.changed){ toast(`‡∏°‡∏µ ${key} ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${res.current} (‡πÑ‡∏°‡πà override)`); return; }
      location.href = res.url;
    });
  }

  // run=
  bindSetIfMissing('#btnPlay', 'run', 'play');
  bindSetIfMissing('#btnResearch', 'run', 'research');

  // diff=
  bindSetIfMissing('#btnDiffEasy', 'diff', 'easy');
  bindSetIfMissing('#btnDiffNormal', 'diff', 'normal');
  bindSetIfMissing('#btnDiffHard', 'diff', 'hard');

  // time=
  bindSetIfMissing('#btnTime60', 'time', '60');
  bindSetIfMissing('#btnTime90', 'time', '90');
  bindSetIfMissing('#btnTime120', 'time', '120');

  // seed auto
  $('#btnSeedAuto').addEventListener('click', ()=>{
    const res = setParamIfMissing('seed', String(Date.now()));
    if (!res.changed){ toast(`‡∏°‡∏µ seed ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${res.current} (‡πÑ‡∏°‡πà override)`); return; }
    location.href = res.url;
  });

  // preset apply (fill only missing)
  function applyPreset(preset){
    const res = setManyIfMissing(preset);
    if (!res.changed){ toast('Preset: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà override)'); return; }
    toast('Preset ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß: ' + res.changedKeys.join(', '));
    location.href = res.url;
  }
  $('#btnPresetResearchA').addEventListener('click', ()=> applyPreset(PRESET_A));
  $('#btnPresetResearchB').addEventListener('click', ()=> applyPreset(PRESET_B));

  // phase followup
  bindSetIfMissing('#btnPhaseFollowup', 'phase', 'followup');

  // condition C/D
  bindSetIfMissing('#btnCondC', 'conditionGroup', 'C');
  bindSetIfMissing('#btnCondD', 'conditionGroup', 'D');

  // New participant (pid) only if missing
  $('#btnNewPid').addEventListener('click', ()=>{
    const pid = makePid();
    const res = setParamIfMissing('pid', pid);
    if (!res.changed){
      toast(`‡∏°‡∏µ pid ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${res.current} (‡πÑ‡∏°‡πà override) ‚Äî ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏î Clear pid ‡∏Å‡πà‡∏≠‡∏ô`);
      return;
    }
    toast('‡∏™‡∏£‡πâ‡∏≤‡∏á participant: ' + pid);
    location.href = res.url;
  });

  // Clear pid only
  $('#btnClearPid').addEventListener('click', ()=>{
    const res = removeKeys(['pid']);
    if (!res.changed){ toast('‡πÑ‡∏°‡πà‡∏°‡∏µ pid ‡πÉ‡∏´‡πâ‡∏•‡∏ö'); return; }
    location.href = res.url;
  });

  // Clear only run/diff/time
  $('#btnClearRDT').addEventListener('click', ()=>{
    const res = removeKeys(['run','diff','time']);
    if (!res.changed){ toast('‡πÑ‡∏°‡πà‡∏°‡∏µ run/diff/time ‡πÉ‡∏´‡πâ‡∏•‡∏ö'); return; }
    location.href = res.url;
  });

  // ========= INIT =========
  function init(){
    let last=null;
    try{ last = localStorage.getItem(LS_LAST_ZONE); }catch{}
    const zoneId = ZONES.some(z=>z.id===last) ? last : ZONES[0].id;
    renderTabs();
    setZone(zoneId, false);
    updateResumeBtn();
  }
  init();

})();
</script>
</body>
</html>