<!-- === /herohealth/hub.html ===
HeroHealth ‚Äî Hub (3 Zones) ‚Äî PRODUCTION (403-safe + Offline fallback)
‚úÖ No forced ordering: play any game anytime
‚úÖ Safe network: API 401/403 won't break hub
‚úÖ Shows offline banner + retry + reset today
‚úÖ Links to ROOT launchers in /herohealth (root)
‚úÖ Pass-through hub/run/diff/time/seed/studyId/phase/conditionGroup/log/view/pid/api
PATCH v20260215c
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hub</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="./favicon.ico" />

  <style>
    :root{
      --bg:#020617;
      --panel: rgba(2,6,23,.72);
      --panel2: rgba(15,23,42,.55);
      --stroke: rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{min-height:100%;padding:calc(16px + var(--sat)) calc(14px + var(--sar)) calc(18px + var(--sab)) calc(14px + var(--sal));max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(34,211,238,.25), rgba(167,139,250,.18));border:1px solid var(--stroke);display:grid;place-items:center;font-weight:1000}
    .title{font-weight:1000;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;font-weight:800;margin-top:2px}
    .chiprow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--stroke);background:rgba(2,6,23,.35);border-radius:999px;padding:7px 10px;font-size:12px;font-weight:900;color:rgba(229,231,235,.92)}
    .chip b{color:#fff}

    .grid{margin-top:14px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width: 860px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width: 560px){ .grid{grid-template-columns:1fr;} }

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(2,6,23,.55));border-radius:20px;padding:14px;box-shadow:0 14px 50px rgba(0,0,0,.35)}
    .card h3{margin:0;font-size:14px;font-weight:1000}
    .card p{margin:6px 0 0 0;color:rgba(229,231,235,.78);font-weight:750;font-size:12px;line-height:1.35}
    .btnrow{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(2,6,23,.35);font-weight:1000;font-size:13px}
    .btn.primary{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.16)}
    .btn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.14)}
    .small{font-size:12px;color:var(--muted);font-weight:850;margin-top:10px}

    .banner{margin-top:14px;border:1px solid var(--stroke);border-radius:18px;padding:12px 12px;background:rgba(2,6,23,.35);display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:999px;margin-top:5px}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .banner h4{margin:0;font-size:13px;font-weight:1000}
    .banner p{margin:4px 0 0 0;font-size:12px;color:rgba(229,231,235,.78);font-weight:750;line-height:1.35}
    .banner .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">HH</div>
        <div>
          <div class="title">HeroHealth ‚Äî Hub</div>
          <div class="sub">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏° ‚Ä¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏°‡πâ API ‡∏ï‡∏≠‡∏ö 401/403</div>
        </div>
      </div>

      <div class="chiprow" id="chipRow">
        <div class="chip">run: <b id="cRun">play</b></div>
        <div class="chip">diff: <b id="cDiff">normal</b></div>
        <div class="chip">time: <b id="cTime">80</b>s</div>
        <div class="chip">pid: <b id="cPid">anon</b></div>
      </div>
    </header>

    <!-- API status banner -->
    <div class="banner" id="apiBanner" aria-live="polite">
      <div class="dot warn" id="apiDot"></div>
      <div>
        <h4 id="apiTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</h4>
        <p id="apiMsg">‡∏ñ‡πâ‡∏≤ API ‡∏•‡πà‡∏°/401/403 ‡∏´‡∏ô‡πâ‡∏≤ HUB ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°)</p>
      </div>
      <div class="actions">
        <a class="btn warn" href="#" id="btnRetry">Retry</a>
        <a class="btn" href="#" id="btnResetToday">Reset today</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ü•ó Nutrition Zone</h3>
        <p>GoodJunk ‚Ä¢ Food Groups ‚Ä¢ Hydration ‚Ä¢ Balanced Plate</p>
        <div class="btnrow">
          <a class="btn primary" id="goGoodJunk" href="./goodjunk-vr-launcher.html">GoodJunkVR</a>
          <a class="btn" id="goGroups" href="./groups-vr.html">GroupsVR</a>
          <a class="btn" id="goHydration" href="./hydration-vr.html">HydrationVR</a>
          <a class="btn" id="goPlate" href="./plate-vr.html">PlateVR</a>
        </div>
        <div class="small">* ‡∏™‡πà‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå run/diff/time/seed/pid/hub/api ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <div class="card">
        <h3>üßº Hygiene Zone</h3>
        <p><b>Handwash</b> ‚Ä¢ Brush ‚Ä¢ Mask & Cough</p>
        <div class="btnrow">
          <a class="btn primary" id="goHandwash" href="./hygiene-vr.html">Handwash</a>
          <a class="btn" id="goMaskCough" href="./maskcough-vr.html">MaskCough</a>
        </div>
        <div class="small">* ‡∏ú‡πà‡∏≤‡∏ô root launcher ‚Ä¢ HUB/‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ API ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</div>
      </div>

      <div class="card">
        <h3>üèÉ Fitness Zone</h3>
        <p>Planner ‚Ä¢ Shadow Breaker ‚Ä¢ Rhythm Boxer ‚Ä¢ Jump-Duck ‚Ä¢ Balance Hold</p>
        <div class="btnrow">
          <a class="btn primary" id="goPlanner" href="./fitness-planner/planner.html">Fitness Planner</a>
          <a class="btn" id="goShadow" href="../fitness/shadow-breaker.html">Shadow Breaker</a>
          <a class="btn" id="goRhythm" href="../fitness/rhythm-boxer.html">Rhythm Boxer</a>
        </div>
        <div class="small">* ‡∏•‡∏¥‡∏á‡∏Å‡πå fitness ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏° (../fitness/‚Ä¶)</div>
      </div>
    </div>
  </div>

  <!-- ===== Defaults (tune here only) ===== -->
  <script>
  // Central defaults for API modules
  // ‚úÖ IMPORTANT: make healthPath a PUBLIC GET endpoint (no auth) if you want banner "Online" for anonymous users.
  window.__HHA_API_DEFAULTS__ = {
    // Probe
    healthPath: '/prod/health',
    probeTimeoutMs: 3500,
    authIsExpected: true,

    // Safe GraphQL client
    graphqlPath: '/prod/graphql',
    timeoutMs: 6000,
    disableOnAuth: false,

    // Optional headers (ONLY if safe to expose publicly)
    // extraHeaders: { 'x-api-key': '...' }
  };
  </script>

  <!-- ===== Hub boot (inline module) ===== -->
  <script type="module">
    'use strict';

    import { bootHubApi } from './api/hub-api-boot.js';
    import { retryGuard } from './api/hub-api-guard.js';

    const WIN = window;
    const DOC = document;

    function $(id){ return DOC.getElementById(id); }

    function parseQS(){
      const u = new URL(WIN.location.href);
      const p = u.searchParams;

      // defaults
      const nowSeed = Date.now();
      const run  = p.get('run')  || 'play';
      const diff = p.get('diff') || 'normal';
      const time = p.get('time') || '80';
      const seed = p.get('seed') || String(nowSeed);
      const pid  = p.get('pid')  || 'anon';

      // optional research params passthrough
      const studyId = p.get('studyId') || '';
      const phase = p.get('phase') || '';
      const conditionGroup = p.get('conditionGroup') || '';
      const log = p.get('log') || '';
      const view = p.get('view') || '';
      const api = p.get('api') || '';

      return { run, diff, time, seed, pid, studyId, phase, conditionGroup, log, view, api };
    }

    function setChips(q){
      if($('cRun')) $('cRun').textContent = q.run;
      if($('cDiff')) $('cDiff').textContent = q.diff;
      if($('cTime')) $('cTime').textContent = q.time;
      if($('cPid')) $('cPid').textContent = q.pid;
    }

    function buildPassParams(q){
      // Always include hub=... so games can offer Back to HUB reliably
      const hubUrl = WIN.location.origin + WIN.location.pathname + WIN.location.search;

      const sp = new URLSearchParams();
      sp.set('hub', hubUrl);
      sp.set('run', q.run);
      sp.set('diff', q.diff);
      sp.set('time', q.time);
      sp.set('seed', q.seed);
      sp.set('pid', q.pid);

      if(q.studyId) sp.set('studyId', q.studyId);
      if(q.phase) sp.set('phase', q.phase);
      if(q.conditionGroup) sp.set('conditionGroup', q.conditionGroup);
      if(q.log) sp.set('log', q.log);
      if(q.view) sp.set('view', q.view);
      if(q.api) sp.set('api', q.api);

      return sp;
    }

    function applyPassThrough(q){
      const sp = buildPassParams(q);
      const ids = [
        'goGoodJunk','goGroups','goHydration','goPlate',
        'goHandwash','goMaskCough',
        'goPlanner','goShadow','goRhythm'
      ];

      for(const id of ids){
        const a = $(id);
        if(!a) continue;
        try{
          const href = a.getAttribute('href') || '';
          // Keep relative links but append query
          const url = new URL(href, WIN.location.href);
          // merge (do not overwrite existing fixed params unless we want)
          for(const [k,v] of sp.entries()){
            url.searchParams.set(k,v);
          }
          a.setAttribute('href', url.toString());
        }catch{}
      }
    }

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `HHA_DAY_${y}-${m}-${da}`;
    }

    function wireButtons(q){
      const btnRetry = $('btnRetry');
      const btnReset = $('btnResetToday');

      if(btnRetry){
        btnRetry.addEventListener('click', async (e)=>{
          e.preventDefault();
          try{
            await retryGuard({ uri: q.api });
            // also re-expose client/status
            await bootHubApi({ uri: q.api });
          }catch{}
        });
      }

      if(btnReset){
        btnReset.addEventListener('click', (e)=>{
          e.preventDefault();
          try{
            localStorage.removeItem(todayKey());
            localStorage.removeItem('HHA_LAST_SUMMARY');
            // optional: clear history
            // localStorage.removeItem('HHA_SUMMARY_HISTORY');
            // little feedback without extra UI:
            btnReset.textContent = 'Reset ‚úì';
            setTimeout(()=>{ btnReset.textContent = 'Reset today'; }, 900);
          }catch{}
        });
      }
    }

    async function main(){
      const q = parseQS();
      setChips(q);
      applyPassThrough(q);
      wireButtons(q);

      // Boot API banner + safe client exposure
      // (If q.api missing => offline banner via guard)
      await bootHubApi({ uri: q.api });
    }

    main().catch(()=>{ /* never break hub */ });
  </script>
</body>
</html>
