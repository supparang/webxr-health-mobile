<!-- === /herohealth/hub.html ===
HeroHealth HUB (PRODUCTION) ‚Äî Profile Bridge + Last Summary Card Patch
‚úÖ Save profile to localStorage/sessionStorage (hha_profile)
‚úÖ Launch games with appended query params (fallback if storage blocked)
‚úÖ Standard research context keys + student profile keys
‚úÖ NEW: Auto show last game summary from localStorage (HHA_LAST_SUMMARY)
‚úÖ NEW: Quick relaunch last game (same mode/diff/time if present)
‚úÖ FIX: Map runMode "study" -> "research" (compat)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî HUB</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.62);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    html,body{
      margin:0; padding:0; width:100%; height:100%;
      background: radial-gradient(1200px 700px at 50% 25%, #0b1120 0%, #020617 60%, #020617 100%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 12px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    header h1{ margin:0; font-size: 16px; letter-spacing:.2px; }
    header .sub{ font-size: 12px; color: var(--muted); font-weight: 850; }
    .row{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; margin-top: 14px; }
    @media (max-width: 980px){ .row{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      padding: 12px;
    }
    .card h2{ margin: 2px 0 10px; font-size: 14px; letter-spacing:.2px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 560px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); font-weight: 850; margin: 0 0 6px; }
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
      font-weight: 900;
      letter-spacing:.2px;
    }
    textarea{ min-height: 72px; resize: vertical; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(34,197,94,.18);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn.secondary{ background: rgba(2,6,23,.55); }
    .btn.danger{ background: rgba(239,68,68,.18); }
    .btn:active{ transform: translateY(1px); }

    .hint{ font-size: 12px; color: var(--muted); font-weight: 850; line-height: 1.45; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.2px;
      color: var(--text);
      margin-left: 10px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight: 900; }
    .games{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 700px){ .games{ grid-template-columns: 1fr; } }
    .game{
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      padding: 12px;
    }
    .game h3{ margin:0 0 8px; font-size: 14px; letter-spacing:.2px; }
    .game .meta{ font-size: 12px; color: var(--muted); font-weight: 850; margin-bottom: 10px; }
    .game .inline{ display:flex; gap:10px; flex-wrap:wrap; }
    .game .inline > div{ flex: 1; min-width: 120px; }
    footer{ margin-top: 14px; padding: 10px 12px; font-size: 12px; color: var(--muted); font-weight: 850; }

    /* ===== Summary card ===== */
    #lastSummaryCard{ display:none; background: var(--panel2); }
    .sumTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      font-weight:1000; font-size:12px;
    }
    .badge.ok{ border-color: rgba(34,197,94,.35); }
    .badge.warn{ border-color: rgba(245,158,11,.35); }
    .badge.danger{ border-color: rgba(239,68,68,.35); }
    .sumGrid{
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .sumCell{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: 0 18px 44px rgba(0,0,0,.25);
    }
    .sumCell .k{ display:block; color: var(--muted); font-weight: 900; font-size: 11px; margin-bottom:4px; }
    .sumCell .v{ font-weight: 1100; font-size: 15px; }
    .sumRow3{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; margin-top:10px; }
    @media (max-width: 520px){
      .sumGrid{ grid-template-columns: 1fr; }
      .sumRow3{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üè† HeroHealth HUB</h1>
        <div class="sub">Profile Bridge Patch ‚Ä¢ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÜ (Storage + Query)</div>
      </div>
      <div>
        <span class="pill">Session: <span id="sessionKey" class="mono">‚Äî</span></span>
      </div>
    </header>

    <div class="row">
      <!-- LEFT: Profile -->
      <section class="card">
        <h2>üßæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏à‡∏±‡∏¢ + ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>

        <div class="grid">
          <div><label>projectTag</label><input id="projectTag" placeholder="HeroHealth" /></div>
          <div><label>studyId</label><input id="studyId" placeholder="‡πÄ‡∏ä‡πà‡∏ô HHA-CRU-2026-01" /></div>
          <div><label>phase</label><input id="phase" placeholder="‡πÄ‡∏ä‡πà‡∏ô pre / post / followup" /></div>

          <div><label>conditionGroup</label><input id="conditionGroup" placeholder="‡πÄ‡∏ä‡πà‡∏ô A / B / C" /></div>
          <div><label>sessionOrder</label><input id="sessionOrder" type="number" min="0" step="1" placeholder="1" /></div>
          <div><label>blockLabel</label><input id="blockLabel" placeholder="‡πÄ‡∏ä‡πà‡∏ô Block-1" /></div>

          <div><label>siteCode</label><input id="siteCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô CRU" /></div>
          <div><label>schoolCode</label><input id="schoolCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô SCH-001" /></div>
          <div><label>schoolName</label><input id="schoolName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" /></div>

          <div><label>classRoom</label><input id="classRoom" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.5/1" /></div>
          <div><label>studentNo</label><input id="studentNo" type="number" min="0" step="1" placeholder="1" /></div>
          <div><label>nickName</label><input id="nickName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" /></div>

          <div>
            <label>gender</label>
            <select id="gender">
              <option value="">‚Äî</option>
              <option value="female">female</option>
              <option value="male">male</option>
              <option value="other">other</option>
            </select>
          </div>
          <div><label>age</label><input id="age" type="number" min="0" step="1" placeholder="10" /></div>
          <div><label>gradeLevel</label><input id="gradeLevel" type="number" min="0" step="1" placeholder="5" /></div>

          <div><label>heightCm</label><input id="heightCm" type="number" min="0" step="0.1" placeholder="140" /></div>
          <div><label>weightKg</label><input id="weightKg" type="number" min="0" step="0.1" placeholder="35" /></div>
          <div>
            <label>handedness</label>
            <select id="handedness">
              <option value="">‚Äî</option>
              <option value="right">right</option>
              <option value="left">left</option>
              <option value="both">both</option>
            </select>
          </div>

          <div>
            <label>vrExperience</label>
            <select id="vrExperience">
              <option value="">‚Äî</option>
              <option value="never">never</option>
              <option value="sometimes">sometimes</option>
              <option value="often">often</option>
            </select>
          </div>
          <div>
            <label>gameFrequency</label>
            <select id="gameFrequency">
              <option value="">‚Äî</option>
              <option value="rare">rare</option>
              <option value="weekly">weekly</option>
              <option value="daily">daily</option>
            </select>
          </div>
          <div>
            <label>consentParent</label>
            <select id="consentParent">
              <option value="">‚Äî</option>
              <option value="yes">yes</option>
              <option value="no">no</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>healthDetail (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <textarea id="healthDetail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏™‡∏±‡πâ‡∏ô / ‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ / ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß"></textarea>
        </div>

        <div class="btns">
          <button class="btn" id="btnSave" type="button">üíæ SAVE PROFILE</button>
          <button class="btn secondary" id="btnLoad" type="button">üì• LOAD SAVED</button>
          <button class="btn danger" id="btnClear" type="button">üßπ CLEAR</button>
        </div>

        <div class="hint" style="margin-top:10px">
          ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á <span class="mono">localStorage/sessionStorage</span> ‡∏Ñ‡∏µ‡∏¢‡πå <span class="mono">hha_profile</span><br/>
          ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° ‡∏à‡∏∞ ‚Äú‡πÅ‡∏ô‡∏ö query‚Äù ‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ logger ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÅ‡∏°‡πâ storage ‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å
        </div>
      </section>

      <!-- RIGHT: Launch -->
      <section class="card">
        <h2>üöÄ Launch ‡πÄ‡∏Å‡∏°</h2>

        <div class="hint" style="margin-bottom:10px">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr 1fr;">
          <div>
            <label>run</label>
            <select id="runMode">
              <option value="play">play</option>
              <option value="research">study</option>
            </select>
          </div>
          <div>
            <label>diff</label>
            <select id="diff">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </div>
          <div>
            <label>time (sec)</label>
            <input id="time" type="number" min="20" max="180" step="1" value="70" />
          </div>
        </div>

        <div class="games" style="margin-top:12px">
          <div class="game">
            <h3>ü•¶üçü GoodJunkVR</h3>
            <div class="meta">‡∏°‡∏µ Boss / Ring / Laser / Storm + Quest/Rank (SSS..C)</div>
            <div class="inline">
              <div>
                <label>challenge</label>
                <select id="gjChallenge">
                  <option value="rush" selected>rush</option>
                  <option value="survival">survival</option>
                  <option value="boss">boss</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn" id="btnGJ" type="button" style="width:100%">üöÄ START</button>
              </div>
            </div>
          </div>

          <div class="game">
            <h3>üíß HydrationVR</h3>
            <div class="meta">‡∏ô‡πâ‡∏≥‡∏™‡∏°‡∏î‡∏∏‡∏• + Fever/Shield + Quest chain</div>
            <div class="inline">
              <div>
                <label>mode</label>
                <select id="hyMode">
                  <option value="play" selected>play</option>
                  <option value="research">study</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn" id="btnHY" type="button" style="width:100%">üöÄ START</button>
              </div>
            </div>
          </div>

          <div class="game">
            <h3>üçΩÔ∏è PlateVR</h3>
            <div class="meta">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏• + Mini ‚ÄúPlate Rush‚Äù + Clamp Safe Zone</div>
            <div class="inline">
              <div>
                <label>mode</label>
                <select id="plMode">
                  <option value="play" selected>play</option>
                  <option value="research">study</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn" id="btnPL" type="button" style="width:100%">üöÄ START</button>
              </div>
            </div>
          </div>

          <div class="game">
            <h3>ü•ó GroupsVR</h3>
            <div class="meta">‡πÄ‡∏Å‡∏° 5 ‡∏´‡∏°‡∏π‡πà + Goal/Mini + Coach</div>
            <div class="inline">
              <div>
                <label>mode</label>
                <select id="grMode">
                  <option value="play" selected>play</option>
                  <option value="research">study</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn" id="btnGR" type="button" style="width:100%">üöÄ START</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ‚úÖ NEW: Last Summary -->
        <div class="card" id="lastSummaryCard" style="margin-top:12px;">
          <div class="sumTop">
            <div>
              <h2 style="margin:2px 0 4px">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Auto)</h2>
              <div class="hint" id="lastSummaryHint">‚Äî</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <span class="badge ok" id="badgeGame">Game: ‚Äî</span>
              <span class="badge" id="badgeGrade">Grade: ‚Äî</span>
            </div>
          </div>

          <div class="sumGrid">
            <div class="sumCell"><span class="k">Score</span><span class="v mono" id="sumScore">‚Äî</span></div>
            <div class="sumCell"><span class="k">Max Combo</span><span class="v mono" id="sumMaxCombo">‚Äî</span></div>
            <div class="sumCell"><span class="k">Miss</span><span class="v mono" id="sumMiss">‚Äî</span></div>
            <div class="sumCell"><span class="k">Perfect</span><span class="v mono" id="sumPerfect">‚Äî</span></div>
            <div class="sumCell"><span class="k">Goals</span><span class="v mono" id="sumGoals">‚Äî</span></div>
            <div class="sumCell"><span class="k">Minis</span><span class="v mono" id="sumMinis">‚Äî</span></div>
          </div>

          <div class="sumRow3">
            <div class="sumCell"><span class="k">G1</span><span class="v mono" id="sumG1">‚Äî</span></div>
            <div class="sumCell"><span class="k">G2</span><span class="v mono" id="sumG2">‚Äî</span></div>
            <div class="sumCell"><span class="k">G3</span><span class="v mono" id="sumG3">‚Äî</span></div>
            <div class="sumCell"><span class="k">G4</span><span class="v mono" id="sumG4">‚Äî</span></div>
            <div class="sumCell"><span class="k">G5</span><span class="v mono" id="sumG5">‚Äî</span></div>
            <div class="sumCell"><span class="k">Total</span><span class="v mono" id="sumGTotal">‚Äî</span></div>
          </div>

          <div class="btns" style="margin-top:10px">
            <button class="btn" id="btnReplayLast" type="button">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            <button class="btn secondary" id="btnCopyLast" type="button">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°</button>
            <button class="btn danger" id="btnClearLast" type="button">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px; background: var(--panel2);">
          <h2 style="margin:2px 0 8px">üîó Debug Link (auto)</h2>
          <div class="hint">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‚Äú‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL‚Äù ‡∏ó‡∏µ‡πà hub ‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö profile ‡πÄ‡∏õ‡πá‡∏ô query</div>
          <div class="hint mono" id="debugUrl" style="margin-top:8px; word-break:break-all;"></div>
        </div>
      </section>
    </div>

    <footer>
      Tip: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ logger Google Sheet ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Å‡∏°‡∏à‡∏∞ emit <span class="mono">hha:log_profile</span> / <span class="mono">hha:log_session</span> / <span class="mono">hha:log_event</span> ‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏á
    </footer>
  </div>

  <script>
    'use strict';

    // ====== CONFIG: ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ======
    const GAMES = {
      goodjunk: './goodjunk-vr.html',
      hydration:'./hydration-vr.html',
      plate:    './plate-vr.html',
      groups:   './groups-vr.html'
    };

    const QS_KEYS = [
      'timestampIso','projectTag','runMode','studyId','phase','conditionGroup','sessionOrder','blockLabel',
      'siteCode','schoolYear','semester','sessionId','gameMode','diff','durationPlannedSec',
      'studentKey','schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel',
      'heightCm','weightKg','bmi','bmiGroup','vrExperience','gameFrequency','handedness','visionIssue','healthDetail',
      'consentParent'
    ];

    const $ = (id)=> document.getElementById(id);

    const elSessionKey = $('sessionKey');
    const elDebugUrl = $('debugUrl');

    const qs = new URLSearchParams(location.search);

    function uid8(){ return Math.random().toString(16).slice(2,10); }
    function safeJsonParse(s){ try{ return JSON.parse(s); }catch(_){ return null; } }
    function clamp(n,a,b){ n = Number(n); if(!Number.isFinite(n)) return a; return Math.max(a, Math.min(b,n)); }

    function readStoredProfile(){
      const a = safeJsonParse(localStorage.getItem('hha_profile') || '');
      const b = safeJsonParse(localStorage.getItem('HHA_PROFILE') || '');
      const c = safeJsonParse(sessionStorage.getItem('hha_profile') || '');
      const d = safeJsonParse(sessionStorage.getItem('HHA_PROFILE') || '');
      return (a && typeof a==='object') ? a :
             (b && typeof b==='object') ? b :
             (c && typeof c==='object') ? c :
             (d && typeof d==='object') ? d : null;
    }

    function writeStoredProfile(obj){
      try{
        const s = JSON.stringify(obj || {});
        sessionStorage.setItem('hha_profile', s);
        localStorage.setItem('hha_profile', s);
      }catch(_){}
    }

    function pickQSProfile(){
      const p = {};
      for (const k of QS_KEYS){
        if (!qs.has(k)) continue;
        const v = qs.get(k);
        if (v === null || v === '') continue;
        p[k] = v;
      }
      // numeric normalize
      const nums = ['sessionOrder','schoolYear','semester','studentNo','age','gradeLevel','heightCm','weightKg','bmi','durationPlannedSec'];
      for (const nk of nums){
        if (p[nk] != null){
          const n = Number(p[nk]);
          if (Number.isFinite(n)) p[nk] = n;
        }
      }
      return p;
    }

    function getVal(id){
      const el = $(id);
      if (!el) return '';
      return (el.value ?? '').toString().trim();
    }

    function setVal(id, v){
      const el = $(id);
      if (!el) return;
      el.value = (v ?? '').toString();
    }

    function computeBMI(heightCm, weightKg){
      const h = Number(heightCm);
      const w = Number(weightKg);
      if (!Number.isFinite(h) || !Number.isFinite(w) || h <= 0 || w <= 0) return '';
      const m = h / 100;
      const bmi = w / (m*m);
      return Math.round(bmi * 10) / 10;
    }

    function normalizeRunMode(v){
      v = (v ?? '').toString().trim().toLowerCase();
      // compat: hub ‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ä‡πâ "study"
      if (v === 'study') return 'research';
      if (v === 'research' || v === 'play') return v;
      return 'play';
    }

    function buildProfileFromForm(){
      const p = {};
      // research context
      p.timestampIso = new Date().toISOString();
      p.projectTag = getVal('projectTag') || 'HeroHealth';
      p.studyId = getVal('studyId');
      p.phase = getVal('phase');
      p.conditionGroup = getVal('conditionGroup');
      p.sessionOrder = Number(getVal('sessionOrder') || 0) || 0;
      p.blockLabel = getVal('blockLabel');
      p.siteCode = getVal('siteCode');

      // school + student
      p.schoolCode = getVal('schoolCode');
      p.schoolName = getVal('schoolName');
      p.classRoom = getVal('classRoom');
      p.studentNo = Number(getVal('studentNo') || 0) || 0;
      p.nickName = getVal('nickName');
      p.gender = getVal('gender');
      p.age = Number(getVal('age') || 0) || 0;
      p.gradeLevel = Number(getVal('gradeLevel') || 0) || 0;

      p.heightCm = Number(getVal('heightCm') || 0) || '';
      p.weightKg = Number(getVal('weightKg') || 0) || '';
      const bmi = computeBMI(p.heightCm, p.weightKg);
      if (bmi !== '') p.bmi = bmi;

      p.handedness = getVal('handedness');
      p.vrExperience = getVal('vrExperience');
      p.gameFrequency = getVal('gameFrequency');
      p.consentParent = getVal('consentParent');
      p.healthDetail = getVal('healthDetail');

      // derive stable studentKey
      const sc = (p.schoolCode || 'SCH').replace(/\s+/g,'');
      const sn = String(p.studentNo || '0').padStart(3,'0');
      const gl = String(p.gradeLevel || '0');
      p.studentKey = `${sc}-G${gl}-${sn}`;

      // sessionId at hub level (shared across games in same ‚Äúlaunch set‚Äù)
      p.sessionId = (readStoredProfile()?.sessionId) || `${Date.now()}-${uid8()}`;

      return p;
    }

    function mergeProfile(base, patch){
      if (!patch || typeof patch !== 'object') return base;
      for (const k of Object.keys(patch)){
        const v = patch[k];
        if (v === undefined || v === null || v === '') continue;
        base[k] = v;
      }
      return base;
    }

    function fillForm(profile){
      if (!profile) return;
      setVal('projectTag', profile.projectTag || 'HeroHealth');
      setVal('studyId', profile.studyId || '');
      setVal('phase', profile.phase || '');
      setVal('conditionGroup', profile.conditionGroup || '');
      setVal('sessionOrder', profile.sessionOrder ?? '');
      setVal('blockLabel', profile.blockLabel || '');
      setVal('siteCode', profile.siteCode || '');

      setVal('schoolCode', profile.schoolCode || '');
      setVal('schoolName', profile.schoolName || '');
      setVal('classRoom', profile.classRoom || '');
      setVal('studentNo', profile.studentNo ?? '');
      setVal('nickName', profile.nickName || '');

      setVal('gender', profile.gender || '');
      setVal('age', profile.age ?? '');
      setVal('gradeLevel', profile.gradeLevel ?? '');

      setVal('heightCm', profile.heightCm ?? '');
      setVal('weightKg', profile.weightKg ?? '');

      setVal('handedness', profile.handedness || '');
      setVal('vrExperience', profile.vrExperience || '');
      setVal('gameFrequency', profile.gameFrequency || '');
      setVal('consentParent', profile.consentParent || '');
      setVal('healthDetail', profile.healthDetail || '');
    }

    function collectProfile(){
      const stored = readStoredProfile();
      const fromQS = pickQSProfile();
      const fromForm = buildProfileFromForm();
      const p = {};
      mergeProfile(p, stored);
      mergeProfile(p, fromQS);
      mergeProfile(p, fromForm);
      // ensure sessionId exists
      p.sessionId = p.sessionId || `${Date.now()}-${uid8()}`;
      return p;
    }

    function saveProfile(){
      const p = collectProfile();
      writeStoredProfile(p);
      elSessionKey.textContent = p.sessionId || '‚Äî';
      try{
        window.dispatchEvent(new CustomEvent('hha:log_profile', { detail: { ts: Date.now(), ...p } }));
      }catch(_){}
      return p;
    }

    function clearAll(){
      try{
        localStorage.removeItem('hha_profile');
        localStorage.removeItem('HHA_PROFILE');
        sessionStorage.removeItem('hha_profile');
        sessionStorage.removeItem('HHA_PROFILE');
      }catch(_){}
      fillForm({
        projectTag:'HeroHealth', studyId:'', phase:'', conditionGroup:'', sessionOrder:'',
        blockLabel:'', siteCode:'', schoolCode:'', schoolName:'', classRoom:'',
        studentNo:'', nickName:'', gender:'', age:'', gradeLevel:'',
        heightCm:'', weightKg:'', handedness:'', vrExperience:'', gameFrequency:'', consentParent:'', healthDetail:''
      });
      elSessionKey.textContent = '‚Äî';
      elDebugUrl.textContent = '';
    }

    function toQS(profile){
      const p = new URLSearchParams();
      for (const k of QS_KEYS){
        if (profile[k] === undefined || profile[k] === null || profile[k] === '') continue;
        p.set(k, String(profile[k]));
      }
      return p;
    }

    function buildLaunchUrl(gameKey, extraParams = {}){
      const base = GAMES[gameKey];
      if (!base) throw new Error('Unknown game: ' + gameKey);

      const profile = saveProfile();

      // standard launch params
      const runModeRaw = $('runMode').value || 'play';
      const runMode = normalizeRunMode(runModeRaw);

      const diff = $('diff').value || 'normal';
      const time = clamp($('time').value || 70, 20, 180)|0;

      const p = toQS(profile);
      p.set('run', runMode);
      p.set('runMode', runMode);
      p.set('diff', diff);
      p.set('time', String(time));
      p.set('durationPlannedSec', String(time));
      p.set('hub', './hub.html'); // important: games use this for back

      for (const k of Object.keys(extraParams || {})){
        const v = extraParams[k];
        if (v === undefined || v === null || v === '') continue;
        p.set(k, String(v));
      }

      p.set('projectTag', profile.projectTag || 'HeroHealth');
      p.set('ts', String(Date.now()));

      const url = base.includes('?') ? (base + '&' + p.toString()) : (base + '?' + p.toString());
      return url;
    }

    function previewGoodJunk(){
      const challenge = $('gjChallenge').value || 'rush';
      const u = buildLaunchUrl('goodjunk', { challenge, gameMode:'goodjunk' });
      elDebugUrl.textContent = u;
      // store as lastLaunch (for replay button)
      try{ localStorage.setItem('HHA_LAST_LAUNCH_URL', u); }catch(_){}
    }

    function bindLivePreview(){
      const ids = [
        'projectTag','studyId','phase','conditionGroup','sessionOrder','blockLabel','siteCode',
        'schoolCode','schoolName','classRoom','studentNo','nickName','gender','age','gradeLevel',
        'heightCm','weightKg','handedness','vrExperience','gameFrequency','consentParent','healthDetail',
        'runMode','diff','time','gjChallenge'
      ];
      for (const id of ids){
        const el = $(id);
        if (!el) continue;
        el.addEventListener('input', ()=> previewGoodJunk(), { passive:true });
        el.addEventListener('change', ()=> previewGoodJunk(), { passive:true });
      }
    }

    // =========================
    // ‚úÖ NEW: Last Summary UI
    // =========================
    const SUM = {
      card: $('lastSummaryCard'),
      hint: $('lastSummaryHint'),
      badgeGame: $('badgeGame'),
      badgeGrade: $('badgeGrade'),

      score: $('sumScore'),
      maxCombo: $('sumMaxCombo'),
      miss: $('sumMiss'),
      perfect: $('sumPerfect'),
      goals: $('sumGoals'),
      minis: $('sumMinis'),

      g1: $('sumG1'),
      g2: $('sumG2'),
      g3: $('sumG3'),
      g4: $('sumG4'),
      g5: $('sumG5'),
      gTotal: $('sumGTotal'),

      btnReplay: $('btnReplayLast'),
      btnCopy: $('btnCopyLast'),
      btnClear: $('btnClearLast'),
    };

    function readLastSummary(){
      try{
        const raw = localStorage.getItem('HHA_LAST_SUMMARY') || '';
        const obj = safeJsonParse(raw);
        if (!obj || typeof obj !== 'object') return null;
        if (!obj.game && !obj.gameTag) return obj; // allow minimal
        return obj;
      }catch(_){
        return null;
      }
    }

    function gradeBadgeClass(grade){
      grade = String(grade||'').toUpperCase();
      if (grade==='SSS' || grade==='SS' || grade==='S') return 'badge ok';
      if (grade==='A' || grade==='B') return 'badge warn';
      return 'badge danger';
    }

    function fmtTs(ts){
      try{
        const d = new Date(Number(ts) || Date.now());
        return d.toLocaleString();
      }catch(_){
        return '';
      }
    }

    function ensure2(x){
      if (x==null) return '‚Äî';
      if (typeof x === 'number') return String(x);
      const s = String(x);
      return s.trim() ? s : '‚Äî';
    }

    function renderLastSummary(){
      const sum = readLastSummary();
      if (!sum){
        SUM.card.style.display = 'none';
        return;
      }

      // best-effort fields
      const game = sum.game || sum.gameTag || sum.gameMode || (qs.get('from') ? String(qs.get('from')).toUpperCase() : '‚Äî');
      const sessionId = sum.sessionId || qs.get('lastSessionId') || '‚Äî';
      const mode = sum.mode || sum.runMode || sum.run || '‚Äî';
      const diff = sum.diff || '‚Äî';
      const grade = sum.grade || sum.rGrade || '‚Äî';

      SUM.badgeGame.textContent = `Game: ${game}`;
      SUM.badgeGrade.textContent = `Grade: ${grade}`;
      SUM.badgeGrade.className = gradeBadgeClass(grade);

      SUM.score.textContent = ensure2(sum.score ?? sum.scoreFinal);
      SUM.maxCombo.textContent = ensure2(sum.maxCombo ?? sum.comboMax);
      SUM.miss.textContent = ensure2(sum.miss ?? sum.misses);
      SUM.perfect.textContent = ensure2(sum.perfect ?? sum.perfectCount);
      SUM.goals.textContent = ensure2(sum.goals ?? (sum.goalsCleared!=null && sum.goalsTotal!=null ? `${sum.goalsCleared}/${sum.goalsTotal}` : '‚Äî'));
      SUM.minis.textContent = ensure2(sum.minis ?? (sum.minisCleared!=null && sum.minisTotal!=null ? `${sum.minisCleared}/${sum.minisTotal}` : '‚Äî'));

      const gc = Array.isArray(sum.groupCounts) ? sum.groupCounts : [];
      SUM.g1.textContent = ensure2(gc[0]);
      SUM.g2.textContent = ensure2(gc[1]);
      SUM.g3.textContent = ensure2(gc[2]);
      SUM.g4.textContent = ensure2(gc[3]);
      SUM.g5.textContent = ensure2(gc[4]);
      const total = (gc && gc.length) ? gc.reduce((a,b)=>a+(Number(b)||0),0) : (sum.total ?? '‚Äî');
      SUM.gTotal.textContent = ensure2(total);

      const hintParts = [];
      if (sessionId && sessionId!=='‚Äî') hintParts.push(`Session: ${sessionId}`);
      hintParts.push(`Mode: ${mode}`);
      hintParts.push(`Diff: ${diff}`);
      if (sum.ts) hintParts.push(`At: ${fmtTs(sum.ts)}`);
      SUM.hint.textContent = hintParts.join(' ‚Ä¢ ');

      // show
      SUM.card.style.display = 'block';

      // store a replay link snapshot if available
      try{
        const lastLaunch = localStorage.getItem('HHA_LAST_LAUNCH_URL');
        if (lastLaunch) { /* ok */ }
      }catch(_){}
    }

    function clearLastSummary(){
      try{ localStorage.removeItem('HHA_LAST_SUMMARY'); }catch(_){}
      SUM.card.style.display = 'none';
    }

    function copyText(txt){
      txt = String(txt||'');
      if (!txt) return;
      try{
        navigator.clipboard.writeText(txt);
      }catch(_){
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand('copy'); }catch(__){}
        ta.remove();
      }
    }

    function replayLast(){
      // priority: exact last launch url (the last time hub generated a link)
      let u = '';
      try{ u = localStorage.getItem('HHA_LAST_LAUNCH_URL') || ''; }catch(_){}
      if (u){
        location.href = u;
        return;
      }

      // fallback: infer from last summary game
      const sum = readLastSummary();
      const g = (sum && (sum.game || sum.gameMode || sum.gameTag)) ? String(sum.game || sum.gameMode || sum.gameTag) : '';
      const key =
        /goodjunk/i.test(g) ? 'goodjunk' :
        /hydration/i.test(g) ? 'hydration' :
        /groups/i.test(g) ? 'groups' :
        /plate/i.test(g) ? 'plate' : 'goodjunk';

      // reuse current form selections
      const u2 = buildLaunchUrl(key, { gameMode: key });
      location.href = u2;
    }

    // --------- Button handlers ---------
    $('btnSave').addEventListener('click', ()=>{ saveProfile(); previewGoodJunk(); renderLastSummary(); }, { passive:true });

    $('btnLoad').addEventListener('click', ()=>{
      const stored = readStoredProfile();
      if (stored) fillForm(stored);
      const merged = {};
      mergeProfile(merged, stored);
      mergeProfile(merged, pickQSProfile());
      if (Object.keys(merged).length) fillForm(merged);
      saveProfile();
      previewGoodJunk();
      renderLastSummary();
    }, { passive:true });

    $('btnClear').addEventListener('click', ()=>{ clearAll(); }, { passive:true });

    $('btnGJ').addEventListener('click', ()=>{
      const challenge = $('gjChallenge').value || 'rush';
      const u = buildLaunchUrl('goodjunk', { challenge, gameMode:'goodjunk' });
      try{ localStorage.setItem('HHA_LAST_LAUNCH_URL', u); }catch(_){}
      location.href = u;
    }, { passive:true });

    $('btnHY').addEventListener('click', ()=>{
      $('runMode').value = normalizeRunMode($('hyMode').value || $('runMode').value || 'play');
      const u = buildLaunchUrl('hydration', { gameMode:'hydration' });
      try{ localStorage.setItem('HHA_LAST_LAUNCH_URL', u); }catch(_){}
      location.href = u;
    }, { passive:true });

    $('btnPL').addEventListener('click', ()=>{
      $('runMode').value = normalizeRunMode($('plMode').value || $('runMode').value || 'play');
      const u = buildLaunchUrl('plate', { gameMode:'plate' });
      try{ localStorage.setItem('HHA_LAST_LAUNCH_URL', u); }catch(_){}
      location.href = u;
    }, { passive:true });

    $('btnGR').addEventListener('click', ()=>{
      $('runMode').value = normalizeRunMode($('grMode').value || $('runMode').value || 'play');
      const u = buildLaunchUrl('groups', { gameMode:'groups' });
      try{ localStorage.setItem('HHA_LAST_LAUNCH_URL', u); }catch(_){}
      location.href = u;
    }, { passive:true });

    // Summary buttons
    SUM.btnReplay && SUM.btnReplay.addEventListener('click', ()=> replayLast(), { passive:true });
    SUM.btnCopy && SUM.btnCopy.addEventListener('click', ()=>{
      let u = '';
      try{ u = localStorage.getItem('HHA_LAST_LAUNCH_URL') || ''; }catch(_){}
      if (!u) u = elDebugUrl.textContent || '';
      copyText(u);
    }, { passive:true });
    SUM.btnClear && SUM.btnClear.addEventListener('click', ()=> clearLastSummary(), { passive:true });

    // --------- Init ---------
    (function init(){
      // prefer: stored -> qs
      const stored = readStoredProfile();
      const fromQS = pickQSProfile();
      const merged = {};
      mergeProfile(merged, stored);
      mergeProfile(merged, fromQS);
      if (Object.keys(merged).length) fillForm(merged);

      // defaults
      if (!getVal('projectTag')) setVal('projectTag','HeroHealth');

      // ensure sessionId exists
      const profile = saveProfile();
      elSessionKey.textContent = profile.sessionId || '‚Äî';

      // compat: if qs had runMode=study, normalize selection
      const qsRun = normalizeRunMode(qs.get('runMode') || qs.get('run') || '');
      if (qsRun) $('runMode').value = qsRun;

      bindLivePreview();
      previewGoodJunk();

      // ‚úÖ show last summary if exists
      renderLastSummary();

      // optional: if returned from a game, scroll to summary card
      if (qs.get('from') || qs.get('lastSessionId')){
        setTimeout(()=>{
          try{
            const el = $('lastSummaryCard');
            if (el && el.style.display !== 'none') el.scrollIntoView({ behavior:'smooth', block:'start' });
          }catch(_){}
        }, 120);
      }
    })();
  </script>
</body>
</html>
