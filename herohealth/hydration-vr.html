<!-- === /herohealth/hydration-vr.html === -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --radius:18px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:radial-gradient(circle at 20% 0%, rgba(34,211,238,.18), transparent 55%), radial-gradient(circle at 80% 100%, rgba(34,197,94,.12), transparent 55%), var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",sans-serif; }

    /* ---------- Stage (‡∏õ‡∏Å‡∏ï‡∏¥) ---------- */
    .stage{
      position:fixed; inset:0;
      display:flex;
      flex-direction:column;
      padding: calc(12px + var(--sat)) calc(12px + var(--sar)) calc(12px + var(--sab)) calc(12px + var(--sal));
      gap:10px;
    }
    body.cardboard .stage{ opacity:0; pointer-events:none; }

    .topbar{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .panel{
      background:var(--panel);
      border:1px solid rgba(148,163,184,.14);
      border-radius: var(--radius);
      box-shadow: 0 18px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .hud{
      padding:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .stat{
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.35);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      min-height:52px;
    }
    .stat b{ font-size:14px; letter-spacing:.2px; }
    .stat span{ font-size:18px; font-weight:900; }

    .coach{
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .coach .bubble{
      flex:1;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.35);
    }
    .coach .bubble .title{ font-weight:900; color:var(--cyan); }
    .coach .bubble .msg{ color:var(--text); opacity:.92; line-height:1.25; }
    .coach .bubble .tip{ color:var(--muted); font-size:12px; margin-top:6px; }

    .playwrap{
      flex:1;
      min-height:0;
      display:flex;
      gap:10px;
    }
    .playfieldWrap{
      flex:1;
      min-width:0;
      position:relative;
      overflow:hidden;
      border-radius: var(--radius);
    }
    #playfield{
      position:absolute; inset:0;
      border-radius: var(--radius);
      background: rgba(0,0,0,.10);
    }
    #hvr-layer{
      position:absolute; inset:0;
      border-radius: var(--radius);
      overflow:hidden;
    }
    /* crosshair */
    .crosshair{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:14px; height:14px;
      border-radius:999px;
      border:2px solid rgba(226,232,240,.55);
      box-shadow: 0 0 0 10px rgba(34,211,238,.08);
      pointer-events:none;
      opacity:.75;
    }

    .sidebar{
      width:min(320px, 36vw);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .gauge, .quest{
      padding:10px;
    }
    .gauge .row, .quest .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .muted{ color:var(--muted); }
    .btnbar{
      display:flex;
      gap:10px;
      padding:10px;
    }
    .btn{
      flex:1;
      padding:12px 12px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color:var(--text);
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{ background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.28); }
    .btn.danger{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.22); }
    .btn:active{ transform: translateY(1px); }

    /* ---------- Cardboard ---------- */
    #cbWrap{
      position:fixed; inset:0;
      display:none;
      background:#000;
      z-index:9999;
    }
    body.cardboard #cbWrap{ display:flex; }
    .cbEye{
      position:relative;
      flex:1;
      overflow:hidden;
      border-left:1px solid rgba(255,255,255,.08);
    }
    .cbEye:first-child{ border-left:none; }
    .cbPlayfield{
      position:absolute; inset:0;
      overflow:hidden;
      background: rgba(0,0,0,.08);
    }
    .cbLayer{
      position:absolute; inset:0;
      overflow:hidden;
    }
    .cbCross{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:16px; height:16px;
      border-radius:999px;
      border:2px solid rgba(226,232,240,.55);
      box-shadow: 0 0 0 10px rgba(34,211,238,.10);
      pointer-events:none;
      opacity:.8;
    }
    .cbHudHint{
      position:absolute;
      left:10px; top:10px;
      padding:8px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
      color:rgba(226,232,240,.92);
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.14);
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á Cardboard */
    #cbControls{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px calc(12px + var(--sar)) calc(10px + var(--sab)) calc(12px + var(--sal));
      display:none;
      z-index:10000;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    body.cardboard #cbControls{ display:flex; }

    /* ---------- overlays ---------- */
    #start-overlay, #end-overlay{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10001;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    #start-overlay[hidden], #end-overlay[hidden]{ display:none; }
    .modal{
      width:min(720px, 92vw);
      border-radius: 22px;
      background: rgba(2,6,23,.88);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 24px 120px rgba(0,0,0,.7);
      padding:16px;
    }
    .modal h2{ margin:0 0 8px 0; }
    .modal p{ margin:0 0 12px 0; color:var(--muted); line-height:1.35; }
    .modal .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.35);
      font-weight:900;
      font-size:13px;
    }
    .summaryGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .sumCard{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
    }
    .sumCard .k{ color:var(--muted); font-size:12px; }
    .sumCard .v{ font-weight:1000; font-size:18px; }
    @media (max-width: 820px){
      .topbar{ grid-template-columns: 1fr; }
      .hud{ grid-template-columns: repeat(2, 1fr); }
      .playwrap{ flex-direction:column; }
      .sidebar{ width:100%; }
      .summaryGrid{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body>

  <!-- START OVERLAY -->
  <div id="start-overlay">
    <div class="modal">
      <h2>üíß Hydration VR</h2>
      <p>‡πÅ‡∏ï‡∏∞ <b>START</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° ‚Ä¢ ‡πÄ‡∏õ‡πâ‡∏≤‡∏î‡∏µ = üíß ‚Ä¢ ‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏¢‡πà = ü•§ ‚Ä¢ ‡πÇ‡∏•‡πà = üõ°Ô∏è<br/>
      ‡∏ï‡∏≠‡∏ô Storm ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ Mini: <b>LOW/HIGH + BLOCK ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢</b> ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢ BOSS üå©Ô∏è</p>
      <div class="row">
        <span class="pill">diff: <b id="pill-diff">normal</b></span>
        <span class="pill">time: <b id="pill-time">70</b>s</span>
        <span class="pill">mode: <b id="pill-run">play</b></span>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnStart">‚ñ∂ START</button>
        <button class="btn" id="btnCardboard">üì¶ CARDBOARD</button>
        <button class="btn danger" id="btnBackHub">üè† BACK HUB</button>
      </div>
      <p class="muted" style="margin-top:10px;font-size:12px;">
        Tip: ‡πÄ‡∏Ç‡πâ‡∏≤ Cardboard ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° <b>SHOOT</b> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‚Äù
      </p>
    </div>
  </div>

  <!-- END / SUMMARY OVERLAY -->
  <div id="end-overlay" hidden>
    <div class="modal">
      <h2>üèÅ Summary</h2>
      <div class="summaryGrid">
        <div class="sumCard"><div class="k">Score</div><div class="v" id="sum-score">0</div></div>
        <div class="sumCard"><div class="k">Grade</div><div class="v" id="sum-grade">C</div></div>
        <div class="sumCard"><div class="k">Accuracy</div><div class="v" id="sum-acc">0%</div></div>

        <div class="sumCard"><div class="k">Combo Max</div><div class="v" id="sum-comboMax">0</div></div>
        <div class="sumCard"><div class="k">Miss</div><div class="v" id="sum-miss">0</div></div>
        <div class="sumCard"><div class="k">Goals</div><div class="v" id="sum-goals">0/1</div></div>

        <div class="sumCard"><div class="k">Minis</div><div class="v" id="sum-minis">0/999</div></div>
        <div class="sumCard"><div class="k">Time in GREEN</div><div class="v" id="sum-green">0.0s</div></div>
        <div class="sumCard"><div class="k">Streak Max</div><div class="v" id="sum-streak">0</div></div>

        <div class="sumCard"><div class="k">Storm Cycles</div><div class="v" id="sum-stormCycles">0</div></div>
        <div class="sumCard"><div class="k">Storm Success</div><div class="v" id="sum-stormOk">0</div></div>
        <div class="sumCard"><div class="k">Storm Rate</div><div class="v" id="sum-stormRate">0%</div></div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnRetry">üîÅ Retry</button>
        <button class="btn primary" id="btnBackHub2">üè† Back HUB</button>
        <button class="btn danger" id="btnCloseEnd">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- MAIN STAGE -->
  <div class="stage">
    <div class="topbar">
      <div class="panel hud">
        <div class="stat"><b>‚è± TIME</b><span id="stat-time">0</span></div>
        <div class="stat"><b>üèÜ SCORE</b><span id="stat-score">0</span></div>
        <div class="stat"><b>‚ö° COMBO</b><span id="stat-combo">0</span></div>
        <div class="stat"><b>üí• MISS</b><span id="stat-miss">0</span></div>
        <div class="stat"><b>üéñ GRADE</b><span id="stat-grade">C</span></div>
        <div class="stat"><b>üåÄ STORM</b><span id="storm-left">0</span>s</div>
        <div class="stat"><b>üõ° SHIELD</b><span id="shield-count">0</span></div>
        <!-- optional -->
        <div class="stat" style="display:none"><b>Combo Max</b><span id="stat-combo-max">0</span></div>
      </div>

      <div class="panel coach">
        <div class="bubble">
          <div class="title">üß† Coach</div>
          <div class="msg" id="coach-msg">‡πÅ‡∏ï‡∏∞ START ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
          <div class="tip">Tip: ‡πÇ‡∏´‡∏°‡∏î Cardboard = ‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á (gaze) / ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° SHOOT</div>
        </div>
      </div>

      <div class="panel quest">
        <div class="row"><b>üß© Quest</b><span class="muted">Goal / Mini</span></div>
        <div class="muted" id="quest-line1">‚Äî</div>
        <div class="muted" id="quest-line2">‚Äî</div>
        <div class="muted" id="quest-line3">‚Äî</div>
        <div class="muted" id="quest-line4">‚Äî</div>
      </div>
    </div>

    <div class="playwrap">
      <div class="panel playfieldWrap">
        <div id="playfield">
          <div id="hvr-layer"></div>
          <div class="crosshair"></div>
        </div>
      </div>

      <div class="sidebar">
        <div class="panel gauge">
          <div class="row"><b>üíß Water Gauge (0‚Äì100)</b><span class="muted" id="wg-pct">0%</span></div>
          <div class="muted" style="margin-top:6px;">Zone <b id="wg-zone">‚Äî</b></div>
          <!-- ui-water.js ‡∏à‡∏∞ inject gauge UI ‡∏•‡∏á‡πÉ‡∏ô DOM ‡πÄ‡∏≠‡∏á -->
          <div class="muted" style="margin-top:6px;">Goal <b style="color:var(--accent)">GREEN</b> ‚Ä¢ Mini <b style="color:var(--cyan)">LOW/HIGH + BLOCK</b></div>
        </div>

        <div class="panel btnbar">
          <button class="btn" id="btnCardboard2">üì¶ CARDBOARD</button>
          <button class="btn primary" id="btnShoot">üéØ SHOOT</button>
          <button class="btn danger" id="btnStop">‚õî STOP</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CARDBOARD WRAP -->
  <div id="cbWrap" aria-hidden="true">
    <div class="cbEye">
      <div class="cbHudHint">CARDBOARD ‚Ä¢ LEFT</div>
      <div class="cbPlayfield" id="cbPlayfieldL">
        <div class="cbLayer" id="hvr-layerL"></div>
        <div class="cbCross"></div>
      </div>
    </div>
    <div class="cbEye">
      <div class="cbHudHint">CARDBOARD ‚Ä¢ RIGHT</div>
      <div class="cbPlayfield" id="cbPlayfieldR">
        <div class="cbLayer" id="hvr-layerR"></div>
        <div class="cbCross"></div>
      </div>
    </div>
  </div>

  <!-- Cardboard controls -->
  <div id="cbControls">
    <button class="btn" id="btnExitCardboard">‚¨Ö Exit</button>
    <button class="btn primary" id="btnShootCenter">üéØ SHOOT</button>
    <button class="btn danger" id="btnStop2">‚õî STOP</button>
  </div>

  <!-- Load game module -->
  <script type="module">
    // -------- URL pills --------
    const qs = (k,d)=>{ try{ return (new URL(location.href)).searchParams.get(k) ?? d; }catch{ return d; } };
    document.getElementById('pill-diff').textContent = qs('diff','normal');
    document.getElementById('pill-time').textContent = qs('time','70');
    document.getElementById('pill-run').textContent  = qs('run', qs('runMode','play'));

    const hub = qs('hub','./hub.html');

    const startOv = document.getElementById('start-overlay');
    const endOv   = document.getElementById('end-overlay');

    const goHub = ()=>{ location.href = hub; };
    const retry = ()=>{
      const u = new URL(location.href);
      u.searchParams.set('ts', String(Date.now()));
      location.href = u.toString();
    };

    // -------- buttons --------
    document.getElementById('btnBackHub').onclick = goHub;
    document.getElementById('btnBackHub2').onclick = goHub;
    document.getElementById('btnRetry').onclick = retry;
    document.getElementById('btnCloseEnd').onclick = ()=> endOv.hidden = true;

    const setCardboard = (on)=>{
      document.body.classList.toggle('cardboard', !!on);
      document.getElementById('cbWrap').setAttribute('aria-hidden', String(!on));
    };

    document.getElementById('btnCardboard').onclick = ()=> setCardboard(true);
    document.getElementById('btnCardboard2').onclick = ()=> setCardboard(true);
    document.getElementById('btnExitCardboard').onclick = ()=> setCardboard(false);

    document.getElementById('btnStart').onclick = ()=>{ startOv.hidden = true; };
    document.getElementById('btnStop').onclick  = ()=> window.dispatchEvent(new CustomEvent('hha:force_end',{detail:{reason:'stop'}}));
    document.getElementById('btnStop2').onclick = ()=> window.dispatchEvent(new CustomEvent('hha:force_end',{detail:{reason:'stop'}}));

    // SHOOT button (hydration.safe.js ‡∏à‡∏∞ bind ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ)
    document.getElementById('btnShoot').onclick = ()=> window.dispatchEvent(new CustomEvent('hha:shoot'));
    document.getElementById('btnShootCenter').onclick = ()=> window.dispatchEvent(new CustomEvent('hha:shoot'));

    // -------- Summary binding --------
    window.addEventListener('hha:end', (ev)=>{
      const d = ev.detail || {};
      const acc = (Number(d.accuracyGoodPct)||0).toFixed(1) + '%';

      document.getElementById('sum-score').textContent = d.scoreFinal ?? 0;
      document.getElementById('sum-grade').textContent = d.grade ?? 'C';
      document.getElementById('sum-acc').textContent = acc;

      document.getElementById('sum-comboMax').textContent = d.comboMax ?? 0;
      document.getElementById('sum-miss').textContent = d.misses ?? 0;
      document.getElementById('sum-goals').textContent = `${d.goalsCleared ?? 0}/${d.goalsTotal ?? 1}`;

      document.getElementById('sum-minis').textContent = `${d.miniCleared ?? 0}/${d.miniTotal ?? 999}`;
      document.getElementById('sum-green').textContent = (Number(d.timeInGreenSec||0)).toFixed(1) + 's';
      document.getElementById('sum-streak').textContent = d.streakMax ?? 0;

      document.getElementById('sum-stormCycles').textContent = d.stormCycles ?? 0;
      document.getElementById('sum-stormOk').textContent = d.stormMiniSuccess ?? 0;
      document.getElementById('sum-stormRate').textContent = (Number(d.stormSuccessRatePct||0)).toFixed(0) + '%';

      endOv.hidden = false;
    });

    // -------- Optional: water gauge text mirror --------
    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail || {};
      document.getElementById('wg-pct').textContent = (Number(d.waterPct||0)).toFixed(0) + '%';
      document.getElementById('wg-zone').textContent = d.waterZone || '‚Äî';

      // optional coach text
      const msg = document.getElementById('coach-msg');
      if (d.stormActive){
        msg.textContent = d.stormInEndWindow ? '‚è≥ ‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏! ‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ BLOCK + ‡∏õ‡∏¥‡∏î BOSS üå©Ô∏è' : 'üåÄ Storm! ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏∏‡∏î GREEN ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° BLOCK ‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢';
      } else {
        msg.textContent = '‡∏¢‡∏¥‡∏á üíß ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô ‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô ü•§ / üå©Ô∏è ‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏';
      }
    });

    // -------- finally: load module --------
    import './hydration-vr/hydration.safe.js';
  </script>
</body>
</html>