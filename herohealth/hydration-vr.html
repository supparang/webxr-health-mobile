<!-- === /herohealth/hydration-vr.html ===
HydrationVR ‚Äî PRODUCTION (Stereo Cardboard + Gaze + Pill Mini HUD)
‚úÖ Mono mode + Cardboard stereo (2 eyes)
‚úÖ Gaze dwell shooting (default ON in Cardboard)
‚úÖ Uses ui-water.js (0‚Äì100 gauge) + hydration.safe.js engine
‚úÖ End summary + back HUB + localStorage HHA_LAST_SUMMARY
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Global FX + input compat + logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.65);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);

      /* gaze */
      --gaze: 0; /* 0..1 */

      /* end-window cinematic */
      --endamp: 0;
      --endflash: 0;

      /* water */
      --water: 50;
    }

    html,body{
      margin:0; padding:0; width:100%; height:100%;
      background: radial-gradient(1200px 700px at 50% 25%, #0b1120 0%, #020617 60%, #020617 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif;
      overflow:hidden;
    }
    *{ box-sizing:border-box; }

    /* ---------- shared components ---------- */
    .pill{
      display:inline-flex; align-items:baseline; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.16);
      font-weight:1000;
      white-space:nowrap;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .k{ color:var(--muted); font-weight:950; font-size:11px; }
    .v{ font-size:14px; font-weight:1100; }
    .muted{ color:var(--muted); font-weight:900; }

    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(34,197,94,.18);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1100;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn.secondary{ background: rgba(2,6,23,.55); }
    .btn.danger{ background: rgba(239,68,68,.18); }
    .btn:active{ transform: translateY(1px); }

    /* ---------- MONO LAYOUT ---------- */
    #monoStage{
      position:fixed; inset:0;
      display:flex;
      flex-direction:column;
    }

    #monoTop{
      position:relative;
      z-index:20;
      padding: calc(var(--sat) + 10px) 12px 10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      pointer-events:none;
    }
    #monoTop .left{ display:flex; gap:8px; flex-wrap:wrap; }
    #monoTop .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    #monoMiniPills{
      position:fixed;
      left:50%;
      top: calc(var(--sat) + 62px);
      transform: translateX(-50%);
      z-index:21;
      display:flex;
      gap:8px;
      pointer-events:none;
      opacity:.96;
    }

    #playfield{
      position:relative;
      flex:1;
      margin: 0 12px;
      border-radius: 22px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.06), 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
      touch-action: manipulation;
      will-change: transform, filter;
    }
    #hvr-layer{ position:absolute; inset:0; }

    #monoBottom{
      position:relative;
      z-index:20;
      padding: 10px 12px calc(var(--sab) + 12px);
      display:flex; gap:10px;
      justify-content:space-between;
      align-items:flex-end;
      pointer-events:none;
    }
    .card{
      pointer-events:none;
      background: var(--panel);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      padding: 10px 10px;
      min-width: 240px;
    }
    .card h3{ margin:0 0 6px; font-size:12px; letter-spacing:.2px; opacity:.95; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:baseline; justify-content:space-between; }

    .barWrap{ margin-top:6px; width:100%; height:10px; border-radius:999px; background: rgba(148,163,184,.12); overflow:hidden; }
    .bar{ height:100%; width:0%; border-radius:999px; transition: width .16s ease; }

    /* water theme */
    body.water-low .bar{ background: linear-gradient(90deg, rgba(249,115,22,.95), rgba(239,68,68,.95)); box-shadow: 0 0 16px rgba(239,68,68,.18); }
    body.water-green .bar{ background: linear-gradient(90deg, rgba(34,211,238,.90), rgba(34,197,94,.95)); box-shadow: 0 0 16px rgba(34,211,238,.18); }
    body.water-high .bar{ background: linear-gradient(90deg, rgba(167,139,250,.92), rgba(34,211,238,.82)); box-shadow: 0 0 16px rgba(167,139,250,.16); }

    /* ---------- TARGETS ---------- */
    .tgt{
      position:absolute;
      left: var(--x, 50%);
      top:  var(--y, 50%);
      width: var(--s, 64px);
      height: var(--s, 64px);
      transform: translate(-50%,-50%);
      display:grid;
      place-items:center;
      font-size: calc(var(--s,64px) * 0.56);
      border-radius: 999px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.35));
      will-change: transform, opacity;
    }
    .tgt::before{
      content:"";
      position:absolute; inset:-6px;
      border-radius:999px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 50% 60%, rgba(34,211,238,.10), rgba(2,6,23,0) 62%);
      border: 1px solid rgba(148,163,184,.16);
      backdrop-filter: blur(6px);
    }
    .tgt.good::before{ box-shadow: 0 0 0 2px rgba(34,197,94,.12), 0 0 24px rgba(34,197,94,.10); }
    .tgt.bad::before{ box-shadow: 0 0 0 2px rgba(239,68,68,.14), 0 0 26px rgba(239,68,68,.10); }
    .tgt.shield::before{ box-shadow: 0 0 0 2px rgba(34,211,238,.14), 0 0 26px rgba(34,211,238,.10); }
    .tgt.star::before{ box-shadow: 0 0 0 2px rgba(250,204,21,.14), 0 0 26px rgba(250,204,21,.10); }
    .tgt.diamond::before{ box-shadow: 0 0 0 2px rgba(167,139,250,.14), 0 0 26px rgba(167,139,250,.10); }

    .tgt.pop{ animation: pop .22s ease-out; }
    @keyframes pop{
      from{ transform: translate(-50%,-50%) scale(.92); opacity:.0; }
      to  { transform: translate(-50%,-50%) scale(1); opacity:1; }
    }
    .tgt.out{ animation: out .18s ease-in forwards; }
    @keyframes out{
      to { transform: translate(-50%,-50%) scale(.75); opacity:0; }
    }

    /* ---------- CROSSHAIR (mono) ---------- */
    #crosshair{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:18px; height:18px;
      border-radius:999px;
      pointer-events:none;
      z-index:5;
      box-shadow: 0 0 0 2px rgba(229,231,235,.28), 0 0 22px rgba(34,197,94,.10);
      background:rgba(229,231,235,.07);
      backdrop-filter: blur(6px);
    }
    #crosshair::after{
      content:'';
      position:absolute; inset:5px;
      border-radius:999px;
      background:rgba(229,231,235,.50);
    }
    /* gaze ring */
    #crosshair::before{
      content:'';
      position:absolute; inset:-10px;
      border-radius:999px;
      background: conic-gradient(rgba(34,211,238,.95) calc(var(--gaze) * 1turn), rgba(255,255,255,0) 0);
      mask: radial-gradient(circle, transparent 62%, #000 63%);
      opacity: .95;
      filter: drop-shadow(0 0 14px rgba(34,211,238,.20));
    }

    /* ---------- CARDBOARD STEREO ---------- */
    #cbStage{
      position:fixed; inset:0;
      display:none;
      background:#000;
      z-index:100;
    }
    body.cardboard #monoStage{ display:none; }
    body.cardboard #cbStage{ display:flex; }

    .eye{
      position:relative;
      flex:1;
      overflow:hidden;
      border-left:1px solid rgba(255,255,255,.06);
    }
    .eye:first-child{ border-left:none; }

    .eyeHud{
      position:absolute;
      left:10px; right:10px;
      top: calc(var(--sat) + 10px);
      z-index:3;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .eyeMini{
      position:absolute;
      left:50%;
      top: calc(var(--sat) + 58px);
      transform: translateX(-50%);
      z-index:3;
      display:flex;
      gap:8px;
      pointer-events:none;
      opacity:.96;
    }

    .cbPlayfield{
      position:absolute;
      left:10px; right:10px;
      top: calc(var(--sat) + 104px);
      bottom: calc(var(--sab) + 104px);
      border-radius: 22px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.26);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.06);
      overflow:hidden;
    }
    .cbLayer{ position:absolute; inset:0; }
    .cbCross{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:18px; height:18px; border-radius:999px;
      pointer-events:none;
      z-index:4;
      box-shadow: 0 0 0 2px rgba(229,231,235,.28), 0 0 22px rgba(34,197,94,.10);
      background:rgba(229,231,235,.07);
      backdrop-filter: blur(6px);
    }
    .cbCross::after{ content:''; position:absolute; inset:5px; border-radius:999px; background:rgba(229,231,235,.50); }
    .cbCross::before{
      content:'';
      position:absolute; inset:-10px;
      border-radius:999px;
      background: conic-gradient(rgba(34,211,238,.95) calc(var(--gaze) * 1turn), rgba(255,255,255,0) 0);
      mask: radial-gradient(circle, transparent 62%, #000 63%);
      opacity: .95;
      filter: drop-shadow(0 0 14px rgba(34,211,238,.20));
    }

    .cbBottom{
      position:absolute;
      left:10px; right:10px;
      bottom: calc(var(--sab) + 10px);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      z-index:5;
      pointer-events:none;
    }
    .cbBottom .pill{ pointer-events:none; }
    .cbShoot{
      pointer-events:auto;
      padding:14px 16px;
      border-radius:18px;
      font-size:16px;
      font-weight:1200;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }

    /* ---------- START OVERLAY ---------- */
    #start-overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,.75);
      z-index:200;
    }
    .startCard{
      width:min(560px, calc(100% - 24px));
      background: rgba(2,6,23,.88);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      text-align:left;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

    /* ---------- END SUMMARY ---------- */
    #hvr-end{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,6,23,.78);
      z-index:300;
    }
    .endCard{
      width:min(560px, calc(100% - 24px));
      background: rgba(2,6,23,.90);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .endGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .endItem{
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.14);
      border-radius: 16px;
      padding: 10px;
      font-weight: 1100;
    }
    .endItem .k{ font-size:11px; color:var(--muted); font-weight:950; }
    .endItem .v{ margin-top:4px; font-size:16px; }

    /* ---------- End-window cinematic (optional) ---------- */
    body.endwindow::after{
      content:"";
      position:fixed; inset:-26px;
      pointer-events:none;
      z-index:120;
      opacity: calc(0.10 + (var(--endamp) * 0.18));
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,0) 0px,
          rgba(255,255,255,0) 2px,
          rgba(255,255,255,0.018) 3px
        ),
        radial-gradient(900px 680px at 50% 42%,
          rgba(239,68,68, calc(0.06 + (var(--endflash) * 0.22))) 0%,
          rgba(239,68,68, calc(0.03 + (var(--endflash) * 0.14))) 22%,
          rgba(2,6,23,0) 60%),
        radial-gradient(1200px 920px at 50% 50%,
          rgba(2,6,23,0) 35%,
          rgba(2,6,23, calc(0.26 + (var(--endamp) * 0.38))) 78%,
          rgba(2,6,23, calc(0.44 + (var(--endamp) * 0.40))) 100%);
      mix-blend-mode: screen;
      filter: saturate(1.25) contrast(1.10);
      animation: endFlicker .18s ease-in-out infinite;
    }
    @keyframes endFlicker{
      0%{ opacity: calc(0.09 + (var(--endamp) * 0.16)); }
      50%{ opacity: calc(0.14 + (var(--endamp) * 0.22)); }
      100%{ opacity: calc(0.10 + (var(--endamp) * 0.18)); }
    }
    body.endwindow #playfield{ filter: contrast(1.12) saturate(1.10); }
  </style>
</head>

<body class="water-green">
  <!-- MONO -->
  <div id="monoStage">
    <div id="monoTop">
      <div class="left">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" id="stat-time" data-stat="time">‚Äî</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" id="stat-score" data-stat="score">0</span></span>
        <span class="pill">‚ö° <span class="k">COMBO</span> <span class="v" id="stat-combo" data-stat="combo">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span class="v" id="stat-miss" data-stat="miss">0</span></span>
        <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span class="v" id="stat-grade" data-stat="grade">C</span></span>
      </div>
      <div class="right">
        <span class="pill">üíß <span class="k">WATER</span> <span class="v" id="water-pct" data-water-pct>50%</span></span>
        <span class="pill">üü© <span class="k">ZONE</span> <span class="v" id="water-zone" data-water-zone>GREEN</span></span>
        <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" id="shield-count" data-stat="shield">0</span></span>
      </div>
    </div>

    <!-- mini pill HUD -->
    <div id="monoMiniPills" aria-hidden="true">
      <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" id="pill-goal" data-pill="goal">‚Äî</span></span>
      <span class="pill">üå™Ô∏è <span class="k">STORM</span> <span class="v" id="pill-storm" data-pill="storm">0s</span></span>
      <span class="pill">üß© <span class="k">MINI</span> <span class="v" id="pill-mini" data-pill="mini">‚Äî</span></span>
    </div>

    <div id="playfield">
      <div id="hvr-layer"></div>
      <div id="crosshair" aria-hidden="true"></div>
    </div>

    <div id="monoBottom">
      <div class="card" style="min-width:280px">
        <h3>üíß Water Gauge (0‚Äì100)</h3>
        <div class="row">
          <div class="pill">ZONE <span class="v" data-water-zone>GREEN</span></div>
          <div class="pill"><span class="v" data-water-pct>50%</span></div>
        </div>
        <div class="barWrap" style="margin-top:10px">
          <div class="bar" id="water-bar" data-water-bar style="width:50%"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="pill">üå™Ô∏è STORM <span class="v" id="storm-left" data-stat="storm">0</span>s</div>
          <div class="pill">üß† PRESS <span class="v" id="press-pct" data-stat="press">0%</span></div>
        </div>
      </div>

      <div class="card" style="min-width:360px">
        <h3>üß© Quest</h3>
        <div class="row" style="justify-content:flex-start">
          <div class="pill">Goal <span class="v" id="quest-line1" data-quest="goal">‚Äî</span></div>
          <div class="pill">Prog <span class="v" id="quest-line2" data-quest="prog">‚Äî</span></div>
        </div>
        <div class="row" style="margin-top:8px; justify-content:flex-start">
          <div class="pill">Mini <span class="v" id="quest-line3" data-quest="mini">‚Äî</span></div>
          <div class="pill">State <span class="v" id="quest-line4" data-quest="state">‚Äî</span></div>
        </div>
        <div class="muted" style="margin-top:10px; font-size:12px; line-height:1.3">
          ‡πÄ‡∏õ‡πâ‡∏≤: üíß(+‡∏ô‡πâ‡∏≥) / üöª(-‡∏ô‡πâ‡∏≥) / üçü(BAD) / üõ°Ô∏è(Shield) / ‚≠ê(Bonus) / üíé(Fever)<br/>
          <b>Mini</b>: ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢ Storm (End-window) ‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏ö‡∏•‡πá‡∏≠‡∏Å BAD‚Äù ‡∏î‡πâ‡∏ß‡∏¢ Shield
        </div>
      </div>
    </div>
  </div>

  <!-- CARDBOARD STEREO -->
  <div id="cbStage" aria-hidden="true">
    <div class="eye" id="eyeL">
      <div class="eyeHud">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" data-stat="time">‚Äî</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" data-stat="score">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span class="v" data-stat="miss">0</span></span>
        <span class="pill">üíß <span class="k">WATER</span> <span class="v" data-water-pct>50%</span></span>
        <span class="pill">üü© <span class="k">ZONE</span> <span class="v" data-water-zone>GREEN</span></span>
        <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" data-stat="shield">0</span></span>
      </div>
      <div class="eyeMini">
        <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" data-pill="goal">‚Äî</span></span>
        <span class="pill">üå™Ô∏è <span class="k">STORM</span> <span class="v" data-pill="storm">0s</span></span>
        <span class="pill">üß© <span class="k">MINI</span> <span class="v" data-pill="mini">‚Äî</span></span>
      </div>
      <div class="cbPlayfield" id="cbPlayL">
        <div class="cbLayer" id="hvr-layerL"></div>
        <div class="cbCross" aria-hidden="true"></div>
      </div>
      <div class="cbBottom">
        <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span class="v" data-stat="grade">C</span></span>
        <button class="btn cbShoot" id="btnShootL" type="button">üéØ SHOOT</button>
      </div>
    </div>

    <div class="eye" id="eyeR">
      <div class="eyeHud">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" data-stat="time">‚Äî</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" data-stat="score">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span class="v" data-stat="miss">0</span></span>
        <span class="pill">üíß <span class="k">WATER</span> <span class="v" data-water-pct>50%</span></span>
        <span class="pill">üü© <span class="k">ZONE</span> <span class="v" data-water-zone>GREEN</span></span>
        <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" data-stat="shield">0</span></span>
      </div>
      <div class="eyeMini">
        <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" data-pill="goal">‚Äî</span></span>
        <span class="pill">üå™Ô∏è <span class="k">STORM</span> <span class="v" data-pill="storm">0s</span></span>
        <span class="pill">üß© <span class="k">MINI</span> <span class="v" data-pill="mini">‚Äî</span></span>
      </div>
      <div class="cbPlayfield" id="cbPlayR">
        <div class="cbLayer" id="hvr-layerR"></div>
        <div class="cbCross" aria-hidden="true"></div>
      </div>
      <div class="cbBottom">
        <span class="pill">üß† <span class="k">PRESS</span> <span class="v" data-stat="press">0%</span></span>
        <button class="btn cbShoot" id="btnShootR" type="button">üéØ SHOOT</button>
      </div>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div id="start-overlay">
    <div class="startCard">
      <div style="font-size:18px;font-weight:1200">üíß Hydration VR</div>
      <div class="muted" style="margin-top:6px; font-size:12px; font-weight:950; line-height:1.35">
        ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (crosshair) ‚Äî ‡πÄ‡∏õ‡πâ‡∏≤‡πÇ‡∏ú‡∏•‡πà‡∏ó‡∏±‡πà‡∏ß‡∏™‡∏ô‡∏≤‡∏° <br/>
        <b>Cardboard</b>: ‡∏°‡∏µ 2 ‡∏à‡∏≠ + ‡πÄ‡∏õ‡∏¥‡∏î Gaze ‡πÉ‡∏´‡πâ (‡πÄ‡∏•‡πá‡∏á‡∏Ñ‡πâ‡∏≤‡∏á = ‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
      </div>
      <div class="btnRow">
        <button class="btn" id="btn-start-2d" type="button">üöÄ START (2D)</button>
        <button class="btn secondary" id="btn-start-vr" type="button">üì¶ START (VR/Cardboard)</button>
        <button class="btn secondary" id="btn-toggle-gaze" type="button">üëÅÔ∏è GAZE: ON</button>
        <button class="btn danger" id="btn-stop" type="button">‚õî STOP</button>
      </div>
      <div class="muted" style="margin-top:10px; font-size:12px; font-weight:950">
        Tip: ‡πÇ‡∏´‡∏°‡∏î Mini ‡∏à‡∏∞‡πÇ‡∏´‡∏î‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ Storm ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Shield ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏ö‡∏•‡πá‡∏≠‡∏Å üçü‚Äù
      </div>
    </div>
  </div>

  <!-- END SUMMARY -->
  <div id="hvr-end">
    <div class="endCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-size:18px; font-weight:1200">üèÅ Summary</div>
        <div style="display:flex; gap:10px;">
          <button class="btn secondary" id="btn-backhub" type="button">üè† HUB</button>
          <button class="btn" id="btn-retry" type="button">üîÅ Retry</button>
        </div>
      </div>
      <div class="endGrid">
        <div class="endItem"><div class="k">Score</div><div class="v" id="end-score">0</div></div>
        <div class="endItem"><div class="k">Grade</div><div class="v" id="end-grade">C</div></div>
        <div class="endItem"><div class="k">Combo Max</div><div class="v" id="end-combo">0</div></div>
        <div class="endItem"><div class="k">Miss</div><div class="v" id="end-miss">0</div></div>
        <div class="endItem"><div class="k">Goal</div><div class="v" id="end-goals">0/1</div></div>
        <div class="endItem"><div class="k">Mini</div><div class="v" id="end-minis">0</div></div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ IMPORTANT: correct relative path from /herohealth/hydration-vr.html -->
  <script type="module" src="./hydration-vr/hydration.safe.js"></script>

  <!-- small helpers (toggle UI only; engine is in safe.js) -->
  <script>
    (function(){
      'use strict';
      const D = document;

      function setGazeVar(v){
        v = Math.max(0, Math.min(1, Number(v)||0));
        D.documentElement.style.setProperty('--gaze', String(v));
      }
      setGazeVar(0);

      const btn2d  = D.getElementById('btn-start-2d');
      const btnvr  = D.getElementById('btn-start-vr');
      const btngz  = D.getElementById('btn-toggle-gaze');
      const btnstop= D.getElementById('btn-stop');
      const overlay= D.getElementById('start-overlay');

      let gazeOn = true;
      function updateGazeBtn(){
        btngz.textContent = 'üëÅÔ∏è GAZE: ' + (gazeOn ? 'ON' : 'OFF');
        D.body.classList.toggle('gaze-off', !gazeOn);
        window.__HVR_GAZE_ON__ = gazeOn;
      }
      updateGazeBtn();

      btngz.addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        updateGazeBtn();
        setGazeVar(0);
      });

      function resumeAudio(){
        try{
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return Promise.resolve();
          const ctx = new AC();
          if (ctx.state === 'suspended') return ctx.resume().finally(()=>ctx.close().catch(()=>{}));
          return ctx.close().catch(()=>{});
        }catch{ return Promise.resolve(); }
      }

      function start(mode){
        // engine listens to this
        window.__HVR_START_MODE__ = mode; // 'mono' | 'cardboard'
        overlay.style.display = 'none';
        window.dispatchEvent(new CustomEvent('hvr:start', { detail:{ mode } }));
      }

      btn2d.addEventListener('click', async ()=>{
        await resumeAudio();
        document.body.classList.remove('cardboard');
        start('mono');
      });

      btnvr.addEventListener('click', async ()=>{
        await resumeAudio();
        document.body.classList.add('cardboard');
        start('cardboard');
      });

      btnstop.addEventListener('click', ()=>{
        window.dispatchEvent(new CustomEvent('hvr:stop'));
        location.reload();
      });

      // show gaze ring progress driven by engine (optional)
      window.addEventListener('hvr:gaze', (ev)=>{
        try{
          const p = Math.max(0, Math.min(1, (ev.detail && ev.detail.p) || 0));
          setGazeVar(p);
        }catch{}
      }, { passive:true });

      // shoot buttons in cardboard
      const sL = D.getElementById('btnShootL');
      const sR = D.getElementById('btnShootR');
      function shoot(){
        window.dispatchEvent(new CustomEvent('hvr:shoot', { detail:{ src:'btn' } }));
      }
      sL.addEventListener('click', shoot);
      sR.addEventListener('click', shoot);

      // retry/backhub
      const end = D.getElementById('hvr-end');
      D.getElementById('btn-retry').addEventListener('click', ()=>location.reload());
      D.getElementById('btn-backhub').addEventListener('click', ()=>{
        try{
          const u = new URL((new URL(location.href)).searchParams.get('hub') || './hub.html', location.href);
          u.searchParams.set('ts', String(Date.now()));
          location.href = u.toString();
        }catch{
          location.href = './hub.html';
        }
      });

      // engine will trigger this
      window.addEventListener('hvr:endui', (ev)=>{
        end.style.display = 'flex';
        try{
          const d = ev.detail || {};
          D.getElementById('end-score').textContent = String(d.scoreFinal ?? 0);
          D.getElementById('end-grade').textContent = String(d.grade ?? 'C');
          D.getElementById('end-combo').textContent = String(d.comboMax ?? 0);
          D.getElementById('end-miss').textContent  = String(d.misses ?? 0);
          D.getElementById('end-goals').textContent = String(d.goalsCleared ?? 0) + '/' + String(d.goalsTotal ?? 1);
          D.getElementById('end-minis').textContent = String(d.miniCleared ?? 0);
        }catch{}
      }, { passive:true });
    })();
  </script>
</body>
</html>
