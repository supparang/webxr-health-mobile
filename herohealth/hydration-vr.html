<!-- === /herohealth/hydration-vr/hydration-vr.html ===
Hydration Quest VR (LATEST PACK)
‚úÖ DOM targets on #hvr-layer (transformed playfield)
‚úÖ Bounds on #hvr-bounds (fixed viewport)
‚úÖ Includes: particles + water UI + fever UI + HUD binder + cloud logger
‚úÖ Start overlay (Play / Research)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --glass: blur(10px);
      --r: 18px;

      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.42);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(56,189,248,.10), transparent 55%),
                  radial-gradient(1000px 600px at 20% 30%, rgba(34,197,94,.10), transparent 50%),
                  radial-gradient(1000px 600px at 90% 30%, rgba(167,139,250,.08), transparent 45%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== fixed game viewport ===== */
    #hvr-bounds{
      position:fixed;
      inset:0;
      overflow:hidden;
      touch-action:none;
      -webkit-user-select:none;
      user-select:none;
    }

    /* ===== transformed playfield (targets move with it) ===== */
    #hvr-layer{
      position:absolute;
      inset:0;
      transform: translate3d(0,0,0);
      will-change: transform;
      pointer-events:none; /* targets have pointer-events:auto */
    }

    /* crosshair */
    #hvr-crosshair{
      position:fixed;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      z-index:9997;
      width:22px; height:22px;
      border-radius:999px;
      pointer-events:none;
      box-shadow:
        0 0 0 2px rgba(226,232,240,.55),
        0 0 16px rgba(56,189,248,.25);
      background: radial-gradient(circle, rgba(255,255,255,.72), rgba(255,255,255,.08));
      opacity:.92;
    }
    #hvr-crosshair:before, #hvr-crosshair:after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:3px; height:3px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 0 14px rgba(255,255,255,.35);
    }

    /* ===== HUD ===== */
    .hha-hud{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9990;
    }
    .hud-top{
      position:absolute;
      left:12px; right:12px; top:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .hud-bot{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow2);
      padding:10px 12px;
      pointer-events:none;
    }
    .card.tight{ padding:8px 10px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:6px; }
    .muted{ color:var(--muted); font-size:12px; }
    .big{
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.35);
      font-weight:700;
      font-size:13px;
    }

    /* Water bar */
    #hha-water-header{
      min-width: 220px;
    }
    .bar{
      height:12px;
      width:220px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(148,163,184,.15);
      border:1px solid rgba(148,163,184,.20);
      box-shadow: inset 0 6px 16px rgba(0,0,0,.35);
    }
    .bar > i{
      display:block;
      height:100%;
      width:50%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(56,189,248,.95));
      box-shadow: 0 0 18px rgba(56,189,248,.22);
      transition: width .12s linear;
    }

    /* Fever bar */
    .feverbar{
      height:10px;
      width:180px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(148,163,184,.14);
      border:1px solid rgba(148,163,184,.20);
      box-shadow: inset 0 6px 16px rgba(0,0,0,.35);
    }
    .feverbar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(167,139,250,.95), rgba(244,63,94,.95));
      box-shadow: 0 0 18px rgba(244,63,94,.20);
      transition: width .12s linear;
    }

    /* Quest */
    #hha-quest{
      min-width: 320px;
      max-width: 520px;
    }
    .quest-title{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
    }
    .quest-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .quest-progress{
      display:flex;
      gap:8px;
      margin-top:8px;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:rgba(226,232,240,.92);
    }
    .mini{
      margin-top:6px;
      padding:8px 10px;
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.28);
      background: rgba(2,6,23,.22);
    }
    .mini .mini-title{ font-weight:900; font-size:13px; }
    .mini .mini-sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    /* Coach */
    #hha-coach{
      display:flex;
      align-items:flex-end;
      gap:10px;
      max-width: 520px;
      pointer-events:none;
    }
    #hha-coach img{
      width:54px;
      height:54px;
      object-fit:contain;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }
    #hha-coach .bubble{
      flex:1;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      font-weight:800;
      line-height:1.25;
    }

    /* Start overlay */
    #hvr-start{
      position:fixed;
      inset:0;
      z-index:10000;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1000px 600px at 50% 30%, rgba(56,189,248,.10), transparent 55%),
                  rgba(2,6,23,.84);
      backdrop-filter: blur(10px);
    }
    .start-card{
      width:min(560px, calc(100vw - 24px));
      border-radius:24px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.70);
      box-shadow: 0 24px 80px rgba(0,0,0,.6);
      padding:18px;
    }
    .start-title{
      font-size:20px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .start-sub{
      margin-top:6px;
      color:rgba(226,232,240,.78);
      font-size:13px;
      line-height:1.35;
    }
    .btnrow{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
    button{
      pointer-events:auto;
      cursor:pointer;
      border:0;
      border-radius:16px;
      padding:10px 14px;
      font-weight:900;
      letter-spacing:.2px;
      color:#031019;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .btn-play{
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(56,189,248,.95));
    }
    .btn-research{
      background: linear-gradient(90deg, rgba(167,139,250,.95), rgba(244,63,94,.95));
      color:#0b1020;
    }
    .btn-ghost{
      background: rgba(148,163,184,.20);
      color: rgba(226,232,240,.92);
      border:1px solid rgba(148,163,184,.28);
      box-shadow:none;
    }

    /* End summary */
    #hvr-end{
      position:fixed;
      inset:0;
      z-index:10001;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(2,6,23,.80);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    .end-card{
      width:min(640px, calc(100vw - 24px));
      border-radius:26px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.62);
      padding:18px;
    }
    .end-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
      font-size:18px;
      letter-spacing:.2px;
    }
    .rank{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.22);
      font-weight:1000;
    }
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      padding:12px;
      border-radius:18px;
      background: rgba(2,6,23,.22);
      border:1px solid rgba(148,163,184,.18);
    }
    .kv b{ display:block; font-size:12px; color:rgba(226,232,240,.75); }
    .kv span{ display:block; margin-top:4px; font-size:18px; font-weight:1000; }
    .end-actions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; justify-content:flex-end; }

    /* FX helpers */
    .screen-hit{
      position:fixed; inset:0;
      z-index:9996;
      pointer-events:none;
      background: radial-gradient(700px 400px at 50% 52%, rgba(56,189,248,.10), transparent 60%),
                  radial-gradient(900px 500px at 50% 52%, rgba(255,255,255,.06), transparent 65%);
      opacity:0;
      transition: opacity .12s ease;
    }
    .screen-hit.on{ opacity:1; }

    .danger-vignette{
      position:fixed; inset:0;
      z-index:9995;
      pointer-events:none;
      box-shadow: inset 0 0 0 0 rgba(244,63,94,.0);
      transition: box-shadow .12s ease;
    }
    .danger-vignette.on{
      box-shadow: inset 0 0 0 999px rgba(244,63,94,.06), inset 0 0 120px rgba(244,63,94,.16);
    }

    /* Make targets clickable */
    #hvr-layer .hvr-target{ pointer-events:auto; }
  </style>

  <!-- Global FX + UI + HUD + Logger (order matters: these are IIFE) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-water.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
</head>

<body>
  <div id="hvr-bounds" aria-label="Hydration Bounds">
    <div id="hvr-layer" aria-label="Hydration Layer"></div>

    <div class="screen-hit" id="hvr-hitflash"></div>
    <div class="danger-vignette" id="hvr-vignette"></div>

    <div id="hvr-crosshair" aria-hidden="true"></div>

    <div class="hha-hud" aria-hidden="true">
      <div class="hud-top">
        <div class="card tight" id="hha-score-card">
          <div class="row">
            <div class="col">
              <div class="muted">SCORE</div>
              <div class="big" id="hha-score">0</div>
            </div>
            <div class="col">
              <div class="muted">COMBO</div>
              <div class="big" id="hha-combo">0</div>
            </div>
            <div class="col">
              <div class="muted">MISS</div>
              <div class="big" id="hha-miss">0</div>
            </div>
            <div class="col">
              <div class="muted">TIME</div>
              <div class="big" id="hha-time">60</div>
            </div>
          </div>
        </div>

        <div class="card" id="hha-water-header" data-hha-exclude="1">
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <div class="pill" id="hha-water-zone">üíß BALANCED</div>
            <div class="pill" id="hha-water-pct">50%</div>
          </div>
          <div class="bar hha-water-bar"><i id="hha-water-fill" style="width:50%"></i></div>
        </div>

        <div class="card" id="hha-fever-card" data-hha-exclude="1">
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <div class="pill" id="hha-fever-label">üî• FEVER</div>
            <div class="pill" id="hha-shield">üõ°Ô∏è OFF</div>
          </div>
          <div class="feverbar"><i id="hha-fever-fill" style="width:0%"></i></div>
        </div>

        <div class="card" id="hha-quest" data-hha-exclude="1">
          <div class="quest-title" id="hha-quest-title">GOAL</div>
          <div class="quest-sub" id="hha-quest-sub">‚Äî</div>
          <div class="quest-progress">
            <span id="hha-goal-count">0/0</span>
            <span class="muted" id="hha-mini-count">MINI 0/0</span>
          </div>
          <div class="mini" id="hha-mini-box" style="display:none">
            <div class="mini-title" id="hha-mini-title">MINI</div>
            <div class="mini-sub" id="hha-mini-sub">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="hud-bot">
        <div id="hha-coach">
          <img id="hha-coach-img" src="./img/coach-neutral.png" alt="Coach" />
          <div class="bubble" id="hha-coach-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏• üíß</div>
        </div>
        <div class="card tight" id="hha-debug" style="display:none"></div>
      </div>
    </div>

    <div id="hvr-start">
      <div class="start-card">
        <div class="start-title">Hydration Quest VR üíß</div>
        <div class="start-sub">
          ‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏ô‡πâ‡∏≥‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á ‚Äú‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏´‡∏ß‡∏≤‡∏ô/‡∏Ç‡∏¢‡∏∞‚Äù ‚úã<br/>
          <span class="muted">Tip: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ / ‡πÇ‡∏´‡∏°‡∏î VR-feel: ‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤ ‚Äú‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‚Äù</span>
        </div>
        <div class="btnrow">
          <button class="btn-play" id="btnPlay">PLAY MODE</button>
          <button class="btn-research" id="btnResearch">RESEARCH MODE</button>
          <button class="btn-ghost" id="btnCloseStart">CLOSE</button>
        </div>
      </div>
    </div>

    <div id="hvr-end">
      <div class="end-card">
        <div class="end-title">
          <span>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üéâ</span>
          <span class="rank" id="hvr-rank">RANK: A</span>
        </div>
        <div class="grid">
          <div class="kv"><b>SCORE</b><span id="hvr-end-score">0</span></div>
          <div class="kv"><b>MAX COMBO</b><span id="hvr-end-combo">0</span></div>
          <div class="kv"><b>MISS</b><span id="hvr-end-miss">0</span></div>
          <div class="kv"><b>GOAL / MINI</b><span id="hvr-end-quest">0/0 ‚Ä¢ 0/0</span></div>
        </div>
        <div class="end-actions">
          <button class="btn-play" id="btnReplay">REPLAY</button>
          <button class="btn-ghost" id="btnCloseEnd">CLOSE</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { bootHydration } from './hydration.safe.js';

    function q(id){ return document.getElementById(id); }

    const start = q('hvr-start');
    const end   = q('hvr-end');

    const btnPlay    = q('btnPlay');
    const btnResearch= q('btnResearch');
    const btnCloseStart = q('btnCloseStart');

    const btnReplay  = q('btnReplay');
    const btnCloseEnd= q('btnCloseEnd');

    function parseUrl(){
      const u = new URL(location.href);
      const p = u.searchParams;
      return {
        diff: p.get('diff') || 'normal',
        time: Number(p.get('time') || '60') || 60,
        run : (p.get('run') || 'play').toLowerCase(),
        seed: p.get('seed') || p.get('ts') || '',
      };
    }

    let lastCfg = null;
    let stopFn = null;

    function startGame(mode){
      // hide overlays
      start.style.display = 'none';
      end.style.display = 'none';

      // stop previous if any
      try{ if (stopFn) stopFn(); }catch{}
      stopFn = null;

      const url = parseUrl();
      lastCfg = {
        ...url,
        runMode: mode,
      };

      bootHydration({
        difficulty: (mode === 'research') ? url.diff : url.diff,
        duration: url.time,
        runMode: mode,
        seed: url.seed,
        onStop: (why) => {
          // external stop hook (optional)
        }
      }).then(api=>{
        stopFn = () => api && api.stop && api.stop();
      });
    }

    btnPlay.addEventListener('click', ()=> startGame('play'));
    btnResearch.addEventListener('click', ()=> startGame('research'));
    btnCloseStart.addEventListener('click', ()=>{ start.style.display='none'; });

    btnReplay.addEventListener('click', ()=> startGame((lastCfg && lastCfg.runMode) || 'play'));
    btnCloseEnd.addEventListener('click', ()=>{ end.style.display='none'; });

    // auto-start if run=play/research and autostart=1
    const u = new URL(location.href);
    if (u.searchParams.get('autostart') === '1'){
      startGame((u.searchParams.get('run') || 'play').toLowerCase());
    }
  </script>
</body>
</html>