<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <style>
    :root{
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --danger:#f97316;
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box;}
    html, body{
      margin:0; padding:0;
      background:var(--bg-main);
      color:var(--text-main);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
      height:100%;
      overflow:hidden; /* ‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á scroll */
      touch-action:none; /* ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR */
    }
    body{ -webkit-font-smoothing:antialiased; }

    #hvr-wrap{
      position:relative;
      height:100vh;
      padding:12px 10px 72px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .hha-water-bar{
      background:linear-gradient(135deg,#020617,#020617);
      border-radius:999px;
      padding:10px 16px;
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:40;
      backdrop-filter:blur(18px);
      box-shadow:0 14px 36px rgba(0,0,0,0.45);
      user-select:none;
    }
    .hha-water-bar-label{
      font-size:14px;
      color:var(--text-soft);
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .hha-water-bar-label span.emoji{ font-size:17px; }
    .hha-water-bar-status{ margin-left:auto; font-size:14px; }
    .hha-water-bar-fill{
      flex:1 1 auto;
      height:8px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .hha-water-bar-fill-inner{
      height:100%;
      width:50%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#4ade80);
      transition:width .25s ease;
    }

    .hha-main-row{
      display:flex;
      gap:10px;
      margin-top:2px;
      z-index:40;
    }
    .hha-card{
      background:radial-gradient(circle at top left,#0b1120,#020617 60%);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.25);
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(15,23,42,0.85);
      min-width:0;
      user-select:none;
    }
    .hha-card-left{ flex:1.15 1 0; }
    .hha-card-right{ flex:1 1 0; }

    .hha-title{
      font-size:15px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:2px;
    }
    .hha-mode{
      font-size:20px;
      font-weight:600;
      margin-bottom:6px;
    }

    .hha-pill-row{
      display:flex;
      gap:8px;
      margin:6px 0 10px;
      flex-wrap:wrap;
    }
    .hha-pill{
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,0.4);
      color:var(--text-soft);
    }
    .hha-pill-primary{
      border-color:rgba(56,189,248,0.8);
      color:#e0f2fe;
    }
    .hha-pill-diff{
      border-color:rgba(34,197,94,0.8);
      color:#bbf7d0;
    }

    .hha-score-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-top:6px;
      gap:10px;
    }
    .hha-score-block{ font-size:13px; }
    .hha-score-block strong{
      display:block;
      font-size:26px;
      line-height:1.1;
    }
    .hha-score-label{
      font-size:12px;
      color:var(--text-soft);
      margin-top:2px;
    }

    .hha-grade{
      text-align:right;
      font-size:12px;
      color:var(--text-soft);
      min-width:156px;
    }
    .hha-grade span.badge{
      display:inline-block;
      min-width:44px;
      text-align:center;
      padding:4px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.4);
      margin-left:6px;
    }
    .hha-grade-progress{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      font-size:11px;
      color:var(--text-soft);
    }
    .hha-grade-progress .bar{
      width:140px;
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:inset 0 2px 10px rgba(0,0,0,0.55);
    }
    .hha-grade-progress .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#4ade80);
      transition:width .25s ease;
    }

    .hha-quest-title{
      font-size:14px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    .hha-quest-main{
      font-size:16px;
      font-weight:600;
      margin-bottom:4px;
      line-height:1.35;
    }
    .hha-quest-mini{
      font-size:14px;
      color:var(--text-soft);
      margin-bottom:6px;
      line-height:1.35;
    }
    .hha-quest-progress{
      font-size:13px;
      color:var(--text-soft);
      margin-top:4px;
    }
    .hha-quest-progress strong{ color:var(--accent); }

    /* PLAYFIELD */
    #hvr-playfield{
      position:absolute;
      inset:0;
      z-index:30;
      overflow:hidden;
      transform:translate3d(0,0,0);
      will-change:transform;
      pointer-events:none;
    }
    .hvr-target{
      pointer-events:auto;
      position:absolute;
      transform:translate(-50%,-50%);
      border-radius:999px;
      border:2px solid rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#f9fafb;
      user-select:none;
      cursor:pointer;
      z-index:35;
      touch-action:manipulation;
    }

    /* Crosshair */
    .hvr-crosshair{
      position:absolute;
      left:50%;
      top:56%;
      transform:translate(-50%,-50%);
      width:52px;
      height:52px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,0.9);
      box-shadow:0 0 0 1px rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(148,163,184,0.92);
      font-size:18px;
      pointer-events:none;
      z-index:60;
      backdrop-filter:blur(8px);
      background:radial-gradient(circle at 30% 30%,rgba(15,23,42,0.9),rgba(15,23,42,0.4));
      user-select:none;
    }
    .hvr-crosshair.ping{ animation:hvrPing 90ms ease-out 1; }
    @keyframes hvrPing{
      0%{ transform:translate(-50%,-50%) scale(1); }
      40%{ transform:translate(-50%,-50%) scale(0.90); }
      100%{ transform:translate(-50%,-50%) scale(1); }
    }

    /* Coach */
    .hha-coach-wrap{ margin-top:auto; z-index:40; user-select:none; }
    .hha-coach-bubble{
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top left,#064e3b,#022c22);
      border:1px solid rgba(34,197,94,0.5);
      color:#dcfce7;
      box-shadow:0 14px 32px rgba(6,95,70,0.7);
    }
    .hha-coach-avatar{
      width:40px;
      height:40px;
      border-radius:999px;
      overflow:hidden;
      background:#064e3b;
      flex-shrink:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
    }
    .hha-coach-text{ font-size:14px; line-height:1.45; }
    .hha-coach-name{ font-weight:700; margin-bottom:2px; }

    /* Bottom */
    .hha-bottom-row{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:8px 12px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      z-index:45;
      pointer-events:none;
    }
    .hha-bottom-row > *{ pointer-events:auto; }

    .hha-fever-card{
      flex:1 1 auto;
      border-radius:var(--radius-lg);
      background:radial-gradient(circle at top left,#020617,#020617 65%);
      border:1px solid rgba(148,163,184,0.4);
      padding:8px 10px 9px;
      font-size:12px;
      color:var(--text-soft);
      box-shadow:0 14px 32px rgba(15,23,42,0.95);
      user-select:none;
    }
    .hha-fever-label{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .hha-fever-label span.emoji{ font-size:16px; }
    .hha-fever-bar{
      height:8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      overflow:hidden;
      position:relative;
    }
    .hha-fever-bar-inner{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#f97316,#fb923c,#facc15);
      transition:width .2s ease-out;
    }
    .hha-fever-extra{
      font-size:11px;
      margin-top:5px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:var(--text-soft);
    }

    .hha-btn-vr{
      flex:0 0 auto;
      min-width:156px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      padding:10px 14px;
      background:radial-gradient(circle at top left,#020617,#020617 70%);
      color:#e5e7eb;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-decoration:none;
      box-shadow:0 14px 32px rgba(15,23,42,0.95);
      user-select:none;
    }
    .hha-btn-vr span.emoji{ font-size:18px; }

    /* Blink layer */
    .hvr-screen-blink{
      position:absolute;
      inset:0;
      z-index:9999;
      pointer-events:none;
      opacity:0;
      transition: opacity .06s ease;
      mix-blend-mode: screen;
    }
    .hvr-screen-blink.on{ opacity:1; }
    .hvr-screen-blink.good{
      background: radial-gradient(circle at 50% 56%, rgba(34,197,94,.35), rgba(34,197,94,0) 60%);
    }
    .hvr-screen-blink.bad{
      background: radial-gradient(circle at 50% 56%, rgba(249,115,22,.38), rgba(249,115,22,0) 60%);
    }
    .hvr-screen-blink.block{
      background: radial-gradient(circle at 50% 56%, rgba(96,165,250,.35), rgba(96,165,250,0) 60%);
    }

    @media (min-width:900px){
      #hvr-wrap{ max-width:1100px; margin:0 auto; }
    }
    @media (max-width:720px){
      .hha-main-row{ flex-direction:column; }
      .hha-grade{ min-width:0; }
      .hha-grade-progress .bar{ width:120px; }
      .hha-btn-vr{ min-width:132px; }
    }

    /* ===== END SCREEN ===== */
    .hvr-end{
      position:fixed;
      inset:0;
      z-index:99999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(2,6,23,.68);
      backdrop-filter:blur(14px);
    }
    .hvr-end.on{ display:flex; }

    .hvr-end-card{
      width:min(720px, 96vw);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.35);
      background:radial-gradient(circle at top left,#0b1120,#020617 70%);
      box-shadow:0 30px 80px rgba(0,0,0,.65);
      padding:16px;
    }

    .hvr-end-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hvr-end-title{ font-size:18px; font-weight:800; }
    .hvr-end-sub{ font-size:12px; color:var(--text-soft); }
    .hvr-end-badge{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.85);
      font-weight:900;
      letter-spacing:.05em;
      user-select:none;
    }

    .hvr-end-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){ .hvr-end-grid{ grid-template-columns:1fr; } }

    .hvr-end-box{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.55);
      padding:12px;
    }
    .hvr-end-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:6px 0;
      color:var(--text-soft);
    }
    .hvr-end-row strong{ color:var(--text-main); }

    .hvr-end-list{
      margin:8px 0 0;
      padding-left:18px;
      color:var(--text-soft);
      font-size:13px;
    }
    .hvr-end-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .hvr-end-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      padding:10px 14px;
      background:rgba(15,23,42,.85);
      color:var(--text-main);
      text-decoration:none;
      font-weight:700;
      user-select:none;
    }
    .hvr-end-btn.primary{
      border-color:rgba(34,197,94,.65);
      background:rgba(34,197,94,.18);
    }
  </style>
</head>

<body>
  <div id="hvr-wrap">

    <header class="hha-water-bar" id="hha-water-header">
      <div class="hha-water-bar-label">
        <span class="emoji">üíß</span>
        <span>Water balance</span>
      </div>

      <div class="hha-water-bar-fill">
        <div class="hha-water-bar-fill-inner" id="hha-water-fill"></div>
      </div>

      <div class="hha-water-bar-status" id="hha-water-status">GREEN 50%</div>
    </header>

    <section class="hha-main-row">
      <article class="hha-card hha-card-left" id="hha-card-left">
        <div class="hha-title">HERO HEALTH ‚Ä¢ HYDRATION VR</div>
        <div class="hha-mode" id="hha-mode-label">Hydration Quest</div>

        <div class="hha-pill-row">
          <div class="hha-pill hha-pill-primary" id="hha-mode-pill">PLAY MODE</div>
          <div class="hha-pill hha-pill-diff" id="hha-diff-pill">EASY ‚Ä¢ 90s</div>
        </div>

        <div class="hha-score-row">
          <div class="hha-score-block">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            <strong id="hha-score-main">0</strong>
            <div class="hha-score-label">
              ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:
              <span id="hha-combo-max">0</span>
            </div>
          </div>

          <div class="hha-score-block">
            ‡∏û‡∏•‡∏≤‡∏î
            <strong id="hha-miss">0</strong>
            <div class="hha-score-label">
              ‡∏ô‡πâ‡∏≥‡πÇ‡∏ã‡∏ô:
              <span id="hha-water-zone-text">GREEN</span>
            </div>
          </div>

          <div class="hha-grade">
            ‡πÄ‡∏Å‡∏£‡∏î (REAL-TIME)
            <span class="badge" id="hha-grade-badge">C</span>

            <div class="hha-grade-progress">
              <span id="hha-grade-progress-text">Progress to S (30%): 0%</span>
              <span class="bar"><div id="hha-grade-progress-fill"></div></span>
            </div>
          </div>
        </div>
      </article>

      <article class="hha-card hha-card-right" id="hha-card-right">
        <div class="hha-quest-title">QUEST</div>
        <div class="hha-quest-main" id="hha-quest-goal">Goal: ‡πÇ‡∏ã‡∏ô‡∏ô‡πâ‡∏≥‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</div>
        <div class="hha-quest-mini" id="hha-quest-mini">Mini: ‡∏™‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</div>

        <div class="hha-quest-progress">
          Goal:
          <strong><span id="hha-goal-done">0</span>/<span id="hha-goal-total">2</span></strong>
        </div>
        <div class="hha-quest-progress">
          Mini quest:
          <strong><span id="hha-mini-done">0</span>/<span id="hha-mini-total">3</span></strong>
        </div>
      </article>
    </section>

    <main id="hvr-playfield"></main>

    <div id="hvr-crosshair" class="hvr-crosshair">‚óã</div>

    <section class="hha-coach-wrap">
      <div class="hha-coach-bubble" id="hha-coach-bubble">
        <div class="hha-coach-avatar">üíß</div>
        <div class="hha-coach-text">
          <div class="hha-coach-name">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div id="hha-coach-text">‡∏•‡∏≤‡∏Å‡∏à‡∏≠ = ‡∏°‡∏≠‡∏á‡∏£‡∏≠‡∏ö ‡πÜ ‚Ä¢ ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ = ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏á ‚óã ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏° GREEN!</div>
        </div>
      </div>
    </section>

    <div class="hha-bottom-row">
      <div class="hha-fever-card">
        <div class="hha-fever-label">
          <span class="emoji">üî•</span>
          <span>FEVER GAUGE</span>
        </div>
        <div class="hha-fever-bar">
          <div class="hha-fever-bar-inner" id="hha-fever-fill"></div>
        </div>
        <div class="hha-fever-extra">
          <span>‡πÄ‡∏Å‡∏£‡∏≤‡∏∞: <span id="hha-shield-count">0</span></span>
          <span id="hha-fever-percent">0%</span>
        </div>
      </div>

      <a href="#" id="hha-btn-vr" class="hha-btn-vr">
        <span class="emoji">üï∂Ô∏è</span>
        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</span>
      </a>
    </div>

    <div id="hvr-screen-blink" class="hvr-screen-blink" aria-hidden="true"></div>
  </div>

  <!-- ‚úÖ END SCREEN (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å <script> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!) -->
  <div id="hvr-end" class="hvr-end" aria-hidden="true">
    <div class="hvr-end-card">
      <div class="hvr-end-head">
        <div>
          <div class="hvr-end-title">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Hydration Quest</div>
          <div class="hvr-end-sub" id="hvr-end-sub">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ Goal & Mini</div>
        </div>
        <div class="hvr-end-badge" id="hvr-end-grade">C</div>
      </div>

      <div class="hvr-end-grid">
        <div class="hvr-end-box">
          <div class="hvr-end-row"><span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span><strong id="hvr-end-score">0</strong></div>
          <div class="hvr-end-row"><span>‡∏û‡∏•‡∏≤‡∏î</span><strong id="hvr-end-miss">0</strong></div>
          <div class="hvr-end-row"><span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span><strong id="hvr-end-combo">0</strong></div>
          <div class="hvr-end-row"><span>Water Zone</span><strong id="hvr-end-zone">GREEN</strong></div>
          <div class="hvr-end-row"><span>‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô GREEN</span><strong id="hvr-end-green">0s</strong></div>
        </div>

        <div class="hvr-end-box">
          <div class="hvr-end-row"><span>Goal</span><strong id="hvr-end-goal">0/2</strong></div>
          <div class="hvr-end-row"><span>Mini Quest</span><strong id="hvr-end-mini">0/3</strong></div>
          <div class="hvr-end-row"><span>Progress</span><strong id="hvr-end-prog">0%</strong></div>
          <div class="hvr-end-row"><span>Fever</span><strong id="hvr-end-fever">0%</strong></div>
          <div class="hvr-end-row"><span>Shield</span><strong id="hvr-end-shield">0</strong></div>

          <div style="margin-top:8px;color:var(--text-soft);font-size:12px">üéÅ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</div>
          <ul class="hvr-end-list" id="hvr-end-rewards"></ul>
        </div>
      </div>

      <div class="hvr-end-actions">
        <a class="hvr-end-btn" href="./hub.html">‡∏Å‡∏•‡∏±‡∏ö HUB</a>
        <a class="hvr-end-btn primary" id="hvr-end-retry" href="#">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</a>
      </div>
    </div>
  </div>

  <!-- ===== Scripts (global HUD / FX) ===== -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>
  <script src="./vr/hha-hud.js"></script>

  <!-- ===== Boot Hydration VR ===== -->
  <script type="module">
    import { boot as hydrationBoot } from './hydration-vr/hydration.safe.js';

    const $ = (id)=>document.getElementById(id);

    function parseQuery() {
      const url = new URL(window.location.href);
      const diff = (url.searchParams.get('diff') || 'easy').toLowerCase();
      let time = parseInt(url.searchParams.get('time') || '90', 10);
      if (!Number.isFinite(time) || time <= 0) time = 90;
      if (time < 20) time = 20;
      if (time > 180) time = 180;
      return { diff, time, url };
    }

    function setDiffPill(diff, time){
      const diffPill = $('hha-diff-pill');
      if (diffPill) diffPill.textContent = `${diff.toUpperCase()} ‚Ä¢ ${time}s`;
    }

    // feedback
    function vibrate(pattern){
      try{ if (navigator && typeof navigator.vibrate === 'function') navigator.vibrate(pattern); }catch{}
    }
    function screenBlink(kind){
      const el = $('hvr-screen-blink');
      if (!el) return;
      el.classList.remove('good','bad','block','on');
      el.classList.add(kind || 'good');
      void el.offsetWidth;
      el.classList.add('on');
      setTimeout(()=> el.classList.remove('on'), 90);
    }
    function ping(){
      const c = $('hvr-crosshair');
      if (!c) return;
      c.classList.remove('ping');
      void c.offsetWidth;
      c.classList.add('ping');
    }

    // ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair
    function elementAtCrosshair(){
      const c = $('hvr-crosshair');
      if(!c) return null;
      const r = c.getBoundingClientRect();
      const x = r.left + r.width/2;
      const y = r.top  + r.height/2;
      const el = document.elementFromPoint(x, y);
      if (!el) return null;
      return el.closest ? el.closest('.hvr-target') : null;
    }

    const FIRE_COOLDOWN = 140;
    let lastFireAt = 0;

    function fire(){
      const now = Date.now();
      if (now - lastFireAt < FIRE_COOLDOWN) return;
      lastFireAt = now;

      ping();
      const tgt = elementAtCrosshair();
      if (!tgt){
        vibrate(10);
        return;
      }

      const isBad = tgt.classList.contains('bad');
      screenBlink(isBad ? 'bad' : 'good');
      vibrate(isBad ? [18,28,18] : 14);

      try{
        tgt.dispatchEvent(new PointerEvent('pointerdown', {
          bubbles:true,
          cancelable:true,
          clientX: (window.innerWidth/2)|0,
          clientY: (window.innerHeight/2)|0
        }));
      }catch{
        try{ tgt.click(); }catch{}
      }
    }

    function bindCrosshairControls(){
      document.addEventListener('pointerdown', (e)=>{
        // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î end screen
        if (document.getElementById('hvr-end')?.classList.contains('on')) return;

        // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‚Üí ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏±‡∏ö
        const t = e.target && e.target.closest ? e.target.closest('.hvr-target') : null;
        if (t){
          const isBad = t.classList.contains('bad');
          screenBlink(isBad ? 'bad' : 'good');
          vibrate(isBad ? [18,28,18] : 14);
          return;
        }

        // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°/‡∏Å‡∏≤‡∏£‡πå‡∏î
        if (e.target && e.target.closest && e.target.closest('a,button,.hha-btn-vr,.hha-card,.hha-water-bar')) return;

        fire();
      }, { passive:true });

      window.addEventListener('keydown', (e)=>{
        if (e.code === 'Space') { e.preventDefault(); fire(); }
      });
    }

    // ‚úÖ Drag look: ‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏°‡∏≠‡∏á‚Äù ‡πÅ‡∏•‡πâ‡∏ß playfield/‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô VR)
    function bindDragLook(){
      const pf = $('hvr-playfield');
      if (!pf) return;

      let down = false;
      let sx=0, sy=0;
      let ox=0, oy=0;
      let vx=0, vy=0;
      let last=0;

      const MAX_X = 240;
      const MAX_Y = 200;

      function apply(){
        pf.style.transform = `translate3d(${ox|0}px, ${oy|0}px, 0)`;
      }
      apply();

      function onDown(e){
        // ‡πÑ‡∏°‡πà‡∏•‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡πâ‡∏≤/‡∏õ‡∏∏‡πà‡∏°
        const hitT = e.target && e.target.closest ? e.target.closest('.hvr-target') : null;
        if (hitT) return;
        if (e.target && e.target.closest && e.target.closest('a,button,.hha-btn-vr')) return;
        if (document.getElementById('hvr-end')?.classList.contains('on')) return;

        down = true;
        sx = e.clientX; sy = e.clientY;
        vx = vy = 0;
        last = performance.now();
      }
      function onMove(e){
        if (!down) return;
        const now = performance.now();
        const dt = Math.max(1, now - last);
        last = now;

        const dx = e.clientX - sx;
        const dy = e.clientY - sy;

        // sensitivity
        const nx = dx * 0.9;
        const ny = dy * 0.9;

        // velocity (for inertia)
        vx = (nx - (ox)) / dt;
        vy = (ny - (oy)) / dt;

        ox = Math.max(-MAX_X, Math.min(MAX_X, nx));
        oy = Math.max(-MAX_Y, Math.min(MAX_Y, ny));
        apply();
      }
      function onUp(){
        if (!down) return;
        down = false;

        // inertia
        let ivx = vx * 60;
        let ivy = vy * 60;
        const decay = 0.92;

        function step(){
          ivx *= decay; ivy *= decay;
          ox = Math.max(-MAX_X, Math.min(MAX_X, ox + ivx));
          oy = Math.max(-MAX_Y, Math.min(MAX_Y, oy + ivy));
          apply();
          if (Math.abs(ivx) + Math.abs(ivy) > 0.8) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      window.addEventListener('pointerdown', onDown, { passive:true });
      window.addEventListener('pointermove', onMove, { passive:true });
      window.addEventListener('pointerup', onUp, { passive:true });
      window.addEventListener('pointercancel', onUp, { passive:true });
    }

    // ===== END SCREEN =====
    function showEndScreen(d){
      const end = $('hvr-end');
      if(!end) return;
      end.classList.add('on');
      end.setAttribute('aria-hidden','false');

      $('hvr-end-score').textContent = d.score ?? 0;
      $('hvr-end-miss').textContent  = d.miss ?? 0;
      $('hvr-end-combo').textContent = d.comboBest ?? 0;
      $('hvr-end-zone').textContent  = d.zone ?? '';
      $('hvr-end-green').textContent = (d.greenTick ?? 0) + 's';

      $('hvr-end-goal').textContent  = `${d.goalsDone ?? 0}/${d.goalsTotal ?? 0}`;
      $('hvr-end-mini').textContent  = `${d.minisDone ?? 0}/${d.minisTotal ?? 0}`;
      $('hvr-end-prog').textContent  = `${d.progPct ?? 0}%`;
      $('hvr-end-fever').textContent = `${d.fever ?? 0}%`;
      $('hvr-end-shield').textContent= `${d.shield ?? 0}`;

      $('hvr-end-grade').textContent = d.grade || 'C';
      $('hvr-end-sub').textContent   =
        `Goal ${d.goalsDone ?? 0}/${d.goalsTotal ?? 0} ‚Ä¢ Mini ${d.minisDone ?? 0}/${d.minisTotal ?? 0}`;

      const ul = $('hvr-end-rewards');
      if (ul){
        ul.innerHTML = '';
        const arr = (d.rewards && Array.isArray(d.rewards.bonuses)) ? d.rewards.bonuses : [];
        if (!arr.length){
          const li = document.createElement('li');
          li.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©';
          ul.appendChild(li);
        } else {
          arr.slice(0, 10).forEach(t=>{
            const li = document.createElement('li');
            li.textContent = t;
            ul.appendChild(li);
          });
        }
      }

      // ‡∏â‡∏•‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏Å ‡πÜ ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ particles.js celebrate)
      try{
        if (window.Particles && typeof window.Particles.celebrate === 'function') {
          window.Particles.celebrate('allComplete');
          window.Particles.celebrate('allComplete');
          window.Particles.celebrate('allComplete');
        }
      }catch{}
      screenBlink('good');
      vibrate([40,60,40,60,40]);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const { diff, time, url } = parseQuery();
      setDiffPill(diff, time);

      // retry = reload with same query (no cache bust)
      const retry = $('hvr-end-retry');
      if (retry){
        retry.addEventListener('click', (e)=>{
          e.preventDefault();
          window.location.href = url.toString();
        });
      }

      try{
        await hydrationBoot({ difficulty: diff, duration: time });
        bindCrosshairControls();
        bindDragLook();
      }catch(err){
        console.error('[HydrationVR] boot error', err);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î Hydration Quest ‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ path ‡πÑ‡∏ü‡∏•‡πå hydration.safe.js)');
      }

      // ‡∏£‡∏±‡∏ö event ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏à‡∏≤‡∏Å hydration.safe.js
      window.addEventListener('hha:end', (e)=>{
        const d = e?.detail || {};
        showEndScreen(d);
      }, { passive:true });
    });
  </script>
</body>
</html>
