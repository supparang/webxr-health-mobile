<!-- === /herohealth/hydration-vr.html ===
HydrationVR ‚Äî PRODUCTION HTML (PATH FIX + CARDBOARD SPLIT + TRUE STEREO PARALLAX + FAST GAZE)
‚úÖ FIX 404 paths: ./vr/* and ./hydration-vr/hydration.safe.js
‚úÖ Cardboard: 2 eyes (left/right split)
‚úÖ TRUE stereo parallax (per-target disparity heuristic; not just clone)
‚úÖ Gaze (Cardboard): dwell-to-shoot (faster + accurate)
‚úÖ Mini HUD pills + big SHOOT button in Cardboard
‚úÖ Keeps required IDs: #playfield, #hvr-layer, #water-bar/#water-pct/#water-zone etc.
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (optional) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- ‚úÖ FIXED PATHS (under /herohealth/) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.66);
      --panel2:rgba(15,23,42,.58);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);

      /* gaze progress 0..1 */
      --gazeProg:0;

      /* stereo strength (px) */
      --ipd: 9px; /* default, can override via ?ipd= */
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 25%, #0b1120 0%, #020617 60%, #020617 100%);
    }

    /* ===== Top HUD (compact pills) ===== */
    .hudTop{
      position:fixed; left:10px; right:10px;
      top: calc(var(--sat) + 10px);
      z-index:50;
      display:flex; gap:10px;
      justify-content:space-between; align-items:flex-start;
      pointer-events:none;
    }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(2,6,23,.58);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 16px 42px rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      font-weight:950;
      white-space:nowrap;
    }
    .k{ color:var(--muted); font-size:11px; font-weight:900; }
    .v{ font-size:14px; font-weight:1100; }
    .grade{ background: rgba(99,102,241,.10); border-color: rgba(99,102,241,.24); }
    .water{ background: rgba(34,211,238,.08); border-color: rgba(34,211,238,.22); }

    /* ===== Bottom HUD (cards) ===== */
    .hudBottom{
      position:fixed; left:10px; right:10px;
      bottom: calc(var(--sab) + 10px);
      z-index:50;
      display:flex; gap:10px;
      justify-content:space-between; align-items:flex-end;
      pointer-events:none;
    }
    .card{
      pointer-events:none;
      background: var(--panel);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      padding:10px 10px;
      min-width: 240px;
      max-width: min(520px, 48vw);
    }
    .card h3{ margin:0 0 6px; font-size:12px; letter-spacing:.2px; opacity:.95; }

    /* water gauge bar */
    .barWrap{ margin-top:6px; width:100%; height:10px; border-radius:999px; background: rgba(148,163,184,.12); overflow:hidden; }
    .bar{ height:100%; width:0%; border-radius:999px; transition: width .18s ease; }
    body.water-low  .bar{ background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.95)); box-shadow:0 0 14px rgba(34,211,238,.22); }
    body.water-green .bar{ background: linear-gradient(90deg, rgba(34,211,238,.92), rgba(34,197,94,.95)); box-shadow:0 0 14px rgba(34,197,94,.18); }
    body.water-high .bar{ background: linear-gradient(90deg, rgba(249,115,22,.95), rgba(239,68,68,.95)); box-shadow:0 0 16px rgba(239,68,68,.20); }

    .questLine{ margin: 3px 0; font-size:12px; font-weight:950; line-height:1.25; }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.45);
      color: var(--muted);
      font-weight:1000;
      margin-right:6px;
    }

    /* ===== Play area wrapper ===== */
    .stage{
      position:fixed; inset:0;
      padding-top: calc(var(--sat) + 56px);
      padding-bottom: calc(var(--sab) + 78px);
    }

    /* Cardboard wrap: two eyes */
    #cbWrap{
      position:absolute; inset:0;
      display:flex;
      gap:0;
    }
    .eye{
      flex:1;
      position:relative;
      overflow:hidden;
      border-left:1px solid rgba(148,163,184,.10);
      background: rgba(2,6,23,.18);
    }
    .eye:first-child{ border-left:none; }

    /* default (non-cardboard): show only left eye full width */
    body:not(.cardboard) .eye.right{ display:none; }
    body:not(.cardboard) .eye.left{ flex:1; width:100%; }

    /* playfield surface inside each eye */
    .pf{
      position:absolute; inset:10px;
      border-radius:22px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.06), 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
      touch-action: manipulation;
    }

    /* ‚úÖ Keep original id #playfield for the LEFT eye (safe.js expects this) */
    #playfield{ position:absolute; inset:0; }
    #hvr-layer, #hvr-layer-r{
      position:absolute; inset:0;
      pointer-events:none;
      will-change: transform;
    }

    /* Crosshair (each eye) */
    .xhair{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:14px; height:14px;
      border-radius:999px;
      pointer-events:none;
      z-index:20;
      box-shadow:
        0 0 0 2px rgba(229,231,235,.30),
        0 0 22px rgba(34,197,94,.12);
      background: rgba(229,231,235,.06);
      backdrop-filter: blur(6px);
    }
    .xhair::after{
      content:"";
      position:absolute; inset:4px;
      border-radius:999px;
      background: rgba(229,231,235,.45);
    }

    /* Gaze ring (progress) */
    .xhair::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:999px;
      background:
        conic-gradient(
          rgba(34,211,238,.85) calc(var(--gazeProg) * 360deg),
          rgba(148,163,184,.12) 0deg
        );
      -webkit-mask: radial-gradient(circle, transparent 62%, #000 64%);
              mask: radial-gradient(circle, transparent 62%, #000 64%);
      opacity: 0;
      transition: opacity .08s ease;
    }
    body.gazeOn .xhair::before{ opacity: .95; }

    /* ===== Start Overlay ===== */
    #start-overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,.75);
      z-index:200;
    }
    .startCard{
      width:min(560px, calc(100% - 24px));
      background: rgba(2,6,23,.88);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      text-align:left;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:flex-end; }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(34,197,94,.18);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn.secondary{ background: rgba(2,6,23,.55); }
    .btn.purple{ background: rgba(99,102,241,.18); }
    .btn:active{ transform: translateY(1px); }

    /* ===== Controls (Cardboard) ===== */
    #shootPad{
      position:fixed;
      left:50%;
      bottom: calc(var(--sab) + 10px);
      transform:translateX(-50%);
      z-index:80;
      display:none;
      pointer-events:auto;
    }
    body.cardboard #shootPad{ display:block; }
    #btnShoot{
      padding:14px 18px;
      border-radius:18px;
      font-size:16px;
      font-weight:1100;
      box-shadow:0 18px 44px rgba(0,0,0,.36);
      background: rgba(2,6,23,.72);
    }
    #btnShoot:active{ transform:translateY(1px); }

    /* Hide heavy HUD in cardboard */
    body.cardboard .hudBottom{ display:none; }

    /* center divider */
    body.cardboard::after{
      content:"";
      position:fixed;
      top:0; bottom:0;
      left:50%;
      width:1px;
      background: rgba(148,163,184,.14);
      z-index:10;
      pointer-events:none;
    }

    /* subtle eye inward shift (comfort) */
    body.cardboard .eye.left  .xhair{ transform: translate(calc(-50% + 2px), -50%); }
    body.cardboard .eye.right .xhair{ transform: translate(calc(-50% - 2px), -50%); }
  </style>
</head>

<body>
  <!-- HUD TOP (pill) -->
  <div class="hudTop">
    <div class="pillRow">
      <div class="pill"><span class="k">SCORE</span><span class="v" id="stat-score">0</span></div>
      <div class="pill"><span class="k">COMBO</span><span class="v" id="stat-combo">0</span></div>
      <div class="pill"><span class="k">MISS</span><span class="v" id="stat-miss">0</span></div>
      <div class="pill"><span class="k">TIME</span><span class="v" id="stat-time">‚Äî</span></div>
      <div class="pill grade"><span class="k">GRADE</span><span class="v" id="stat-grade">C</span></div>
    </div>

    <div class="pillRow">
      <div class="pill water"><span class="k">ZONE</span><span class="v" id="water-zone">‚Äî</span></div>
      <div class="pill water"><span class="k">WATER</span><span class="v" id="water-pct">0%</span></div>
      <div class="pill"><span class="k">SHIELD</span><span class="v" id="shield-count">0</span></div>
      <div class="pill"><span class="k">STORM</span><span class="v"><span id="storm-left">0</span>s</span></div>
    </div>
  </div>

  <!-- HUD BOTTOM (cards) -->
  <div class="hudBottom">
    <div class="card" style="min-width:280px">
      <h3>üíß Water Gauge</h3>
      <div class="barWrap"><div id="water-bar" class="bar" aria-valuemin="0" aria-valuemax="100"></div></div>
      <div class="questLine" style="margin-top:8px">
        <span class="tag">Tip</span><span style="color:var(--muted);font-weight:900">‡∏Ñ‡∏∏‡∏° GREEN ‡πÉ‡∏´‡πâ‡∏î‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞ Storm ‡∏Ñ‡πà‡∏≠‡∏¢ ‚Äú‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‚Äù</span>
      </div>
    </div>

    <div class="card" style="min-width:340px">
      <h3>üß© Quest</h3>
      <div class="questLine"><span class="tag">Goal</span><span id="quest-line1">‚Äî</span></div>
      <div class="questLine"><span class="tag">Progress</span><span id="quest-line2">‚Äî</span></div>
      <div class="questLine"><span class="tag">Mini</span><span id="quest-line3">‚Äî</span></div>
      <div class="questLine"><span class="tag">State</span><span id="quest-line4">‚Äî</span></div>
      <div class="questLine" style="margin-top:8px;color:var(--muted)">
        ‡∏¢‡∏¥‡∏á = ‡πÅ‡∏ï‡∏∞‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ / (Cardboard) ‡∏Å‡∏î SHOOT / (Gaze) ‡∏°‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á
      </div>
    </div>
  </div>

  <!-- PLAY STAGE -->
  <div class="stage">
    <div id="cbWrap">
      <!-- LEFT EYE (real game host) -->
      <div class="eye left">
        <div class="pf" id="pfL">
          <div id="playfield">
            <div id="hvr-layer"></div>
          </div>
          <div class="xhair" aria-hidden="true"></div>
        </div>
      </div>

      <!-- RIGHT EYE (stereo mirror + parallax) -->
      <div class="eye right">
        <div class="pf" id="pfR">
          <div id="playfieldR">
            <div id="hvr-layer-r" aria-hidden="true"></div>
          </div>
          <div class="xhair" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div id="start-overlay">
    <div class="startCard">
      <div style="font-size:18px;font-weight:1100">üíß Hydration VR</div>
      <div style="margin-top:6px; color:var(--muted); font-size:12px; font-weight:900; line-height:1.35">
        ‚úÖ FIX path ‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà 404) ‚Ä¢ Cardboard 2 ‡∏à‡∏≠ + ‚Äú‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏¥‡πÇ‡∏≠ parallax‚Äù ‡∏à‡∏£‡∏¥‡∏á<br>
        üéØ ‡∏¢‡∏¥‡∏á: ‡πÅ‡∏ï‡∏∞‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î SHOOT (Cardboard)<br>
        üëÅÔ∏è Gaze: ‡∏°‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ß‡∏á‡πÄ‡∏ï‡πá‡∏° ‚Üí ‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏ß+‡πÅ‡∏°‡πà‡∏ô)
      </div>
      <div class="btnRow">
        <button class="btn secondary" id="btnCardboard" type="button">üì¶ CARDBOARD</button>
        <button class="btn purple" id="btnGaze" type="button">üëÅÔ∏è GAZE: ON</button>
        <button class="btn secondary" id="btnStereo" type="button">üßø STEREO: ON</button>
        <button class="btn" id="btnStart" type="button">üöÄ START</button>
      </div>
    </div>
  </div>

  <!-- Cardboard shoot pad -->
  <div id="shootPad">
    <button class="btn" id="btnShoot" type="button">üéØ SHOOT</button>
  </div>

  <!-- ‚úÖ IMPORTANT: module path must be inside /herohealth/hydration-vr/ -->
  <script type="module" src="./hydration-vr/hydration.safe.js"></script>

  <script>
  (function(){
    'use strict';

    const D = document;
    const body = D.body;

    const btnStart = D.getElementById('btnStart');
    const btnCardboard = D.getElementById('btnCardboard');
    const btnGaze = D.getElementById('btnGaze');
    const btnStereo = D.getElementById('btnStereo');
    const startOverlay = D.getElementById('start-overlay');
    const btnShoot = D.getElementById('btnShoot');

    const pfL = D.getElementById('pfL');
    const layerL = D.getElementById('hvr-layer');
    const layerR = D.getElementById('hvr-layer-r');

    function clamp(v,a,b){ v = Number(v)||0; return Math.max(a, Math.min(b, v)); }

    // --- audio unlock (mobile) ---
    async function resumeAudio(){
      try{
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        const ctx = new AC();
        if (ctx.state === 'suspended') await ctx.resume();
        await ctx.close();
      }catch(e){}
    }

    // --- fire: simulate a center tap on LEFT playfield (fast + consistent) ---
    let fireCd = 0;
    function fire(){
      const now = performance.now();
      if (now < fireCd) return;
      fireCd = now + 95; // ‚úÖ faster than before

      try{
        const r = pfL.getBoundingClientRect();
        const x = Math.round(r.left + r.width/2);
        const y = Math.round(r.top + r.height/2);

        const evDown = new PointerEvent('pointerdown', { bubbles:true, cancelable:true, clientX:x, clientY:y, pointerType:'touch' });
        const evUp   = new PointerEvent('pointerup',   { bubbles:true, cancelable:true, clientX:x, clientY:y, pointerType:'touch' });
        pfL.dispatchEvent(evDown);
        pfL.dispatchEvent(evUp);

        pfL.click();
      }catch(e){}
    }

    // --- cardboard toggle ---
    function setCardboard(on){
      on = !!on;
      body.classList.toggle('cardboard', on);
      // in cardboard we typically want stereo
      if (on) setStereo(true);
    }

    // --- gaze toggle ---
    let gazeOn = true;
    let dwellMs = 260;          // ‚úÖ faster
    let cooldownMs = 120;       // ‚úÖ snappier
    let gazeT = 0;
    let lastTarget = null;
    let lastTick = performance.now();
    let gazeCooldownUntil = 0;

    function setGaze(on){
      gazeOn = !!on;
      body.classList.toggle('gazeOn', gazeOn);
      btnGaze.textContent = gazeOn ? 'üëÅÔ∏è GAZE: ON' : 'üëÅÔ∏è GAZE: OFF';
      gazeT = 0; lastTarget = null;
      D.documentElement.style.setProperty('--gazeProg', '0');
    }

    // --- stereo toggle + strength ---
    let stereoOn = true;
    let ipdPx = 9;

    function setStereo(on){
      stereoOn = !!on;
      btnStereo.textContent = stereoOn ? 'üßø STEREO: ON' : 'üßø STEREO: OFF';
    }
    function setIPD(px){
      ipdPx = clamp(px, 0, 22);
      D.documentElement.style.setProperty('--ipd', ipdPx.toFixed(2) + 'px');
    }

    // --- Mirror map (src element -> mirror element) ---
    const mirrorMap = new WeakMap();

    function ensureMirrorNode(src){
      let m = mirrorMap.get(src);
      if (m && m.isConnected) return m;
      m = src.cloneNode(true);
      mirrorMap.set(src, m);
      return m;
    }

    // --- heuristics: compute disparity for a target (true parallax-ish) ---
    // idea: bigger target = "closer" => larger disparity; smaller = "far" => smaller disparity
    function disparityFor(srcEl){
      try{
        const r = srcEl.getBoundingClientRect();
        const size = Math.max(10, Math.min(220, (r.width + r.height) * 0.5));
        // map size -> depth factor (0..1)
        // small -> 0.25, medium -> 0.6, large -> 1.0
        const t = clamp((size - 18) / 86, 0, 1);
        const depth = 0.25 + 0.75 * t;
        return ipdPx * depth;
      }catch(e){
        return ipdPx * 0.65;
      }
    }

    // apply stereo shift for mirrored node (RIGHT eye)
    function applyStereoShift(src, mirror){
      if (!stereoOn) {
        // remove our injected translate if present
        mirror.style.transform = src.style.transform || '';
        return;
      }

      const dx = disparityFor(src);
      const base = src.style.transform || '';
      // Append an extra translateX for RIGHT eye (negative = shift left)
      // (Left eye stays as-is; Right eye gets -dx)
      // Add translate3d at end to preserve existing transforms.
      mirror.style.transform = (base ? base + ' ' : '') + `translate3d(${-dx}px,0,0)`;
    }

    function copyCore(s, d){
      // style/class/text/dataset (keep fast)
      if (d.className !== s.className) d.className = s.className;
      if (d.textContent !== s.textContent) d.textContent = s.textContent;

      // copy inline style but we override transform for stereo
      if (d.getAttribute('style') !== s.getAttribute('style')) d.setAttribute('style', s.getAttribute('style') || '');

      // dataset
      const sd = s.dataset || {};
      const dd = d.dataset || {};
      for (const k of Object.keys(sd)){
        if (dd[k] !== sd[k]) dd[k] = sd[k];
      }
    }

    // --- Mirror sync: clone LEFT targets into RIGHT + apply stereo disparity ---
    function syncMirrorTree(){
      if (!body.classList.contains('cardboard')){
        if (layerR.childNodes.length) layerR.innerHTML = '';
        return;
      }

      const srcKids = Array.from(layerL.children);

      // quick rebuild if big mismatch
      if (layerR.children.length !== srcKids.length){
        layerR.innerHTML = '';
        for (const s of srcKids){
          const m = ensureMirrorNode(s);
          copyCore(s, m);
          applyStereoShift(s, m);
          layerR.appendChild(m);
        }
        return;
      }

      // per index sync
      for (let i=0; i<srcKids.length; i++){
        const s = srcKids[i];
        let d = layerR.children[i];
        const m = ensureMirrorNode(s);

        if (!d){
          copyCore(s, m);
          applyStereoShift(s, m);
          layerR.appendChild(m);
          continue;
        }

        // if tag differs -> replace
        if (d.tagName !== m.tagName){
          copyCore(s, m);
          applyStereoShift(s, m);
          d.replaceWith(m);
          d = m;
        } else {
          copyCore(s, d);
          applyStereoShift(s, d);
        }
      }
    }

    // --- find target under gaze point (center of LEFT eye) ---
    function pickTargetAtCenter(){
      const r = pfL.getBoundingClientRect();
      const x = Math.round(r.left + r.width/2);
      const y = Math.round(r.top + r.height/2);
      const el = D.elementFromPoint(x, y);
      if (!el) return null;

      const t =
        el.closest('#hvr-layer [data-kind]') ||
        el.closest('#hvr-layer [data-role="target"]') ||
        el.closest('#hvr-layer .target') ||
        el.closest('#hvr-layer .hha-target') ||
        null;

      return t;
    }

    function gazeLoop(now){
      const dt = Math.min(0.05, Math.max(0.001, (now - lastTick)/1000));
      lastTick = now;

      // keep mirror updated
      syncMirrorTree();

      if (body.classList.contains('cardboard') && gazeOn){
        const t = pickTargetAtCenter();
        if (now < gazeCooldownUntil){
          D.documentElement.style.setProperty('--gazeProg', '0');
        } else if (!t){
          gazeT = 0;
          lastTarget = null;
          D.documentElement.style.setProperty('--gazeProg', '0');
        } else {
          if (t !== lastTarget){
            lastTarget = t;
            gazeT = 0;
          }
          gazeT += dt * 1000;
          const prog = clamp(gazeT / dwellMs, 0, 1);
          D.documentElement.style.setProperty('--gazeProg', String(prog));

          if (prog >= 1){
            fire();
            gazeCooldownUntil = now + cooldownMs;
            gazeT = 0;
            D.documentElement.style.setProperty('--gazeProg', '0');
          }
        }
      } else {
        D.documentElement.style.setProperty('--gazeProg', '0');
      }

      requestAnimationFrame(gazeLoop);
    }
    requestAnimationFrame(gazeLoop);

    // --- buttons ---
    btnCardboard.addEventListener('click', async ()=>{
      await resumeAudio();
      setCardboard(!body.classList.contains('cardboard'));
      if (body.classList.contains('cardboard')) setGaze(true);
    });

    btnGaze.addEventListener('click', async ()=>{
      await resumeAudio();
      setGaze(!gazeOn);
    });

    btnStereo.addEventListener('click', async ()=>{
      await resumeAudio();
      setStereo(!stereoOn);
    });

    btnShoot.addEventListener('click', async ()=>{
      await resumeAudio();
      fire();
    });

    btnStart.addEventListener('click', async ()=>{
      await resumeAudio();
      startOverlay.style.display = 'none';
    });

    // --- defaults & URL params ---
    setGaze(true);
    setStereo(true);
    setIPD(9);

    try{
      const u = new URL(location.href);
      if (u.searchParams.get('cardboard') === '1') setCardboard(true);

      const g = u.searchParams.get('gaze');
      if (g === '0') setGaze(false);
      if (g === '1') setGaze(true);

      const st = u.searchParams.get('stereo');
      if (st === '0') setStereo(false);
      if (st === '1') setStereo(true);

      const dwell = Number(u.searchParams.get('gazedwell'));
      if (Number.isFinite(dwell) && dwell >= 150 && dwell <= 1200) dwellMs = dwell;

      const ipd = Number(u.searchParams.get('ipd'));
      if (Number.isFinite(ipd) && ipd >= 0 && ipd <= 22) setIPD(ipd);
    }catch(e){}
  })();
  </script>
</body>
</html>