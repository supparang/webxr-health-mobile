<!-- === /herohealth/hydration-vr.html ===
Hydration Quest VR (PLAY MODE) ‚Äî Full HTML (UPDATED: prettier targets-ready + 2-layer parallax + wobble/chroma hooks)
‚úÖ bind ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô import
‚úÖ ‡πÉ‡∏ä‡πâ hydration-vr/hydration.safe.js
‚úÖ goHub -> ./hub.html
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --good:#22c55e;
      --bad:#ef4444;
      --block:#60a5fa;
      --warn:#f59e0b;
      --shadow:0 18px 55px rgba(0,0,0,.55);
      --radius:18px;
      --pill:999px;

      /* parallax pointer */
      --px:0;
      --py:0;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 700px at 20% 30%, rgba(96,165,250,.14), transparent 55%),
                  radial-gradient(800px 700px at 80% 35%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", Arial, sans-serif;
      overflow:hidden;
    }

    /* Main wrapper (shake applies here) */
    #hvr-wrap{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
    }

    /* ===== 2-layer parallax background (behind playfield) ===== */
    .hvr-bg{
      position:absolute;
      inset:-6%;
      z-index:0;
      pointer-events:none;
      transform: translate3d(calc(var(--px) * 1px), calc(var(--py) * 1px), 0);
      transition: transform 90ms ease-out;
      will-change: transform;
      opacity:.95;
    }
    #hvr-bg1{
      filter: blur(.1px);
      opacity:.55;
      transform: translate3d(calc(var(--px) * 0.6px), calc(var(--py) * 0.6px), 0);
      background:
        radial-gradient(circle at 18% 30%, rgba(34,197,94,.22), transparent 54%),
        radial-gradient(circle at 78% 38%, rgba(96,165,250,.18), transparent 58%),
        radial-gradient(circle at 62% 78%, rgba(245,158,11,.10), transparent 62%),
        radial-gradient(circle at 30% 75%, rgba(167,139,250,.10), transparent 64%);
    }
    #hvr-bg2{
      opacity:.30;
      transform: translate3d(calc(var(--px) * 1.15px), calc(var(--py) * 1.15px), 0);
      background:
        radial-gradient(circle at 20% 35%, rgba(255,255,255,.08), transparent 55%),
        repeating-radial-gradient(circle at 22% 36%,
          rgba(148,163,184,.10) 0 1px,
          transparent 1px 18px),
        linear-gradient(180deg, rgba(2,6,23,.10), rgba(2,6,23,.40));
      mix-blend-mode: screen;
    }

    /* Screen blink overlay (flash) */
    #hvr-screen-blink{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:99980;
      opacity:0;
      transition:opacity 90ms ease;
      mix-blend-mode:screen;
    }
    #hvr-screen-blink.on{ opacity:1; }
    #hvr-screen-blink.good{ background:rgba(34,197,94,.22); }
    #hvr-screen-blink.bad{ background:rgba(239,68,68,.22); }
    #hvr-screen-blink.block{ background:rgba(96,165,250,.22); }

    /* Playfield */
    #hvr-playfield{
      position:absolute;
      inset:0;
      z-index:1;
      pointer-events:auto;
      overflow:hidden;
    }

    /* ===== Continuous subtle wobble + chroma (applies only to playfield, HUD stays crisp) ===== */
    #hvr-playfield.hvr-wobble{
      animation: hvrWobble 1.25s ease-in-out infinite;
      transform-origin: 50% 56%;
      will-change: transform, filter;
    }
    #hvr-playfield.hvr-wobble-strong{
      animation: hvrWobbleStrong .78s ease-in-out infinite;
    }
    @keyframes hvrWobble{
      0%{ transform: translate3d(0,0,0) rotate(0deg); }
      25%{ transform: translate3d(0.35px,-0.25px,0) rotate(0.03deg); }
      50%{ transform: translate3d(-0.35px,0.25px,0) rotate(-0.03deg); }
      75%{ transform: translate3d(0.25px,0.35px,0) rotate(0.02deg); }
      100%{ transform: translate3d(0,0,0) rotate(0deg); }
    }
    @keyframes hvrWobbleStrong{
      0%{ transform: translate3d(0,0,0) rotate(0deg); }
      20%{ transform: translate3d(1.2px,-0.9px,0) rotate(0.09deg); }
      50%{ transform: translate3d(-1.2px,0.8px,0) rotate(-0.09deg); }
      80%{ transform: translate3d(0.9px,1.1px,0) rotate(0.06deg); }
      100%{ transform: translate3d(0,0,0) rotate(0deg); }
    }

    /* chromatic split (subtle always, stronger on storm) */
    #hvr-playfield.hvr-chroma{
      filter:
        drop-shadow(0.8px 0 rgba(255,0,60,.18))
        drop-shadow(-0.8px 0 rgba(0,255,255,.14));
    }
    #hvr-playfield.hvr-chroma-strong{
      filter:
        drop-shadow(1.6px 0 rgba(255,0,80,.28))
        drop-shadow(-1.6px 0 rgba(0,255,255,.22))
        contrast(1.03) saturate(1.06);
    }

    /* HUD */
    .hud{
      position:fixed;
      left:12px; right:12px;
      top:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
      z-index:50;
      pointer-events:none;
    }
    .card{
      pointer-events:none;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      padding:10px 12px;
      min-width:0;
    }

    .hud-left{ flex:1.25; display:flex; gap:10px; min-width:0; }
    .hud-mid{ flex:1; display:flex; gap:10px; min-width:0; }
    .hud-right{ flex:0.85; display:flex; gap:10px; justify-content:flex-end; min-width:0; }

    .row{ display:flex; align-items:center; gap:10px; }
    .kpi{
      display:flex; flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .kpi .label{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .kpi .value{
      font-size:18px;
      font-weight:900;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.62);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      white-space:nowrap;
    }

    /* Water gauge */
    .water{ width:240px; min-width:240px; }
    .bar{
      position:relative;
      height:12px;
      border-radius:var(--pill);
      overflow:hidden;
      background:rgba(148,163,184,.16);
      border:1px solid rgba(148,163,184,.22);
    }
    #hha-water-fill{
      position:absolute; left:0; top:0; bottom:0;
      width:50%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(96,165,250,.75), rgba(239,68,68,.85));
      border-radius:var(--pill);
      transition:width 160ms ease;
    }
    .water-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      gap:8px;
    }
    #hha-water-zone-text{
      color:#dbeafe;
      font-weight:900;
      letter-spacing:.08em;
    }

    /* Grade progress */
    .grade{ width:260px; min-width:260px; }
    .progress{
      position:relative;
      height:12px;
      border-radius:var(--pill);
      overflow:hidden;
      background:rgba(148,163,184,.16);
      border:1px solid rgba(148,163,184,.22);
    }
    #hha-grade-progress-fill{
      position:absolute; left:0; top:0; bottom:0;
      width:0%;
      background:linear-gradient(90deg, rgba(245,158,11,.95), rgba(34,197,94,.95));
      border-radius:var(--pill);
      transition:width 180ms ease;
    }
    #hha-grade-badge{
      font-weight:1000;
      letter-spacing:.08em;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    #hha-grade-progress-text{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Quest panel */
    .quest{ width:100%; min-width:0; }
    .quest-line{
      font-size:12px;
      color:var(--txt);
      font-weight:800;
      letter-spacing:.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-top:3px;
    }
    .quest-counts{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
    }
    .quest-counts b{ color:var(--txt); }

    /* Start overlay */
    #hvr-start{
      position:fixed;
      inset:0;
      z-index:120;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:linear-gradient(180deg, rgba(2,6,23,.88), rgba(2,6,23,.92));
      backdrop-filter:blur(12px);
    }
    .start-card{
      width:min(720px, 100%);
      background:var(--panel2);
      border:1px solid rgba(148,163,184,.24);
      border-radius:24px;
      padding:16px;
      box-shadow:0 22px 70px rgba(0,0,0,.60);
    }
    .start-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .title{ font-size:20px; font-weight:1000; letter-spacing:.02em; }
    .subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(2,6,23,.55);
      color:var(--txt);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 14px 36px rgba(0,0,0,.45);
    }
    .btn.primary{
      border-color:rgba(34,197,94,.45);
      background:rgba(34,197,94,.14);
    }
    .btn:active{ transform:translateY(1px); }

    /* FIX: ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡∏ö */
    #btn-start,#btn-reload,#btn-exit,#btn-retry,#btn-to-hub{
      position:relative;
      z-index:99999;
      pointer-events:auto;
      touch-action:manipulation;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.40);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .chip b{ color:var(--txt); }

    /* End overlay */
    #hvr-end{
      position:fixed;
      inset:0;
      z-index:140;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:linear-gradient(180deg, rgba(2,6,23,.90), rgba(2,6,23,.94));
      backdrop-filter:blur(12px);
    }
    #hvr-end.on{ display:flex; }
    .end-grid{
      width:min(760px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .end-card{
      background:var(--panel2);
      border:1px solid rgba(148,163,184,.24);
      border-radius:24px;
      padding:14px;
      box-shadow:0 22px 70px rgba(0,0,0,.60);
    }
    .end-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .end-title h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
    }
    .end-title .grade{
      width:auto; min-width:auto;
      display:flex; align-items:center; gap:10px;
    }
    .end-kpis{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .end-kpis .card{ pointer-events:auto; }
    .end-small{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .end-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    @media (max-width: 720px){
      .hud{ top:8px; flex-direction:column; }
      .water,.grade{ min-width:0; width:100%; }
      .hud-left,.hud-mid,.hud-right{ width:100%; }
      .end-kpis{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div id="hvr-wrap">

    <!-- 2-layer parallax background -->
    <div id="hvr-bg1" class="hvr-bg"></div>
    <div id="hvr-bg2" class="hvr-bg"></div>

    <!-- FX overlays -->
    <div id="hvr-screen-blink" class=""></div>

    <!-- HUD -->
    <div class="hud">
      <div class="hud-left">
        <div class="card quest">
          <div class="row" style="justify-content:space-between;">
            <div class="kpi">
              <div class="label">Quest</div>
              <div class="value">Hydration</div>
            </div>
            <div class="pill">
              <span style="color:var(--muted); font-weight:900;">Grade</span>
              <span id="hha-grade-badge">C</span>
            </div>
          </div>

          <div id="hha-quest-goal" class="quest-line">Goal: ‚Äî</div>
          <div id="hha-quest-mini" class="quest-line">Mini: ‚Äî</div>

          <div class="quest-counts">
            <div class="pill">üéØ Goal <b><span id="hha-goal-done">0</span>/<span id="hha-goal-total">2</span></b></div>
            <div class="pill">‚ú® Mini <b><span id="hha-mini-done">0</span>/<span id="hha-mini-total">3</span></b></div>
          </div>
        </div>

        <div class="card water">
          <div class="row" style="justify-content:space-between;">
            <div class="kpi">
              <div class="label">Water</div>
              <div class="value" id="hha-water-status">GREEN 50%</div>
            </div>
            <div class="pill">
              <span style="color:var(--muted); font-weight:900;">ZONE</span>
              <span id="hha-water-zone-text">GREEN</span>
            </div>
          </div>
          <div class="bar" style="margin-top:8px;">
            <div id="hha-water-fill"></div>
          </div>
          <div class="water-meta">
            <span>‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà GREEN ‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î üíß</span>
            <span style="opacity:.9;">(+‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å streak)</span>
          </div>
        </div>
      </div>

      <div class="hud-mid">
        <div class="card grade">
          <div class="row" style="justify-content:space-between;">
            <div class="kpi">
              <div class="label">Progress</div>
              <div class="value"><span id="hha-score-main">0</span> pts</div>
            </div>
            <div class="pill">
              <span style="color:var(--muted); font-weight:900;">Combo Max</span>
              <span style="font-weight:1000;"><span id="hha-combo-max">0</span></span>
            </div>
          </div>

          <div class="progress" style="margin-top:8px;">
            <div id="hha-grade-progress-fill"></div>
          </div>
          <div id="hha-grade-progress-text">Progress to S (30%): 0%</div>
        </div>
      </div>

      <div class="hud-right">
        <div class="card" style="min-width:170px;">
          <div class="kpi">
            <div class="label">Miss</div>
            <div class="value"><span id="hha-miss">0</span></div>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35;">
            JUNK hit = miss + ‡∏•‡∏î‡∏ô‡πâ‡∏≥/‡∏•‡∏î fever
          </div>
        </div>
      </div>
    </div>

    <!-- Playfield -->
    <div id="hvr-playfield" aria-label="playfield"></div>

    <!-- Start overlay -->
    <div id="hvr-start">
      <div class="start-card">
        <div class="start-top">
          <div>
            <div class="title">üíß Hydration Quest VR (Play)</div>
            <div class="subtitle">
              ‡πÅ‡∏ï‡∏∞ ‚Äú‡∏ô‡πâ‡∏≥‡∏î‡∏µ‚Äù ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏ã‡∏ô GREEN ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ß‡∏±‡∏á ‚ÄúJUNK‚Äù<br>
              ‡∏°‡∏µ <b>Surprise mini</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß + <b>Mini Chain</b> ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡πÅ‡∏û‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ <b>JUNK hit</b>) + Storm/Fever!
            </div>
          </div>
          <div class="pill" style="pointer-events:auto;">
            <span style="color:var(--muted); font-weight:900;">URL</span>
            <span id="hvr-url-info" style="font-weight:1000;">diff=easy ‚Ä¢ time=90</span>
          </div>
        </div>

        <div class="chips">
          <div class="chip">üéØ Goal: <b>GREEN time</b> + <b>Bad zone ‚â§ limit</b></div>
          <div class="chip">‚ú® Core mini: <b>Combo</b> / <b>Good hits</b> / <b>No junk</b></div>
          <div class="chip">üîÅ Chain mini: <b>Junk Cleanse</b> / <b>Perfect Chain</b></div>
        </div>

        <div class="controls">
          <button id="btn-start" class="btn primary">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
          <button id="btn-reload" class="btn">üîÑ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
          <button id="btn-exit" class="btn">üè† ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        </div>

        <div class="subtitle" style="margin-top:10px;">
          ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á beep ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‚Äú‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        </div>
      </div>
    </div>

    <!-- End overlay -->
    <div id="hvr-end">
      <div class="end-grid">
        <div class="end-card">
          <div class="end-title">
            <h2>üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
            <div class="grade">
              <span style="color:var(--muted); font-weight:900;">Grade</span>
              <span id="end-grade" style="font-weight:1000; letter-spacing:.08em;">C</span>
            </div>
          </div>

          <div class="end-kpis">
            <div class="card">
              <div class="kpi">
                <div class="label">Score</div>
                <div class="value" id="end-score">0</div>
              </div>
              <div class="end-small">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™ Goal/Mini/Chain/Storm)</div>
            </div>
            <div class="card">
              <div class="kpi">
                <div class="label">Goal / Mini</div>
                <div class="value" id="end-quests">0/0 ‚Ä¢ 0/0</div>
              </div>
              <div class="end-small">Goal ‡∏ú‡πà‡∏≤‡∏ô / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Ä¢ Core Mini ‡∏ú‡πà‡∏≤‡∏ô / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="card">
              <div class="kpi">
                <div class="label">üîÅ Chain Minis</div>
                <div class="value" id="end-chain">0 (fail 0)</div>
              </div>
              <div class="end-small">‡πÇ‡∏ä‡∏ß‡πå Chain cleared + fail (‡∏ô‡∏±‡∏ö fail ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ junk hit)</div>
            </div>
            <div class="card">
              <div class="kpi">
                <div class="label">Combo / Miss</div>
                <div class="value" id="end-combo-miss">0 ‚Ä¢ 0</div>
              </div>
              <div class="end-small">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô miss</div>
            </div>
          </div>

          <div class="end-small" id="end-extra">
            ‡∏ô‡πâ‡∏≥/‡πÇ‡∏ã‡∏ô/greenTick/fever/shield ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
          </div>

          <div class="end-actions">
            <button id="btn-retry" class="btn primary">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            <button id="btn-to-hub" class="btn">üè† ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚úÖ FIX: bind ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ import ‡πÄ‡∏Å‡∏°‡πÅ‡∏ö‡∏ö dynamic -->
  <script type="module">
    'use strict';
    const ROOT = window;
    const $ = (id)=>document.getElementById(id);

    function qs(){
      const u = new URL(location.href);
      return {
        diff: (u.searchParams.get('diff') || u.searchParams.get('difficulty') || 'easy').toLowerCase(),
        time: Number(u.searchParams.get('time') || u.searchParams.get('duration') || 90) || 90
      };
    }

    function bindTap(el, fn){
      if (!el) return;
      const h = (e)=>{ try{ e.preventDefault(); e.stopPropagation(); }catch{} fn(e); };
      el.addEventListener('pointerdown', h, { passive:false });
      el.addEventListener('touchstart', h, { passive:false });
      el.addEventListener('click', h, { passive:false });
    }

    function goHub(){
      location.href = './hub.html';
    }

    // parallax pointer -> CSS vars (2 layers)
    (function bindParallax(){
      const wrap = $('hvr-wrap');
      if (!wrap) return;
      let tx = 0, ty = 0;
      function setVars(x,y){
        // clamp to keep subtle
        const cx = Math.max(-14, Math.min(14, x));
        const cy = Math.max(-10, Math.min(10, y));
        wrap.style.setProperty('--px', cx.toFixed(2));
        wrap.style.setProperty('--py', cy.toFixed(2));
      }
      window.addEventListener('pointermove', (e)=>{
        const w = window.innerWidth || 1;
        const h = window.innerHeight || 1;
        const nx = ((e.clientX / w) - 0.5) * 2;
        const ny = ((e.clientY / h) - 0.5) * 2;
        tx = nx * 10;
        ty = ny * 7;
        setVars(tx, ty);
      }, { passive:true });

      // optional device tilt
      window.addEventListener('deviceorientation', (e)=>{
        const gx = Number(e.gamma||0); // left-right
        const by = Number(e.beta||0);  // front-back
        if (!Number.isFinite(gx) || !Number.isFinite(by)) return;
        const nx = Math.max(-18, Math.min(18, gx));
        const ny = Math.max(-14, Math.min(14, by - 10));
        setVars(nx * 0.35, ny * 0.25);
      }, { passive:true });
    })();

    const p = qs();
    const urlInfo = $('hvr-url-info');
    if (urlInfo) urlInfo.textContent = `diff=${p.diff} ‚Ä¢ time=${p.time}`;

    // ‡∏´‡∏ô‡πâ‡∏≤ start ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ playfield ‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
    const playfield = $('hvr-playfield');
    if (playfield) playfield.style.pointerEvents = 'none';

    bindTap($('btn-reload'), ()=>location.reload());
    bindTap($('btn-exit'), goHub);
    bindTap($('btn-to-hub'), goHub);
    bindTap($('btn-retry'), ()=>location.reload());

    let inst = null;

    async function startGame(){
      const start = $('hvr-start');
      if (start) start.style.display = 'none';
      if (playfield) {
        playfield.style.pointerEvents = 'auto';
        // subtle always-on wobble + chroma (storm will strengthen via JS)
        playfield.classList.add('hvr-wobble', 'hvr-chroma');
      }

      try{
        const mod = await import('./hydration-vr/hydration.safe.js');
        if (!mod || typeof mod.boot !== 'function') throw new Error('boot() not found');

        inst = await mod.boot({ difficulty: p.diff, duration: p.time });
        ROOT.__HVR_INST = inst;

        // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        try{
          const AC = ROOT.AudioContext || ROOT.webkitAudioContext;
          if (AC){
            const ac = new AC();
            if (ac.state === 'suspended') ac.resume();
          }
        }catch{}
      }catch(err){
        console.error('[Hydration] start failed:', err);
        if (start) start.style.display = 'flex';
        if (playfield) playfield.style.pointerEvents = 'none';
        alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à path import / ‡πÑ‡∏ü‡∏•‡πå 404 / syntax error\n‡πÄ‡∏õ‡∏¥‡∏î Console ‡∏î‡∏π error');
      }
    }

    bindTap($('btn-start'), startGame);

    // End screen
    window.addEventListener('hha:end', (e)=>{
      const d = e?.detail || {};
      const end = $('hvr-end');
      if (end) end.classList.add('on');

      $('end-grade') && ($('end-grade').textContent = String(d.grade ?? 'C'));
      $('end-score') && ($('end-score').textContent = String(d.score ?? 0));

      const gd = d.goalsDone ?? 0, gt = d.goalsTotal ?? 0;
      const md = d.minisDone ?? 0, mt = d.minisTotal ?? 0;
      $('end-quests') && ($('end-quests').textContent = `${gd}/${gt} ‚Ä¢ ${md}/${mt}`);

      const cc = d.chainCleared ?? (d.rewards?.chainCleared ?? 0);
      const cf = d.chainFailed ?? (d.rewards?.chainFailed ?? 0);
      $('end-chain') && ($('end-chain').textContent = `${cc} (fail ${cf})`);

      const cb = d.comboBest ?? 0;
      const ms = d.miss ?? d.misses ?? 0;
      $('end-combo-miss') && ($('end-combo-miss').textContent = `${cb} ‚Ä¢ ${ms}`);

      const water = d.water ?? 0;
      const zone = d.zone ?? '';
      const gtick = d.greenTick ?? 0;
      const fever = d.fever ?? 0;
      const shield = d.shield ?? 0;
      const prog = d.progPct ?? 0;

      const extra = $('end-extra');
      if (extra){
        extra.textContent =
          `Water ${water}% ‚Ä¢ Zone ${zone} ‚Ä¢ GREEN ${gtick}s ‚Ä¢ Fever ${fever} ‚Ä¢ Shield ${shield} ‚Ä¢ Progress ${prog}%`;
      }
    }, { passive:true });
  </script>
</body>
</html>
