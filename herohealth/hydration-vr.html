<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg-main:#020617;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.25);
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --danger:#f97316;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:var(--bg-main);
      color:var(--text-main);
      overflow:hidden;
    }

    a-scene{
      width:100vw;
      height:100vh;
      position:fixed;
      inset:0;
    }

    /* ===== ‡πÉ‡∏´‡πâ Water gauge ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô HUD ‡∏ö‡∏±‡∏á ===== */
    .hha-water-root,
    [data-hha-water],
    .water-gauge-root{
      position:fixed;
      z-index:700;
    }

    /* ===== HUD ‡∏´‡∏•‡∏±‡∏Å ===== */
    .hud-root{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:650;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:70px 10px 14px; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á ‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡πÄ‡∏Å‡∏à‡∏ô‡πâ‡∏≥ */
    }
    .hud-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .hud-card{
      background:rgba(15,23,42,0.9);
      border-radius:16px;
      padding:8px 12px;
      border:1px solid rgba(148,163,184,0.22);
      pointer-events:auto;
      font-size:13px;
      min-width:150px;
    }
    .hud-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--text-soft);
      margin-bottom:2px;
    }
    .hud-body{
      font-size:13px;
      line-height:1.4;
    }

    /* ===== Coach bubble (‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á) ===== */
    .hud-bottom{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding-bottom:72px;
    }
    .coach-bubble{
      min-width:60%;
      max-width:680px;
      text-align:left;
      background:rgba(15,23,42,0.96);
      border-radius:999px;
      padding:8px 14px;
      border:1px solid rgba(52,211,153,0.45);
      font-size:13px;
      display:none;
      align-items:center;
      gap:8px;
      pointer-events:auto;
    }
    .coach-bubble.show{ display:flex; }
    .coach-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#6ee7b7;
      font-weight:600;
      margin-bottom:2px;
    }

    /* ===== Toast ‡∏â‡∏•‡∏≠‡∏á Goal / Mini / All ===== */
    .hint-center{
      position:fixed;
      left:50%;
      top:32%;
      transform:translate(-50%,-50%);
      font-size:14px;
      color:#fefce8;
      background:radial-gradient(circle at top left, rgba(250,204,21,0.35), transparent 55%),
                 rgba(15,23,42,0.98);
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,0.7);
      display:none;
      pointer-events:none;
      z-index:652;
    }
    .hint-center.show{
      display:block;
      animation:questToast .6s ease-out;
    }
    @keyframes questToast{
      from{opacity:0;transform:translate(-50%,-40%) scale(.9);}
      to{opacity:1;transform:translate(-50%,-50%) scale(1);}
    }

    /* ===== End Summary Toast ===== */
    .end-toast{
      position:fixed;
      left:50%;
      top:18%;
      transform:translateX(-50%);
      background:radial-gradient(circle at top left, rgba(250,204,21,0.26), transparent 55%),
                 rgba(15,23,42,0.96);
      padding:12px 16px 14px;
      border-radius:20px;
      border:1px solid rgba(250,204,21,0.65);
      min-width:280px;
      max-width:420px;
      font-size:13px;
      box-shadow:0 20px 40px rgba(15,23,42,0.85);
      display:none;
      z-index:653;
      pointer-events:auto;
    }
    .end-toast.show{
      display:block;
      animation:fadeIn .6s ease-out;
    }
    .end-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .end-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-top:2px;
    }
    .end-row strong{ font-weight:600; }
    .end-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
      gap:8px;
    }
    .end-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:6px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,0.85);
      color:var(--text-main);
    }
    .end-btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border-color:rgba(187,247,208,0.9);
      color:#022c22;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translate(-50%,-18px);}
      to{opacity:1;transform:translate(-50%,0);}
    }

    /* ‡∏õ‡∏∏‡πà‡∏° VR */
    .vr-btn{
      position:fixed;
      right:12px;
      bottom:16px;
      z-index:654;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      padding:8px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 55%),
                 rgba(15,23,42,0.96);
      color:#e0f2fe;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 14px 30px rgba(15,23,42,0.9);
    }
  </style>
</head>
<body>

  <!-- ===== A-Frame Scene (VR Hydration) ===== -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    background="color: #020617">

    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="hydration-camera"
                wasd-controls-enabled="false"
                look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  raycaster="objects: .hha-target-vr, [data-hha-tgt]; interval: 50; far: 10"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9">
        </a-entity>
      </a-camera>
    </a-entity>

    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- ===== HUD Overlay ===== -->
  <div class="hud-root">
    <div class="hud-top">
      <div class="hud-card">
        <div class="hud-title">Hydration VR ‚Ä¢ Mode</div>
        <div class="hud-body">
          ‡πÇ‡∏´‡∏°‡∏î: <span id="hud-runmode">Play</span><br>
          ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <span id="hud-diff">NORMAL</span><br>
          ‡πÄ‡∏ß‡∏•‡∏≤: <span id="hud-time">60s</span>
        </div>
      </div>
      <div class="hud-card">
        <div class="hud-title">Score</div>
        <div class="hud-body">
          ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="hud-score">0</span><br>
          ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <span id="hud-combo">0</span><br>
          ‡∏û‡∏•‡∏≤‡∏î: <span id="hud-miss">0</span>
        </div>
      </div>
      <div class="hud-card">
        <div class="hud-title">Quest</div>
        <div class="hud-body">
          Quest: <span id="hud-quest-main">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</span><br>
          Mini: <span id="hud-quest-mini">Mini quest ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</span>
        </div>
      </div>
    </div>

    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div>
          <div class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä</div>
          <div id="coach-text">‡∏à‡∏¥‡∏ö‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡∏à‡∏±‡∏î ‡πÜ ‡∏ô‡∏∞ üíß</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast ‡∏â‡∏•‡∏≠‡∏á -->
  <div class="hint-center" id="quest-hint"></div>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
  <div class="end-toast" id="end-toast">
    <div class="end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Hydration Quest VR</div>
    <div class="end-row"><span>‡πÇ‡∏´‡∏°‡∏î</span><strong id="end-runmode">Play</strong></div>
    <div class="end-row"><span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span><strong id="end-score">0</strong></div>
    <div class="end-row"><span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span><strong id="end-combo">0</strong></div>
    <div class="end-row"><span>‡∏û‡∏•‡∏≤‡∏î</span><strong id="end-miss">0</strong></div>
    <div class="end-row"><span>Goals</span><strong id="end-goal">0 / 0</strong></div>
    <div class="end-row"><span>Mini quests</span><strong id="end-mini">0 / 0</strong></div>
    <div class="end-actions">
      <button class="end-btn end-btn-primary" id="btn-replay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button class="end-btn" id="btn-back-hub">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° VR -->
  <button class="vr-btn" id="btn-vr">üï∂Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</button>

  <!-- Fever + Particles -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <script type="module">
    import { GameEngine } from './hydration-vr/GameEngine.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';

    function getParam(name, fallback){
      const url = new URL(window.location.href);
      const v = url.searchParams.get(name);
      return v !== null && v !== '' ? v : fallback;
    }

    const elScore   = document.getElementById('hud-score');
    const elCombo   = document.getElementById('hud-combo');
    const elMiss    = document.getElementById('hud-miss');
    const elDiff    = document.getElementById('hud-diff');
    const elTime    = document.getElementById('hud-time');
    const elRunHUD  = document.getElementById('hud-runmode');

    const elQuestMain = document.getElementById('hud-quest-main');
    const elQuestMini = document.getElementById('hud-quest-mini');

    const elCoachBubble = document.getElementById('coach-bubble');
    const elCoachText   = document.getElementById('coach-text');

    const elQuestHint  = document.getElementById('quest-hint');

    const elEndToast  = document.getElementById('end-toast');
    const elEndScore  = document.getElementById('end-score');
    const elEndCombo  = document.getElementById('end-combo');
    const elEndMiss   = document.getElementById('end-miss');
    const elEndGoal   = document.getElementById('end-goal');
    const elEndMini   = document.getElementById('end-mini');
    const elEndRun    = document.getElementById('end-runmode');

    const btnReplay   = document.getElementById('btn-replay');
    const btnBackHub  = document.getElementById('btn-back-hub');
    const btnVR       = document.getElementById('btn-vr');

    let lastStats = {
      score: 0,
      comboMax: 0,
      misses: 0,
      goalsCleared: 0,
      goalsTotal: 0,
      miniCleared: 0,
      miniTotal: 0
    };

    let currentDiff = 'normal';
    let currentRunMode = 'play';
    let gameStopped = false;
    let timeLeft = 0;
    let timerId = null;

    function setCoach(text){
      if (!text) return;
      elCoachText.textContent = text;
      elCoachBubble.classList.add('show');
      setTimeout(()=> elCoachBubble.classList.remove('show'), 4200);
    }

    function showQuestToast(msg){
      if (!msg) return;
      elQuestHint.textContent = msg;
      elQuestHint.classList.add('show');
      setTimeout(()=> elQuestHint.classList.remove('show'), 1400);
    }

    // ===== HUD score =====
    window.addEventListener('hha:score',(e)=>{
      const d = e.detail || {};
      if (typeof d.score === 'number') {
        elScore.textContent = d.score;
        lastStats.score = d.score;
      }
      if (typeof d.comboMax === 'number') {
        elCombo.textContent = d.comboMax;
        lastStats.comboMax = d.comboMax;
      }
      if (typeof d.misses === 'number') {
        elMiss.textContent = d.misses;
        lastStats.misses = d.misses;
      }
    });

    window.addEventListener('hha:miss',()=>{
      lastStats.misses += 1;
      elMiss.textContent = lastStats.misses;
      setCoach('‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞ üíß');
    });

    // ‡πÄ‡∏ß‡∏•‡∏≤
    window.addEventListener('hha:time',(e)=>{
      const sec = (e.detail && typeof e.detail.sec === 'number')
        ? e.detail.sec
        : (e.detail?.sec | 0);
      if (sec >= 0) {
        elTime.textContent = sec + 's';
      }
    });

    // Quest HUD + ‡πÄ‡∏Å‡πá‡∏ö progress ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏∏‡∏õ
    window.addEventListener('quest:update',(e)=>{
      const d = e.detail || {};
      const goal = d.goal || null;
      const mini = d.mini || null;
      const goalsAll = d.goalsAll || [];
      const minisAll = d.minisAll || [];

      if (goal){
        const prog = goal.prog|0, tgt = goal.target|0;
        elQuestMain.textContent = goal.label
          ? `${goal.label} (${prog}/${tgt})`
          : `Goal: ${prog}/${tgt}`;
      } else {
        elQuestMain.textContent = 'Goal: ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéØ';
      }

      if (mini){
        const progM = mini.prog|0, tgtM = mini.target|0;
        elQuestMini.textContent = mini.label
          ? `${mini.label} (${progM}/${tgtM})`
          : `Mini: ${progM}/${tgtM}`;
      } else {
        elQuestMini.textContent = 'Mini quest: ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      }

      lastStats.goalsTotal  = goalsAll.length;
      lastStats.miniTotal   = minisAll.length;
      lastStats.goalsCleared = goalsAll.filter(g => g && g.done).length;
      lastStats.miniCleared  = minisAll.filter(m => m && m.done).length;
    });

    // ‡∏â‡∏•‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢
    window.addEventListener('quest:step',(e)=>{
      const d = e.detail || {};
      if (d.type === 'goal') {
        showQuestToast(`üéØ Goal ${d.done}/${d.total} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +${d.bonus||0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
      } else if (d.type === 'mini') {
        showQuestToast(`‚≠ê Mini quest ${d.done}/${d.total} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +${d.bonus||0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
      }
    });

    window.addEventListener('quest:reward',(e)=>{
      const t = e.detail?.type || '';
      if (t === 'goal-all') {
        showQuestToast('üéØ Goal ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
      } else if (t === 'mini-all') {
        showQuestToast('‚≠ê Mini quest ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 3 ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
      }
    });

    // ‡∏â‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà + ‡∏¢‡∏¥‡∏á hha:end ‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ stop ‡πÄ‡∏Å‡∏°
    window.addEventListener('quest:all-cleared',()=>{
      if (gameStopped) return;
      showQuestToast('üéâ ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
      setCoach('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢ üíßüéâ');

      setTimeout(()=> {
        if (gameStopped) return;
        gameStopped = true;
        if (timerId) clearInterval(timerId);

        // ‡∏¢‡∏¥‡∏á hha:end ‡∏î‡πâ‡∏ß‡∏¢ stats ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const detail = {
          mode: 'Hydration',
          modeLabel: 'Hydration',
          difficulty: currentDiff,
          score: lastStats.score,
          misses: lastStats.misses,
          comboMax: lastStats.comboMax,
          goalsCleared: lastStats.goalsCleared,
          goalsTotal: lastStats.goalsTotal,
          miniCleared: lastStats.miniCleared,
          miniTotal: lastStats.miniTotal
        };
        window.dispatchEvent(new CustomEvent('hha:end',{ detail }));

        // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏±‡πà‡∏á stop engine
        GameEngine.stop('all-cleared');
      }, 1500);
    });

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à)
    window.addEventListener('hha:end',(e)=>{
      const d = e.detail || {};

      const scoreFinal   = d.scoreFinal ?? d.score ?? lastStats.score;
      const comboMax     = d.comboMax  ?? lastStats.comboMax;
      const misses       = d.misses    ?? lastStats.misses;
      const goalsCleared = d.goalsCleared ?? lastStats.goalsCleared;
      const goalsTotal   = d.goalsTotal   ?? lastStats.goalsTotal;
      const miniCleared  = d.miniCleared  ?? lastStats.miniCleared;
      const miniTotal    = d.miniTotal    ?? lastStats.miniTotal;

      elEndScore.textContent = scoreFinal;
      elEndCombo.textContent = comboMax;
      elEndMiss.textContent  = misses;
      elEndGoal.textContent  = `${goalsCleared} / ${goalsTotal}`;
      elEndMini.textContent  = `${miniCleared} / ${miniTotal}`;
      elEndRun.textContent   = (currentRunMode === 'research') ? 'Research' : 'Play';

      setTimeout(()=> {
        elEndToast.classList.add('show');
      }, 400);
    });

    // ===== VR button =====
    function initVRButton(){
      const scene = document.querySelector('a-scene');
      if (!btnVR || !scene) return;
      btnVR.addEventListener('click', () => {
        try{
          scene.enterVR();
        }catch(err){
          console.warn('[HydrationVR] enterVR error:', err);
        }
      });
    }

    // ===== Boot =====
    window.addEventListener('DOMContentLoaded',()=>{
      const diffParam = String(getParam('diff','normal')).toLowerCase();
      const runParam  = String(getParam('run','play')).toLowerCase();
      currentDiff     = (diffParam === 'easy' || diffParam === 'hard') ? diffParam : 'normal';
      currentRunMode  = (runParam === 'research') ? 'research' : 'play';

      // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      let baseDur = 60;
      if (currentDiff === 'easy') baseDur = 80;
      else if (currentDiff === 'hard') baseDur = 45;

      timeLeft = baseDur;
      const timeParam = getParam('time','');
      if (timeParam){
        const parsed = parseInt(timeParam,10);
        if (!isNaN(parsed) && parsed >= 20 && parsed <= 180){
          timeLeft = parsed;
        }
      }

      elDiff.textContent   = currentDiff.toUpperCase();
      elRunHUD.textContent = (currentRunMode === 'research') ? 'Research Mode' : 'Play Mode';
      elTime.textContent   = timeLeft + 's';

      // profile ‡∏à‡∏≤‡∏Å Hub
      let studentProfile = null;
      let studentKey = null;
      try{
        const raw = sessionStorage.getItem('hhaStudentProfile');
        if (raw){
          studentProfile = JSON.parse(raw);
          studentKey = studentProfile.studentKey || null;
        }
      }catch(err){
        console.warn('[HydrationVR] cannot parse student profile:', err);
      }

      initCloudLogger({
        endpoint: 'https://script.google.com/macros/s/AKfycbxunS2aJ3NlznqAtn2iTln0JsMJ2OdsYx6pVvfVDVn-CkQzDiSDh1tep3yJHnKa0VIH/exec',
        projectTag: 'HeroHealth-HydrationVR',
        mode: 'HydrationVR',
        runMode: currentRunMode,
        diff: currentDiff,
        durationSec: timeLeft,
        studentKey,
        profile: studentProfile,
        debug: false
      });

      const cam = document.querySelector('#hydration-camera');
      attachTouchLook(cam);
      initVRButton();

      setCoach('‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏î‡∏µ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡∏∞ üíß');

      GameEngine.start(currentDiff, timeLeft);

      // clock ‡∏Å‡∏•‡∏≤‡∏á
      window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));
      timerId = setInterval(() => {
        if (gameStopped) return;
        timeLeft -= 1;
        if (timeLeft < 0){
          clearInterval(timerId);
          if (!gameStopped){
            gameStopped = true;
            GameEngine.stop('time-up');
          }
          return;
        }
        window.dispatchEvent(new CustomEvent('hha:time',{ detail:{ sec: timeLeft }}));
      }, 1000);

      if (btnReplay) {
        btnReplay.addEventListener('click', () => {
          window.location.reload();
        });
      }
      if (btnBackHub) {
        btnBackHub.addEventListener('click', () => {
          window.location.href = './hub.html';
        });
      }

      document.addEventListener('visibilitychange', () => {
        if (document.hidden && !gameStopped) {
          gameStopped = true;
          if (timerId) clearInterval(timerId);
          GameEngine.stop('tab-hidden');
        }
      });
    });
  </script>

</body>
</html>