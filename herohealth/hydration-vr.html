<!-- === /herohealth/hydration-vr.html ===
Hydration Quest VR ‚Äî FULL HTML (PRODUCTION READY)
‚úÖ module boot hydration.safe.js
‚úÖ HUD compact + auto-hide friendly (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡πÄ‡∏õ‡πâ‡∏≤)
‚úÖ exclusion via data-hha-exclude="1" (‡πÑ‡∏°‡πà‡∏ö‡∏µ‡∏ö‡∏™‡∏ô‡∏≤‡∏°)
‚úÖ auto-start via ?diff=easy&time=90&run=play (or research)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX / Fever / HUD (IIFE) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.78);
      --panel2:rgba(15,23,42,.72);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#9ca3af;

      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;

      --radius:18px;
      --radius2:22px;
      --shadow:0 18px 50px rgba(0,0,0,.42);
    }

    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    .wrap{
      position:fixed; inset:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 600px at 50% 40%, rgba(59,130,246,.10), transparent 60%),
        radial-gradient(900px 520px at 20% 10%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(#020617, #020617);
    }
    a-scene{ position:absolute; inset:0; z-index:0; }

    /* bounds layer (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô transform) */
    #hvr-bounds{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:1;
    }

    /* playfield layer (‡πÇ‡∏î‡∏ô transform ‡πÑ‡∏î‡πâ) */
    #hvr-playfield{
      position:absolute; inset:0;
      z-index:5;
      pointer-events:auto;
      touch-action:manipulation;
    }

    /* HUD wrapper: pointer-events none (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å) */
    .hud{ position:absolute; inset:0; z-index:30; pointer-events:none; }

    .topbar{
      position:absolute; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .pill{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .stats{ display:flex; gap:10px; flex-wrap:wrap; }
    .stat{ min-width:98px; display:flex; flex-direction:column; gap:2px; }
    .k{ font-size:11px; color:var(--muted); letter-spacing:.2px; }
    .v{ font-size:16px; font-weight:750; }

    .questBox{
      flex:1;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      min-height:64px;
      pointer-events:none;
    }
    .questTitle{ display:flex; align-items:center; gap:8px; font-weight:900; }
    .questTitle small{ font-weight:800; color:var(--muted); }
    .qline{ margin-top:6px; font-size:14px; color:var(--text); opacity:.96; }
    .qline .muted{ color:var(--muted); }

    .coachBox{
      position:absolute; left:12px; top:92px;
      width:min(420px, calc(100% - 24px));
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      padding:10px 12px;
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .coachText{ font-size:14px; color:var(--text); line-height:1.35; }
    .coachSub{ color:var(--muted); font-size:12.5px; margin-top:4px; }

    .controls{
      position:absolute; left:12px; right:12px; bottom:14px;
      display:flex; gap:12px;
      align-items:flex-end;
      z-index:40;
      pointer-events:none;
    }
    .btnCol{ display:flex; gap:10px; pointer-events:auto; }
    .btn{
      min-width:92px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:12px 14px;
      font-weight:950;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.30); }
    .btn.danger{ background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.30); }

    /* Start overlay */
    #startOverlay{
      position:absolute; inset:0; z-index:80;
      background: radial-gradient(900px 500px at 50% 40%, rgba(59,130,246,.16), transparent 60%),
                  rgba(2,6,23,.72);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .card{
      width:min(560px, 100%);
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .h1{ font-size:18px; font-weight:1000; margin:0 0 8px; }
    .p{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.45; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .seg{
      flex:1;
      min-width:140px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px;
    }
    .seg label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900; }
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.55);
      color:var(--text);
      font-weight:900;
      outline:none;
    }
    .startBtn{
      width:100%;
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.20);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }
    .startBtn:active{ transform: translateY(1px); }
    .note{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }

    /* Marks for exclusion (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô mode-factory) */
    [data-hha-exclude="1"]{ pointer-events:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <a-scene
      embedded
      renderer="antialias: true; colorManagement: true;"
      vr-mode-ui="enabled:false"
      background="color: #020617"
    >
      <a-entity id="rig" position="0 1.6 0">
        <a-camera id="cam"
          wasd-controls-enabled="false"
          look-controls="enabled:true; touchEnabled:true; mouseEnabled:true"
          position="0 0 0"
        ></a-camera>
      </a-entity>
      <a-sky color="#020617"></a-sky>
    </a-scene>

    <div id="hvr-bounds"></div>
    <div id="hvr-playfield" aria-label="playfield"></div>

    <div class="hud">
      <!-- Mark only real boxes as exclusions -->
      <div class="topbar">
        <div class="pill stats" data-hha-exclude="1">
          <div class="stat"><div class="k">SCORE</div><div class="v" id="hha-score-main">0</div></div>
          <div class="stat"><div class="k">COMBO MAX</div><div class="v" id="hha-combo-max">0</div></div>
          <div class="stat"><div class="k">MISS</div><div class="v" id="hha-miss">0</div></div>
          <div class="stat"><div class="k">GRADE</div><div class="v" id="hha-grade-badge">C</div></div>
        </div>

        <div class="questBox" data-hha-exclude="1">
          <div class="questTitle">üß© <span>QUEST</span> <small id="hha-mini-count">0</small></div>
          <div class="qline" id="hha-quest-goal"><span class="muted">Goal:</span> ‚Äî</div>
          <div class="qline" id="hha-quest-mini"><span class="muted">Mini:</span> ‚Äî</div>
          <div class="qline"><span class="muted">Water Zone:</span> <b id="hha-water-zone-text">GREEN</b></div>
          <div class="qline" style="margin-top:8px;">
            <span class="muted">Goals done:</span> <b id="hha-goal-count">0</b>
            &nbsp;‚Ä¢&nbsp;
            <span class="muted">Minis done:</span> <b id="hha-mini-count2">0</b>
          </div>
          <div style="margin-top:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid rgba(255,255,255,.14)">
            <div id="hha-grade-progress-fill" style="height:100%;width:0%;background:rgba(34,197,94,.55);border-radius:999px"></div>
          </div>
          <div id="hha-grade-progress-text" class="qline" style="margin-top:6px;color:var(--muted);font-size:12px;">Progress to S (30%): 0%</div>
        </div>
      </div>

      <div class="coachBox" data-hha-exclude="1">
        <div class="coachText" id="coachText">‡πÅ‡∏ï‡∏∞‡∏ô‡πâ‡∏≥‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ üíß ‡∏£‡∏±‡∏Å‡∏©‡∏≤ GREEN ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô!</div>
        <div class="coachSub" id="coachSub">Tip: ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡πÅ‡∏ï‡∏∞ = ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á / ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>
      </div>

      <div class="controls">
        <div class="btnCol">
          <button class="btn danger" id="btnStop">STOP</button>
          <button class="btn primary" id="btnVR">VR</button>
        </div>
      </div>
    </div>

    <div id="startOverlay">
      <div class="card">
        <div class="h1">Hydration Quest VR ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢</div>
        <div class="p">
          ‡πÇ‡∏´‡∏°‡∏î <b>play</b> = Adaptive ON (‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ù‡∏µ‡∏°‡∏∑‡∏≠) + STORM
          <br/>‡πÇ‡∏´‡∏°‡∏î <b>research</b> = Adaptive OFF (‡∏Ñ‡∏∏‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‡πÅ‡∏Ñ‡πà easy/normal/hard)
        </div>

        <div class="row">
          <div class="seg">
            <label>Difficulty</label>
            <select id="selDiff">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </div>

          <div class="seg">
            <label>Run mode</label>
            <select id="selMode">
              <option value="play" selected>play</option>
              <option value="research">research</option>
            </select>
          </div>

          <div class="seg">
            <label>Time (sec)</label>
            <input id="inpTime" type="number" min="20" max="180" step="10" value="90" />
          </div>
        </div>

        <button class="startBtn" id="btnStart">START</button>
        <div class="note">
          ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ URL: <code>?diff=easy&time=90&run=play</code> ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
          <br/>‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏à‡∏≠‡∏î‡∏≥/‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° <code>&debug=1</code> ‡∏î‡∏π log ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { boot as hydrationBoot } from './hydration-vr/hydration.safe.js';

    const $ = (id)=>document.getElementById(id);
    const startOverlay = $('startOverlay');
    const selDiff = $('selDiff');
    const selMode = $('selMode');
    const inpTime = $('inpTime');

    const sp = new URLSearchParams(location.search);
    const qDiff = (sp.get('diff')||'').toLowerCase();
    const qMode = (sp.get('run')||sp.get('mode')||'').toLowerCase();
    const qTime = parseInt(sp.get('time')||'',10);

    if (qDiff) selDiff.value = (['easy','normal','hard'].includes(qDiff) ? qDiff : 'normal');
    if (qMode) selMode.value = (qMode === 'research' ? 'research' : 'play');
    if (!Number.isNaN(qTime) && qTime>0) inpTime.value = String(Math.max(20, Math.min(180, qTime)));

    const btnStart = $('btnStart');
    const btnStop  = $('btnStop');
    const btnVR    = $('btnVR');
    const sceneEl  = document.querySelector('a-scene');

    let inst = null;

    async function startGame(){
      const diff = (selDiff.value||'normal').toLowerCase();
      const mode = (selMode.value||'play').toLowerCase();
      const tsec = Math.max(20, Math.min(180, parseInt(inpTime.value||'90',10) || 90));

      try{
        const u = new URL(location.href);
        u.searchParams.set('diff', diff);
        u.searchParams.set('time', String(tsec));
        u.searchParams.set('run', mode);
        history.replaceState(null,'',u.toString());
      }catch{}

      startOverlay.style.display = 'none';

      inst = await hydrationBoot({ difficulty: diff, duration: tsec, runMode: mode });
      window.__HVR_STARTED__ = true;
    }

    btnStart.addEventListener('click', ()=> startGame());
    btnStop.addEventListener('click', ()=>{
      try{ inst && inst.stop && inst.stop(); }catch{}
      startOverlay.style.display = '';
      window.__HVR_STARTED__ = false;
    });
    btnVR.addEventListener('click', async ()=>{
      try{ if (sceneEl && sceneEl.enterVR) sceneEl.enterVR(); }catch{}
    });

    // auto start
    if (qMode === 'play' || qMode === 'research'){
      // ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á start ‡∏Å‡πà‡∏≠‡∏ô script defer ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ô‡∏¥‡∏î
      setTimeout(()=> startGame(), 200);
    }

    // sync mini-count2 (optional)
    window.addEventListener('quest:update', ()=>{
      const a = document.getElementById('hha-mini-count');
      const b = document.getElementById('hha-mini-count2');
      if (a && b) b.textContent = a.textContent;
    });
  </script>
</body>
</html>