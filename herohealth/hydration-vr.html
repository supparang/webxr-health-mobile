<!-- === /herohealth/hydration-vr/hydration-vr.html ===
Hydration VR (PRODUCTION) ‚Äî FULL HTML (Stereo Cardboard + Gaze + HUD Pills + WaterGauge + End Summary)
Works with:
- ./hydration.safe.js  (ESM)
- ../vr/ui-water.js    (ESM, imported by hydration.safe.js)
Optional:
- ../vr/particles.js   (IIFE)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.62);
      --panel2:rgba(15,23,42,.58);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      /* gaze progress 0..1 */
      --gazeProg:0;

      /* storm end-window FX */
      --endamp:0;     /* 0..1 */
      --endflash:0;   /* 0..1 */

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);

      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; width:100%; height:100%;
      background:var(--bg); color:var(--text);
      overflow:hidden;
    }

    /* ===== layout root ===== */
    #app{
      position:fixed; inset:0;
      background:
        radial-gradient(circle at top left, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,211,238,.12), transparent 55%);
    }

    /* ===== MONO ===== */
    #monoWrap{
      position:absolute; inset:0;
      display:block;
    }
    body.cardboard #monoWrap{ display:none; }

    /* ===== CARDBOARD ===== */
    #cbWrap{
      position:absolute; inset:0;
      display:none;
      background:#000;
    }
    body.cardboard #cbWrap{ display:flex; }
    .eye{
      position:relative;
      flex:1;
      overflow:hidden;
      border-left:1px solid rgba(255,255,255,.07);
    }
    .eye:first-child{ border-left:none; }

    /* ===== Playfield bounds ===== */
    .playfield{
      position:absolute;
      left: max(10px, calc(10px + var(--sal)));
      right:max(10px, calc(10px + var(--sar)));
      top:  max(76px, calc(76px + var(--sat)));
      bottom: max(116px, calc(116px + var(--sab)));
      border-radius:20px;
      border:1px solid rgba(148,163,184,.16);
      background:
        radial-gradient(circle at 50% 50%, rgba(15,23,42,.48), rgba(2,6,23,.62));
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      overflow:hidden;
      touch-action: none;
    }

    /* cardboard eyes: make bounds fit nicely */
    body.cardboard .playfield{
      left:10px; right:10px;
      top:  max(70px, calc(70px + var(--sat)));
      bottom: max(106px, calc(106px + var(--sab)));
      border-radius:16px;
    }

    /* ===== target layer ===== */
    .layer{
      position:absolute; inset:0;
    }

    /* ===== targets (DOM emoji) ===== */
    .tgt{
      position:absolute;
      left: var(--x);
      top:  var(--y);
      width: var(--s);
      height: var(--s);
      transform: translate(-50%,-50%);
      display:grid;
      place-items:center;
      font-size: calc(var(--s) * 0.56);
      line-height:1;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      filter: drop-shadow(0 16px 26px rgba(0,0,0,.35));
    }
    .tgt::before{
      content:'';
      position:absolute; inset:0;
      border-radius:999px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(34,197,94,.16), rgba(2,6,23,0) 60%);
      border:1px solid rgba(148,163,184,.18);
      box-shadow:
        0 0 0 3px rgba(34,197,94,.10),
        0 0 30px rgba(34,197,94,.10);
      backdrop-filter: blur(8px);
    }
    .tgt.good::before{
      box-shadow:
        0 0 0 3px rgba(34,197,94,.12),
        0 0 32px rgba(34,197,94,.12);
    }
    .tgt.bad::before{
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(239,68,68,.18), rgba(2,6,23,0) 62%);
      border:1px solid rgba(239,68,68,.22);
      box-shadow:
        0 0 0 3px rgba(239,68,68,.12),
        0 0 34px rgba(239,68,68,.12);
    }
    .tgt.shield::before{
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(34,211,238,.18), rgba(2,6,23,0) 62%);
      border:1px solid rgba(34,211,238,.25);
      box-shadow:
        0 0 0 3px rgba(34,211,238,.12),
        0 0 34px rgba(34,211,238,.12);
    }
    .tgt.star::before{
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(250,204,21,.18), rgba(2,6,23,0) 62%);
      border:1px solid rgba(250,204,21,.25);
      box-shadow:
        0 0 0 3px rgba(250,204,21,.12),
        0 0 34px rgba(250,204,21,.12);
    }
    .tgt.diamond::before{
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(167,139,250,.18), rgba(2,6,23,0) 62%);
      border:1px solid rgba(167,139,250,.25);
      box-shadow:
        0 0 0 3px rgba(167,139,250,.12),
        0 0 34px rgba(167,139,250,.12);
    }

    /* spawn / despawn */
    .tgt.pop{ animation: pop .12s ease-out; }
    @keyframes pop{
      from{ transform: translate(-50%,-50%) scale(.65); opacity:.0; }
      to  { transform: translate(-50%,-50%) scale(1.0); opacity:1; }
    }
    .tgt.out{ animation: out .18s ease-in forwards; }
    @keyframes out{
      to{ transform: translate(-50%,-50%) scale(.80); opacity:0; }
    }

    /* ===== Boss target style (from patch) ===== */
    .tgt.boss::before{
      border: 1px solid rgba(239,68,68,.35);
      box-shadow:
        0 0 0 3px rgba(239,68,68,.18),
        0 0 34px rgba(239,68,68,.18),
        inset 0 0 0 2px rgba(250,204,21,.10);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 55% 70%, rgba(239,68,68,.16), rgba(2,6,23,0) 62%);
    }
    .tgt.boss{
      filter: drop-shadow(0 18px 36px rgba(239,68,68,.28));
      animation: bossPulse .42s ease-in-out infinite;
    }
    @keyframes bossPulse{
      0%{ transform: translate(-50%,-50%) scale(1.00); }
      50%{ transform: translate(-50%,-50%) scale(1.06); }
      100%{ transform: translate(-50%,-50%) scale(1.00); }
    }

    /* ===== Crosshair + Gaze ring ===== */
    .crosshair{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:16px; height:16px;
      border-radius:999px;
      pointer-events:none;
      z-index:30;
      background:rgba(229,231,235,.06);
      box-shadow: 0 0 0 2px rgba(229,231,235,.30), 0 0 22px rgba(34,197,94,.12);
      backdrop-filter: blur(8px);
    }
    .crosshair::after{
      content:'';
      position:absolute; inset:5px;
      border-radius:999px;
      background:rgba(229,231,235,.48);
    }

    /* gaze ring uses conic-gradient progress */
    .gazeRing{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:62px; height:62px;
      border-radius:999px;
      pointer-events:none;
      z-index:29;
      background:
        conic-gradient(
          rgba(34,197,94,.95) calc(var(--gazeProg) * 1turn),
          rgba(229,231,235,.12) 0
        );
      -webkit-mask: radial-gradient(circle, transparent 59%, #000 60%);
              mask: radial-gradient(circle, transparent 59%, #000 60%);
      filter: drop-shadow(0 14px 26px rgba(34,197,94,.12));
      opacity: .0;
      transition: opacity .08s linear;
    }
    body.cardboard .gazeRing{ opacity: .95; }
    body.cardboard .crosshair{ width:18px; height:18px; }
    body.cardboard .crosshair::after{ inset:6px; }

    /* ===== HUD pills ===== */
    .hudTop{
      position:absolute;
      left:max(10px, calc(10px + var(--sal)));
      right:max(10px, calc(10px + var(--sar)));
      top: max(10px, calc(10px + var(--sat)));
      z-index:40;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      pointer-events:none;
    }
    body.cardboard .hudTop{
      left:10px; right:10px;
      top: max(8px, calc(8px + var(--sat)));
      gap:8px;
    }
    .hudCard{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 52px rgba(0,0,0,.30);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      pointer-events:none;
      min-width:0;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:baseline;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.46);
      border:1px solid rgba(148,163,184,.14);
      font-weight:1000;
      white-space:nowrap;
    }
    .k{ color:var(--muted); font-weight:1000; font-size:11px; letter-spacing:.2px; }
    .v{ font-weight:1100; font-size:15px; }

    .hudTop .left{ flex:1; }
    .hudTop .right{ flex:0 0 auto; justify-content:flex-end; }

    /* ===== Mini HUD (pills) ===== */
    .miniHud{
      position:absolute;
      left:max(10px, calc(10px + var(--sal)));
      right:max(10px, calc(10px + var(--sar)));
      bottom:max(90px, calc(90px + var(--sab)));
      z-index:41;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    body.cardboard .miniHud{
      left:10px; right:10px;
      bottom:max(86px, calc(86px + var(--sab)));
    }

    /* ===== Quest panel ===== */
    .questPanel{
      position:absolute;
      left:max(10px, calc(10px + var(--sal)));
      right:max(10px, calc(10px + var(--sar)));
      bottom:max(14px, calc(14px + var(--sab)));
      z-index:42;
      background:rgba(2,6,23,.60);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 52px rgba(0,0,0,.30);
      pointer-events:none;
    }
    body.cardboard .questPanel{
      left:10px; right:10px;
    }
    .qRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .qBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.50);
      border:1px solid rgba(148,163,184,.14);
      font-weight:1100;
    }
    .qText{ font-weight:1000; color:rgba(229,231,235,.92); }
    .qSub{ margin-top:6px; color:rgba(148,163,184,.95); font-weight:900; line-height:1.25; }

    /* ===== Water gauge ===== */
    .waterHud{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 170px;
    }
    .waterBarWrap{
      height:12px;
      border-radius:999px;
      background:rgba(15,23,42,.45);
      border:1px solid rgba(148,163,184,.16);
      overflow:hidden;
    }
    #water-bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90));
      box-shadow: 0 0 26px rgba(34,197,94,.16);
      transition: width .09s linear;
    }
    .waterMeta{
      display:flex; justify-content:space-between;
      gap:10px;
      font-weight:1000;
      color:rgba(229,231,235,.90);
    }
    .waterMeta span{ white-space:nowrap; }

    body.water-low  #water-bar{ background: linear-gradient(90deg, rgba(239,68,68,.92), rgba(245,158,11,.92)); }
    body.water-green #water-bar{ background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,211,238,.90)); }
    body.water-high #water-bar{ background: linear-gradient(90deg, rgba(167,139,250,.92), rgba(34,211,238,.92)); }

    /* ===== Controls ===== */
    #controls{
      position:absolute;
      right:max(10px, calc(10px + var(--sar)));
      bottom:max(110px, calc(110px + var(--sab)));
      z-index:60;
      display:flex;
      gap:10px;
      pointer-events:auto;
    }
    body.cardboard #controls{
      right:10px;
      bottom:max(170px, calc(170px + var(--sab)));
    }
    .btn{
      background:rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.20);
      color:var(--text);
      border-radius:16px;
      padding:10px 12px;
      font-weight:1100;
      box-shadow: 0 18px 44px rgba(0,0,0,.34);
      backdrop-filter: blur(10px);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    /* big shoot pad (Cardboard) */
    #shootPad{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:max(12px, calc(12px + var(--sab)));
      z-index:70;
      display:none;
      pointer-events:auto;
    }
    body.cardboard #shootPad{ display:block; }
    #btnShoot{
      padding:14px 18px;
      border-radius:18px;
      font-size:16px;
      font-weight:1200;
    }

    /* ===== Start overlay ===== */
    #startOverlay{
      position:absolute; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(2,6,23,.74);
      backdrop-filter: blur(12px);
      pointer-events:auto;
    }
    #startCard{
      width:min(820px, 92vw);
      background:rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
    }
    #startTitle{ font-size:20px; font-weight:1200; }
    #startDesc{
      margin-top:8px;
      color:rgba(148,163,184,.96);
      font-weight:900;
      line-height:1.35;
    }
    #startGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    .chip{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.52);
      font-weight:1100;
    }
    .chip b{ color:rgba(229,231,235,.92); }
    #startActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn.primary{
      background:rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.30);
    }

    /* ===== End overlay ===== */
    #endOverlay{
      position:absolute; inset:0;
      z-index:220;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(12px);
      pointer-events:auto;
    }
    #endCard{
      width:min(860px, 92vw);
      background:rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    .cell{
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.16);
      border-radius:16px;
      padding:10px 12px;
    }
    .cell .k{ display:block; margin-bottom:4px; }
    #endActions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }

    /* ===== Storm end-window FX overlay ===== */
    #stormFx{
      position:absolute; inset:0;
      pointer-events:none;
      z-index:80;
      opacity:0;
      transition: opacity .08s linear;
      background:
        radial-gradient(circle at 50% 50%, rgba(2,6,23,0) 35%, rgba(2,6,23,.30) 70%, rgba(2,6,23,.72) 100%);
    }
    body.endwindow #stormFx{
      opacity: calc(0.18 + (var(--endamp) * 0.55));
    }
    #stormFx::after{
      content:'';
      position:absolute; inset:0;
      opacity: calc(var(--endflash));
      background:
        radial-gradient(circle at 50% 50%, rgba(239,68,68,0) 40%, rgba(239,68,68,.12) 75%, rgba(2,6,23,.0) 100%);
      mix-blend-mode: screen;
    }

    /* small helper text */
    .muted{ color:rgba(148,163,184,.96); font-weight:900; }

    @media (max-width: 520px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      #startGrid{ grid-template-columns: 1fr; }
      .waterHud{ min-width: 150px; }
    }
  </style>

  <!-- Optional particles layer (safe if missing) -->
  <script src="../vr/particles.js" defer></script>

  <!-- Hydration engine -->
  <script type="module" src="./hydration.safe.js"></script>
</head>

<body>
  <div id="app">

    <!-- ========== MONO ========== -->
    <div id="monoWrap">
      <div class="hudTop">
        <div class="hudCard left">
          <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" data-stat="time">0</span></span>
          <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" data-stat="score">0</span></span>
          <span class="pill">‚ö° <span class="k">COMBO</span> <span class="v" data-stat="combo">0</span></span>
          <span class="pill">üí• <span class="k">MISS</span> <span class="v" data-stat="miss">0</span></span>

          <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" data-stat="shield">0</span></span>
          <span class="pill">‚ú® <span class="k">PERF</span> <span class="v" data-stat="perf">0</span></span>
        </div>

        <div class="hudCard right">
          <span class="pill">üéØ <span class="k">GRADE</span> <span class="v" data-stat="grade">C</span></span>
          <span class="pill">‚ö†Ô∏è <span class="k">PRESS</span> <span class="v" data-stat="press">0%</span></span>

          <div class="waterHud" style="pointer-events:none">
            <div class="waterMeta">
              <span>üíß <b id="water-pct">0%</b></span>
              <span>ZONE <b id="water-zone">‚Äî</b></span>
            </div>
            <div class="waterBarWrap" aria-label="water gauge">
              <div id="water-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- mini pills -->
      <div class="miniHud">
        <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" data-pill="goal">‚Ä¶</span></span>
        <span class="pill">üå©Ô∏è <span class="k">STORM</span> <span class="v" data-pill="storm">‚Ä¶</span></span>
        <span class="pill">üëπ <span class="k">MINI</span> <span class="v" data-pill="mini">‚Ä¶</span></span>
      </div>

      <!-- playfield -->
      <div class="playfield" id="playfield" aria-label="playfield">
        <div id="stormFx" aria-hidden="true"></div>
        <div class="layer" id="hvr-layer" aria-label="targets layer"></div>
        <div class="gazeRing" aria-hidden="true"></div>
        <div class="crosshair" aria-hidden="true"></div>
      </div>

      <!-- quest -->
      <div class="questPanel">
        <div class="qRow">
          <span class="qBadge">GOAL</span>
          <span class="qText" data-quest="goal">‚Ä¶</span>
          <span class="qBadge">PROG</span>
          <span class="qText" data-quest="prog">‚Ä¶</span>
        </div>
        <div class="qSub">
          <b data-quest="state">‚Ä¶</b> ‚Ä¢ <span data-quest="mini">‚Ä¶</span>
        </div>
      </div>
    </div>

    <!-- ========== CARDBOARD (stereoscopic L/R) ========== -->
    <div id="cbWrap" aria-label="cardboard stereo">
      <div class="eye" id="eyeL">
        <div class="hudTop">
          <div class="hudCard left">
            <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" data-stat="time">0</span></span>
            <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" data-stat="score">0</span></span>
            <span class="pill">‚ö° <span class="k">COMBO</span> <span class="v" data-stat="combo">0</span></span>
            <span class="pill">üí• <span class="k">MISS</span> <span class="v" data-stat="miss">0</span></span>
            <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" data-stat="shield">0</span></span>
            <span class="pill">‚ú® <span class="k">PERF</span> <span class="v" data-stat="perf">0</span></span>
          </div>
          <div class="hudCard right">
            <span class="pill">üéØ <span class="k">GRADE</span> <span class="v" data-stat="grade">C</span></span>
            <span class="pill">‚ö†Ô∏è <span class="k">PRESS</span> <span class="v" data-stat="press">0%</span></span>
          </div>
        </div>

        <div class="miniHud">
          <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" data-pill="goal">‚Ä¶</span></span>
          <span class="pill">üå©Ô∏è <span class="k">STORM</span> <span class="v" data-pill="storm">‚Ä¶</span></span>
          <span class="pill">üëπ <span class="k">MINI</span> <span class="v" data-pill="mini">‚Ä¶</span></span>
        </div>

        <div class="playfield" id="cbPlayL" aria-label="left eye playfield">
          <div id="stormFx" aria-hidden="true"></div>
          <div class="layer" id="hvr-layerL"></div>
          <div class="gazeRing" aria-hidden="true"></div>
          <div class="crosshair" aria-hidden="true"></div>
        </div>

        <div class="questPanel">
          <div class="qRow">
            <span class="qBadge">GOAL</span>
            <span class="qText" data-quest="goal">‚Ä¶</span>
            <span class="qBadge">PROG</span>
            <span class="qText" data-quest="prog">‚Ä¶</span>
          </div>
          <div class="qSub">
            <b data-quest="state">‚Ä¶</b> ‚Ä¢ <span data-quest="mini">‚Ä¶</span>
          </div>
        </div>
      </div>

      <div class="eye" id="eyeR">
        <div class="hudTop">
          <div class="hudCard left">
            <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span class="v" data-stat="time">0</span></span>
            <span class="pill">üèÜ <span class="k">SCORE</span> <span class="v" data-stat="score">0</span></span>
            <span class="pill">‚ö° <span class="k">COMBO</span> <span class="v" data-stat="combo">0</span></span>
            <span class="pill">üí• <span class="k">MISS</span> <span class="v" data-stat="miss">0</span></span>
            <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span class="v" data-stat="shield">0</span></span>
            <span class="pill">‚ú® <span class="k">PERF</span> <span class="v" data-stat="perf">0</span></span>
          </div>
          <div class="hudCard right">
            <span class="pill">üéØ <span class="k">GRADE</span> <span class="v" data-stat="grade">C</span></span>
            <span class="pill">‚ö†Ô∏è <span class="k">PRESS</span> <span class="v" data-stat="press">0%</span></span>

            <!-- show water gauge only once (right eye) -->
            <div class="waterHud" style="pointer-events:none">
              <div class="waterMeta">
                <span>üíß <b id="water-pct">0%</b></span>
                <span>ZONE <b id="water-zone">‚Äî</b></span>
              </div>
              <div class="waterBarWrap">
                <div id="water-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="miniHud">
          <span class="pill">üéØ <span class="k">GOAL</span> <span class="v" data-pill="goal">‚Ä¶</span></span>
          <span class="pill">üå©Ô∏è <span class="k">STORM</span> <span class="v" data-pill="storm">‚Ä¶</span></span>
          <span class="pill">üëπ <span class="k">MINI</span> <span class="v" data-pill="mini">‚Ä¶</span></span>
        </div>

        <div class="playfield" id="cbPlayR" aria-label="right eye playfield">
          <div id="stormFx" aria-hidden="true"></div>
          <div class="layer" id="hvr-layerR"></div>
          <div class="gazeRing" aria-hidden="true"></div>
          <div class="crosshair" aria-hidden="true"></div>
        </div>

        <div class="questPanel">
          <div class="qRow">
            <span class="qBadge">GOAL</span>
            <span class="qText" data-quest="goal">‚Ä¶</span>
            <span class="qBadge">PROG</span>
            <span class="qText" data-quest="prog">‚Ä¶</span>
          </div>
          <div class="qSub">
            <b data-quest="state">‚Ä¶</b> ‚Ä¢ <span data-quest="mini">‚Ä¶</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls">
      <button class="btn" id="btnCardboard">üì¶ CARDBOARD</button>
      <button class="btn" id="btnGaze">üëÅÔ∏è GAZE: ON</button>
      <button class="btn" id="btnRestart">üîÅ RESTART</button>
    </div>

    <div id="shootPad">
      <button class="btn primary" id="btnShoot">üéØ SHOOT</button>
    </div>

    <!-- Start Overlay -->
    <div id="startOverlay">
      <div id="startCard">
        <div id="startTitle">Hydration VR üíß</div>
        <div id="startDesc">
          ‡πÄ‡∏Å‡πá‡∏ö üíß / üöª ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô <b>GREEN</b> ‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô‡∏û‡∏≠<br>
          ‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡πà‡∏ß‡∏á <b>STORM</b> ‡∏à‡∏∞‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏‡∏à‡∏∞‡∏°‡∏µ <b>BOSS</b> ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ <b>üõ°Ô∏è</b> ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö!<br>
          <span class="muted">Cardboard ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î Gaze (‡πÄ‡∏•‡πá‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span>
        </div>

        <div id="startGrid">
          <div class="chip">DIFF: <b id="chipDiff">‚Äî</b></div>
          <div class="chip">TIME: <b id="chipTime">‚Äî</b></div>
          <div class="chip">MODE: <b id="chipMode">‚Äî</b></div>
        </div>

        <div id="startActions">
          <button class="btn" id="btnMotion">üì± ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion</button>
          <button class="btn" id="btnStartMono">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° (MONO)</button>
          <button class="btn primary" id="btnStartCardboard">üï∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° (CARDBOARD)</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Tip: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ / ‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á ‚Ä¢ Cardboard ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        </div>
      </div>
    </div>

    <!-- End Overlay -->
    <div id="endOverlay">
      <div id="endCard">
        <div style="font-weight:1200; font-size:20px">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî Hydration VR</div>
        <div class="muted" style="margin-top:6px">
          Mode: <b id="eMode">‚Äî</b> ‚Ä¢ Diff: <b id="eDiff">‚Äî</b> ‚Ä¢ Grade: <b id="eGrade">‚Äî</b>
        </div>

        <div class="grid">
          <div class="cell"><span class="k">Score</span><span class="v" id="eScore">0</span></div>
          <div class="cell"><span class="k">Max Combo</span><span class="v" id="eComboMax">0</span></div>
          <div class="cell"><span class="k">Miss</span><span class="v" id="eMiss">0</span></div>

          <div class="cell"><span class="k">Accuracy</span><span class="v" id="eAcc">0%</span></div>
          <div class="cell"><span class="k">Perfect</span><span class="v" id="ePerf">0</span></div>
          <div class="cell"><span class="k">Avg RT</span><span class="v" id="eRt">0ms</span></div>

          <div class="cell"><span class="k">Green Sec</span><span class="v" id="eGreen">0</span></div>
          <div class="cell"><span class="k">Goal</span><span class="v" id="eGoal">0/1</span></div>
          <div class="cell"><span class="k">Mini (Boss)</span><span class="v" id="eMini">0/1</span></div>
        </div>

        <div id="endActions">
          <button class="btn" id="btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
          <button class="btn primary" id="btnPlayAgain">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function(){
      'use strict';

      function qs(name, def){
        try{ return (new URL(location.href)).searchParams.get(name) ?? def; }catch{ return def; }
      }
      function clamp(v,a,b){ v = Number(v)||0; return v<a?a:(v>b?b:v); }

      const diff = String(qs('diff','normal')).toLowerCase();
      const time = clamp(parseInt(qs('time','70'),10)||70, 30, 600);
      const run  = String(qs('run', qs('runMode','play'))).toLowerCase()==='research'?'research':'play';
      const hub  = String(qs('hub','../hub.html') || '../hub.html');

      // chips
      document.getElementById('chipDiff').textContent = diff;
      document.getElementById('chipTime').textContent = time + 's';
      document.getElementById('chipMode').textContent = run;

      // gaze global toggle flag consumed by hydration.safe.js
      const gazeBtn = document.getElementById('btnGaze');
      let gazeOn = true;
      window.__HVR_GAZE_ON__ = true;
      function syncGazeBtn(){
        gazeBtn.textContent = 'üëÅÔ∏è GAZE: ' + (gazeOn ? 'ON' : 'OFF');
        window.__HVR_GAZE_ON__ = gazeOn;
      }
      syncGazeBtn();

      // motion permission helper (iOS)
      async function requestMotion(){
        try{
          if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
            const p = await DeviceMotionEvent.requestPermission();
            alert('Motion permission: ' + p);
          } else {
            alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ Motion permission (‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)');
          }
        }catch(e){
          alert('‡∏Ç‡∏≠ Motion ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e && e.message ? e.message : e));
        }
      }

      // toggle cardboard
      function setCardboard(on){
        document.body.classList.toggle('cardboard', !!on);
      }

      // start game
      const startOverlay = document.getElementById('startOverlay');
      function start(mode){
        startOverlay.style.display = 'none';
        setCardboard(mode === 'cardboard');
        // dispatch start for hydration.safe.js
        window.dispatchEvent(new CustomEvent('hvr:start', { detail:{ mode } }));
      }

      // restart
      document.getElementById('btnRestart').addEventListener('click', ()=> location.reload());

      // buttons
      document.getElementById('btnMotion').addEventListener('click', requestMotion);
      document.getElementById('btnStartMono').addEventListener('click', ()=> start('mono'));
      document.getElementById('btnStartCardboard').addEventListener('click', ()=> start('cardboard'));

      document.getElementById('btnCardboard').addEventListener('click', ()=>{
        const on = !document.body.classList.contains('cardboard');
        setCardboard(on);
      });

      gazeBtn.addEventListener('click', ()=>{
        gazeOn = !gazeOn;
        syncGazeBtn();
      });

      // shoot button (for cardboard)
      document.getElementById('btnShoot').addEventListener('click', ()=>{
        window.dispatchEvent(new CustomEvent('hvr:shoot'));
      });

      // gaze progress -> CSS var
      window.addEventListener('hvr:gaze', (ev)=>{
        const p = (ev && ev.detail && typeof ev.detail.p === 'number') ? ev.detail.p : 0;
        document.documentElement.style.setProperty('--gazeProg', String(Math.max(0, Math.min(1, p))));
      }, { passive:true });

      // end overlay fill
      const endOverlay = document.getElementById('endOverlay');
      const $ = (id)=>document.getElementById(id);

      window.addEventListener('hha:end', (ev)=>{
        const d = (ev && ev.detail) ? ev.detail : {};
        try{
          localStorage.setItem('HHA_LAST_SUMMARY', JSON.stringify(d||{}));
          localStorage.setItem('hha_last_summary', JSON.stringify(d||{}));
        }catch{}

        $('eMode').textContent = String(d.runMode ?? d.runMode ?? run);
        $('eDiff').textContent = String(d.diff ?? diff);
        $('eGrade').textContent = String(d.grade ?? 'C');
        $('eScore').textContent = String(d.scoreFinal ?? 0);
        $('eComboMax').textContent = String(d.comboMax ?? 0);
        $('eMiss').textContent = String(d.misses ?? 0);
        $('eAcc').textContent = String((d.accuracyGoodPct ?? 0)|0) + '%';
        $('ePerf').textContent = String(d.perfectCount ?? 0);
        $('eRt').textContent = String(d.avgRtGoodMs ?? 0) + 'ms';
        $('eGreen').textContent = String(d.greenSec ?? 0);
        $('eGoal').textContent = String(d.goalsCleared ?? 0) + '/' + String(d.goalsTotal ?? 1);
        $('eMini').textContent = String(d.miniCleared ?? 0) + '/' + String(d.miniTotal ?? 1);

        endOverlay.style.display = 'flex';
      }, { passive:true });

      // back hub / play again
      document.getElementById('btnBackHub').addEventListener('click', ()=>{
        try{
          const u = new URL(hub, location.href);
          u.searchParams.set('ts', String(Date.now()));
          location.href = u.toString();
        }catch{
          location.href = hub;
        }
      });
      document.getElementById('btnPlayAgain').addEventListener('click', ()=> location.reload());

      // quick autostart support
      if (qs('autostart','0') === '1'){
        startOverlay.style.display = 'none';
        start(qs('cardboard','0') === '1' ? 'cardboard' : 'mono');
      }
    })();
  </script>
</body>
</html>
