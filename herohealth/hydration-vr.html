<!-- === /herohealth/hydration-vr.html ===
HydrationVR LAUNCHER ‚Äî ROOT (Production)
‚úÖ Auto-detect view: pc / mobile / vr / cvr
‚úÖ DO NOT override if ?view= already exists
‚úÖ Pass-through: hub/run/diff/time/seed/style/studyId/phase/conditionGroup/log/practice/ai/ts
‚úÖ Optional: remembers last view (localStorage) if no explicit ?view=
‚úÖ Redirect to ./hydration-vr/hydration-vr.html
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HeroHealth ‚Äî HydrationVR</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="icon" href="./favicon.ico"/>
  <style>
    :root{
      --bg:#020617; --panel:rgba(2,6,23,.78); --panel2:rgba(15,23,42,.66);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e;
      --radius:22px; --pill:999px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(34,211,238,.14), transparent 55%),
                  radial-gradient(900px 700px at 85% 15%, rgba(34,197,94,.14), transparent 60%),
                  radial-gradient(900px 700px at 50% 85%, rgba(59,130,246,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
    }
    .wrap{
      min-height:100vh;
      padding: calc(18px + var(--sat)) calc(18px + var(--sar)) calc(18px + var(--sab)) calc(18px + var(--sal));
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:min(940px, 92vw);
      background: linear-gradient(180deg, rgba(2,6,23,.78), rgba(2,6,23,.58));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 28px 90px rgba(0,0,0,.48);
      backdrop-filter: blur(10px);
      padding: 20px;
    }
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.20);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      font-size:22px;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .sub{ margin:2px 0 0; color:var(--muted); font-size:13px; }
    .meta{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted); font-size:12px;
    }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.55);
      padding:8px 10px;
      border-radius: var(--pill);
    }
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }
    .panel{
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.48);
      border-radius: 18px;
      padding: 14px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      appearance:none; border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color:var(--text);
      padding:10px 12px; border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      transition: transform .06s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(2,6,23,.55); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.28);
    }
    .btn.warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.24);
    }
    .hint{
      margin-top:10px;
      color: rgba(148,163,184,.95);
      font-size:12px;
      line-height: 1.45;
    }
    .small{ font-size:12px; color: var(--muted); }
    code{ color: rgba(34,211,238,.95); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="logo">üíß</div>
          <div>
            <h1>Hydration Quest VR</h1>
            <div class="sub">HeroHealth Academy ‚Äî Launcher (auto-detect)</div>
          </div>
        </div>
        <div class="meta">
          <div class="pill">view: <b id="vNow">auto</b></div>
          <div class="pill">mode: <b id="mNow">play</b></div>
          <div class="pill">diff: <b id="dNow">normal</b></div>
          <div class="pill">time: <b id="tNow">70</b>s</div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="row">
            <button class="btn primary" id="btnGo">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° (Auto)</button>
            <button class="btn" id="btnPC">PC</button>
            <button class="btn" id="btnMobile">Mobile</button>
            <button class="btn" id="btnVR">VR</button>
            <button class="btn warn" id="btnCVR">Cardboard (cVR)</button>
          </div>
          <div class="hint">
            ‚Ä¢ Auto ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏à‡∏∞ <b>‡πÑ‡∏°‡πà override</b> ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ <code>?view=</code> ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß<br/>
            ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠+‡πÅ‡∏ß‡πà‡∏ô Cardboard ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ <b>cVR</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
          </div>
        </div>

        <div class="panel">
          <div class="small">
            ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: <code id="dst"></code><br/>
            ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠: <code id="pass"></code>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const WIN = window;
  const DOC = document;

  const STORAGE_KEY = 'HHA_LAST_VIEW_hydration';

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,Number(v)||0));

  function qs(k, def=null){
    try{ return new URL(location.href).searchParams.get(k) ?? def; }
    catch(_){ return def; }
  }

  function setText(id, v){
    const el = DOC.getElementById(id);
    if (el) el.textContent = String(v);
  }

  function hasExplicitView(){
    try{
      const v = new URL(location.href).searchParams.get('view');
      return !!(v && String(v).trim());
    }catch(_){ return false; }
  }

  function detectView(){
    // Priority:
    // 1) If has XR headset signature => vr
    // 2) If mobile + cardboard hint => cvr
    // 3) If mobile => mobile
    // 4) else => pc
    const ua = (navigator.userAgent || '').toLowerCase();
    const isMobile = /android|iphone|ipad|ipod/.test(ua) || (WIN.matchMedia && WIN.matchMedia('(max-width: 820px)').matches);
    const hasXR = !!(navigator.xr);

    if (hasXR && /oculus|quest|vive|pico|hololens/.test(ua)) return 'vr';

    const cvrHint = isMobile && (/cardboard|vrbox|daydream|gearvr|vr/.test(ua));
    if (cvrHint) return 'cvr';

    return isMobile ? 'mobile' : 'pc';
  }

  function normalizeView(v){
    v = String(v||'').toLowerCase();
    if (v==='cvr' || v==='cardboard') return 'cvr';
    if (v==='vr') return 'vr';
    if (v==='mobile') return 'mobile';
    if (v==='pc' || v==='desktop') return 'pc';
    return '';
  }

  function getRun(){
    const r = String(qs('run', qs('runMode', 'play'))).toLowerCase();
    return (r==='research') ? 'research' : 'play';
  }

  function buildTargetUrl(forcedView){
    const base = './hydration-vr/hydration-vr.html';
    const u0 = new URL(location.href);
    const out = new URL(base, location.href);

    // --- pass-through whitelist ---
    const passKeys = [
      'hub','run','runMode','diff','time','seed','style',
      'studyId','phase','conditionGroup',
      // research/site metadata (optional but useful)
      'siteCode','schoolYear','semester',
      'sessionId','studentKey',
      // logging / toggles
      'log','practice','ai','ts'
    ];

    passKeys.forEach(k=>{
      const v = u0.searchParams.get(k);
      if (v !== null) out.searchParams.set(k, v);
    });

    // ensure run/diff/time defaults if missing
    if (!out.searchParams.get('run') && out.searchParams.get('runMode')) out.searchParams.set('run', out.searchParams.get('runMode'));
    if (!out.searchParams.get('run')) out.searchParams.set('run', getRun());
    if (!out.searchParams.get('diff')) out.searchParams.set('diff', String(qs('diff','normal')));
    if (!out.searchParams.get('time')) out.searchParams.set('time', String(clamp(parseInt(qs('time',70),10)||70, 20, 600)));

    // ts default (important for session uniqueness)
    if (!out.searchParams.get('ts')) out.searchParams.set('ts', String(Date.now()));

    // view logic: DO NOT override if explicit view exists in current URL
    if (hasExplicitView()){
      out.searchParams.set('view', normalizeView(qs('view','')) || 'mobile');
    } else {
      let v = normalizeView(forcedView);
      if (!v){
        try{
          const last = normalizeView(localStorage.getItem(STORAGE_KEY));
          v = last || detectView();
        }catch(_){
          v = detectView();
        }
      }
      out.searchParams.set('view', v);
      try{ localStorage.setItem(STORAGE_KEY, v); }catch(_){}
    }

    return out;
  }

  function updatePreview(){
    const run = getRun();
    const diff = String(qs('diff','normal')).toLowerCase();
    const time = clamp(parseInt(qs('time',70),10)||70, 20, 600);

    let v = '';
    if (hasExplicitView()) v = normalizeView(qs('view','')) || 'auto';
    else {
      try{ v = normalizeView(localStorage.getItem(STORAGE_KEY)) || detectView(); }
      catch(_){ v = detectView(); }
    }

    setText('mNow', run);
    setText('dNow', diff);
    setText('tNow', time);
    setText('vNow', hasExplicitView() ? (normalizeView(qs('view','')) || 'auto') : v);

    const dst = buildTargetUrl('');
    setText('dst', dst.pathname + dst.search);

    setText('pass', [
      'hub','run','diff','time','seed','view','log','studyId','conditionGroup','ai','practice','ts'
    ].map(k=>k+'='+(dst.searchParams.get(k)||'')).join('&'));
  }

  function go(forcedView){
    const target = buildTargetUrl(forcedView);
    location.href = target.toString();
  }

  DOC.getElementById('btnGo')?.addEventListener('click', ()=>go(''));
  DOC.getElementById('btnPC')?.addEventListener('click', ()=>go('pc'));
  DOC.getElementById('btnMobile')?.addEventListener('click', ()=>go('mobile'));
  DOC.getElementById('btnVR')?.addEventListener('click', ()=>go('vr'));
  DOC.getElementById('btnCVR')?.addEventListener('click', ()=>go('cvr'));

  // Optional auto-redirect: set ?autogo=1
  const autogo = String(qs('autogo','0')) === '1';
  updatePreview();
  if (autogo){
    setTimeout(()=>go(''), 60);
  }
})();
</script>
</body>
</html>