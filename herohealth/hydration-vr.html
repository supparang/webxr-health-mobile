<!-- === /herohealth/hydration-vr.html ===
Hydration VR ‚Äî FULL HTML (PILLS HUD + Water Tube 0‚Äì100 + CARDBOARD STEREO + GAZE SNAP/SHOOT + SOUND + HUB FLUSH)
‚úÖ Works with: /herohealth/hydration-vr/hydration.safe.js (ESM)
‚úÖ Optional FX: /herohealth/vr/particles.js (path must exist)
‚úÖ WaterGauge IDs (single): #water-bar #water-pct #water-zone
‚úÖ Required IDs by hydration.safe.js:
   #playfield #hvr-layer
   #stat-score #stat-combo #stat-miss #stat-time #stat-grade
   #quest-line1..4 #storm-left #shield-count
‚úÖ Cardboard: 2 eyes split + mirrored targets (visual) + GAZE shoot at center
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Optional FX (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà /herohealth/vr/particles.js ‡∏à‡∏£‡∏¥‡∏á) -->
  <script src="./vr/particles.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.62);
      --panel2:rgba(15,23,42,.56);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;

      --good:rgba(34,197,94,1);
      --bad:rgba(248,113,113,1);
      --cyan:rgba(34,211,238,1);
      --amber:rgba(251,191,36,1);

      --radius:18px;
      --pill:999px;

      /* cardboard parallax */
      --px: 0px;
      --gaze: 0; /* 0..1 */
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0; overflow:hidden;
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
    }

    /* ===================== MASTER STAGE (logic) ===================== */
    #hvr-stage{
      position:fixed; inset:0;
      z-index:10;
      overflow:hidden;
      background:
        radial-gradient(circle at 22% 18%, rgba(56,189,248,.14), transparent 52%),
        radial-gradient(circle at 78% 82%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(99,102,241,.06), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,1));
    }
    body.cardboard #hvr-stage{ opacity:0; pointer-events:none; }

    #playfield{ position:absolute; inset:0; overflow:hidden; }
    #hvr-layer{ position:absolute; inset:0; transform: translate3d(0,0,0); will-change: transform; }

    /* crosshair */
    #crosshair{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:16px; height:16px; border-radius:999px;
      z-index:60; pointer-events:none;
      box-shadow:0 0 0 2px rgba(229,231,235,.30), 0 0 28px rgba(34,197,94,.14);
      background: rgba(229,231,235,.08);
      backdrop-filter: blur(8px);
    }
    #crosshair::after{
      content:'';
      position:absolute; inset:5px;
      border-radius:999px;
      background: rgba(229,231,235,.55);
    }

    /* lock highlight (applied to real master target) */
    .hvr-target.gaze-lock{
      outline: 3px solid rgba(34,197,94,.38) !important;
      box-shadow:
        0 0 0 6px rgba(34,197,94,.12),
        0 18px 60px rgba(0,0,0,.45) !important;
      filter: saturate(1.05) brightness(1.02);
      transform: translate(-50%,-50%) scale(1.03) !important;
    }

    /* hit vignette */
    #hitFx{
      position:fixed; inset:0;
      z-index:55; pointer-events:none;
      opacity:0; transition: opacity .08s linear;
      background: radial-gradient(circle at 50% 50%, rgba(2,6,23,0) 35%, rgba(2,6,23,.35) 70%, rgba(2,6,23,.65) 100%);
    }
    #hitFx.show{ opacity:1; }
    #hitFx[data-kind="bad"]{
      background: radial-gradient(circle at 50% 50%, rgba(248,113,113,0) 35%, rgba(248,113,113,.18) 70%, rgba(2,6,23,.70) 100%);
    }
    #hitFx[data-kind="good"]{
      background: radial-gradient(circle at 50% 50%, rgba(34,197,94,0) 35%, rgba(34,197,94,.14) 70%, rgba(2,6,23,.70) 100%);
    }
    #hitFx[data-kind="shield"]{
      background: radial-gradient(circle at 50% 50%, rgba(34,211,238,0) 35%, rgba(34,211,238,.14) 70%, rgba(2,6,23,.70) 100%);
    }

    /* ===================== HUD PILLS ===================== */
    #hudTop{
      position:fixed; left:10px; right:10px; top:10px;
      z-index:90;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      pointer-events:none;
    }
    .hudCard{
      pointer-events:none;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
      min-width:0;
    }
    .hudRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; gap:8px; align-items:baseline;
      padding:7px 10px;
      border-radius:var(--pill);
      background:rgba(15,23,42,.48);
      border:1px solid rgba(148,163,184,.16);
      font-weight:1000;
      white-space:nowrap;
    }
    .k{ color:var(--muted); font-weight:900; font-size:11px; letter-spacing:.2px; }
    .v{ font-size:15px; font-weight:1100; }

    /* mini pills */
    #miniPills{
      position:fixed; left:10px; bottom:10px;
      z-index:95;
      display:flex; gap:8px; flex-wrap:wrap;
      pointer-events:none;
    }

    /* ===================== QUEST PANEL ===================== */
    #questPanel{
      position:fixed; left:10px; right:10px; bottom:72px;
      z-index:92; pointer-events:none;
    }
    #questCard{
      background:var(--panel2);
      border:1px solid rgba(148,163,184,.16);
      border-radius:var(--radius);
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
    }
    .qline{ font-weight:1000; color:rgba(229,231,235,.92); line-height:1.25; margin:2px 0; word-break:break-word; }
    .qline.muted{ color:rgba(148,163,184,.95); font-weight:950; }

    /* ===================== WATER TUBE (single IDs) ===================== */
    #waterDock{
      position:fixed; right:10px; bottom:10px;
      z-index:96; pointer-events:none;
      width:min(220px, 44vw);
    }
    #waterCard{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
    }
    #tubeWrap{ margin-top:10px; display:flex; gap:12px; align-items:stretch; }
    #tube{
      position:relative;
      width:26px; height:132px;
      border-radius:999px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
      box-shadow: inset 0 10px 26px rgba(0,0,0,.35);
    }
    #tube::before{
      content:'';
      position:absolute; inset:0;
      background:
        linear-gradient(180deg,
          rgba(248,113,113,.35) 0%,
          rgba(248,113,113,.18) 33%,
          rgba(34,197,94,.20) 33%,
          rgba(34,197,94,.18) 66%,
          rgba(251,191,36,.22) 66%,
          rgba(251,191,36,.18) 100%);
      opacity:.55;
      filter:saturate(1.1);
    }
    #water-bar{
      position:absolute; left:0; right:0; bottom:0;
      height:50%;
      width:100%;
      transform: translateZ(0);
      background:
        linear-gradient(180deg, rgba(229,231,235,.10), rgba(229,231,235,0)),
        linear-gradient(180deg, rgba(34,211,238,.35), rgba(34,211,238,.10));
      box-shadow: 0 0 20px rgba(34,211,238,.12);
    }
    body.water-low  #water-bar{ background: linear-gradient(180deg, rgba(229,231,235,.10), rgba(229,231,235,0)), linear-gradient(180deg, rgba(248,113,113,.35), rgba(248,113,113,.12)); box-shadow:0 0 22px rgba(248,113,113,.12); }
    body.water-green#water-bar{ background: linear-gradient(180deg, rgba(229,231,235,.10), rgba(229,231,235,0)), linear-gradient(180deg, rgba(34,197,94,.32), rgba(34,197,94,.10)); box-shadow:0 0 22px rgba(34,197,94,.12); }
    body.water-high #water-bar{ background: linear-gradient(180deg, rgba(229,231,235,.10), rgba(229,231,235,0)), linear-gradient(180deg, rgba(251,191,36,.34), rgba(251,191,36,.12)); box-shadow:0 0 22px rgba(251,191,36,.12); }

    #tubeScale{
      flex:1;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:2px 0;
      color:rgba(148,163,184,.95);
      font-weight:1000;
      font-size:11px;
    }
    .scaleRow{ display:flex; justify-content:space-between; gap:10px; }
    .badge{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.48);
      font-weight:1100;
      gap:8px;
      align-items:baseline;
      white-space:nowrap;
    }

    /* ===================== CONTROLS ===================== */
    #controls{
      position:fixed; right:10px; top:10px;
      z-index:110;
      display:flex; gap:10px;
      pointer-events:auto;
    }
    .btn{
      background:rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.20);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1100;
      box-shadow:0 16px 36px rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    #shootPad{
      position:fixed; left:50%; bottom:10px;
      transform:translateX(-50%);
      z-index:120;
      display:none;
      pointer-events:auto;
    }
    body.cardboard #shootPad{ display:block; }
    #btnShoot{
      padding:14px 18px;
      border-radius:18px;
      font-size:16px;
      font-weight:1200;
      min-width:200px;
    }

    /* ===================== START OVERLAY (gate) ===================== */
    #startOverlay{
      position:fixed; inset:0; z-index:1400;
      display:flex; align-items:center; justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(12px);
      pointer-events:auto;
    }
    #startCard{
      width:min(760px,92vw);
      background:rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow:0 26px 80px rgba(0,0,0,.55);
    }
    #startTitle{ font-weight:1200; font-size:20px; }
    #startDesc{ color:rgba(148,163,184,.95); font-weight:1000; margin-top:8px; line-height:1.35; }
    #startMeta{ color:rgba(148,163,184,.92); font-weight:1000; margin-top:10px; font-size:12px; }
    #startBtns{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }

    /* ===================== RESULT OVERLAY ===================== */
    #resultBackdrop{
      position:fixed; inset:0; z-index:1500;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(12px);
      pointer-events:auto;
    }
    #resultCard{
      width:min(820px,92vw);
      background:rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow:0 26px 80px rgba(0,0,0,.55);
    }
    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:12px; }
    .cell{ background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px; }
    .cell .k{ display:block; margin-bottom:4px; }
    #resultActions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }

    /* ===================== CARDBOARD STEREO ===================== */
    #cbWrap{
      position:fixed; inset:0;
      z-index:2000;
      display:none;
      background:#000;
    }
    body.cardboard #cbWrap{ display:flex; }

    .cbEye{ position:relative; flex:1; overflow:hidden; border-left:1px solid rgba(255,255,255,.10); }
    .cbEye:first-child{ border-left:none; }

    .eyeWorld{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 22% 18%, rgba(56,189,248,.10), transparent 52%),
        radial-gradient(circle at 78% 82%, rgba(34,197,94,.08), transparent 55%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,1));
      transform: translate3d(var(--eyeShift,0px), 0, 0);
      will-change: transform;
    }
    .eyeLayer{
      position:absolute; inset:0;
      transform: translate3d(var(--layerShift,0px),0,0);
      will-change: transform;
      pointer-events:none; /* visual only */
    }

    .eyeCross{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:18px; height:18px; border-radius:999px;
      box-shadow: 0 0 0 2px rgba(229,231,235,.34), 0 0 30px rgba(34,197,94,.14);
      background: rgba(229,231,235,.08);
      backdrop-filter: blur(8px);
      pointer-events:none;
    }
    .eyeCross::after{
      content:''; position:absolute; inset:5px; border-radius:999px;
      background: rgba(229,231,235,.55);
    }

    /* gaze ring */
    .gazeRing{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:46px; height:46px;
      border-radius:999px;
      pointer-events:none;
      opacity:.95;
      background:
        conic-gradient(rgba(34,197,94,.92) calc(var(--gaze)*1turn), rgba(229,231,235,.10) 0);
      mask: radial-gradient(circle, transparent 58%, #000 60%);
      -webkit-mask: radial-gradient(circle, transparent 58%, #000 60%);
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.55));
    }

    /* safe-area */
    @supports(padding:max(0px)){
      #hudTop{ top: max(10px, env(safe-area-inset-top)); }
      #controls{ top: max(10px, env(safe-area-inset-top)); }
      #miniPills{ bottom: max(10px, env(safe-area-inset-bottom)); }
      #waterDock{ bottom: max(10px, env(safe-area-inset-bottom)); }
      #shootPad{ bottom: max(10px, env(safe-area-inset-bottom)); }
    }
  </style>

  <!-- ‚úÖ Game module -->
  <script type="module" src="./hydration-vr/hydration.safe.js"></script>
</head>

<body>
  <!-- MASTER STAGE -->
  <div id="hvr-stage">
    <div id="playfield">
      <div id="hvr-layer" aria-label="hydration targets layer"></div>
    </div>
  </div>

  <div id="hitFx"></div>
  <div id="crosshair" aria-hidden="true"></div>

  <!-- TOP HUD -->
  <div id="hudTop">
    <div class="hudCard" style="flex:1">
      <div class="hudRow">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span id="stat-time" class="v">0</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span id="stat-score" class="v">0</span></span>
        <span class="pill">‚ö° <span class="k">COMBO</span> <span id="stat-combo" class="v">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span id="stat-miss" class="v">0</span></span>
        <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span id="stat-grade" class="v">C</span></span>
      </div>
    </div>

    <div class="hudCard" style="flex:0 0 auto">
      <div class="hudRow" style="justify-content:flex-end">
        <span class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <span id="shield-count" class="v">0</span></span>
        <span class="pill">üå™Ô∏è <span class="k">STORM</span> <span id="storm-left" class="v">0</span></span>
        <span class="pill">üíß <span class="k">WATER</span> <span id="hudWaterPct" class="v">0%</span></span>
        <span class="pill">üéØ <span class="k">ZONE</span> <span id="hudWaterZone" class="v">‚Äî</span></span>
      </div>
    </div>
  </div>

  <!-- MINI HUD (pills) -->
  <div id="miniPills">
    <span class="pill">üíß <span class="k">HIT GOOD</span> <span class="v" id="miniGood">0</span></span>
    <span class="pill">ü•§ <span class="k">HIT JUNK</span> <span class="v" id="miniBad">0</span></span>
    <span class="pill">üß™ <span class="k">MODE</span> <span class="v" id="miniMode">PLAY</span></span>
    <span class="pill">üéöÔ∏è <span class="k">DIFF</span> <span class="v" id="miniDiff">NORMAL</span></span>
  </div>

  <!-- QUEST PANEL -->
  <div id="questPanel">
    <div id="questCard">
      <div class="qline" id="quest-line1">Goal: ‚Äî</div>
      <div class="qline muted" id="quest-line2">‚Äî</div>
      <div class="qline" id="quest-line3">Mini: ‚Äî</div>
      <div class="qline muted" id="quest-line4">‚Äî</div>
    </div>
  </div>

  <!-- WATER TUBE (single IDs for ui-water.js) -->
  <div id="waterDock">
    <div id="waterCard">
      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px;">
        <div style="font-weight:1200">WATER GAUGE</div>
        <div class="badge">üéØ <span class="k">ZONE</span> <span id="water-zone" class="v">GREEN</span></div>
      </div>

      <div id="tubeWrap">
        <div id="tube" aria-label="water tube">
          <div id="water-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"></div>
        </div>

        <div id="tubeScale">
          <div class="scaleRow"><span>100</span><span style="opacity:.9">HIGH</span></div>
          <div class="scaleRow"><span>75</span><span style="opacity:.9">‚Äî</span></div>
          <div class="scaleRow"><span>50</span><span style="opacity:.9">GREEN</span></div>
          <div class="scaleRow"><span>25</span><span style="opacity:.9">‚Äî</span></div>
          <div class="scaleRow"><span>0</span><span style="opacity:.9">LOW</span></div>

          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <span class="badge">üíß <span class="k">PCT</span> <span id="water-pct" class="v">50%</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div id="controls">
    <button class="btn" id="btnCardboard">üì¶ CARDBOARD</button>
    <button class="btn" id="btnBackHub">üè† HUB</button>
    <button class="btn" id="btnRestart">üîÅ RESTART</button>
  </div>

  <!-- big shoot button for cardboard -->
  <div id="shootPad">
    <button class="btn" id="btnShoot">üéØ SHOOT (GAZE)</button>
  </div>

  <!-- START OVERLAY -->
  <div id="startOverlay">
    <div id="startCard">
      <div id="startTitle">Hydration VR üíß</div>
      <div id="startDesc">
        ‡∏¢‡∏¥‡∏á ‚Äú‡∏ô‡πâ‡∏≥‡∏î‡∏µ‚Äù üíß ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ß‡∏±‡∏á ‚Äú‡∏Ç‡∏¢‡∏∞‡∏ô‡πâ‡∏≥‚Äù ü•§<br/>
        <b>Cardboard:</b> ‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ <b>GAZE</b> (‡∏°‡∏µ Snap Assist) ‚Äî ‡∏ß‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞
      </div>
      <div id="startMeta">run=<b id="metaRun">play</b> ‚Ä¢ diff=<b id="metaDiff">normal</b> ‚Ä¢ time=<b id="metaTime">70</b>s</div>
      <div id="startBtns">
        <button class="btn" id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- RESULT OVERLAY -->
  <div id="resultBackdrop">
    <div id="resultCard">
      <div style="font-weight:1200; font-size:20px">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏Å‡∏° (Hydration VR)</div>
      <div style="color:rgba(148,163,184,.95); font-weight:1000; margin-top:6px">
        Mode: <span id="rMode">‚Äî</span> ‚Ä¢ Diff: <span id="rDiff">‚Äî</span> ‚Ä¢ Grade: <span id="rGrade">‚Äî</span>
      </div>

      <div class="grid">
        <div class="cell"><span class="k">Score</span><span id="rScore" class="v">0</span></div>
        <div class="cell"><span class="k">Max Combo</span><span id="rMaxCombo" class="v">0</span></div>
        <div class="cell"><span class="k">Miss</span><span id="rMiss" class="v">0</span></div>
        <div class="cell"><span class="k">Accuracy</span><span id="rAcc" class="v">0%</span></div>
        <div class="cell"><span class="k">Goals</span><span id="rGoals" class="v">0/0</span></div>
        <div class="cell"><span class="k">Minis</span><span id="rMinis" class="v">0/0</span></div>
      </div>

      <div id="resultActions">
        <button class="btn" id="btnPlayAgain">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn" id="btnBackHub2">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- CARDBOARD STEREO -->
  <div id="cbWrap" aria-label="cardboard stereo view">
    <div class="cbEye" id="eyeL">
      <div class="eyeWorld" style="--eyeShift: calc(var(--px) * -0.40);">
        <div class="eyeLayer" id="eyeLayerL" style="--layerShift: calc(var(--px) * -0.65);"></div>
        <div class="eyeCross"></div>
        <div class="gazeRing" id="gazeRingL" style="--gaze: var(--gaze)"></div>
      </div>
    </div>
    <div class="cbEye" id="eyeR">
      <div class="eyeWorld" style="--eyeShift: calc(var(--px) * 0.40);">
        <div class="eyeLayer" id="eyeLayerR" style="--layerShift: calc(var(--px) * 0.65);"></div>
        <div class="eyeCross"></div>
        <div class="gazeRing" id="gazeRingR" style="--gaze: var(--gaze)"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    const D = document;
    const body = D.body;
    const $ = (id)=>D.getElementById(id);

    const startOverlay = $('startOverlay');
    const btnStart = $('btnStart');
    const btnCardboard = $('btnCardboard');
    const btnBackHub = $('btnBackHub');
    const btnBackHub2 = $('btnBackHub2');
    const btnRestart = $('btnRestart');
    const btnPlayAgain = $('btnPlayAgain');
    const btnShoot = $('btnShoot');

    const hitFx = $('hitFx');
    const masterLayer = $('hvr-layer');
    const masterPlayfield = $('playfield');
    const eyeLayerL = $('eyeLayerL');
    const eyeLayerR = $('eyeLayerR');

    // meta
    function qs(name, def){
      try{ return (new URL(location.href)).searchParams.get(name) ?? def; }catch{ return def; }
    }
    const run = String(qs('run', qs('runMode','play'))).toLowerCase();
    const diff = String(qs('diff','normal')).toLowerCase();
    const time = Number.parseInt(qs('time', qs('durationPlannedSec', 70)), 10) || 70;
    $('metaRun').textContent = run;
    $('metaDiff').textContent = diff;
    $('metaTime').textContent = String(time);

    $('miniMode').textContent = (run === 'research') ? 'RESEARCH' : 'PLAY';
    $('miniDiff').textContent = diff.toUpperCase();

    // ------------------ SOUND (tick/beep) ------------------
    let audioCtx = null;
    function ensureAudio(){
      if (audioCtx) return audioCtx;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return null;
      audioCtx = new AC();
      return audioCtx;
    }
    function beep(freq=660, ms=35, gain=0.045){
      try{
        const ctx = ensureAudio();
        if (!ctx) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        const t = ctx.currentTime;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t + 0.010);
        g.gain.exponentialRampToValueAtTime(0.0001, t + ms/1000);
        o.start(t);
        o.stop(t + ms/1000 + 0.02);
      }catch{}
    }

    async function resumeAudio(){
      try{
        const ctx = ensureAudio();
        if (!ctx) return;
        if (ctx.state === 'suspended') await ctx.resume();
      }catch{}
    }

    // ------------------ FX flash ------------------
    function flash(kind){
      if (!hitFx) return;
      hitFx.dataset.kind = kind || '';
      hitFx.classList.add('show');
      setTimeout(()=>hitFx.classList.remove('show'), 90);
    }

    // ------------------ Water tube vertical mapping ------------------
    const waterBar = $('water-bar');
    const waterPct = $('water-pct');
    const waterZone= $('water-zone');
    const hudWaterPct = $('hudWaterPct');
    const hudWaterZone= $('hudWaterZone');

    function syncTube(){
      if (!waterBar) return;
      const w = parseFloat(String(waterBar.style.width || '0').replace('%','')) || 0;
      const h = Math.max(0, Math.min(100, w));
      waterBar.style.height = h.toFixed(2) + '%';
      waterBar.style.width = '100%';
      if (hudWaterPct && waterPct) hudWaterPct.textContent = String(waterPct.textContent || '0%');
      if (hudWaterZone && waterZone) hudWaterZone.textContent = String(waterZone.textContent || '‚Äî');
    }
    try{
      const mo = new MutationObserver(()=>syncTube());
      if (waterBar) mo.observe(waterBar, { attributes:true, attributeFilter:['style'] });
      if (waterPct) mo.observe(waterPct, { childList:true, subtree:true });
      if (waterZone) mo.observe(waterZone, { childList:true, subtree:true });
      setInterval(syncTube, 250);
    }catch{}

    // ------------------ Event mirrors ------------------
    window.addEventListener('hha:judge', (ev)=>{
      const d = ev.detail || {};
      const k = String(d.kind || '');
      if (k === 'good') { flash('good'); beep(720, 26, 0.032); }
      else if (k === 'bad') { flash('bad'); beep(220, 40, 0.040); }
      else if (k === 'shield' || k === 'block') { flash('shield'); beep(520, 28, 0.030); }
    }, { passive:true });

    window.addEventListener('hha:score', (ev)=>{
      const d = ev.detail || {};
      if (typeof d.nHitGood === 'number') $('miniGood').textContent = String(d.nHitGood|0);
      if (typeof d.nHitJunk === 'number') $('miniBad').textContent  = String(d.nHitJunk|0);
    }, { passive:true });

    // ------------------ Result overlay ------------------
    const resultBackdrop = $('resultBackdrop');
    function showResult(summary){
      try{
        $('rMode').textContent = String(summary.runMode || run || 'play');
        $('rDiff').textContent = String(summary.diff || diff || 'normal');
        $('rGrade').textContent = String(summary.grade || 'C');
        $('rScore').textContent = String(summary.scoreFinal ?? 0);
        $('rMaxCombo').textContent = String(summary.comboMax ?? 0);
        $('rMiss').textContent = String(summary.misses ?? 0);
        $('rAcc').textContent = String(((summary.accuracyGoodPct ?? 0)|0)) + '%';
        $('rGoals').textContent = String(summary.goalsCleared ?? 0) + '/' + String(summary.goalsTotal ?? 0);
        $('rMinis').textContent = String(summary.miniCleared ?? 0) + '/' + String(summary.miniTotal ?? 0);
      }catch{}
      if (resultBackdrop) resultBackdrop.style.display = 'flex';
      beep(880, 60, 0.040);
    }
    window.addEventListener('hha:end', (ev)=> showResult((ev && ev.detail) ? ev.detail : {}), { passive:true });

    // ------------------ Start gate ------------------
    async function requestMotionPermissionIfNeeded(){
      try{
        const DM = window.DeviceMotionEvent;
        if (!DM || typeof DM.requestPermission !== 'function') return;
        await DM.requestPermission();
      }catch{}
    }

    if (btnStart){
      btnStart.addEventListener('click', async ()=>{
        await resumeAudio();
        await requestMotionPermissionIfNeeded();
        if (startOverlay) startOverlay.style.display = 'none';
        beep(660, 40, 0.040);
      }, { passive:false });
    }

    // ------------------ Restart ------------------
    if (btnRestart) btnRestart.addEventListener('click', ()=>location.reload());
    if (btnPlayAgain) btnPlayAgain.addEventListener('click', ()=>location.reload());

    // ------------------ HUB flush-hardened ------------------
    async function gotoHub(){
      const hub = String(qs('hub','./hub.html'));
      try{
        const H = window.__HVR__;
        if (H && typeof H.forceEnd === 'function'){
          const p = H.forceEnd('backhub');
          await Promise.race([ p, new Promise(r=>setTimeout(r, 850)) ]);
        } else {
          try{ window.dispatchEvent(new CustomEvent('hha:force_end', { detail:{ reason:'backhub' } })); }catch{}
          await new Promise(r=>setTimeout(r, 450));
        }
      }catch{}
      try{
        const u = new URL(hub, location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }catch{
        location.href = hub;
      }
    }
    if (btnBackHub) btnBackHub.addEventListener('click', (e)=>{ e.preventDefault(); gotoHub(); });
    if (btnBackHub2) btnBackHub2.addEventListener('click', (e)=>{ e.preventDefault(); gotoHub(); });

    // ------------------ Cardboard toggle ------------------
    let isCardboard = false;
    function setCardboard(on){
      isCardboard = !!on;
      body.classList.toggle('cardboard', isCardboard);
      syncTube();
      beep(isCardboard ? 520 : 360, 35, 0.035);
    }
    if (btnCardboard){
      btnCardboard.addEventListener('click', ()=>{
        setCardboard(!isCardboard);
      });
    }

    // ------------------ GAZE SNAP / LOCK / SHOOT ------------------
    let gazeHoldBaseMs = 420;       // ‚úÖ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
    let acquirePx = 62;             // ‚úÖ ‡∏à‡∏±‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
    let releaseMul = 1.35;          // ‚úÖ hysteresis (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏∏‡∏î‡∏á‡πà‡∏≤‡∏¢)
    let gazeT = 0;
    let lastTs = performance.now();

    let lockedEl = null;
    let lockedUid = '';
    let stepTick = 0; // 0..4

    function clearLock(){
      try{ if (lockedEl) lockedEl.classList.remove('gaze-lock'); }catch{}
      lockedEl = null; lockedUid = '';
      gazeT = 0; stepTick = 0;
      body.style.setProperty('--gaze', '0');
    }

    function computeCenter(){
      const r = masterPlayfield.getBoundingClientRect();
      return { r, cx: r.left + r.width*0.5, cy: r.top + r.height*0.5 };
    }

    function distToCenter(el, r, cx, cy){
      const sx = el.style.getPropertyValue('--x') || '';
      const sy = el.style.getPropertyValue('--y') || '';
      const ss = el.style.getPropertyValue('--s') || '';
      const xPct = parseFloat(String(sx).replace('%',''));
      const yPct = parseFloat(String(sy).replace('%',''));
      const sPx  = parseFloat(String(ss).replace('px','')) || 64;
      if (!Number.isFinite(xPct) || !Number.isFinite(yPct)) return null;
      const x = r.left + (xPct/100) * r.width;
      const y = r.top  + (yPct/100) * r.height;
      const d = Math.hypot(x-cx, y-cy);
      const score = d - (sPx * 0.14); // ‚úÖ ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà
      return { d, score, sPx };
    }

    function findBestTarget(){
      if (!masterLayer || !masterPlayfield) return null;
      const { r, cx, cy } = computeCenter();
      const nodes = masterLayer.querySelectorAll('.hvr-target');
      if (!nodes || !nodes.length) return null;

      let best = null;
      let bestScore = 1e9;

      for (const el of nodes){
        const m = distToCenter(el, r, cx, cy);
        if (!m) continue;
        // accept within acquire
        if (m.d > acquirePx) continue;
        if (m.score < bestScore){
          bestScore = m.score;
          best = { el, d:m.d, sPx:m.sPx, uid: el.dataset.uid || '' };
        }
      }
      return best;
    }

    function stillValidLock(){
      if (!lockedEl || !lockedEl.isConnected) return false;
      const { r, cx, cy } = computeCenter();
      const m = distToCenter(lockedEl, r, cx, cy);
      if (!m) return false;
      return m.d <= acquirePx * releaseMul;
    }

    function shootEl(el){
      if (!el) return false;
      try{
        const ev = new PointerEvent('pointerdown', { bubbles:true, cancelable:true, pointerType:'mouse' });
        el.dispatchEvent(ev);
        beep(900, 35, 0.045);
        return true;
      }catch{
        try{ el.click(); beep(900, 35, 0.045); return true; }catch{}
      }
      return false;
    }

    function manualShoot(){
      if (lockedEl && lockedEl.isConnected){
        shootEl(lockedEl);
        gazeT = 0; stepTick = 0;
        body.style.setProperty('--gaze','0');
        return;
      }
      const b = findBestTarget();
      if (b) shootEl(b.el);
    }

    if (btnShoot){
      btnShoot.addEventListener('click', (e)=>{
        e.preventDefault();
        manualShoot();
      });
    }

    function gazeLoop(){
      const ts = performance.now();
      const dt = Math.max(0, ts - lastTs);
      lastTs = ts;

      if (!isCardboard){
        clearLock();
        requestAnimationFrame(gazeLoop);
        return;
      }

      // lock Ïú†ÏßÄ (hysteresis)
      if (!stillValidLock()){
        clearLock();
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ lock -> ‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
      if (!lockedEl){
        const b = findBestTarget();
        if (b){
          lockedEl = b.el;
          lockedUid = b.uid || '';
          try{ lockedEl.classList.add('gaze-lock'); }catch{}
          beep(520, 18, 0.020); // lock tick
        }
      } else {
        // update lock class safety
        try{ lockedEl.classList.add('gaze-lock'); }catch{}
      }

      // ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á (snap assist: ‡πÉ‡∏Å‡∏•‡πâ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏°‡∏≤‡∏Å ‡∏¢‡∏¥‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î)
      if (lockedEl){
        const { r, cx, cy } = computeCenter();
        const m = distToCenter(lockedEl, r, cx, cy);
        const dist = m ? m.d : acquirePx;
        const nearK = Math.max(0, Math.min(1, 1 - (dist / (acquirePx*1.0))));
        const holdMs = gazeHoldBaseMs * (1.00 - 0.28*nearK); // ‚úÖ ‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏¢‡∏¥‡∏á‡πÑ‡∏ß‡∏Å‡∏ß‡πà‡∏≤
        gazeT += dt;

        const g = Math.max(0, Math.min(1, gazeT / holdMs));
        body.style.setProperty('--gaze', String(g));

        // tick steps 25/50/75/100
        const step = (g >= 0.999) ? 4 : (g >= 0.75 ? 3 : (g >= 0.50 ? 2 : (g >= 0.25 ? 1 : 0)));
        if (step > stepTick){
          stepTick = step;
          if (step < 4) beep(620 + step*40, 12, 0.016);
        }

        if (g >= 1){
          stepTick = 0;
          gazeT = 0;
          shootEl(lockedEl);
        }
      } else {
        // decay
        gazeT = Math.max(0, gazeT - dt*0.9);
        body.style.setProperty('--gaze', String(Math.max(0, Math.min(1, gazeT/gazeHoldBaseMs))));
      }

      requestAnimationFrame(gazeLoop);
    }
    requestAnimationFrame(gazeLoop);

    // ------------------ Mirror targets into both eyes (visual) ------------------
    // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô MutationObserver (‡πÑ‡∏ß + ‡πÄ‡∏ö‡∏≤) ‡πÅ‡∏ó‡∏ô innerHTML ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ü‡∏£‡∏°
    function mirror(){
      if (!isCardboard || !masterLayer || !eyeLayerL || !eyeLayerR) return;
      const html = masterLayer.innerHTML;
      eyeLayerL.innerHTML = html;
      eyeLayerR.innerHTML = html;
    }
    try{
      const mo = new MutationObserver(()=> mirror());
      if (masterLayer) mo.observe(masterLayer, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'] });
    }catch{}
    setInterval(mirror, 120);

    // ------------------ Simple parallax (gyro/drag) ------------------
    let px = 0, lastX = 0, dragging = false;
    function setPX(v){
      px = Math.max(-30, Math.min(30, v));
      body.style.setProperty('--px', px.toFixed(2) + 'px');
    }
    window.addEventListener('pointerdown', (e)=>{ if(!isCardboard) return; dragging=true; lastX=e.clientX; }, { passive:true });
    window.addEventListener('pointermove', (e)=>{
      if(!isCardboard || !dragging) return;
      const dx = e.clientX - lastX; lastX = e.clientX;
      setPX(px + dx*0.08);
    }, { passive:true });
    window.addEventListener('pointerup', ()=>{ dragging=false; }, { passive:true });
    window.addEventListener('deviceorientation', (e)=>{
      if(!isCardboard) return;
      const gamma = Number(e.gamma);
      if(!Number.isFinite(gamma)) return;
      setPX(gamma*0.22);
    }, { passive:true });

    // autostart
    if (qs('autostart','0') === '1'){
      if (startOverlay) startOverlay.style.display = 'none';
    }

    // keep tube synced early
    setTimeout(syncTube, 60);
  })();
  </script>
</body>
</html>