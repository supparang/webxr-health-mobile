<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (for Cardboard/EnterVR events + VR mode) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + input compat + logger (IIFE / non-module) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Page CSS -->
  <link rel="stylesheet" href="./hydration-vr/hydration-vr.css" />

</head>
<body>

  <!-- Minimal A-Frame scene to enable EnterVR / Cardboard -->
  <a-scene id="vrscene"
           embedded
           vr-mode-ui="enabled:false"
           renderer="antialias:true; colorManagement:true;"
           style="position:fixed; inset:0; z-index:0; background:transparent;">
    <a-entity camera position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- ======= VR HUD (2 lines) ======= -->
  <div id="vrhud" aria-hidden="true">
    <div class="vrhud-row">
      <div class="vrhud-pill">‚è± <span id="vh-time">--</span></div>
      <div class="vrhud-pill">üèÅ <span id="vh-score">0</span></div>
      <div class="vrhud-pill">üíß <span id="vh-zone">GREEN</span></div>
      <div class="vrhud-pill">üõ°Ô∏è <span id="vh-shield">0</span></div>
      <div class="vrhud-pill">üå™Ô∏è <span id="vh-storm">--</span></div>
    </div>
    <div class="vrhud-row vrhud-row2">
      <div class="vrhud-pill">Goal: <span id="vh-goal">--</span></div>
      <div class="vrhud-pill">Mini: <span id="vh-mini">--</span></div>
    </div>
  </div>

  <!-- ======= Main UI Layer ======= -->
  <div id="app">

    <!-- Top bar -->
    <div id="topbar">
      <div id="stats" class="panel">
        <div class="panel-title">üìä Stats</div>
        <div class="stats-row">
          <div>Score <b id="stat-score">0</b></div>
          <div>Combo <b id="stat-combo">0</b> (Max <b id="stat-combo-max">0</b>)</div>
          <div>Miss <b id="stat-miss">0</b></div>
          <div>Time <b id="stat-time">70</b></div>
          <div>Grade <b id="stat-grade">C</b></div>
        </div>
      </div>

      <div id="coach-box" class="panel">
        <div class="panel-title">üí¨ Coach</div>
        <div id="coach-text" class="coach-text">‡πÅ‡∏ï‡∏∞ START ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
        <div id="coach-sub" class="coach-sub">Goal ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏ô 1/3 ‚Üí 2/3 ‚Üí 3/3 ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠ Storm mini!</div>
      </div>
    </div>

    <!-- Play area -->
    <div id="main">
      <div id="playfield-wrap">
        <div id="playfield">
          <div id="hvr-layer"></div>
        </div>
      </div>

      <!-- Right rail -->
      <aside id="right-rail">
        <div id="quest-panel" class="panel">
          <div class="panel-title">üß© Quest</div>

          <div class="quest-lines">
            <div id="quest-line1" class="qline">‚Äî</div>
            <div id="quest-line2" class="qline muted">‚Äî</div>
            <div id="quest-line3" class="qline">‚Äî</div>
            <div id="quest-line4" class="qline muted">‚Äî</div>
          </div>

          <div class="mini-card">
            <div class="mini-head">
              <div class="mini-title">üå™Ô∏è Storm Mini: Shield Timing (FULL)</div>
              <div class="mini-meta">Storm in <span id="mini-storm-in">--</span>s</div>
            </div>

            <div class="mini-row">
              <span class="mini-dot" id="mini-c-storm"></span>
              <span class="mini-label">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Storm</span>
              <span class="mini-val" id="mini-v-storm">‚Äî</span>
            </div>

            <div class="mini-row">
              <span class="mini-dot" id="mini-c-zone"></span>
              <span class="mini-label">‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏≠‡∏á LOW/HIGH (‡∏´‡πâ‡∏≤‡∏° GREEN)</span>
              <span class="mini-val" id="mini-v-zone">‚Äî</span>
            </div>

            <div class="mini-row">
              <span class="mini-dot" id="mini-c-pressure"></span>
              <span class="mini-label">Pressure ‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>
              <span class="mini-val" id="mini-v-pressure">‚Äî</span>
            </div>

            <div class="mini-row">
              <span class="mini-dot" id="mini-c-end"></span>
              <span class="mini-label">‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏ (End-window)</span>
              <span class="mini-val" id="mini-v-end">‚Äî</span>
            </div>

            <div class="mini-row">
              <span class="mini-dot" id="mini-c-block"></span>
              <span class="mini-label">‡∏ö‡∏•‡πá‡∏≠‡∏Å BAD ‡∏î‡πâ‡∏ß‡∏¢ Shield ‚Äú‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‚Äù</span>
              <span class="mini-val" id="mini-v-block">0/0</span>
            </div>

            <div class="mini-pressure">
              <div class="mini-pressure-top">
                <span>Pressure bar</span>
                <span><b id="mini-pressure-pct">0</b>%</span>
              </div>
              <div class="mini-pressure-track">
                <div id="mini-pressure-bar" class="mini-pressure-bar" style="width:0%"></div>
              </div>
            </div>
          </div>

        </div>
      </aside>
    </div>

    <!-- Water gauge bottom-left -->
    <div id="water-gauge" class="panel">
      <div class="panel-title">üíß Water Gauge</div>
      <div class="wg-row">
        <div>Zone <b id="water-zone">GREEN</b></div>
        <div><b id="water-pct">50%</b></div>
      </div>
      <div class="wg-track">
        <div id="water-bar" class="wg-bar" style="width:50%"></div>
      </div>
      <div class="wg-row wg-row2">
        <div>Shield <b id="shield-count">0</b></div>
        <div>Storm <b id="storm-left">0</b>s</div>
      </div>
    </div>

    <!-- Stamp -->
    <div id="hha-stamp" aria-hidden="true">
      <div id="stamp-big">OK</div>
      <div id="stamp-small">‚Äî</div>
    </div>

    <!-- Start overlay -->
    <div id="start-overlay">
      <div class="start-card">
        <div class="start-title">Hydration VR</div>
        <div class="start-sub">‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà GREEN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô Goal ‚Ä¢ ‡πÄ‡∏à‡∏≠ Storm ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà GREEN</div>

        <div class="start-actions">
          <button id="btn-start" class="btn primary" type="button">‚ñ∂ START</button>
          <button id="btn-vr" class="btn" type="button">üï∂Ô∏è Enter VR</button>
          <button id="btn-stop" class="btn danger" type="button">‚èπ Stop</button>
        </div>

        <div class="start-hint">Tip: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡πà‡∏ô</div>
      </div>
    </div>

    <!-- End summary -->
    <div id="hvr-end" style="display:none;">
      <div class="endCard">
        <div class="endTop">
          <div class="endTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
          <div class="endBtns">
            <button id="btn-retry" class="btn primary" type="button">üîÅ Retry</button>
            <!-- Back to HUB will be injected by safe.js -->
          </div>
        </div>

        <div class="endGrid">
          <div class="endBox"><div class="k">Score</div><div class="v" id="end-score">0</div></div>
          <div class="endBox"><div class="k">Grade</div><div class="v" id="end-grade">C</div></div>
          <div class="endBox"><div class="k">Combo Max</div><div class="v" id="end-combo">0</div></div>
          <div class="endBox"><div class="k">Miss</div><div class="v" id="end-miss">0</div></div>
          <div class="endBox"><div class="k">Goals</div><div class="v" id="end-goals">0/3</div></div>
          <div class="endBox"><div class="k">Minis</div><div class="v" id="end-minis">0/0</div></div>
        </div>

        <div class="endNote muted">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <code>localStorage:HHA_LAST_SUMMARY</code> ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á event <code>hha:end</code>
        </div>
      </div>
    </div>

  </div><!-- /#app -->

  <!-- ===== VR mode class toggles + VR HUD listeners ===== -->
  <script>
  (function(){
    const doc = document;
    const root = doc.documentElement;
    function isMobile(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

    // Toggle classes on enter/exit VR (Cardboard uses enter-vr too)
    function bindVrEvents(){
      const scene = doc.querySelector('a-scene');
      if(!scene) return;

      scene.addEventListener('enter-vr', ()=>{
        root.classList.add('is-vr');
        if (isMobile()) root.classList.add('is-cardboard');
      });
      scene.addEventListener('exit-vr', ()=>{
        root.classList.remove('is-vr','is-cardboard');
      });
    }

    // VR HUD updates (2 lines)
    function bindVrHud(){
      const $ = (id)=>doc.getElementById(id);
      const el = {
        time: $('vh-time'),
        score:$('vh-score'),
        zone: $('vh-zone'),
        shield:$('vh-shield'),
        storm:$('vh-storm'),
        goal:$('vh-goal'),
        mini:$('vh-mini'),
      };

      window.addEventListener('hha:time', (ev)=>{
        const d = ev.detail || {};
        if(el.time) el.time.textContent = String(d.secLeft ?? '--');
      });

      window.addEventListener('hha:score', (ev)=>{
        const d = ev.detail || {};
        if(el.score)  el.score.textContent  = String(d.score ?? 0);
        if(el.zone)   el.zone.textContent   = String(d.zone ?? 'GREEN');
        if(el.shield) el.shield.textContent = String(d.shield ?? 0);
      });

      window.addEventListener('quest:update', (ev)=>{
        const q = ev.detail || {};
        if(el.goal) el.goal.textContent = String(q.goalProg ?? '--');
        if(el.mini) el.mini.textContent = String(q.miniProg ?? '--');

        if(el.storm){
          const s3 = String(q.line3 ?? '');
          if (s3.includes('Storm ‡∏≠‡∏¢‡∏π‡πà')) { el.storm.textContent = 'NOW'; return; }
          const m = s3.match(/~(\d+)s/i) || s3.match(/in\s*~?(\d+)s/i);
          el.storm.textContent = m ? ('in ' + m[1] + 's') : '--';
        }
      });
    }

    if (doc.readyState === 'loading'){
      doc.addEventListener('DOMContentLoaded', ()=>{
        bindVrEvents();
        bindVrHud();
      });
    } else {
      bindVrEvents();
      bindVrHud();
    }
  })();
  </script>

  <!-- ===== Loader (module) ===== -->
  <script type="module" src="./hydration-vr/hydration-vr.js"></script>

</body>
</html>