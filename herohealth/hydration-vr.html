<!-- === /herohealth/hydration-vr.html === -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth — Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- (CSS เดิมของคุณ 그대로ได้) -->
  <!-- ผมขอยกสั้น ๆ: ใช้ไฟล์เดิมจากรอบก่อนของคุณได้เลย -->
</head>

<body>
  <!-- (DOM เดิมทั้งหมดของคุณ: stage, HUD pills, playfield, water tube, buttons, start overlay, cbWrap, gazeRing) -->
  <!-- ✅ ให้ใช้ตัวเดิมจากรอบก่อน / ของคุณได้เลย เพื่อไม่ยาวเกิน -->
  <!-- แค่ต้องมีปุ่ม id="btnBackHub" และ overlay id="start-overlay" ตามเดิม -->

  <!-- ✅ IMPORTANT -->
  <script type="module" src="./hydration-vr/hydration.safe.js"></script>

  <script>
  (function(){
    'use strict';
    const D = document;

    function qs(name, def){
      try{ return (new URL(location.href)).searchParams.get(name) ?? def; }catch{ return def; }
    }

    const btnBackHub = D.getElementById('btnBackHub');
    const btnRestart = D.getElementById('btnRestart');
    const btnCardboard = D.getElementById('btnCardboard');

    if (btnRestart) btnRestart.addEventListener('click', ()=>location.reload());

    async function gotoHub(){
      const hub = String(qs('hub','./hub.html'));

      // ✅ flush-hardened: end game + try to send log before navigation
      try{
        const H = window.__HVR__;
        if (H && typeof H.forceEnd === 'function'){
          const p = H.forceEnd('backhub');
          // wait at most 750ms (enough for beacon/keepalive to fire)
          await Promise.race([
            p,
            new Promise(r=>setTimeout(r, 750))
          ]);
        } else {
          // fallback: fire event
          try{
            window.dispatchEvent(new CustomEvent('hha:force_end', { detail:{ reason:'backhub' } }));
          }catch{}
          await new Promise(r=>setTimeout(r, 450));
        }
      }catch{}

      // navigate
      try{
        const u = new URL(hub, location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }catch{
        location.href = hub;
      }
    }

    if (btnBackHub){
      btnBackHub.addEventListener('click', (e)=>{
        e.preventDefault();
        gotoHub();
      });
    }

    // ✅ back button (มือถือ) flush
    window.addEventListener('popstate', ()=>{
      try{
        const H = window.__HVR__;
        if (H && typeof H.forceEnd === 'function') H.forceEnd('popstate');
      }catch{}
    });

    // ✅ pagehide flush (iOS friendly)
    window.addEventListener('pagehide', ()=>{
      try{
        const H = window.__HVR__;
        if (H && typeof H.forceEnd === 'function') H.forceEnd('pagehide-html');
      }catch{}
    });

    // (Cardboard toggle / gaze / stereo / center shot scripts ของคุณใช้ตัวเดิมได้)
    // ถ้าคุณอยากให้ผม "รวมเป็นไฟล์เดียวแบบเต็มจริง ๆ" บอกคำเดียว: "รวมเต็ม"
  })();
  </script>
</body>
</html>