<!-- === /herohealth/hydration-vr.html ===
HydrationVR ‚Äî PRODUCTION (DOM + WaterTube + Cardboard Stereo + Gaze)
‚úÖ Fix paths (no /vr/... root 404)
‚úÖ Water "tube" 0‚Äì100 + zone colors
‚úÖ Mini HUD pills
‚úÖ Cardboard: stereoscopic left/right + gaze dwell shoot
‚úÖ Desktop/mobile: click/tap playfield = shoot center
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Optional A-Frame (only for VR button UI if you want) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + logger (paths fixed) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.74);
      --panel2:rgba(15,23,42,.65);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --cyan:#22d3ee;
      --violet:#a78bfa;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);

      /* cinematic */
      --endamp:0;
      --endflash:0;

      /* gaze */
      --gazeProg:0; /* 0..1 */
      --waterPct:50;
    }

    html,body{
      margin:0; padding:0; width:100%; height:100%;
      background: radial-gradient(1200px 700px at 50% 25%, #0b1120 0%, #020617 60%, #020617 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
    }
    *{ box-sizing:border-box; }

    /* ---------- CARD / PILL ---------- */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(2,6,23,.62);
      border:1px solid rgba(148,163,184,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 44px rgba(0,0,0,.30);
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
      pointer-events:none;
    }
    .pill b{ font-weight:1100; color:var(--cyan); }
    .pill .k{ color:var(--muted); font-weight:950; font-size:11px; }

    /* ---------- Layout ---------- */
    .stage{ position:fixed; inset:0; display:flex; flex-direction:column; }

    .topbar{
      padding: calc(var(--sat) + 10px) 10px 8px;
      display:flex; flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      z-index:30;
    }
    .topLeft, .topRight{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* mini HUD pills (center) */
    .miniPills{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      justify-content:center;
      flex: 1 1 auto;
      min-width: 240px;
    }

    /* playfield: make it BIG (‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢) */
    #playfield{
      position:relative;
      flex:1;
      margin: 0 10px;
      border-radius: 22px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.06), 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
      touch-action: manipulation;
      will-change: transform, filter;
    }
    #hvr-layer{ position:absolute; inset:0; }

    .bottombar{
      padding: 8px 10px calc(var(--sab) + 10px);
      display:flex; gap:10px;
      justify-content:space-between;
      align-items:flex-end;
      z-index:30;
    }
    .bottomLeft, .bottomRight{ display:flex; gap:10px; align-items:flex-end; }

    /* ---------- Water Tube (0‚Äì100) ---------- */
    .waterBox{
      pointer-events:none;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background: var(--panel);
      border:1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      min-width: 260px;
    }
    .tube{
      position:relative;
      width:22px;
      height:84px;
      border-radius:999px;
      background: rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.35);
    }
    .tubeFill{
      position:absolute; left:0; right:0; bottom:0;
      height:0%;
      border-radius:999px;
      transition: height .18s ease;
      background: linear-gradient(180deg,
        rgba(34,211,238,.95),
        rgba(34,197,94,.95)
      );
      box-shadow: 0 0 16px rgba(34,211,238,.20);
    }
    body.water-low  .tubeFill{
      background: linear-gradient(180deg, rgba(34,211,238,.95), rgba(34,211,238,.70));
      box-shadow: 0 0 16px rgba(34,211,238,.18);
    }
    body.water-green .tubeFill{
      background: linear-gradient(180deg, rgba(34,197,94,.98), rgba(34,211,238,.70));
      box-shadow: 0 0 18px rgba(34,197,94,.20);
    }
    body.water-high .tubeFill{
      background: linear-gradient(180deg, rgba(249,115,22,.98), rgba(239,68,68,.72));
      box-shadow: 0 0 18px rgba(239,68,68,.18);
    }
    .wText{ display:flex; flex-direction:column; gap:4px; }
    .wRow{ display:flex; gap:10px; align-items:baseline; }
    .wBig{ font-weight:1100; font-size:14px; }
    .wSub{ font-weight:900; color:var(--muted); font-size:11px; }

    /* ---------- Controls ---------- */
    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      pointer-events:auto;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(34,197,94,.18);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn.secondary{ background: rgba(2,6,23,.55); }
    .btn.danger{ background: rgba(239,68,68,.18); }

    /* ---------- Start Overlay ---------- */
    #start-overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,.75);
      z-index:90;
    }
    .startCard{
      width:min(560px, calc(100% - 24px));
      background: rgba(2,6,23,.88);
      border:1px solid rgba(148,163,184,.18);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      text-align:left;
    }
    .startTitle{ font-size:18px; font-weight:1100; }
    .startDesc{ margin-top:6px; font-size:12px; font-weight:900; color:var(--muted); line-height:1.35; }

    /* ---------- Gaze Ring (Cardboard) ---------- */
    .gazeRing{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:54px; height:54px;
      border-radius:999px;
      pointer-events:none;
      z-index:120;
      opacity:0;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.45));
    }
    body.cardboard .gazeRing{ opacity:1; }
    .gazeRing::before{
      content:"";
      position:absolute; inset:0;
      border-radius:999px;
      background:
        conic-gradient(
          rgba(34,197,94,.95) calc(var(--gazeProg)*360deg),
          rgba(148,163,184,.18) 0
        );
      mask: radial-gradient(circle, transparent 58%, #000 60%);
      -webkit-mask: radial-gradient(circle, transparent 58%, #000 60%);
    }
    .gazeDot{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:10px; height:10px; border-radius:999px;
      background: rgba(229,231,235,.45);
      box-shadow: 0 0 0 2px rgba(229,231,235,.20), 0 0 18px rgba(34,197,94,.18);
    }

    /* ---------- Cardboard Stereo Wrapper ---------- */
    #cbWrap{
      position:fixed; inset:0;
      display:none;
      background:#000;
      z-index:200; /* above normal stage */
    }
    body.cardboard #cbWrap{ display:flex; }
    .cbEye{
      flex:1;
      position:relative;
      overflow:hidden;
      border-left:1px solid rgba(255,255,255,.10);
    }
    .cbEye:first-child{ border-left:none; }

    /* the "real" stage goes into left eye */
    #cbLeft .stage{ position:absolute; inset:0; }
    /* right eye uses a mirrored clone (visual only) */
    #cbRight .stage{ position:absolute; inset:0; pointer-events:none; opacity:1; }

    /* hide original stage when cardboard active */
    body.cardboard > .stage{ display:none; }

    /* ---------- Cinematic end-window overlay ---------- */
    body.endwindow::after{
      content:"";
      position:fixed; inset:-26px;
      pointer-events:none;
      z-index:26;
      opacity: calc(0.10 + (var(--endamp) * 0.18));
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,0) 0px,
          rgba(255,255,255,0) 2px,
          rgba(255,255,255,0.018) 3px
        ),
        radial-gradient(900px 680px at 50% 42%,
          rgba(239,68,68, calc(0.06 + (var(--endflash) * 0.22))) 0%,
          rgba(239,68,68, calc(0.03 + (var(--endflash) * 0.14))) 22%,
          rgba(2,6,23,0) 60%),
        radial-gradient(1200px 920px at 50% 50%,
          rgba(2,6,23,0) 35%,
          rgba(2,6,23, calc(0.26 + (var(--endamp) * 0.38))) 78%,
          rgba(2,6,23, calc(0.44 + (var(--endamp) * 0.40))) 100%);
      mix-blend-mode: screen;
      filter: saturate(1.25) contrast(1.10);
      animation: endVigJitter .10s ease-in-out infinite, endFlicker .18s ease-in-out infinite;
    }
    @keyframes endVigJitter{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(.6px,-.7px,0)} 100%{transform:translate3d(0,0,0)}}
    @keyframes endFlicker{ 0%{opacity:calc(0.09 + (var(--endamp)*0.16))} 50%{opacity:calc(0.14 + (var(--endamp)*0.22))} 100%{opacity:calc(0.10 + (var(--endamp)*0.18))} }
  </style>
</head>

<body>

  <!-- ========== Normal Stage ========== -->
  <div class="stage" id="mainStage">
    <div class="topbar">
      <div class="topLeft">
        <div class="pill">üèÜ <span class="k">SCORE</span> <b id="stat-score">0</b></div>
        <div class="pill">‚ö° <span class="k">COMBO</span> <b id="stat-combo">0</b> <span class="k">MAX</span> <b id="stat-combo-max">0</b></div>
        <div class="pill">üí• <span class="k">MISS</span> <b id="stat-miss">0</b></div>
        <div class="pill">‚è±Ô∏è <span class="k">TIME</span> <b id="stat-time">‚Äî</b></div>
        <div class="pill">üéñÔ∏è <span class="k">GRADE</span> <b id="stat-grade">C</b></div>
      </div>

      <div class="miniPills">
        <div class="pill">üß© <span class="k">GOAL</span> <span id="quest-line2">‚Äî</span></div>
        <div class="pill">üå™Ô∏è <span class="k">STORM</span> <b id="storm-left">0</b><span class="k">s</span></div>
        <div class="pill">üõ°Ô∏è <span class="k">SHIELD</span> <b id="shield-count">0</b></div>
      </div>

      <div class="topRight">
        <div class="pill">üéØ <span class="k">GOAL</span> <span id="quest-line1">‚Äî</span></div>
        <div class="pill">‚ö†Ô∏è <span class="k">MINI</span> <span id="quest-line4">‚Äî</span></div>
      </div>
    </div>

    <div id="playfield" aria-label="playfield">
      <div id="hvr-layer"></div>
    </div>

    <div class="bottombar">
      <div class="bottomLeft">
        <div class="waterBox">
          <div class="tube" id="water-tube" aria-label="water tube">
            <div class="tubeFill" id="water-tube-fill" style="height:50%"></div>
          </div>
          <div class="wText">
            <div class="wRow">
              <div class="wBig">üíß Water</div>
              <div class="pill" style="padding:6px 10px; box-shadow:none;">
                <span class="k">ZONE</span> <b id="water-zone">GREEN</b>
              </div>
              <div class="pill" style="padding:6px 10px; box-shadow:none;">
                <span class="k">%</span> <b id="water-pct">50%</b>
              </div>
            </div>
            <div class="wSub">‡∏ó‡∏≥‡πÉ‡∏´‡πâ GREEN ‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô ‚Ä¢ ‡∏ï‡∏≠‡∏ô Storm ‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô GREEN‚Äù + ‡∏Å‡∏î BLOCK ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢</div>
          </div>
        </div>
      </div>

      <div class="bottomRight">
        <div class="btnRow" style="pointer-events:auto;">
          <button class="btn" id="btnCardboard" type="button">üì¶ CARDBOARD</button>
          <button class="btn secondary" id="btnBackHub" type="button">üè† HUB</button>
          <button class="btn danger" id="btnRestart" type="button">üîÅ RESTART</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== Cardboard Stereo Overlay ========== -->
  <div id="cbWrap" aria-hidden="true">
    <div class="cbEye" id="cbLeft"></div>
    <div class="cbEye" id="cbRight"></div>
  </div>

  <!-- Gaze -->
  <div class="gazeRing" aria-hidden="true">
    <div class="gazeDot"></div>
  </div>

  <!-- Start Overlay -->
  <div id="start-overlay">
    <div class="startCard">
      <div class="startTitle">üíß Hydration VR</div>
      <div class="startDesc">
        ‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÅ‡∏ï‡∏∞ ‚Äú‡πÉ‡∏ô‡∏™‡∏ô‡∏≤‡∏°‚Äù = ‡∏¢‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (center shot)<br/>
        ‚úÖ Cardboard: ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏à‡πâ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á (gaze dwell)<br/>
        Mini ‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö Storm ‡∏à‡∏∞‡∏°‡∏µ üõ°Ô∏è ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏°‡∏µ ü•§ ‡πÉ‡∏´‡πâ BLOCK ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button class="btn" id="btnStart" type="button">üöÄ START</button>
        <button class="btn secondary" id="btnStartCardboard" type="button">üì¶ START (CARDBOARD)</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ IMPORTANT: correct module path from /herohealth/hydration-vr.html -->
  <script type="module" src="./hydration-vr/hydration.safe.js"></script>

  <!-- Cardboard stereo + gaze + center shooting helpers -->
  <script>
  (function(){
    'use strict';

    const D = document;

    const playfield = D.getElementById('playfield');
    const layer = D.getElementById('hvr-layer');

    const startOverlay = D.getElementById('start-overlay');
    const btnStart = D.getElementById('btnStart');
    const btnStartCb = D.getElementById('btnStartCardboard');

    const btnCardboard = D.getElementById('btnCardboard');
    const btnRestart = D.getElementById('btnRestart');
    const btnBackHub = D.getElementById('btnBackHub');

    const cbWrap  = D.getElementById('cbWrap');
    const cbLeft  = D.getElementById('cbLeft');
    const cbRight = D.getElementById('cbRight');

    function qs(name, def){
      try{ return (new URL(location.href)).searchParams.get(name) ?? def; }catch{ return def; }
    }

    function resumeAudio(){
      // simple unlock
      try{
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return Promise.resolve();
        const ctx = new AC();
        const p = (ctx.state === 'suspended') ? ctx.resume() : Promise.resolve();
        return p.finally(()=>{ try{ ctx.close(); }catch{} });
      }catch{ return Promise.resolve(); }
    }

    // ----- HUB / restart -----
    btnRestart.addEventListener('click', ()=>location.reload());
    btnBackHub.addEventListener('click', ()=>{
      const hub = String(qs('hub','./hub.html'));
      try{
        const u = new URL(hub, location.href);
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }catch{
        location.href = hub;
      }
    });

    // ----- center shoot (mouse/tap) -----
    function shootAtCenter(){
      if (!playfield) return;
      const r = playfield.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top  + r.height/2;

      const el = document.elementFromPoint(cx, cy);
      if (!el) return;

      // find closest target
      const t = el.closest && el.closest('.hvr-target');
      if (t){
        // fire pointerdown to trigger same logic
        try{
          const ev = new PointerEvent('pointerdown', { bubbles:true, cancelable:true, pointerType:'mouse' });
          t.dispatchEvent(ev);
        }catch{
          try{ t.click(); }catch{}
        }
      }
    }

    // allow click/tap anywhere in playfield to shoot center
    if (playfield){
      playfield.addEventListener('pointerdown', (e)=>{
        // if you actually click a target, let it handle
        const t = e.target && e.target.closest && e.target.closest('.hvr-target');
        if (t) return;
        e.preventDefault();
        shootAtCenter();
      }, { passive:false });
    }

    // ----- Cardboard: build stereo clone + mirror changes -----
    let mirrorObs = null;
    let mirrorDebounce = 0;

    function stripIds(root){
      // remove ids inside clone to avoid duplicates
      const all = root.querySelectorAll('[id]');
      all.forEach(el=>{ el.removeAttribute('id'); });
    }

    function syncRightOnce(){
      if (!cbRight) return;
      const leftStage = cbLeft.querySelector('.stage');
      const rightStage = cbRight.querySelector('.stage');
      if (!leftStage || !rightStage) return;

      // Copy layer visuals fast (targets only)
      const leftLayer = leftStage.querySelector('#hvr-layer');
      const rightLayer = rightStage.querySelector('[data-role="hvr-layer"]');
      if (leftLayer && rightLayer){
        rightLayer.innerHTML = leftLayer.innerHTML;
      }

      // Copy visible text by data-mirror keys
      const leftMir = leftStage.querySelectorAll('[data-mirror]');
      leftMir.forEach(src=>{
        const key = src.getAttribute('data-mirror');
        const dst = rightStage.querySelector('[data-mirror="'+key+'"]');
        if (dst) dst.textContent = src.textContent;
      });

      // Copy tube fill height
      const lf = leftStage.querySelector('#water-tube-fill');
      const rf = rightStage.querySelector('[data-role="waterFill"]');
      if (lf && rf){
        rf.style.height = lf.style.height || (getComputedStyle(lf).height);
      }
    }

    function setupStereo(){
      cbLeft.innerHTML = '';
      cbRight.innerHTML = '';

      // move real stage into left eye
      const mainStage = document.getElementById('mainStage');
      if (!mainStage) return;
      cbLeft.appendChild(mainStage);

      // clone stage to right eye (visual only)
      const clone = mainStage.cloneNode(true);

      // mark special nodes so we can find them without ids
      const cLayer = clone.querySelector('#hvr-layer');
      if (cLayer){ cLayer.setAttribute('data-role','hvr-layer'); }

      const cFill = clone.querySelector('#water-tube-fill');
      if (cFill){ cFill.setAttribute('data-role','waterFill'); }

      // add mirror attributes to key texts (in clone AND in left)
      function setMirrorKeys(stage){
        const map = [
          ['#stat-score','score'],
          ['#stat-combo','combo'],
          ['#stat-combo-max','comboMax'],
          ['#stat-miss','miss'],
          ['#stat-time','time'],
          ['#stat-grade','grade'],
          ['#storm-left','stormLeft'],
          ['#shield-count','shield'],
          ['#quest-line1','q1'],
          ['#quest-line2','q2'],
          ['#quest-line4','q4'],
          ['#water-zone','zone'],
          ['#water-pct','pct']
        ];
        map.forEach(([sel,key])=>{
          const el = stage.querySelector(sel);
          if (el) el.setAttribute('data-mirror', key);
        });
      }
      setMirrorKeys(mainStage);
      setMirrorKeys(clone);

      // remove ids in clone
      stripIds(clone);

      // ensure right clone doesn't intercept
      clone.style.pointerEvents = 'none';

      cbRight.appendChild(clone);

      // observe mutations on left stage and debounce-copy
      if (mirrorObs) { try{ mirrorObs.disconnect(); }catch{} }
      mirrorObs = new MutationObserver(()=>{
        clearTimeout(mirrorDebounce);
        mirrorDebounce = setTimeout(syncRightOnce, 24);
      });
      mirrorObs.observe(mainStage, { subtree:true, childList:true, characterData:true, attributes:true });

      // initial sync
      syncRightOnce();
    }

    function teardownStereo(){
      // move real stage back to body
      const stage = cbLeft.querySelector('.stage');
      if (stage) document.body.insertBefore(stage, cbWrap);

      cbLeft.innerHTML = '';
      cbRight.innerHTML = '';

      if (mirrorObs) { try{ mirrorObs.disconnect(); }catch{} }
      mirrorObs = null;
    }

    function setCardboard(on){
      on = !!on;
      if (on){
        document.body.classList.add('cardboard');
        setupStereo();
      } else {
        document.body.classList.remove('cardboard');
        teardownStereo();
      }
    }

    btnCardboard.addEventListener('click', async ()=>{
      await resumeAudio();
      setCardboard(!document.body.classList.contains('cardboard'));
    });

    // ----- Gaze dwell (Cardboard) -----
    let gazeOn = false;
    let gazeHold = 0;
    let gazeCooldown = 0;
    const dwellSec = 0.62;     // ‚úÖ faster
    const cooldownSec = 0.20;  // ‚úÖ snappier

    function setGazeProg(p){
      p = Math.max(0, Math.min(1, p));
      document.documentElement.style.setProperty('--gazeProg', String(p));
    }

    function gazeTick(dt){
      if (!document.body.classList.contains('cardboard')){
        setGazeProg(0);
        gazeHold = 0;
        gazeCooldown = 0;
        return;
      }

      gazeCooldown = Math.max(0, gazeCooldown - dt);

      // simple: always dwell at center (‡∏¢‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á)
      if (gazeCooldown <= 0){
        gazeHold += dt;
        setGazeProg(gazeHold / dwellSec);
        if (gazeHold >= dwellSec){
          gazeHold = 0;
          gazeCooldown = cooldownSec;
          setGazeProg(0);
          shootAtCenter();
        }
      } else {
        setGazeProg(0);
        gazeHold = 0;
      }
    }

    let lastT = 0;
    function loop(t){
      const dt = Math.min(0.05, Math.max(0.001, (t - (lastT||t))/1000));
      lastT = t;

      gazeTick(dt);

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ----- Start buttons -----
    btnStart.addEventListener('click', async ()=>{
      await resumeAudio();
      startOverlay.style.display = 'none';
    });

    btnStartCb.addEventListener('click', async ()=>{
      await resumeAudio();
      startOverlay.style.display = 'none';
      setCardboard(true);
    });

  })();
  </script>

  <!-- Cinematic driver (‡∏≠‡πà‡∏≤‡∏ô window.__HVR__.S/TUNE) -->
  <script>
  (function(){
    'use strict';

    const D = document;

    // audio (tick/thunder)
    const EndAudio = (() => {
      let ctx = null;
      function ensure(){
        if (ctx) return ctx;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;
        ctx = new AC();
        return ctx;
      }
      function resume(){
        const c = ensure(); if (!c) return;
        if (c.state === 'suspended') c.resume().catch(()=>{});
      }
      function tick(){
        const c = ensure(); if(!c) return;
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'square';
        o.frequency.value = 1200;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(c.destination);
        const t0 = c.currentTime;
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.032, t0 + 0.006);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.040);
        o.start(t0);
        o.stop(t0 + 0.05);
      }
      function thunder(gain=0.08){
        const c = ensure(); if(!c) return;
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(80, c.currentTime);
        o.frequency.exponentialRampToValueAtTime(38, c.currentTime + 0.7);
        g.gain.setValueAtTime(0.0001, c.currentTime);
        g.gain.exponentialRampToValueAtTime(Math.max(0.02, gain), c.currentTime + 0.04);
        g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + 0.85);
        o.connect(g); g.connect(c.destination);
        o.start();
        o.stop(c.currentTime + 0.9);
      }
      return { resume, tick, thunder };
    })();

    function clamp(v,a,b){ v = Number(v)||0; return Math.max(a, Math.min(b, v)); }
    function setEndVars(amp, flash){
      D.documentElement.style.setProperty('--endamp', String(clamp(amp,0,1)));
      D.documentElement.style.setProperty('--endflash', String(clamp(flash,0,1)));
    }

    let endOn=false, tEnter=0, acc=0, lastT=0, thundered=false, currentAmp=0;

    window.addEventListener('pointerdown', ()=>EndAudio.resume(), { passive:true });

    function setEnd(on){
      on = !!on;
      if (on === endOn) return;
      endOn = on;

      if (on){
        tEnter = performance.now();
        acc = 0;
        thundered = false;
        currentAmp = 0.25;
        D.body.classList.add('endwindow');
        EndAudio.resume();
        EndAudio.tick();
        setEndVars(0.35, 0.9);
      } else {
        D.body.classList.remove('endwindow');
        currentAmp = 0;
        setEndVars(0,0);
      }
    }

    function loop(t){
      const dt = Math.min(0.05, Math.max(0.001, (t - (lastT||t)) / 1000));
      lastT = t;

      const H = window.__HVR__;
      const S = H && H.S;
      const TUNE = H && H.TUNE;

      if (!S || !TUNE){
        requestAnimationFrame(loop);
        return;
      }

      const inEnd = !!(S.stormActive && (S.stormLeftSec <= (TUNE.endWindowSec + 0.02)));
      setEnd(inEnd);

      if (endOn){
        const elapsed = (t - tEnter) / 1000;
        const k = clamp(elapsed / 1.0, 0, 1);
        currentAmp = 0.25 + 0.75*k;
        setEndVars(currentAmp, 0);

        // tick accel
        const rate = Math.max(0.052, 0.135 - (0.085 * k));
        acc += dt;
        while (acc >= rate){
          acc -= rate;
          EndAudio.tick();
          setEndVars(currentAmp, 0.55 + 0.45*k);
          setTimeout(()=>setEndVars(currentAmp, 0), 70);
        }

        if (!thundered && k > 0.82){
          thundered = true;
          EndAudio.thunder(0.06);
        }
      }

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>