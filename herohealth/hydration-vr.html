<!-- === /herohealth/hydration-vr.html ===
Hydration Quest VR ‚Äî PRODUCTION READY (Full HTML)
‚úÖ Fix import path: ./hydration-vr/hydration.safe.js (‡∏Å‡∏±‡∏ô Failed to fetch)
‚úÖ HUD + Start overlay + End overlay (‡∏Ñ‡∏£‡∏ö)
‚úÖ Playfield + BoundsHost + SpawnHost ‡πÅ‡∏¢‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö drag/transform ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ hitbox ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
‚úÖ ‡∏õ‡∏∏‡πà‡∏° VR/STOP + Peek HUD + Double-tap reset view
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- (Optional) A-Frame for VR button compat if you use it elsewhere -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + Logger (safe if absent) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.62);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#fb7185;
      --warn:#f59e0b;
      --shadow: 0 16px 40px rgba(0,0,0,.55);
      --r:22px;
    }
    html,body{height:100%; background:radial-gradient(1200px 800px at 50% 15%, rgba(34,197,94,.10), transparent 55%), var(--bg); color:var(--text); margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    /* bounds host (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì safe-zone) */
    #hvr-bounds{
      position:fixed; inset:0;
      overflow:hidden;
      touch-action:none;
    }

    /* world (‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å/gyro) */
    #hvr-world{
      position:absolute; inset:0;
      transform: translate3d(0,0,0);
      will-change: transform;
    }

    /* spawn host */
    #hvr-layer{
      position:absolute; inset:0;
      pointer-events:auto;
    }

    /* crosshair (‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠) */
    #hvr-crosshair{
      position:fixed;
      left:50%; top:52%;
      transform:translate(-50%,-50%);
      width:18px; height:18px;
      border:2px solid rgba(229,231,235,.55);
      border-radius:999px;
      box-shadow:0 0 16px rgba(255,255,255,.10);
      z-index:30;
      pointer-events:none;
      opacity:.7;
    }
    #hvr-crosshair::after{
      content:'';
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:4px; height:4px;
      border-radius:999px;
      background:rgba(229,231,235,.65);
    }

    /* HUD */
    #hha-hud{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:40;
    }
    .hud-top{
      position:absolute; left:16px; right:16px; top:14px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .pill{
      pointer-events:none;
      background:linear-gradient(180deg, rgba(2,6,23,.75), rgba(2,6,23,.55));
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .pill b{ font-weight:800; letter-spacing:.2px; }
    .bar{
      height:10px; width:170px;
      border-radius:999px;
      background:rgba(148,163,184,.16);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
    }
    .bar > i{
      display:block; height:100%;
      width:50%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,197,94,.55));
      border-radius:999px;
    }
    .hud-mid{
      position:absolute; left:16px; right:16px; top:86px;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
    }
    .card{
      pointer-events:none;
      width:min(320px, 44vw);
      background:linear-gradient(180deg, rgba(2,6,23,.78), rgba(15,23,42,.58));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding:12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card h4{ margin:0 0 8px; font-size:13px; letter-spacing:.2px; color:rgba(229,231,235,.9); }
    .kv{ display:grid; grid-template-columns: 1fr auto; gap:6px 10px; font-size:12px; color:rgba(229,231,235,.88);}
    .kv span{ color:rgba(148,163,184,.95); }
    .big{
      pointer-events:none;
      flex:1;
      min-width: 260px;
      background:linear-gradient(180deg, rgba(2,6,23,.70), rgba(15,23,42,.52));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding:12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .big .row{ display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .big .row h3{ margin:0; font-size:14px; letter-spacing:.2px;}
    .big .sub{ margin-top:8px; font-size:12px; color:rgba(148,163,184,.95); line-height:1.25; }
    .big .prog{
      margin-top:10px;
      height:12px; border-radius:999px;
      background:rgba(148,163,184,.14);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
    }
    .big .prog > i{
      display:block; height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,197,94,.55));
      border-radius:999px;
    }

    .hud-right-stack{
      pointer-events:none;
      display:flex; flex-direction:column; gap:10px;
      width:min(240px, 34vw);
    }

    .hint{
      position:fixed; left:16px; bottom:108px;
      width:min(320px, 44vw);
      pointer-events:none;
      background:linear-gradient(180deg, rgba(2,6,23,.72), rgba(15,23,42,.55));
      border:1px solid rgba(148,163,184,.20);
      border-radius: var(--r);
      padding:12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      color:rgba(229,231,235,.92);
      z-index:45;
    }
    .hint b{ display:block; margin-bottom:6px; }
    .hint small{ color:rgba(148,163,184,.95); }

    .hud-bottom{
      position:fixed; left:16px; right:16px; bottom:18px;
      display:flex; align-items:center; justify-content:flex-end; gap:10px;
      pointer-events:auto;
      z-index:55;
    }
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(15,23,42,.72), rgba(2,6,23,.82));
      color:rgba(229,231,235,.92);
      padding:12px 18px;
      border-radius: 16px;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .btn.stop{ background:linear-gradient(180deg, rgba(127,29,29,.70), rgba(2,6,23,.88)); }
    .btn.vr{ background:linear-gradient(180deg, rgba(20,83,45,.68), rgba(2,6,23,.88)); }
    .btn:active{ transform: translateY(1px); }

    /* START overlay */
    #hvr-start{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:80;
      background: radial-gradient(900px 500px at 50% 20%, rgba(34,197,94,.12), transparent 60%), rgba(2,6,23,.78);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .start-card{
      width:min(520px, 92vw);
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(2,6,23,.86), rgba(15,23,42,.62));
      border-radius: 26px;
      box-shadow: 0 26px 70px rgba(0,0,0,.68);
      padding:18px;
    }
    .start-card h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .start-card p{ margin:10px 0 0; color:rgba(148,163,184,.98); line-height:1.35; }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    label{ display:block; font-size:12px; color:rgba(148,163,184,.98); margin:0 0 6px; }
    select,input{
      width:100%;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.55);
      color:rgba(229,231,235,.92);
      padding:14px 14px;
      border-radius: 18px;
      outline:none;
      font-weight:700;
    }
    .start-actions{ margin-top:14px; display:flex; gap:12px; }
    .start-btn{
      flex:1;
      padding:14px 16px;
      border-radius: 18px;
      border:1px solid rgba(34,197,94,.30);
      background: linear-gradient(180deg, rgba(20,83,45,.78), rgba(2,6,23,.92));
      color:rgba(229,231,235,.95);
      font-weight:900;
      letter-spacing:.3px;
      box-shadow: var(--shadow);
    }
    .start-btn:active{ transform: translateY(1px); }
    .tiny{
      margin-top:10px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.40);
      color:rgba(148,163,184,.95);
      font-size:12px;
      line-height:1.25;
      white-space:pre-wrap;
    }

    /* END overlay */
    #hvr-end{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:90;
      background:rgba(2,6,23,.80);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .end-card{
      width:min(680px, 94vw);
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(2,6,23,.90), rgba(15,23,42,.62));
      border-radius: 28px;
      box-shadow: 0 28px 80px rgba(0,0,0,.72);
      padding:18px;
    }
    .end-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .end-top h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .badge-grade{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:54px;
      padding:10px 14px;
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      font-weight:900;
      letter-spacing:.4px;
    }
    .end-kpis{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi{
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.45);
      border-radius: 18px;
      padding:12px 12px;
    }
    .kpi b{ display:block; font-size:22px; }
    .kpi span{ color:rgba(148,163,184,.95); font-size:12px; }
    .end-prog{
      margin-top:12px;
      height:14px; border-radius:999px;
      background:rgba(148,163,184,.14);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
    }
    .end-prog > i{
      display:block; height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,197,94,.55));
      border-radius:999px;
    }
    .end-actions{
      margin-top:14px;
      display:flex; gap:10px; justify-content:flex-end;
    }
    .end-actions .btn{ pointer-events:auto; }

    /* hidden hud */
    .hud-hidden #hha-hud{ opacity:.12; }
  </style>
</head>

<body>
  <!-- bounds host -->
  <div id="hvr-bounds">
    <div id="hvr-world">
      <div id="hvr-layer" aria-label="spawn-layer"></div>
    </div>
  </div>

  <div id="hvr-crosshair" aria-hidden="true"></div>

  <!-- HUD -->
  <div id="hha-hud">
    <div class="hud-top">
      <div class="pill" id="hha-water-header">
        <span>üíß</span>
        <b>Water balance</b>
        <span id="hha-water-zone" style="margin-left:6px; font-weight:900;">GREEN</span>
        <span id="hha-water-pct" style="margin-left:2px; font-weight:900;">50%</span>
        <div class="bar" style="margin-left:10px;"><i id="hha-water-fill" style="width:50%"></i></div>
      </div>

      <div class="pill" id="hha-water-bar" style="opacity:.0; pointer-events:none;">
        <!-- (optional spare) -->
      </div>
    </div>

    <div class="hud-mid">
      <div class="card" id="hha-card-left">
        <h4>STATS</h4>
        <div class="kv">
          <span>SCORE</span><b id="hha-score">0</b>
          <span>COMBO MAX</span><b id="hha-comboMax">0</b>
          <span>MISS</span><b id="hha-miss">0</b>
          <span>TIME</span><b id="hha-time">0</b>
          <span>GRADE</span><b id="hha-grade">C</b>
        </div>
      </div>

      <div class="big" id="hha-card-right">
        <div class="row">
          <h3>üß© QUEST <span id="hha-quest-num">1</span></h3>
          <div class="pill" style="padding:6px 10px;">
            <span>üíß</span>
            <b>Water balance</b>
            <span id="hha-water-zone2" style="margin-left:6px; font-weight:900;">GREEN</span>
            <span id="hha-water-pct2" style="margin-left:2px; font-weight:900;">50%</span>
          </div>
        </div>
        <div class="sub" id="hha-quest-text">Goal: 0/0 ‚Ä¢ Mini: 0/0</div>
        <div class="sub" id="hha-quest-sub">Water Zone: GREEN</div>
        <div class="sub" id="hha-quest-done">Goals done: 0 ‚Ä¢ Minis done: 0</div>
        <div class="prog"><i id="hha-progress-fill" style="width:0%"></i></div>
        <div class="sub" id="hha-progress-text">Progress to S (30%): 0%</div>
      </div>

      <div class="hud-right-stack">
        <div class="card hha-fever-card" id="hha-fever-card">
          <h4>üî• FEVER</h4>
          <div class="bar" style="width:100%"><i id="hha-fever-fill" style="width:0%"></i></div>
          <div class="sub" style="margin-top:8px;"><b id="hha-fever-pct">0%</b></div>
        </div>

        <div class="card" id="hha-shield-card">
          <h4>üõ°Ô∏è SHIELD</h4>
          <div class="sub"><b id="hha-shield">0</b></div>
        </div>
      </div>
    </div>

    <div class="hint" id="hha-hint">
      <b>Peek HUD</b>
      <small>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå HUD ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</small>
    </div>

    <div class="hud-bottom">
      <div class="btn vr" id="btnVR">VR</div>
      <div class="btn stop" id="btnStop">STOP</div>
    </div>
  </div>

  <!-- START overlay -->
  <div id="hvr-start">
    <div class="start-card">
      <h2>Hydration Quest VR ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢ üíß</h2>
      <p>
        ‡πÇ‡∏´‡∏°‡∏î <b>play</b> = ‡∏™‡∏ô‡∏∏‡∏Å ‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à (Adaptive + Storm + Shield)<br/>
        ‡πÇ‡∏´‡∏°‡∏î <b>research</b> = ‡πÉ‡∏™‡πà seed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ô‡∏¥‡πà‡∏á ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
      </p>

      <div class="grid">
        <div>
          <label>Difficulty</label>
          <select id="uiDiff">
            <option value="easy">easy</option>
            <option value="normal" selected>normal</option>
            <option value="hard">hard</option>
          </select>
        </div>
        <div>
          <label>Run mode</label>
          <select id="uiRun">
            <option value="play" selected>play</option>
            <option value="research">research</option>
          </select>
        </div>
        <div>
          <label>Time (sec)</label>
          <input id="uiTime" type="number" min="20" max="180" step="1" value="90"/>
        </div>
        <div>
          <label>Seed (optional)</label>
          <input id="uiSeed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô schoolA-g5-0"/>
        </div>
      </div>

      <div class="start-actions">
        <button class="start-btn" id="uiStart">START</button>
      </div>

      <div class="tiny" id="uiUrlPreview">URL: ?diff=normal&time=90&run=play&seed=</div>
      <div class="tiny">HUD ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ Peek ‚Ä¢ Double-tap: Reset view</div>
    </div>
  </div>

  <!-- END overlay -->
  <div id="hvr-end">
    <div class="end-card">
      <div class="end-top">
        <h2 id="endTitle">‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! üíß</h2>
        <div class="badge-grade" id="endGrade">B</div>
      </div>

      <div class="end-kpis">
        <div class="kpi"><b id="endScore">0</b><span>Score</span></div>
        <div class="kpi"><b id="endMiss">0</b><span>Miss</span></div>
        <div class="kpi"><b id="endCombo">0</b><span>ComboMax</span></div>
      </div>

      <div class="end-prog"><i id="endProgFill" style="width:0%"></i></div>
      <div class="tiny" id="endDesc">Progress to S: 0%</div>

      <div class="end-actions">
        <div class="btn" id="endReplay">REPLAY</div>
        <div class="btn stop" id="endClose">CLOSE</div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- URL helpers ---
    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const get = (k, d='') => (qs.get(k) ?? d);

    function setPreview(){
      const diff = $('uiDiff').value;
      const run  = $('uiRun').value;
      const time = Math.max(20, Math.min(180, Number($('uiTime').value||90)));
      const seed = String($('uiSeed').value||'').trim();
      const url = `?diff=${encodeURIComponent(diff)}&time=${encodeURIComponent(time)}&run=${encodeURIComponent(run)}${seed?`&seed=${encodeURIComponent(seed)}`:''}&debug=1`;
      $('uiUrlPreview').textContent = 'URL: ' + url;
    }

    ['uiDiff','uiRun','uiTime','uiSeed'].forEach(id=>{
      const el = $(id);
      el.addEventListener('input', setPreview);
      el.addEventListener('change', setPreview);
    });
    setPreview();

    function navToStart(){
      const diff = $('uiDiff').value;
      const run  = $('uiRun').value;
      const time = Math.max(20, Math.min(180, Number($('uiTime').value||90)));
      const seed = String($('uiSeed').value||'').trim();
      const nqs = new URLSearchParams();
      nqs.set('diff', diff);
      nqs.set('time', String(time));
      nqs.set('run', run);
      nqs.set('ts', String(Date.now()));
      if (seed) nqs.set('seed', seed);
      nqs.set('debug', '1');
      location.href = location.pathname + '?' + nqs.toString();
    }

    $('uiStart').addEventListener('click', navToStart);

    // prefill form from URL
    const urlDiff = get('diff','normal');
    const urlRun  = get('run','play');
    const urlTime = get('time','90');
    const urlSeed = get('seed','');
    $('uiDiff').value = ['easy','normal','hard'].includes(urlDiff) ? urlDiff : 'normal';
    $('uiRun').value  = (urlRun === 'research') ? 'research' : 'play';
    $('uiTime').value = Math.max(20, Math.min(180, Number(urlTime||90)));
    $('uiSeed').value = urlSeed;
    setPreview();

    // Buttons (STOP/VR)
    $('btnStop').addEventListener('click', ()=> window.dispatchEvent(new CustomEvent('hha:stop')));
    $('btnVR').addEventListener('click', ()=> {
      // placeholder: if you have a VR scene, hook it here
      // For now: attempt fullscreen
      try{ document.documentElement.requestFullscreen?.(); }catch{}
    });

    // Peek HUD: tap top edge
    let hudPeekTimer = null;
    function showHudTemp(ms=2500){
      document.body.classList.remove('hud-hidden');
      clearTimeout(hudPeekTimer);
      hudPeekTimer = setTimeout(()=> document.body.classList.add('hud-hidden'), ms);
    }
    function autoHideHud(){
      clearTimeout(hudPeekTimer);
      hudPeekTimer = setTimeout(()=> document.body.classList.add('hud-hidden'), 2500);
    }
    window.addEventListener('pointerdown', (e)=>{
      if (e.clientY < 36) showHudTemp(2800);
    }, {passive:true});
    autoHideHud();

    // Double-tap reset view
    let lastTap = 0;
    window.addEventListener('pointerup', (e)=>{
      const now = performance.now();
      if (now - lastTap < 320) window.dispatchEvent(new CustomEvent('hha:resetView'));
      lastTap = now;
    }, {passive:true});

    // End overlay hooks
    function showEnd(on){ $('hvr-end').style.display = on ? 'flex' : 'none'; }
    $('endClose').addEventListener('click', ()=> showEnd(false));
    $('endReplay').addEventListener('click', ()=> {
      const nqs = new URLSearchParams(location.search);
      nqs.set('ts', String(Date.now()));
      location.href = location.pathname + '?' + nqs.toString();
    });

    window.addEventListener('hha:end', (ev)=>{
      const d = ev?.detail || {};
      $('endTitle').textContent = d.title || '‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! üíß';
      $('endGrade').textContent = d.grade || 'C';
      $('endScore').textContent = String(d.score ?? 0);
      $('endMiss').textContent = String(d.miss ?? 0);
      $('endCombo').textContent = String(d.comboMax ?? 0);
      $('endProgFill').style.width = String(Math.max(0, Math.min(100, Number(d.progressPct||0)))) + '%';
      $('endDesc').textContent = `Progress to S: ${Math.round(Number(d.progressPct||0))}%`;
      showEnd(true);
    });

    // Boot the game engine (MODULE) ‚Äî IMPORTANT PATH FIX HERE:
    import { bootHydration } from './hydration-vr/hydration.safe.js';
    bootHydration();
  </script>
</body>
</html>
