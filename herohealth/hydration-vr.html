<!-- === /herohealth/hydration-vr.html ===
Hydration Quest VR ‚Äî FULL HTML (PRODUCTION)
‚úÖ Static import (no dynamic import fetch error)
‚úÖ Correct module path: ./hydration-vr/hydration.safe.js
‚úÖ Start overlay + URL sync (?diff=&time=&run=&seed=&debug=1)
‚úÖ HUD IDs complete for hydration.safe.js
‚úÖ Playfield + bounds fixed layer
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- FX / Fever / HUD / Logger (IIFE) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/ui-fever.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.76);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;

      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;

      --radius:18px;
      --radius2:22px;
      --shadow:0 18px 50px rgba(0,0,0,.42);

      --hudTop: 108px;
      --hudBottom: 150px;
    }

    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    .wrap{
      position:fixed; inset:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 600px at 50% 40%, rgba(59,130,246,.10), transparent 60%),
        radial-gradient(900px 520px at 20% 10%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(#020617, #020617);
    }

    /* bounds fixed layer */
    #hvr-stage{
      position:fixed; inset:0; z-index:1;
      pointer-events:none;
    }

    /* playfield (transformed by hydration.safe.js) */
    #hvr-playfield{
      position:absolute; inset:0; z-index:5;
      pointer-events:auto;
      touch-action:manipulation;
      will-change: transform;
      transform: translate3d(0,0,0);
    }

    /* crosshair */
    #hvr-crosshair{
      position:absolute; left:50%; top:50%;
      width:12px; height:12px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      background:rgba(255,255,255,.55);
      box-shadow:0 0 20px rgba(255,255,255,.12);
      z-index:10;
      pointer-events:none;
      opacity:.88;
    }

    /* HUD shell */
    .hud{ position:absolute; inset:0; z-index:20; pointer-events:none; }

    .topbar{
      position:absolute; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:flex-start;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px;
    }

    .stats{ width:220px; }
    .k{ font-size:11px; color:var(--muted); letter-spacing:.2px; }
    .v{ font-size:16px; font-weight:900; }

    .row{ display:flex; justify-content:space-between; gap:10px; margin:8px 0; }
    .bigScore{ font-size:44px; font-weight:1000; line-height:1; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background:rgba(255,255,255,.06);
      font-weight:950;
    }

    .progress{
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .progress > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(59,130,246,.85));
    }
    .muted{ color:var(--muted); }

    .quest{ flex:1; min-height:78px; }
    .questTitle{ display:flex; align-items:center; gap:8px; font-weight:1000; }
    .qline{ margin-top:6px; font-size:14px; opacity:.96; }

    .controls{
      position:absolute; left:12px; right:12px; bottom:14px;
      display:flex; gap:12px; align-items:flex-end;
      z-index:30;
      pointer-events:none;
    }
    .hintCol{ flex:1; display:flex; flex-direction:column; gap:10px; }
    .hint{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:12px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      font-weight:1000;
      pointer-events:none;
    }
    .hint small{ display:block; font-weight:800; color:var(--muted); margin-top:4px; }

    .btnCol{ display:flex; gap:10px; pointer-events:auto; }
    .btn{
      min-width:92px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:12px 14px;
      font-weight:1000;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.30); }
    .btn.danger{ background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.30); }
    .btnMini{ min-width:64px; border-radius:14px; padding:10px 12px; }

    /* Start overlay */
    #startOverlay{
      position:absolute; inset:0; z-index:60;
      background: radial-gradient(900px 500px at 50% 40%, rgba(59,130,246,.16), transparent 60%),
                  rgba(2,6,23,.72);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .startCard{
      width:min(560px, 100%);
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .h1{ font-size:18px; font-weight:1000; margin:0 0 8px; }
    .p{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.45; }
    .grid{ display:flex; gap:10px; flex-wrap:wrap; }
    .seg{
      flex:1; min-width:140px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px;
    }
    .seg label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900; }
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.55);
      color:var(--text);
      font-weight:900;
      outline:none;
    }
    .startBtn{
      width:100%;
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.20);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }
    .startBtn:active{ transform: translateY(1px); }
    code{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); padding:2px 6px; border-radius:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="hvr-stage" aria-hidden="true"></div>
    <div id="hvr-playfield" aria-label="playfield"></div>
    <div id="hvr-crosshair"></div>

    <!-- HUD -->
    <div class="hud">
      <div class="topbar">
        <div class="card stats">
          <div class="k">SCORE</div><div class="v" id="hha-score-main">0</div>
          <div class="row">
            <div>
              <div class="k">COMBO MAX</div>
              <div class="v" id="hha-combo-max">0</div>
            </div>
            <div>
              <div class="k">MISS</div>
              <div class="v" id="hha-miss">0</div>
            </div>
          </div>
          <div class="row">
            <div class="pill">üèÖ <span id="hha-grade-badge">C</span></div>
            <div class="pill">üß© QUEST <span class="muted"><span id="hha-goal-count">0</span> goal ‚Ä¢ <span id="hha-mini-count">0</span> mini</span></div>
          </div>
        </div>

        <div class="card quest" id="hha-water-card">
          <div class="questTitle">üíß Water balance <span class="muted" id="hha-water-zone-text">GREEN</span> <span class="muted" id="hha-water-pct-text">50%</span></div>

          <div class="progress" style="margin-top:10px;">
            <div id="hha-water-fill" style="width:50%;"></div>
          </div>

          <div class="qline" id="hha-quest-goal"><span class="muted">Goal:</span> ‚Äî</div>
          <div class="qline" id="hha-quest-mini"><span class="muted">Mini:</span> ‚Äî</div>

          <div class="qline muted" style="margin-top:10px;">
            <span id="hha-grade-progress-text">Progress to S (30%): 0%</span>
          </div>
          <div class="progress" style="margin-top:8px;">
            <div id="hha-grade-progress-fill"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="hintCol">
          <div class="hint">Peek HUD <small>‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå HUD ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</small></div>
          <div class="hint">Double-tap <small>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á / ‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡∏µ</small></div>
        </div>

        <div class="btnCol">
          <button class="btn btnMini" id="btnVR">VR</button>
          <button class="btn danger" id="btnStop">STOP</button>
        </div>
      </div>
    </div>

    <!-- Start Overlay -->
    <div id="startOverlay">
      <div class="startCard">
        <div class="h1">Hydration Quest VR ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢ üíß</div>
        <div class="p">
          ‡πÇ‡∏´‡∏°‡∏î <b>play</b> = ‡∏™‡∏ô‡∏∏‡∏Å ‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏à (Storm + Fever + Shield) <br/>
          ‡πÇ‡∏´‡∏°‡∏î <b>research</b> = ‡πÉ‡∏™‡πà <b>seed</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏¥‡πà‡∏á)
        </div>

        <div class="grid">
          <div class="seg">
            <label>Difficulty</label>
            <select id="selDiff">
              <option value="easy" selected>easy</option>
              <option value="normal">normal</option>
              <option value="hard">hard</option>
            </select>
          </div>

          <div class="seg">
            <label>Run mode</label>
            <select id="selRun">
              <option value="play" selected>play</option>
              <option value="research">research</option>
            </select>
          </div>

          <div class="seg">
            <label>Time (sec)</label>
            <input id="inpTime" type="number" min="20" max="180" step="5" value="90" />
          </div>

          <div class="seg">
            <label>Seed (optional)</label>
            <input id="inpSeed" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô schoolA-g5-01" />
          </div>
        </div>

        <button class="startBtn" id="btnStart">START</button>

        <div class="p" style="margin-top:10px;">
          URL ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>?diff=easy&time=90&run=play&debug=1</code> <br/>
          (HUD ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ Peek)
        </div>
      </div>
    </div>
  </div>

  <!-- IMPORTANT: static module import (fix Failed to fetch dynamically imported module) -->
  <script type="module">
    import { boot as HydrationBoot } from './hydration-vr/hydration.safe.js';

    const $ = (id)=>document.getElementById(id);

    const overlay = $('startOverlay');
    const selDiff = $('selDiff');
    const selRun  = $('selRun');
    const inpTime = $('inpTime');
    const inpSeed = $('inpSeed');

    const btnStart = $('btnStart');
    const btnStop  = $('btnStop');
    const btnVR    = $('btnVR');

    // Sync from URL
    const sp = new URLSearchParams(location.search);
    const qDiff = (sp.get('diff')||'').toLowerCase();
    const qRun  = (sp.get('run')||sp.get('mode')||'').toLowerCase();
    const qTime = parseInt(sp.get('time')||'',10);
    const qSeed = String(sp.get('seed')||'').trim();

    if (['easy','normal','hard'].includes(qDiff)) selDiff.value = qDiff;
    if (qRun === 'research' || qRun === 'play') selRun.value = qRun;
    if (!Number.isNaN(qTime) && qTime > 0) inpTime.value = String(qTime);
    if (qSeed) inpSeed.value = qSeed;

    let inst = null;

    async function start(){
      const diff = (selDiff.value||'easy').toLowerCase();
      const run  = (selRun.value||'play').toLowerCase();
      const tsec = Math.max(20, Math.min(180, parseInt(inpTime.value||'90',10) || 90));
      const seed = String(inpSeed.value||'').trim();

      // write URL (nice)
      try{
        const u = new URL(location.href);
        u.searchParams.set('diff', diff);
        u.searchParams.set('time', String(tsec));
        u.searchParams.set('run', run);
        if (seed) u.searchParams.set('seed', seed);
        history.replaceState(null,'',u.toString());
      }catch{}

      overlay.style.display = 'none';

      try{
        inst = await HydrationBoot({ difficulty: diff, duration: tsec, runMode: run, seed });
        window.__HVR_STARTED__ = true;
      }catch(err){
        console.error(err);
        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + (err?.message || err));
        overlay.style.display = '';
        window.__HVR_STARTED__ = false;
      }
    }

    btnStart.addEventListener('click', start);

    btnStop.addEventListener('click', ()=>{
      try{ inst?.stop?.(); }catch{}
      try{ window.dispatchEvent(new CustomEvent('hha:stop')); }catch{}
      overlay.style.display = '';
      window.__HVR_STARTED__ = false;
    });

    btnVR.addEventListener('click', async ()=>{
      // simple fullscreen = ‚ÄúVR feel‚Äù (works on mobile)
      try{
        const el = document.documentElement;
        if (!document.fullscreenElement && el.requestFullscreen) await el.requestFullscreen();
        else if (document.exitFullscreen) await document.exitFullscreen();
      }catch{}
    });

    // optional autostart if run provided
    if (qRun === 'play' || qRun === 'research'){
      // small delay to ensure defer scripts ready
      setTimeout(()=> start(), 120);
    }
  </script>
</body>
</html>