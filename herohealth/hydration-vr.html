<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hydration VR ‚Äî Hero Health</title>
  <meta name="color-scheme" content="dark"/>

  <link rel="icon" href="./favicon.ico"/>

  <!-- ‡πÉ‡∏ä‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Good vs Junk VR -->
  <link rel="stylesheet" href="./css/goodjunk-vr.css"/>
  <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå hydration-vr.css ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πá‡πÉ‡∏™‡πà‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢
  <link rel="stylesheet" href="./css/hydration-vr.css"/>
  -->

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö (overlay ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠) -->
  <style>
    .hha-end-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,.78);
      z-index: 60;
      font-family: system-ui, Segoe UI, Inter, Roboto, sans-serif;
      color: #e5e7eb;
    }
    .hha-end-card {
      background: rgba(15,23,42,.96);
      border-radius: 18px;
      padding: 20px 22px;
      min-width: 260px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0,0,0,.75);
    }
    .hha-end-card h2 {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .hha-end-card h3 {
      margin: 4px 0 10px;
      font-size: 14px;
      font-weight: 500;
      opacity: .9;
    }
    .hha-end-card p {
      margin: 3px 0;
      font-size: 14px;
    }
    .hha-end-card .hha-end-highlight {
      font-weight: 600;
    }
    .hha-end-card button {
      margin-top: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- ===== SCENE WRAP / LOADING ===== -->
  <div class="hha-scene-wrap">
    <div class="hha-loading-msg">
      üíß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î Hydration VR...
    </div>
  </div>

  <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (crosshair) ‡πÉ‡∏´‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏à‡∏≤‡∏Å goodjunk-vr.css ‡∏î‡∏π‡πÅ‡∏• -->
  <div class="hha-crosshair"></div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° VR ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á GoodJunk VR) -->
  <button class="hha-vr-btn" id="hha-vr-btn">VR</button>

  <!-- ===== SCRIPT ZONE ===== -->
  <!-- HUD ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå / ‡∏™‡∏Å‡∏≠‡∏£‡πå ‡∏Ø‡∏•‡∏Ø (‡πÅ‡∏ô‡∏ö‡πÅ‡∏ö‡∏ö side-effect ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Good vs Junk) -->
  <script type="module" src="./vr/quest-hud-vr.js"></script>

  <!-- ‡πÇ‡∏´‡∏°‡∏î Hydration VR -->
  <script type="module">
    import { boot as bootHydration } from './hydration-vr/hydration.safe.js';

    // ‡∏≠‡πà‡∏≤‡∏ô URL param: ?diff=easy|normal|hard&time=60
    const url = new URL(window.location.href);
    let diff = (url.searchParams.get('diff') || 'normal').toLowerCase();
    if (!['easy','normal','hard'].includes(diff)) diff = 'normal';

    let dur = parseInt(url.searchParams.get('time'), 10);
    if (Number.isNaN(dur) || dur <= 0) dur = 60;
    if (dur < 20)  dur = 20;
    if (dur > 180) dur = 180;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î Hydration (engine ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤, HUD, ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå ‡∏Ø‡∏•‡∏Ø ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
    bootHydration({
      difficulty: diff,
      duration:   dur
    }).then(inst => {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ scene-wrap ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
      const wrap = document.querySelector('.hha-scene-wrap');
      if (wrap) wrap.style.display = 'none';

      // ‡∏Å‡∏±‡∏ô memory leak ‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô
      window.addEventListener('beforeunload', () => {
        try {
          if (inst && typeof inst.destroy === 'function') {
            inst.destroy();
          }
        } catch (e) {
          console.warn('[HydrationVR] destroy error on unload', e);
        }
      });
    }).catch(err => {
      console.error('[HydrationVR] boot error', err);
      const msg = document.querySelector('.hha-loading-msg');
      if (msg) {
        msg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î Hydration';
      }
    });
  </script>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡∏à‡∏ö ‡∏û‡∏£‡πâ‡∏≠‡∏° Goals / Mini quests ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå -->
  <script type="module">
    function formatTime(sec) {
      sec = sec | 0;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ':' + (s < 10 ? '0' + s : s);
    }

    window.addEventListener('hha:end', (ev) => {
      const d = ev.detail || {};
      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î Hydration
      if ((d.mode || '').toLowerCase() !== 'hydration') return;

      // ‡∏•‡∏ö overlay ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const old = document.querySelector('.hha-end-overlay');
      if (old) old.remove();

      const overlay = document.createElement('div');
      overlay.className = 'hha-end-overlay';

      const card = document.createElement('div');
      card.className = 'hha-end-card';

      const h2 = document.createElement('h2');
      h2.textContent = '‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏´‡∏°‡∏î Hydration';
      card.appendChild(h2);

      const h3 = document.createElement('h3');
      const diffLabel = (d.difficulty || 'normal').toUpperCase();
      h3.textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å: ${diffLabel}`;
      card.appendChild(h3);

      const pScore = document.createElement('p');
      pScore.innerHTML =
        `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span class="hha-end-highlight">${d.score ?? 0}</span>` +
        ` | Combo ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${d.comboMax ?? 0}`;
      card.appendChild(pScore);

      const pTime = document.createElement('p');
      const dur = d.duration ?? d.timeSec ?? 0;
      const miss = d.misses ?? d.miss ?? 0;
      pTime.textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô: ${formatTime(dur)} | Miss: ${miss}`;
      card.appendChild(pTime);

      if (typeof d.greenTick === 'number') {
        const pGreen = document.createElement('p');
        pGreen.textContent = `‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏• (GREEN): ${d.greenTick}s`;
        card.appendChild(pGreen);
      }

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á 2 ‡∏Ñ‡πà‡∏≤: Goals / Mini quests ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏µ‡πà‡∏≠‡∏±‡∏ô
      if (typeof d.goalsCleared === 'number' && typeof d.goalsTotal === 'number') {
        const pGoals = document.createElement('p');
        pGoals.innerHTML =
          `Goals ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span class="hha-end-highlight">` +
          `${d.goalsCleared}/${d.goalsTotal}</span>`;
        card.appendChild(pGoals);
      }

      if (typeof d.questsCleared === 'number' && typeof d.questsTotal === 'number') {
        const pMini = document.createElement('p');
        pMini.innerHTML =
          `Mini quests ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span class="hha-end-highlight">` +
          `${d.questsCleared}/${d.questsTotal}</span>`;
        card.appendChild(pMini);
      }

      const btn = document.createElement('button');
      btn.textContent = '‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö';
      btn.addEventListener('click', () => {
        location.reload();
      });
      card.appendChild(btn);

      overlay.appendChild(card);
      document.body.appendChild(overlay);
    });
  </script>
</body>
</html>
