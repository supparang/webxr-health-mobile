<!-- === /herohealth/hydration-vr.html ===
Hydration VR ‚Äî ROOT ENTRY (PRODUCTION) v2
‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Launcher Overlay: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PC/Mobile/Cardboard + run/diff/time ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
‚úÖ ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ Start Overlay (‡πÄ‡∏î‡∏¥‡∏°) ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô query params
‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö hydration-vr.loader.js (‡∏≠‡πà‡∏≤‡∏ô view/cardboard) + hydration.safe.js (‡∏≠‡πà‡∏≤‡∏ô run/diff/time)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Global FX + logger (optional) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Coach auto image (hydration-*) -->
  <script src="./vr/coach-manager.js" defer></script>

  <!-- Hydration CSS -->
  <link rel="stylesheet" href="./hydration-vr/hydration-vr.css" />

  <style>
    /* Launcher overlay sits above startOverlay */
    #launcherOverlay{ z-index:220; }
    .hha-launcher-card{
      width:min(720px, 94vw);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(2,6,23,.90);
      box-shadow: 0 30px 120px rgba(0,0,0,.68);
      padding: 16px;
    }
    .hha-launcher-top{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding: 4px 4px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .hha-launcher-top .title{
      font-weight: 1000;
      font-size: 20px;
      letter-spacing:.3px;
    }
    .hha-launcher-top .sub{
      color: rgba(148,163,184,.95);
      margin-top: 6px;
      line-height:1.35;
      font-weight: 800;
      font-size: 13px;
    }
    .hha-launcher-grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
      padding: 12px 4px 4px;
    }
    .hha-field{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.45);
      border-radius: 18px;
      padding: 12px;
    }
    .hha-field h4{
      margin:0 0 8px;
      font-size: 13px;
      font-weight: 1000;
      color: rgba(226,232,240,.95);
      letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
    }
    .hha-row{ display:flex; gap:10px; flex-wrap:wrap; }
    .hha-chip{
      appearance:none;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color: rgba(226,232,240,.95);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
    }
    .hha-chip.active{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.14);
    }
    .hha-select{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color: rgba(226,232,240,.95);
      padding: 10px 12px;
      font-weight: 900;
      outline:none;
    }
    .hha-mini{
      font-size: 12px;
      color: rgba(148,163,184,.95);
      font-weight: 800;
      margin-top: 8px;
      line-height:1.35;
    }
    .hha-launcher-actions{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding: 12px 4px 4px;
    }
    .hha-launcher-actions .left, .hha-launcher-actions .right{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    @media (max-width: 820px){
      .hha-launcher-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="view-pc">

  <!-- ================= LAUNCHER (NEW) ================= -->
  <div id="launcherOverlay" class="hha-overlay">
    <div class="hha-launcher-card">
      <div class="hha-launcher-top">
        <div>
          <div class="title">Hydration VR üíß ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô</div>
          <div class="sub">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå + ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å + ‡πÄ‡∏ß‡∏•‡∏≤‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°<br/>
            <b>Tip:</b> ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô Cardboard ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‚Äúüì¶ ‡πÄ‡∏Ç‡πâ‡∏≤ VR‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ fullscreen/‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
          </div>
        </div>
        <div class="muted" style="font-weight:900">
          Seed: <span id="seedPreview">auto</span>
        </div>
      </div>

      <div class="hha-launcher-grid">
        <div class="hha-field">
          <h4>üïπÔ∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå / ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</h4>
          <div class="hha-row">
            <button class="hha-chip active" data-view="pc" id="chipPc">üñ• PC</button>
            <button class="hha-chip" data-view="mobile" id="chipMobile">üì± Mobile</button>
            <button class="hha-chip" data-view="cvr" id="chipCvr">üì¶ VR Cardboard</button>
          </div>
          <div class="hha-mini">
            ‚Ä¢ PC/Mobile: ‡∏¢‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‚Äù + ‡∏õ‡∏∏‡πà‡∏° üéØ SHOOT + tap-to-shoot<br/>
            ‚Ä¢ Cardboard: ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° üéØ SHOOT (‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≤/reticle)
          </div>
        </div>

        <div class="hha-field">
          <h4>üß™ ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ / ‡πÄ‡∏•‡πà‡∏ô</h4>
          <select id="selRun" class="hha-select">
            <option value="play">PLAY (Adaptive ON)</option>
            <option value="research">RESEARCH (Adaptive OFF)</option>
          </select>

          <div style="height:10px"></div>

          <h4>üéö ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h4>
          <select id="selDiff" class="hha-select">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>

          <div style="height:10px"></div>

          <h4>‚è± ‡πÄ‡∏ß‡∏•‡∏≤</h4>
          <select id="selTime" class="hha-select">
            <option value="50">50s</option>
            <option value="70" selected>70s</option>
            <option value="90">90s</option>
            <option value="120">120s</option>
          </select>

          <div class="hha-mini">
            * ‡πÄ‡∏ß‡∏•‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö Quest + AI Coach + Summary
          </div>
        </div>
      </div>

      <div class="hha-launcher-actions">
        <div class="left">
          <button class="hha-btn" id="btnUseUrl">üîó ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL</button>
          <button class="hha-btn" id="btnDefaults">‚Ü© ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
        </div>
        <div class="right">
          <button class="hha-btn" id="btnGoStart">‚û° ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
          <button class="hha-btn primary" id="btnGoStartNow">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢ (‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= START OVERLAY (‡πÄ‡∏î‡∏¥‡∏°) ================= -->
  <div id="startOverlay" class="hha-overlay" style="z-index:200; display:none">
    <div class="hha-overlay-card">
      <div class="hha-title">Hydration VR üíß</div>
      <div class="hha-sub">
        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Ñ‡∏∏‡∏° WATER ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ã‡∏ô <b>GREEN</b> ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡πÑ‡∏ß‡πâ <b>BLOCK</b> ‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏
      </div>
      <div class="hha-overlay-actions">
        <button id="btnStart" class="hha-btn primary">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnEnterVR" class="hha-btn">üì¶ ‡πÄ‡∏Ç‡πâ‡∏≤ VR (Cardboard)</button>
      </div>
      <div class="hha-hint" id="startHint">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </div>

  <!-- HUD TOP -->
  <div id="hudTop" class="hha-top">
    <div class="hha-pill"><span>‚è± TIME</span><b id="stat-time">0</b></div>
    <div class="hha-pill"><span>üèÜ SCORE</span><b id="stat-score">0</b></div>
    <div class="hha-pill"><span>‚ö° COMBO</span><b id="stat-combo">0</b></div>
    <div class="hha-pill"><span>üí• MISS</span><b id="stat-miss">0</b></div>
    <div class="hha-pill"><span>üéñ GRADE</span><b id="stat-grade">C</b></div>
    <div class="hha-pill"><span>üåÄ STORM</span><b id="storm-left">0</b></div>
    <div class="hha-pill"><span>üõ° SHIELD</span><b id="shield-count">0</b></div>
  </div>

  <!-- MAIN -->
  <main class="hha-main">
    <!-- NORMAL PLAYFIELD -->
    <section id="playfield" class="hha-playfield">
      <div id="hydration-layer" class="hha-layer"></div>
    </section>

    <!-- CARDBOARD PLAYFIELD -->
    <section id="cbPlayfield" class="hha-playfield cb">
      <div class="cb-eyes">
        <div class="eye">
          <div id="hydration-layerL" class="hha-layer"></div>
          <div class="reticle"></div>
        </div>
        <div class="eye">
          <div id="hydration-layerR" class="hha-layer"></div>
          <div class="reticle"></div>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <aside class="hha-side">
      <div class="hha-card" id="water-panel">
        <h3>üíß Water Gauge <small>(0‚Äì100)</small></h3>
        <div class="water-gauge"><div id="water-bar"></div></div>
        <div class="water-meta">
          <div>Zone <b id="water-zone">GREEN</b></div>
          <div><b id="water-pct">50</b>%</div>
        </div>
        <div class="muted">Goal: GREEN (‡∏™‡∏∞‡∏™‡∏°) ‚Ä¢ Mini: LOW/HIGH + BLOCK</div>
      </div>

      <div class="hha-card">
        <h3>üß© Quest</h3>
        <div id="quest-line1">...</div>
        <div id="quest-line2" class="muted">...</div>
        <div id="quest-line3">...</div>
        <div id="quest-line4" class="muted">...</div>
      </div>

      <div class="hha-card">
        <h3>üß† Coach</h3>
        <div class="coachRow">
          <img id="coach-img" alt="coach" />
          <div class="coachText">
            <div id="coach-text">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üíß</div>
            <div id="coach-sub">Tip: ‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏≤‡∏¢‡∏∏</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- BOTTOM CONTROLS -->
  <div id="hudBtns" class="hha-bottom">
    <button class="hha-btn" id="btnCardboard">üì¶ CARDBOARD</button>
    <button class="hha-btn primary" id="btnShoot">üéØ SHOOT</button>
    <button class="hha-btn danger" id="btnStop">‚õî STOP</button>
  </div>

  <!-- SUMMARY -->
  <div id="resultBackdrop" class="hha-result" hidden>
    <div class="hha-result-panel">
      <div class="hha-result-top">
        <h2>üèÅ Summary</h2>
        <div class="hha-result-actions">
          <button class="hha-btn" id="btnRetry">üîÅ Retry</button>
          <button class="hha-btn" id="btnBackHub">üè† Back HUB</button>
          <button class="hha-btn" id="btnCopyJSON">üìã Copy JSON</button>
          <button class="hha-btn" id="btnDownloadCSV">‚¨áÔ∏è Download CSV</button>
        </div>
      </div>

      <div class="hha-grid">
        <div class="tile"><div class="lab">Score</div><div class="val" id="rScore">0</div></div>
        <div class="tile"><div class="lab">Grade</div><div class="val" id="rGrade">C</div></div>
        <div class="tile"><div class="lab">Accuracy</div><div class="val" id="rAcc">0%</div></div>

        <div class="tile"><div class="lab">Combo Max</div><div class="val" id="rComboMax">0</div></div>
        <div class="tile"><div class="lab">Miss</div><div class="val" id="rMiss">0</div></div>
        <div class="tile"><div class="lab">Goals</div><div class="val" id="rGoals">0/0</div></div>

        <div class="tile"><div class="lab">Minis</div><div class="val" id="rMinis">0/0</div></div>
        <div class="tile"><div class="lab">Time in GREEN</div><div class="val" id="rGreen">0.0s</div></div>
        <div class="tile"><div class="lab">Streak Max</div><div class="val" id="rStreak">0</div></div>

        <div class="tile"><div class="lab">Storm Cycles</div><div class="val" id="rStormCycles">0</div></div>
        <div class="tile"><div class="lab">Storm Success</div><div class="val" id="rStormOk">0</div></div>
        <div class="tile"><div class="lab">Storm Rate</div><div class="val" id="rStormRate">0%</div></div>
      </div>

      <div class="hha-tipsRow">
        <div class="tile">
          <div class="lab">AI Tips</div>
          <div class="tips" id="rTips">‚Ä¢ ...</div>
        </div>
        <div class="tile">
          <div class="lab">Next Focus</div>
          <div class="val" id="rNext">...</div>
          <div class="muted" id="rTier">Tier: ...</div>
        </div>
      </div>

      <div class="hha-closeRow">
        <button class="hha-btn" id="btnCloseSummary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- LOADER -->
  <script type="module" src="./hydration-vr/hydration-vr.loader.js"></script>

  <!-- ============ Launcher Logic (inline) ============ -->
  <script>
    (function(){
      const D = document;
      const launcher = D.getElementById('launcherOverlay');
      const startOverlay = D.getElementById('startOverlay');
      const startHint = D.getElementById('startHint');

      const selRun = D.getElementById('selRun');
      const selDiff = D.getElementById('selDiff');
      const selTime = D.getElementById('selTime');

      const chipPc = D.getElementById('chipPc');
      const chipMobile = D.getElementById('chipMobile');
      const chipCvr = D.getElementById('chipCvr');
      let view = 'pc';

      function q(){
        try{ return new URL(location.href); }catch(_){ return null; }
      }
      function setChipActive(v){
        view = v;
        [chipPc, chipMobile, chipCvr].forEach(b=>b && b.classList.remove('active'));
        const map = { pc: chipPc, mobile: chipMobile, cvr: chipCvr };
        map[v]?.classList.add('active');
      }
      function pullFromUrl(){
        const u = q(); if(!u) return;
        const run = (u.searchParams.get('run') || u.searchParams.get('runMode') || 'play').toLowerCase();
        const diff = (u.searchParams.get('diff') || 'normal').toLowerCase();
        const time = String(u.searchParams.get('time') || u.searchParams.get('durationPlannedSec') || '70');
        const v = (u.searchParams.get('view') || '').toLowerCase();
        const cb = (u.searchParams.get('cardboard') === '1') || (v === 'cvr');

        if (selRun) selRun.value = (run === 'research') ? 'research' : 'play';
        if (selDiff) selDiff.value = (diff === 'easy' || diff === 'hard') ? diff : 'normal';
        if (selTime) selTime.value = ['50','70','90','120'].includes(time) ? time : '70';

        setChipActive(cb ? 'cvr' : (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'mobile' : 'pc'));

        const sp = D.getElementById('seedPreview');
        if (sp){
          const seed = u.searchParams.get('seed') || (u.searchParams.get('sessionId') || u.searchParams.get('studentKey') || '') + '|' + (u.searchParams.get('ts') || '');
          sp.textContent = seed ? seed : 'auto';
        }
      }
      function defaults(){
        if (selRun) selRun.value = 'play';
        if (selDiff) selDiff.value = 'normal';
        if (selTime) selTime.value = '70';
        setChipActive(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'mobile' : 'pc');
      }

      function applyParamsToUrl(){
        const u = q(); if(!u) return null;
        u.searchParams.set('run', selRun?.value || 'play');
        u.searchParams.set('diff', selDiff?.value || 'normal');
        u.searchParams.set('time', selTime?.value || '70');
        u.searchParams.set('ts', String(Date.now()));

        if (view === 'cvr'){
          u.searchParams.set('view', 'cvr');
          u.searchParams.set('cardboard', '1');
        } else {
          u.searchParams.delete('cardboard');
          u.searchParams.set('view', view);
        }
        // mark that user has chosen options
        u.searchParams.set('chosen', '1');
        return u;
      }

      function goStart(showNow){
        const u = applyParamsToUrl();
        if (!u) return;

        // update URL without reload (keeps hub link etc.)
        history.replaceState({}, '', u.toString());

        // show Start Overlay
        if (launcher) launcher.style.display = 'none';
        if (startOverlay){
          startOverlay.style.display = '';
          startOverlay.classList.remove('hide');
        }

        const msg =
          `Mode: ${view.toUpperCase()} ‚Ä¢ Run: ${(selRun?.value||'play').toUpperCase()} ‚Ä¢ Diff: ${(selDiff?.value||'normal').toUpperCase()} ‚Ä¢ Time: ${(selTime?.value||'70')}s`;
        if (startHint) startHint.textContent = msg;

        if (showNow){
          // If user chose cvr, auto click EnterVR (still within a user gesture chain in many browsers)
          if (view === 'cvr'){
            const btnEnter = D.getElementById('btnEnterVR');
            setTimeout(()=>btnEnter?.click(), 60);
          } else {
            const btnStart = D.getElementById('btnStart');
            setTimeout(()=>btnStart?.click(), 60);
          }
        }
      }

      // Bind chips
      chipPc?.addEventListener('click', ()=>setChipActive('pc'));
      chipMobile?.addEventListener('click', ()=>setChipActive('mobile'));
      chipCvr?.addEventListener('click', ()=>setChipActive('cvr'));

      // Actions
      D.getElementById('btnUseUrl')?.addEventListener('click', pullFromUrl);
      D.getElementById('btnDefaults')?.addEventListener('click', defaults);
      D.getElementById('btnGoStart')?.addEventListener('click', ()=>goStart(false));
      D.getElementById('btnGoStartNow')?.addEventListener('click', ()=>goStart(true));

      // Init: show launcher always when coming from hub, unless chosen=1
      defaults();
      pullFromUrl();

      const u0 = q();
      const chosen = u0 && (u0.searchParams.get('chosen') === '1');
      // If user has chosen already (e.g., refresh mid-game), don't block with launcher
      if (chosen){
        if (launcher) launcher.style.display = 'none';
        if (startOverlay) startOverlay.style.display = '';
      } else {
        if (launcher) launcher.style.display = '';
        if (startOverlay) startOverlay.style.display = 'none';
      }
    })();
  </script>
</body>
</html>