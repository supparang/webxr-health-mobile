<!-- === /herohealth/hydration-vr.html ===
Hydration VR ‚Äî ROOT ENTRY (PRODUCTION v2: mode options)
/show: PC / Mobile / Cardboard options
/keeps: loader handles view + fullscreen + shoot + start
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Global FX + logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <!-- Coach image binder -->
  <script src="./vr/coach-manager.js" defer></script>

  <!-- Hydration CSS -->
  <link rel="stylesheet" href="./hydration-vr/hydration-vr.css" />

  <style>
    /* tiny extras for the new option UI */
    .optRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .optCard{
      flex:1 1 150px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,23,42,.45);
      padding: 12px;
    }
    .optCard .t{ font-weight:1000; }
    .optCard .d{ color:var(--muted); font-weight:850; margin-top:6px; line-height:1.35; font-size:13px; }
    .optActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .optActions .hha-btn{ min-width prevent; }
    .miniSettings{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .miniSettings label{
      display:flex; flex-direction:column; gap:6px;
      font-weight:900; color:var(--muted);
      font-size:12px;
    }
    .miniSettings select, .miniSettings input{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(2,6,23,.55);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 950;
      outline:none;
    }
    .miniSettings .full{ grid-column: 1 / -1; }
    .topMiniBtns{
      position:fixed;
      top: calc(var(--sat) + 10px);
      right: calc(var(--sar) + 10px);
      z-index: 210;
      display:flex; gap:8px;
    }
    .ghostBtn{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(2,6,23,.55);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .ghostBtn:active{ transform: translateY(1px); }
    .settingsBox{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:18px;
      padding:12px;
      background: rgba(2,6,23,.45);
      display:none;
    }
    .settingsBox.show{ display:block; }
    .settingsHint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      line-height:1.4;
    }
    @media (max-width:520px){
      .miniSettings{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="view-pc">
  <!-- quick top buttons (works even before start) -->
  <div class="topMiniBtns">
    <button class="ghostBtn" id="btnGoHub">üè† HUB</button>
    <button class="ghostBtn" id="btnToggleSettings">‚öôÔ∏è</button>
  </div>

  <!-- Start Overlay -->
  <div id="startOverlay" class="hha-overlay">
    <div class="hha-overlay-card">
      <div class="hha-title">Hydration VR üíß</div>
      <div class="hha-sub">
        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Ñ‡∏∏‡∏° WATER ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ã‡∏ô <b>GREEN</b> ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡πÑ‡∏ß‡πâ <b>BLOCK</b> ‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏
        <div class="settingsHint">Tip: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚ÄúMobile / Tap-to-shoot‚Äù ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Cardboard ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</div>
      </div>

      <!-- Mode options -->
      <div class="optRow">
        <div class="optCard">
          <div class="t">üñ• PC</div>
          <div class="d">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤ ‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö/‡∏™‡∏≤‡∏ò‡∏¥‡∏ï</div>
          <div class="optActions">
            <button class="hha-btn primary" id="btnStartPC">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô PC</button>
          </div>
        </div>

        <div class="optCard">
          <div class="t">üì± Mobile</div>
          <div class="d">‡πÅ‡∏ï‡∏∞‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á + ‡∏õ‡∏∏‡πà‡∏° SHOOT ‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï</div>
          <div class="optActions">
            <button class="hha-btn primary" id="btnStartMobile">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô Mobile</button>
          </div>
        </div>

        <div class="optCard">
          <div class="t">üì¶ VR Cardboard</div>
          <div class="d">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (reticle) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î SHOOT ‚Ä¢ fullscreen + ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</div>
          <div class="optActions">
            <button class="hha-btn" id="btnEnterVR">üéÆ ‡πÄ‡∏Ç‡πâ‡∏≤ Cardboard</button>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div id="settingsBox" class="settingsBox">
        <div class="miniSettings">
          <label>
            Difficulty
            <select id="setDiff">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </label>

          <label>
            Time (sec)
            <input id="setTime" type="number" min="20" max="600" value="70" />
          </label>

          <label class="full">
            Run Mode
            <select id="setRun">
              <option value="play" selected>play</option>
              <option value="research">research</option>
            </select>
          </label>
        </div>

        <div class="settingsHint">
          ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö URL ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î research ‡∏à‡∏∞‡∏õ‡∏¥‡∏î adaptive (‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢)
        </div>
      </div>

      <div class="hha-overlay-actions" style="margin-top:14px;">
        <button id="btnStart" class="hha-btn primary">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</button>
        <button id="btnStartDefault" class="hha-btn">‚ö° Auto (‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</button>
      </div>

      <div class="hha-hint">* ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏≥/‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ user gesture ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠)</div>
    </div>
  </div>

  <!-- HUD TOP -->
  <div id="hudTop" class="hha-top">
    <div class="hha-pill"><span>‚è± TIME</span><b id="stat-time">0</b></div>
    <div class="hha-pill"><span>üèÜ SCORE</span><b id="stat-score">0</b></div>
    <div class="hha-pill"><span>‚ö° COMBO</span><b id="stat-combo">0</b></div>
    <div class="hha-pill"><span>üí• MISS</span><b id="stat-miss">0</b></div>
    <div class="hha-pill"><span>üéñ GRADE</span><b id="stat-grade">C</b></div>
    <div class="hha-pill"><span>üåÄ STORM</span><b id="storm-left">0</b></div>
    <div class="hha-pill"><span>üõ° SHIELD</span><b id="shield-count">0</b></div>
  </div>

  <!-- MAIN -->
  <main class="hha-main">
    <!-- NORMAL PLAYFIELD -->
    <section id="playfield" class="hha-playfield">
      <div id="hydration-layer" class="hha-layer"></div>
      <div class="hha-crosshair" aria-hidden="true"></div>
    </section>

    <!-- CARDBOARD PLAYFIELD -->
    <section id="cbPlayfield" class="hha-playfield cb">
      <div class="cb-eyes">
        <div class="eye">
          <div id="hydration-layerL" class="hha-layer"></div>
          <div class="reticle"></div>
        </div>
        <div class="eye">
          <div id="hydration-layerR" class="hha-layer"></div>
          <div class="reticle"></div>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <aside class="hha-side">
      <div class="hha-card" id="water-panel">
        <h3>üíß Water Gauge <small>(0‚Äì100)</small></h3>
        <div class="water-gauge"><div id="water-bar"></div></div>
        <div class="water-meta">
          <div>Zone <b id="water-zone">GREEN</b></div>
          <div><b id="water-pct">50</b>%</div>
        </div>
        <div class="muted">Goal: GREEN (‡∏™‡∏∞‡∏™‡∏°) ‚Ä¢ Mini: LOW/HIGH + BLOCK</div>
      </div>

      <div class="hha-card">
        <h3>üß© Quest</h3>
        <div id="quest-line1">...</div>
        <div id="quest-line2" class="muted">...</div>
        <div id="quest-line3">...</div>
        <div id="quest-line4" class="muted">...</div>
      </div>

      <div class="hha-card">
        <h3>üß† Coach</h3>
        <div class="coachRow">
          <img id="coach-img" alt="coach" />
          <div class="coachText">
            <div id="coach-text">‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏¥‡∏á üíß</div>
            <div id="coach-sub">Tip: ‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏≤‡∏¢‡∏∏</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- BOTTOM CONTROLS -->
  <div id="hudBtns" class="hha-bottom">
    <button class="hha-btn" id="btnCardboard">üì¶ CARDBOARD</button>
    <button class="hha-btn primary" id="btnShoot">üéØ SHOOT</button>
    <button class="hha-btn danger" id="btnStop">‚õî STOP</button>
  </div>

  <!-- SUMMARY -->
  <div id="resultBackdrop" class="hha-result" hidden>
    <div class="hha-result-panel">
      <div class="hha-result-top">
        <h2>üèÅ Summary</h2>
        <div class="hha-result-actions">
          <button class="hha-btn" id="btnRetry">üîÅ Retry</button>
          <button class="hha-btn" id="btnBackHub">üè† Back HUB</button>
          <button class="hha-btn" id="btnCopyJSON">üìã Copy JSON</button>
          <button class="hha-btn" id="btnDownloadCSV">‚¨áÔ∏è Download CSV</button>
        </div>
      </div>

      <div class="hha-grid">
        <div class="tile"><div class="lab">Score</div><div class="val" id="rScore">0</div></div>
        <div class="tile"><div class="lab">Grade</div><div class="val" id="rGrade">C</div></div>
        <div class="tile"><div class="lab">Accuracy</div><div class="val" id="rAcc">0%</div></div>

        <div class="tile"><div class="lab">Combo Max</div><div class="val" id="rComboMax">0</div></div>
        <div class="tile"><div class="lab">Miss</div><div class="val" id="rMiss">0</div></div>
        <div class="tile"><div class="lab">Goals</div><div class="val" id="rGoals">0/0</div></div>

        <div class="tile"><div class="lab">Minis</div><div class="val" id="rMinis">0/0</div></div>
        <div class="tile"><div class="lab">Time in GREEN</div><div class="val" id="rGreen">0.0s</div></div>
        <div class="tile"><div class="lab">Streak Max</div><div class="val" id="rStreak">0</div></div>

        <div class="tile"><div class="lab">Storm Cycles</div><div class="val" id="rStormCycles">0</div></div>
        <div class="tile"><div class="lab">Storm Success</div><div class="val" id="rStormOk">0</div></div>
        <div class="tile"><div class="lab">Storm Rate</div><div class="val" id="rStormRate">0%</div></div>
      </div>

      <div class="hha-tipsRow">
        <div class="tile">
          <div class="lab">AI Tips</div>
          <div class="tips" id="rTips">‚Ä¢ ...</div>
        </div>
        <div class="tile">
          <div class="lab">Next Focus</div>
          <div class="val" id="rNext">...</div>
          <div class="muted" id="rTier">Tier: ...</div>
        </div>
      </div>

      <div class="hha-closeRow">
        <button class="hha-btn" id="btnCloseSummary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- LOADER -->
  <script type="module" src="./hydration-vr/hydration-vr.loader.js"></script>

  <!-- Small overlay logic for options (pure inline, safe) -->
  <script>
    (function(){
      const qs = (k, d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(e){ return d; } };
      const overlay = document.getElementById('startOverlay');

      const btnGoHub = document.getElementById('btnGoHub');
      const btnToggleSettings = document.getElementById('btnToggleSettings');
      const settingsBox = document.getElementById('settingsBox');

      const setDiff = document.getElementById('setDiff');
      const setTime = document.getElementById('setTime');
      const setRun  = document.getElementById('setRun');

      const btnStart = document.getElementById('btnStart');
      const btnStartDefault = document.getElementById('btnStartDefault');
      const btnStartPC = document.getElementById('btnStartPC');
      const btnStartMobile = document.getElementById('btnStartMobile');
      const btnEnterVR = document.getElementById('btnEnterVR');

      // init controls from URL
      const diff = (qs('diff','normal')||'normal').toLowerCase();
      const time = parseInt(qs('time','70'),10) || 70;
      const run  = (qs('run', qs('runMode','play'))||'play').toLowerCase();

      if (setDiff) setDiff.value = (diff==='easy'||diff==='hard'||diff==='normal') ? diff : 'normal';
      if (setTime) setTime.value = String(Math.max(20, Math.min(600, time)));
      if (setRun)  setRun.value  = (run==='research') ? 'research' : 'play';

      function hideOverlay(){
        try{ overlay.classList.add('hide'); overlay.style.display='none'; }catch(e){}
      }

      function setUrlParams(obj){
        const u = new URL(location.href);
        Object.keys(obj).forEach(k=>{
          if (obj[k] === null || obj[k] === undefined) return;
          u.searchParams.set(k, String(obj[k]));
        });
        return u;
      }

      function applySettingsAndReload(extra={}){
        const u = setUrlParams({
          diff: (setDiff && setDiff.value) || diff,
          time: (setTime && setTime.value) || time,
          run:  (setRun && setRun.value) || run,
          ...extra
        });
        // keep hub param
        const hub = qs('hub', null);
        if (hub) u.searchParams.set('hub', hub);
        // refresh ts for deterministic sessions (optional)
        u.searchParams.set('ts', String(Date.now()));
        location.href = u.toString();
      }

      btnToggleSettings?.addEventListener('click', ()=>{
        settingsBox?.classList.toggle('show');
      });

      // update instantly when changed (nice UX)
      setDiff?.addEventListener('change', ()=>applySettingsAndReload({}));
      setTime?.addEventListener('change', ()=>applySettingsAndReload({}));
      setRun?.addEventListener('change', ()=>applySettingsAndReload({}));

      btnGoHub?.addEventListener('click', ()=>{
        const hub = qs('hub','./hub.html');
        location.href = hub;
      });

      // Mode buttons:
      btnStartPC?.addEventListener('click', ()=>{
        document.body.classList.remove('view-mobile','view-cvr');
        document.body.classList.add('view-pc');
        hideOverlay();
        window.dispatchEvent(new CustomEvent('hha:start'));
      });

      btnStartMobile?.addEventListener('click', ()=>{
        document.body.classList.remove('view-pc','view-cvr');
        document.body.classList.add('view-mobile');
        hideOverlay();
        window.dispatchEvent(new CustomEvent('hha:start'));
      });

      // Enter VR button is handled by loader (it binds #btnEnterVR).
      // Our overlay also provides a fallback: if loader didn't bind yet, still start.
      btnEnterVR?.addEventListener('click', ()=>{
        // if loader hasn't bound, at least hide overlay; loader will flip to cvr.
        setTimeout(()=>{
          hideOverlay();
          window.dispatchEvent(new CustomEvent('hha:start'));
        }, 200);
      });

      // Start (whatever loader decided for view)
      btnStart?.addEventListener('click', ()=>{
        hideOverlay();
        window.dispatchEvent(new CustomEvent('hha:start'));
      });

      // Auto by device (just hide + start; loader already picked view on boot)
      btnStartDefault?.addEventListener('click', ()=>{
        hideOverlay();
        window.dispatchEvent(new CustomEvent('hha:start'));
      });

    })();
  </script>
</body>
</html>