<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.72);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --cyan:#22d3ee;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:22px;
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ overflow:hidden; }

    /* stage */
    #app{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
    }
    #playfield{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      padding-top: calc(var(--sat) + 10px);
      padding-bottom: calc(var(--sab) + 10px);
    }

    /* background */
    #playfield::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 18% 16%, rgba(34,211,238,.10), transparent 55%),
        radial-gradient(circle at 84% 78%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(circle at 48% 92%, rgba(168,85,247,.08), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    /* layers (targets mount here) */
    .layer{
      position:absolute; inset:0;
      z-index:10;
      pointer-events:auto;
    }

    /* HUD */
    #hud{
      position:absolute;
      left:12px; right:12px;
      top: calc(var(--sat) + 10px);
      z-index:80;
      pointer-events:none;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .panel{
      pointer-events:none;
      background:var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:10px;
    }
    #hudLeft{ width:min(420px, 54vw); }
    #hudRight{ flex:1 1 auto; min-width:240px; }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .title{ font-weight:900; letter-spacing:.2px; font-size:13px; }
    .muted{ color:rgba(148,163,184,.95); font-size:12px; }

    /* water bar */
    #waterWrap{ margin-top:8px; }
    #waterBarOuter{
      height:12px;
      border-radius:999px;
      background: rgba(15,23,42,.6);
      border:1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    #water-bar{
      height:100%;
      width:50%;
      background: linear-gradient(90deg, rgba(34,211,238,.85), rgba(34,197,94,.85));
    }
    .kpi{
      display:flex; justify-content:space-between;
      margin-top:6px;
      font-size:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.55);
      font-weight:800;
      font-size:12px;
      color:rgba(229,231,235,.95);
    }
    .pill.good{ border-color: rgba(34,197,94,.22); }
    .pill.bad{ border-color: rgba(239,68,68,.22); }

    /* quest */
    #quest .qline{ font-size:12px; line-height:1.35; white-space:pre-line; }

    /* stats */
    #stats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:6px;
      margin-top:8px;
    }
    .stat{
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.14);
      border-radius:14px;
      padding:8px 8px;
      text-align:center;
    }
    .stat .v{ font-weight:900; font-size:14px; }
    .stat .k{ font-size:11px; color:rgba(148,163,184,.95); }

    /* start overlay */
    #startOverlay{
      position:fixed; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(2,6,23,.78);
      backdrop-filter: blur(10px);
    }
    .card{
      width:min(920px, 100%);
      border-radius:var(--radius);
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.72);
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      padding:16px;
    }
    .head{ display:flex; gap:12px; align-items:center; }
    .icon{
      width:52px; height:52px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(34,211,238,.12);
      border:1px solid rgba(34,211,238,.18);
      font-size:26px;
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; }
    .sub{ margin:6px 0 0 0; color:rgba(148,163,184,.95); font-size:13px; line-height:1.4; white-space:pre-line; }

    .btnRow{ margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; }
    .btn{
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.62);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{ border-color: rgba(34,197,94,.26); background: rgba(34,197,94,.16); }
    .btn.warn{ border-color: rgba(245,158,11,.26); background: rgba(245,158,11,.14); }
    code{ background:rgba(15,23,42,.62); border:1px solid rgba(148,163,184,.14); padding:1px 6px; border-radius:10px; }

    /* result overlay */
    #resultBackdrop{
      position:fixed; inset:0;
      z-index:210;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(2,6,23,.82);
      backdrop-filter: blur(12px);
    }
    #resultCard{
      width:min(980px, 100%);
      border-radius:var(--radius);
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.74);
      box-shadow: 0 22px 90px rgba(0,0,0,.6);
      padding:16px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:10px;
    }
    .kv{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    .kv .box{
      border:1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.55);
      border-radius:14px;
      padding:10px;
    }
    .kv .box .k{ font-size:11px; color:rgba(148,163,184,.95); }
    .kv .box .v{ font-weight:900; font-size:16px; margin-top:2px; }
    #rTips{ white-space:pre-line; font-size:12px; color:rgba(229,231,235,.92); line-height:1.4; }
    #rNext{ font-size:12px; color:rgba(148,163,184,.95); margin-top:8px; }
    .btnBackHub{ }
    [hidden]{ display:none !important; }

    /* FX classes toggled by engine */
    body.hha-bossfx #playfield::before{ filter:saturate(1.25); }
    body.hha-endfx  #playfield::before{ filter:contrast(1.15); }

    /* optional shock fx element from engine */
    .hha-shock{
      position:absolute;
      left:var(--x); top:var(--y);
      width:22px; height:22px;
      transform: translate(-50%,-50%);
      border-radius:999px;
      border:2px solid rgba(34,211,238,.65);
      box-shadow: 0 0 0 10px rgba(34,211,238,.10);
      animation: shock .65s ease-out forwards;
      pointer-events:none;
      z-index:60;
    }
    @keyframes shock{
      0%{ opacity:1; transform:translate(-50%,-50%) scale(.85); }
      100%{ opacity:0; transform:translate(-50%,-50%) scale(2.2); }
    }

    @media (max-width: 720px){
      #hud{ flex-direction:column; }
      #hudLeft{ width:100%; }
      #hudRight{ width:100%; }
      #stats{ grid-template-columns: repeat(5, minmax(0,1fr)); }
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="playfield">
      <!-- HUD -->
      <div id="hud">
        <div id="hudLeft" class="panel">
          <div class="row">
            <div class="title">üíß Hydration</div>
            <div class="pill good">‡∏ô‡πâ‡∏≥ <span id="water-pct">50</span>%</div>
            <div class="pill">‡πÇ‡∏ã‡∏ô <span id="water-zone">GREEN</span></div>
          </div>

          <div id="waterWrap">
            <div id="waterBarOuter"><div id="water-bar"></div></div>
            <div class="kpi">
              <span class="muted">LOW &lt; 40 | GREEN 40‚Äì70 | HIGH &gt; 70</span>
              <span class="muted">Storm: <span id="storm-left">0</span>s</span>
            </div>
          </div>

          <div id="stats">
            <div class="stat"><div class="v" id="stat-score">0</div><div class="k">Score</div></div>
            <div class="stat"><div class="v" id="stat-combo">0</div><div class="k">Combo</div></div>
            <div class="stat"><div class="v" id="stat-miss">0</div><div class="k">Miss</div></div>
            <div class="stat"><div class="v" id="stat-time">0</div><div class="k">Time</div></div>
            <div class="stat"><div class="v" id="stat-grade">D</div><div class="k">Grade</div></div>
          </div>
        </div>

        <div id="hudRight" class="panel" style="pointer-events:none;">
          <div class="title">üéØ Quest</div>
          <div id="quest" style="margin-top:8px;">
            <div class="qline" id="quest-line1">‚Äî</div>
            <div class="qline" id="quest-line2">‚Äî</div>
            <div class="qline muted" id="quest-line3">‚Äî</div>
            <div class="qline muted" id="quest-line4">‚Äî</div>
            <div class="qline muted" style="margin-top:8px;">Shield: <span id="shield-count">0</span></div>
          </div>
        </div>
      </div>

      <!-- target layers -->
      <div id="hydration-layer" class="layer" aria-label="hydration-layer"></div>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div id="startOverlay">
    <div class="card">
      <div class="head">
        <div class="icon">üíß</div>
        <div>
          <h1>Hydration VR</h1>
          <p class="sub" id="startDesc">
‡πÇ‡∏´‡∏°‡∏î: <code id="sRun">play</code> | ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <code id="sDiff">normal</code> | ‡πÄ‡∏ß‡∏•‡∏≤: <code id="sTime">70</code>s
‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô GREEN ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
          </p>
        </div>
      </div>
      <div class="btnRow">
        <button class="btn primary" id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
        <button class="btn warn" id="btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div class="sub" style="margin-top:10px;" id="startHint">
Tip: ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Ñ‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ crosshair ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á (tap-to-shoot) ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
      </div>
    </div>
  </div>

  <!-- RESULT OVERLAY (engine toggles [hidden]) -->
  <div id="resultBackdrop" hidden>
    <div id="resultCard">
      <div class="head">
        <div class="icon">üèÅ</div>
        <div>
          <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h1>
          <p class="sub">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV / ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>
      </div>

      <div class="grid2">
        <div class="panel" style="pointer-events:none;">
          <div class="title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
          <div class="kv">
            <div class="box"><div class="k">Score</div><div class="v" id="rScore">0</div></div>
            <div class="box"><div class="k">Grade</div><div class="v" id="rGrade">D</div></div>
            <div class="box"><div class="k">Accuracy</div><div class="v" id="rAcc">0%</div></div>
            <div class="box"><div class="k">ComboMax</div><div class="v" id="rComboMax">0</div></div>
            <div class="box"><div class="k">Miss</div><div class="v" id="rMiss">0</div></div>
            <div class="box"><div class="k">Tier</div><div class="v" id="rTier">‚Äî</div></div>
            <div class="box"><div class="k">Goal</div><div class="v" id="rGoals">‚Äî</div></div>
            <div class="box"><div class="k">Mini</div><div class="v" id="rMinis">‚Äî</div></div>
          </div>

          <div id="rNext"></div>
        </div>

        <div class="panel">
          <div class="title">‡πÇ‡∏Ñ‡πâ‡∏ä‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
          <div id="rTips" style="margin-top:8px;">‚Äî</div>

          <div class="btnRow" style="margin-top:12px;">
            <button class="btn primary" id="btnRetry">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            <button class="btn" id="btnCopyJSON">üìã Copy JSON</button>
            <button class="btn" id="btnDownloadCSV">‚¨áÔ∏è Download CSV</button>
          </div>

          <div class="btnRow" style="margin-top:8px;">
            <button class="btn warn btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
            <button class="btn" id="btnCloseSummary">‚úñÔ∏è ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Universal VR UI (Enter VR/Exit/Recenter + crosshair + hha:shoot) -->
  <script defer src="../vr/vr-ui.js"></script>

  <!-- View helper: set body class for pc/mobile/cvr/cardboard (optional but useful) -->
  <script>
  (function(){
    const qs=(k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } };
    const view = String(qs('view','')).toLowerCase();
    const ua = navigator.userAgent||'';
    const isMobile = (typeof matchMedia==='function' && matchMedia('(pointer:coarse)').matches) || /Android|iPhone|iPad|iPod/i.test(ua);

    // default if not set
    const v = view || (isMobile ? 'mobile' : 'pc');

    document.body.classList.add(`view-${v}`);

    // expose HHA_VIEW layers for safe.js
    window.HHA_VIEW = window.HHA_VIEW || {};
    if (!Array.isArray(window.HHA_VIEW.layers) || !window.HHA_VIEW.layers.length){
      window.HHA_VIEW.layers = ['hydration-layer'];
    }
  })();
  </script>

  <!-- START OVERLAY controller (dispatch hha:start) -->
  <script>
  (function(){
    const qs=(k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } };
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,Number(v)||0));
    const run = (String(qs('run','play')).toLowerCase()==='research') ? 'research' : 'play';
    const diff0 = String(qs('diff','normal')).toLowerCase();
    const diff = (diff0==='easy'||diff0==='hard') ? diff0 : 'normal';
    const time = clamp(Number(qs('time',70)), 20, 600) | 0;
    const seedQ = Number(qs('seed',0)) || 0;
    const seed = seedQ ? seedQ : Date.now();
    const hub = String(qs('hub','../hub.html'));

    const $ = (id)=>document.getElementById(id);
    if ($('sRun')) $('sRun').textContent = run;
    if ($('sDiff')) $('sDiff').textContent = diff;
    if ($('sTime')) $('sTime').textContent = String(time);

    function fireStart(){
      try{
        window.dispatchEvent(new CustomEvent('hha:start', { detail: {
          game:'hydration',
          runMode: run,
          diff,
          timePlannedSec: time,
          seed,
          // legacy alias
          run,
          time
        }}));
      }catch(_){}
      // hide overlay (safe.js has hardened auto-start too)
      const ov = $('startOverlay');
      if (ov) ov.hidden = true;
    }

    $('btnStart')?.addEventListener('click', fireStart);
    $('btnBackHub')?.addEventListener('click', ()=>{ location.href = hub; });

    // auto-start if startOverlay is not really visible / or in VR contexts
    setTimeout(()=>{
      const ov = $('startOverlay');
      if (!ov) return;
      const cs = getComputedStyle(ov);
      const visible = !(ov.hidden || cs.display==='none' || cs.visibility==='hidden' || Number(cs.opacity||'1')<=0);
      if (!visible) fireStart();
    }, 240);
  })();
  </script>

  <!-- SAFE ENGINE (module) -->
  <script type="module">
    import './hydration.safe.js';

    // --------- PATCH: make STORM actually happen (run-time hotfix) ----------
    // NOTE: your hydration.safe.js should already include the logic;
    // this section is just a safety net in case an older cached safe.js loads.
    (function(){
      const WIN = window;

      // If the module exposes HydrationVR debug object, we can patch state live.
      // Otherwise do nothing (safe.js already contains the fix).
      const tryPatch = () => {
        const api = WIN.HydrationVR;
        if (!api || typeof api.getState !== 'function') return;

        // (no-op) ‚Äî keep for future hotfix hooks
      };
      setTimeout(tryPatch, 600);
    })();
  </script>
</body>
</html>