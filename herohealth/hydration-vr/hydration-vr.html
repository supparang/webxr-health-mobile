<!-- === /herohealth/hydration-vr/hydration-vr.html ===
HydrationVR Run (PC/Mobile/Cardboard/cVR)
‚úÖ Uses vr-ui.js (Enter VR/Exit/Recenter + crosshair + tap-to-shoot => hha:shoot)
‚úÖ Folder loader imports hydration.safe.js
‚úÖ Layers: single or stereo (cardboard)
‚úÖ Start overlay -> emits hha:start
‚úÖ Result summary: shows RT + Perfect bonus + Tier + tips
‚úÖ Flush-hardened logging via hha-cloud-logger.js (optional) if ?log=
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./hydration-vr.css" />

  <!-- A-Frame (minimal, for ENTER VR reliability in compatible devices) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + optional logger -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>

  <!-- Universal VR UI -->
  <script src="../vr/vr-ui.js" defer></script>

  <!-- Loader (imports hydration.safe.js) -->
  <script src="./hydration-vr.loader.js" defer></script>
</head>

<body class="view-pc">
  <!-- Minimal A-Frame scene hidden behind DOM (for WebXR enter/exit/recenter buttons) -->
  <a-scene
    embedded
    renderer="antialias:true;alpha:true"
    vr-mode-ui="enabled:false"
    style="position:fixed; inset:0; width:1px; height:1px; opacity:0; pointer-events:none;">
    <a-entity camera position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- ===== TOP HUD ===== -->
  <header class="hud-top" id="hudTop">
    <div class="hud-left">
      <div class="stat">
        <div class="k">SCORE</div>
        <div class="v" id="stat-score">0</div>
      </div>
      <div class="stat">
        <div class="k">COMBO</div>
        <div class="v" id="stat-combo">0</div>
      </div>
      <div class="stat">
        <div class="k">MISS</div>
        <div class="v" id="stat-miss">0</div>
      </div>
    </div>

    <div class="hud-mid">
      <div class="pill">
        <span class="dot"></span>
        <span class="label">TIME</span>
        <span class="value" id="stat-time">0</span>
      </div>

      <div class="pill grade">
        <span class="label">GRADE</span>
        <span class="value" id="stat-grade">C</span>
      </div>

      <div class="pill storm">
        <span class="label">STORM</span>
        <span class="value" id="storm-left">0</span>
      </div>

      <div class="pill shield">
        <span class="label">üõ°Ô∏è</span>
        <span class="value" id="shield-count">0</span>
      </div>
    </div>

    <div class="hud-right" id="hudBtns">
      <a class="btn ghost btnBackHub" href="../hub.html" title="‡∏Å‡∏•‡∏±‡∏ö HUB">‚Üê HUB</a>
      <button class="btn ghost" id="btnForceEnd" title="‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (debug)">END</button>
    </div>
  </header>

  <!-- ===== QUEST PANEL ===== -->
  <section class="quest-panel" aria-live="polite">
    <div class="q-title">MISSION</div>
    <div class="q-lines">
      <div class="q" id="quest-line1">Stage 1/3</div>
      <div class="q" id="quest-line2">...</div>
      <div class="q" id="quest-line3">...</div>
      <div class="q sub" id="quest-line4">...</div>
    </div>
  </section>

  <!-- ===== WATER PANEL ===== -->
  <section class="water-panel">
    <div class="water-head">
      <div class="water-title">HYDRATION</div>
      <div class="water-meta">
        <span class="tag">ZONE:</span>
        <span class="zone" id="water-zone">GREEN</span>
        <span class="sep">‚Ä¢</span>
        <span class="tag">%</span>
        <span class="pct" id="water-pct">50</span>
      </div>
    </div>
    <div class="water-barWrap">
      <div class="water-bar" id="water-bar" style="width:50%"></div>
      <div class="water-midline"></div>
    </div>
    <div class="water-hint">‡∏¢‡∏¥‡∏á üíß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà GREEN ‚Ä¢ ‡πÄ‡∏à‡∏≠ üåÄ ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ LOW/HIGH + BLOCK ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢</div>
  </section>

  <!-- ===== PLAYFIELD ===== -->
  <main class="stage">
    <!-- normal view -->
    <div id="playfield" class="playfield" role="application" aria-label="Hydration playfield">
      <div id="hydration-layer" class="layer"></div>
    </div>

    <!-- cardboard stereo -->
    <div id="cbPlayfield" class="cbPlayfield" aria-label="Cardboard playfield">
      <div class="cbCol">
        <div id="hydration-layerL" class="layer"></div>
      </div>
      <div class="cbCol">
        <div id="hydration-layerR" class="layer"></div>
      </div>
    </div>

    <!-- subtle vignette -->
    <div class="vignette" aria-hidden="true"></div>
  </main>

  <!-- ===== START OVERLAY ===== -->
  <section id="startOverlay" class="overlay">
    <div class="overlay-card">
      <div class="brand">
        <div class="logo">üíß</div>
        <div class="title">
          <div class="h1">Hydration VR</div>
          <div class="h2">3-Stage Mission ‚Ä¢ Aim Assist (cVR) ‚Ä¢ Storm + Boss</div>
        </div>
      </div>

      <div class="modeRow">
        <div class="mode">
          <div class="k">VIEW</div>
          <div class="v" id="viewLabel">auto</div>
        </div>
        <div class="mode">
          <div class="k">DIFF</div>
          <div class="v" id="diffLabel">normal</div>
        </div>
        <div class="mode">
          <div class="k">TIME</div>
          <div class="v" id="timeLabel">70s</div>
        </div>
        <div class="mode">
          <div class="k">SEED</div>
          <div class="v mono" id="seedLabel">‚Äî</div>
        </div>
      </div>

      <div class="how">
        <div class="howTitle">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô (‡∏™‡∏±‡πâ‡∏ô ‡πÜ)</div>
        <ul>
          <li><b>Stage1</b>: ‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà <b>GREEN</b> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏∞‡∏™‡∏°)</li>
          <li><b>Storm Mini</b>: ‡∏û‡∏≠‡∏°‡∏µ‡∏û‡∏≤‡∏¢‡∏∏ üåÄ ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ <b>LOW/HIGH</b> + <b>BLOCK</b> ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢ (End Window)</li>
          <li><b>Boss</b>: ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏≤‡∏¢‡∏∏‡∏à‡∏∞‡∏°‡∏µ üå©Ô∏è ‡πÇ‡∏ú‡∏•‡πà‡∏ñ‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‚Äî ‡πÉ‡∏ä‡πâ üõ°Ô∏è BLOCK ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</li>
          <li class="muted">cVR: ‡∏¢‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ crosshair ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (tap-to-shoot)</li>
        </ul>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="btnStart">START</button>
        <a class="btn" id="btnBackHub2" href="../hub.html">BACK TO HUB</a>
      </div>

      <div class="small muted">
        Tip: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö Cardboard/cVR ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏° ENTER VR ‡∏ó‡∏±‡∏ö HUD ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>
    </div>
  </section>

  <!-- ===== RESULT SUMMARY ===== -->
  <section id="resultBackdrop" class="result-backdrop" hidden>
    <div class="result-card">
      <div class="result-head">
        <div class="badge">RESULT</div>
        <div class="result-title">Hydration VR Summary</div>
        <button class="x" id="btnCloseSummary" aria-label="Close">‚úï</button>
      </div>

      <div class="result-grid">
        <div class="kv">
          <div class="k">Score</div>
          <div class="v" id="rScore">0</div>
        </div>
        <div class="kv">
          <div class="k">Grade</div>
          <div class="v" id="rGrade">C</div>
        </div>
        <div class="kv">
          <div class="k">Accuracy</div>
          <div class="v" id="rAcc">0%</div>
        </div>
        <div class="kv">
          <div class="k">ComboMax</div>
          <div class="v" id="rComboMax">0</div>
        </div>

        <div class="kv">
          <div class="k">Miss</div>
          <div class="v" id="rMiss">0</div>
        </div>
        <div class="kv">
          <div class="k">Goals</div>
          <div class="v" id="rGoals">0/1</div>
        </div>
        <div class="kv">
          <div class="k">Minis</div>
          <div class="v" id="rMinis">0/0</div>
        </div>
        <div class="kv">
          <div class="k">GreenHold</div>
          <div class="v" id="rGreen">0.0s</div>
        </div>

        <div class="kv">
          <div class="k">StreakMax</div>
          <div class="v" id="rStreak">0</div>
        </div>
        <div class="kv">
          <div class="k">StormCycles</div>
          <div class="v" id="rStormCycles">0</div>
        </div>
        <div class="kv">
          <div class="k">StormOK</div>
          <div class="v" id="rStormOk">0</div>
        </div>
        <div class="kv">
          <div class="k">StormRate</div>
          <div class="v" id="rStormRate">0%</div>
        </div>

        <!-- RT / Tier / Perfect (optional fields; safe.js writes into HHA_LAST_SUMMARY) -->
        <div class="kv wide">
          <div class="k">Tips</div>
          <pre class="v pre" id="rTips">‚Äî</pre>
        </div>
        <div class="kv wide">
          <div class="k">Next</div>
          <div class="v" id="rNext">‚Äî</div>
        </div>
        <div class="kv wide">
          <div class="k">Tier</div>
          <div class="v" id="rTier">Tier: ‚Äî</div>
        </div>

        <details class="details wide" open>
          <summary>Research (RT / Perfect Bonus)</summary>
          <div class="miniGrid">
            <div class="miniKV">
              <div class="k">avgRtGoodMs</div><div class="v" id="rAvgRt">‚Äî</div>
            </div>
            <div class="miniKV">
              <div class="k">medianRtGoodMs</div><div class="v" id="rMedRt">‚Äî</div>
            </div>
            <div class="miniKV">
              <div class="k">Perfect End Hits</div><div class="v" id="rPEH">‚Äî</div>
            </div>
            <div class="miniKV">
              <div class="k">Perfect Boss Hits</div><div class="v" id="rPBH">‚Äî</div>
            </div>
            <div class="miniKV">
              <div class="k">End Bonus</div><div class="v" id="rPEB">‚Äî</div>
            </div>
            <div class="miniKV">
              <div class="k">Boss Bonus</div><div class="v" id="rPBB">‚Äî</div>
            </div>
          </div>
          <div class="muted small">* ‡∏Ñ‡πà‡∏≤ RT/Perfect ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ safe.js ‡πÉ‡∏™‡πà‡∏•‡∏á summary ‡πÅ‡∏•‡πâ‡∏ß</div>
        </details>
      </div>

      <div class="result-actions">
        <button class="btn primary" id="btnRetry">RETRY</button>
        <button class="btn" id="btnCopyJSON">COPY JSON</button>
        <button class="btn" id="btnDownloadCSV">DOWNLOAD CSV</button>
        <a class="btn ghost btnBackHub" href="../hub.html">‚Üê HUB</a>
      </div>
    </div>
  </section>

  <script>
  // --- light boot glue (safe.js emits/reads; this just starts overlay + labels) ---
  (function(){
    const q = new URLSearchParams(location.search);
    const view = (q.get('view')||'auto').toLowerCase();
    const diff = (q.get('diff')||'normal').toLowerCase();
    const time = q.get('time') || q.get('durationPlannedSec') || '70';
    const seed = q.get('seed') || q.get('sessionId') || q.get('ts') || '‚Äî';

    const $ = (id)=>document.getElementById(id);

    if ($('viewLabel')) $('viewLabel').textContent = view || 'auto';
    if ($('diffLabel')) $('diffLabel').textContent = diff;
    if ($('timeLabel')) $('timeLabel').textContent = String(time) + 's';
    if ($('seedLabel')) $('seedLabel').textContent = String(seed).slice(0,24);

    // hide/show playfield modes
    const cb = document.getElementById('cbPlayfield');
    const pf = document.getElementById('playfield');
    const isCardboard = document.body.classList.contains('cardboard');
    if (cb) cb.style.display = isCardboard ? 'grid' : 'none';
    if (pf) pf.style.display = isCardboard ? 'none' : 'block';

    // Start button
    const ov = $('startOverlay');
    const btn = $('btnStart');
    btn && btn.addEventListener('click', ()=>{
      if (ov) ov.classList.add('hide');
      window.dispatchEvent(new CustomEvent('hha:start'));
    });

    // Force end (debug)
    const endBtn = $('btnForceEnd');
    endBtn && endBtn.addEventListener('click', ()=>{
      window.dispatchEvent(new CustomEvent('hha:force_end', { detail:{ reason:'force' } }));
    });

    // When game ends, fill extra research fields from HHA_LAST_SUMMARY (optional)
    window.addEventListener('hha:end', (ev)=>{
      const sum = ev.detail || {};
      const set = (id,v)=>{ const el=$(id); if(el) el.textContent = String(v ?? '‚Äî'); };

      set('rAvgRt', sum.avgRtGoodMs);
      set('rMedRt', sum.medianRtGoodMs);

      set('rPEH', sum.perfectEndHits);
      set('rPBH', sum.perfectBossHits);
      set('rPEB', sum.perfectEndBonus);
      set('rPBB', sum.perfectBossBonus);
    });

    // Auto-start if ?autostart=1
    if ((q.get('autostart')||'') === '1'){
      setTimeout(()=>{ btn && btn.click(); }, 250);
    }
  })();
  </script>
</body>
</html>