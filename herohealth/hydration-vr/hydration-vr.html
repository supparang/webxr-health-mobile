<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./hydration-vr.css" />

  <!-- Global utilities -->
  <script defer src="../vr/particles.js"></script>
  <script defer src="../vr/hha-cloud-logger.js"></script>
  <script defer src="../vr/vr-ui.js"></script>

  <!-- Water gauge helper (optional, you already use setWaterGauge) -->
  <script defer src="../vr/ui-water.js"></script>

  <!-- AI coach -->
  <script defer src="../vr/ai-coach.js"></script>

  <!-- SAFE engine -->
  <script type="module" defer src="./hydration.safe.js"></script>

  <script>
    (function(){
      'use strict';
      const DOC=document;

      const qs=(k,def=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? def; }catch(_){ return def; } };

      function autoDetectView(){
        // if explicit view => use it
        const v = String(qs('view','')||'').toLowerCase();
        if (v) return v;

        // Cardboard heuristics
        const w = Math.min(window.innerWidth, window.innerHeight);
        const h = Math.max(window.innerWidth, window.innerHeight);

        // If very small width and tall: likely mobile portrait -> mobile
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent||'');
        if (!isMobile) return 'pc';

        // Default for mobile: mobile (user can choose ?view=cvr or ?view=cardboard)
        return 'mobile';
      }

      function setBodyView(view){
        const b = DOC.body;
        b.classList.remove('view-pc','view-mobile','view-cvr','cardboard');
        if (view === 'pc') b.classList.add('view-pc');
        else if (view === 'cvr') b.classList.add('view-cvr');
        else if (view === 'cardboard') b.classList.add('cardboard');
        else b.classList.add('view-mobile');

        // Cardboard uses split layers
        const isCB = b.classList.contains('cardboard');
        DOC.documentElement.classList.toggle('is-cardboard', isCB);
      }

      // expose layers to hydration.safe.js (it reads window.HHA_VIEW.layers)
      function setupLayers(){
        const b = DOC.body;
        const isCB = b.classList.contains('cardboard');

        // main
        const main = DOC.getElementById('hydration-layer');
        const L = DOC.getElementById('hydration-layerL');
        const R = DOC.getElementById('hydration-layerR');

        if (isCB){
          // show L/R, hide main
          if (main) main.style.display='none';
          if (L) L.style.display='block';
          if (R) R.style.display='block';
          window.HHA_VIEW = { layers: ['hydration-layerL','hydration-layerR'] };
        }else{
          if (main) main.style.display='block';
          if (L) L.style.display='none';
          if (R) R.style.display='none';
          window.HHA_VIEW = { layers: ['hydration-layer'] };
        }
      }

      function boot(){
        const view = autoDetectView();
        setBodyView(view);
        setupLayers();

        // Optional: set gameMode for logger context
        window.HHA_LOGGER_GAME = 'hydration';
      }

      if (DOC.readyState === 'loading') DOC.addEventListener('DOMContentLoaded', boot, {once:true});
      else boot();
    })();
  </script>
</head>

<body class="view-mobile">

  <!-- Start Overlay -->
  <div id="startOverlay" class="overlay">
    <div class="overlay-card">
      <div class="title">Hydration Quest</div>
      <div class="subtitle">
        ‡∏¢‡∏¥‡∏á üíß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏° ‚Äú‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‚Äù ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô <b>GREEN</b><br/>
        ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡∏ó‡∏≥ Mini: <b>LOW/HIGH + BLOCK üõ°Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢</b>
      </div>

      <div class="hintline">
        <span class="pill">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Ñ‡∏∏‡∏° GREEN + ‡∏ú‡πà‡∏≤‡∏ô Storm Mini + ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå BOSS</span>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <a class="btn ghost" id="btnBackHub" href="../hub.html">‡∏Å‡∏•‡∏±‡∏ö HUB</a>
      </div>

      <div class="fineprint">
        ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢: ‡πÉ‡∏™‡πà <code>&run=research&seed=...</code> ‚Ä¢ Kids: <code>&kids=1</code> ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: <code>&time=70</code>
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-row top">
      <div class="stat">Score <b id="stat-score">0</b></div>
      <div class="stat">Combo <b id="stat-combo">0</b></div>
      <div class="stat">Miss <b id="stat-miss">0</b></div>
      <div class="stat">Time <b id="stat-time">0</b></div>
      <div class="stat grade">Grade <b id="stat-grade">C</b></div>
    </div>

    <div class="hud-row mid">
      <div class="panel quest">
        <div class="qline" id="quest-line1">Stage 1/3: ...</div>
        <div class="qline" id="quest-line2"></div>
        <div class="qline" id="quest-line3"></div>
        <div class="qline" id="quest-line4"></div>
      </div>

      <div class="panel water">
        <div class="water-title">Water</div>
        <div class="waterbar">
          <div class="fill" id="water-bar" style="width:50%"></div>
        </div>
        <div class="watermeta">
          <span><b id="water-pct">50</b>%</span>
          <span>Zone: <b id="water-zone">GREEN</b></span>
        </div>
      </div>

      <div class="panel mini">
        <div class="mini-title">Storm</div>
        <div class="mini-meta">Left: <b id="storm-left">0</b>s</div>
        <div class="mini-meta">Shield: <b id="shield-count">0</b></div>
      </div>
    </div>
  </div>

  <!-- Playfields -->
  <div id="playfield" class="playfield">
    <div id="hydration-layer" class="layer"></div>
  </div>

  <!-- Cardboard split playfield -->
  <div id="cbPlayfield" class="cbPlayfield">
    <div class="cbCol"><div id="hydration-layerL" class="layer"></div></div>
    <div class="cbCol"><div id="hydration-layerR" class="layer"></div></div>
  </div>

  <!-- Result Summary -->
  <div id="resultBackdrop" class="resultBackdrop" hidden>
    <div class="resultCard">
      <div class="resultTitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>

      <div class="resultGrid">
        <div class="rItem">Score <b id="rScore">0</b></div>
        <div class="rItem">Grade <b id="rGrade">C</b></div>
        <div class="rItem">Accuracy <b id="rAcc">0%</b></div>
        <div class="rItem">ComboMax <b id="rComboMax">0</b></div>
        <div class="rItem">Miss <b id="rMiss">0</b></div>
        <div class="rItem">Goals <b id="rGoals">0/0</b></div>
        <div class="rItem">Minis <b id="rMinis">0/0</b></div>
        <div class="rItem">GREEN <b id="rGreen">0s</b></div>
        <div class="rItem">Streak <b id="rStreak">0</b></div>
        <div class="rItem">Storm <b id="rStormCycles">0</b></div>
        <div class="rItem">Pass <b id="rStormOk">0</b></div>
        <div class="rItem">Rate <b id="rStormRate">0%</b></div>
      </div>

      <div class="resultTier" id="rTier">Tier: Beginner</div>
      <pre class="resultTips" id="rTips"></pre>
      <div class="resultNext">Next: <b id="rNext"></b></div>

      <div class="resultActions">
        <button id="btnRetry" class="btn primary">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnCopyJSON" class="btn ghost">Copy JSON</button>
        <button id="btnDownloadCSV" class="btn ghost">Download CSV</button>
        <button class="btn ghost btnBackHub">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button id="btnCloseSummary" class="btn danger">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

</body>
</html>