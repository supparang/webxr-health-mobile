<!-- === /herohealth/hydration-vr/hydration-vr.html ===
Hydration VR RUN ‚Äî PRODUCTION
‚úÖ PC / Mobile / Cardboard + cVR (via loader/body classes)
‚úÖ Includes: particles + hha-cloud-logger + vr-ui (crosshair shoot)
‚úÖ Wires: start overlay -> emits hha:start
‚úÖ Provides required DOM ids for hydration.safe.js (HUD/Quest/Result)
-->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- A-Frame only for Enter VR reliability (optional; OK to keep) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./hydration-vr.css" />

  <!-- Global FX + Logger + Universal VR UI -->
  <script src="../vr/particles.js" defer></script>
  <script src="../vr/hha-cloud-logger.js" defer></script>
  <script src="../vr/vr-ui.js" defer></script>

  <style>
    /* minimal fallbacks if css missing some bits */
    body{ margin:0; height:100%; overflow:hidden; background:#020617; }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    .hud{ position:fixed; inset:0; pointer-events:none; z-index:30; }
    .hud .panel{ pointer-events:auto; }
    .playwrap{ position:fixed; inset:0; z-index:10; }
    #playfield, #cbPlayfield{ position:absolute; inset:0; overflow:hidden; }
    .layer{ position:absolute; inset:0; pointer-events:none; }
    .layer .hvr-target{ pointer-events:auto; }
    .safeTap{ position:fixed; inset:0; z-index:5; }

    /* END FX hooks from safe.js */
    body.hha-endfx #playfield,
    body.hha-endfx #cbPlayfield{
      animation: hhaEndPulse .18s linear infinite;
      filter: saturate(1.15);
    }
    body.hha-bossfx #playfield,
    body.hha-bossfx #cbPlayfield{
      filter: saturate(1.25) contrast(1.05);
    }
    @keyframes hhaEndPulse{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(0.7px,0); }
      50%{ transform: translate(0,0.7px); }
      75%{ transform: translate(-0.7px,0); }
      100%{ transform: translate(0,0); }
    }

    /* shock element injected by safe.js */
    .hha-shock{
      position:absolute;
      left: var(--x,50%);
      top: var(--y,50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      border: 2px solid rgba(239,68,68,.55);
      box-shadow: 0 0 0 rgba(239,68,68,.0);
      animation: shock .5s ease-out forwards;
      pointer-events:none;
    }
    @keyframes shock{
      0%{ opacity:.9; transform:translate(-50%,-50%) scale(0.6); box-shadow:0 0 0 rgba(239,68,68,.0); }
      70%{ opacity:.55; transform:translate(-50%,-50%) scale(6); box-shadow:0 0 42px rgba(239,68,68,.18); }
      100%{ opacity:0; transform:translate(-50%,-50%) scale(8); box-shadow:0 0 60px rgba(239,68,68,.0); }
    }

    /* Result overlay basic */
    #resultBackdrop{
      position:fixed; inset:0; z-index:60;
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    #resultCard{
      width:min(980px, 100%);
      border-radius: 22px;
      background: rgba(2,6,23,.88);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: 0 24px 90px rgba(0,0,0,.55);
      color:#e5e7eb;
      overflow:hidden;
    }
    #resultCard header{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(148,163,184,.14);
      background: linear-gradient(90deg, rgba(34,211,238,.10), rgba(168,85,247,.10));
    }
    #resultCard .content{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      #resultCard .content{ grid-template-columns: 1fr; }
    }
    .rbox{
      border:1px solid rgba(148,163,184,.14);
      border-radius:18px;
      padding:12px;
      background: rgba(15,23,42,.55);
    }
    .row{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(148,163,184,.10); }
    .row:last-child{ border-bottom:none; }
    .k{ color:#94a3b8; }
    .v{ font-weight:800; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px; border-top:1px solid rgba(148,163,184,.14); }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.70);
      color:#e5e7eb;
      border-radius: 999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
  </style>
</head>

<body class="hha hydration">
  <!-- tap catcher helps mobile (no blocking targets because targets pointer-events:auto) -->
  <div class="safeTap" aria-hidden="true"></div>

  <!-- PLAY AREA -->
  <div class="playwrap">
    <!-- Normal playfield -->
    <div id="playfield">
      <div id="hydration-layer" class="layer" aria-hidden="false"></div>
    </div>

    <!-- Cardboard playfield (loader can toggle display and set body classes) -->
    <div id="cbPlayfield" style="display:none;">
      <div id="hydration-layerL" class="layer"></div>
      <div id="hydration-layerR" class="layer"></div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud" aria-hidden="false">
    <!-- Top Stats -->
    <div class="panel" style="position:fixed; left:12px; right:12px; top:calc(10px + env(safe-area-inset-top,0px)); display:flex; gap:10px; align-items:stretch;">
      <div style="flex:1; border-radius:18px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.70); padding:10px 12px;">
        <div style="display:flex; justify-content:space-between; gap:10px; font-weight:900;">
          <div>Score <span id="stat-score" class="v">0</span></div>
          <div>Combo <span id="stat-combo" class="v">0</span></div>
          <div>Miss <span id="stat-miss" class="v">0</span></div>
          <div>Time <span id="stat-time" class="v">0</span></div>
          <div>Grade <span id="stat-grade" class="v">C</span></div>
        </div>
        <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
          <div style="font-weight:900;">Water</div>
          <div style="flex:1; height:10px; border-radius:999px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.60); overflow:hidden;">
            <div id="water-bar" style="width:50%; height:100%; background:rgba(34,197,94,.55);"></div>
          </div>
          <div style="min-width:84px; text-align:right; font-weight:900;">
            <span id="water-pct">50</span>% <span id="water-zone">GREEN</span>
          </div>
        </div>
      </div>

      <div style="width:260px; border-radius:18px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.70); padding:10px 12px;">
        <div style="display:flex; justify-content:space-between; font-weight:900;">
          <div>Storm <span id="storm-left">0</span>s</div>
          <div>Shield <span id="shield-count">0</span></div>
        </div>
        <div style="margin-top:8px; color:#94a3b8; font-size:13px; font-weight:700;">
          cVR: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤ + Aim Assist
        </div>
      </div>
    </div>

    <!-- Quest Panel -->
    <div class="panel" style="position:fixed; left:12px; right:12px; top:calc(92px + env(safe-area-inset-top,0px)); border-radius:18px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.66); padding:10px 12px;">
      <div id="quest-line1" style="font-weight:900;">Stage 1/3: ‚Ä¶</div>
      <div id="quest-line2" style="margin-top:4px; font-weight:800; color:#e5e7eb;">‚Ä¶</div>
      <div id="quest-line3" style="margin-top:4px; font-weight:700; color:#94a3b8;">‚Ä¶</div>
      <div id="quest-line4" style="margin-top:2px; font-weight:700; color:#94a3b8;">‚Ä¶</div>
    </div>

    <!-- Bottom actions -->
    <div class="panel" style="position:fixed; left:12px; right:12px; bottom:calc(10px + env(safe-area-inset-bottom,0px)); display:flex; gap:10px; align-items:center; justify-content:space-between;">
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btnBackHub" type="button">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button id="btnForceEnd" class="btn warn" type="button">‚õî ‡∏à‡∏ö‡πÄ‡∏Å‡∏° (Force)</button>
      </div>
      <div style="color:#94a3b8; font-weight:800; font-size:12px;">
        üíß ‡∏¢‡∏¥‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏µ ‚Ä¢ ü•§‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô(‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢) ‚Ä¢ üõ°Ô∏è‡πÇ‡∏•‡πà‡∏Å‡∏±‡∏ô
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div id="startOverlay" style="position:fixed; inset:0; z-index:50; background:rgba(2,6,23,.86); display:flex; align-items:center; justify-content:center; padding:16px;">
    <div style="width:min(720px,100%); border-radius:22px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.70); padding:16px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:1000; font-size:20px;">Hydration Quest VR</div>
        <button class="btn btnBackHub" type="button">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
      <div style="margin-top:10px; color:#e5e7eb; font-weight:800; line-height:1.4;">
        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ã‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÅ‡∏•‡∏∞‡∏ú‡πà‡∏≤‡∏ô Storm Mini + Boss
      </div>
      <div style="margin-top:8px; color:#94a3b8; font-weight:700; line-height:1.45;">
        ‚Ä¢ PC/Mobile: ‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢<br/>
        ‚Ä¢ VR Cardboard/cVR: ‡πÉ‡∏ä‡πâ crosshair ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏¢‡∏¥‡∏á‚Äù (vr-ui.js ‡∏à‡∏∞‡∏™‡πà‡∏á hha:shoot)<br/>
        ‚Ä¢ Research: ‡πÉ‡∏ä‡πâ seed ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
      </div>

      <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
        <button id="btnStart" class="btn primary" type="button">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button id="btnHow" class="btn" type="button">‚ùì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
      </div>

      <div id="howBox" style="margin-top:12px; display:none; border-radius:18px; border:1px solid rgba(148,163,184,.14); background:rgba(15,23,42,.55); padding:12px;">
        <div style="font-weight:900;">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô (‡∏™‡∏±‡πâ‡∏ô ‡πÜ)</div>
        <div style="margin-top:6px; color:#94a3b8; font-weight:700; line-height:1.45;">
          1) ‡∏¢‡∏¥‡∏á üíß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà GREEN ‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô ‡πÜ<br/>
          2) ‡πÄ‡∏Å‡πá‡∏ö üõ°Ô∏è ‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô STORM ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á BLOCK ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞<br/>
          3) ‡∏ï‡∏≠‡∏ô Boss Window ‡πÉ‡∏´‡πâ BLOCK üå©Ô∏è ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        </div>
      </div>
    </div>
  </div>

  <!-- Result Summary -->
  <div id="resultBackdrop" hidden>
    <div id="resultCard" role="dialog" aria-modal="true">
      <header>
        <div style="font-weight:1000;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>
        <button id="btnCloseSummary" class="btn" type="button">‚úï ‡∏õ‡∏¥‡∏î</button>
      </header>

      <div class="content">
        <div class="rbox">
          <div style="font-weight:900; margin-bottom:8px;">‡∏ú‡∏•‡∏£‡∏ß‡∏°</div>
          <div class="row"><div class="k">Score</div><div class="v" id="rScore">0</div></div>
          <div class="row"><div class="k">Grade</div><div class="v" id="rGrade">C</div></div>
          <div class="row"><div class="k">Accuracy</div><div class="v" id="rAcc">0%</div></div>
          <div class="row"><div class="k">Combo Max</div><div class="v" id="rComboMax">0</div></div>
          <div class="row"><div class="k">Miss</div><div class="v" id="rMiss">0</div></div>
          <div class="row"><div class="k">Goals</div><div class="v" id="rGoals">0/0</div></div>
          <div class="row"><div class="k">Minis</div><div class="v" id="rMinis">0/0</div></div>
          <div class="row"><div class="k">Tier</div><div class="v" id="rTier">Tier: Beginner</div></div>
        </div>

        <div class="rbox">
          <div style="font-weight:900; margin-bottom:8px;">‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</div>
          <div class="row"><div class="k">Green Hold</div><div class="v" id="rGreen">0.0s</div></div>
          <div class="row"><div class="k">Streak Max</div><div class="v" id="rStreak">0</div></div>
          <div class="row"><div class="k">Storm Cycles</div><div class="v" id="rStormCycles">0</div></div>
          <div class="row"><div class="k">Storm OK</div><div class="v" id="rStormOk">0</div></div>
          <div class="row"><div class="k">Storm Rate</div><div class="v" id="rStormRate">0%</div></div>
          <div style="margin-top:10px; white-space:pre-line; color:#e5e7eb; font-weight:800;" id="rTips"></div>
          <div style="margin-top:10px; color:#94a3b8; font-weight:900;">Next:</div>
          <div style="color:#e5e7eb; font-weight:900;" id="rNext"></div>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnRetry" class="btn primary" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btnBackHub" type="button">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button id="btnCopyJSON" class="btn" type="button">üìã Copy JSON</button>
        <button id="btnDownloadCSV" class="btn" type="button">‚¨á Download CSV</button>
      </div>
    </div>
  </div>

  <!-- Boot logic (start overlay + hub + force end) -->
  <script type="module">
    const qs = (k, def=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? def; }catch(_){ return def; } };
    const hub = String(qs('hub','../hub.html'));

    // Back hub buttons
    document.querySelectorAll('.btnBackHub').forEach(btn=>{
      btn.addEventListener('click', ()=>{ location.href = hub; });
    });

    // Start overlay
    const ov = document.getElementById('startOverlay');
    const howBox = document.getElementById('howBox');
    document.getElementById('btnHow')?.addEventListener('click', ()=>{
      howBox.style.display = (howBox.style.display==='none' || !howBox.style.display) ? 'block' : 'none';
    });

    document.getElementById('btnStart')?.addEventListener('click', ()=>{
      try{ ov.style.display='none'; }catch(_){}
      window.dispatchEvent(new CustomEvent('hha:start'));
    });

    // Force end (optional)
    document.getElementById('btnForceEnd')?.addEventListener('click', ()=>{
      window.dispatchEvent(new CustomEvent('hha:force_end', { detail:{ reason:'force_end_ui' } }));
    });

    // Cardboard switch (loader may manage; this is a safe fallback)
    const view = String(qs('view','')||'').toLowerCase();
    const isCardboard = (view==='cardboard' || view==='vr' || view==='cvr');
    if (isCardboard){
      document.getElementById('cbPlayfield').style.display='block';
      document.getElementById('playfield').style.display='none';
    }
  </script>

  <!-- GAME ENGINE -->
  <script type="module" src="./hydration.safe.js"></script>
</body>
</html>