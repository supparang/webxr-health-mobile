<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" />

  <link rel="stylesheet" href="./hydration-vr.css" />

  <!-- Universal VR UI (Enter VR/Exit/Recenter + crosshair + tap-to-shoot -> hha:shoot) -->
  <script src="../vr/vr-ui.js"></script>

  <!-- Folder loader: set view classes + ensure playfield/layers + import hydration.safe.js -->
  <script src="./hydration-vr.loader.js"></script>
</head>
<body class="view-pc">

  <!-- ===== GAME PLAYFIELD (MUST EXIST) ===== -->
  <div id="playfield" aria-label="playfield">
    <div id="hydration-layer" aria-label="hydration-layer"></div>
  </div>

  <!-- ===== CARDBOARD PLAYFIELD (optional; loader also hardens this) ===== -->
  <div id="cbPlayfield" aria-label="cbPlayfield" hidden>
    <div class="cbHalf left"><div id="hydration-layerL"></div></div>
    <div class="cbHalf right"><div id="hydration-layerR"></div></div>
  </div>

  <!-- ===== HUD (non-blocking) ===== -->
  <div id="hudRoot" class="hud-root" aria-label="hud">
    <!-- Top Stats -->
    <div id="hudTop" class="hud-top hha-card" aria-label="stats">
      <div class="stat-pill"><div class="label">SCORE</div><div class="val" id="stat-score">0</div></div>
      <div class="stat-pill"><div class="label">COMBO</div><div class="val" id="stat-combo">0</div></div>
      <div class="stat-pill"><div class="label">MISS</div><div class="val" id="stat-miss">0</div></div>
      <div class="stat-pill"><div class="label">TIME</div><div class="val" id="stat-time">0</div></div>
      <div class="stat-pill grade"><div class="label">GRADE</div><div class="val" id="stat-grade">C</div></div>
    </div>

    <!-- Bottom Quest + Water -->
    <div id="hudBottom" class="hud-bottom">
      <section id="questPanel" class="hha-card quest-panel" aria-label="quest">
        <div class="title">
          <span>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</span>
          <button id="btnQuestToggle" type="button">‚ñæ</button>
        </div>
        <div id="questLines" class="quest-lines">
          <div id="quest-line1">‚Äî</div>
          <div id="quest-line2" class="muted">‚Äî</div>
          <div id="quest-line3" class="muted">‚Äî</div>
          <div id="quest-line4" class="muted">‚Äî</div>
        </div>
      </section>

      <section id="waterPanel" class="hha-card water-panel" aria-label="water">
        <div class="waterRow">
          <div class="t">üíß Water</div>
          <div class="p"><span id="water-pct">50</span>%</div>
        </div>
        <div class="waterRow2">
          <div class="z">ZONE: <span id="water-zone">GREEN</span></div>
          <div class="storm">üåÄ STORM <span id="storm-left">0</span>s</div>
        </div>
        <div class="barWrap"><div id="water-bar" class="bar"></div></div>
        <div class="shield">üõ°Ô∏è <span id="shield-count">0</span></div>
      </section>
    </div>
  </div>

  <!-- ===== START OVERLAY ===== -->
  <div id="startOverlay" class="start-overlay" role="dialog" aria-label="start overlay">
    <div class="start-card">
      <div class="start-title">üíß Hydration Quest</div>
      <div class="start-sub">
        ‡∏¢‡∏¥‡∏á üíß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà GREEN<br/>
        ‡πÄ‡∏à‡∏≠ STORM ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥ Mini + BLOCK ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢
      </div>

      <div class="start-row">
        <button id="btnStart" class="btn primary" type="button">START</button>
        <button id="btnBackHub" class="btn" type="button">HUB</button>
      </div>

      <div class="start-tip">
        PC: ‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á ‚Ä¢ Mobile/cVR: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (crosshair) ‚Ä¢ VR: ‡πÉ‡∏ä‡πâ ENTER VR
      </div>
    </div>
  </div>

  <!-- ===== RESULT BACKDROP (hydration.safe.js will fill ids) ===== -->
  <div id="resultBackdrop" class="result-backdrop" hidden>
    <div class="result-card">
      <div class="result-head">
        <div class="ttl">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <button class="btn" id="btnCloseSummary" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="grid">
        <div class="box"><div class="k">Score</div><div class="v" id="rScore">0</div></div>
        <div class="box"><div class="k">Grade</div><div class="v" id="rGrade">C</div></div>
        <div class="box"><div class="k">Acc</div><div class="v" id="rAcc">0%</div></div>
        <div class="box"><div class="k">ComboMax</div><div class="v" id="rComboMax">0</div></div>
        <div class="box"><div class="k">Miss</div><div class="v" id="rMiss">0</div></div>
        <div class="box"><div class="k">Goals</div><div class="v" id="rGoals">0/1</div></div>
        <div class="box"><div class="k">Minis</div><div class="v" id="rMinis">0/0</div></div>
        <div class="box"><div class="k">Tier</div><div class="v" id="rTier">‚Äî</div></div>
      </div>

      <div class="box big">
        <div class="k">Tips</div>
        <pre class="tips" id="rTips">‚Äî</pre>
        <div class="next">Next: <span id="rNext">‚Äî</span></div>
      </div>

      <div class="result-row">
        <button class="btn primary" id="btnRetry" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn" id="btnCopyJSON" type="button">Copy JSON</button>
        <button class="btn" id="btnDownloadCSV" type="button">Download CSV</button>
        <button class="btn btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>
    </div>
  </div>

  <!-- ===== page wiring (MUST) ===== -->
  <script>
    (function(){
      'use strict';
      const qs = (k,d=null)=>{ try{ return new URL(location.href).searchParams.get(k) ?? d; }catch(_){ return d; } };
      const hub = String(qs('hub','../hub.html'));

      // HUD collapse toggle (mobile)
      const btnT = document.getElementById('btnQuestToggle');
      btnT?.addEventListener('click', ()=>{
        document.body.classList.toggle('hud-collapsed');
        btnT.textContent = document.body.classList.contains('hud-collapsed') ? '‚ñ∏' : '‚ñæ';
      });

      // Start overlay -> dispatch hha:start
      const ov = document.getElementById('startOverlay');
      const btnStart = document.getElementById('btnStart');
      const btnHub = document.getElementById('btnBackHub');

      function startGame(){
        try{ ov?.classList.add('hide'); }catch(_){}
        setTimeout(()=>{ try{ ov && (ov.style.display='none'); }catch(_){ } }, 240);
        try{ window.dispatchEvent(new CustomEvent('hha:start')); }catch(_){}
      }

      btnStart?.addEventListener('click', startGame);
      btnHub?.addEventListener('click', ()=> location.href = hub);

      // click-to-start fallback (mobile convenience)
      window.addEventListener('pointerdown', (ev)=>{
        if (!ov) return;
        if (ov.classList.contains('hide')) return;
        // don't auto-start when tapping buttons
        const t = ev.target;
        if (t && (t.id==='btnStart' || t.id==='btnBackHub' || t.closest && t.closest('button'))) return;
        // allow first tap anywhere to start
        startGame();
      }, {passive:true});

      // back-to-hub buttons (summary)
      document.querySelectorAll('.btnBackHub').forEach(b=>{
        b.addEventListener('click', ()=> location.href = hub);
      });
    })();
  </script>
</body>
</html>