<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Hydration Quest VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <link rel="stylesheet" href="./hydration-vr.css" />

  <!-- Global (non-module) -->
  <script defer src="../vr/particles.js"></script>
  <script defer src="../vr/hha-cloud-logger.js"></script>
  <script defer src="../vr/vr-ui.js"></script>
  <script defer src="../vr/ui-water.js"></script>
  <script defer src="../vr/ai-coach.js"></script>

  <!-- SAFE ENGINE (module because it imports) -->
  <script type="module" defer src="./hydration.safe.js"></script>

  <script>
    // Minimal, non-overriding view classes:
    // - If user/loader sets body class already: keep it
    // - Else: default to mobile-friendly
    (function(){
      const b=document.body;
      if(!b) return;
      const has = (c)=>b.classList.contains(c);
      if(has('view-pc')||has('view-mobile')||has('view-cvr')||has('cardboard')) return;
      // default
      b.classList.add('view-mobile');
    })();
  </script>
</head>

<body class="view-mobile">
  <!-- Playfield (PC/Mobile/cVR) -->
  <main id="playfield" class="playfield" aria-label="Hydration playfield">
    <div id="hydration-layer" class="layer"></div>
  </main>

  <!-- Cardboard playfield (L/R) - shown only when body.cardboard -->
  <main id="cbPlayfield" class="cb-playfield" aria-label="Hydration cardboard playfield">
    <div class="cb-eye cb-left"><div id="hydration-layerL" class="layer"></div></div>
    <div class="cb-eye cb-right"><div id="hydration-layerR" class="layer"></div></div>
  </main>

  <!-- START OVERLAY -->
  <section id="startOverlay" class="overlay">
    <div class="panel">
      <div class="brand">
        <div class="logo">üíß</div>
        <div>
          <div class="title">Hydration Quest</div>
          <div class="subtitle">‡∏¢‡∏¥‡∏á üíß ‡∏Ñ‡∏∏‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏• ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏¢‡∏∏ ‚Ä¢ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏≠‡∏™</div>
        </div>
      </div>

      <div class="hint">
        <div class="chip">PC: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏¥‡∏á</div>
        <div class="chip">Mobile: ‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á</div>
        <div class="chip">cVR: ‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠</div>
        <div class="chip">Cardboard: ENTER VR ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô</div>
      </div>

      <div class="row">
        <button id="btnStart" class="btn btnPrimary" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <button class="btn btnGhost btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="small">
        * ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢: ‡πÉ‡∏™‡πà <code>&run=research</code> ‡πÅ‡∏•‡∏∞ <code>&seed=...</code> (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ deterministic)
      </div>
    </div>
  </section>

  <!-- HUD -->
  <aside class="hud" aria-label="HUD">
    <div class="hudTop">
      <div class="statCard">
        <div class="statRow">
          <div class="stat">
            <div class="k">SCORE</div>
            <div class="v" id="stat-score">0</div>
          </div>
          <div class="stat">
            <div class="k">COMBO</div>
            <div class="v" id="stat-combo">0</div>
          </div>
          <div class="stat">
            <div class="k">MISS</div>
            <div class="v" id="stat-miss">0</div>
          </div>
          <div class="stat">
            <div class="k">TIME</div>
            <div class="v"><span id="stat-time">0</span>s</div>
          </div>
          <div class="stat">
            <div class="k">GRADE</div>
            <div class="v" id="stat-grade">C</div>
          </div>
        </div>

        <div class="subRow">
          <div class="mini">
            <span class="tag">STORM</span>
            <b id="storm-left">0</b>s
          </div>
          <div class="mini">
            <span class="tag">SHIELD</span>
            <b id="shield-count">0</b>
          </div>
        </div>
      </div>

      <!-- Water panel (engine updates these ids) -->
      <div class="waterCard">
        <div class="waterHead">
          <div class="waterTitle">Water</div>
          <div class="waterMeta"><b id="water-pct">50</b>% ‚Ä¢ <span id="water-zone">GREEN</span></div>
        </div>
        <div class="waterBar">
          <div id="water-bar" class="waterFill" style="width:50%"></div>
        </div>
      </div>
    </div>

    <!-- Quest panel -->
    <div class="questCard">
      <div class="questTitle">Mission</div>
      <div class="questLines">
        <div id="quest-line1" class="q1">Stage 1/3‚Ä¶</div>
        <div id="quest-line2" class="q2">‚Ä¶</div>
        <div id="quest-line3" class="q3">‚Ä¶</div>
        <div id="quest-line4" class="q4">‚Ä¶</div>
      </div>
    </div>
  </aside>

  <!-- RESULTS / SUMMARY -->
  <section id="resultBackdrop" class="resultBackdrop" hidden>
    <div class="resultPanel">
      <div class="resultTop">
        <div class="resultTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div class="resultTier" id="rTier">Tier: -</div>
      </div>

      <div class="grid">
        <div class="cell"><div class="k">Score</div><div class="v" id="rScore">0</div></div>
        <div class="cell"><div class="k">Grade</div><div class="v" id="rGrade">C</div></div>
        <div class="cell"><div class="k">Accuracy</div><div class="v" id="rAcc">0%</div></div>
        <div class="cell"><div class="k">Combo Max</div><div class="v" id="rComboMax">0</div></div>

        <div class="cell"><div class="k">Miss</div><div class="v" id="rMiss">0</div></div>
        <div class="cell"><div class="k">Goals</div><div class="v" id="rGoals">0/0</div></div>
        <div class="cell"><div class="k">Mini</div><div class="v" id="rMinis">0/0</div></div>
        <div class="cell"><div class="k">GREEN Hold</div><div class="v" id="rGreen">0.0s</div></div>

        <div class="cell"><div class="k">Streak Max</div><div class="v" id="rStreak">0</div></div>
        <div class="cell"><div class="k">Storm Cycles</div><div class="v" id="rStormCycles">0</div></div>
        <div class="cell"><div class="k">Storm OK</div><div class="v" id="rStormOk">0</div></div>
        <div class="cell"><div class="k">Storm Rate</div><div class="v" id="rStormRate">0%</div></div>
      </div>

      <div class="tips">
        <div class="k">Tips</div>
        <pre id="rTips" class="pre">-</pre>
      </div>

      <div class="next">
        <div class="k">Next</div>
        <div id="rNext" class="v">-</div>
      </div>

      <div class="btnRow">
        <button id="btnRetry" class="btn btnPrimary" type="button">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="btn btnGhost btnBackHub" type="button">‡∏Å‡∏•‡∏±‡∏ö HUB</button>
        <button id="btnCopyJSON" class="btn btnSoft" type="button">Copy JSON</button>
        <button id="btnDownloadCSV" class="btn btnSoft" type="button">Download CSV</button>
        <button id="btnCloseSummary" class="btn btnGhost" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </section>

  <script>
    // start + back hub wiring (safe.js listens for hha:start)
    (function(){
      const qs=(k,d=null)=>{ try{return new URL(location.href).searchParams.get(k)??d;}catch(_){return d;} };
      const hub = String(qs('hub','../hub.html')||'../hub.html');
      document.querySelectorAll('.btnBackHub').forEach(b=>{
        b.addEventListener('click', ()=> location.href = hub);
      });

      const ov = document.getElementById('startOverlay');
      const btn = document.getElementById('btnStart');
      btn?.addEventListener('click', ()=>{
        if (ov) ov.classList.add('hide');
        window.dispatchEvent(new CustomEvent('hha:start'));
      });

      // If overlay hidden by CSS/layout, still start
      setTimeout(()=>{
        const hidden = !ov || getComputedStyle(ov).display==='none' || ov.classList.contains('hide');
        if (hidden) window.dispatchEvent(new CustomEvent('hha:start'));
      }, 800);
    })();
  </script>
</body>
</html>