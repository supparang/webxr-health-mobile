<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame core (‡πÉ‡∏ä‡πâ scene ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ mode-factory ‡πÉ‡∏ä‡πâ) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Particle FX (global: window.Particles / window.GAME_MODULES.Particles) -->
  <script src="./vr/particles.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --panel-soft2:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --accent-alt:#38bdf8;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --danger:#fb7185;
      --radius-lg:18px;
      --radius-pill:999px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      min-height:100vh;
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Thonburi",sans-serif;
      background:#020617;
      color:var(--text-main);
      overflow:hidden;
    }
    .app{
      position:relative;
      width:100vw;
      height:100vh;
      overflow:hidden;
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
    }

    /* ======= A-Frame Scene ======= */
    #scene-wrap{
      position:absolute;
      inset:0;
      z-index:1;
    }
    a-scene{
      width:100%;
      height:100%;
    }

    /* ======= HUD ======= */
    #hud{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:400;
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }

    .hud-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .hud-left{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .hud-title{
      font-size:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .hud-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 10px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
    }
    .hud-pill span.label{
      color:var(--text-soft);
    }

    .hud-info-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .hud-badge{
      font-size:11px;
      padding:3px 10px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.35);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .hud-badge strong{
      font-weight:600;
      color:var(--accent);
    }
    .hud-badge span.value{
      font-variant-numeric:tabular-nums;
    }

    .hud-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }

    .hud-timer{
      font-size:13px;
      padding:4px 12px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(148,163,184,0.6);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .hud-timer span.icon{font-size:14px;}
    .hud-timer span.value{
      font-variant-numeric:tabular-nums;
      font-weight:600;
      color:#fee2e2;
    }

    .hud-groups{
      font-size:11px;
      padding:4px 10px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.35);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .hud-groups span strong{
      font-weight:600;
      color:var(--accent-alt);
      font-variant-numeric:tabular-nums;
    }

    /* ======= Quest Panel ======= */
    #quest-panel{
      position:absolute;
      right:10px;
      top:72px;
      width:240px;
      max-width:55vw;
      z-index:410;
      pointer-events:none;
    }
    .quest-card{
      background:rgba(15,23,42,0.96);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 18px 40px rgba(0,0,0,0.8);
      padding:10px 12px;
      font-size:11px;
    }
    .quest-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .quest-header span.title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--text-soft);
    }
    .quest-header span.icon{
      font-size:14px;
    }
    .quest-section{
      margin-bottom:6px;
    }
    .quest-label{
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:2px;
    }
    .quest-text{
      font-size:11px;
      line-height:1.4;
    }
    .quest-hint{
      font-size:10px;
      color:var(--accent-alt);
      margin-top:4px;
    }

    /* ======= Coach Bubble ======= */
    #coach-wrap{
      position:absolute;
      left:0;
      right:0;
      bottom:12px;
      z-index:420;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    .coach-bubble{
      max-width:420px;
      padding:8px 11px;
      border-radius:16px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 18px 40px rgba(0,0,0,0.85);
      font-size:12px;
      display:flex;
      align-items:flex-start;
      gap:8px;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .25s ease, transform .25s ease;
    }
    .coach-bubble.show{
      opacity:1;
      transform:translateY(0);
    }
    .coach-avatar{
      font-size:20px;
    }
    .coach-text{
      line-height:1.4;
    }

    /* ======= Summary Overlay ======= */
    #summary{
      position:absolute;
      inset:0;
      z-index:500;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transition:opacity .25s ease;
    }
    #summary.visible{
      opacity:1;
      pointer-events:auto;
    }
    .summary-card{
      width: min(420px, 90vw);
      background:radial-gradient(circle at top, rgba(34,197,94,0.1) 0, #020617 45%, #000 100%);
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.75);
      box-shadow:0 28px 60px rgba(0,0,0,0.9);
      padding:14px 16px 12px;
      font-size:12px;
    }
    .summary-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:8px;
      gap:8px;
    }
    .summary-header h2{
      font-size:15px;
    }
    .summary-header p{
      font-size:11px;
      color:var(--text-soft);
    }
    .summary-badge{
      font-size:11px;
      padding:3px 10px;
      border-radius:var(--radius-pill);
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
    }
    .summary-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:6px 10px;
      margin-bottom:8px;
    }
    .summary-item span{
      display:block;
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:1px;
    }
    .summary-item strong{
      font-size:13px;
      font-variant-numeric:tabular-nums;
    }
    .summary-groups{
      font-size:11px;
      padding:6px 8px;
      border-radius:var(--radius-lg);
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.45);
      margin-bottom:8px;
      color:var(--text-soft);
    }
    .summary-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:4px;
    }
    .btn{
      border:none;
      border-radius:var(--radius-pill);
      font-size:12px;
      padding:5px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary{
      background:var(--accent);
      color:#022c22;
    }
    .btn-ghost{
      background:transparent;
      color:var(--text-soft);
      border:1px solid rgba(148,163,184,0.5);
    }

    /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ö‡∏ô‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    @media (max-width:768px){
      .hud-groups{
        display:none;
      }
      #quest-panel{
        top:auto;
        bottom:72px;
        right:6px;
      }
      .summary-card{
        border-radius:18px;
        padding:12px 12px 10px;
      }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- ===== VR Scene (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á, ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡πâ mode-factory ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á) ===== -->
  <div id="scene-wrap">
    <a-scene
      vr-mode-ui="enabled: true"
      embedded="true"
      renderer="antialias: true; colorManagement: true"
      background="color: #020617"
    >
      <a-entity position="0 1.6 0">
        <a-entity camera look-controls wasd-controls="enabled: false"></a-entity>
      </a-entity>
      <!-- ‡πÑ‡∏ü‡∏à‡∏≤‡∏á ‡πÜ -->
      <a-entity light="type:ambient; color:#ffffff; intensity:0.6"></a-entity>
      <a-entity light="type:directional; color:#ffffff; intensity:0.7" position="0 2 -1"></a-entity>
    </a-scene>
  </div>

  <!-- ===== HUD / UI Overlay ===== -->
  <div id="hud">
    <div class="hud-top">
      <div class="hud-left">
        <div class="hud-title">
          <span>üçΩÔ∏è Balanced Plate VR</span>
          <span class="hud-pill">
            <span class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
            <span id="hud-diff">-</span>
          </span>
        </div>
        <div class="hud-info-row">
          <div class="hud-badge">
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            <span class="value" id="hud-score">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>
            <span class="value" id="hud-combo">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</span>
            <span class="value" id="hud-plates">0</span>
          </div>
          <div class="hud-badge">
            <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
            <span class="value" id="hud-miss">0</span>
          </div>
        </div>
      </div>

      <div class="hud-right">
        <div class="hud-timer">
          <span class="icon">‚è±Ô∏è</span>
          <span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</span>
          <span class="value" id="hud-time">60</span>
          <span>‡∏ß‡∏¥</span>
        </div>
        <div class="hud-groups" id="hud-groups">
          <span>‡∏´‡∏°‡∏π‡πà 1: <strong id="g1">0</strong></span>
          <span>2: <strong id="g2">0</strong></span>
          <span>3: <strong id="g3">0</strong></span>
          <span>4: <strong id="g4">0</strong></span>
          <span>5: <strong id="g5">0</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Quest Panel ===== -->
  <div id="quest-panel">
    <div class="quest-card">
      <div class="quest-header">
        <span class="title">QUEST ‚Äî ‡∏à‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        <span class="icon">üéØ</span>
      </div>
      <div class="quest-section">
        <div class="quest-label">Goal ‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="quest-text" id="quest-goal">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="quest-section">
        <div class="quest-label">Mini Quest</div>
        <div class="quest-text" id="quest-mini">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤</div>
      </div>
      <div class="quest-hint" id="quest-hint">
        ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏ô 1 ‡∏à‡∏≤‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      </div>
    </div>
  </div>

  <!-- ===== Coach Bubble ===== -->
  <div id="coach-wrap">
    <div class="coach-bubble" id="coach-bubble">
      <div class="coach-avatar">üë©‚Äçüè´</div>
      <div class="coach-text" id="coach-text">
        ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞
      </div>
    </div>
  </div>

  <!-- ===== Summary Overlay ===== -->
  <div id="summary">
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <h2 id="sum-title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Balanced Plate</h2>
          <p id="sum-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>
        </div>
        <div class="summary-badge" id="sum-diff">‡∏£‡∏∞‡∏î‡∏±‡∏ö -</div>
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
          <strong id="sum-score">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
          <strong id="sum-combo">0</strong>
        </div>
        <div class="summary-item">
          <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
          <strong id="sum-miss">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏î‡πâ</span>
          <strong id="sum-plates">0</strong>
        </div>
        <div class="summary-item">
          <span>Goal ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-goal-done">0</span>/<span id="sum-goal-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>Mini Quest ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-mini-done">0</span>/<span id="sum-mini-total">0</span></strong>
        </div>
      </div>

      <div class="summary-groups">
        <div><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° (‡∏´‡∏°‡∏π‡πà 1‚Äì5):</strong></div>
        <div id="sum-groups">1:0, 2:0, 3:0, 4:0, 5:0</div>
      </div>

      <div class="summary-actions">
        <button class="btn btn-ghost" id="btn-to-hub">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="btn btn-primary" id="btn-restart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
      </div>
    </div>
  </div>

</div>

<!-- ===== Logic ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ plate-vr ===== -->
<script type="module">
  import { boot as bootPlate } from './plate/plate.safe.js';

  // ------- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL -------
  const url = new URL(window.location.href);
  const diffParam = (url.searchParams.get('diff') || 'easy').toLowerCase();
  let duration = parseInt(url.searchParams.get('time') || '60', 10);
  if (!Number.isFinite(duration) || duration <= 0) duration = 60;
  if (duration < 20) duration = 20;
  if (duration > 180) duration = 180;

  // ------- DOM refs HUD -------
  const elDiff    = document.getElementById('hud-diff');
  const elScore   = document.getElementById('hud-score');
  const elCombo   = document.getElementById('hud-combo');
  const elPlates  = document.getElementById('hud-plates');
  const elMiss    = document.getElementById('hud-miss');
  const elTime    = document.getElementById('hud-time');
  const elG1      = document.getElementById('g1');
  const elG2      = document.getElementById('g2');
  const elG3      = document.getElementById('g3');
  const elG4      = document.getElementById('g4');
  const elG5      = document.getElementById('g5');

  // Quest
  const elQuestGoal = document.getElementById('quest-goal');
  const elQuestMini = document.getElementById('quest-mini');
  const elQuestHint = document.getElementById('quest-hint');

  // Coach
  const elCoachBubble = document.getElementById('coach-bubble');
  const elCoachText   = document.getElementById('coach-text');
  let coachTimer = null;

  // Summary
  const elSummary      = document.getElementById('summary');
  const elSumTitle     = document.getElementById('sum-title');
  const elSumSub       = document.getElementById('sum-sub');
  const elSumDiff      = document.getElementById('sum-diff');
  const elSumScore     = document.getElementById('sum-score');
  const elSumCombo     = document.getElementById('sum-combo');
  const elSumMiss      = document.getElementById('sum-miss');
  const elSumPlates    = document.getElementById('sum-plates');
  const elSumGoalDone  = document.getElementById('sum-goal-done');
  const elSumGoalTotal = document.getElementById('sum-goal-total');
  const elSumMiniDone  = document.getElementById('sum-mini-done');
  const elSumMiniTotal = document.getElementById('sum-mini-total');
  const elSumGroups    = document.getElementById('sum-groups');

  const btnRestart = document.getElementById('btn-restart');
  const btnToHub   = document.getElementById('btn-to-hub');

  // ‡πÅ‡∏õ‡∏•‡∏á diff ‡πÄ‡∏õ‡πá‡∏ô label ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  function diffLabel(d){
    if (d === 'easy') return '‡∏á‡πà‡∏≤‡∏¢';
    if (d === 'hard') return '‡∏¢‡∏≤‡∏Å';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  elDiff.textContent = diffLabel(diffParam);
  elTime.textContent = duration;

  // ------- Clock ‡∏Å‡∏•‡∏≤‡∏á ‡∏™‡πà‡∏á hha:time -------
  let secLeft = duration;
  let timerId = null;
  let endedByEvent = false;

  function tick(){
    if (endedByEvent) return;
    // ‡∏™‡πà‡∏á event ‡πÉ‡∏´‡πâ engine
    window.dispatchEvent(new CustomEvent('hha:time', {
      detail:{ sec: secLeft }
    }));

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HUD
    elTime.textContent = Math.max(secLeft, 0);

    secLeft -= 1;
    if (secLeft < 0) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° timer ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
  timerId = setInterval(tick, 1000);
  // ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (sec = duration)
  tick();

  // ------- HUD realtime ‡∏à‡∏≤‡∏Å hha:stat -------
  window.addEventListener('hha:stat', (e) => {
    const d = e.detail || {};
    if (typeof d.score === 'number')   elScore.textContent  = d.score;
    if (typeof d.combo === 'number')   elCombo.textContent  = d.combo;
    if (typeof d.misses === 'number')  elMiss.textContent   = d.misses;
    if (typeof d.platesDone === 'number') elPlates.textContent = d.platesDone;

    if (Array.isArray(d.totalCounts) && d.totalCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.totalCounts;
      elG1.textContent = g1;
      elG2.textContent = g2;
      elG3.textContent = g3;
      elG4.textContent = g4;
      elG5.textContent = g5;
    }
  });

  // ------- Quest realtime -------
  window.addEventListener('quest:update', (e) => {
    const d = e.detail || {};
    const goal = d.goal || {};
    const mini = d.mini || {};

    const goalText = goal.text || goal.title || goal.label || goal.name || '‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà';
    const miniText = mini.text || mini.title || mini.label || mini.name || '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤';

    elQuestGoal.textContent = goalText;
    elQuestMini.textContent = miniText;
    elQuestHint.textContent = d.hint || elQuestHint.textContent;
  });

  // ------- Coach Bubble -------
  function showCoach(text){
    if (!text) return;
    elCoachText.textContent = text;
    elCoachBubble.classList.add('show');
    if (coachTimer) clearTimeout(coachTimer);
    coachTimer = setTimeout(() => {
      elCoachBubble.classList.remove('show');
    }, 3500);
  }

  window.addEventListener('hha:coach', (e) => {
    const d = e.detail || {};
    if (d.text) showCoach(d.text);
  });

  // ------- Summary ‡∏à‡∏≤‡∏Å hha:end -------
  window.addEventListener('hha:end', (e) => {
    const d = e.detail || {};
    endedByEvent = true;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }

    elSumTitle.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${d.mode || 'Balanced Plate'}`;
    elSumSub.textContent   = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${d.duration || duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
    elSumDiff.textContent  = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)}`;

    elSumScore.textContent  = d.score ?? 0;
    elSumCombo.textContent  = d.comboMax ?? 0;
    elSumMiss.textContent   = d.misses ?? 0;
    elSumPlates.textContent = d.platesDone ?? 0;

    elSumGoalDone.textContent  = d.goalsCleared ?? 0;
    elSumGoalTotal.textContent = d.goalsTotal ?? 0;
    elSumMiniDone.textContent  = d.questsCleared ?? 0;
    elSumMiniTotal.textContent = d.questsTotal ?? 0;

    if (Array.isArray(d.groupCounts) && d.groupCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.groupCounts;
      elSumGroups.textContent = `1: ${g1}   2: ${g2}   3: ${g3}   4: ${g4}   5: ${g5}`;
    } else {
      elSumGroups.textContent = '-';
    }

    elSummary.classList.add('visible');
  });

  // ------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö / ‡∏Å‡∏•‡∏±‡∏ö Hub -------
  btnRestart.addEventListener('click', () => {
    const base = window.location.pathname.split('/').pop() || 'plate-vr.html';
    const search = `?diff=${encodeURIComponent(diffParam)}&time=${encodeURIComponent(duration)}`;
    window.location.href = base + search;
  });

  btnToHub.addEventListener('click', () => {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå hub ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ./hub.html
    window.location.href = './hub.html';
  });

  // ------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° Plate Engine -------
  bootPlate({ difficulty: diffParam, duration });
</script>

</body>
</html>
