<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÅ‡∏¢‡∏Å -->
  <link rel="stylesheet" href="./css/plate-vr.css" />

  <!-- A-Frame core (‡πÉ‡∏ä‡πâ scene ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ mode-factory ‡πÉ‡∏ä‡πâ) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Particle FX (global: window.Particles / window.GAME_MODULES.Particles) -->
  <script src="./vr/particles.js"></script>    <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡πâ‡∏á -->
  <script src="./vr/ui-fever.js"></script>     <!-- Fever ‡∏Å‡∏•‡∏≤‡∏á -->
</head>
<body>
<div class="app">

  <!-- ===== VR Scene (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á, ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡πâ mode-factory ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á) ===== -->
  <div id="scene-wrap">
    <a-scene
      vr-mode-ui="enabled: true"
      embedded="true"
      renderer="antialias: true; colorManagement: true"
      background="color: #020617"
    >
      <a-entity position="0 1.6 0">
        <!-- ‡πÄ‡∏õ‡∏¥‡∏î touch/mouse ‡∏ä‡∏±‡∏î ‡πÜ -->
        <a-entity
          camera
          look-controls="touchEnabled: true; mouseEnabled: true; pointerLockEnabled: false"
          wasd-controls="enabled: false">
        </a-entity>
      </a-entity>

      <!-- ‡πÑ‡∏ü‡∏à‡∏≤‡∏á ‡πÜ -->
      <a-entity light="type:ambient; color:#ffffff; intensity:0.6"></a-entity>
      <a-entity light="type:directional; color:#ffffff; intensity:0.7" position="0 2 -1"></a-entity>
    </a-scene>
  </div>

  <!-- ===== HUD / UI Overlay ===== -->
  <div id="hud">
    <div class="hud-top">
      <div class="hud-left">
        <div class="hud-title">
          <span>üçΩÔ∏è Balanced Plate VR</span>
          <span class="hud-pill">
            <span class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
            <span id="hud-diff">-</span>
          </span>
        </div>

        <div class="hud-info-row">
          <div class="hud-badge">
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            <span class="value" id="hud-score">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>
            <span class="value" id="hud-combo">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</span>
            <span class="value" id="hud-plates">0</span>
          </div>
          <div class="hud-badge">
            <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
            <span class="value" id="hud-miss">0</span>
          </div>
          <div class="hud-badge hud-badge-grade">
            <span>‡πÄ‡∏Å‡∏£‡∏î</span>
            <span class="value" id="hud-grade">C</span>
          </div>
        </div>

        <!-- Legend ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
        <div class="hud-groups-legend">
          <span>1 ‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á üçöüçû</span>
          <span>2 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ü•©üçó</span>
          <span>3 ‡∏ú‡∏±‡∏Å ü•¶ü•ï</span>
          <span>4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ üçéüçå</span>
          <span>5 ‡∏ô‡∏°/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏° ü•õüßÄ</span>
        </div>
      </div>

      <div class="hud-right">
        <div class="hud-timer">
          <span class="icon">‚è±Ô∏è</span>
          <span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</span>
          <span class="value" id="hud-time">60</span>
          <span>‡∏ß‡∏¥</span>
        </div>
        <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà -->
        <div class="hud-groups" id="hud-groups">
          <span>‡∏´‡∏°‡∏π‡πà 1: <strong id="g1">0</strong></span>
          <span>2: <strong id="g2">0</strong></span>
          <span>3: <strong id="g3">0</strong></span>
          <span>4: <strong id="g4">0</strong></span>
          <span>5: <strong id="g5">0</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Quest Panel ===== -->
  <div id="quest-panel">
    <div class="quest-card">
      <div class="quest-header">
        <span class="title">QUEST ‚Äî ‡∏à‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        <span class="icon">üéØ</span>
      </div>
      <div class="quest-section">
        <div class="quest-label">Goal ‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="quest-text" id="quest-goal">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="quest-section">
        <div class="quest-label">Mini Quest</div>
        <div class="quest-text" id="quest-mini">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤</div>
      </div>
      <div class="quest-hint" id="quest-hint">
        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå: progress + quota ‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î -->
      </div>
    </div>
  </div>

  <!-- ===== Coach Bubble ===== -->
  <div id="coach-wrap">
    <div class="coach-bubble" id="coach-bubble">
      <div class="coach-avatar">üë©‚Äçüè´</div>
      <div class="coach-text" id="coach-text">
        ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞
      </div>
    </div>
  </div>

  <!-- ===== Toast ‡∏â‡∏•‡∏≠‡∏á‡∏à‡∏ö Goal/Mini ===== -->
  <div id="quest-toast">
    <div class="quest-toast-inner">
      <div class="quest-toast-title" id="qt-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div class="quest-toast-text" id="qt-text">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
      <div class="quest-toast-tag" id="qt-tag">Goal 1/2 ‚Ä¢ Mini 2/3</div>
    </div>
  </div>

  <!-- ===== Mega Celebration ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ===== -->
  <div id="mega-celebrate">
    <div class="mega-card">
      <div class="mega-emoji">üèÖüçΩÔ∏è</div>
      <div class="mega-title">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!</div>
      <div class="mega-text">
        ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Goal ‡πÅ‡∏•‡∏∞ Mini Quest ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å üéâ
      </div>
    </div>
  </div>

  <!-- ===== Summary Overlay ===== -->
  <div id="summary">
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <h2 id="sum-title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Balanced Plate</h2>
          <p id="sum-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>
        </div>
        <div class="summary-badge" id="sum-diff">‡∏£‡∏∞‡∏î‡∏±‡∏ö -</div>
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
          <strong id="sum-score">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
          <strong id="sum-combo">0</strong>
        </div>
        <div class="summary-item">
          <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
          <strong id="sum-miss">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏î‡πâ</span>
          <strong id="sum-plates">0</strong>
        </div>
        <div class="summary-item">
          <span>Goal ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-goal-done">0</span>/<span id="sum-goal-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>Mini Quest ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-mini-done">0</span>/<span id="sum-mini-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏ß‡∏°</span>
          <strong id="sum-grade">-</strong>
        </div>
      </div>

      <div class="summary-groups">
        <div><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° (‡∏´‡∏°‡∏π‡πà 1‚Äì5):</strong></div>
        <div id="sum-groups">1:0, 2:0, 3:0, 4:0, 5:0</div>
      </div>

      <div class="summary-actions">
        <button class="btn btn-ghost" id="btn-to-hub">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="btn btn-primary" id="btn-restart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
      </div>
    </div>
  </div>

  <!-- ===== Gaze Reticle (VR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏•‡∏≠‡∏î) ===== -->
  <div id="gaze-reticle">
    <div class="gaze-dot"></div>
    <div class="gaze-ring"></div>
  </div>

</div>

<!-- ===== Logic ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ plate-vr ===== -->
<script type="module">
  import { boot as bootPlate } from './plate/plate.safe.js';

  // ------- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL -------
  const url = new URL(window.location.href);
  const diffParam = (url.searchParams.get('diff') || 'easy').toLowerCase();
  const runParam  = (url.searchParams.get('run')  || 'play').toLowerCase();

  let duration = parseInt(url.searchParams.get('time') || '60', 10);
  if (!Number.isFinite(duration) || duration <= 0) duration = 60;
  if (duration < 20) duration = 20;
  if (duration > 180) duration = 180;

  // ‡πÄ‡∏Å‡πá‡∏ö run mode ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ logger / ‡πÄ‡∏Å‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô
  try {
    if (typeof sessionStorage !== 'undefined') {
      sessionStorage.setItem('HHA_RUN_MODE', runParam); // 'play' | 'research'
    }
  } catch (err) {
    console.warn('[PlateVR] cannot save HHA_RUN_MODE:', err);
  }

  // ------- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Hub ‡∏Å‡πà‡∏≠‡∏ô -------
  function ensureProfileForResearch() {
    if (runParam !== 'research') return;
    try {
      const raw = sessionStorage.getItem('HHA_STUDENT_PROFILE');
      if (!raw) {
        alert('‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Hub ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ‚úèÔ∏è\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Hub');
        window.location.href = './hub.html';
      }
    } catch (err) {
      console.warn('[PlateVR] profile check error:', err);
    }
  }

  ensureProfileForResearch();

  // ------- DOM refs HUD -------
  const elDiff    = document.getElementById('hud-diff');
  const elScore   = document.getElementById('hud-score');
  const elCombo   = document.getElementById('hud-combo');
  const elPlates  = document.getElementById('hud-plates');
  const elMiss    = document.getElementById('hud-miss');
  const elGrade   = document.getElementById('hud-grade');
  const elTime    = document.getElementById('hud-time');
  const elG1      = document.getElementById('g1');
  const elG2      = document.getElementById('g2');
  const elG3      = document.getElementById('g3');
  const elG4      = document.getElementById('g4');
  const elG5      = document.getElementById('g5');

  // Quest
  const elQuestGoal = document.getElementById('quest-goal');
  const elQuestMini = document.getElementById('quest-mini');
  const elQuestHint = document.getElementById('quest-hint');

  // Coach
  const elCoachBubble = document.getElementById('coach-bubble');
  const elCoachText   = document.getElementById('coach-text');
  let coachTimer = null;

  // Toast / celebration
  const toastEl      = document.getElementById('quest-toast');
  const toastTitleEl = document.getElementById('qt-title');
  const toastTextEl  = document.getElementById('qt-text');
  const toastTagEl   = document.getElementById('qt-tag');
  const megaEl       = document.getElementById('mega-celebrate');

  let toastTimer = null;
  let lastStat   = null;
  let lastHintHeader = '';
  let allClearedShown = false;

  const GROUP_ICONS = ['üçö','ü•©','ü•¶','üçé','ü•õ'];
  const QUOTA_MAP = {
    easy:   [1,1,1,1,1],
    normal: [1,1,2,2,1],
    hard:   [2,2,2,2,1]
  };

  // Summary
  const elSummary      = document.getElementById('summary');
  const elSumTitle     = document.getElementById('sum-title');
  const elSumSub       = document.getElementById('sum-sub');
  const elSumDiff      = document.getElementById('sum-diff');
  const elSumScore     = document.getElementById('sum-score');
  const elSumCombo     = document.getElementById('sum-combo');
  const elSumMiss      = document.getElementById('sum-miss');
  const elSumPlates    = document.getElementById('sum-plates');
  const elSumGoalDone  = document.getElementById('sum-goal-done');
  const elSumGoalTotal = document.getElementById('sum-goal-total');
  const elSumMiniDone  = document.getElementById('sum-mini-done');
  const elSumMiniTotal = document.getElementById('sum-mini-total');
  const elSumGroups    = document.getElementById('sum-groups');
  const elSumGrade     = document.getElementById('sum-grade');

  const btnRestart = document.getElementById('btn-restart');
  const btnToHub   = document.getElementById('btn-to-hub');

  const sceneEl   = document.querySelector('a-scene');
  const gazeEl    = document.getElementById('gaze-reticle');

  // ‡πÅ‡∏õ‡∏•‡∏á diff ‡πÄ‡∏õ‡πá‡∏ô label ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  function diffLabel(d){
    if (d === 'easy') return '‡∏á‡πà‡∏≤‡∏¢';
    if (d === 'hard') return '‡∏¢‡∏≤‡∏Å';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  elDiff.textContent = diffLabel(diffParam);
  elTime.textContent = duration;

  // ------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Hint quota / progress ‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î -------
  function updateQuestHint(prefixHtml = '') {
    if (!elQuestHint) return;

    const quota = QUOTA_MAP[diffParam] || QUOTA_MAP.normal;
    const plate = (lastStat && Array.isArray(lastStat.plateCounts))
      ? lastStat.plateCounts
      : [0,0,0,0,0];

    let html = '';
    if (prefixHtml) {
      html += prefixHtml;
    }

    html += '<div class="quest-hint-title">‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏à‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</div>';

    for (let i = 0; i < quota.length && i < 5; i++) {
      const need = quota[i] ?? 0;
      if (!need) continue;
      const have = plate[i] ?? 0;
      const missing = Math.max(0, need - have);
      const cls = missing > 0 ? 'missing' : 'ok';
      const txt = missing > 0
        ? `${have}/${need} (‡∏Ç‡∏≤‡∏î ${missing})`
        : `${have}/${need} ‚úî`;

      html += `
        <div class="quest-hint-line ${cls}">
          <span class="quest-hint-icon">${GROUP_ICONS[i]}</span>
          <span class="quest-hint-label">‡∏´‡∏°‡∏π‡πà ${i + 1}</span>
          <span class="quest-hint-text">${txt}</span>
        </div>
      `;
    }

    elQuestHint.innerHTML = html;
  }

  function showQuestToast(kind, text, progressText) {
    if (!toastEl) return;
    toastEl.classList.remove('goal', 'mini', 'show');
    toastEl.classList.add(kind === 'goal' ? 'goal' : 'mini');

    if (toastTitleEl) {
      toastTitleEl.textContent = kind === 'goal'
        ? 'Goal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! üéØ'
        : 'Mini Quest ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‚≠ê';
    }
    if (toastTextEl) toastTextEl.textContent = text || '';
    if (toastTagEl)  toastTagEl.textContent  = progressText || '';

    void toastEl.offsetWidth; // reflow ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö animation
    toastEl.classList.add('show');

    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toastEl.classList.remove('show');
    }, 2600);
  }

  function showMegaCelebration() {
    if (allClearedShown) return;
    allClearedShown = true;
    if (megaEl) megaEl.classList.add('show');
  }

  // ------- Clock ‡∏Å‡∏•‡∏≤‡∏á ‡∏™‡πà‡∏á hha:time -------
  let secLeft = duration;
  let timerId = null;
  let endedByEvent = false;

  function tick(){
    if (endedByEvent) return;
    // ‡∏™‡πà‡∏á event ‡πÉ‡∏´‡πâ engine
    window.dispatchEvent(new CustomEvent('hha:time', {
      detail:{ sec: secLeft }
    }));

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HUD
    elTime.textContent = Math.max(secLeft, 0);

    secLeft -= 1;
    if (secLeft < 0) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  timerId = setInterval(tick, 1000);
  tick(); // ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

  // ------- HUD realtime ‡∏à‡∏≤‡∏Å hha:stat -------
  window.addEventListener('hha:stat', (e) => {
    const d = e.detail || {};
    lastStat = d;

    if (typeof d.score === 'number')   elScore.textContent  = d.score;
    if (typeof d.combo === 'number')   elCombo.textContent  = d.combo;
    if (typeof d.misses === 'number')  elMiss.textContent   = d.misses;
    if (typeof d.platesDone === 'number') elPlates.textContent = d.platesDone;
    if (typeof d.grade === 'string')   elGrade.textContent  = d.grade;

    if (Array.isArray(d.totalCounts) && d.totalCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.totalCounts;
      elG1.textContent = g1;
      elG2.textContent = g2;
      elG3.textContent = g3;
      elG4.textContent = g4;
      elG5.textContent = g5;
    }

    // ‡∏õ‡∏£‡∏±‡∏ö hint quota ‡∏ï‡∏≤‡∏° plateCounts ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    updateQuestHint(lastHintHeader);

    // ‡∏ñ‡πâ‡∏≤ engine ‡πÅ‡∏à‡πâ‡∏á allCleared ‡∏ú‡πà‡∏≤‡∏ô stat (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ event ‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô)
    if (d.allCleared && !allClearedShown) {
      showMegaCelebration();
    }
  });

  // ------- Quest realtime / progress per batch -------
  window.addEventListener('quest:update', (e) => {
    const d = e.detail || {};
    const goal = d.goal || {};
    const mini = d.mini || {};
    const goals = d.goalsAll || d.goals || [];
    const minis = d.minisAll || d.minis || [];

    const goalText = goal.text || goal.title || goal.label || goal.name || '‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà';
    const miniText = mini.text || mini.title || mini.label || mini.name || '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤';

    if (elQuestGoal) elQuestGoal.textContent = goalText;
    if (elQuestMini) elQuestMini.textContent = miniText;

    const gDone  = goals.filter(q => q && q.done).length;
    const gTotal = goals.length || 0;
    const mDone  = minis.filter(q => q && q.done).length;
    const mTotal = minis.length || 0;

    lastHintHeader =
      `<div class="quest-hint-title">Goal ${gDone}/${gTotal} ‚Ä¢ Mini ${mDone}/${mTotal}</div>`;

    updateQuestHint(lastHintHeader);
  });

  // ------- Toast ‡∏â‡∏•‡∏≠‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏Å quest:cleared -------
  window.addEventListener('quest:cleared', (e) => {
    const d = e.detail || {};
    const cleared = d.cleared || [];
    if (!cleared.length) return;
    const q = cleared[0];

    const goals = d.goals || [];
    const minis = d.minis || [];
    const gDone  = goals.filter(x => x && x.done).length;
    const gTotal = goals.length || 0;
    const mDone  = minis.filter(x => x && x.done).length;
    const mTotal = minis.length || 0;

    const progressText = `Goal ${gDone}/${gTotal} ‚Ä¢ Mini ${mDone}/${mTotal}`;
    showQuestToast(q.type === 'goal' ? 'goal' : 'mini',
      q.text || q.title || q.label || '',
      progressText
    );
  });

  // ------- Mega celebration ‡∏à‡∏≤‡∏Å engine -------
  window.addEventListener('hha:all-cleared', () => {
    showMegaCelebration();
  });

  // ------- Coach Bubble -------
  function showCoach(text){
    if (!text) return;
    elCoachText.textContent = text;
    elCoachBubble.classList.add('show');
    if (coachTimer) clearTimeout(coachTimer);
    coachTimer = setTimeout(() => {
      elCoachBubble.classList.remove('show');
    }, 3500);
  }

  window.addEventListener('hha:coach', (e) => {
    const d = e.detail || {};
    if (d.text) showCoach(d.text);
  });

  // ------- Summary ‡∏à‡∏≤‡∏Å hha:end -------
  window.addEventListener('hha:end', (e) => {
    const d = e.detail || {};
    endedByEvent = true;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }

    // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡πÇ‡∏ú‡∏•‡πà‡∏≠‡∏µ‡∏Å
    document.body.classList.add('hha-game-ended');

    elSumTitle.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${d.mode || 'Balanced Plate'}`;
    elSumSub.textContent   = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${d.duration || duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
    elSumDiff.textContent  = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)}`;

    elSumScore.textContent  = d.score ?? 0;
    elSumCombo.textContent  = d.comboMax ?? 0;
    elSumMiss.textContent   = d.misses ?? 0;
    elSumPlates.textContent = d.platesDone ?? 0;

    elSumGoalDone.textContent  = d.goalsCleared ?? 0;
    elSumGoalTotal.textContent = d.goalsTotal ?? 0;
    elSumMiniDone.textContent  = d.questsCleared ?? 0;
    elSumMiniTotal.textContent = d.questsTotal ?? 0;
    elSumGrade.textContent     = d.grade || '-';

    if (Array.isArray(d.groupCounts) && d.groupCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.groupCounts;
      elSumGroups.textContent = `1: ${g1}   2: ${g2}   3: ${g3}   4: ${g4}   5: ${g5}`;
    } else {
      elSumGroups.textContent = '-';
    }

    elSummary.classList.add('visible');
  });

  // ------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö / ‡∏Å‡∏•‡∏±‡∏ö Hub -------
  btnRestart.addEventListener('click', () => {
    const base = window.location.pathname.split('/').pop() || 'plate-vr.html';
    const params = new URLSearchParams();
    params.set('diff', diffParam);
    params.set('time', String(duration));
    params.set('run',  runParam);   // ‡∏Ñ‡∏á run ‡πÄ‡∏î‡∏¥‡∏° (play / research)

    window.location.href = `${base}?${params.toString()}`;
  });

  btnToHub.addEventListener('click', () => {
    window.location.href = './hub.html';
  });

  // ------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° Plate Engine -------
  bootPlate({ difficulty: diffParam, duration });

  // ================== Gaze & Fuse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VR ==================

  let isVrMode = false;

  const GAZE_RADIUS = 70;     // ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÇ‡∏î‡∏ô (px)
  const FUSE_MS     = 1100;   // ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (ms)

  let gazeTimerId   = null;
  let gazeTarget    = null;
  let gazeStartTs   = 0;

  function findTargetNearCenter() {
    const targets = document.querySelectorAll('.hha-target');
    if (!targets.length) return { el: null, dist: Infinity };

    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    let best = null;
    let bestDist = Infinity;

    targets.forEach(el => {
      const rect = el.getBoundingClientRect();
      const tx = rect.left + rect.width / 2;
      const ty = rect.top  + rect.height / 2;
      const dx = tx - cx;
      const dy = ty - cy;
      const dist = Math.hypot(dx, dy);
      if (dist < bestDist) {
        bestDist = dist;
        best = el;
      }
    });

    return { el: best, dist: bestDist };
  }

  function hitTargetAtCenter() {
    const { el, dist } = findTargetNearCenter();
    if (!el || dist > GAZE_RADIUS) return false;
    el.click();
    return true;
  }

  function gazeTick() {
    if (!isVrMode) return;

    const { el, dist } = findTargetNearCenter();

    if (!el || dist > GAZE_RADIUS) {
      gazeTarget = null;
      gazeStartTs = 0;
      if (gazeEl) gazeEl.classList.remove('fuse-active');
      return;
    }

    const now = performance.now();

    if (el === gazeTarget) {
      const elapsed = now - gazeStartTs;
      if (elapsed >= FUSE_MS) {
        if (gazeEl) gazeEl.classList.remove('fuse-active');
        el.click();
        gazeTarget = null;
        gazeStartTs = 0;
      }
    } else {
      gazeTarget = el;
      gazeStartTs = now;
      if (gazeEl) {
        gazeEl.classList.remove('fuse-active');
        void gazeEl.offsetWidth;
        gazeEl.classList.add('fuse-active');
      }
    }
  }

  function startGazeLoop() {
    if (gazeTimerId) return;
    gazeTimerId = setInterval(gazeTick, 100);
  }

  function stopGazeLoop() {
    if (!gazeTimerId) return;
    clearInterval(gazeTimerId);
    gazeTimerId = null;
    gazeTarget = null;
    gazeStartTs = 0;
    if (gazeEl) gazeEl.classList.remove('fuse-active');
  }

  if (sceneEl) {
    sceneEl.addEventListener('enter-vr', () => {
      isVrMode = true;
      document.body.classList.add('hha-vr-mode');
      startGazeLoop();
    });
    sceneEl.addEventListener('exit-vr', () => {
      isVrMode = false;
      document.body.classList.remove('hha-vr-mode');
      stopGazeLoop();
    });
  }

  // pointer / key ‚Üí ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô VR)
  function handlePointerDownForGaze(ev) {
    if (!isVrMode) return;

    const path = ev.composedPath ? ev.composedPath() : [ev.target];
    const hitUI = path.some(node => {
      if (!node || !node.closest) return false;
      return node.closest('#summary') ||
             node.closest('#hud')     ||
             node.closest('button');
    });
    if (hitUI) return;

    const hitTargetDirect = path.some(node =>
      node && node.classList && node.classList.contains('hha-target')
    );
    if (hitTargetDirect) return;

    hitTargetAtCenter();
  }

  function handleKeyDownForGaze(ev) {
    if (!isVrMode) return;
    if (ev.code === 'Space' || ev.code === 'Enter') {
      const ok = hitTargetAtCenter();
      if (ok) ev.preventDefault();
    }
  }

  window.addEventListener('pointerdown', handlePointerDownForGaze, { passive:true });
  window.addEventListener('keydown', handleKeyDownForGaze);
</script>

</body>
</html>
