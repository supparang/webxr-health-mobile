<!-- === /herohealth/plate-vr.html ===
Plate VR (PRODUCTION) ‚Äî FULL (Cardboard STEREO + GAZE)
‚úÖ Loads: particles.js + hha-compat-input + hha-cloud-logger + hha-hud
‚úÖ Works with: ./plate/plate.safe.js (IIFE)
‚úÖ Has #plate-layer (spawn host)
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + input compat + logger + HUD binder -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- UI CSS -->
  <link rel="stylesheet" href="./plate/plate-vr.css" />

  <!-- Plate engine -->
  <script defer src="./plate/plate.safe.js"></script>
</head>

<body>
  <!-- Cardboard wrapper (eyes) -->
  <div id="cbWrap" aria-hidden="true">
    <div class="eye" id="eyeL"><div class="eyeInner" id="eyeInnerL"></div></div>
    <div class="eye" id="eyeR"><div class="eyeInner" id="eyeInnerR"></div></div>
  </div>
  <div id="cbDivider" aria-hidden="true"></div>

  <div class="gazeRing" id="gazeL" aria-hidden="true"></div>
  <div class="gazeRing" id="gazeR" aria-hidden="true"></div>

  <!-- ===== MAIN APP (single view) ===== -->
  <div id="plateApp">
    <a-scene embedded vr-mode-ui="enabled: false">
      <a-entity id="cam" camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>

    <!-- ‚úÖ Spawn layer -->
    <div id="plate-layer" aria-hidden="true"></div>

    <div id="hitFx"></div>
    <div id="crosshair" aria-hidden="true"></div>

    <!-- START overlay -->
    <div id="startOverlay">
      <div id="startCard">
        <div id="startTitle">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Plate VR?</div>
        <div id="startDesc">
          ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
          * ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion ‡∏¢‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á + ‡∏•‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á)
        </div>
        <div id="startBtns">
          <button class="btn" id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <div id="hudTop">
      <div class="hudCard" style="flex:1">
        <div id="hudLeftGroup">
          <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span id="hudTime" class="v">0</span></span>
          <span class="pill">üèÜ <span class="k">SCORE</span> <span id="hudScore" class="v">0</span></span>
          <span class="pill">‚ö° <span class="k">COMBO</span> <span id="hudCombo" class="v">0</span></span>
          <span class="pill">üí• <span class="k">MISS</span> <span id="hudMiss" class="v">0</span></span>
          <span class="pill">üçΩÔ∏è <span class="k">PLATE</span> <span id="hudGroupsHave" class="v">0/5</span></span>
        </div>
      </div>

      <div class="hudCard" style="flex:0 0 auto">
        <div id="hudRightGroup">
          <span class="pill">üî• <span class="k">FEVER</span> <span id="hudFeverPct" class="v">0%</span></span>
          <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span id="hudGrade" class="v">C</span></span>

          <span class="pill" style="display:none">‚≠ê <span class="k">PERF</span> <span id="hudPerfectCount" class="v">0</span></span>
          <span class="pill" style="display:none">üß™ <span class="k">MODE</span> <span id="hudMode" class="v">Play</span></span>
          <span class="pill" style="display:none">üéöÔ∏è <span class="k">DIFF</span> <span id="hudDiff" class="v">Normal</span></span>
        </div>
      </div>
    </div>

    <div id="miniPanel">
      <div id="miniLine">MINI: ‚Ä¶</div>
      <div id="goalLine">Goal: ‚Ä¶</div>
      <div id="miniHint">‚Ä¶</div>
    </div>

    <!-- Coach -->
    <div id="coachPanel">
      <img id="coachImg" src="./img/coach-neutral.png" alt="Coach" />
      <div id="coachMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üí™</div>
    </div>

    <div id="hudBtns">
      <button class="btn" id="btnCardboard">üì¶ CARDBOARD</button>
      <button class="btn" id="btnEnterVR">üï∂Ô∏è ENTER VR</button>
      <button class="btn" id="btnPause">‚è∏Ô∏è PAUSE</button>
      <button class="btn" id="btnRestart">üîÅ RESTART</button>
    </div>

    <!-- big shoot + gaze (cardboard) -->
    <div id="shootPad">
      <button class="btn" id="btnShoot">üéØ SHOOT</button>
      <button class="btn" id="btnGaze">üëÅÔ∏è GAZE</button>
    </div>

    <div id="hudPaused">‚è∏Ô∏è PAUSED</div>

    <!-- Result -->
    <div id="resultBackdrop">
      <div id="resultCard">
        <div style="font-weight:1100; font-size:20px">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏Å‡∏° (Plate VR)</div>
        <div style="color:rgba(148,163,184,.95); font-weight:900; margin-top:6px">
          Mode: <span id="rMode">‚Äî</span> ‚Ä¢ Grade: <span id="rGrade">‚Äî</span>
        </div>

        <div class="grid">
          <div class="cell"><span class="k">Score</span><span id="rScore" class="v">0</span></div>
          <div class="cell"><span class="k">Max Combo</span><span id="rMaxCombo" class="v">0</span></div>
          <div class="cell"><span class="k">Miss</span><span id="rMiss" class="v">0</span></div>
          <div class="cell"><span class="k">Perfect</span><span id="rPerfect" class="v">0</span></div>
          <div class="cell"><span class="k">Goals</span><span id="rGoals" class="v">0/3</span></div>
          <div class="cell"><span class="k">Minis</span><span id="rMinis" class="v">0/8</span></div>
        </div>

        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));">
          <div class="cell"><span class="k">G1 ‡∏ú‡∏±‡∏Å</span><span id="rG1" class="v">0</span></div>
          <div class="cell"><span class="k">G2 ‡∏ú‡∏•‡πÑ‡∏°‡πâ</span><span id="rG2" class="v">0</span></div>
          <div class="cell"><span class="k">G3 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span><span id="rG3" class="v">0</span></div>
          <div class="cell"><span class="k">G4 ‡πÅ‡∏õ‡πâ‡∏á</span><span id="rG4" class="v">0</span></div>
          <div class="cell"><span class="k">G5 ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</span><span id="rG5" class="v">0</span></div>
          <div class="cell"><span class="k">Total</span><span id="rGTotal" class="v">0</span></div>
        </div>

        <div id="resultActions">
          <button class="btn" id="btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ HUB</button>
          <button class="btn" id="btnPlayAgain">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
      </div>
    </div>
  </div><!-- /plateApp -->

  <script>
  (function(){
    'use strict';
    const D = document;

    // ===============================
    // Cardboard stereo: move #plateApp into left eye + clone to right
    // ===============================
    const btnCardboard = D.getElementById('btnCardboard');
    const btnShoot = D.getElementById('btnShoot');
    const btnGaze  = D.getElementById('btnGaze');

    const plateApp = D.getElementById('plateApp');
    const eyeInnerL = D.getElementById('eyeInnerL');
    const eyeInnerR = D.getElementById('eyeInnerR');

    let cardboardOn = false;
    let gazeOn = false;

    function suffixIds(rootEl, suf){
      const all = rootEl.querySelectorAll('[id]');
      for (const el of all){
        el.id = el.id + suf;
      }
    }

    function enableCardboard(){
      if (cardboardOn) return;
      cardboardOn = true;
      D.body.classList.add('cardboard');

      // move original app into left eye
      eyeInnerL.appendChild(plateApp);

      // clone to right eye
      const clone = plateApp.cloneNode(true);
      clone.id = 'plateApp_r';
      suffixIds(clone, '_r');
      eyeInnerR.appendChild(clone);
    }

    function disableCardboard(){
      if (!cardboardOn) return;
      cardboardOn = false;
      gazeOn = false;
      D.body.classList.remove('cardboard','gaze');
      D.documentElement.style.setProperty('--gaze','0');

      // move original app back to body
      document.body.appendChild(plateApp);

      // clear right eye
      eyeInnerR.innerHTML = '';
    }

    btnCardboard.addEventListener('click', ()=>{
      if (!cardboardOn) enableCardboard();
      else disableCardboard();
    });

    // ===============================
    // SHOOT: click nearest target around center of LEFT EYE
    // ===============================
    const TARGET_SEL = [
      '.pl-target',        // ‚úÖ Plate targets
      '.plate-target',
      '.hha-target',
      '.hvr-target',
      '[data-target]',
      '[data-kind]',
      '.target'
    ].join(',');

    function shootAtCenter(){
      const host = cardboardOn ? eyeInnerL : document;
      const targets = host.querySelectorAll(TARGET_SEL);
      if (!targets || !targets.length) return;

      const eyeRect = cardboardOn
        ? document.getElementById('eyeL').getBoundingClientRect()
        : { left:0, top:0, width:innerWidth, height:innerHeight };

      const cx = eyeRect.left + eyeRect.width/2;
      const cy = eyeRect.top + eyeRect.height/2;

      let best=null, bestD=1e18, bestRect=null;

      for (const t of targets){
        const r = t.getBoundingClientRect();
        if (r.width <= 0 || r.height <= 0) continue;
        const tx = r.left + r.width/2;
        const ty = r.top + r.height/2;
        const dx = tx - cx, dy = ty - cy;
        const d2 = dx*dx + dy*dy;
        if (d2 < bestD){ bestD = d2; best = t; bestRect = r; }
      }

      if (!best) return;

      const thr = Math.max(28, (bestRect ? bestRect.width * 0.65 : 44));
      if (bestD > thr*thr) return;

      try{
        best.dispatchEvent(new PointerEvent('pointerdown', { bubbles:true, cancelable:true, pointerId: 1 }));
      }catch{
        try{ best.click(); }catch{}
      }
    }

    btnShoot.addEventListener('click', ()=> shootAtCenter());

    // ===============================
    // GAZE dwell: 0.62s
    // ===============================
    function setGazeFill(v){
      v = Math.max(0, Math.min(1, v));
      D.documentElement.style.setProperty('--gaze', String(v));
    }
    let gazeFill=0, last=0;
    function gazeLoop(t){
      const dt = Math.min(0.05, Math.max(0.001, (t - (last||t))/1000));
      last = t;

      if (cardboardOn && gazeOn){
        const dwell = 0.62;
        gazeFill += dt / dwell;
        if (gazeFill >= 1){
          gazeFill = 0;
          shootAtCenter();
        }
        setGazeFill(gazeFill);
      } else {
        gazeFill = 0;
        setGazeFill(0);
      }
      requestAnimationFrame(gazeLoop);
    }
    requestAnimationFrame(gazeLoop);

    btnGaze.addEventListener('click', ()=>{
      if (!cardboardOn) enableCardboard();
      gazeOn = !gazeOn;
      D.body.classList.toggle('gaze', gazeOn);
    });

  })();
  </script>
</body>
</html>