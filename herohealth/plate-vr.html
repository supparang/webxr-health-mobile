<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Enter VR / Cardboard) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + Logger + HUD Binder (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>
  <script src="./vr/hha-hud.js" defer></script>

  <!-- UI CSS -->
  <link rel="stylesheet" href="./plate/plate-vr.css?v=20251229" />

  <!-- Plate SAFE (IIFE) -->
  <script src="./plate/plate.safe.js?v=20251229" defer></script>
</head>

<body>

  <!-- A-Frame scene (‡∏≠‡∏¢‡∏π‡πà ‚Äú‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î‚Äù) -->
  <a-scene
    embedded
    vr-mode-ui="enabled: true"
    renderer="antialias: true; alpha: true"
    style="position:fixed; inset:0; z-index:0;"
  >
    <a-entity id="rig" position="0 1.6 0">
      <a-camera wasd-controls-enabled="false" look-controls-enabled="true"></a-camera>
    </a-entity>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- DOM play layer (‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) -->
  <div id="plate-layer" class="plate-layer" aria-label="Plate play layer"></div>

  <!-- Hit FX overlay (plate.safe.js ‡∏à‡∏∞ pulse ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ) -->
  <div id="hitFx" class="hha-hitfx" aria-hidden="true"></div>

  <!-- HUD TOP (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô exclusion safe-zone ‡∏î‡πâ‡∏ß‡∏¢) -->
  <div id="hudTop" class="hudTop">
    <div class="hudRow">
      <div class="hudPill">
        <div class="hudLbl">‚è±Ô∏è</div>
        <div class="hudVal" id="hudTime">90</div>
      </div>

      <div class="hudPill">
        <div class="hudLbl">üèÜ</div>
        <div class="hudVal" id="hudScore">0</div>
      </div>

      <div class="hudPill">
        <div class="hudLbl">üî•</div>
        <div class="hudVal" id="hudCombo">0</div>
        <div class="hudSub">max <span id="hudComboMax">0</span></div>
      </div>

      <div class="hudPill danger">
        <div class="hudLbl">‚ùå</div>
        <div class="hudVal" id="hudMiss">0</div>
      </div>

      <div class="hudPill plate">
        <div class="hudLbl">üçΩÔ∏è</div>
        <div class="hudVal"><span id="plateHave">0</span>/<span id="plateTotal">5</span></div>
        <div class="hudSub">‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
      </div>
    </div>

    <!-- Fever / Shield bar (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ HUD binder ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) -->
    <div class="barRow">
      <div class="barWrap">
        <div class="barLbl">FEVER</div>
        <div class="bar">
          <div class="barFill" id="feverFill" style="width:0%"></div>
        </div>
        <div class="barTxt"><span id="feverVal">0</span>%</div>
      </div>
      <div class="shieldWrap">
        <div class="shieldIcon" id="shieldIcon" title="Shield">üõ°Ô∏è</div>
        <div class="shieldTxt" id="shieldTxt">0</div>
      </div>
    </div>
  </div>

  <!-- HUD Buttons (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô exclusion safe-zone ‡∏î‡πâ‡∏ß‡∏¢) -->
  <div id="hudBtns" class="hudBtns">
    <button id="btnPause" class="btn ghost" type="button">‚è∏Ô∏è ‡∏û‡∏±‡∏Å</button>
    <button id="btnEnterVR" class="btn" type="button">üï∂Ô∏è Enter VR</button>
    <button id="btnRestart" class="btn warn" type="button">üîÑ Restart</button>
    <button id="btnBackHub" class="btn danger" type="button">üè† HUB</button>
  </div>

  <!-- Quest / Mini Panel (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô exclusion safe-zone ‡∏î‡πâ‡∏ß‡∏¢) -->
  <div id="miniPanel" class="miniPanel">
    <div class="qBlock">
      <div class="qTitle">üéØ GOAL</div>
      <div class="qMain" id="goalTitle">‚Äî</div>
      <div class="qMeta"><span id="goalCount">0/0</span></div>
    </div>

    <div class="qBlock">
      <div class="qTitle">‚ö° MINI</div>
      <div class="qMain" id="miniTitle">‚Äî</div>
      <div class="qMeta">
        <span id="miniCount">0/0</span>
        <span class="dot">‚Ä¢</span>
        <span id="miniTimer">00.0</span>
      </div>
      <div class="qHint" id="miniHint"> </div>
    </div>
  </div>

  <!-- Coach panel (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô exclusion safe-zone ‡∏î‡πâ‡∏ß‡∏¢) -->
  <div id="coachPanel" class="coachPanel">
    <img
      id="coachImg"
      class="coachImg"
      src="./img/coach-neutral.png"
      alt="Coach"
      loading="lazy"
    />
    <div class="coachText" id="coachText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üòä</div>
  </div>

  <!-- Paused badge -->
  <div id="hudPaused" class="pausedBadge" style="display:none;">‚è∏Ô∏è PAUSED</div>

  <!-- Start Overlay -->
  <div id="startOverlay" class="startOverlay">
    <div class="startCard">
      <div class="startTitle">üçΩÔ∏è Balanced Plate VR</div>
      <div class="startSub">
        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà + ‡∏ó‡∏≥ Goal/Mini ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô<br/>
        <span class="muted">Tip: ‚≠ê ‡∏™‡∏∞‡∏™‡∏° 2 ‡∏î‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ OVERDRIVE x2</span>
      </div>

      <div class="startGrid">
        <div class="startPill">
          <div class="pillK">‡πÇ‡∏´‡∏°‡∏î</div>
          <div class="pillV"><span id="uiRunMode">play / research</span> (‡πÉ‡∏ä‡πâ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå URL)</div>
        </div>
        <div class="startPill">
          <div class="pillK">diff</div>
          <div class="pillV"><span id="uiDiff">easy/normal/hard</span></div>
        </div>
        <div class="startPill">
          <div class="pillK">time</div>
          <div class="pillV"><span id="uiTime">30‚Äì600</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        </div>
        <div class="startPill">
          <div class="pillK">seed</div>
          <div class="pillV"><span id="uiSeed">auto</span></div>
        </div>
      </div>

      <button id="btnStart" class="btnStart" type="button">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>

      <div class="startFoot">
        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL:
        <code>?run=play&diff=normal&time=70</code>
        ‡∏´‡∏£‡∏∑‡∏≠
        <code>?run=research&diff=hard&time=70&seed=123</code>
      </div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div id="resultBackdrop" class="resultBackdrop" style="display:none;">
    <div class="resultCard">
      <div class="resultTop">
        <div class="resultTitle">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div class="resultBadge">
          <span id="rMode">play</span>
          <span class="sep">‚Ä¢</span>
          Grade <b id="rGrade">C</b>
        </div>
      </div>

      <div class="resultGrid">
        <div class="stat">
          <div class="k">Score</div>
          <div class="v" id="rScore">0</div>
        </div>
        <div class="stat">
          <div class="k">Max Combo</div>
          <div class="v" id="rMaxCombo">0</div>
        </div>
        <div class="stat danger">
          <div class="k">Miss</div>
          <div class="v" id="rMiss">0</div>
        </div>
        <div class="stat">
          <div class="k">Fast Hit</div>
          <div class="v" id="rPerfect">0</div>
        </div>

        <div class="stat wide">
          <div class="k">Goals</div>
          <div class="v"><span id="rGoals">0/0</span></div>
        </div>
        <div class="stat wide">
          <div class="k">Minis</div>
          <div class="v"><span id="rMinis">0/0</span></div>
        </div>

        <div class="plateBox">
          <div class="plateHdr">üçΩÔ∏è Plate (5 ‡∏´‡∏°‡∏π‡πà)</div>
          <div class="plateRows">
            <div class="row"><span>ü•¶ ‡∏ú‡∏±‡∏Å</span> <b id="rG1">0</b></div>
            <div class="row"><span>üçé ‡∏ú‡∏•‡πÑ‡∏°‡πâ</span> <b id="rG2">0</b></div>
            <div class="row"><span>üçó ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span> <b id="rG3">0</b></div>
            <div class="row"><span>üçö ‡πÅ‡∏õ‡πâ‡∏á</span> <b id="rG4">0</b></div>
            <div class="row"><span>ü•ë ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</span> <b id="rG5">0</b></div>
          </div>
          <div class="plateSum">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="rGTotal">0</b></div>
        </div>
      </div>

      <div class="resultBtns">
        <button id="btnPlayAgain" class="btn" type="button">üîÅ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button id="btnBackHub2" class="btn danger" type="button">üè† ‡∏Å‡∏•‡∏±‡∏ö HUB</button>
      </div>

      <div class="resultNote muted">
        * ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <code>localStorage:HHA_LAST_SUMMARY</code>
      </div>
    </div>
  </div>

  <!-- Tiny glue: plate counter + quest/hud fallbacks (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) -->
  <script>
    // Plate counter (0/5) live
    window.addEventListener('hha:plate', (e) => {
      try {
        const d = (e && e.detail) || {};
        const have = (d.have ?? 0) | 0;
        const total = (d.total ?? 5) | 0;
        const a = document.getElementById('plateHave');
        const b = document.getElementById('plateTotal');
        if (a) a.textContent = have;
        if (b) b.textContent = total;
      } catch {}
    });

    // Quest panel minimal binder (‡∏ñ‡πâ‡∏≤ hha-hud.js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å)
    window.addEventListener('quest:update', (e) => {
      try {
        const d = (e && e.detail) || {};
        const gt = document.getElementById('goalTitle');
        const gc = document.getElementById('goalCount');
        const mt = document.getElementById('miniTitle');
        const mc = document.getElementById('miniCount');
        const tm = document.getElementById('miniTimer');
        const hint = document.getElementById('miniHint');

        if (gt) gt.textContent = d.goalTitle || '‚Äî';
        if (gc) gc.textContent = ((d.goalNow|0) + '/' + (d.goalTotal|0));
        if (mt) mt.textContent = d.miniTitle || '‚Äî';
        if (mc) mc.textContent = ((d.miniNow|0) + '/' + (d.miniTotal|0));

        const left = (d.miniLeftMs|0);
        if (tm) tm.textContent = left ? (Math.max(0,left)/1000).toFixed(1) : '‚Äî';
        if (hint) hint.textContent = (d.extra && d.extra.hint) ? d.extra.hint : '';
      } catch {}
    });

    // Score/time minimal binder (‡∏ñ‡πâ‡∏≤ hha-hud.js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å)
    window.addEventListener('hha:score', (e) => {
      try {
        const d = (e && e.detail) || {};
        const s = document.getElementById('hudScore');
        const c = document.getElementById('hudCombo');
        const m = document.getElementById('hudComboMax');
        const x = document.getElementById('hudMiss');
        if (s) s.textContent = (d.score|0);
        if (c) c.textContent = (d.combo|0);
        if (m) m.textContent = (d.comboMax|0);
        if (x) x.textContent = (d.misses|0);
      } catch {}
    });
    window.addEventListener('hha:time', (e) => {
      try {
        const d = (e && e.detail) || {};
        const t = document.getElementById('hudTime');
        if (t) t.textContent = (d.left|0);
      } catch {}
    });
    window.addEventListener('hha:coach', (e) => {
      try {
        const d = (e && e.detail) || {};
        const img = document.getElementById('coachImg');
        const txt = document.getElementById('coachText');
        if (txt && d.text) txt.textContent = d.text;

        if (img && d.mood) {
          const mood = String(d.mood);
          const map = {
            happy: './img/coach-happy.png',
            sad: './img/coach-sad.png',
            fever: './img/coach-fever.png',
            neutral: './img/coach-neutral.png'
          };
          img.src = map[mood] || map.neutral;
        }
      } catch {}
    });
    window.addEventListener('hha:fever', (e) => {
      try {
        const d = (e && e.detail) || {};
        const v = Math.max(0, Math.min(100, (d.fever|0)));
        const fill = document.getElementById('feverFill');
        const val = document.getElementById('feverVal');
        const shieldTxt = document.getElementById('shieldTxt');
        if (fill) fill.style.width = v + '%';
        if (val) val.textContent = v;
        if (shieldTxt) shieldTxt.textContent = (d.shield|0);
      } catch {}
    });

    // Result "Back HUB" button inside overlay
    document.addEventListener('click', (ev) => {
      const id = ev && ev.target && ev.target.id;
      if (id === 'btnBackHub2') {
        try { (window.PlateBoot && PlateBoot.goHub) ? PlateBoot.goHub() : (location.href = './hub.html'); } catch {}
      }
    });
  </script>

</body>
</html>