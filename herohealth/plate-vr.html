<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + input compat + logger (defer ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.55);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); overflow:hidden;}
    a-scene{position:fixed; inset:0;}

    /* ===== HUD (PLAY: compact) ===== */
    #hudTop{
      position:fixed; left:10px; right:10px; top:10px;
      z-index:900;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    .hudBar{
      width:min(820px, calc(100vw - 20px));
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:10px 10px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.35);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .hudCluster{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:baseline;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      font-weight:1000;
      white-space:nowrap;
      min-width:0;
    }
    .k{color:var(--muted); font-weight:900; font-size:12px;}
    .v{font-size:16px; font-weight:1000;}

    /* fever pill: small bar */
    .feverWrap{display:inline-flex; gap:8px; align-items:center;}
    .feverBar{
      width:86px; height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.16);
      border:1px solid rgba(148,163,184,.18);
      overflow:hidden;
      position:relative;
      top:1px;
    }
    .feverFill{
      height:100%;
      width:0%;
      transform-origin:left;
      transform:scaleX(0);
      background:rgba(250,204,21,.78);
      filter: drop-shadow(0 0 10px rgba(250,204,21,.18));
      transition: transform .12s linear;
    }

    /* ===== Buttons ===== */
    #hudBtns{
      position:fixed; right:10px; bottom:10px;
      z-index:910;
      display:flex; gap:10px;
      pointer-events:auto;
    }
    .btn{
      pointer-events:auto;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      box-shadow:0 16px 36px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .btn:active{transform:translateY(1px);}

    /* ===== Mini/Goal compact strip ===== */
    #miniPanel{
      position:fixed; left:10px; right:10px; bottom:64px;
      z-index:905;
      pointer-events:auto; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢ hint ‡πÑ‡∏î‡πâ */
      background:rgba(2,6,23,.62);
      border:1px solid rgba(148,163,184,.20);
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.35);
      max-width: min(820px, calc(100vw - 20px));
      margin: 0 auto;
    }
    #miniLine{font-weight:1000;}
    #goalLine{margin-top:6px; color:rgba(229,231,235,.90); font-weight:900;}
    #miniHint{
      margin-top:6px;
      color:rgba(148,163,184,.92);
      font-weight:900;
      font-size:13px;
      line-height:1.25;
      display:none;
    }
    #miniPanel.showHint #miniHint{display:block;}

    /* urgent highlight */
    body.hha-mini-urgent #miniPanel{
      border-color: rgba(250,204,21,.55)!important;
      box-shadow:0 18px 46px rgba(0,0,0,.35), 0 0 30px rgba(250,204,21,.12);
    }

    /* paused helper */
    #hudPaused{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      z-index:980;
      display:none;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.25);
      font-weight:1000;
      pointer-events:none;
      backdrop-filter: blur(10px);
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }

    /* ===== Stats Drawer (optional) ===== */
    #statsDrawer{
      position:fixed;
      left:10px; right:10px; top:74px;
      z-index:899;
      display:none;
      pointer-events:none;
      justify-content:center;
    }
    #statsDrawer .card{
      width:min(820px, calc(100vw - 20px));
      background:rgba(2,6,23,.70);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 44px rgba(0,0,0,.35);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    #statsDrawer.show{ display:flex; }

    /* ===== Result overlay ===== */
    #resultBackdrop{
      position:fixed; inset:0; z-index:1200;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    #resultCard{
      width:min(680px,92vw);
      background:rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow:0 26px 80px rgba(0,0,0,.55);
    }
    .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:12px;}
    .cell{background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px;}
    .cell .k{display:block; margin-bottom:4px;}

    /* ===== Mobile tune ===== */
    @media (max-width: 430px){
      .hudBar{ padding:9px 9px; gap:8px; }
      .pill{ padding:7px 9px; }
      .k{ font-size:11px; }
      .v{ font-size:15px; }
      .feverBar{ width:72px; }
      #miniPanel{ bottom:62px; }
      #hudBtns{ gap:8px; }
      .btn{ padding:9px 10px; border-radius:13px; }
    }
  </style>

  <!-- ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå plate/ -->
  <script type="module" src="./plate/plate.safe.js"></script>
</head>

<body>
  <a-scene embedded vr-mode-ui="enabled: false">
    <a-entity id="cam" camera look-controls position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- HUD (PLAY compact) -->
  <div id="hudTop">
    <div class="hudBar">
      <div class="hudCluster" id="hudLeftGroup">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span id="hudTime" class="v">0</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span id="hudScore" class="v">0</span></span>
        <span class="pill">‚ö° <span class="k">COMBO</span> <span id="hudCombo" class="v">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span id="hudMiss" class="v">0</span></span>
      </div>

      <div class="hudCluster" id="hudRightGroup" style="justify-content:flex-end;">
        <span class="pill">
          üî• <span class="k">FEVER</span>
          <span class="feverWrap">
            <span id="hudFeverPct" class="v">0%</span>
            <span class="feverBar"><span id="hudFeverFill" class="feverFill"></span></span>
          </span>
        </span>
        <span class="pill">üçΩÔ∏è <span class="k">PLATE</span> <span id="hudGroupsHave" class="v">0/5</span></span>
      </div>
    </div>
  </div>

  <!-- Optional stats drawer (toggle by STATS button) -->
  <div id="statsDrawer">
    <div class="card">
      <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span id="hudGrade" class="v">C</span></span>
      <span class="pill">‚≠ê <span class="k">PERF</span> <span id="hudPerfectCount" class="v">0</span></span>
      <span class="pill">üß™ <span class="k">MODE</span> <span id="hudMode" class="v">Play</span></span>
      <span class="pill">üéöÔ∏è <span class="k">DIFF</span> <span id="hudDiff" class="v">Easy</span></span>
    </div>
  </div>

  <!-- Mini/Goal -->
  <div id="miniPanel" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Hint">
    <div id="miniLine">MINI: ‚Ä¶</div>
    <div id="goalLine">Goal: ‚Ä¶</div>
    <div id="miniHint">‚Ä¶</div>
  </div>

  <!-- Buttons -->
  <div id="hudBtns">
    <button class="btn" id="btnEnterVR">üï∂Ô∏è VR</button>
    <button class="btn" id="btnStats">üìä STATS</button>
    <button class="btn" id="btnPause">‚è∏Ô∏è PAUSE</button>
    <button class="btn" id="btnRestart">üîÅ RESTART</button>
  </div>

  <div id="hudPaused">‚è∏Ô∏è PAUSED</div>

  <!-- Result -->
  <div id="resultBackdrop">
    <div id="resultCard">
      <div style="font-weight:1100; font-size:20px">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏Å‡∏° (Plate VR)</div>
      <div style="color:rgba(148,163,184,.95); font-weight:900; margin-top:6px">
        Mode: <span id="rMode">‚Äî</span> ‚Ä¢ Grade: <span id="rGrade">‚Äî</span>
      </div>

      <div class="grid">
        <div class="cell"><span class="k">Score</span><span id="rScore" class="v">0</span></div>
        <div class="cell"><span class="k">Max Combo</span><span id="rMaxCombo" class="v">0</span></div>
        <div class="cell"><span class="k">Miss</span><span id="rMiss" class="v">0</span></div>
        <div class="cell"><span class="k">Perfect</span><span id="rPerfect" class="v">0</span></div>
        <div class="cell"><span class="k">Goals</span><span id="rGoals" class="v">0/2</span></div>
        <div class="cell"><span class="k">Minis</span><span id="rMinis" class="v">0/7</span></div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));">
        <div class="cell"><span class="k">G1</span><span id="rG1" class="v">0</span></div>
        <div class="cell"><span class="k">G2</span><span id="rG2" class="v">0</span></div>
        <div class="cell"><span class="k">G3</span><span id="rG3" class="v">0</span></div>
        <div class="cell"><span class="k">G4</span><span id="rG4" class="v">0</span></div>
        <div class="cell"><span class="k">G5</span><span id="rG5" class="v">0</span></div>
        <div class="cell"><span class="k">Total</span><span id="rGTotal" class="v">0</span></div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
        <button class="btn" id="btnPlayAgain">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Tiny HUD helpers -->
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      // toggle mini hint
      const mini = $('miniPanel');
      if (mini){
        mini.addEventListener('click', ()=>{
          mini.classList.toggle('showHint');
        });
      }

      // toggle stats drawer
      const btnStats = $('btnStats');
      const drawer = $('statsDrawer');
      if (btnStats && drawer){
        btnStats.addEventListener('click', ()=>{
          drawer.classList.toggle('show');
        });
      }

      // fever bar sync (plate.safe.js ‡∏à‡∏∞ set #hudFeverPct ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      const feverPct = $('hudFeverPct');
      const feverFill = $('hudFeverFill');
      if (feverPct && feverFill){
        const obs = new MutationObserver(()=>{
          const m = (feverPct.textContent||'0').replace('%','').trim();
          const v = Math.max(0, Math.min(100, parseFloat(m)||0));
          feverFill.style.transform = 'scaleX('+(v/100)+')';
        });
        obs.observe(feverPct, {childList:true, characterData:true, subtree:true});
        // init
        feverFill.style.transform = 'scaleX(0)';
      }
    })();
  </script>
</body>
</html>