<!-- === /herohealth/plate-vr.html ===
Plate VR (PRODUCTION) ‚Äî Full HTML
‚úÖ Start Overlay (start-gated)
‚úÖ HUD + Crosshair + FX overlays
‚úÖ Coach panel (uses /img/coach-*.png)
‚úÖ Result overlay + Back HUB + Play again
‚úÖ CARDBOARD MODE: 2-eye split + gaze/fuse (fast) + recenter
‚úÖ Works with /plate/plate.safe.js + /plate/plate.state.js
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HeroHealth ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Global FX + input compat + logger -->
  <script src="./vr/particles.js" defer></script>
  <script src="./vr/hha-compat-input.js" defer></script>
  <script src="./vr/hha-cloud-logger.js" defer></script>

  <style>
    :root{
      --bg:#020617;
      --panel:rgba(2,6,23,.62);
      --panel2:rgba(15,23,42,.58);
      --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --gazeProg:0; /* 0..1 */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); overflow:hidden;}
    a-scene{position:fixed; inset:0;}

    /* ===== Start Overlay ===== */
    #startOverlay{
      position:fixed; inset:0; z-index:1400;
      display:flex; align-items:center; justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    #startCard{
      width:min(720px,92vw);
      background:rgba(2,6,23,.82);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow:0 26px 80px rgba(0,0,0,.55);
    }
    #startTitle{font-weight:1100; font-size:20px;}
    #startDesc{color:rgba(148,163,184,.95); font-weight:900; margin-top:8px; line-height:1.35;}
    #startBtns{display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap;}

    /* ===== Minimal HUD ===== */
    #hudTop{
      position:fixed; left:10px; right:10px; top:10px;
      z-index:900; pointer-events:none;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .hudCard{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
      display:flex; gap:8px; align-items:center;
      pointer-events:none;
      min-width: 0;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:baseline;
      padding:7px 10px; border-radius:999px;
      background:rgba(15,23,42,.48);
      border:1px solid rgba(148,163,184,.16);
      font-weight:900;
      white-space:nowrap;
    }
    .k{color:var(--muted); font-weight:900; font-size:11px;}
    .v{font-size:15px; font-weight:1000;}
    #hudLeftGroup{display:flex; gap:8px; flex-wrap:wrap;}
    #hudRightGroup{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    /* ===== Crosshair ===== */
    #crosshair{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      z-index:420;
      width:14px; height:14px;
      border-radius:999px;
      pointer-events:none;
      box-shadow:
        0 0 0 2px rgba(229,231,235,.28),
        0 0 22px rgba(34,197,94,.10);
      background:rgba(229,231,235,.07);
      backdrop-filter: blur(6px);
    }
    #crosshair::after{
      content:'';
      position:absolute; inset:4px;
      border-radius:999px;
      background:rgba(229,231,235,.45);
    }

    /* ===== Hit flash overlay ===== */
    #hitFx{
      position:fixed; inset:0;
      z-index:850;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(circle at 50% 50%, rgba(2,6,23,0) 35%, rgba(2,6,23,.35) 70%, rgba(2,6,23,.65) 100%);
      transition: opacity .08s linear;
    }
    #hitFx.show{ opacity:1; }
    #hitFx[data-kind="bad"]{
      background:
        radial-gradient(circle at 50% 50%, rgba(251,113,133,0) 35%, rgba(251,113,133,.18) 70%, rgba(2,6,23,.70) 100%);
    }
    #hitFx[data-kind="boss"]{
      background:
        radial-gradient(circle at 50% 50%, rgba(248,113,113,0) 35%, rgba(248,113,113,.22) 70%, rgba(2,6,23,.74) 100%);
    }
    #hitFx[data-kind="good"]{
      background:
        radial-gradient(circle at 50% 50%, rgba(34,197,94,0) 35%, rgba(34,197,94,.14) 70%, rgba(2,6,23,.70) 100%);
    }
    #hitFx[data-kind="gold"]{
      background:
        radial-gradient(circle at 50% 50%, rgba(250,204,21,0) 35%, rgba(250,204,21,.16) 70%, rgba(2,6,23,.70) 100%);
    }

    /* ===== Buttons ===== */
    #hudBtns{
      position:fixed; right:10px; bottom:10px;
      z-index:910; display:flex; gap:10px;
    }
    .btn{
      pointer-events:auto;
      background:rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.20);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      box-shadow:0 16px 36px rgba(0,0,0,.30);
      backdrop-filter: blur(8px);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px);}

    /* Cardboard shoot pad */
    #shootPad{
      position:fixed;
      left:50%;
      bottom:10px;
      transform:translateX(-50%);
      z-index:915;
      display:none;
      pointer-events:auto;
    }
    body.cardboard #shootPad{ display:block; }
    #btnShoot{
      padding:14px 18px;
      border-radius:18px;
      font-size:16px;
      font-weight:1100;
      box-shadow:0 18px 44px rgba(0,0,0,.36);
    }
    body.cardboard #hudBtns{ bottom:76px; }
    body.cardboard #btnEnterVR{ display:none; }
    body.cardboard #coachPanel{ bottom:210px; }

    /* ===== Mini/Goal panel ===== */
    #miniPanel{
      position:fixed; left:10px; right:10px; bottom:64px;
      z-index:905;
      pointer-events:none;
      background:rgba(2,6,23,.58);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
    }
    #miniLine{font-weight:1000;}
    #goalLine{margin-top:6px; color:rgba(229,231,235,.88); font-weight:900;}
    #miniHint{margin-top:6px; color:rgba(148,163,184,.92); font-weight:900; font-size:13px; line-height:1.25;}

    #hudPaused{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      z-index:980;
      display:none;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(2,6,23,.75);
      border:1px solid rgba(148,163,184,.25);
      font-weight:1000;
      pointer-events:none;
    }

    /* ===== Coach panel ===== */
    #coachPanel{
      position:fixed;
      left:10px;
      bottom:170px;
      z-index:906;
      width:min(360px,56vw);
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(2,6,23,.58);
      border:1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(8px);
      box-shadow:0 18px 44px rgba(0,0,0,.30);
      pointer-events:none;
    }
    #coachImg{
      width:54px; height:54px;
      border-radius:14px;
      object-fit:cover;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      box-shadow:0 10px 26px rgba(0,0,0,.28);
      flex:0 0 auto;
    }
    #coachMsg{
      font-weight:1000;
      line-height:1.2;
      color:rgba(229,231,235,.92);
      word-break: break-word;
    }

    /* Result overlay */
    #resultBackdrop{
      position:fixed; inset:0; z-index:1200;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    #resultCard{
      width:min(760px,92vw);
      background:rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      padding:16px;
      box-shadow:0 26px 80px rgba(0,0,0,.55);
    }
    .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:12px;}
    .cell{background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.16); border-radius:16px; padding:10px 12px;}
    .cell .k{display:block; margin-bottom:4px;}
    #resultActions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap;}

    /* =========================================================
       Cardboard split-screen + Gaze ring (overlay)
       ========================================================= */
    #cbWrap{
      position:fixed; inset:0;
      display:none;
      z-index:2000; /* above everything */
      background:#000;
    }
    body.cardboard #cbWrap{ display:flex; }

    .cbEye{
      position:relative;
      flex:1;
      overflow:hidden;
      border-left: 1px solid rgba(255,255,255,.06);
    }
    .cbEye:first-child{ border-left:none; }

    .cbViewport{
      position:absolute; inset:10px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.12);
      overflow:hidden;
      background: rgba(2,6,23,.25);
    }

    /* We don't duplicate A-Frame render; we show one scene full-screen behind.
       The split overlay is for Cardboard feel + gaze. (true stereo would be WebXR VR mode) */
    body.cardboard a-scene{ opacity:1; }

    .gazeRing{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:56px; height:56px;
      border-radius:999px;
      background:
        conic-gradient(rgba(34,197,94,.95) calc(var(--gazeProg)*360deg),
                       rgba(148,163,184,.18) 0deg);
      -webkit-mask: radial-gradient(circle at 50% 50%, transparent 62%, #000 64%);
      mask: radial-gradient(circle at 50% 50%, transparent 62%, #000 64%);
      filter: drop-shadow(0 0 14px rgba(34,197,94,.22));
      pointer-events:none;
      opacity:.95;
    }
    .gazeRet{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:30px; height:30px;
      border-radius:999px;
      border:2px solid rgba(229,231,235,.58);
      box-shadow: 0 0 0 10px rgba(2,6,23,.35);
      pointer-events:none;
    }
    .gazeRet::after{
      content:'';
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(34,211,238,.95);
      box-shadow: 0 0 12px rgba(34,211,238,.35);
    }

    #cbControls{
      position:fixed;
      left:50%;
      bottom: calc(10px + env(safe-area-inset-bottom,0px));
      transform:translateX(-50%);
      z-index:2100;
      display:none;
      gap:10px;
    }
    body.cardboard #cbControls{ display:flex; }
    .cbBtn{
      pointer-events:auto;
      background:rgba(2,6,23,.70);
      border:1px solid rgba(148,163,184,.20);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1100;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      -webkit-tap-highlight-color: transparent;
    }
  </style>

  <!-- ‚úÖ plate.safe.js -->
  <script type="module" src="./plate/plate.safe.js"></script>
</head>

<body>
  <a-scene embedded vr-mode-ui="enabled: false">
    <a-entity id="cam" camera look-controls position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- overlays -->
  <div id="hitFx"></div>
  <div id="crosshair" aria-hidden="true"></div>

  <!-- Cardboard split overlay (2 eyes) -->
  <div id="cbWrap" aria-hidden="true">
    <div class="cbEye">
      <div class="cbViewport">
        <div class="gazeRing"></div>
        <div class="gazeRet"></div>
      </div>
    </div>
    <div class="cbEye">
      <div class="cbViewport">
        <div class="gazeRing"></div>
        <div class="gazeRet"></div>
      </div>
    </div>
  </div>
  <div id="cbControls">
    <button class="cbBtn" id="cbExit" type="button">‚¨Ö Exit Cardboard</button>
    <button class="cbBtn" id="cbRecenter" type="button">üéØ Recenter</button>
  </div>

  <!-- START overlay -->
  <div id="startOverlay">
    <div id="startCard">
      <div id="startTitle">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô Plate VR?</div>
      <div id="startDesc">
        ‡πÅ‡∏ï‡∏∞ ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
        * ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Motion ‡∏¢‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡∏∞‡∏¢‡∏¥‡∏á + ‡∏•‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á)
      </div>
      <div id="startBtns">
        <button class="btn" id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div id="hudTop">
    <div class="hudCard" style="flex:1">
      <div id="hudLeftGroup">
        <span class="pill">‚è±Ô∏è <span class="k">TIME</span> <span id="hudTime" class="v">0</span></span>
        <span class="pill">üèÜ <span class="k">SCORE</span> <span id="hudScore" class="v">0</span></span>
        <span class="pill">‚ö° <span class="k">COMBO</span> <span id="hudCombo" class="v">0</span></span>
        <span class="pill">üí• <span class="k">MISS</span> <span id="hudMiss" class="v">0</span></span>
        <span class="pill">üçΩÔ∏è <span class="k">PLATE</span> <span id="hudGroupsHave" class="v">0/5</span></span>
      </div>
    </div>

    <div class="hudCard" style="flex:0 0 auto">
      <div id="hudRightGroup">
        <span class="pill">üî• <span class="k">FEVER</span> <span id="hudFeverPct" class="v">0%</span></span>
        <span class="pill">üéñÔ∏è <span class="k">GRADE</span> <span id="hudGrade" class="v">C</span></span>

        <span class="pill" style="display:none">‚≠ê <span class="k">PERF</span> <span id="hudPerfectCount" class="v">0</span></span>
        <span class="pill" style="display:none">üß™ <span class="k">MODE</span> <span id="hudMode" class="v">Play</span></span>
        <span class="pill" style="display:none">üéöÔ∏è <span class="k">DIFF</span> <span id="hudDiff" class="v">Normal</span></span>
      </div>
    </div>
  </div>

  <div id="miniPanel">
    <div id="miniLine">MINI: ‚Ä¶</div>
    <div id="goalLine">Goal: ‚Ä¶</div>
    <div id="miniHint">‚Ä¶</div>
  </div>

  <!-- Coach -->
  <div id="coachPanel">
    <img id="coachImg" src="./img/coach-neutral.png" alt="Coach" />
    <div id="coachMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà üí™</div>
  </div>

  <div id="hudBtns">
    <button class="btn" id="btnCardboard">üì¶ CARDBOARD</button>
    <button class="btn" id="btnEnterVR">üï∂Ô∏è ENTER VR</button>
    <button class="btn" id="btnPause">‚è∏Ô∏è PAUSE</button>
    <button class="btn" id="btnRestart">üîÅ RESTART</button>
  </div>

  <div id="shootPad">
    <button class="btn" id="btnShoot">üéØ SHOOT</button>
  </div>

  <div id="hudPaused">‚è∏Ô∏è PAUSED</div>

  <!-- Result -->
  <div id="resultBackdrop">
    <div id="resultCard">
      <div style="font-weight:1100; font-size:20px">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏Å‡∏° (Plate VR)</div>
      <div style="color:rgba(148,163,184,.95); font-weight:900; margin-top:6px">
        Mode: <span id="rMode">‚Äî</span> ‚Ä¢ Grade: <span id="rGrade">‚Äî</span>
      </div>

      <div class="grid">
        <div class="cell"><span class="k">Score</span><span id="rScore" class="v">0</span></div>
        <div class="cell"><span class="k">Max Combo</span><span id="rMaxCombo" class="v">0</span></div>
        <div class="cell"><span class="k">Miss</span><span id="rMiss" class="v">0</span></div>
        <div class="cell"><span class="k">Perfect</span><span id="rPerfect" class="v">0</span></div>
        <div class="cell"><span class="k">Goals</span><span id="rGoals" class="v">0/2</span></div>
        <div class="cell"><span class="k">Minis</span><span id="rMinis" class="v">0/7</span></div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));">
        <div class="cell"><span class="k">G1</span><span id="rG1" class="v">0</span></div>
        <div class="cell"><span class="k">G2</span><span id="rG2" class="v">0</span></div>
        <div class="cell"><span class="k">G3</span><span id="rG3" class="v">0</span></div>
        <div class="cell"><span class="k">G4</span><span id="rG4" class="v">0</span></div>
        <div class="cell"><span class="k">G5</span><span id="rG5" class="v">0</span></div>
        <div class="cell"><span class="k">Total</span><span id="rGTotal" class="v">0</span></div>
      </div>

      <div id="resultActions">
        <button class="btn" id="btnBackHub">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ HUB</button>
        <button class="btn" id="btnPlayAgain">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       Cardboard + Gaze driver (NO plate.safe.js edits)
       - Split overlay 2 eyes
       - Gaze fuse: try click nearest target-like element near center
         fallback => click btnShoot
       ========================================================= -->
  <script>
  (function(){
    'use strict';
    const D = document;

    const qs = new URLSearchParams(location.search);
    const btnCard = D.getElementById('btnCardboard');
    const cbExit  = D.getElementById('cbExit');
    const cbRecenter = D.getElementById('cbRecenter');
    const btnShoot = D.getElementById('btnShoot');

    function clamp(v,a,b){ v=Number(v)||0; return Math.max(a, Math.min(b, v)); }
    function setProg(p){ D.documentElement.style.setProperty('--gazeProg', String(clamp(p,0,1))); }

    function enable(on){
      on = !!on;
      if (on) D.body.classList.add('cardboard');
      else D.body.classList.remove('cardboard');
      setProg(0);
      try{ localStorage.setItem('HHA_PLATE_CARDBOARD', on?'1':'0'); }catch(_){}
    }

    // auto
    try{
      const want = (qs.get('cardboard')==='1') || (localStorage.getItem('HHA_PLATE_CARDBOARD')==='1');
      if (want) enable(true);
    }catch(_){}

    btnCard?.addEventListener('click', ()=>enable(true), {passive:true});
    cbExit?.addEventListener('click', ()=>enable(false), {passive:true});

    cbRecenter?.addEventListener('click', ()=>{
      // best-effort: some engines keep look state on globals; reset common ones
      try{
        if (window.__HHA_LOOK__){
          window.__HHA_LOOK__.x = 0; window.__HHA_LOOK__.y = 0;
        }
      }catch(_){}
    }, {passive:true});

    // --- Target picking (best-effort) ---
    // Plate could be DOM targets or A-Frame hits; we try DOM first.
    const TARGET_SELECTORS = [
      '.plate-target',
      '.hha-target',
      '.target',
      '[data-kind]',
      '[data-target]',
      '[role="button"]'
    ];

    function centerPoint(){
      const w = window.innerWidth, h = window.innerHeight;
      return { x: w/2, y: h/2 };
    }

    function pickNearestTarget(cx, cy){
      let best = null;
      let bestD = Infinity;

      for (const sel of TARGET_SELECTORS){
        const nodes = D.querySelectorAll(sel);
        if (!nodes || !nodes.length) continue;

        for (const el of nodes){
          if (!(el instanceof HTMLElement)) continue;
          if (!el.isConnected) continue;
          const st = getComputedStyle(el);
          if (st.display === 'none' || st.visibility === 'hidden' || st.opacity === '0') continue;

          const r = el.getBoundingClientRect();
          if (r.width < 8 || r.height < 8) continue;

          const x = r.left + r.width/2;
          const y = r.top + r.height/2;
          const d = Math.hypot(x - cx, y - cy);
          if (d < bestD){
            bestD = d; best = el;
          }
        }
        if (best) break; // first selector wins
      }
      return { el: best, d: bestD };
    }

    function fireAt(el){
      if (!el) return false;
      try{
        const r = el.getBoundingClientRect();
        const ev = new PointerEvent('pointerdown', {
          bubbles:true, cancelable:true,
          clientX: r.left + r.width/2,
          clientY: r.top + r.height/2,
          pointerId: 1,
          pointerType: 'mouse'
        });
        el.dispatchEvent(ev);
        return true;
      }catch(_){
        try{ el.click(); return true; }catch(__){}
      }
      return false;
    }

    // --- Gaze loop (fast + accurate) ---
    const DWELL_MS = 320;     // faster
    const PICK_RADIUS = 92;   // accurate
    const DECAY = 1.8;

    let hold = 0;
    let lastT = 0;
    let locked = null;

    function loop(t){
      const dt = Math.min(60, Math.max(8, t - (lastT||t)));
      lastT = t;

      if (!D.body.classList.contains('cardboard')){
        hold = 0; locked = null; setProg(0);
        requestAnimationFrame(loop);
        return;
      }

      const c = centerPoint();

      // keep target if still near center
      if (locked && locked.isConnected){
        const rr = locked.getBoundingClientRect();
        const dx = (rr.left + rr.width/2) - c.x;
        const dy = (rr.top + rr.height/2) - c.y;
        const d = Math.hypot(dx, dy);
        if (d > PICK_RADIUS * 1.15) locked = null;
      } else {
        locked = null;
      }

      if (!locked){
        const pick = pickNearestTarget(c.x, c.y);
        if (pick.el && pick.d <= PICK_RADIUS) locked = pick.el;
      }

      if (locked){
        hold += dt;
        const p = hold / DWELL_MS;
        setProg(p);

        if (hold >= DWELL_MS){
          const ok = fireAt(locked);
          if (!ok && btnShoot) btnShoot.click(); // fallback
          hold = 0;
          locked = null;
          setProg(0);
        }
      } else {
        hold = Math.max(0, hold - dt*DECAY);
        setProg(hold / DWELL_MS);
      }

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
