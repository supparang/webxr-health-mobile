<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Particle FX + Fever (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö GoodJunk) -->
  <script src="./vr/ui-fever.js"></script>
  <script src="./vr/particles.js"></script>

  <style>
    :root{
      color-scheme: light dark;
      --bg-main:#020617;
      --panel:#020617;
      --panel-soft:#0b1120;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --danger:#f97316;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
    }
    *{ box-sizing:border-box; }

    /* ===== Start Countdown ===== */
    .countdown-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:655;
      font-size:clamp(3rem, 10vw, 5rem);
      font-weight:800;
      color:#fbbf24;
      text-shadow:0 0 40px rgba(0,0,0,0.85);
      pointer-events:none;
      transition:opacity .25s ease-out, transform .25s.ease-out;
    }
    .countdown-hidden{
      opacity:0;
      visibility:hidden;
      transform:scale(0.8);
    }

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.16), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.22), transparent 55%),
        var(--bg-main);
      color:var(--text-main);
      overflow:hidden;
    }

    /* ===== HUD ‡∏´‡∏•‡∏±‡∏Å ===== */
    .hud-root{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:650;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:10px 10px 14px;
    }

    .hud-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }

    .hud-card{
      background:linear-gradient(135deg, rgba(15,23,42,0.94), rgba(15,23,42,0.78));
      border-radius:18px;
      padding:8px 10px;
      box-shadow:0 18px 40px rgba(15,23,42,0.65);
      border:1px solid rgba(148,163,184,0.18);
      pointer-events:auto;
    }

    .hud-main{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .hud-main-title{
      font-size:14px;
      font-weight:600;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--text-soft);
    }
    .hud-main-mode{
      font-size:15px;
      font-weight:700;
    }
    .hud-pill{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,118,110,0.2);
      border:1px solid rgba(45,212,191,0.4);
      color:#a5f3fc;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .hud-metrics{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .metric{
      min-width:90px;
    }
    .metric-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--text-soft);
    }
    .metric-value{
      font-size:15px;
      font-weight:700;
      margin-top:2px;
    }
    .metric-value.accent{ color:var(--accent); }
    .metric-value.danger{ color:var(--danger); }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° stats ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Balanced Plate */
    .metric-small-label{
      font-size:10px;
      color:var(--text-soft);
    }

    /* ===== Grade bar (real-time) ===== */
    .metric-grade{
      min-width:120px;
      max-width:150px;
    }
    .grade-text{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:14px;
    }
    .grade-badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
    }
    .grade-bar{
      margin-top:2px;
      width:100%;
      height:4px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .grade-bar-fill{
      width:10%;
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#4ade80);
      transition:width .25s ease-out, background .25s.ease-out, box-shadow .25s.ease-out;
      box-shadow:0 0 0 0 rgba(34,197,94,0.6);
    }
    .grade-bar-fill[data-grade="C"]{
      background:linear-gradient(90deg,#6b7280,#9ca3af);
    }
    .grade-bar-fill[data-grade="B"]{
      background:linear-gradient(90deg,#22c55e,#16a34a);
    }
    .grade-bar-fill[data-grade="A"]{
      background:linear-gradient(90deg,#22c55e,#4ade80);
    }
    .grade-bar-fill[data-grade="S"],
    .grade-bar-fill[data-grade="SS"],
    .grade-bar-fill[data-grade="SSS"]{
      background:linear-gradient(90deg,#22c55e,#a855f7);
      box-shadow:0 0 12px 0 rgba(168,85,247,0.6);
    }

    /* ===== Quest panel (‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤) ===== */
    .hud-quest{
      max-width:280px;
      font-size:12px;
    }
    .quest-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      margin-bottom:2px;
    }
    .quest-main-label{
      font-size:13px;
      font-weight:600;
    }
    .quest-mini-label{
      font-size:12px;
      color:var(--text-soft);
      margin-top:4px;
    }
    .quest-progress-wrap{
      margin-top:5px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .quest-bar{
      position:relative;
      width:100%;
      height:4px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .quest-bar-fill{
      position:absolute;
      inset:0;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-soft), var(--accent));
      transition:width .18s.ease-out;
    }
    .quest-caption{
      font-size:10px;
      color:var(--text-soft);
      display:flex;
      justify-content:space-between;
    }

    /* ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà + ‡∏ô‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° */
    .hud-groups-row{
      margin-top:5px;
      font-size:11px;
      color:var(--text-soft);
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
    }
    .hud-groups-row span strong{
      font-variant-numeric:tabular-nums;
      color:#38bdf8;
    }
    .hud-groups-legend{
      margin-top:4px;
      font-size:10px;
      color:var(--text-soft);
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
    }

    /* ===== Coach bubble (‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á) ===== */
    .hud-bottom{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding-bottom:72px;
    }

    .coach-bubble{
      min-width:60%;
      max-width:680px;
      text-align:left;
      background:
        radial-gradient(circle at top left, rgba(52,211,153,0.26), transparent 55%),
        radial-gradient(circle at bottom right, rgba(45,212,191,0.18), transparent 55%),
        rgba(15,23,42,0.98);
      border-radius:999px;
      padding:10px 16px;
      border:1px solid rgba(52,211,153,0.65);
      font-size:13px;
      display:none;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      pointer-events:auto;
      position:relative;
      overflow:hidden;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 38px rgba(15,23,42,0.9);
    }

    .coach-bubble.show{
      display:flex;
      animation:coach-bubble-pop 0.45s.ease-out;
    }

    .coach-bubble::before,
    .coach-bubble::after{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 0% 0%, rgba(52,211,153,0.20), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(56,189,248,0.16), transparent 55%);
      opacity:0;
      pointer-events:none;
      mix-blend-mode:screen;
      animation:coach-sparkle 2.6s ease-in-out infinite;
    }
    .coach-bubble::after{
      animation-delay:1.3s;
    }

    .coach-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#6ee7b7;
      font-weight:600;
    }

    #coach-text{
      font-size:13px;
      line-height:1.4;
      animation:coach-text-wave 0.9s ease-out;
    }

    .coach-emoji{
      width:46px;
      height:46px;
      border-radius:999px;
      background-image:url('./img/coach-neutral.png');
      background-size:cover;
      background-position:center;
      flex-shrink:0;
      box-shadow:0 0 14px rgba(16,185,129,0.85);
      position:relative;
      animation:coach-idle 1.3s ease-in-out infinite;
    }

    .coach-emoji::before{
      content:"";
      position:absolute;
      inset:-5px;
      border-radius:inherit;
      border:1px solid rgba(52,211,153,0.45);
      box-shadow:0 0 22px rgba(34,197,94,0.65);
      opacity:.7;
      mix-blend-mode:screen;
      pointer-events:none;
    }

    .coach-emoji.coach-neutral{
      background-image:url('./img/coach-neutral.png');
      filter:none;
    }
    .coach-emoji.coach-happy{
      background-image:url('./img/coach-happy.png');
      box-shadow:0 0 20px rgba(34,197,94,0.95);
      animation:coach-dance 0.8s ease-in-out infinite;
    }
    .coach-emoji.coach-sad{
      background-image:url('./img/coach-sad.png');
      filter:grayscale(0.2) brightness(0.9);
      box-shadow:0 0 12px rgba(148,163,184,0.85);
    }
    .coach-emoji.coach-fever{
      background-image:url('./img/coach-fever.png');
      box-shadow:0 0 24px rgba(248,113,113,0.95);
      animation:coach-fever-pulse 0.55s.ease-in-out infinite;
    }

    .coach-emoji.coach-celebrate{
      animation:coach-celebrate-bounce 0.75s.ease-out;
    }

    /* ===== Animations (coach) ===== */
    @keyframes coach-idle{
      0%{   transform:translateY(0) scale(1);}
      25%{  transform:translateY(-2px) scale(1.03);}
      50%{  transform:translateY(1px) scale(0.99);}
      75%{  transform:translateY(-1px) scale(1.02);}
      100%{ transform:translateY(0) scale(1);}
    }

    @keyframes coach-dance{
      0%{   transform:translateY(0) rotate(0deg) scale(1);}
      20%{  transform:translateY(-4px) rotate(-6deg) scale(1.06);}
      40%{  transform:translateY(-2px) rotate(5deg) scale(1.03);}
      60%{  transform:translateY(-6px) rotate(-4deg) scale(1.07);}
      80%{  transform:translateY(-3px) rotate(4deg) scale(1.04);}
      100%{ transform:translateY(0) rotate(0deg) scale(1);}
    }

    @keyframes coach-fever-pulse{
      0%{
        transform:translateY(-1px) scale(1.05);
        box-shadow:0 0 16px rgba(248,113,113,0.9);
      }
      50%{
        transform:translateY(-3px) scale(1.11);
        box-shadow:0 0 26px rgba(248,113,113,1);
      }
      100%{
        transform:translateY(-1px) scale(1.05);
        box-shadow:0 0 16px rgba(248,113,113,0.9);
      }
    }

    @keyframes coach-celebrate-bounce{
      0%{   transform:translateY(0) scale(1) rotate(0);}
      20%{  transform:translateY(-10px) scale(1.15) rotate(-8deg);}
      40%{  transform:translateY(-6px) scale(1.08) rotate(6deg);}
      60%{  transform:translateY(-12px) scale(1.18) rotate(-4deg);}
      100%{ transform:translateY(0) scale(1) rotate(0);}
    }

    @keyframes coach-bubble-pop{
      0%{
        opacity:0;
        transform:translateY(8px) scale(.92);
      }
      60%{
        opacity:1;
        transform:translateY(0) scale(1.02);
      }
      100%{
        opacity:1;
        transform:translateY(0) scale(1);
      }
    }

    @keyframes coach-text-wave{
      0%{
        opacity:0;
        transform:translateY(4px);
      }
      40%{
        opacity:1;
        transform:translateY(0);
      }
      100%{
        opacity:1;
        transform:translateY(0);
      }
    }

    @keyframes coach-sparkle{
      0%{
        opacity:0;
        transform:translate3d(-6px,4px,0) scale(1);
      }
      40%{
        opacity:.7;
        transform:translate3d(2px,-4px,0) scale(1.03);
      }
      80%{
        opacity:.4;
        transform:translate3d(6px,2px,0) scale(1.02);
      }
      100%{
        opacity:0;
        transform:translate3d(0,0,0) scale(1);
      }
    }

    /* ===== Center hint ===== */
    .hint-center{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-size:12px;
      color:var(--text-soft);
      background:rgba(15,23,42,0.8);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      display:none;
      pointer-events:none;
      z-index:651;
    }
    .hint-center.show{ display:block; }

    /* ===== End Summary Toast ===== */
    .end-toast{
      position:fixed;
      left:50%;
      top:18%;
      transform:translateX(-50%);
      background:radial-gradient(circle at top left, rgba(250,204,21,0.26), transparent 55%),
                 rgba(15,23,42,0.96);
      padding:12px 16px 14px;
      border-radius:20px;
      border:1px solid rgba(250,204,21,0.65);
      min-width:280px;
      max-width:420px;
      font-size:13px;
      box-shadow:0 20px 40px rgba(15,23,42,0.85);
      display:none;
      z-index:652;
      pointer-events:auto;
    }
    .end-toast.show{ display:block; }
    .end-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .end-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-top:2px;
    }
    .end-row strong{ font-weight:600; }

    .end-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }
    .end-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:6px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,0.85);
      color:var(--text-main);
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:background .15s ease, box-shadow .15s ease, transform .1s ease;
    }
    .end-btn:hover{
      background:rgba(15,23,42,0.98);
      box-shadow:0 10px 22px rgba(15,23,42,0.9);
      transform:translateY(-1px);
    }
    .end-btn:active{
      transform:translateY(0);
      box-shadow:0 6px 14px rgba(15,23,42,0.7);
    }
    .end-btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border-color:rgba(187,247,208,0.9);
      color:#052e16;
    }
    .end-btn-primary:hover{
      background:linear-gradient(135deg,#4ade80,#22c55e);
    }
    .end-btn-ghost{
      background:rgba(15,23,42,0.7);
    }

    /* ===== ‡∏õ‡πâ‡∏≤‡∏¢‡πÇ‡∏´‡∏°‡∏î (Play / Research) ===== */
    .hud-mode-badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(30,64,175,0.18);
      border:1px solid rgba(59,130,246,0.6);
      color:#bfdbfe;
      font-weight:500;
      margin-left:6px;
    }

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ VR ===== */
    .vr-btn{
      position:fixed;
      right:12px;
      bottom:16px;
      z-index:653;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.7);
      padding:8px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 55%),
                 rgba(15,23,42,0.96);
      color:#e0f2fe;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 14px 30px rgba(15,23,42,0.9);
    }
    .vr-btn span{
      font-size:16px;
    }
    .vr-btn:hover{
      background:radial-gradient(circle at top left, rgba(56,189,248,0.5), transparent 55%),
                 rgba(15,23,42,1);
    }

    /* ===== A-Frame canvas full ===== */
    a-scene{
      width:100vw;
      height:100vh;
      position:fixed;
      inset:0;
    }

    /* ===== ‡∏â‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (overlay) ===== */
    .big-celebrate{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:654;
      pointer-events:none;
    }
    .big-celebrate.show{
      display:flex;
      animation:big-celebrate-fade 1.2s ease-out forwards;
    }
    .big-celebrate-inner{
      padding:16px 22px;
      border-radius:999px;
      background:radial-gradient(circle at top left, rgba(250,250,250,0.16), transparent 55%),
                 rgba(8,47,73,0.96);
      border:1px solid rgba(251,191,36,0.75);
      font-size:16px;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#fef9c3;
      box-shadow:0 24px 60px rgba(15,23,42,0.95);
    }
    @keyframes big-celebrate-fade{
      0%{ opacity:0; transform:scale(0.85);}
      20%{ opacity:1; transform:scale(1);}
      80%{ opacity:1; transform:scale(1);}
      100%{ opacity:0; transform:scale(0.9);}
    }

    /* ===== Layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤ DOM (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á) ===== */
    #plate-target-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:360;
      /* ‡∏à‡∏∞‡∏°‡∏µ transform: translateX(...) ‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å JS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */
    }

    /* ===== ‡πÄ‡∏õ‡πâ‡∏≤ DOM (emoji) ===== */
    .hha-target{
      position:absolute;
      transform:translate(-50%, -50%);
      width:68px;
      height:68px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      cursor:pointer;
      z-index:360;

      font-size:42px;
      line-height:1;
      text-shadow:
        0 0 8px rgba(0,0,0,0.65),
        0 0 16px rgba(0,0,0,0.7);

      /* ‡∏ï‡∏±‡∏î‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏ü‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ï‡∏∞ */
      border:none;
      background:transparent;
      outline:none;
      -webkit-tap-highlight-color:transparent;
    }
    .hha-target:focus{
      outline:none;
    }
    .hha-target::before{
      content:none !important;
    }
    .hha-target-good{
      text-shadow:
        0 0 10px rgba(34,197,94,0.9),
        0 0 20px rgba(34,197,94,0.7),
        0 0 28px rgba(34,197,94,0.55);
    }
    .hha-target-bad{
      text-shadow:
        0 0 10px rgba(248,113,113,0.9),
        0 0 20px rgba(248,113,113,0.7),
        0 0 28px rgba(248,113,113,0.55);
    }

    @media (max-width:768px){
      .hud-quest{
        max-width:220px;
      }
      .hud-groups-legend{ display:none; }
      .hud-groups-row{ font-size:10px; }
    }
  </style>
</head>
<body>

  <!-- ===== A-Frame Scene (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á VR) ===== -->
  <a-scene
    vr-mode-ui="enabled: true"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    background="color: #020617">

    <a-entity id="rig" position="0 1.6 0">
      <a-camera id="plate-camera"
                wasd-controls-enabled="false"
                look-controls="pointerLockEnabled: false">
        <a-entity id="cursor"
                  cursor="fuse: false; rayOrigin: mouse"
                  raycaster="objects: [data-hha-tgt]"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.016"
                  material="shader: flat; color: #ffffff"
                  position="0 0 -0.9">
        </a-entity>
      </a-camera>
    </a-entity>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô + ‡πÅ‡∏™‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÜ -->
    <a-entity light="type: hemisphere; color: #ffffff; groundColor: #4b5563; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.65" position="1 2 0.5"></a-entity>
    <a-plane position="0 0 0" rotation="-90 0 0" width="16" height="16"
             material="color: #020617; metalness: 0; roughness: 1"></a-plane>
    <a-sky color="#020617"></a-sky>
  </a-scene>

  <!-- ===== HUD Overlay (2D) ===== -->
  <div class="hud-root">
    <div class="hud-top">
      <!-- Left: mode + metrics -->
      <div class="hud-card" style="flex:1;max-width:460px;">
        <div class="hud-main">
          <div>
            <div class="hud-main-title">
              Hero Health ‚Ä¢ Nutrition VR
              <span id="hud-runmode" class="hud-mode-badge">Play Mode</span>
            </div>
            <div class="hud-main-mode">Balanced Plate</div>
          </div>
          <div class="hud-pill">
            <span id="hud-diff-label">NORMAL</span>
            <span>‚Ä¢</span>
            <span id="hud-time-label">60s</span>
          </div>
        </div>

        <div class="hud-metrics">
          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
            <div class="metric-value accent" id="hud-score">0</div>
          </div>

          <div class="metric">
            <div class="metric-label">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="metric-value" id="hud-combo" data-max="0">0</div>
          </div>

          <div class="metric">
            <div class="metric-label">MISS</div>
            <div class="metric-value danger" id="hud-miss">0</div>
          </div>

          <div class="metric">
            <div class="metric-label">‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</div>
            <div class="metric-value accent" id="hud-plates">0</div>
          </div>

          <!-- Grade (real-time) + bar -->
          <div class="metric metric-grade">
            <div class="metric-label">‡πÄ‡∏Å‡∏£‡∏î (real-time)</div>
            <div class="grade-text">
              <span class="metric-value" id="hud-grade">-</span>
              <span class="grade-badge" id="hud-grade-badge">C‚ÄìSSS</span>
            </div>
            <div class="grade-bar">
              <div id="hud-grade-bar" class="grade-bar-fill" data-grade="C"></div>
            </div>
          </div>
        </div>

        <!-- ‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° -->
        <div class="hud-groups-row">
          <span>‡∏´‡∏°‡∏π‡πà 1: <strong id="g1">0</strong></span>
          <span>2: <strong id="g2">0</strong></span>
          <span>3: <strong id="g3">0</strong></span>
          <span>4: <strong id="g4">0</strong></span>
          <span>5: <strong id="g5">0</strong></span>
        </div>
        <div class="hud-groups-legend">
          <span>1 ‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á üçöüçû</span>
          <span>2 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ü•©üçó</span>
          <span>3 ‡∏ú‡∏±‡∏Å ü•¶ü•ï</span>
          <span>4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ üçéüçå</span>
          <span>5 ‡∏ô‡∏°/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏° ü•õüßÄ</span>
        </div>
      </div>

      <!-- Right: quest panel -->
      <div class="hud-card hud-quest">
        <div class="quest-title">Quest (‡∏à‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)</div>
        <div id="hud-quest-main" class="quest-main-label">Goal ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
        <div id="hud-quest-mini" class="quest-mini-label">Mini quest ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ</div>
        <div class="quest-progress-wrap">
          <div class="quest-bar">
            <div id="hud-quest-main-bar" class="quest-bar-fill"></div>
          </div>
          <div class="quest-caption">
            <span id="hud-quest-main-caption">0 / 0</span>
            <span id="hud-quest-hint"></span>
          </div>
          <div class="quest-bar">
            <div id="hud-quest-mini-bar" class="quest-bar-fill"></div>
          </div>
          <div class="quest-caption">
            <span id="hud-quest-mini-caption">0 / 0</span>
            <span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom: coach -->
    <div class="hud-bottom">
      <div class="coach-bubble" id="coach-bubble">
        <div id="coach-emoji" class="coach-emoji coach-neutral"></div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:2px;">
          <span class="coach-label">‡πÇ‡∏Ñ‡πâ‡∏ä</span>
          <span id="coach-text">
            ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô ‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞ üçΩÔ∏è
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Hint touch-look -->
  <div class="hint-center" id="touch-hint">‡∏•‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á üëÜ</div>

  <!-- End summary (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Å‡∏°) -->
  <div class="end-toast" id="end-toast">
    <div class="end-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ Balanced Plate</div>
    <div class="end-row"><span>‡πÇ‡∏´‡∏°‡∏î</span><strong id="end-runmode">Play</strong></div>
    <div class="end-row"><span>‡πÄ‡∏Å‡∏£‡∏î</span><strong id="end-grade">-</strong></div>
    <div class="end-row"><span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span><strong id="end-score">0</strong></div>
    <div class="end-row"><span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span><strong id="end-combo">0</strong></div>
    <div class="end-row"><span>MISS</span><strong id="end-miss">0</strong></div>
    <div class="end-row"><span>‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</span><strong id="end-plates">0</strong></div>
    <div class="end-row"><span>Goals</span><strong id="end-goal">0 / 0</strong></div>
    <div class="end-row"><span>Mini quests</span><strong id="end-mini">0 / 0</strong></div>
    <div class="end-row"><span>‡∏´‡∏°‡∏π‡πà 1‚Äì5 ‡∏£‡∏ß‡∏°</span><strong id="end-groups">1:0 2:0 3:0 4:0 5:0</strong></div>
    <div class="end-actions">
      <button class="end-btn end-btn-primary" id="btn-replay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button class="end-btn end-btn-ghost" id="btn-back-hub">‡∏Å‡∏•‡∏±‡∏ö Hub</button>
    </div>
  </div>

  <!-- Start countdown -->
  <div id="start-countdown" class="countdown-overlay countdown-hidden">3</div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ VR -->
  <button id="btn-vr" class="vr-btn"><span>üï∂Ô∏è</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î VR</button>

  <!-- ‡∏â‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à -->
  <div class="big-celebrate" id="big-celebrate">
    <div class="big-celebrate-inner">ALL QUESTS CLEAR! üåü</div>
  </div>

  <!-- ===== Logic: boot Plate + HUD + Touch Look + Cloud Logger ===== -->
  <script type="module">
    import { boot as bootPlate } from './plate/plate.safe.js';
    import { attachTouchLook } from './vr-goodjunk/touch-look-goodjunk.js';
    import { initCloudLogger } from './vr/hha-cloud-logger.js';

    function getParam(name, fallback){
      const url = new URL(window.location.href);
      const v = url.searchParams.get(name);
      return v !== null && v !== '' ? v : fallback;
    }

    // HUD refs
    const elScore   = document.getElementById('hud-score');
    const elCombo   = document.getElementById('hud-combo');
    const elMiss    = document.getElementById('hud-miss');
    const elPlates  = document.getElementById('hud-plates');
    const elDiff    = document.getElementById('hud-diff-label');
    const elTime    = document.getElementById('hud-time-label');
    const elRunHUD  = document.getElementById('hud-runmode');

    const elG1 = document.getElementById('g1');
    const elG2 = document.getElementById('g2');
    const elG3 = document.getElementById('g3');
    const elG4 = document.getElementById('g4');
    const elG5 = document.getElementById('g5');

    // Quest HUD
    const elQuestMain    = document.getElementById('hud-quest-main');
    const elQuestMini    = document.getElementById('hud-quest-mini');
    const elQuestMainBar = document.getElementById('hud-quest-main-bar');
    const elQuestMiniBar = document.getElementById('hud-quest-mini-bar');
    const elQuestMainCap = document.getElementById('hud-quest-main-caption');
    const elQuestMiniCap = document.getElementById('hud-quest-mini-caption');
    const elQuestHint    = document.getElementById('hud-quest-hint');

    // Coach
    const elCoachBubble = document.getElementById('coach-bubble');
    const elCoachText   = document.getElementById('coach-text');
    const elCoachEmoji  = document.getElementById('coach-emoji');
    const elTouchHint   = document.getElementById('touch-hint');
    const elBigCelebrate = document.getElementById('big-celebrate');

    // Summary
    const elEndToast   = document.getElementById('end-toast');
    const elEndScore   = document.getElementById('end-score');
    const elEndCombo   = document.getElementById('end-combo');
    const elEndMiss    = document.getElementById('end-miss');
    const elEndPlates  = document.getElementById('end-plates');
    const elEndGoal    = document.getElementById('end-goal');
    const elEndMini    = document.getElementById('end-mini');
    const elEndGrade   = document.getElementById('end-grade');
    const elEndRun     = document.getElementById('end-runmode');
    const elEndGroups  = document.getElementById('end-groups');
    const btnReplay    = document.getElementById('btn-replay');
    const btnBackHub   = document.getElementById('btn-back-hub');
    const btnVR        = document.getElementById('btn-vr');

    // Grade HUD
    const elGrade      = document.getElementById('hud-grade');
    const elGradeBadge = document.getElementById('hud-grade-badge');
    const elGradeBar   = document.getElementById('hud-grade-bar');

    // Countdown
    const elCountdown  = document.getElementById('start-countdown');

    let lastCoachTimeout = null;
    let hudMissCount = 0;
    let comboMax = 0;
    let hudGoalsTotal = 0;
    let hudGoalsCleared = 0;
    let hudMiniTotal = 0;
    let hudMiniCleared = 0;
    let prevGoalsCleared = 0;
    let prevMiniCleared = 0;
    let lastScore = 0;

    const coachMoodKeys = ['neutral','happy','sad','fever'];

    function setCoachFace(mood){
      if (!elCoachEmoji) return;
      coachMoodKeys.forEach(k => elCoachEmoji.classList.remove('coach-' + k));
      const m = coachMoodKeys.includes(mood) ? mood : 'neutral';
      elCoachEmoji.classList.add('coach-' + m);
    }

    function pulseCoachCelebrate(){
      if (!elCoachEmoji) return;
      elCoachEmoji.classList.add('coach-celebrate');
      setTimeout(() => elCoachEmoji.classList.remove('coach-celebrate'), 800);
    }

    function setCoach(text){
      if (!text) return;
      elCoachText.textContent = text;
      elCoachBubble.classList.add('show');
      if (lastCoachTimeout) clearTimeout(lastCoachTimeout);
      lastCoachTimeout = setTimeout(() => {
        elCoachBubble.classList.remove('show');
      }, 4200);
    }

    // ===== Countdown 3‚Äì2‚Äì1‚ÄìGo =====
    function runCountdown(onDone){
      if (!elCountdown){
        if (onDone) onDone();
        return;
      }
      const steps = ['3','2','1','Go!'];
      let idx = 0;
      elCountdown.classList.remove('countdown-hidden');
      elCountdown.textContent = steps[0];

      const interval = 800;
      const t = setInterval(() => {
        idx++;
        if (idx >= steps.length){
          clearInterval(t);
          elCountdown.classList.add('countdown-hidden');
          if (onDone) onDone();
        } else {
          elCountdown.textContent = steps[idx];
        }
      }, interval);
    }

    // ===== ‡πÄ‡∏Å‡∏£‡∏î C‚ÄìSSS ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô GoodJunk =====
    function computeGrade(score, comboMax, misses, goalsCleared, goalsTotal, miniCleared, miniTotal){
      const allGoalDone = (goalsTotal > 0 && goalsCleared >= goalsTotal);
      const allMiniDone = (miniTotal > 0 && miniCleared >= miniTotal);
      const allQuest    = allGoalDone && allMiniDone;

      if (allQuest && score >= 1200 && comboMax >= 15 && misses <= 1) return 'SSS';
      if (allQuest && score >= 900  && comboMax >= 10 && misses <= 3) return 'SS';
      if (score >= 700) return 'S';
      if (score >= 500) return 'A';
      if (score >= 300) return 'B';
      return 'C';
    }

    function updateRealtimeGrade(latestScore){
      if (!elGrade || !elGradeBar) return;

      const scoreNow = (typeof latestScore === 'number') ? latestScore : lastScore;
      const grade = computeGrade(
        scoreNow,
        comboMax,
        hudMissCount,
        hudGoalsCleared,
        hudGoalsTotal,
        hudMiniCleared,
        hudMiniTotal
      );

      elGrade.textContent = grade;
      if (elGradeBadge) elGradeBadge.textContent = 'C‚ÄìSSS';

      const pctMap = { C:20, B:40, A:60, S:75, SS:90, SSS:100 };
      const pct = pctMap[grade] || 15;
      elGradeBar.style.width = pct + '%';
      elGradeBar.dataset.grade = grade;
    }

    // ===== Particles API =====
    function getParticlesAPI(){
      const gm = window.GAME_MODULES || {};
      return gm.Particles || window.Particles || null;
    }

    // ===== Celebrate per quest =====
    function celebrateQuest(kind, cleared, total){
      const P = getParticlesAPI();
      const cx = window.innerWidth / 2;
      const y  = window.innerHeight * 0.22;

      if (P && P.burstAt){
        P.burstAt(cx, y, {
          color: (kind === 'goal') ? '#22c55e' : '#38bdf8',
          count: 16
        });
      }
      if (P && P.scorePop){
        const label = (kind === 'goal')
          ? ('Goal ' + cleared + '/' + total)
          : ('Mini ' + cleared + '/' + total);
        P.scorePop(cx, y, 'MISSION CLEAR!', {
          judgment: label,
          good: true
        });
      }
      pulseCoachCelebrate();
    }

    // ===== ‡∏â‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà =====
    function bigCelebrateAllQuests(callback){
      if (!elBigCelebrate){
        if (callback) callback();
        return;
      }
      const P = getParticlesAPI();
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight * 0.35;

      if (P && P.burstAt){
        for (let i = 0; i < 3; i++){
          setTimeout(() => {
            P.burstAt(cx, cy, {
              color: i === 1 ? '#facc15' : '#22c55e',
              count: 22
            });
          }, i * 260);
        }
      }
      if (P && P.scorePop){
        P.scorePop(cx, cy, 'ALL QUESTS CLEAR!', {
          judgment: 'GREAT JOB',
          good: true
        });
      }

      setCoachFace('happy');
      setCoach('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Goal ‡πÅ‡∏•‡∏∞ Mini ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢ üåü');
      pulseCoachCelebrate();

      elBigCelebrate.classList.add('show');
      setTimeout(() => {
        elBigCelebrate.classList.remove('show');
        if (callback) callback();
      }, 1400);
    }

    // ===== ‡πÄ‡∏ß‡∏•‡∏≤ hha:time ‡∏à‡∏≤‡∏Å timer ‡∏Å‡∏•‡∏≤‡∏á =====
    window.addEventListener('hha:time', (e) => {
      const d = e.detail || {};
      const sec = d.sec | 0;
      if (sec < 0) return;
      elTime.textContent = sec + 's';
    });

    // ===== HUD ‡∏à‡∏≤‡∏Å hha:stat (Plate engine) =====
    window.addEventListener('hha:stat', (e) => {
      const d = e.detail || {};
      if (typeof d.score === 'number'){
        lastScore = d.score;
        elScore.textContent = d.score;
      }
      if (typeof d.combo === 'number'){
        const c = d.combo | 0;
        comboMax = Math.max(comboMax, c);
        elCombo.dataset.max = String(comboMax);
        elCombo.textContent = comboMax;

        if (c >= 10)      setCoachFace('fever');
        else if (c >= 5)  setCoachFace('happy');
        else if (c === 0 && hudMissCount === 0) setCoachFace('neutral');
      }
      if (typeof d.misses === 'number'){
        hudMissCount = d.misses;
        elMiss.textContent = hudMissCount;
      }
      if (typeof d.platesDone === 'number'){
        elPlates.textContent = d.platesDone;
      }
      if (Array.isArray(d.totalCounts) && d.totalCounts.length >= 5){
        const [g1,g2,g3,g4,g5] = d.totalCounts;
        elG1.textContent = g1;
        elG2.textContent = g2;
        elG3.textContent = g3;
        elG4.textContent = g4;
        elG5.textContent = g5;
      }

      updateRealtimeGrade(d.score);
    });

    // ===== Quest update =====
    window.addEventListener('quest:update', (e) => {
      const d = e.detail || {};
      const goalsAll = d.goalsAll || d.goals || [];
      const minisAll = d.minisAll || d.minis || [];
      const goal = d.goal || goalsAll.find(q => q && !q.done) || goalsAll[0] || null;
      const mini = d.mini || minisAll.find(q => q && !q.done) || minisAll[0] || null;

      if (goal){
        const prog = (typeof goal.prog === 'number') ? goal.prog : (goal.progress || 0);
        const tgt  = goal.target || goal.tgt || 0;
        const pct  = tgt > 0 ? Math.max(0, Math.min(100,(prog/tgt)*100)) : 0;
        elQuestMain.textContent = goal.text || goal.title || goal.label || '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å';
        elQuestMainBar.style.width = pct + '%';
        elQuestMainCap.textContent = `${prog} / ${tgt}`;
      }else{
        elQuestMain.textContent = 'Goal ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéØ';
        elQuestMainBar.style.width = '100%';
        elQuestMainCap.textContent = '';
      }

      if (mini){
        const progM = (typeof mini.prog === 'number') ? mini.prog : (mini.progress || 0);
        const tgtM  = mini.target || mini.tgt || 0;
        const pctM  = tgtM > 0 ? Math.max(0, Math.min(100,(progM/tgtM)*100)) : 0;
        elQuestMini.textContent = 'Mini: ' + (mini.text || mini.title || mini.label || '');
        elQuestMiniBar.style.width = pctM + '%';
        elQuestMiniCap.textContent = `${progM} / ${tgtM}`;
      }else{
        elQuestMini.textContent = 'Mini quest ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
        elQuestMiniBar.style.width = '100%';
        elQuestMiniCap.textContent = '';
      }

      if (d.hint){
        elQuestHint.textContent = d.hint;
      } else {
        elQuestHint.textContent = '';
      }

      hudGoalsTotal   = goalsAll.length;
      hudGoalsCleared = goalsAll.filter(q => q && q.done).length;
      hudMiniTotal    = minisAll.length;
      hudMiniCleared  = minisAll.filter(q => q && q.done).length;

      if (hudGoalsCleared > prevGoalsCleared){
        celebrateQuest('goal', hudGoalsCleared, hudGoalsTotal);
      }
      if (hudMiniCleared > prevMiniCleared){
        celebrateQuest('mini', hudMiniCleared, hudMiniTotal);
      }
      prevGoalsCleared = hudGoalsCleared;
      prevMiniCleared  = hudMiniCleared;

      updateRealtimeGrade();
    });

    // Coach text ‡∏à‡∏≤‡∏Å engine
    window.addEventListener('hha:coach', (e) => {
      const d = e.detail || {};
      if (d.text) setCoach(d.text);
    });

    // ===== End summary + big celebrate =====
    function showEndSummary(payload){
      const d = payload || {};
      const score = (typeof d.score === 'number') ? d.score : (typeof d.scoreFinal === 'number' ? d.scoreFinal : lastScore);
      const plates = d.platesDone ?? 0;
      const misses = (typeof d.misses === 'number') ? d.misses : hudMissCount;
      const gCleared = d.goalsCleared ?? hudGoalsCleared;
      const gTotal   = d.goalsTotal   ?? hudGoalsTotal;
      const mCleared = d.questsCleared ?? d.miniCleared ?? hudMiniCleared;
      const mTotal   = d.questsTotal   ?? d.miniTotal   ?? hudMiniTotal;

      let groupsText = '-';
      if (Array.isArray(d.groupCounts) && d.groupCounts.length >= 5){
        const [gg1,gg2,gg3,gg4,gg5] = d.groupCounts;
        groupsText = `1:${gg1}  2:${gg2}  3:${gg3}  4:${gg4}  5:${gg5}`;
      }

      const grade = computeGrade(score, comboMax, misses, gCleared, gTotal, mCleared, mTotal);
      elEndScore.textContent  = score;
      elEndCombo.textContent  = comboMax;
      elEndMiss.textContent   = misses;
      elEndPlates.textContent = plates;
      elEndGoal.textContent   = `${gCleared} / ${gTotal}`;
      elEndMini.textContent   = `${mCleared} / ${mTotal}`;
      elEndGrade.textContent  = grade;
      elEndGroups.textContent = groupsText;

      updateRealtimeGrade(score);

      setCoachFace(misses <= 3 ? 'happy' : 'neutral');
      setCoach('‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üéâ');

      elEndToast.classList.add('show');
    }

    let timerId = null;
    let endedByEvent = false;

    window.addEventListener('hha:end', (e) => {
      const d = e.detail || {};
      endedByEvent = true;
      if (timerId){
        clearInterval(timerId);
        timerId = null;
      }

      const gCleared = d.goalsCleared ?? hudGoalsCleared;
      const gTotal   = d.goalsTotal   ?? hudGoalsTotal;
      const mCleared = d.questsCleared ?? d.miniCleared ?? hudMiniCleared;
      const mTotal   = d.questsTotal   ?? d.miniTotal   ?? hudMiniTotal;
      const allQuest = d.allCleared || (gTotal>0 && gCleared>=gTotal && mTotal>0 && mCleared>=mTotal);

      if (allQuest){
        bigCelebrateAllQuests(() => showEndSummary(d));
      }else{
        showEndSummary(d);
      }
    });

    // ===== Touch look =====
    function initTouchLook(cameraEl){
      if (!cameraEl) return;
      attachTouchLook(cameraEl, {
        sensitivity: 0.25,
        areaEl: document.body,
        onActiveChange(active){
          if (active){
            elTouchHint.classList.add('show');
            setTimeout(() => elTouchHint.classList.remove('show'), 3200);
          }
        }
      });
    }

    // ===== ‡∏ó‡∏≥‡πÉ‡∏´‡πâ layer ‡πÄ‡∏õ‡πâ‡∏≤ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏≤‡∏°) =====
    function initTargetLayerFollowCamera(cameraEl){
      if (!cameraEl) return;
      const A = window.AFRAME;
      const THREE = A && A.THREE;
      let layer = document.getElementById('plate-target-layer');

      function clampLocal(v,min,max){
        if (v < min) return min;
        if (v > max) return max;
        return v;
      }

      function loop(){
        // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏¥‡∏Å loop
        if (!cameraEl.parentNode){
          return;
        }

        if (!layer){
          layer = document.getElementById('plate-target-layer');
          requestAnimationFrame(loop);
          return;
        }

        try{
          const obj = cameraEl.object3D;
          if (obj){
            const rot = obj.rotation || { y:0 };
            let yawDeg;
            if (THREE && THREE.MathUtils && THREE.MathUtils.radToDeg){
              yawDeg = THREE.MathUtils.radToDeg(rot.y || 0);
            }else{
              yawDeg = (rot.y || 0) * 180 / Math.PI;
            }

            // normalize ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á -180..180 ‡πÅ‡∏•‡πâ‡∏ß map ‡πÄ‡∏õ‡πá‡∏ô shift ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤/‡∏ã‡πâ‡∏≤‡∏¢
            while (yawDeg > 180) yawDeg -= 360;
            while (yawDeg < -180) yawDeg += 360;

            const maxShift = window.innerWidth * 0.40; // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ ~40% ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const t = clampLocal(yawDeg / 45, -1, 1);  // ‡∏´‡∏°‡∏∏‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 45¬∞ = ‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö
            const x = t * maxShift;

            layer.style.transform = `translateX(${x}px)`;
          }
        }catch(err){
          // ignore
        }

        requestAnimationFrame(loop);
      }

      requestAnimationFrame(loop);
    }

    // ===== VR button =====
    function initVRButton(){
      const scene = document.querySelector('a-scene');
      if (!scene || !btnVR) return;
      btnVR.addEventListener('click', () => {
        try{ scene.enterVR(); }catch(err){ console.warn('[PlateVR] enterVR error:', err); }
      });
    }

    // ===== Gaze center shot ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VR (DOM target .hha-target) =====
    let isVrMode = false;
    let gazeTimerId = null;
    let gazeTarget = null;
    let gazeStartTs = 0;
    const GAZE_RADIUS = 70;
    const FUSE_MS = 1100; // ‡∏à‡πâ‡∏≠‡∏á 1.1 ‡∏ß‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á

    function findTargetNearCenter(){
      const targets = document.querySelectorAll('.hha-target');
      if (!targets.length) return { el:null, dist:Infinity };
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      let best = null;
      let bestDist = Infinity;
      targets.forEach(el => {
        const rect = el.getBoundingClientRect();
        const tx = rect.left + rect.width/2;
        const ty = rect.top + rect.height/2;
        const dx = tx - cx;
        const dy = ty - cy;
        const dist = Math.hypot(dx,dy);
        if (dist < bestDist){
          bestDist = dist;
          best = el;
        }
      });
      return { el:best, dist:bestDist };
    }

    function hitTargetAtCenter(){
      const { el, dist } = findTargetNearCenter();
      if (!el || dist > GAZE_RADIUS) return false;
      el.click();
      return true;
    }

    function gazeTick(){
      if (!isVrMode) return;
      const { el, dist } = findTargetNearCenter();
      if (!el || dist > GAZE_RADIUS){
        gazeTarget = null;
        gazeStartTs = 0;
        return;
      }
      const now = performance.now();
      if (el === gazeTarget){
        const elapsed = now - gazeStartTs;
        if (elapsed >= FUSE_MS){
          el.click();
          gazeTarget = null;
          gazeStartTs = 0;
        }
      }else{
        gazeTarget = el;
        gazeStartTs = now;
      }
    }

    function startGazeLoop(){
      if (gazeTimerId) return;
      gazeTimerId = setInterval(gazeTick, 100);
    }
    function stopGazeLoop(){
      if (!gazeTimerId) return;
      clearInterval(gazeTimerId);
      gazeTimerId = null;
      gazeTarget = null;
      gazeStartTs = 0;
    }

    // ===== Block touch-drag ‡∏ö‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á =====
    ['touchstart','touchmove','touchend','pointerdown','pointermove','pointerup'].forEach(type => {
      document.addEventListener(type, (ev) => {
        const t = ev.target;
        if (t && t.closest && t.closest('.hha-target')) {
          // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡∏∞ / ‡∏•‡∏≤‡∏Å‡∏ö‡∏ô‡πÄ‡∏õ‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà tap/click ‡πÄ‡∏õ‡πâ‡∏≤
          // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ event ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á touch-look ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö body
          ev.stopPropagation();
          // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ preventDefault() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ click ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        }
      }, { capture: true });
    });

    window.addEventListener('DOMContentLoaded', () => {
      const diff = String(getParam('diff','normal')).toLowerCase();
      const runParam = String(getParam('run','play')).toLowerCase();
      const runMode = (runParam === 'research') ? 'research' : 'play';

      // ‡πÉ‡∏´‡πâ engine ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ runmode ‡∏≠‡∏∞‡πÑ‡∏£
      window.HHA_RUNMODE = runMode;

      let dur = 60;
      const timeParam = getParam('time','');
      if (timeParam){
        const parsed = parseInt(timeParam,10);
        if (!isNaN(parsed) && parsed >= 20 && parsed <= 180){
          dur = parsed;
        }
      }

      // HUD init
      elDiff.textContent = diff.toUpperCase();
      elRunHUD.textContent = (runMode === 'research') ? 'Research Mode' : 'Play Mode';
      elScore.textContent = '0';
      elCombo.textContent = '0';
      elCombo.dataset.max = '0';
      elMiss.textContent  = '0';
      elPlates.textContent = '0';
      elTime.textContent  = dur + 's';
      hudMissCount = 0;
      comboMax = 0;
      hudGoalsTotal = hudGoalsCleared = hudMiniTotal = hudMiniCleared = 0;
      prevGoalsCleared = prevMiniCleared = 0;
      elGrade.textContent = '-';
      elGradeBar.style.width = '10%';
      elGradeBar.dataset.grade = 'C';

      setCoachFace('neutral');
      setCoach('‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢ üçéü•¶');

      // student profile ‡∏à‡∏≤‡∏Å Hub
      let studentProfile = null;
      let studentKey = null;
      try{
        const raw = sessionStorage.getItem('HHA_STUDENT_PROFILE');
        if (raw){
          studentProfile = JSON.parse(raw);
          studentKey = studentProfile.studentKey || null;
        }
      }catch(err){
        console.warn('[PlateVR] cannot parse student profile:', err);
      }

      // Cloud logger (‡πÉ‡∏ä‡πâ endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö GoodJunk ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏•‡∏∞ projectTag/mode)
      initCloudLogger({
        endpoint: 'https://script.google.com/macros/s/AKfycby7IBVmpmEydNDp5BR3CMaSAjvF7ljptaDwvow_L781iDLsbtpuiFmKviGUnugFerDtQg/exec',
        projectTag: 'HeroHealth-PlateVR',
        mode: 'BalancedPlateVR',
        runMode: runMode,
        diff: diff,
        durationSec: dur,
        studentKey: studentKey,
        profile: studentProfile,
        debug: false
      });

      const cam = document.querySelector('#plate-camera');
      initTouchLook(cam);
      initVRButton();
      initTargetLayerFollowCamera(cam); // ‚òÖ ‡πÉ‡∏´‡πâ layer ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á

      if (elEndRun){
        elEndRun.textContent = (runMode === 'research') ? 'Research' : 'Play';
      }

      const sceneEl = document.querySelector('a-scene');
      if (sceneEl){
        sceneEl.addEventListener('enter-vr', () => {
          isVrMode = true;
          startGazeLoop();
        });
        sceneEl.addEventListener('exit-vr', () => {
          isVrMode = false;
          stopGazeLoop();
        });
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å countdown
      runCountdown(() => {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Plate Engine
        bootPlate({ difficulty: diff, duration: dur, runMode });

        let timeLeft = dur;
        window.dispatchEvent(new CustomEvent('hha:time', { detail:{ sec: timeLeft }}));
        timerId = setInterval(() => {
          if (endedByEvent){
            clearInterval(timerId);
            timerId = null;
            return;
          }
          timeLeft -= 1;
          if (timeLeft < 0){
            clearInterval(timerId);
            timerId = null;
            return;
          }
          window.dispatchEvent(new CustomEvent('hha:time', { detail:{ sec: timeLeft }}));
        }, 1000);
      });

      // ‡∏õ‡∏∏‡πà‡∏° summary
      if (btnReplay){
        btnReplay.addEventListener('click', () => window.location.reload());
      }
      if (btnBackHub){
        btnBackHub.addEventListener('click', () => {
          window.location.href = './hub.html';
        });
      }

      // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ tab ‡∏´‡∏≤‡∏¢
      document.addEventListener('visibilitychange', () => {
        if (document.hidden){
          endedByEvent = true;
          if (timerId){
            clearInterval(timerId);
            timerId = null;
          }
        }
      });

      // ‡∏¢‡∏¥‡∏á event miss ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤ engine ‡πÉ‡∏ä‡πâ hha:miss ‡πÄ‡∏û‡∏¥‡πà‡∏°
      window.addEventListener('hha:miss', () => {
        hudMissCount += 1;
        elMiss.textContent = hudMissCount;
        setCoachFace('sad');
        setCoach('‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ú‡∏±‡∏Å ‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡πÅ‡∏•‡∏∞‡∏ô‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞ üòå');
        updateRealtimeGrade();
      });
    });
  </script>
</body>
</html>