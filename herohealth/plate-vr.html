<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÅ‡∏¢‡∏Å -->
  <link rel="stylesheet" href="./css/plate-vr.css" />

  <!-- A-Frame core (‡πÉ‡∏ä‡πâ scene ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ mode-factory ‡πÉ‡∏ä‡πâ) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Particle FX (global: window.Particles / window.GAME_MODULES.Particles) -->
  <script src="./vr/particles.js"></script>    <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏ï‡∏Å + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡πâ‡∏á -->
  <script src="./vr/ui-fever.js"></script>     <!-- Fever ‡∏Å‡∏•‡∏≤‡∏á -->
</head>
<body>
<div class="app">

  <!-- ===== VR Scene (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á, ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡πâ mode-factory ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á) ===== -->
  <div id="scene-wrap">
    <a-scene
      vr-mode-ui="enabled: true"
      embedded="true"
      renderer="antialias: true; colorManagement: true"
      background="color: #020617"
    >
      <a-entity position="0 1.6 0">
        <!-- ‡πÄ‡∏õ‡∏¥‡∏î touch/mouse ‡∏ä‡∏±‡∏î ‡πÜ -->
        <a-entity
          camera
          look-controls="touchEnabled: true; mouseEnabled: true; pointerLockEnabled: false"
          wasd-controls="enabled: false">
        </a-entity>
      </a-entity>

      <!-- ‡πÑ‡∏ü‡∏à‡∏≤‡∏á ‡πÜ -->
      <a-entity light="type:ambient; color:#ffffff; intensity:0.6"></a-entity>
      <a-entity light="type:directional; color:#ffffff; intensity:0.7" position="0 2 -1"></a-entity>
    </a-scene>
  </div>

  <!-- ===== HUD / UI Overlay ===== -->
  <div id="hud">
    <div class="hud-top">
      <div class="hud-left">
        <div class="hud-title">
          <span>üçΩÔ∏è Balanced Plate VR</span>
          <span class="hud-pill">
            <span class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
            <span id="hud-diff">-</span>
          </span>
        </div>

        <div class="hud-info-row">
          <div class="hud-badge">
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            <span class="value" id="hud-score">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>
            <span class="value" id="hud-combo">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</span>
            <span class="value" id="hud-plates">0</span>
          </div>
          <div class="hud-badge">
            <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
            <span class="value" id="hud-miss">0</span>
          </div>
          <div class="hud-badge hud-badge-grade">
            <span>‡πÄ‡∏Å‡∏£‡∏î</span>
            <span class="value" id="hud-grade">C</span>
          </div>
        </div>

        <!-- Legend ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
        <div class="hud-groups-legend">
          <span>1 ‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á üçöüçû</span>
          <span>2 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ü•©üçó</span>
          <span>3 ‡∏ú‡∏±‡∏Å ü•¶ü•ï</span>
          <span>4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ üçéüçå</span>
          <span>5 ‡∏ô‡∏°/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏° ü•õüßÄ</span>
        </div>
      </div>

      <div class="hud-right">
        <div class="hud-timer">
          <span class="icon">‚è±Ô∏è</span>
          <span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</span>
          <span class="value" id="hud-time">60</span>
          <span>‡∏ß‡∏¥</span>
        </div>
        <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà -->
        <div class="hud-groups" id="hud-groups">
          <span>‡∏´‡∏°‡∏π‡πà 1: <strong id="g1">0</strong></span>
          <span>2: <strong id="g2">0</strong></span>
          <span>3: <strong id="g3">0</strong></span>
          <span>4: <strong id="g4">0</strong></span>
          <span>5: <strong id="g5">0</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Quest Panel ===== -->
  <div id="quest-panel">
    <div class="quest-card">
      <div class="quest-header">
        <span class="title">QUEST ‚Äî ‡∏à‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        <span class="icon">üéØ</span>
      </div>
      <div class="quest-section">
        <div class="quest-label">Goal ‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="quest-text" id="quest-goal">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="quest-section">
        <div class="quest-label">Mini Quest</div>
        <div class="quest-text" id="quest-mini">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤</div>
      </div>
      <div class="quest-hint" id="quest-hint">
        ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏ô 1 ‡∏à‡∏≤‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      </div>
    </div>
  </div>

  <!-- ===== Coach Bubble ===== -->
  <div id="coach-wrap">
    <div class="coach-bubble" id="coach-bubble">
      <div class="coach-avatar">üë©‚Äçüè´</div>
      <div class="coach-text" id="coach-text">
        ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞
      </div>
    </div>
  </div>

  <!-- ===== Toast ‡∏â‡∏•‡∏≠‡∏á‡∏à‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ===== -->
  <div id="quest-toast">
    <div class="quest-toast-inner">
      <div class="quest-toast-title" id="quest-toast-title">Goal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div class="quest-toast-text" id="quest-toast-text">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
      <div class="quest-toast-tag" id="quest-toast-tag">GOAL 1/2</div>
    </div>
  </div>

  <!-- ===== Mega Celebration ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ===== -->
  <div id="mega-celebrate">
    <div class="mega-card">
      <div class="mega-emoji">üåàüçΩÔ∏èüéâ</div>
      <div class="mega-title">Balanced Plate Master!</div>
      <div class="mega-text">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥ Goal ‡πÅ‡∏•‡∏∞ Mini Quest ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </div>

  <!-- ===== Summary Overlay ===== -->
  <div id="summary">
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <h2 id="sum-title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Balanced Plate</h2>
          <p id="sum-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>
        </div>
        <div class="summary-badge" id="sum-diff">‡∏£‡∏∞‡∏î‡∏±‡∏ö -</div>
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
          <strong id="sum-score">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
          <strong id="sum-combo">0</strong>
        </div>
        <div class="summary-item">
          <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
          <strong id="sum-miss">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏î‡πâ</span>
          <strong id="sum-plates">0</strong>
        </div>
        <div class="summary-item">
          <span>Goal ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-goal-done">0</span>/<span id="sum-goal-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>Mini Quest ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-mini-done">0</span>/<span id="sum-mini-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏ß‡∏°</span>
          <strong id="sum-grade">-</strong>
        </div>
      </div>

      <div class="summary-groups">
        <div><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° (‡∏´‡∏°‡∏π‡πà 1‚Äì5):</strong></div>
        <div id="sum-groups">1:0, 2:0, 3:0, 4:0, 5:0</div>
      </div>

      <div class="summary-actions">
        <button class="btn btn-ghost" id="btn-to-hub">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="btn btn-primary" id="btn-restart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
      </div>
    </div>
  </div>

  <!-- ===== Gaze Reticle (VR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ï‡∏•‡∏≠‡∏î) ===== -->
  <div id="gaze-reticle">
    <div class="gaze-dot"></div>
    <div class="gaze-ring"></div>
  </div>

</div>

<!-- ===== Logic ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ plate-vr ===== -->
<script type="module">
  import { boot as bootPlate } from './plate/plate.safe.js';

  // ------- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL -------
  const url = new URL(window.location.href);
  const diffParam = (url.searchParams.get('diff') || 'easy').toLowerCase();
  let duration = parseInt(url.searchParams.get('time') || '60', 10);
  if (!Number.isFinite(duration) || duration <= 0) duration = 60;
  if (duration < 20) duration = 20;
  if (duration > 180) duration = 180;

  // ------- DOM refs HUD -------
  const elDiff    = document.getElementById('hud-diff');
  const elScore   = document.getElementById('hud-score');
  const elCombo   = document.getElementById('hud-combo');
  const elPlates  = document.getElementById('hud-plates');
  const elMiss    = document.getElementById('hud-miss');
  const elGrade   = document.getElementById('hud-grade');
  const elTime    = document.getElementById('hud-time');
  const elG1      = document.getElementById('g1');
  const elG2      = document.getElementById('g2');
  const elG3      = document.getElementById('g3');
  const elG4      = document.getElementById('g4');
  const elG5      = document.getElementById('g5');

  // Quest
  const elQuestGoal = document.getElementById('quest-goal');
  const elQuestMini = document.getElementById('quest-mini');
  const elQuestHint = document.getElementById('quest-hint');

  // Coach
  const elCoachBubble = document.getElementById('coach-bubble');
  const elCoachText   = document.getElementById('coach-text');
  let coachTimer = null;

  // Toast celebrate
  const toastEl       = document.getElementById('quest-toast');
  const toastTitleEl  = document.getElementById('quest-toast-title');
  const toastTextEl   = document.getElementById('quest-toast-text');
  const toastTagEl    = document.getElementById('quest-toast-tag');
  let toastTimer      = null;
  let lastGoalDone    = 0;
  let lastMiniDone    = 0;

  // Mega celebrate
  const megaEl   = document.getElementById('mega-celebrate');
  let megaShown  = false;

  // Summary
  const elSummary      = document.getElementById('summary');
  const elSumTitle     = document.getElementById('sum-title');
  const elSumSub       = document.getElementById('sum-sub');
  const elSumDiff      = document.getElementById('sum-diff');
  const elSumScore     = document.getElementById('sum-score');
  const elSumCombo     = document.getElementById('sum-combo');
  const elSumMiss      = document.getElementById('sum-miss');
  const elSumPlates    = document.getElementById('sum-plates');
  const elSumGoalDone  = document.getElementById('sum-goal-done');
  const elSumGoalTotal = document.getElementById('sum-goal-total');
  const elSumMiniDone  = document.getElementById('sum-mini-done');
  const elSumMiniTotal = document.getElementById('sum-mini-total');
  const elSumGroups    = document.getElementById('sum-groups');
  const elSumGrade     = document.getElementById('sum-grade');

  const btnRestart = document.getElementById('btn-restart');
  const btnToHub   = document.getElementById('btn-to-hub');

  const sceneEl   = document.querySelector('a-scene');
  const gazeEl    = document.getElementById('gaze-reticle');

  // ‡πÅ‡∏õ‡∏•‡∏á diff ‡πÄ‡∏õ‡πá‡∏ô label ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  function diffLabel(d){
    if (d === 'easy') return '‡∏á‡πà‡∏≤‡∏¢';
    if (d === 'hard') return '‡∏¢‡∏≤‡∏Å';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  elDiff.textContent = diffLabel(diffParam);
  elTime.textContent = duration;

  // ------- Clock ‡∏Å‡∏•‡∏≤‡∏á ‡∏™‡πà‡∏á hha:time -------
  let secLeft = duration;
  let timerId = null;
  let endedByEvent = false;

  function tick(){
    if (endedByEvent) return;
    // ‡∏™‡πà‡∏á event ‡πÉ‡∏´‡πâ engine
    window.dispatchEvent(new CustomEvent('hha:time', {
      detail:{ sec: secLeft }
    }));

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HUD
    elTime.textContent = Math.max(secLeft, 0);

    secLeft -= 1;
    if (secLeft < 0) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  timerId = setInterval(tick, 1000);
  tick(); // ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

  // ------- HUD realtime ‡∏à‡∏≤‡∏Å hha:stat -------
  window.addEventListener('hha:stat', (e) => {
    const d = e.detail || {};
    if (typeof d.score === 'number')   elScore.textContent  = d.score;
    if (typeof d.combo === 'number')   elCombo.textContent  = d.combo;
    if (typeof d.misses === 'number')  elMiss.textContent   = d.misses;
    if (typeof d.platesDone === 'number') elPlates.textContent = d.platesDone;
    if (typeof d.grade === 'string')   elGrade.textContent  = d.grade;

    if (Array.isArray(d.totalCounts) && d.totalCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.totalCounts;
      elG1.textContent = g1;
      elG2.textContent = g2;
      elG3.textContent = g3;
      elG4.textContent = g4;
      elG5.textContent = g5;
    }
  });

  // ------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toast ‡∏â‡∏•‡∏≠‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à -------
  function showQuestToast({ kind, title, text, index, total }) {
    if (!toastEl) return;
    toastTitleEl.textContent = title || (kind === 'goal' ? 'Goal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : 'Mini Quest ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    toastTextEl.textContent  = text  || '';
    toastTagEl.textContent   = (kind === 'goal'
      ? `GOAL ${index}/${total || '-'}`
      : `MINI ${index}/${total || '-'}`);

    toastEl.classList.remove('goal','mini');
    toastEl.classList.add(kind === 'goal' ? 'goal' : 'mini');
    toastEl.classList.add('show');

    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toastEl.classList.remove('show');
    }, 2200);
  }

  // ------- Quest realtime (quota ‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î + emoji + ‡πÄ‡∏ä‡πá‡∏Ñ progress) -------
  window.addEventListener('quest:update', (e) => {
    const d = e.detail || {};
    const goal = d.goal || {};
    const mini = d.mini || {};

    const goalText = goal.text || goal.title || goal.label || goal.name || '‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà';
    const miniText = mini.text || mini.title || mini.label || mini.name || '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤';

    elQuestGoal.textContent = goalText;
    elQuestMini.textContent = miniText;

    // 1) ‡πÅ‡∏™‡∏î‡∏á quota ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà
    if (elQuestHint) {
      elQuestHint.innerHTML = '';

      const need = d.quotaNeed;
      const have = d.quotaHave;

      if (Array.isArray(need) && Array.isArray(have)) {
        const icons = ['üçö', 'ü•©', 'ü•¶', 'üçé', 'ü•õ'];
        const names = ['‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á', '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', '‡∏ú‡∏±‡∏Å', '‡∏ú‡∏•‡πÑ‡∏°‡πâ', '‡∏ô‡∏°'];

        const title = document.createElement('div');
        title.className = 'quest-hint-title';
        title.textContent = '‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏ô 1 ‡∏à‡∏≤‡∏ô (‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏π‡πà):';
        elQuestHint.appendChild(title);

        need.forEach((quota, i) => {
          const haveVal = have[i] ?? 0;
          const line = document.createElement('div');
          line.className = 'quest-hint-line';
          if (haveVal < quota) line.classList.add('missing');
          else line.classList.add('ok');

          const icon = document.createElement('span');
          icon.className = 'quest-hint-icon';
          icon.textContent = icons[i];

          const label = document.createElement('span');
          label.className = 'quest-hint-label';
          label.textContent = names[i];

          const textSpan = document.createElement('span');
          textSpan.className = 'quest-hint-text';
          textSpan.textContent = `${haveVal} / ${quota}`;

          line.append(icon, label, textSpan);
          elQuestHint.appendChild(line);
        });
      } else if (d.hint) {
        elQuestHint.textContent = d.hint;
      }
    }

    // 2) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà done ‡πÄ‡∏û‡∏∑‡πà‡∏≠ trigger toast
    const goalsAll = Array.isArray(d.goalsAll) ? d.goalsAll : [];
    const minisAll = Array.isArray(d.minisAll) ? d.minisAll : [];

    const goalDone = goalsAll.filter(x => x && x.done).length;
    const miniDone = minisAll.filter(x => x && x.done).length;

    if (goalDone > lastGoalDone) {
      const idx = goalDone;
      const q = goalsAll.find(x => x && x.done && !x._toastShown);
      if (q) q._toastShown = true;
      showQuestToast({
        kind: 'goal',
        title: 'Goal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
        text:  (q && (q.text || q.label || q.title)) || goalText,
        index: idx,
        total: goalsAll.length || 2
      });
    } else if (miniDone > lastMiniDone) {
      const idx = miniDone;
      const q = minisAll.find(x => x && x.done && !x._toastShown);
      if (q) q._toastShown = true;
      showQuestToast({
        kind: 'mini',
        title: 'Mini Quest ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
        text:  (q && (q.text || q.label || q.title)) || miniText,
        index: idx,
        total: minisAll.length || 3
      });
    }

    lastGoalDone = goalDone;
    lastMiniDone = miniDone;
  });

  // ------- Coach Bubble -------
  function showCoach(text){
    if (!text) return;
    elCoachText.textContent = text;
    elCoachBubble.classList.add('show');
    if (coachTimer) clearTimeout(coachTimer);
    coachTimer = setTimeout(() => {
      elCoachBubble.classList.remove('show');
    }, 3500);
  }

  window.addEventListener('hha:coach', (e) => {
    const d = e.detail || {};
    if (d.text) showCoach(d.text);
  });

  // ------- Summary + Mega Celebration ‡∏à‡∏≤‡∏Å hha:end -------
  window.addEventListener('hha:end', (e) => {
    const d = e.detail || {};
    endedByEvent = true;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏°‡∏à‡∏ö
    document.body.classList.add('hha-game-ended');

    elSumTitle.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${d.mode || 'Balanced Plate'}`;
    elSumSub.textContent   = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${d.duration || duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
    elSumDiff.textContent  = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)}`;

    elSumScore.textContent  = d.score ?? 0;
    elSumCombo.textContent  = d.comboMax ?? 0;
    elSumMiss.textContent   = d.misses ?? 0;
    elSumPlates.textContent = d.platesDone ?? 0;

    elSumGoalDone.textContent  = d.goalsCleared ?? 0;
    elSumGoalTotal.textContent = d.goalsTotal ?? 0;
    elSumMiniDone.textContent  = d.questsCleared ?? 0;
    elSumMiniTotal.textContent = d.questsTotal ?? 0;
    elSumGrade.textContent     = d.grade || '-';

    if (Array.isArray(d.groupCounts) && d.groupCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.groupCounts;
      elSumGroups.textContent = `1: ${g1}   2: ${g2}   3: ${g3}   4: ${g4}   5: ${g5}`;
    } else {
      elSumGroups.textContent = '-';
    }

    const allCleared =
      (d.goalsTotal  > 0 && d.goalsCleared  >= d.goalsTotal) &&
      (d.questsTotal > 0 && d.questsCleared >= d.questsTotal);

    if (allCleared && megaEl && !megaShown) {
      megaShown = true;
      megaEl.classList.add('show');
      // ‡πÅ‡∏™‡∏î‡∏á‡∏â‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏±‡∏Å‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
      setTimeout(() => {
        megaEl.classList.remove('show');
        elSummary.classList.add('visible');
      }, 1700);
    } else {
      elSummary.classList.add('visible');
    }
  });

  // ------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö / ‡∏Å‡∏•‡∏±‡∏ö Hub -------
  btnRestart.addEventListener('click', () => {
    const base = window.location.pathname.split('/').pop() || 'plate-vr.html';
    const search = `?diff=${encodeURIComponent(diffParam)}&time=${encodeURIComponent(duration)}`;
    window.location.href = base + search;
  });

  btnToHub.addEventListener('click', () => {
    window.location.href = './hub.html';
  });

  // ------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° Plate Engine -------
  bootPlate({ difficulty: diffParam, duration });

  // ================== Gaze & Fuse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VR ==================

  let isVrMode = false;

  const GAZE_RADIUS = 70;     // ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÇ‡∏î‡∏ô (px)
  const FUSE_MS     = 1100;   // ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (ms)

  let gazeTimerId   = null;
  let gazeTarget    = null;
  let gazeStartTs   = 0;

  function findTargetNearCenter() {
    const targets = document.querySelectorAll('.hha-target');
    if (!targets.length) return { el: null, dist: Infinity };

    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    let best = null;
    let bestDist = Infinity;

    targets.forEach(el => {
      const rect = el.getBoundingClientRect();
      const tx = rect.left + rect.width / 2;
      const ty = rect.top  + rect.height / 2;
      const dx = tx - cx;
      const dy = ty - cy;
      const dist = Math.hypot(dx, dy);
      if (dist < bestDist) {
        bestDist = dist;
        best = el;
      }
    });

    return { el: best, dist: bestDist };
  }

  function hitTargetAtCenter() {
    const { el, dist } = findTargetNearCenter();
    if (!el || dist > GAZE_RADIUS) return false;
    el.click();
    return true;
  }

  function gazeTick() {
    const { el, dist } = findTargetNearCenter();

    if (!el || dist > GAZE_RADIUS) {
      gazeTarget = null;
      gazeStartTs = 0;
      if (gazeEl) gazeEl.classList.remove('fuse-active');
      return;
    }

    const now = performance.now();

    if (el === gazeTarget) {
      const elapsed = now - gazeStartTs;
      if (elapsed >= FUSE_MS) {
        if (gazeEl) gazeEl.classList.remove('fuse-active');
        el.click();
        gazeTarget = null;
        gazeStartTs = 0;
      }
    } else {
      gazeTarget = el;
      gazeStartTs = now;
      if (gazeEl) {
        gazeEl.classList.remove('fuse-active');
        // force reflow ‡πÉ‡∏´‡πâ animation ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
        void gazeEl.offsetWidth;
        gazeEl.classList.add('fuse-active');
      }
    }
  }

  function startGazeLoop() {
    if (gazeTimerId) return;
    gazeTimerId = setInterval(gazeTick, 100);
  }

  function stopGazeLoop() {
    if (!gazeTimerId) return;
    clearInterval(gazeTimerId);
    gazeTimerId = null;
    gazeTarget = null;
    gazeStartTs = 0;
    if (gazeEl) gazeEl.classList.remove('fuse-active');
  }

  if (sceneEl) {
    sceneEl.addEventListener('enter-vr', () => {
      isVrMode = true;
      document.body.classList.add('hha-vr-mode');
      startGazeLoop();
    });
    sceneEl.addEventListener('exit-vr', () => {
      isVrMode = false;
      document.body.classList.remove('hha-vr-mode');
      stopGazeLoop();
    });
  }

  // pointer / key ‚Üí ‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πâ‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô VR)
  function handlePointerDownForGaze(ev) {
    if (!isVrMode) return;

    const path = ev.composedPath ? ev.composedPath() : [ev.target];
    const hitUI = path.some(node => {
      if (!node || !node.closest) return false;
      return node.closest('#summary') ||
             node.closest('#hud')     ||
             node.closest('button');
    });
    if (hitUI) return;

    const hitTargetDirect = path.some(node =>
      node && node.classList && node.classList.contains('hha-target')
    );
    if (hitTargetDirect) return;

    hitTargetAtCenter();
  }

  function handleKeyDownForGaze(ev) {
    if (!isVrMode) return;
    if (ev.code === 'Space' || ev.code === 'Enter') {
      const ok = hitTargetAtCenter();
      if (ok) ev.preventDefault();
    }
  }

  window.addEventListener('pointerdown', handlePointerDownForGaze, { passive:true });
  window.addEventListener('keydown', handleKeyDownForGaze);
</script>

</body>
</html>