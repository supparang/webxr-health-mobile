<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health ‚Äî Balanced Plate VR</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÅ‡∏¢‡∏Å -->
  <link rel="stylesheet" href="./css/plate-vr.css" />

  <!-- A-Frame core (‡πÉ‡∏ä‡πâ scene ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ mode-factory ‡πÉ‡∏ä‡πâ) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Particle FX + Fever UI (global IIFE) -->
  <script src="./vr/particles.js"></script>
  <script src="./vr/ui-fever.js"></script>
</head>
<body>
<div class="app">

  <!-- ===== VR Scene ===== -->
  <div id="scene-wrap">
    <a-scene
      vr-mode-ui="enabled: true"
      embedded="true"
      renderer="antialias: true; colorManagement: true"
      background="color: #020617"
    >
      <a-entity position="0 1.6 0">
        <a-entity camera look-controls wasd-controls="enabled: false"></a-entity>
      </a-entity>
      <!-- ‡πÑ‡∏ü‡∏à‡∏≤‡∏á ‡πÜ -->
      <a-entity light="type:ambient; color:#ffffff; intensity:0.6"></a-entity>
      <a-entity light="type:directional; color:#ffffff; intensity:0.7" position="0 2 -1"></a-entity>
    </a-scene>
  </div>

  <!-- ===== HUD / UI Overlay ===== -->
  <div id="hud">
    <div class="hud-top">
      <div class="hud-left">
        <div class="hud-title">
          <span>üçΩÔ∏è Balanced Plate VR</span>
          <span class="hud-pill">
            <span class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
            <span id="hud-diff">-</span>
          </span>
        </div>

        <div class="hud-info-row">
          <div class="hud-badge">
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            <span class="value" id="hud-score">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>
            <span class="value" id="hud-combo">0</span>
          </div>
          <div class="hud-badge">
            <span>‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</span>
            <span class="value" id="hud-plates">0</span>
          </div>
          <div class="hud-badge">
            <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
            <span class="value" id="hud-miss">0</span>
          </div>
          <!-- ‚úÖ ‡πÄ‡∏Å‡∏£‡∏î real-time -->
          <div class="hud-badge hud-badge-grade">
            <span>‡πÄ‡∏Å‡∏£‡∏î (real-time)</span>
            <span class="value" id="hud-grade">-</span>
          </div>
        </div>

        <!-- ‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏à‡∏≥‡∏á‡πà‡∏≤‡∏¢) -->
        <div class="hud-groups-legend">
          <span>1 ‡∏Ç‡πâ‡∏≤‡∏ß-‡πÅ‡∏õ‡πâ‡∏á üçöüçû</span>
          <span>2 ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô ü•©üçó</span>
          <span>3 ‡∏ú‡∏±‡∏Å ü•¶ü•ï</span>
          <span>4 ‡∏ú‡∏•‡πÑ‡∏°‡πâ üçéüçå</span>
          <span>5 ‡∏ô‡∏°/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏° ü•õüßÄ</span>
        </div>
      </div>

      <div class="hud-right">
        <div class="hud-timer">
          <span class="icon">‚è±Ô∏è</span>
          <span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</span>
          <span class="value" id="hud-time">60</span>
          <span>‡∏ß‡∏¥</span>
        </div>
        <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà -->
        <div class="hud-groups" id="hud-groups">
          <span>‡∏´‡∏°‡∏π‡πà 1: <strong id="g1">0</strong></span>
          <span>2: <strong id="g2">0</strong></span>
          <span>3: <strong id="g3">0</strong></span>
          <span>4: <strong id="g4">0</strong></span>
          <span>5: <strong id="g5">0</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Quest Panel ===== -->
  <div id="quest-panel">
    <div class="quest-card">
      <div class="quest-header">
        <span class="title">QUEST ‚Äî ‡∏à‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        <span class="icon">üéØ</span>
      </div>
      <div class="quest-section">
        <div class="quest-label">Goal ‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="quest-text" id="quest-goal">‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà</div>
      </div>
      <div class="quest-section">
        <div class="quest-label">Mini Quest</div>
        <div class="quest-text" id="quest-mini">‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤</div>
      </div>
      <div class="quest-hint" id="quest-hint">
        ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏ô 1 ‡∏à‡∏≤‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      </div>
      <!-- ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Goal / Mini ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° -->
      <div class="quest-hint" id="quest-status">
        Goal: 0/0 ‚Ä¢ Mini: 0/0
      </div>
    </div>
  </div>

  <!-- ===== Coach Bubble ===== -->
  <div id="coach-wrap">
    <div class="coach-bubble" id="coach-bubble">
      <div class="coach-avatar">üë©‚Äçüè´</div>
      <div class="coach-text" id="coach-text">
        ‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞
      </div>
    </div>
  </div>

  <!-- ===== Summary Overlay ===== -->
  <div id="summary">
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <h2 id="sum-title">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Balanced Plate</h2>
          <p id="sum-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>
        </div>
        <div class="summary-badge" id="sum-diff">‡∏£‡∏∞‡∏î‡∏±‡∏ö -</div>
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
          <strong id="sum-score">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
          <strong id="sum-combo">0</strong>
        </div>
        <div class="summary-item">
          <span>‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ (MISS)</span>
          <strong id="sum-miss">0</strong>
        </div>
        <div class="summary-item">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏î‡πâ</span>
          <strong id="sum-plates">0</strong>
        </div>
        <div class="summary-item">
          <span>Goal ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-goal-done">0</span>/<span id="sum-goal-total">0</span></strong>
        </div>
        <div class="summary-item">
          <span>Mini Quest ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          <strong><span id="sum-mini-done">0</span>/<span id="sum-mini-total">0</span></strong>
        </div>
      </div>

      <div class="summary-groups">
        <div><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° (‡∏´‡∏°‡∏π‡πà 1‚Äì5):</strong></div>
        <div id="sum-groups">1:0, 2:0, 3:0, 4:0, 5:0</div>
      </div>

      <div class="summary-actions">
        <button class="btn btn-ghost" id="btn-to-hub">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö Hub</button>
        <button class="btn btn-primary" id="btn-restart">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö</button>
      </div>
    </div>
  </div>

</div>

<!-- ===== Logic ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ plate-vr ===== -->
<script type="module">
  import { boot as bootPlate } from './plate/plate.safe.js';

  // ------- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL -------
  const url = new URL(window.location.href);
  const diffParam = (url.searchParams.get('diff') || 'easy').toLowerCase();
  let duration = parseInt(url.searchParams.get('time') || '60', 10);
  if (!Number.isFinite(duration) || duration <= 0) duration = 60;
  if (duration < 20) duration = 20;
  if (duration > 180) duration = 180;

  // ------- DOM refs HUD -------
  const elDiff    = document.getElementById('hud-diff');
  const elScore   = document.getElementById('hud-score');
  const elCombo   = document.getElementById('hud-combo');
  const elPlates  = document.getElementById('hud-plates');
  const elMiss    = document.getElementById('hud-miss');
  const elTime    = document.getElementById('hud-time');
  const elG1      = document.getElementById('g1');
  const elG2      = document.getElementById('g2');
  const elG3      = document.getElementById('g3');
  const elG4      = document.getElementById('g4');
  const elG5      = document.getElementById('g5');
  const elGrade   = document.getElementById('hud-grade');

  // Quest
  const elQuestGoal   = document.getElementById('quest-goal');
  const elQuestMini   = document.getElementById('quest-mini');
  const elQuestHint   = document.getElementById('quest-hint');
  const elQuestStatus = document.getElementById('quest-status');

  // Coach
  const elCoachBubble = document.getElementById('coach-bubble');
  const elCoachText   = document.getElementById('coach-text');
  let coachTimer = null;

  // Summary
  const elSummary      = document.getElementById('summary');
  const elSumTitle     = document.getElementById('sum-title');
  const elSumSub       = document.getElementById('sum-sub');
  const elSumDiff      = document.getElementById('sum-diff');
  const elSumScore     = document.getElementById('sum-score');
  const elSumCombo     = document.getElementById('sum-combo');
  const elSumMiss      = document.getElementById('sum-miss');
  const elSumPlates    = document.getElementById('sum-plates');
  const elSumGoalDone  = document.getElementById('sum-goal-done');
  const elSumGoalTotal = document.getElementById('sum-goal-total');
  const elSumMiniDone  = document.getElementById('sum-mini-done');
  const elSumMiniTotal = document.getElementById('sum-mini-total');
  const elSumGroups    = document.getElementById('sum-groups');

  const btnRestart = document.getElementById('btn-restart');
  const btnToHub   = document.getElementById('btn-to-hub');

  // ‡πÅ‡∏õ‡∏•‡∏á diff ‡πÄ‡∏õ‡πá‡∏ô label ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
  function diffLabel(d){
    if (d === 'easy') return '‡∏á‡πà‡∏≤‡∏¢';
    if (d === 'hard') return '‡∏¢‡∏≤‡∏Å';
    return '‡∏õ‡∏Å‡∏ï‡∏¥';
  }

  elDiff.textContent = diffLabel(diffParam);
  elTime.textContent = duration;

  // ------- Clock ‡∏Å‡∏•‡∏≤‡∏á ‡∏™‡πà‡∏á hha:time -------
  let secLeft = duration;
  let timerId = null;
  let endedByEvent = false;

  function tick(){
    if (endedByEvent) return;
    // ‡∏™‡πà‡∏á event ‡πÉ‡∏´‡πâ engine
    window.dispatchEvent(new CustomEvent('hha:time', {
      detail:{ sec: secLeft }
    }));

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HUD
    elTime.textContent = Math.max(secLeft, 0);

    secLeft -= 1;
    if (secLeft < 0) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° timer ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
  timerId = setInterval(tick, 1000);
  // ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (sec = duration)
  tick();

  // ------- HUD realtime ‡∏à‡∏≤‡∏Å hha:stat -------
  window.addEventListener('hha:stat', (e) => {
    const d = e.detail || {};
    if (typeof d.score === 'number')   elScore.textContent  = d.score;
    if (typeof d.combo === 'number')   elCombo.textContent  = d.combo;
    if (typeof d.misses === 'number')  elMiss.textContent   = d.misses;
    if (typeof d.platesDone === 'number') elPlates.textContent = d.platesDone;

    if (Array.isArray(d.totalCounts) && d.totalCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.totalCounts;
      elG1.textContent = g1;
      elG2.textContent = g2;
      elG3.textContent = g3;
      elG4.textContent = g4;
      elG5.textContent = g5;
    }

    // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Goal / Mini ‡πÅ‡∏ö‡∏ö real-time
    if (typeof d.goalsCleared === 'number' && typeof d.goalsTotal === 'number' &&
        typeof d.questsCleared === 'number' && typeof d.questsTotal === 'number') {
      elQuestStatus.textContent =
        `Goal: ${d.goalsCleared}/${d.goalsTotal} ‚Ä¢ Mini: ${d.questsCleared}/${d.questsTotal}`;
    }

    // ‚úÖ ‡πÄ‡∏Å‡∏£‡∏î real-time + ‡∏™‡∏µ
    if (d.grade) {
      elGrade.textContent = d.grade;
      const badge = elGrade.parentElement;
      badge.classList.remove(
        'hud-badge-grade-SSS',
        'hud-badge-grade-SS',
        'hud-badge-grade-S',
        'hud-badge-grade-A',
        'hud-badge-grade-B',
        'hud-badge-grade-C'
      );
      badge.classList.add('hud-badge-grade-' + d.grade);
    }
  });

  // ------- Quest realtime -------
  window.addEventListener('quest:update', (e) => {
    const d = e.detail || {};
    const goal = d.goal || {};
    const mini = d.mini || {};

    const goalText = goal.text || goal.title || goal.label || goal.name || '‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà';
    const miniText = mini.text || mini.title || mini.label || mini.name || '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤';

    elQuestGoal.textContent = goalText;
    elQuestMini.textContent = miniText;
    elQuestHint.textContent = d.hint || elQuestHint.textContent;
  });

  // ------- Coach Bubble -------
  function showCoach(text){
    if (!text) return;
    elCoachText.textContent = text;
    elCoachBubble.classList.add('show');
    if (coachTimer) clearTimeout(coachTimer);
    coachTimer = setTimeout(() => {
      elCoachBubble.classList.remove('show');
    }, 3500);
  }

  window.addEventListener('hha:coach', (e) => {
    const d = e.detail || {};
    if (d.text) showCoach(d.text);
  });

  // ------- Summary ‡∏à‡∏≤‡∏Å hha:end -------
  window.addEventListener('hha:end', (e) => {
    const d = e.detail || {};
    endedByEvent = true;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }

    const grade = d.grade || '-';

    elSumTitle.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${d.mode || 'Balanced Plate'}`;
    elSumSub.textContent   =
      `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)} ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${d.duration || duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
    elSumDiff.textContent  =
      `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${diffLabel(d.difficulty || diffParam)} ‚Ä¢ ‡πÄ‡∏Å‡∏£‡∏î ${grade}`;

    elSumScore.textContent  = d.score ?? 0;
    elSumCombo.textContent  = d.comboMax ?? 0;
    elSumMiss.textContent   = d.misses ?? 0;
    elSumPlates.textContent = d.platesDone ?? 0;

    elSumGoalDone.textContent  = d.goalsCleared ?? 0;
    elSumGoalTotal.textContent = d.goalsTotal ?? 0;
    elSumMiniDone.textContent  = d.questsCleared ?? 0;
    elSumMiniTotal.textContent = d.questsTotal ?? 0;

    if (Array.isArray(d.groupCounts) && d.groupCounts.length >= 5) {
      const [g1,g2,g3,g4,g5] = d.groupCounts;
      elSumGroups.textContent = `1: ${g1}   2: ${g2}   3: ${g3}   4: ${g4}   5: ${g5}`;
    } else {
      elSumGroups.textContent = '-';
    }

    elSummary.classList.add('visible');
  });

  // ------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö / ‡∏Å‡∏•‡∏±‡∏ö Hub -------
  btnRestart.addEventListener('click', () => {
    const base = window.location.pathname.split('/').pop() || 'plate-vr.html';
    const search = `?diff=${encodeURIComponent(diffParam)}&time=${encodeURIComponent(duration)}`;
    window.location.href = base + search;
  });

  btnToHub.addEventListener('click', () => {
    window.location.href = './hub.html';
  });

  // ------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° Plate Engine -------
  bootPlate({ difficulty: diffParam, duration });
</script>

</body>
</html>