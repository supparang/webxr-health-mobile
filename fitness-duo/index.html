<script src="./profile.js"></script>
<script src="./missions.js"></script>
<script>
(function(){
  const box = document.createElement('section');
  box.className='card';
  box.innerHTML = `
    <h2 style="margin:0 0 6px">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h2>
    <div id="profileBox" class="hint">loading‚Ä¶</div>
    <div style="margin-top:10px">
      <h3 style="margin:12px 0 6px">üî• Daily</h3>
      <div id="dailyBox" class="hint"></div>
      <h3 style="margin:12px 0 6px">üìÖ Weekly</h3>
      <div id="weeklyBox" class="hint"></div>
      <h3 style="margin:12px 0 6px">‚õìÔ∏è Chain-3</h3>
      <div id="chainBox" class="hint"></div>
    </div>
  `;
  document.querySelector('main .grid').appendChild(box);

  function rMoney(n){ return new Intl.NumberFormat().format(n||0); }
  function render(){
    const p = DuoProfile.load();
    document.getElementById('profileBox').innerHTML =
      `‡∏ä‡∏∑‡πà‡∏≠: <b>${p.name}</b> ‚Ä¢ Lv ${p.level} ‚Ä¢ XP ${p.xp}/${DuoProfile.needXP(p.level)} ‚Ä¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: ${rMoney(p.coins)}<br>
       ‡∏£‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô: ${p.totals.play} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Ä¢ ‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏£‡∏ß‡∏°: ${rMoney(p.totals.score)} ‚Ä¢ Combo-best: ${p.totals.comboBest} ‚Ä¢ ACC-best: ${(p.totals.accBest*100).toFixed(0)}%<br>
       ‡πÅ‡∏ö‡∏î‡∏à‡πå: ${p.badges.length? p.badges.join(', ') : '‚Äî'}`;

    const m = DuoMissions.getProgress();
    const make = t => t.map(x=>{
      const goal = x.metric==='acc' ? `${(x.target*100).toFixed(0)}%` : x.target;
      const btn = x.claimed ? `<button disabled>CLAIMED</button>` : (x.cleared? `<button data-claim="${x.id}">CLAIM</button>` : `<button disabled>LOCKED</button>`);
      return `<div style="margin:6px 0;padding:6px;border:1px solid #334155;border-radius:10px">
        <b>${x.id}</b> ‚Äì ${x.name} (‡πÄ‡∏õ‡πâ‡∏≤: ${goal}) ${btn}
      </div>`;
    }).join('');

    document.getElementById('dailyBox').innerHTML  = make(m.daily);
    document.getElementById('weeklyBox').innerHTML = make(m.weekly);
    document.getElementById('chainBox').innerHTML  = make(m.chain);

    document.querySelectorAll('[data-claim]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        const id=e.currentTarget.getAttribute('data-claim');
        if(DuoMissions.claim(id)){ alert('‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß!'); render(); }
      });
    });
  }
  render();
})();
</script>
