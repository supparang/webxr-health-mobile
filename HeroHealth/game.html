<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¥¦ Good vs Junk ğŸ”</title>
    <style>
        /* CSS à¸à¸·à¹‰à¸™à¸à¸²à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¸™à¹‰à¸²à¸ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹à¸¥à¸°à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
          (CSS à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸à¸¡, à¸ à¸²à¸£à¸à¸´à¸ˆ, à¹à¸¥à¸°à¹à¸–à¸š Fever à¸ˆà¸°à¸–à¸¹à¸à¸‰à¸µà¸”à¹€à¸‚à¹‰à¸²à¸¡à¸²à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸ˆà¸²à¸à¹‚à¸„à¹‰à¸” JS)
        */
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;700&display=swap');
        
        body {
            font-family: 'IBM Plex Sans Thai', system-ui, -apple-system, sans-serif;
            background-color: #0b1222;
            color: #e8eefc;
            margin: 0;
            padding: 0;
            overflow: hidden; /* à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸‚à¸“à¸°à¹€à¸¥à¹ˆà¸™ */
            touch-action: none; /* à¸›à¸´à¸”à¸à¸²à¸£à¸‹à¸¹à¸¡/à¹€à¸¥à¸·à¹ˆà¸­à¸™ à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ */
        }
        #uiOverlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            transition: opacity 0.3s ease;
        }
        #uiOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #uiOverlay h1 {
            font-size: 3rem;
            margin: 0 0 1rem 0;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,.5));
        }
        #uiOverlay h2 {
            font-size: 2.2rem;
            color: #f59e0b;
        }
        .game-button {
            font-family: 'IBM Plex Sans Thai', system-ui, -apple-system, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(145deg, #22c55e, #16a34a);
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            transition: all 0.2s ease;
            margin: 8px;
        }
        .game-button:hover, .game-button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        }
        .game-button.hard {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .game-button.hard:hover, .game-button.hard:active {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }
        #resultsData {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            text-align: left;
            font-size: 1rem;
            line-height: 1.6;
            max-width: 400px;
            margin: 1rem auto;
            border: 1px solid #334155;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>

    <div id="uiOverlay">
        <div id="startScreen">
            <h1>ğŸ¥¦ Good vs Junk ğŸ”</h1>
            <p style="font-size: 1.1rem; max-width: 400px; opacity: 0.9;">à¸„à¸¥à¸´à¸/à¹à¸•à¸° "à¸‚à¸­à¸‡à¸”à¸µ" à¹à¸¥à¸° "à¸à¸²à¸§à¹€à¸§à¸­à¸£à¹Œà¸­à¸±à¸›" à¹€à¸à¸·à¹ˆà¸­à¸—à¸³à¸„à¸°à¹à¸™à¸™<br>à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡ "à¸‚à¸­à¸‡à¸‚à¸¢à¸°" à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰à¹‚à¸¥à¹ˆà¸›à¹‰à¸­à¸‡à¸à¸±à¸™!</p>
            <button class="game-button" id="startButtonEasy">à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (Easy)</button>
            <button class="game-button" id="startButtonNormal">à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (Normal)</button>
            <button class="game-button hard" id="startButtonHard">à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡ (Hard)</button>
        </div>
        <div id="resultsScreen" style="display:none;">
            <h2>à¹€à¸à¸¡à¸ˆà¸šà¹à¸¥à¹‰à¸§!</h2>
            <pre id="resultsData"></pre>
            <button class="game-button" id="playAgainButton">à¹€à¸¥à¹ˆà¸™à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡</button>
        </div>
    </div>

    <script>
        (function() {
            // à¸ªà¸£à¹‰à¸²à¸‡ Namespace à¸à¸¥à¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£ import/export
            const GAME_MODULES = {};

            // --- 1. /vr/mission.js ---
            (function(exports) {
                'use strict';
                // à¹€à¸”à¹‡à¸„à¸ à¸²à¸£à¸à¸´à¸ˆ 3 à¹ƒà¸š + à¸•à¸±à¸§à¸™à¸±à¸šà¸ªà¸–à¸²à¸™à¸° à¹ƒà¸Šà¹‰à¹ƒà¸™à¸—à¸¸à¸à¹‚à¸«à¸¡à¸”
                exports.MissionDeck = class MissionDeck {
                Â  constructor(opts = {}) {
                Â  Â  this.pool = (opts.pool && Array.isArray(opts.pool)) ? opts.pool : [
                Â  Â  Â  { id:'good10',Â  Â  level:'easy',Â  Â label:'à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¸”à¸µ 10 à¸Šà¸´à¹‰à¸™',Â  Â  Â  Â check:s=>s.goodCount>=10,Â  Â  prog:s=>Math.min(10, s.goodCount), target:10 },
                Â  Â  Â  { id:'avoid5',Â  Â  level:'easy',Â  Â label:'à¸«à¸¥à¸µà¸à¸‚à¸­à¸‡à¸‚à¸¢à¸° 5 à¸„à¸£à¸±à¹‰à¸‡',Â  Â  Â  Â check:s=>s.junkMiss>=5,Â  Â  Â  prog:s=>Math.min(5,Â  s.junkMiss),Â  target:5Â  },
                Â  Â  Â  { id:'combo10',Â  Â level:'normal', label:'à¸—à¸³à¸„à¸­à¸¡à¹‚à¸š 10',Â  Â  Â  Â  Â  Â  Â  check:s=>s.comboMax>=10,Â  Â  Â prog:s=>Math.min(10, s.comboMax),Â  target:10 },
                Â  Â  Â  { id:'good20',Â  Â  level:'normal', label:'à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¸”à¸µ 20 à¸Šà¸´à¹‰à¸™',Â  Â  Â  Â check:s=>s.goodCount>=20,Â  Â  prog:s=>Math.min(20, s.goodCount), target:20 },
                Â  Â  Â  { id:'nostreak10',level:'normal', label:'à¹„à¸¡à¹ˆà¸à¸¥à¸²à¸” 10 à¸§à¸´',Â  Â  Â  Â  Â  Â  check:s=>s.noMissTime>=10,Â  Â prog:s=>Math.min(10, s.noMissTime),target:10 },
                Â  Â  Â  { id:'fever2',Â  Â  level:'hard',Â  Â label:'à¹€à¸‚à¹‰à¸² Fever 2 à¸„à¸£à¸±à¹‰à¸‡',Â  Â  Â  Â check:s=>s.feverCount>=2,Â  Â  prog:s=>Math.min(2,Â  s.feverCount),target:2Â  },
                Â  Â  Â  { id:'combo20',Â  Â level:'hard',Â  Â label:'à¸„à¸­à¸¡à¹‚à¸š 20 à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡',Â  Â  Â  check:s=>s.comboMax>=20,Â  Â  Â prog:s=>Math.min(20, s.comboMax),Â  target:20 },
                Â  Â  Â  { id:'score500',Â  level:'hard',Â  Â label:'à¸—à¸³à¸„à¸°à¹à¸™à¸™ 500+',Â  Â  Â  Â  Â  Â  Â check:s=>s.score>=500,Â  Â  Â  Â prog:s=>Math.min(500,s.score),Â  Â  Â target:500},
                Â  Â  Â  { id:'star3',Â  Â  Â level:'normal', label:'à¹€à¸à¹‡à¸šà¸”à¸²à¸§ â­ 3 à¸”à¸§à¸‡',Â  Â  Â  Â  Â  check:s=>s.star>=3,Â  Â  Â  Â  Â  prog:s=>Math.min(3,Â  s.star),Â  Â  Â  target:3Â  },
                Â  Â  Â  { id:'diamond1',Â  level:'hard',Â  Â label:'à¹€à¸à¹‡à¸šà¹€à¸à¸Šà¸£ ğŸ’ 1 à¹€à¸¡à¹‡à¸”',Â  Â  Â  Â  check:s=>s.diamond>=1,Â  Â  Â  Â prog:s=>Math.min(1,Â  s.diamond),Â  Â target:1Â  },
                Â  Â  ];
                Â  Â  this.reset();
                Â  }
                Â  reset() {
                Â  Â  this.currentIndex = 0;
                Â  Â  this.deck = [];
                Â  Â  this.stats = { goodCount:0, junkMiss:0, comboMax:0, noMissTime:0, feverCount:0, score:0, star:0, diamond:0, shield:0 };
                Â  Â  this._paused = false;
                Â  }
                Â  draw3() {
                Â  Â  this.reset();
                Â  Â  const pickBy = lvl => {
                Â  Â  Â  const c = this.pool.filter(q=>q.level===lvl);
                Â  Â  Â  return c.length ? c[(Math.random()*c.length)|0] : this.pool[(Math.random()*this.pool.length)|0];
                Â  Â  };
                Â  Â  const chosen=new Map();
                Â  Â  ['easy','normal','hard'].forEach(lv=>{
                Â  Â  Â  let q=pickBy(lv), guard=40;
                Â  Â  Â  while(chosen.has(q.id) && guard-- > 0) q=pickBy(lv);
                Â  Â  Â  chosen.set(q.id,q);
                Â  Â  });
                Â  Â  this.deck = Array.from(chosen.values()).slice(0,3);
                Â  Â  return this.deck;
                Â  }
                Â  pause(){ this._paused=true; }
                Â  resume(){ this._paused=false; }
                Â  second(){ if(!this._paused){ this.stats.noMissTime=Math.min(9999,this.stats.noMissTime+1); this._autoAdvance(); } }
                Â  onGood(){ this.stats.goodCount++; this._autoAdvance(); }
                Â  onJunk(){ this.stats.junkMiss++; this.stats.noMissTime=0; this._autoAdvance(); }
                Â  onFeverStart(){ this.stats.feverCount++; this._autoAdvance(); }
                Â  onStar(){ this.stats.star++; this._autoAdvance(); }
                Â  onDiamond(){ this.stats.diamond++; this._autoAdvance(); }
                Â  onShield(){ this.stats.shield++; this._autoAdvance(); }
                Â  updateScore(n){ if(Number.isFinite(n)) this.stats.score=Math.max(this.stats.score,n); this._autoAdvance(); }
                Â  updateCombo(n){ if(Number.isFinite(n)) this.stats.comboMax=Math.max(this.stats.comboMax,n); this._autoAdvance(); }
                Â  _autoAdvance(){
                Â  Â  const cur=this.deck[this.currentIndex]; if(!cur) return false;
                Â  Â  if (cur.check(this.stats)) { this.currentIndex=Math.min(this.deck.length-1,this.currentIndex+1); return true; }
                Â  Â  return false;
                Â  }
                Â  getCurrent(){ return this.deck[this.currentIndex]||null; }
                Â  getProgress(){
                Â  Â  return this.deck.map((q,i)=>({ id:q.id,label:q.label,level:q.level, done:q.check(this.stats),
                Â  Â  Â  prog: (typeof q.prog==='function')?q.prog(this.stats):undefined, target:q.target, current:i===this.currentIndex }));
                Â  }
                Â  isCleared(){ if(!this.deck.length) return false; const last=this.deck[this.deck.length-1]; return this.currentIndex===this.deck.length-1 && last.check(this.stats); }
                Â  summary(){ return { deck:this.deck.map(q=>({id:q.id,label:q.label,level:q.level})), stats:{...this.stats}, cleared:this.isCleared(), currentIndex:this.currentIndex, progress:this.getProgress() }; }
                Â  serialize(){ return { deck:this.deck.map(q=>({id:q.id,level:q.level,label:q.label})), stats:{...this.stats}, currentIndex:this.currentIndex }; }
                Â  load(state={}){
                Â  Â  try{
                Â  Â  Â  if(Array.isArray(state.deck)) this.deck = state.deck.map(d=> this.pool.find(p=>p.id===d.id)||d).slice(0,3);
                Â  Â  Â  if(state.stats && typeof state.stats==='object') this.stats={...this.stats, ...state.stats};
                Â  Â  Â  if(Number.isFinite(state.currentIndex)) this.currentIndex=Math.max(0,Math.min(this.deck.length-1,state.currentIndex));
                Â  Â  }catch{}
                Â  }
                }
            })(GAME_MODULES);

            // --- 2. /vr/particles.js ---
            (function(exports) {
                'use strict';
                exports.Particles = {
                Â  burstShards(host, pos, opts) {
                Â  Â  opts = opts || {};
                Â  Â  const scr = opts.screen || (pos && typeof pos.x === 'number' && typeof pos.y === 'number'
                Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? { x: pos.x, y: pos.y } : null);

                Â  Â  // ---------- DOM MODE ----------
                Â  Â  if (scr) {
                Â  Â  Â  const x = Math.round(scr.x), y = Math.round(scr.y);
                Â  Â  Â  const theme = opts.theme || 'default';
                Â  Â  Â  let color = '#8ee9a1', count = 14, dur = 560;

                Â  Â  Â  if (theme === 'goodjunk')Â  Â { color = '#22c55e'; count = 16; }
                Â  Â  Â  else if (theme === 'groups'){ color = '#f59e0b'; count = 14; }
                Â  Â  Â  else if (theme === 'hydration'){ color = '#60a5fa'; count = 14; }
                Â  Â  Â  else if (theme === 'plate'){ color = '#facc15'; count = 16; }

                Â  Â  Â  for (let i = 0; i < count; i++) {
                Â  Â  Â  Â  const p = document.createElement('div');
                Â  Â  Â  Â  Object.assign(p.style, {
                Â  Â  Â  Â  Â  position:'fixed', left:x+'px', top:y+'px', width:'6px', height:'6px',
                Â  Â  Â  Â  Â  borderRadius:'999px', background:color, opacity:'0.96', zIndex:999,
                Â  Â  Â  Â  Â  transform:'translate(-50%,-50%)', transition:'all .55s ease', pointerEvents:'none'
                Â  Â  Â  Â  });
                Â  Â  Â  Â  document.body.appendChild(p);
                Â  Â  Â  Â  const ang = Math.random()*Math.PI*2, r = 24 + Math.random()*28;
                Â  Â  Â  Â  const tx = x + Math.cos(ang)*r, ty = y + Math.sin(ang)*r - 8;
                Â  Â  Â  Â  requestAnimationFrame(()=>{ p.style.left=tx+'px'; p.style.top=ty+'px'; p.style.opacity='0'; });
                Â  Â  Â  Â  setTimeout(()=>{ try{p.remove();}catch{} }, dur);
                Â  Â  Â  }
                Â  Â  Â  return;
                Â  Â  }

                Â  Â  // ---------- 3D MODE (fallback à¹„à¸› DOM à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ A-Frame) ----------
                Â  Â  try {
                Â  Â  Â  let root = host || document.getElementById('spawnHost') || document.querySelector('a-scene') || document.body;
                Â  Â  Â  const theme = opts.theme || 'default';
                Â  Â  Â  let color = '#8ee9a1', count = 10, dur = 600;
                Â  Â  Â  if (theme === 'goodjunk') { color='#22c55e'; count=12; }
                Â  Â  Â  else if (theme === 'plate'){ color='#facc15'; count=14; }
                Â  Â  Â  else if (theme === 'hydration'){ color='#60a5fa'; count=10; }
                Â  Â  Â  else if (theme === 'groups'){ color='#f472b6'; count=16; }

                Â  Â  Â  if (!window.AFRAME || !root) {
                Â  Â  Â  Â  const x = (pos && pos.x) || (window.innerWidth/2);
                Â  Â  Â  Â  const y = (pos && pos.y) || (window.innerHeight/2);
                Â  Â  Â  Â  return this.burstShards(null, null, { screen:{x,y}, theme });
                Â  Â  Â  }

                Â  Â  Â  for (let i=0;i<count;i++){
                Â  Â  Â  Â  const shard=document.createElement('a-plane');
                Â  Â  Â  Â  shard.setAttribute('width',0.06);
                Â  Â  Â  Â  shard.setAttribute('height',0.12);
                Â  Â  Â  Â  shard.setAttribute('material',`color:${color}; opacity:0.9; transparent:true`);
                Â  Â  Â  Â  const p = pos && pos.x!=null ? pos : {x:0,y:1,z:-1.5};
                Â  Â  Â  Â  shard.setAttribute('position',`${p.x} ${p.y} ${p.z||-1.5}`);
                Â  Â  Â  Â  const a=Math.random()*Math.PI*2, r=0.25+Math.random()*0.8, up=0.10+Math.random()*0.40;
                Â  Â  Â  Â  const tx=(p.x||0)+Math.cos(a)*r, ty=(p.y||1)+up, tz=(p.z||-1.5)+Math.sin(a)*r;
                Â  Â  Â  Â  shard.setAttribute('animation__move',`property: position; to:${tx} ${ty} ${tz}; dur:${dur}; easing:ease-out`);
                Â  Â  Â  Â  shard.setAttribute('animation__fade',`property: material.opacity; to:0; dur:${dur}; easing:linear`);
                Â  Â  Â  Â  root.appendChild(shard);
                Â  Â  Â  Â  setTimeout(()=>{ try{shard.remove();}catch{} }, dur+80);
                Â  Â  Â  }
                Â  Â  } catch {
                Â  Â  Â  const x=(pos&&pos.x)||(window.innerWidth/2), y=(pos&&pos.y)||(window.innerHeight/2);
                Â  Â  Â  this.burstShards(null, null, { screen:{x,y}, theme:opts.theme });
                Â  Â  }
                Â  },

                Â  // âœ… à¸„à¸°à¹à¸™à¸™à¹€à¸”à¹‰à¸‡à¸—à¸µà¹ˆà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸„à¸¥à¸´à¸
                Â  scorePop(x, y, text, good=true){
                Â  Â  const el=document.createElement('div');
                Â  Â  el.textContent = String(text ?? (good?'+10':'-10'));
                Â  Â  Object.assign(el.style,{
                Â  Â  Â  position:'fixed', left:x+'px', top:y+'px', transform:'translate(-50%,-50%)',
                Â  Â  Â  font:'800 16px system-ui', color: good ? '#22c55e' : '#ef4444', zIndex:1000,
                Â  Â  Â  textShadow:'0 2px 8px rgba(0,0,0,.55)', pointerEvents:'none', transition:'all .6s ease', opacity:'1'
                Â  Â  });
                Â  Â  document.body.appendChild(el);
                Â  Â  requestAnimationFrame(()=>{ el.style.top=(y-28)+'px'; el.style.opacity='0'; });
                Â  Â  setTimeout(()=>{ try{el.remove();}catch{} }, 650);
                Â  }
                };
            })(GAME_MODULES);
            
            // --- 3. /vr/ui-fever.js ---
            (function(exports) {
                'use strict';
                function $(s){ return document.querySelector(s); }

                let flameRoot = null;
                let cssInjected = false;

                function injectCSS(){
                Â  if (cssInjected) return;
                Â  cssInjected = true;
                Â  const st = document.createElement('style');
                Â  st.id = 'fever-css';
                Â  st.textContent = `
                Â  Â  #feverWrap{ position:fixed; left:50%; top:56px; transform:translateX(-50%);
                Â  Â  Â  width:min(540px,86vw); height:12px; background:#0b1222;
                Â  Â  Â  border:1px solid #334155; border-radius:999px; overflow:hidden; z-index:910 }
                Â  Â  #feverFill{ height:100%; width:0%;
                Â  Â  Â  transition:width .15s ease-out;
                Â  Â  Â  background:linear-gradient(90deg,#37d67a,#06d6a0) }

                Â  Â  #shieldChip{ position:fixed; right:16px; top:16px; background:#0f172acc;
                Â  Â  Â  border:1px solid #334155; border-radius:12px; padding:8px 12px;
                Â  Â  Â  font-weight:800; color:#e8eefc; z-index:910 }

                Â  Â  /* Flame overlay (absolute, pointer-events:none) */
                Â  Â  #feverFlame{
                Â  Â  Â  position:fixed; left:50%; top:52px; transform:translateX(-50%);
                Â  Â  Â  width:min(560px,90vw); height:36px; pointer-events:none; z-index:909; opacity:0;
                Â  Â  Â  filter:drop-shadow(0 4px 12px rgba(255,140,0,.55));
                Â  Â  Â  transition:opacity .18s ease;
                Â  Â  }
                Â  Â  #feverFlame .fl{
                Â  Â  Â  position:absolute; bottom:0; width:18px; height:26px; border-radius:12px 12px 8px 8px;
                Â  Â  Â  background:radial-gradient(ellipse at 50% 70%, #ffd166 0%, #ff7a00 55%, rgba(255,0,0,.75) 100%);
                Â  Â  Â  transform-origin:50% 100%;
                Â  Â  Â  animation:flameUp var(--flDur,900ms) ease-in infinite;
                Â  Â  Â  mix-blend-mode:screen; opacity:.88;
                Â  Â  Â  will-change:transform, opacity, filter;
                Â  Â  }
                Â  Â  @keyframes flameUp{
                Â  Â  Â  0%Â  Â { transform:translateY(0) scale(1) rotate(var(--flRot,0deg)); opacity:.95; }
                Â  Â  Â  70%Â  { opacity:.8; }
                Â  Â  Â  100% { transform:translateY(-22px) scale(1.1) rotate(calc(var(--flRot,0deg) + 4deg)); opacity:0; }
                Â  Â  }

                Â  Â  /* Sparks (tiny dots) */
                Â  Â  #feverFlame .sp{
                Â  Â  Â  position:absolute; bottom:6px; width:4px; height:4px; border-radius:999px;
                Â  Â  Â  background:linear-gradient(90deg,#fff2,#ffe6); opacity:.9;
                Â  Â  Â  animation:sparkUp 900ms ease-out infinite;
                Â  Â  }
                Â  Â  @keyframes sparkUp{
                Â  Â  Â  0%Â  Â { transform:translateY(0) scale(1); opacity:.95; }
                Â  Â  Â  100% { transform:translateY(-26px) scale(0.6); opacity:0; }
                Â  Â  }

                Â  Â  /* Glow when fever active (wrap + score pill à¸–à¹‰à¸²à¸¡à¸µ) */
                Â  Â  .fever-on{ box-shadow:0 0 0 3px #ffd16655, 0 0 22px #ffb703aa; }
                Â  `;
                Â  document.head.appendChild(st);
                }

                exports.ensureFeverBar = function(){
                Â  injectCSS();

                Â  let wrap = $('#feverWrap');
                Â  if (!wrap){
                Â  Â  wrap = document.createElement('div');
                Â  Â  wrap.id = 'feverWrap';
                Â  Â  const fill = document.createElement('div');
                Â  Â  fill.id = 'feverFill';
                Â  Â  wrap.appendChild(fill);
                Â  Â  document.body.appendChild(wrap);
                Â  }

                Â  if (!$('#shieldChip')){
                Â  Â  const chip = document.createElement('div');
                Â  Â  chip.id = 'shieldChip';
                Â  Â  chip.textContent = 'ğŸ›¡ï¸ x0';
                Â  Â  document.body.appendChild(chip);
                Â  }

                Â  // Flame root
                Â  if (!$('#feverFlame')){
                Â  Â  flameRoot = document.createElement('div');
                Â  Â  flameRoot.id = 'feverFlame';
                Â  Â  document.body.appendChild(flameRoot);
                Â  Â  buildFlameChildren(); // initial populate
                Â  } else {
                Â  Â  flameRoot = $('#feverFlame');
                Â  }
                Â  return wrap;
                }

                function buildFlameChildren(){
                Â  if (!flameRoot) return;
                Â  flameRoot.innerHTML = '';
                Â  const W = flameRoot.getBoundingClientRect().width || 520;
                Â  const cols = Math.max(10, Math.floor(W / 28)); // à¸ˆà¸³à¸™à¸§à¸™à¹€à¸›à¸¥à¸§à¹„à¸Ÿà¹à¸™à¸§à¸™à¸­à¸™

                Â  for (let i=0;i<cols;i++){
                Â  Â  const x = (i+0.5) * (W/cols);
                Â  Â  // fire core
                Â  Â  const fl = document.createElement('div');
                Â  Â  fl.className = 'fl';
                Â  Â  fl.style.left = (x - 9) + 'px';
                Â  Â  fl.style.setProperty('--flRot', ((Math.random()*10)-5)+'deg');
                Â  Â  fl.style.setProperty('--flDur', (800 + Math.random()*300)+'ms');
                Â  Â  flameRoot.appendChild(fl);

                Â  Â  // spark (à¸šà¸²à¸‡à¸ˆà¸¸à¸”)
                Â  Â  if (Math.random() < 0.6){
                Â  Â  Â  const sp = document.createElement('div');
                Â  Â  Â  sp.className = 'sp';
                Â  Â  Â  sp.style.left = (x - 2) + 'px';
                Â  Â  Â  sp.style.animationDuration = (600 + Math.random()*500)+'ms';
                Â  Â  Â  flameRoot.appendChild(sp);
                Â  Â  }
                Â  }
                }

                /** 0..100 */
                exports.setFever = function(pct){
                Â  exports.ensureFeverBar();
                Â  const p = Math.max(0, Math.min(100, Math.round(pct||0)));
                Â  const fill = $('#feverFill'); if (fill) fill.style.width = p + '%';

                Â  // à¸„à¸§à¸²à¸¡à¹à¸£à¸‡à¸‚à¸­à¸‡à¹„à¸Ÿ: map à¹€à¸›à¹‡à¸™ opacity + à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¹„à¸Ÿ
                Â  if (flameRoot){
                Â  Â  const alpha = p <= 0 ? 0 : (p < 100 ? (0.25 + p/150) : 1);
                Â  Â  flameRoot.style.opacity = String(alpha);
                Â  Â  // à¹€à¸à¸´à¹ˆà¸¡/à¸¥à¸”à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸›à¸£à¸±à¸š --flDur à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™ (à¸„à¸£à¹ˆà¸²à¸§ à¹†)
                Â  Â  flameRoot.querySelectorAll('.fl').forEach(el=>{
                Â  Â  Â  const base = 900 - p*3; // à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™ â†’ à¹€à¸£à¹‡à¸§à¸‚à¸¶à¹‰à¸™
                Â  Â  Â  el.style.setProperty('--flDur', Math.max(500, base) + 'ms');
                Â  Â  });
                Â  }
                }

                exports.setShield = function(n){
                Â  exports.ensureFeverBar();
                Â  const chip = $('#shieldChip'); if (!chip) return;
                Â  chip.textContent = 'ğŸ›¡ï¸ x' + (n|0);
                Â  chip.style.opacity = n>0 ? '1' : '.55';
                }

                /** à¹€à¸›à¸´à¸”/à¸›à¸´à¸”à¸ à¸²à¸§à¸° Fever (glow + à¹„à¸Ÿà¸¥à¸¸à¸) */
                exports.setFeverActive = function(on){
                Â  exports.ensureFeverBar();
                Â  const scorePill = $('#score'); // Note: #score is not defined in this file, but it tries to style it.
                Â  const wrap = $('#feverWrap');
                Â  const flame = $('#feverFlame');
                Â  if (on){
                Â  Â  if (wrap) wrap.classList.add('fever-on');
                Â  Â  if (scorePill) scorePill.classList.add('fever-on');
                Â  Â  if (flame){ flame.style.opacity = '1'; }
                Â  }else{
                Â  Â  if (wrap) wrap.classList.remove('fever-on');
                Â  Â  if (scorePill) scorePill.classList.remove('fever-on');
                Â  Â  if (flame){
                Â  Â  Â  // à¹„à¸¡à¹ˆà¸”à¸±à¸šà¸—à¸±à¸™à¸—à¸µ à¹ƒà¸«à¹‰à¸¥à¸”à¸•à¸²à¸¡à¸„à¹ˆà¸²à¹€à¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸—à¸µà¹ˆ setFever() à¸„à¸¸à¸¡à¸­à¸¢à¸¹à¹ˆ
                Â  Â  }
                Â  }
                }
                
                exports.setFlame = exports.setFeverActive;

            })(GAME_MODULES);

            // --- 4. /vr/quest-hud.js ---
            (function(exports) {
                'use strict';
                (function(){
                Â  // à¸¥à¹‰à¸²à¸‡à¸‚à¸­à¸‡à¹€à¸à¹ˆà¸²à¹€à¸¡à¸·à¹ˆà¸­ index à¸ªà¹ˆà¸‡à¸ªà¸±à¸à¸à¸²à¸“à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹‚à¸«à¸¡à¸”
                Â  window.addEventListener('hha:dispose-ui', () => {
                Â  Â  try { exports.questHUDDispose(); } catch {}
                Â  });
                })();

                function $(s){ return document.querySelector(s); }
                function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

                exports.questHUDInit = function(){
                Â  if (document.getElementById('questPanel')) return;
                Â  const wrap = document.createElement('div');
                Â  wrap.id = 'questPanel';
                Â  wrap.setAttribute('data-hha-ui','');
                Â  Object.assign(wrap.style, {
                Â  Â  position:'fixed', right:'12px', bottom:'68px', zIndex:'930',
                Â  Â  width:'min(340px, 86vw)', color:'#e8eefc',
                Â  Â  background:'rgba(17,24,39,.72)', border:'1px solid #334155',
                Â  Â  borderRadius:'12px', padding:'10px 12px', backdropFilter:'blur(6px)',
                Â  Â  fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif'
                Â  });
                Â  wrap.innerHTML = `
                Â  Â  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
                Â  Â  Â  <strong style="font-weight:800">Goal + Mini Quests</strong>
                Â  Â  Â  <span id="questHint" style="opacity:.8;font-weight:700;font-size:12px"></span>
                Â  Â  </div>
                Â  Â  <div id="questList" role="list"></div>
                Â  `;
                Â  document.body.appendChild(wrap);
                }

                exports.questHUDDispose = function(){
                Â  const el = document.getElementById('questPanel');
                Â  if (el) try { el.remove(); } catch {}
                }

                function rowHTML(item, idx){
                Â  const done = !!item.done;
                Â  const curÂ  = !!item.current;
                Â  const prog = Number.isFinite(item.prog) ? item.prog : (done ? (item.target ?? 1) : 0);
                Â  const tgtÂ  = Number.isFinite(item.target) ? item.target : (done ? 1 : (prog||1));
                Â  const pctÂ  = tgt>0 ? Math.round(clamp(prog/tgt,0,1)*100) : (done?100:0);
                Â  const lvÂ  Â = item.level || '';
                Â  const badge = done ? 'âœ…' : (cur ? 'â–¶ï¸' : 'â€¢');

                Â  return `
                Â  <div role="listitem" aria-current="${cur?'true':'false'}"
                Â  Â  Â  Â style="border:1px solid #334155;border-radius:10px;padding:8px 10px;margin:6px 0;background:${done?'#0b5':'#0b1222'}22">
                Â  Â  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                Â  Â  Â  <div style="font-weight:800">${badge} ${item.label}</div>
                Â  Â  Â  <div style="opacity:.85;font-weight:800;font-size:12px">${lv.toUpperCase()}</div>
                Â  Â  </div>
                Â  Â  <div style="height:10px;border:1px solid #334155;border-radius:999px;overflow:hidden;margin-top:6px;background:#0b1222">
                Â  Â  Â  <div style="height:100%;width:${pct}%;background:${done?'linear-gradient(90deg,#22c55e,#86efac)':'linear-gradient(90deg,#60a5fa,#93c5fd)'}"></div>
                Â  Â  </div>
                Â  Â  <div style="margin-top:4px;font-size:12px;font-weight:800;opacity:.9">${prog}/${tgt}</div>
                Â  </div>`;
                }

                exports.questHUDUpdate = function(deck, hintText){
                Â  exports.questHUDInit();
                Â  const list = document.getElementById('questList');
                Â  const hint = document.getElementById('questHint');
                Â  if (!list) return;
                Â  try {
                Â  Â  const prog = (typeof deck.getProgress==='function') ? deck.getProgress() : [];
                Â  Â  list.innerHTML = prog.map((it, i)=>rowHTML(it,i)).join('');
                Â  Â  if (hint && typeof hintText==='string') hint.textContent = hintText;
                Â  } catch(e) {
                Â  Â  // à¸à¸£à¸“à¸µ deck à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡
                Â  Â  list.innerHTML = `<div style="opacity:.7;font-weight:700">à¸à¸³à¸¥à¸±à¸‡à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸§à¸ªà¸•à¹Œâ€¦</div>`;
                Â  }
                }
            })(GAME_MODULES);

            // --- 5. /vr/mode-factory.js ---
            (function(exports) {
                'use strict';
                exports.factoryBoot = async function(config){
                Â  config = config || {};
                Â  var hostÂ  Â = config.host || document.getElementById('spawnHost') || document.body;
                Â  var diffÂ  Â = String(config.difficulty || 'normal');
                Â  var durÂ  Â  = Number(config.duration || 60);

                Â  // à¸à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›
                Â  var poolsÂ  = config.pools || { good: ['âœ…'], bad: ['âŒ'] };
                Â  var goodRate = (typeof config.goodRate==='number') ? config.goodRate : 0.7;

                Â  // à¸à¸¹à¸¥à¸à¸²à¸§à¹€à¸§à¸­à¸£à¹Œ (â­ğŸ’ğŸ›¡ï¸ğŸ”¥) + à¸­à¸±à¸•à¸£à¸²à¹€à¸à¸´à¸” (0..1) + à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢à¸—à¸¸à¸ N à¸„à¸£à¸±à¹‰à¸‡
                Â  var powerPoolÂ  = Array.isArray(config.powerups) ? config.powerups : ['â­','ğŸ’','ğŸ›¡ï¸','ğŸ”¥'];
                Â  var powerRateÂ  = (typeof config.powerRate==='number') ? config.powerRate : 0.08;Â  Â // 8%
                Â  var powerEvery = (typeof config.powerEvery==='number') ? config.powerEvery : 7;Â  Â  // à¸šà¸±à¸‡à¸„à¸±à¸šà¸­à¸­à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢à¸—à¸¸à¸ 7 à¸ªà¸›à¸­à¸™

                Â  var judgeÂ  Â  Â = typeof config.judge === 'function'Â  Â  ? config.judgeÂ  Â  Â : function(){ return {good:true, scoreDelta:1}; };
                Â  var onExpireÂ  = typeof config.onExpire === 'function' ? config.onExpireÂ  : null;
                Â  var onFinishÂ  = typeof config.onFinish === 'function' ? config.onFinishÂ  : null;Â  Â // âœ… NEW: à¹ƒà¸«à¹‰à¹‚à¸«à¸¡à¸”à¸„à¸·à¸™à¸ªà¸£à¸¸à¸›à¹€à¸à¸´à¹ˆà¸¡
                Â  var running = true;

                Â  function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
                Â  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
                Â  function fire(name, detail){ try{ window.dispatchEvent(new CustomEvent(name,{detail:detail||{}})); }catch(e){} }
                Â  function vw(){ return Math.max(320, window.innerWidth||320); }
                Â  function vh(){ return Math.max(320, window.innerHeight||320); }
                Â  function getFlag(name){ var q=(window.location && window.location.search) || ''; return new RegExp('[?&]'+name+'(?:=1|&|$)').test(q); }
                Â  var DEBUG = getFlag('debug');

                Â  // style once
                Â  if(!document.getElementById('hha-style')){
                Â  Â  var st=document.createElement('style'); st.id='hha-style';
                Â  Â  st.textContent=
                Â  Â  Â  '.hha-layer{position:fixed;inset:0;z-index:650;pointer-events:auto;background:transparent;user-select:none;-webkit-user-select:none;}'+
                Â  Â  Â  '.hha-tgt{position:absolute;pointer-events:auto;display:block;transform:translate(-50%,-50%);font-size:64px;line-height:1;filter:drop-shadow(0 8px 14px rgba(0,0,0,.5));transition:transform .12s ease,opacity .24s ease;opacity:1;cursor:pointer;user-select:none;-webkit-user-select:none;}'+
                Â  Â  Â  '.hha-tgt.hit{transform:translate(-50%,-50%) scale(.85);opacity:.15;pointer-events:none;}'+
                Â  Â  Â  '.hha-badge{position:fixed;left:50%;top:50px;transform:translateX(-50%);background:#0f172acc;color:#fff;padding:6px 10px;border:1px solid #475569;border-radius:10px;font:700 12px system-ui;}';
                Â  Â  document.head.appendChild(st);
                Â  }

                Â  // layer (clear old)
                Â  var olds=document.querySelectorAll('.hha-layer'); for(var oi=0;oi<olds.length;oi++){ try{olds[oi].parentNode.removeChild(olds[oi]);}catch(_e){} }
                Â  var layer=document.createElement('div'); layer.className='hha-layer'; document.body.appendChild(layer);

                Â  var dbg; if(DEBUG){ dbg=document.createElement('div'); dbg.className='hha-badge'; dbg.textContent='DEBUG: ready'; document.body.appendChild(dbg); }
                Â  function dbglog(s){ if(DEBUG){ try{dbg.textContent='DEBUG: '+s;}catch{} } }

                Â  // state
                Â  var score=0, combo=0, misses=0, left=Math.max(1,Math.round(dur));
                Â  var spawnTimer=null, timeTimer=null, watchdog=null;
                Â  var spawnCount=0, sinceLastPower=0;

                Â  // tuning
                Â  var spawnMin=900, spawnMax=1200, life=1600;
                Â  if(diff==='easy'){ spawnMin=1000; spawnMax=1400; life=1800; }
                Â  if(diff==='hard'){ spawnMin=700;Â  spawnMax=950;Â  life=1400; }

                Â  function tickTime(){ if(!running) return; left=Math.max(0,left-1); fire('hha:time',{sec:left}); if(left<=0) end(); }
                Â  function planNextSpawn(){ if(!running) return; var wait=Math.floor(spawnMin+Math.random()*(spawnMax-spawnMin)); spawnTimer=setTimeout(spawnOne, wait); }
                Â  function ensureOnScreen(el){
                Â  Â  try{
                Â  Â  Â  var r=el.getBoundingClientRect();
                Â  Â  Â  if(!(r.width>0&&r.height>0&&r.left>=-2&&r.top>=-2&&r.right<=vw()+2&&r.bottom<=vh()+2)){
                Â  Â  Â  Â  el.style.left=(vw()/2)+'px'; el.style.top=(vh()/2)+'px';
                Â  Â  Â  }
                Â  Â  }catch(_e){}
                Â  }

                Â  function shouldSpawnPower(){
                Â  Â  if (sinceLastPower >= powerEvery) return true;
                Â  Â  return Math.random() < powerRate;
                Â  }

                Â  function spawnOne(forceCenter){
                Â  Â  if(!running) return;
                Â  Â  spawnCount++; sinceLastPower++;

                Â  Â  var usePower = powerPool.length>0 && shouldSpawnPower();
                Â  Â  var isGood, ch;

                Â  Â  if (usePower){
                Â  Â  Â  ch = pick(powerPool);
                Â  Â  Â  isGood = true;Â  Â  Â  Â  Â  Â  Â  Â  Â // à¸à¸²à¸§à¹€à¸§à¸­à¸£à¹Œà¸–à¸·à¸­à¹€à¸›à¹‡à¸™ good
                Â  Â  Â  sinceLastPower = 0;
                Â  Â  } else {
                Â  Â  Â  isGood = Math.random() < goodRate;
                Â  Â  Â  var pool = isGood ? (pools.good||['âœ…']) : (pools.bad||['âŒ']);
                Â  Â  Â  ch = pick(pool);
                Â  Â  }

                Â  Â  var el=document.createElement('div'); el.className='hha-tgt'; el.textContent=ch;
                Â  Â  var x = forceCenter ? vw()/2 : Math.floor(vw()*0.12 + Math.random()*vw()*0.76);
                Â  Â  var y = forceCenter ? vh()/2 : Math.floor(vh()*0.18 + Math.random()*vh()*0.62);
                Â  Â  el.style.left=x+'px'; el.style.top=y+'px';
                Â  Â  el.style.fontSize=(diff==='easy'?74:(diff==='hard'?56:64))+'px';

                Â  Â  var clicked=false;

                Â  Â  function onHit(ev){
                Â  Â  Â  if(clicked) return; clicked=true;
                Â  Â  Â  try{ ev.preventDefault(); ev.stopPropagation(); }catch(_e){}
                Â  Â  Â  var cx=vw()/2, cy=vh()/2;
                Â  Â  Â  if (ev.touches && ev.touches[0]) { cx=ev.touches[0].clientX; cy=ev.touches[0].clientY; }
                Â  Â  Â  else if (ev.clientX!=null) { cx=ev.clientX; cy=ev.clientY; }
                      
                      // à¸„à¹‰à¸™à¸«à¸²à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸—à¸µà¹ˆà¹à¸¡à¹ˆà¸™à¸¢à¸³à¸‚à¸¶à¹‰à¸™à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰
                      try {
                          const rect = el.getBoundingClientRect();
                          cx = rect.left + rect.width / 2;
                          cy = rect.top + rect.height / 2;
                      } catch(e) {}

                Â  Â  Â  var resÂ  Â = judge(ch, {score:score, combo:combo, misses:misses, diff:diff, isGood:isGood, clientX: cx, clientY: cy});
                Â  Â  Â  var goodÂ  = !!(res && res.good);
                Â  Â  Â  var delta = (res && typeof res.scoreDelta==='number') ? res.scoreDelta : (good?1:-1);

                Â  Â  Â  combo = good ? Math.min(9999, combo+1) : 0;
                Â  Â  Â  score = clamp(score + delta, 0, 999999);
                Â  Â  Â  if(!good){ misses += 1; fire('hha:miss',{count:misses}); }

                Â  Â  Â  try{ el.className='hha-tgt hit'; setTimeout(() => el.remove(), 300); }catch(_e){}
                Â  Â  Â  fire('hha:score',{score:score, combo:combo, delta:delta, good:good});
                Â  Â  Â  fire('hha:hit-screen',{x:cx, y:cy, good:good, delta:delta, char:ch, isGood:isGood});
                Â  Â  Â  dbglog('hit '+ch+' good='+good+' score='+score);
                Â  Â  Â  planNextSpawn();
                Â  Â  }

                Â  Â  el.addEventListener('click', onHit, {passive:false});
                Â  Â  el.addEventListener('touchstart', onHit, {passive:false});

                Â  Â  setTimeout(function(){
                Â  Â  Â  if(clicked || !running) return;
                Â  Â  Â  try{ el.remove(); }catch(_e){}
                Â  Â  Â  if(isGood){
                Â  Â  Â  Â  combo=0; misses+=1; fire('hha:miss',{count:misses});
                Â  Â  Â  Â  fire('hha:score',{score:score, combo:combo});
                Â  Â  Â  Â  dbglog('expire GOOD (miss)');
                Â  Â  Â  }else{
                Â  Â  Â  Â  fire('hha:avoid',{ch:ch});
                Â  Â  Â  Â  fire('hha:expired',{isGood:false, ch:ch});
                Â  Â  Â  Â  if(onExpire) try{ onExpire({isGood:false, ch:ch}); }catch(_e){}
                Â  Â  Â  Â  dbglog('expire JUNK (avoid)');
                Â  Â  Â  }
                Â  Â  Â  planNextSpawn();
                Â  Â  }, life);

                Â  Â  layer.appendChild(el);
                Â  Â  ensureOnScreen(el);
                Â  Â  dbglog('spawn '+ch+' at '+x+','+y+(usePower?' (POWER)':''));
                Â  }

                Â  function startWatchdog(){
                Â  Â  if(watchdog) clearInterval(watchdog);
                Â  Â  watchdog=setInterval(function(){
                Â  Â  Â  if(!running) return;
                Â  Â  Â  var leftOvers=layer.querySelectorAll('.hha-tgt');
                Â  Â  Â  if(leftOvers.length===0){ dbglog('watchdog spawn'); spawnOne(true); }
                Â  Â  }, 2000);
                Â  }

                Â  function start(){
                Â  Â  if(timeTimer) clearInterval(timeTimer);
                Â  Â  timeTimer=setInterval(tickTime, 1000);
                    fire('hha:time',{sec:left}); // à¸¢à¸´à¸‡à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸à¸—à¸±à¸™à¸—à¸µ
                Â  Â  spawnOne(true);
                Â  Â  planNextSpawn();
                Â  Â  startWatchdog();
                Â  }

                Â  function end(){
                Â  Â  if(!running) return; running=false;
                Â  Â  try{ clearInterval(timeTimer); }catch(_e){}
                Â  Â  try{ clearTimeout(spawnTimer); }catch(_e){}
                Â  Â  try{ clearInterval(watchdog); }catch(_e){}
                Â  Â  try{
                Â  Â  Â  var nodes=layer.querySelectorAll('.hha-tgt');
                Â  Â  Â  for(var i=0;i<nodes.length;i++){ try{ layer.removeChild(nodes[i]); }catch(_e){} }
                Â  Â  }catch(_e){}
                    
                    // à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸² UI à¸­à¸·à¹ˆà¸™à¹† (à¹€à¸Šà¹ˆà¸™ quest HUD) à¸–à¸¹à¸à¸¥à¹‰à¸²à¸‡à¸à¹ˆà¸­à¸™
                    setTimeout(() => {
                        try{ document.body.removeChild(layer); }catch(_e){}
                        if(DEBUG){ try{ document.body.removeChild(dbg); }catch(_e){} }
                    }, 500);


                Â  Â  // âœ… à¸£à¸§à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸·à¹‰à¸™à¸à¸²à¸™
                Â  Â  var base = { score:score, combo:combo, misses:misses, duration:dur };

                Â  Â  // âœ… à¹ƒà¸«à¹‰à¹‚à¸«à¸¡à¸”à¹€à¸•à¸´à¸¡ field à¸ªà¸£à¸¸à¸›à¹€à¸à¸´à¹ˆà¸¡ (à¹€à¸Šà¹ˆà¸™ questsCleared/questsTotal/goalCleared/hits/à¸¯à¸¥à¸¯)
                Â  Â  if (onFinish) {
                Â  Â  Â  try {
                Â  Â  Â  Â  var extra = onFinish(base) || {};
                Â  Â  Â  Â  for (var k in extra) base[k] = extra[k];
                Â  Â  Â  } catch(_e){}
                Â  Â  }

                Â  Â  // âœ… à¸¢à¸´à¸‡à¸ªà¸£à¸¸à¸›à¸—à¸µà¹ˆà¸£à¸§à¸¡à¹à¸¥à¹‰à¸§
                Â  Â  fire('hha:end', base);
                Â  }

                Â  start();
                Â  return {
                Â  Â  stop:end,
                Â  Â  pause:function(){ if(!running) return; running=false; try{clearInterval(timeTimer);}catch{} try{clearTimeout(spawnTimer);}catch{} },
                Â  Â  resume:function(){ if(running) return; running=true; start(); }
                Â  };
                }
            })(GAME_MODULES);

            // --- 6. /goodjunk.safe.js (The Brain) ---
            (function(exports, imports) {
                'use strict';
                // --- Simulated Imports ---
                const { factoryBoot } = imports;
                const { MissionDeck } = imports;
                const { questHUDInit, questHUDUpdate, questHUDDispose } = imports;
                const { Particles } = imports;
                const { ensureFeverBar, setFever, setFeverActive, setShield } = imports;
                // --- End Imports ---

                exports.boot = async function(cfg = {}) {
                Â  const diff = String(cfg.difficulty || 'normal');
                Â  const durÂ  = Number(cfg.duration || 60);

                Â  // ---------- Pools ----------
                Â  const GOOD = ['ğŸ¥¦','ğŸ¥•','ğŸ','ğŸŸ','ğŸ¥›','ğŸŠ','ğŸŒ','ğŸ‡','ğŸ¥¬','ğŸš','ğŸ¥œ','ğŸ','ğŸ“','ğŸ','ğŸ¥','ğŸ'];
                Â  const JUNK = ['ğŸ”','ğŸŸ','ğŸ•','ğŸ©','ğŸª','ğŸ§','ğŸ¥¤','ğŸ§‹','ğŸ«','ğŸŒ­','ğŸ°','ğŸ¬'];
                Â  const STAR='â­', DIA='ğŸ’', SHIELD='ğŸ›¡ï¸', FIRE='ğŸ”¥';
                Â  const BONUS=[STAR,DIA,SHIELD,FIRE];

                Â  // ---------- Goal (à¸•à¸²à¸¡à¸£à¸°à¸”à¸±à¸š) ----------
                Â  const GOAL_SCORE = (diff==='easy') ? 350 : (diff==='hard' ? 750 : 550);
                Â  function goalObj(score){ return { label:`à¸—à¸³à¸„à¸°à¹à¸™à¸™à¹ƒà¸«à¹‰à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸² (${diff})`, prog:score, target:GOAL_SCORE }; }

                Â  // ---------- Mini quest pool 10 à¹ƒà¸š (Good vs Junk) ----------
                Â  const gjQuestPool10 = [
                Â  Â  { id:'g_good15',Â  Â level:'easy',Â  Â label:'à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¸”à¸µ 15 à¸Šà¸´à¹‰à¸™',Â  Â  Â check:s=>s.goodCount>=15,Â  prog:s=>Math.min(15,s.goodCount),Â  target:15 },
                Â  Â  { id:'g_good25',Â  Â level:'normal', label:'à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¸”à¸µ 25 à¸Šà¸´à¹‰à¸™',Â  Â  Â check:s=>s.goodCount>=25,Â  prog:s=>Math.min(25,s.goodCount),Â  target:25 },
                Â  Â  { id:'g_combo12',Â  level:'normal', label:'à¸—à¸³à¸„à¸­à¸¡à¹‚à¸š 12',Â  Â  Â  Â  Â  Â  check:s=>s.comboMax>=12,Â  Â prog:s=>Math.min(12,s.comboMax),Â  Â target:12 },
                Â  Â  { id:'g_score500', level:'hard',Â  Â label:'à¸—à¸³à¸„à¸°à¹à¸™à¸™à¸£à¸§à¸¡ 500+',Â  Â  Â  Â check:s=>s.score>=500,Â  Â  Â prog:s=>Math.min(500,s.score),Â  Â  Â target:500 },
                Â  Â  { id:'g_nomiss10', level:'normal', label:'à¹„à¸¡à¹ˆà¸à¸¥à¸²à¸” 10 à¸§à¸´à¸™à¸²à¸—à¸µ',Â  Â  Â check:s=>s.noMissTime>=10, prog:s=>Math.min(10,s.noMissTime), target:10 },
                Â  Â  // à¸™à¸±à¸š â€œà¸«à¸¥à¸µà¸à¸‚à¸¢à¸°â€ à¹€à¸‰à¸à¸²à¸°à¸à¸£à¸“à¸µà¸—à¸µà¹ˆà¸‚à¸¢à¸°à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ (à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸„à¸¥à¸´à¸) â†’ à¹€à¸£à¸²à¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸œà¹ˆà¸²à¸™ onExpire à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
                Â  Â  { id:'g_avoid5',Â  Â level:'easy',Â  Â label:'à¸«à¸¥à¸µà¸à¸‚à¸­à¸‡à¸‚à¸¢à¸° 5 à¸„à¸£à¸±à¹‰à¸‡',Â  Â  check:s=>s.junkMiss>=5,Â  Â  prog:s=>Math.min(5,s.junkMiss),Â  Â  target:5 },
                Â  Â  { id:'g_star2',Â  Â  level:'hard',Â  Â label:'à¹€à¸à¹‡à¸šà¸”à¸²à¸§ â­ 2 à¸”à¸§à¸‡',Â  Â  Â  Â  check:s=>s.star>=2,Â  Â  Â  Â  prog:s=>Math.min(2,s.star),Â  Â  Â  Â  target:2 },
                Â  Â  { id:'g_dia1',Â  Â  Â level:'hard',Â  Â label:'à¹€à¸à¹‡à¸šà¹€à¸à¸Šà¸£ ğŸ’ 1 à¹€à¸¡à¹‡à¸”',Â  Â  Â  check:s=>s.diamond>=1,Â  Â  Â prog:s=>Math.min(1,s.diamond),Â  Â  Â target:1 },
                Â  Â  { id:'g_streak20', level:'hard',Â  Â label:'à¸„à¸­à¸¡à¹‚à¸šà¸ªà¸¹à¸‡à¸ªà¸¸à¸” 20',Â  Â  Â  Â  Â check:s=>s.comboMax>=20,Â  Â prog:s=>Math.min(20,s.comboMax),Â  Â target:20 },
                Â  Â  { id:'g_fever2',Â  Â level:'normal', label:'à¹€à¸‚à¹‰à¸²à¹‚à¸«à¸¡à¸” Fever 2 à¸„à¸£à¸±à¹‰à¸‡',Â  check:s=>s.feverCount>=2,Â  prog:s=>Math.min(2,s.feverCount),Â  target:2 },
                Â  ];

                Â  // ---------- HUD / Fever ----------
                Â  ensureFeverBar(); setFever(0); setShield(0);

                Â  // ---------- Mission deck (à¸ªà¸¸à¹ˆà¸¡ 3 à¹ƒà¸š / à¹€à¸•à¸´à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¸œà¹ˆà¸²à¸™à¸„à¸£à¸š) ----------
                Â  const deck = new MissionDeck({ pool: gjQuestPool10 });
                Â  deck.draw3();
                Â  let wave = 1;
                Â  let totalQuestsCleared = 0;

                Â  questHUDInit();

                Â  // ---------- Game state ----------
                Â  let score=0, combo=0, shield=0;
                Â  let fever=0, feverActive=false, feverCount=0;
                Â  let star=0, diamond=0;

                Â  // à¸Šà¸µà¹‰à¹ƒà¸«à¹‰ deck à¹€à¸«à¹‡à¸™à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™ (à¹ƒà¸Šà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š quests)
                Â  function syncDeckStats(){
                Â  Â  deck.stats.starÂ  Â  Â = star;
                Â  Â  deck.stats.diamondÂ  = diamond;
                Â  Â  deck.stats.feverCount = feverCount;
                Â  Â  deck.updateScore(score);
                Â  Â  deck.updateCombo(combo);
                Â  }

                Â  function mult(){ return feverActive ? 2 : 1; }
                Â  function gainFever(n){
                Â  Â  const prev = fever;
                Â  Â  fever = Math.max(0, Math.min(100, fever + n));
                Â  Â  setFever(fever);
                Â  Â  if (!feverActive && fever>=100){
                Â  Â  Â  feverActive = true; setFeverActive(true); feverCount += 1;
                Â  Â  Â  deck.onFeverStart?.(); // à¸£à¸­à¸‡à¸£à¸±à¸š mission.js à¹ƒà¸«à¸¡à¹ˆ
                Â  Â  }
                Â  }
                Â  function decayFever(base){
                Â  Â  const d = feverActive ? 10 : base;
                Â  Â  const wasActive = feverActive;
                Â  Â  fever = Math.max(0, fever - d);
                Â  Â  setFever(fever);
                Â  Â  if (wasActive && fever<=0){ feverActive=false; setFeverActive(false); }
                Â  }

                Â  // ---------- Push quest+goal to HUD ----------
                Â  function pushQuestHUD(hintText){
                Â  Â  // current mini (à¸—à¸µà¸¥à¸°à¹ƒà¸š) à¸ˆà¸²à¸ deck
                Â  Â  const cur = deck.getCurrent();
                Â  Â  let mini=null;
                Â  Â  if (cur){
                Â  Â  Â  const progList = deck.getProgress();
                Â  Â  Â  const now = progList.find(x=>x.id===cur.id) || {};
                Â  Â  Â  mini = {
                Â  Â  Â  Â  label: cur.label,
                Â  Â  Â  Â  prog:Â  Number.isFinite(now.prog) ? now.prog : 0,
                Â  Â  Â  Â  target:Number.isFinite(now.target) ? now.target : (now.done?1:0)
                Â  Â  Â  };
                Â  Â  }
                Â  Â  // goal
                Â  Â  const g = goalObj(score);
                Â  Â  // window.dispatchEvent(new CustomEvent('hha:quest',{ detail:{ goal:g, mini } })); // Not used by other modules
                Â  Â  questHUDUpdate(deck, hintText ?? `Wave ${wave}`);
                Â  }

                Â  // ---------- Judge ----------
                Â  function judge(ch, ctx){
                Â  Â  const cx = ctx.cx ?? ctx.clientX, cy = ctx.cy ?? ctx.clientY;

                Â  Â  // Power-ups
                Â  Â  if (ch===STAR){ const d=40*mult(); score+=d; star++; gainFever(10);
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'goodjunk'}); syncDeckStats(); pushQuestHUD(); return {good:true, scoreDelta:d}; }
                Â  Â  if (ch===DIA){Â  const d=80*mult(); score+=d; diamond++; gainFever(30);
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'groups'});Â  Â syncDeckStats(); pushQuestHUD(); return {good:true, scoreDelta:d}; }
                Â  Â  if (ch===SHIELD){ shield=Math.min(3, shield+1); setShield(shield); score+=20;
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'hydration'}); syncDeckStats(); pushQuestHUD(); return {good:true, scoreDelta:20}; }
                Â  Â  if (ch===FIRE){ feverActive=true; setFeverActive(true); fever=Math.max(fever,60); setFever(fever); score+=25;
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'plate'});Â  Â  Â syncDeckStats(); pushQuestHUD(); return {good:true, scoreDelta:25}; }

                Â  Â  const isGood = GOOD.includes(ch);
                Â  Â  if (isGood){
                Â  Â  Â  const baseÂ  = 20 + combo*2;
                Â  Â  Â  const delta = base * mult();
                Â  Â  Â  score += delta; combo += 1;
                Â  Â  Â  gainFever(8 + combo*0.6);
                Â  Â  Â  deck.onGood();Â  Â  Â  Â  Â  Â // âœ… à¸™à¸±à¸šà¸‚à¸­à¸‡à¸”à¸µ
                Â  Â  Â  syncDeckStats();
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'goodjunk'});
                Â  Â  Â  pushQuestHUD();
                Â  Â  Â  return { good:true, scoreDelta: delta };
                Â  Â  } else {
                Â  Â  Â  // à¸•à¸µà¹‚à¸”à¸™à¸‚à¸¢à¸°
                Â  Â  Â  if (shield>0){
                Â  Â  Â  Â  shield -= 1; setShield(shield);
                Â  Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'hydration'});
                Â  Â  Â  Â  pushQuestHUD();
                Â  Â  Â  Â  return {good:false, scoreDelta:0};
                Â  Â  Â  }
                Â  Â  Â  const delta = -15;
                Â  Â  Â  score = Math.max(0, score + delta); combo = 0;
                Â  Â  Â  decayFever(18);
                Â  Â  Â  // âŒ à¸ªà¸³à¸„à¸±à¸: "à¸•à¸µà¹‚à¸”à¸™à¸‚à¸¢à¸°" à¹„à¸¡à¹ˆà¸–à¸·à¸­à¸§à¹ˆà¸² 'à¸«à¸¥à¸µà¸à¸‚à¸¢à¸°' â†’ à¸«à¹‰à¸²à¸¡ deck.onJunk() à¸—à¸µà¹ˆà¸™à¸µà¹ˆ
                Â  Â  Â  // à¹à¸•à¹ˆà¸•à¹‰à¸­à¸‡à¸£à¸µà¹€à¸‹à¹‡à¸• no-miss timer à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡
                Â  Â  Â  deck.stats.noMissTime = 0;
                Â  Â  Â  syncDeckStats();
                Â  Â  Â  Particles.burstShards(null,null,{screen:{x:cx,y:cy},theme:'plate'});
                Â  Â  Â  pushQuestHUD();
                Â  Â  Â  return { good:false, scoreDelta: delta };
                Â  Â  }
                Â  }

                Â  // ---------- Event hooks ----------
                Â  // à¸‚à¸¢à¸°à¸«à¸¡à¸”à¹€à¸§à¸¥à¸² = "à¸«à¸¥à¸µà¸à¸‚à¸¢à¸°" â†’ deck.onJunk() à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸™à¸±à¸š junkMiss à¹à¸¥à¸°à¸£à¸µà¹€à¸‹à¹‡à¸• noMissTime à¸ à¸²à¸¢à¹ƒà¸™
                Â  function onExpire(ev){
                Â  Â  if (!ev || ev.isGood) return;
                Â  Â  gainFever(4);
                Â  Â  deck.onJunk(); // âœ… à¸™à¸±à¸šà¸«à¸¥à¸µà¸à¸‚à¸¢à¸°
                Â  Â  syncDeckStats();
                Â  Â  pushQuestHUD(`Wave ${wave}`);
                Â  }

                Â  function refillWaveIfCleared(){
                Â  Â  if (deck.isCleared()){
                Â  Â  Â  totalQuestsCleared += 3;
                Â  Â  Â  deck.draw3();Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¸ªà¸¸à¹ˆà¸¡à¸Šà¸¸à¸”à¹ƒà¸«à¸¡à¹ˆà¸—à¸±à¸™à¸—à¸µ
                Â  Â  Â  pushQuestHUD(`Wave ${++wave}`);
                Â  Â  }
                Â  }

                Â  function onHitScreen(){
                Â  Â  pushQuestHUD(`Wave ${wave}`);
                Â  Â  refillWaveIfCleared();
                Â  }

                Â  function onSec(ev){
                      // à¸­à¸±à¸›à¹€à¸”à¸•à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸à¸—à¸±à¸™à¸—à¸µ
                      if (ev.detail.sec === dur) {
                        syncDeckStats();
                        pushQuestHUD(`Wave ${wave}`);
                      }
                Â  Â  // Fever à¸„à¹ˆà¸­à¸¢ à¹† à¸¥à¸”à¹€à¸­à¸‡ (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸­à¸¡à¹‚à¸šà¸¥à¸”à¹„à¸§à¸‚à¸¶à¹‰à¸™)
                Â  Â  decayFever(combo<=0 ? 6 : 2);
                Â  Â  // à¸™à¸±à¸šà¹€à¸§à¸¥à¸²à¹„à¸¡à¹ˆà¸à¸¥à¸²à¸”
                Â  Â  deck.second();
                Â  Â  syncDeckStats();
                Â  Â  pushQuestHUD(`Wave ${wave}`);
                Â  }

                Â  window.addEventListener('hha:hit-screen', onHitScreen);
                Â  window.addEventListener('hha:expired',Â  Â  onExpire);
                Â  window.addEventListener('hha:time',Â  Â  Â  Â onSec);

                Â  const onEnd = () => {
                Â  Â  try{
                Â  Â  Â  window.removeEventListener('hha:hit-screen', onHitScreen);
                Â  Â  Â  window.removeEventListener('hha:expired',Â  Â  onExpire);
                Â  Â  Â  window.removeEventListener('hha:time',Â  Â  Â  Â onSec);
                        
                Â  Â  Â  const clearedNowÂ  Â  = deck.getProgress().filter(q=>q.done).length;
                Â  Â  Â  const questsCleared = totalQuestsCleared + clearedNow;
                Â  Â  Â  const questsTotalÂ  Â = (wave-1)*3 + 3; // à¹€à¸„à¸§à¸ªà¸•à¹Œà¸—à¸µà¹ˆà¸–à¸¹à¸à¹€à¸ªà¸™à¸­à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸™à¸ˆà¸š

                Â  Â  Â  questHUDDispose();
                        // à¸¥à¹‰à¸²à¸‡ UI à¸­à¸·à¹ˆà¸™à¹† à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¹‚à¸«à¸¡à¸”
                        window.dispatchEvent(new CustomEvent('hha:dispose-ui'));
                        
                        // à¸„à¸·à¸™à¸„à¹ˆà¸²à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹„à¸›à¸¢à¸±à¸‡ factoryBoot
                Â  Â  Â  return {
                Â  Â  Â  Â  mode:'Good vs Junk', difficulty:diff, score,
                Â  Â  Â  Â  comboMax:deck.stats.comboMax, misses:deck.stats.junkMiss, hits:deck.stats.goodCount,
                Â  Â  Â  Â  duration:dur,
                Â  Â  Â  Â  goalCleared: score>=GOAL_SCORE,
                Â  Â  Â  Â  goalTarget : GOAL_SCORE,
                Â  Â  Â  Â  questsCleared, questsTotal
                Â  Â  Â  };
                Â  Â  }catch(e){
                        console.error('Error during onEnd:', e);
                        return {};
                      }
                Â  };

                Â  // ---------- Boot via factory (à¸¡à¸µ power-ups + expired hook) ----------
                Â  return factoryBoot({
                Â  Â  difficulty: diff,
                Â  Â  durationÂ  : dur,
                Â  Â  poolsÂ  Â  Â : { good:[...GOOD, ...BONUS], bad:[...JUNK] },
                Â  Â  goodRateÂ  : 0.65,
                Â  Â  powerupsÂ  : BONUS,
                Â  Â  powerRate : 0.08,
                Â  Â  powerEvery: 7,
                Â  Â  judgeÂ  Â  Â : (ch, ctx)=>judge(ch, { ...ctx, cx:(ctx.clientX||ctx.cx), cy:(ctx.clientY||ctx.cy) }),
                Â  Â  onExpire,
                    onFinish  : onEnd // à¸ªà¹ˆà¸‡ onEnd à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™ factory
                Â  }).then(ctrl=>{
                    // `hha:end` à¸ˆà¸°à¸–à¸¹à¸à¸¢à¸´à¸‡à¸ˆà¸²à¸ factoryBoot à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸ onFinish à¸—à¸³à¸‡à¸²à¸™à¹€à¸ªà¸£à¹‡à¸ˆ
                Â  Â  // à¹€à¸£à¸²à¹à¸„à¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¸«à¸¢à¸¸à¸”à¹€à¸à¸¡ (à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™)
                    // à¸•à¸±à¸§à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²à¸ˆà¸°à¸–à¸¹à¸à¸ˆà¸±à¸”à¸à¸²à¸£à¹‚à¸”à¸¢ factoryBoot à¹à¸¥à¸°à¸ˆà¸°à¹€à¸£à¸µà¸¢à¸ onEnd à¹€à¸¡à¸·à¹ˆà¸­à¸«à¸¡à¸”à¹€à¸§à¸¥à¸²
                Â  Â  return ctrl;
                Â  });
                }
            })(GAME_MODULES, GAME_MODULES);


            // --- 7. Game Launcher (à¸•à¸±à¸§à¹€à¸£à¸µà¸¢à¸à¹€à¸à¸¡) ---
            (function(App) {
                'use strict';
                const uiOverlay = document.getElementById('uiOverlay');
                const startScreen = document.getElementById('startScreen');
                const resultsScreen = document.getElementById('resultsScreen');
                const resultsData = document.getElementById('resultsData');
                const playAgainButton = document.getElementById('playAgainButton');

                let activeGame = null;

                function cleanupGameUI() {
                    // à¸¥à¹‰à¸²à¸‡ UI à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸ˆà¸°à¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¸ˆà¸²à¸à¹€à¸à¸¡à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§
                    window.dispatchEvent(new CustomEvent('hha:dispose-ui'));
                    const oldPanels = document.querySelectorAll('[data-hha-ui]');
                    oldPanels.forEach(el => el.remove());
                    
                    const oldLayers = document.querySelectorAll('.hha-layer');
                    oldLayers.forEach(el => el.remove());

                    const feverUI = ['#feverWrap', '#shieldChip', '#feverFlame', '#questPanel', '.hha-layer'];
                    feverUI.forEach(sel => {
                        const el = document.querySelector(sel);
                        if (el) el.remove();
                    });
                }

                function startGame(difficulty) {
                    if (activeGame) {
                        activeGame.stop();
                    }
                    
                    cleanupGameUI();
                    
                    startScreen.style.display = 'none';
                    resultsScreen.style.display = 'none';
                    uiOverlay.classList.add('hidden');

                    // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡
                    App.boot({ difficulty: difficulty, duration: 60 })
                        .then(controller => {
                            activeGame = controller;
                        });
                }

                function showResults(detail) {
                    uiOverlay.classList.remove('hidden');
                    startScreen.style.display = 'none';
                    resultsScreen.style.display = 'block';
                    
                    const goalStatus = detail.goalCleared ? 'âœ… à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' : 'âŒ à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ';
                    
                    resultsData.textContent = `
    à¸„à¸°à¹à¸™à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢: ${detail.score}
    à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ (${detail.difficulty}): ${detail.goalTarget} (${goalStatus})
    à¸„à¸­à¸¡à¹‚à¸šà¸ªà¸¹à¸‡à¸ªà¸¸à¸”: ${detail.comboMax}
    à¹€à¸„à¸§à¸ªà¸•à¹Œà¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰: ${detail.questsCleared} / ${detail.questsTotal}
    à¹€à¸à¹‡à¸šà¸‚à¸­à¸‡à¸”à¸µ: ${detail.hits}
    à¸«à¸¥à¸šà¸‚à¸¢à¸° (à¸ªà¸³à¹€à¸£à¹‡à¸ˆ): ${detail.misses}
                    `;
                }

                // à¸•à¸±à¸§à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸¡à¸ˆà¸š
                window.addEventListener('hha:end', (ev) => {
                    activeGame = null;
                    showResults(ev.detail || {});
                    cleanupGameUI(); // à¸¥à¹‰à¸²à¸‡ UI à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
                });

                // à¸›à¸¸à¹ˆà¸¡à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡
                document.getElementById('startButtonEasy').addEventListener('click', () => startGame('easy'));
                document.getElementById('startButtonNormal').addEventListener('click', () => startGame('normal'));
                document.getElementById('startButtonHard').addEventListener('click', () => startGame('hard'));
                
                // à¸›à¸¸à¹ˆà¸¡à¹€à¸¥à¹ˆà¸™à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
                playAgainButton.addEventListener('click', () => {
                    resultsScreen.style.display = 'none';
                    startScreen.style.display = 'block';
                });

            })(GAME_MODULES);

        })();
    </script>
</body>
</html>
