<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>

  <link rel="icon" href="./favicon.ico" type="image/x-icon"/>

  <!-- A-Frame + Troika -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text@0.12.0/dist/aframe-troika-text.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}
    #feverWrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:900;
      width:min(540px,86vw);height:12px;background:#0f172a;border:1px solid #334155;border-radius:999px;overflow:hidden}
    #feverFill{height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0);transition:width .15s}
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);width:min(1080px,86vw);
      padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip">พลาด: 0 ครั้ง</div>
  <div id="feverWrap"><div id="feverFill"></div></div>

  <!-- เมนู -->
  <div id="menu" class="menu-wrap">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">เลือกโหมด:</label>
        <select id="modeSel">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration" selected>Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">ระดับ:</label>
        <select id="diffSel">
          <option value="easy">ง่าย (90s)</option>
          <option value="normal" selected>ปกติ (60s)</option>
          <option value="hard">ยาก (45s)</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">เริ่มเกม</button>
      </div>
    </div>
  </div>

  <!-- A-Frame Scene -->
  <a-scene id="scene" background="color:#0b1324">
    <a-entity id="cam" camera look-controls cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects:.clickable; far:6" position="0 1.6 0"></a-entity>
    <a-entity id="spawnHost" position="0 1.0 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <script>
    // HUD events
    (function(){
      const $=s=>document.querySelector(s);
      window.addEventListener('hha:score',e=>{
        const d=e.detail||{};$('#badgeScore').textContent=`คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
      });
      window.addEventListener('hha:time',e=>{
        const t=Math.max(0,Math.round(e.detail?.sec||0));$('#badgeTime').textContent='เวลา: '+t+'s';
      });
      window.addEventListener('hha:quest',e=>{ $('#badgeQuest').textContent=e.detail?.text||'Mini Quest'; });
      window.addEventListener('hha:miss',e=>{
        const el=$('#badgeMiss'); el.style.display='';
        const n=(parseInt(el.dataset.n||'0',10)+1); el.dataset.n=n; el.textContent='พลาด: '+n+' ครั้ง';
      });
    })();
  </script>

  <!-- Loader with robust boot() detection -->
  <script>
    (function(){
      const q = (k)=> new URLSearchParams(location.search).get(k);
      const DEBUG = q('debug')==='1' || q('debug')==='true';
      const MAP={
        goodjunk :'./modes/goodjunk.safe.js',
        groups   :'./modes/groups.safe.js',
        hydration:'./modes/hydration.quest.js',
        plate    :'./modes/plate.quest.js'
      };
      const withStamp=url=>url+(url.includes('?')?'&':'?')+'v='+Date.now();
      let current=null;
      function cleanup(){
        try{window.dispatchEvent(new Event('hha:dispose-ui'));}catch{}
        document.querySelectorAll('[data-hha-ui]').forEach(n=>n.remove());
        const host=document.getElementById('spawnHost');
        host && host.querySelectorAll('a-image,a-entity,div.hha-tgt').forEach(n=>n.remove());
        document.body.classList.remove('fever-on');
        const ff=document.getElementById('feverFill'); if(ff) ff.style.width='0%';
      }
      function dlog(...a){ if(DEBUG) console.log('[HHA]', ...a); }

      document.getElementById('startBtn').addEventListener('click', async ()=>{
        const mode=document.getElementById('modeSel').value;
        const diff=document.getElementById('diffSel').value;

        // reset HUD
        document.getElementById('badgeScore').textContent='คะแนน: 0 | คอมโบ: x0';
        document.getElementById('badgeTime').textContent='เวลา: '+(diff==='easy'?90:diff==='hard'?45:60)+'s';
        document.getElementById('badgeQuest').textContent='Mini Quest — กำลังเริ่ม…';
        const missEl=document.getElementById('badgeMiss'); missEl.style.display='none'; missEl.dataset.n='0';

        document.getElementById('menu').style.display='none';
        try{current?.stop?.();}catch{}
        cleanup();

        const url=withStamp(MAP[mode]||MAP.goodjunk);
        dlog('import', url);
        try{
          const mod = await import(url);
          dlog('module keys', Object.keys(mod), 'default keys', mod?.default && Object.keys(mod.default));

          let bootFn=null;
          if (typeof mod?.boot==='function') bootFn=mod.boot;
          else if (typeof mod?.default?.boot==='function') bootFn=mod.default.boot;
          else if (typeof window.HHA_BOOT==='function') bootFn=window.HHA_BOOT;

          if(!bootFn) throw new Error('โหมดนี้ไม่มีฟังก์ชัน boot()');

          current = await bootFn({ host:document.getElementById('spawnHost'), difficulty:diff });
          window.addEventListener('blur',()=>current?.pause?.());
          window.addEventListener('focus',()=>current?.resume?.());
          dlog('boot ok');
        }catch(err){
          console.error(err);
          alert('โหลดโหมดไม่สำเร็จ: ' + (err && err.message?err.message:err));
          cleanup();
          document.getElementById('menu').style.display='';
        }
      });
    })();
  </script>
</body>
</html>