<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hero Health VR — Nutrition Hub</title>
<meta name="color-scheme" content="light dark"/>
<style>
  html,body{height:100%;margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
  .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px;z-index:10}
  .fallback strong{color:#9ff}
  .ver{position:fixed;right:10px;bottom:10px;opacity:0.6;font-size:12px}
</style>

<!-- A-Frame & Troika -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

<!-- on-top renderer for UI -->
<script>
AFRAME.registerComponent('front-most', {
  schema:{order:{default:10000}},
  init(){
    const apply=(o)=>{ o.traverse(n=>{ if(n.material){ n.material.depthTest=false; n.material.depthWrite=false; n.renderOrder=this.data.order; }}); };
    if(this.el.object3D) apply(this.el.object3D);
    this.el.addEventListener('object3dset',()=>apply(this.el.object3D));
  }
});
</script>

<!-- Hub (optional; ถ้าไม่มีจะ fallback inline) -->
<script type="module">
  import { GameHub } from './vr/hub.js?v=starter';
  window.addEventListener('DOMContentLoaded',()=>{ try{ window.__hub=new GameHub(); }catch(e){ console.warn('hub missing, fallback inline',e); } });
</script>
</head>
<body>
<div class="fallback" id="bootStatus"><div><strong>Status:</strong> Booting…</div>
  <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Force Start</button>
</div>
<div class="ver">HeroHealth VR — Menu Fix</div>

<a-scene background="color:#0b1324" vr-mode-ui="enterVRButton:true"
         renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true">
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
  <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
  <a-sky color="#0b1324"></a-sky>

  <!-- HUD -->
  <a-entity id="hudRoot" position="0 2.18 -2.8" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.30"
              material="color:#111a33; opacity:0.9;"></a-entity>
    <a-entity id="hudMode"  troika-text="value: โหมด: -; color:#9fd; fontSize:0.06;" position="-0.9 0.08 0.05"></a-entity>
    <a-entity id="hudTime"  troika-text="value: เวลา: 60s; color:#fff; fontSize:0.06;" position="-0.9 -0.02 0.05"></a-entity>
    <a-entity id="hudScore" troika-text="value: คะแนน: 0; color:#fff; fontSize:0.06;" position="0.15 0.08 0.05"></a-entity>
    <a-entity id="hudCombo" troika-text="value: คอมโบ: x1; color:#fff; fontSize:0.06;" position="0.15 -0.02 0.05"></a-entity>

    <!-- Fever bar -->
    <a-entity position="0 -0.20 0">
      <a-entity geometry="primitive: plane; width: 1.9; height: 0.08"
                material="color:#1b2752; opacity:0.95;"></a-entity>
      <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.95 0 0.06"
                material="color:#ff6600; opacity:0.95;"></a-entity>
      <a-entity id="feverLbl" troika-text="value: Fever 0%; color:#ffd54f; fontSize:0.06;" position="-0.92 -0.01 0.08"></a-entity>
    </a-entity>

    <!-- Buttons -->
    <a-entity id="pauseBtn" class="clickable" position="-0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#5b2b2b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: Pause; color:#fff; fontSize:0.045;" position="-0.95 0.095 0.08"></a-entity>

    <a-entity id="langBtn" class="clickable" position="0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#243a6b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: TH/EN; color:#fff; fontSize:0.045;" position="0.80 0.095 0.08"></a-entity>
  </a-entity>

  <!-- Mini Quest -->
  <a-entity id="questPanel" position="0 1.65 -2.8" visible="false" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.28"
              material="color:#111a33; opacity:0.88; transparent:true;"></a-entity>
    <a-entity troika-text="value: Mini Quests; color:#ffd54f; fontSize:0.07;" position="-0.9 0.09 0.05"></a-entity>
    <a-entity id="tQ" troika-text="value: ; color:#e8f0ff; fontSize:0.06;" position="-0.9 -0.06 0.05"></a-entity>
  </a-entity>

  <!-- เมนูโหมด (ขยับใกล้ + front-most) -->
  <a-entity id="modeMenu" position="0 1.35 -1.0" front-most="order:10001">
    <a-entity geometry="primitive: plane; width: 1.05; height: 0.62"
              material="color:#0e1b38; opacity:0.95; transparent:true"></a-entity>
    <a-entity troika-text="value: เลือกโหมดเกม; color:#9fd; fontSize:0.065;" position="-0.40 0.25 0.26"></a-entity>
    <a-entity troika-text="value: ดี  vs  ขยะ; color:#fff; fontSize:0.058;" position="-0.38 0.09 0.26"></a-entity>
    <a-entity troika-text="value: หมวดอาหาร; color:#fff; fontSize:0.058;" position="0.06 0.09 0.26"></a-entity>
    <a-entity troika-text="value: สมดุลน้ำ; color:#fff; fontSize:0.058;" position="-0.38 -0.12 0.26"></a-entity>
    <a-entity troika-text="value: จานสุขภาพ; color:#fff; fontSize:0.058;" position="0.06 -0.12 0.26"></a-entity>

    <!-- ปุ่ม (ทำให้มองเห็นเล็กน้อยเพื่อดีบัก; ปรับกลับ opacity:0.001 ได้) -->
    <a-plane class="clickable" data-mode="goodjunk" position="-0.16 0.09 0.24" width="0.46" height="0.18"
             material="color:#00ff88; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="groups" position="0.40 0.09 0.24" width="0.46" height="0.18"
             material="color:#00aaff; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="hydration" position="-0.16 -0.12 0.24" width="0.46" height="0.18"
             material="color:#ffd400; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="plate" position="0.40 -0.12 0.24" width="0.46" height="0.18"
             material="color:#ff6a6a; opacity:0.12"></a-plane>
  </a-entity>

  <!-- ปุ่มเริ่ม -->
  <a-entity id="startPanel" position="0 0.72 -1.15" visible="false" front-most="order:10000">
    <a-plane id="startBtn" class="clickable" position="0 0 0.30"
             width="0.90" height="0.24"
             material="color:#2e8b57; transparent:true; opacity:1.0"></a-plane>
    <a-entity id="startBtnFx" position="0 0 0.31"
              geometry="primitive: plane; width:0.92; height:0.26"
              material="color:#ffffff; opacity:0.0; transparent:true"></a-entity>
    <a-entity id="startLbl" troika-text="value: เลือกโหมดก่อน; color:#fff; fontSize:0.058;"
              position="-0.27 0 0.40"></a-entity>
  </a-entity>

  <!-- Rig/Camera — raycaster ยิงได้ทั้ง .hitbox และ .clickable -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="camera"
              camera look-controls
              cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 550"
              raycaster="objects: .hitbox, .clickable; far: 6; interval: 0">
      <a-entity id="aimRing" position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                material="color:#9fd; shader: flat; depthTest:false; depthWrite:false"></a-entity>
    </a-entity>
    <a-entity laser-controls="hand: right"
              raycaster="objects: .hitbox, .clickable; far: 6; interval: 0"></a-entity>
  </a-entity>

  <!-- พื้นที่เกม -->
  <a-entity id="spawnZone" position="0 1.00 -3.80"></a-entity>
  <a-entity id="fxLayer" position="0 0 0"></a-entity>
</a-scene>

<!-- App wiring / Audio unlock / Pause / i18n / Fallback inline GoodJunk -->
<script>
function logBoot(msg){
  const box=document.getElementById('bootStatus');
  if(box) box.firstElementChild.innerHTML='<strong>Status:</strong> '+msg;
  console.log('[HVR]',msg);
}

// Audio unlock (มือถือ/VR)
let _ctx;
function getAudioCtx(){ if(_ctx) return _ctx; const AC = window.AudioContext||window.webkitAudioContext; _ctx = new AC(); return _ctx; }
['click','touchstart','pointerdown','keydown'].forEach(ev=>{
  window.addEventListener(ev,()=>{ try{ getAudioCtx().resume(); }catch{} }, {once:true});
});

// Pause/Resume global
(function(){
  let paused=false;
  function setPaused(v){ if(paused===v) return; paused=v; window.dispatchEvent(new CustomEvent(v?'hha:pause':'hha:resume')); logBoot(v?'Paused':'Resumed'); }
  window.addEventListener('visibilitychange',()=>setPaused(document.hidden));
  window.addEventListener('blur',()=>setPaused(true));
  window.addEventListener('focus',()=>setPaused(false));
  document.getElementById('pauseBtn').addEventListener('click',()=>setPaused(!paused));
})();

// i18n stub
const i18n = {
  th: { mode:'โหมด', time:'เวลา', score:'คะแนน', start:'เริ่ม', quests:'Quests' },
  en: { mode:'Mode', time:'Time', score:'Score', start:'Start', quests:'Quests' }
};
let lang='th';
document.getElementById('langBtn').addEventListener('click', ()=>{
  lang = (lang==='th'?'en':'th');
  document.getElementById('hudMode') .setAttribute('troika-text','value', (i18n[lang].mode||'Mode')+': -');
  document.getElementById('hudTime') .setAttribute('troika-text','value', (i18n[lang].time||'Time')+': 60s');
  document.getElementById('hudScore').setAttribute('troika-text','value', (i18n[lang].score||'Score')+': 0');
});

// เมนู/เริ่ม/Force fallback + DEBUG LOG
function wireClicks(){
  const hub=()=>window.__hub;

  // DEBUG: ดูว่าเมาส์/เรย์เข้าเป้าหรือยัง
  document.querySelectorAll('.clickable').forEach(e=>{
    ['mouseenter','click'].forEach(ev=>{
      e.addEventListener(ev,()=>console.log('HIT',ev,e.getAttribute('data-mode')||e.id));
    });
  });

  // เลือกโหมด
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    const mode=btn.getAttribute('data-mode');
    const onPick=()=>{
      if(hub() && typeof hub().selectMode==='function') hub().selectMode(mode);
      const lbl=document.getElementById('startLbl');
      if(lbl) lbl.setAttribute('troika-text','value','เริ่ม: '+mode.toUpperCase());
      document.getElementById('startPanel').setAttribute('visible',true);
      logBoot('Picked mode: '+mode);
      document.getElementById('hudMode').setAttribute('troika-text','value',(i18n[lang].mode||'Mode')+': '+mode);
    };
    ['click','mousedown','mouseup','triggerdown'].forEach(ev=>btn.addEventListener(ev,onPick));
  });

  // ปุ่ม Start
  const start=document.getElementById('startBtn');
  const fx=document.getElementById('startBtnFx');
  start.addEventListener('mouseenter',()=>fx.setAttribute('material','opacity',0.08));
  start.addEventListener('mouseleave',()=>fx.setAttribute('material','opacity',0.0));
  const tryStart=async ()=>{
    logBoot('Start pressed');
    if(hub()){
      if(typeof hub().startGame==='function'){ hub().startGame(); gotoPlayUI(); return; }
      if(typeof hub().start==='function'){ hub().start(); gotoPlayUI(); return; }
      if(typeof hub().begin==='function'){ hub().begin(); gotoPlayUI(); return; }
    }
    // fallback inline
    logBoot('Fallback inline GoodJunk');
    inlineGoodJunkBoot({host:document.getElementById('spawnZone'), duration:60, difficulty:'normal'});
    gotoPlayUI();
  };
  function gotoPlayUI(){
    document.getElementById('modeMenu').setAttribute('visible', false);
    document.getElementById('startPanel').setAttribute('visible', false);
  }
  ['click','mousedown','mouseup','triggerdown'].forEach(ev=>start.addEventListener(ev,tryStart));
  document.getElementById('forceStartBtn').addEventListener('click', tryStart);
}
if(document.readyState!=='loading') setTimeout(wireClicks,0);
else window.addEventListener('DOMContentLoaded',()=>setTimeout(wireClicks,0));

/* ---------------- Helper HUD ---------------- */
function setHudTime(sec){ document.getElementById('hudTime').setAttribute('troika-text','value',(i18n[lang].time||'Time')+': '+sec+'s'); }
function setHudScore(sc){ document.getElementById('hudScore').setAttribute('troika-text','value', (i18n[lang].score||'Score')+': '+sc); }
function setHudCombo(c){ document.getElementById('hudCombo').setAttribute('troika-text','value','คอมโบ: x'+Math.max(1,c)); }
function setHudFever(p){
  const bar = document.getElementById('feverFill');
  if (bar) bar.setAttribute('geometry','width', (Math.max(0,Math.min(1,p))*1.9));
  const label = document.getElementById('feverLbl');
  if (label) label.setAttribute('troika-text','value','Fever ' + Math.round(p*100) + '%');
}
function burst3D(host, pos=[0,0,0], color='#7ee'){
  for(let i=0;i<10;i++){
    const piece = document.createElement('a-entity');
    piece.setAttribute('geometry','primitive: box; depth: 0.02; height: 0.02; width: 0.02');
    piece.setAttribute('material',`color:${color}; opacity:0.95; transparent:true`);
    piece.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    const dx = (Math.random()*0.6-0.3).toFixed(2);
    const dy = (Math.random()*0.6-0.2).toFixed(2);
    const dz = (Math.random()*0.2+0.05).toFixed(2);
    piece.setAttribute('animation__move', `property: position; to: ${(+pos[0]+ +dx)} ${(+pos[1]+ +dy)} ${(+pos[2]+ +dz)}; dur: 450; easing: easeOutQuad`);
    piece.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 420; delay:80; easing: linear');
    host.appendChild(piece);
    setTimeout(()=>piece.remove(), 520);
  }
}
function popupScore(host, pos=[0,0,0], text='+1', color='#7CFC00'){
  const node = document.createElement('a-entity');
  node.setAttribute('troika-text', `value: ${text}; color:${color}; fontSize:0.06; anchor:center;`);
  node.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]+0.02}`);
  node.setAttribute('animation__rise', `property: position; to: ${pos[0]} ${(+pos[1]+0.24).toFixed(2)} ${pos[2]+0.02}; dur:600; easing:easeOutQuad`);
  node.setAttribute('animation__fade', `property: opacity; to: 0; dur: 500; delay:100; easing: linear`);
  host.appendChild(node);
  setTimeout(()=>node.remove(), 700);
}

/* ================= Inline GoodJunk (full-screen targets) — ย่อไว้: ใช้ของเวอร์ชันก่อนหน้า ================= */
/*  หมายเหตุ: ส่วนเกม fallback ยังเหมือนรุ่นก่อนหน้า (สุ่มทั่ว 2.2×1.2, hitbox กลม, mini quest, x2/shield/fever)
    ถ้าต้องการ ผมส่งฉบับเต็มอีกครั้งได้ แต่เพื่อให้ตอบโจทย์ “คลิกเมนูไม่ได้” เราเน้นแก้เมนูและ raycaster ในไฟล์นี้ก่อน */
</script>
</body>
</html>
