<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>HeroHealth</title>
<style>
  :root { --bg:#0b1220; --card:#0f172acc; --text:#e8eefc; --muted:#94a3b8; --line:#334155; --accent:#60a5fa; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Apple Color Emoji,Segoe UI Emoji; }
  .hud{ position:fixed; left:12px; right:12px; top:12px; display:flex; gap:12px; z-index:900 }
  .pill{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:10px 14px; font-weight:800; }
  .zone{ position:fixed; left:12px; right:12px; bottom:16px; z-index:900; }
  .panel{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; }
  .title{ display:flex; justify-content:space-between; align-items:center; gap:8px; font-weight:900; }
  .bar{ height:12px; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:#0b1222; margin-top:6px; }
  .fill{ height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#93c5fd); transition:width .2s ease; }
  .sub{ margin-top:10px; color:var(--muted); font-weight:700 }
  /* DOM target layer (โหมดใช้เอง) */
  .hha-layer{ position:fixed; inset:0; z-index:650; pointer-events:auto; background:transparent }
  .hha-tgt{ position:absolute; transform:translate(-50%,-50%); line-height:1; filter:drop-shadow(0 8px 14px rgba(0,0,0,.5)) }
</style>
</head>
<body>

<!-- HUD บน -->
<div class="hud">
  <div class="pill" id="hudTime">เวลา: --s</div>
  <div class="pill" id="hudScore">คะแนน: 0 | คอมโบ: x0</div>
  <div class="pill" id="hudQuest">Mini Quest — กำลังเริ่ม…</div>
</div>

<!-- HUD ล่าง -->
<div class="zone">
  <div class="panel">
    <div class="title">
      <span id="goalLabel">เป้า: –</span>
      <span id="modeLabel">โหมด: –</span>
    </div>
    <div class="bar"><div class="fill" id="goalFill"></div></div>

    <div class="sub" id="questRow">Quest — </div>
    <div class="bar"><div class="fill" id="questFill"></div></div>
  </div>
</div>

<script type="module">
  // ====== utility ======
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get('mode')||'goodjunk').toLowerCase();  // goodjunk | hydration | groups | plate
  const diff = (qs.get('diff')||'normal').toLowerCase();     // easy|normal|hard
  const dur  = Number(qs.get('dur')||60);

  const $ = sel => document.querySelector(sel);
  const hud = {
    time:   $('#hudTime'),
    score:  $('#hudScore'),
    quest:  $('#hudQuest'),
    goalLbl:$('#goalLabel'),
    goalFill:$('#goalFill'),
    modeLbl:$('#modeLabel'),
    qRow:   $('#questRow'),
    qFill:  $('#questFill'),
  };
  hud.modeLbl.textContent = `โหมด: ${diff}`;

  // ====== event wiring (รับจากโหมดเกม) ======
  window.addEventListener('hha:time', (e)=>{
    const s = Math.max(0, Math.floor(e.detail?.sec ?? 0));
    hud.time.textContent = `เวลา: ${s}s`;
  });

  window.addEventListener('hha:score', (e)=>{
    const sc = e.detail?.score ?? 0;
    const cb = e.detail?.combo ?? 0;
    hud.score.textContent = `คะแนน: ${sc} | คอมโบ: x${cb}`;
  });

  // เป้าหมายหลัก
  window.addEventListener('hha:goal', (e)=>{
    const {label='', value=0, max=0, mode:''} = (e.detail||{});
    hud.goalLbl.textContent = label;
    if (max>0) hud.goalFill.style.width = Math.min(100, Math.round(value/max*100)) + '%';
    if (mode) hud.modeLbl.textContent = `โหมด: ${mode}`;
  });

  // ป้ายเควสต์บน + แถบเควสต์ล่าง
  window.addEventListener('hha:quest', (e)=>{
    hud.quest.textContent = e.detail?.label || 'Mini Quest — กำลังเริ่ม…';
    if (e.detail?.currentIndex!=null && e.detail?.total!=null){
      hud.quest.textContent = `Quest ${e.detail.currentIndex+1}/${e.detail.total} — ${e.detail.label||''}`;
      hud.qRow.textContent  = `Quest ${e.detail.currentIndex+1}/${e.detail.total} — ${e.detail.label||''}`;
    }
  });
  window.addEventListener('hha:quest-progress', (e)=>{
    const {label='', value=0, max=0, currentIndex, total} = (e.detail||{});
    if (label) {
      const head = (currentIndex!=null && total!=null) ? `Quest ${currentIndex+1}/${total} — ` : 'Quest — ';
      hud.qRow.textContent = head + label;
    }
    if (max>0) hud.qFill.style.width = Math.min(100, Math.round(value/max*100)) + '%';
    else hud.qFill.style.width = '0%';
  });

  // สรุปตอนจบ
  window.addEventListener('hha:end', (e)=>{
    const d = e.detail||{};
    const msg = [
      'จบเกม!',
      `คะแนน: ${d.score ?? 0}`,
      `คอมโบสูงสุด: ${d.combo ?? 0}`,
      `Mini Quest: ${d.questsCleared ?? 0}/${d.questsTotal ?? 3}`,
      `Goal: ${d.goal ? 'สำเร็จ' : 'ยังไม่สำเร็จ'}`
    ].join('\n');
    alert(msg);
  });

  // ====== โหลดโหมดตามพาธ ======
  const map = {
    goodjunk   : './modes/goodjunk.safe.js',
    hydration  : './modes/hydration.quest.js',
    groups     : './modes/groups.safe.js',
    plate      : './modes/plate.quest.js',
  };
  const url = map[mode] || map.goodjunk;

  try {
    const mod = await import(url);
    if (!mod || typeof mod.boot!=='function')
      throw new Error('โหมดโหลดได้ แต่ไม่พบฟังก์ชัน boot()');

    // เริ่มเกม
    await mod.boot({ difficulty: diff, duration: dur });

    // แจ้งว่าพร้อม (บางโหมดอาจอยากรู้)
    window.dispatchEvent(new CustomEvent('hha:index-ready'));
  } catch (err) {
    alert('โหลดโหมดไม่สำเร็จ: ' + (err?.message || err));
    // เผื่อดีบัก
    console.error(err);
  }
</script>
</body>
</html>