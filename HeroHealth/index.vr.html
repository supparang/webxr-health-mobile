<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health Academy ‚Äî VR Edition</title>
  <meta name="color-scheme" content="light dark" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; background:#0b1120; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif; }
    .hud { position:fixed; top:10px; left:0; right:0; display:flex; justify-content:space-between; align-items:center; padding:0 12px; font-size:14px; z-index:20; }
    .hud > div { background:rgba(255,255,255,0.08); padding:6px 12px; border-radius:12px; backdrop-filter:blur(6px); }
    #feverBarWrap { position:fixed; top:46px; left:50%; transform:translateX(-50%); width:min(820px,86vw); height:12px; background:rgba(255,255,255,0.08); border-radius:999px; overflow:hidden; z-index:19; }
    #feverBar { width:0%; height:100%; background:linear-gradient(90deg,#facc15,#f97316); transition:width 0.15s; }
    #feverBadge { position:fixed; top:64px; right:12px; background:#f59e0b; color:#111827; font-weight:800; padding:3px 8px; border-radius:999px; display:none; z-index:21; }

    #vrButton { position:fixed; bottom:16px; right:16px; background:white; color:black; font-weight:bold; border-radius:8px; padding:6px 14px; font-size:1rem; z-index:30; }
    a-scene { width:100vw; height:100vh; }
    /* Fever flash overlay */
    #feverFlash { position:fixed; inset:0; background:radial-gradient(circle at center, rgba(255,214,102,0.35), rgba(255,153,0,0.15), transparent 70%); pointer-events:none; opacity:0; transition:opacity .18s; z-index:18; }
    .show-flash { opacity:1; }
  </style>
</head>
<body>
  <div class="hud">
    <div id="timeBox">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
    <div id="scoreBox">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
    <div id="questBox">Mini Quest ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶</div>
  </div>
  <div id="feverBarWrap"><div id="feverBar"></div></div>
  <div id="feverBadge">FEVER x2</div>
  <div id="feverFlash"></div>

  <a-scene vr-mode-ui="enabled: true" background="color: #0b1120">
    <a-entity id="cameraRig">
      <a-entity id="playerCam"
        camera
        look-controls
        wasd-controls
        position="0 1.6 0"
        cursor="fuse: false; rayOrigin: mouse"
        raycaster="objects: a-image, a-plane, .clickable">
      </a-entity>
    </a-entity>

    <!-- ‡πÇ‡∏ã‡∏ô‡∏™‡πÅ‡∏õ‡∏ß‡πå‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á) -->
    <a-entity id="spawnHost" position="0 1.0 -1.4"></a-entity>
  </a-scene>

  <button id="vrButton">VR</button>

  <script type="module">
    // ===== ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ =====
    var MAP = {
      goodjunk : './modes/goodjunk.safe.js',
      groups   : './modes/groups.safe.js',
      hydration: './modes/hydration.quest.js',
      plate    : './modes/plate.quest.js'
    };

    // ===== HUD binding =====
    var hud = {
      time : document.getElementById('timeBox'),
      score: document.getElementById('scoreBox'),
      quest: document.getElementById('questBox')
    };
    function setText(el, txt){ if(el) el.textContent = txt; }

    window.addEventListener('hha:time', function(e){
      var t = (e && e.detail && e.detail.sec)|0;
      setText(hud.time, '‡πÄ‡∏ß‡∏•‡∏≤: '+t+'s');
    });
    window.addEventListener('hha:score', function(e){
      var s = (e && e.detail && e.detail.score)|0;
      var c = (e && e.detail && e.detail.combo)|0;
      setText(hud.score, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: '+s+' | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x'+c);
      if(!FEVER.active){
        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏à‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö (‡∏ñ‡∏∂‡∏á 10 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏µ‡πÄ‡∏ß‡∏≠‡∏£‡πå)
        var pct = Math.max(0, Math.min(100, Math.round((c/FEVER.comboNeed)*100)));
        FEVER.setBar(pct);
      }
    });
    window.addEventListener('hha:quest', function(e){
      var txt = e && e.detail && e.detail.text || '';
      setText(hud.quest, txt);
    });
    window.addEventListener('hha:end', function(e){
      var d = e && e.detail || {};
      alert('üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏° '+(d.title||'')+'\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: '+(d.score||0)+'\n‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: '+(d.combo||0)+'\n‡∏û‡∏•‡∏≤‡∏î: '+(d.misses||0));
      FEVER.reset();
    });

    // ===== ‡∏£‡∏∞‡∏ö‡∏ö FEVER (‡∏ù‡∏±‡πà‡∏á HUD) =====
    var FEVER = (function(){
      var bar = document.getElementById('feverBar');
      var badge = document.getElementById('feverBadge');
      var flash = document.getElementById('feverFlash');
      var timer = null, leftMs = 0;

      var api = {
        active:false,
        comboNeed:10,
        durationMs:10000,
        setBar: function(pct){
          if(bar){ bar.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
        },
        start: function(ms){
          api.active = true;
          leftMs = (ms|0) || api.durationMs;
          if(badge) badge.style.display = 'inline-block';
          api.setBar(100);
          if(flash){ flash.classList.add('show-flash'); setTimeout(function(){ flash.classList.remove('show-flash'); }, 220); }
          clearInterval(timer);
          timer = setInterval(function(){
            leftMs -= 120;
            if(leftMs <= 0){ api.end(); return; }
            // ‡∏•‡∏î‡πÄ‡∏Å‡∏à‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            var pct = Math.max(0, Math.min(100, Math.round(leftMs / api.durationMs * 100)));
            api.setBar(pct);
          }, 120);
        },
        end: function(){
          api.active = false;
          clearInterval(timer); timer = null; leftMs = 0;
          if(badge) badge.style.display = 'none';
          api.setBar(0);
        },
        reset: function(){ api.end(); api.setBar(0); }
      };
      return api;
    })();

    // ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö Fever
    window.addEventListener('hha:fever', function(e){
      var st = e && e.detail && e.detail.state;
      if(st === 'start'){ FEVER.start((e.detail && e.detail.ms)|0 || 10000); }
      else if(st === 'end'){ FEVER.end(); }
    });

    // ===== ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô =====
    async function loadMode(name){
      var url = MAP[name];
      if(!url){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏´‡∏°‡∏î: '+name); return; }
      try{
        var mod = await import(url + '?v=' + Date.now());
        if(!mod || !mod.boot) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö boot()');
        // reset HUD
        setText(hud.score, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0');
        setText(hud.time,  '‡πÄ‡∏ß‡∏•‡∏≤: 60s');
        setText(hud.quest, 'Mini Quest ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶');
        FEVER.reset();
        // start
        mod.boot({ host: document.getElementById('spawnHost'), duration:60, difficulty:'normal' });
      }catch(err){
        console.error(err); alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err && err.message || err));
      }
    }

    loadMode('goodjunk'); // auto start

    // ‡∏õ‡∏∏‡πà‡∏° VR
    document.getElementById('vrButton').onclick = function(){
      var scene = document.querySelector('a-scene');
      try{ scene && scene.enterVR && scene.enterVR(); }catch(e){}
    };
  </script>
</body>
</html>