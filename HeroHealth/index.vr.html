<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health VR</title>

  <!-- A-Frame + Troika -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/troika-three-text@0.49.0/dist/troika-three-text.umd.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

  <!-- ป้องกัน 404: favicon (data URL) -->
  <link rel="icon" type="image/svg+xml"
        href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%232563eb"/><text x="50%" y="54%" font-size="34" text-anchor="middle" fill="white" font-family="Segoe UI, Arial">VR</text></svg>'/>

  <style>
    :root { color-scheme: light dark; }
    html,body { margin:0; padding:0; height:100%; background:#0b1220; font-family:system-ui, Segoe UI, Inter, Roboto, "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", sans-serif; }
    .game-wrap { position:fixed; inset:0; overflow:hidden; }
    #hudRoot { position:fixed; inset:0; pointer-events:none; z-index:500; }
    .hud-top { position:absolute; left:50%; top:14px; transform:translateX(-50%); display:flex; gap:10px; align-items:flex-start; }
    .score-box { pointer-events:auto; background:#0b1220cc; backdrop-filter:blur(6px); border:1px solid #334155; border-radius:14px; padding:10px 12px; color:#e2e8f0; min-width:180px; display:flex; flex-direction:column; gap:6px; box-shadow:0 12px 30px rgba(0,0,0,.35); }
    .score-row { display:flex; justify-content:space-between; gap:10px; font-weight:800; }
    .score-row .k { color:#93c5fd; }
    .score-row .v { color:#f8fafc; }
    #feverBarDock { margin-top:6px; }
    #spawnHost { position:absolute; inset:0; pointer-events:none; z-index:650; }
    .start-fab { position:absolute; right:16px; bottom:16px; z-index:520; pointer-events:auto; background:#2563eb; color:#fff; border:0; border-radius:999px; padding:12px 16px; font-weight:900; box-shadow:0 10px 30px rgba(0,0,0,.45); cursor:pointer; }
    @media (max-width:640px){ .score-box{ min-width:160px; } }
  </style>
</head>
<body>
  <div class="game-wrap">
    <!-- ===== A-FRAME SCENE =====
         ใช้ renderer แบบสมัยใหม่: ไม่มี legacy lights, เปิด colorManagement,
         เปิด physicallyCorrectLights, ตั้ง toneMapping เป็น ACESFilmic -->
    <a-scene
      renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true; toneMapping:ACESFilmic;"
      background="color: #101826">

      <a-assets></a-assets>

      <!-- Camera -->
      <a-entity position="0 1.6 0">
        <a-camera wasd-controls-enabled="false"></a-camera>
      </a-entity>

      <!-- Lights (สมดุลกับ renderer รุ่นใหม่) -->
      <a-entity light="type:ambient; intensity:0.35; color:#ffffff"></a-entity>
      <a-entity light="type:hemisphere; intensity:0.35; color:#ffffff; groundColor:#222733" position="0 2 0"></a-entity>
      <a-entity id="dirKey" light="type:directional; intensity:0.8; castShadow:false; color:#ffffff" position="1 2 1"></a-entity>

      <!-- Quest Panel -->
      <a-entity id="questPanel" position="0 2 -2" visible="false">
        <a-entity geometry="primitive:plane; width:2.2; height:0.4"
                  material="color:#0b1220; opacity:0.85; side:double"></a-entity>
        <a-entity id="tQ"
          troika-text="value: สุ่มมิชชัน 3 อย่าง / เก็บแต้มให้ถึงเป้า!; color:#E2E8F0; fontSize:0.16; maxWidth:2; anchor:center; baseline:middle;"
          position="0 0 0.02"></a-entity>
      </a-entity>

      <!-- Start Panel -->
      <a-entity id="startPanel" position="0 1.4 -1.6" visible="true">
        <a-entity geometry="primitive:plane; width:1.6; height:0.6"
                  material="color:#0b1220; opacity:0.85; side:double"></a-entity>
        <a-entity id="startLbl"
          troika-text="value: เริ่ม: GOODJUNK; color:#93C5FD; fontSize:0.18; maxWidth:1.4; anchor:center; baseline:top;"
          position="0 0.16 0.02"></a-entity>
        <a-entity id="vrStartBtn" geometry="primitive:plane; width:0.9; height:0.22"
                  material="color:#2563EB" position="0 -0.12 0.02" class="clickable"></a-entity>
        <a-entity troika-text="value: เริ่มเกม; color:#FFFFFF; fontSize:0.12; anchor:center; baseline:middle;"
                  position="0 -0.12 0.03"></a-entity>
      </a-entity>

      <!-- Mode Menu (hub จะ toggle) -->
      <a-entity id="modeMenu" position="-0.9 1.2 -1.6" visible="false">
        <a-entity geometry="primitive:plane; width:1.2; height:0.9" material="color:#0b1220; opacity:0.85"></a-entity>
        <a-entity troika-text="value: โหมดเกม; color:#E2E8F0; fontSize:0.14; anchor:center;" position="0 0.35 0.02"></a-entity>

        <a-entity data-mode="goodjunk" position="0 0.18 0.02" geometry="primitive:plane; width:1.0; height:0.18" material="color:#1E293B" class="clickable"></a-entity>
        <a-entity troika-text="value: Good vs Junk; color:#A5B4FC; fontSize:0.12; anchor:center;" position="0 0.18 0.03"></a-entity>

        <a-entity data-mode="groups" position="0 -0.02 0.02" geometry="primitive:plane; width:1.0; height:0.18" material="color:#1E293B" class="clickable"></a-entity>
        <a-entity troika-text="value: Food Groups; color:#FDE68A; fontSize:0.12; anchor:center;" position="0 -0.02 0.03"></a-entity>

        <a-entity data-mode="hydration" position="0 -0.22 0.02" geometry="primitive:plane; width:1.0; height:0.18" material="color:#1E293B" class="clickable"></a-entity>
        <a-entity troika-text="value: Hydration; color:#93C5FD; fontSize:0.12; anchor:center;" position="0 -0.22 0.03"></a-entity>

        <a-entity data-mode="plate" position="0 -0.42 0.02" geometry="primitive:plane; width:1.0; height:0.18" material="color:#1E293B" class="clickable"></a-entity>
        <a-entity troika-text="value: Balanced Plate; color:#86EFAC; fontSize:0.12; anchor:center;" position="0 -0.42 0.03"></a-entity>
      </a-entity>

      <a-entity id="resultLbl" position="0 1.9 -2" visible="false"
        troika-text="value: จบเกม; color:#F8FAFC; fontSize:0.22; anchor:center;"></a-entity>
    </a-scene>

    <!-- HUD (DOM) -->
    <div id="hudRoot">
      <div id="hudTop" class="hud-top">
        <div class="score-box" data-hud="scorebox">
          <div class="score-row"><span class="k">คะแนน</span><span id="hudScore" class="v">0</span></div>
          <div class="score-row"><span class="k">คอมโบ</span><span id="hudCombo" class="v">0</span></div>
          <div id="feverBarDock"></div>
        </div>
      </div>
    </div>

    <div id="spawnHost"></div>
    <button id="btnStart" class="start-fab">เริ่มเกม</button>
  </div>

  <!-- ให้คลิกปุ่ม VR เรียกปุ่ม DOM -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var vrBtn = document.getElementById('vrStartBtn');
      var domBtn = document.getElementById('btnStart');
      if (vrBtn && domBtn) vrBtn.addEventListener('click', function(e){ try{e.preventDefault();}catch(_){}
        domBtn.click();
      });
    });
  </script>

  <!-- Patch: ปรับ renderer หลัง scene โหลด (r155+ safe) -->
  <script>
    window.addEventListener('load', function(){
      var scene = document.querySelector('a-scene');
      if (!scene) return;
      scene.addEventListener('loaded', function(){
        try {
          var r = scene.renderer;           // THREE.WebGLRenderer
          if (!r) return;
          // ไม่มีการเรียก r.useLegacyLights อีกต่อไป
          r.outputColorSpace   = THREE.SRGBColorSpace;
          r.toneMapping        = THREE.ACESFilmicToneMapping;
          r.toneMappingExposure= 1.0;
          // ตัวเลือกเสริม
          r.physicallyCorrectLights = true;
          // ดึงแหล่งแสงหลักถ้ามีแล้วปรับเล็กน้อย
          var key = scene.querySelector('#dirKey');
          if (key) { try { key.setAttribute('light','intensity',0.8); } catch(_){} }
          console.log('[renderer] modern lighting configured');
        } catch (e) {
          console.warn('[renderer] setup skipped:', e);
        }
      });
    });
  </script>

  <!-- Entrypoint -->
  <script type="module" src="./game/main.js"></script>
</body>
</html>
