<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Hero Health VR</title>

<link rel="icon" href="./favicon.ico" type="image/x-icon"/>

<style>
  :root{
    --bg:#0b1220; --fg:#e6edf7; --chip:#0f172acc; --bd:#334155;
    --ok:#22c55e; --ok2:#86efac; --ok3:#bbf7d0;
    --warn:#f59e0b; --bad:#ef4444; --bar:#0b1222; --accent:#60a5fa; --accent2:#93c5fd;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font:600 16px system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif;}
  /* HUD pills */
  .pill{position:fixed;top:12px;background:var(--chip);border:1px solid var(--bd);
    border-radius:12px;padding:8px 12px;font-weight:800;backdrop-filter:blur(6px);z-index:900}
  #time{left:12px} #score{left:50%;transform:translateX(-50%)} #quest{right:12px;max-width:min(56vw,560px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Bottom progress panel */
  #panel{position:fixed;left:12px;right:12px;bottom:12px;background:#0f172a99;border:1px solid var(--bd);
    border-radius:16px;padding:12px 14px;z-index:880;backdrop-filter:blur(6px)}
  .row{display:flex;justify-content:space-between;gap:10px;font-weight:800}
  .bar{height:14px;background:var(--bar);border:1px solid var(--bd);border-radius:999px;overflow:hidden;margin-top:6px}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .18s ease}
  [data-hha-ui]{pointer-events:none;}
  /* Result panel */
  #resultPanel{position:fixed;inset:0;display:none;place-items:center;background:rgba(5,10,20,.72);backdrop-filter:blur(6px);z-index:1200}
  #card{width:min(640px,92vw);background:linear-gradient(#1b2538,#21304a);border:1px solid #3a4a66;border-radius:16px;padding:18px 20px}
  #stars{font-size:36px;letter-spacing:3px;text-align:center;margin:4px 0 8px}
  #btns{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#0b1222;color:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--ok);color:#052e12;border-color:#16a34a}
  /* Layer สำหรับเป้า (จาก mode-factory) ไม่ต้องสไตล์เพิ่มที่นี่ */
</style>
</head>

<body>
  <!-- HUD -->
  <div id="time"  class="pill">เวลา: --s</div>
  <div id="score" class="pill">คะแนน: 0 | คอมโบ: x0</div>
  <div id="quest" class="pill">Mini Quest — กำลังเริ่ม…</div>

  <!-- Bottom progress (Goal + Mini) -->
  <div id="panel" data-hha-ui>
    <div class="row"><div>เป้า: <span id="goalLbl">—</span></div><div>โหมด: <span id="modeLbl">-</span></div></div>
    <div class="bar"><div id="goalFill" class="fill"></div></div>
    <div style="height:8px"></div>
    <div class="row"><div>Mini Quest — <span id="miniLbl">—</span></div></div>
    <div class="bar"><div id="miniFill" class="fill"></div></div>
  </div>

  <!-- Result -->
  <div id="resultPanel" role="dialog" aria-modal="true" aria-labelledby="rt">
    <div id="card">
      <div id="rt" style="text-align:center;font-weight:900;font-size:20px">สรุปผล</div>
      <div id="stars">☆☆☆☆☆</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;font-weight:800">
        <div>โหมด: <b id="rsMode">-</b></div>
        <div>ระดับ: <b id="rsDiff">-</b></div>
        <div>คะแนน: <b id="rsScore">0</b></div>
        <div>คอมโบสูงสุด: <b id="rsCombo">0</b></div>
        <div>พลาด: <b id="rsMiss">0</b></div>
        <div>Mini Quests: <b id="rsQuests">0/3</b></div>
        <div>ใช้เวลา: <b id="rsTime">0s</b></div>
      </div>
      <div id="btns">
        <button class="btn" id="btnBack">กลับ Hub</button>
        <button class="btn primary" id="btnReplay">เล่นอีกครั้ง</button>
      </div>
    </div>
  </div>

<script type="module">
  const $ = s => document.querySelector(s);
  const ui = {
    time:$('#time'), score:$('#score'), quest:$('#quest'),
    goalLbl:$('#goalLbl'), goalFill:$('#goalFill'),
    miniLbl:$('#miniLbl'), miniFill:$('#miniFill'),
    modeLbl:$('#modeLbl')
  };

  // อ่านพารามิเตอร์
  const q = new URLSearchParams(location.search);
  const mode = (q.get('mode') || 'goodjunk').toLowerCase();
  const difficulty = (q.get('difficulty') || q.get('diff') || 'normal').toLowerCase();
  const dur = Number(q.get('dur') || 60);
  ui.modeLbl.textContent = `${mode} • ${difficulty}`;

  // โหมดไฟล์
  const MODS = {
    goodjunk   : './modes/goodjunk.safe.js',
    hydration  : './modes/hydration.quest.js',
    groups     : './modes/groups.safe.js',
    plate      : './modes/plate.quest.js'
  };

  // ---- HUD Events ----
  window.addEventListener('hha:time', e=>{
    const t = e?.detail?.sec;
    if (typeof t === 'number') ui.time.textContent = 'เวลา: '+t+'s';
  });

  window.addEventListener('hha:score', e=>{
    const d = e?.detail || {};
    ui.score.textContent = `คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
  });

  // อัปเดตแถบ Goal/Mini + ข้อความบนสุด
  window.addEventListener('hha:quest', e=>{
    const d = e?.detail || {};
    if (d.text) ui.quest.textContent = d.text;
    if (d.goal) {
      ui.goalLbl.textContent = d.goal.label || '-';
      const g = Number(d.goal.prog||0), t = Number(d.goal.target||1);
      ui.goalFill.style.width = Math.min(100, t>0 ? (g/t)*100 : 0) + '%';
    }
    if (d.mini) {
      ui.miniLbl.textContent = d.mini.label || '-';
      const g = Number(d.mini.prog||0), t = Number(d.mini.target||1);
      ui.miniFill.style.width = Math.min(100, t>0 ? (g/t)*100 : 0) + '%';
      // แสดงบน pill ด้านบนด้วย (เห็นชัด)
      ui.quest.textContent = `Mini Quest — ${d.mini.label||'-'}`;
    }
  });

  // สรุปตอนจบ
  const stars = n => '★'.repeat(n) + '☆'.repeat(5-n);
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  window.addEventListener('hha:end', e=>{
    const d = e?.detail || {};
    // ประเมินดาวง่าย ๆ จากคะแนน/พลาด/คอมโบ/เควสต์
    const score = +d.score||0, miss=+d.misses||0, combo=+d.comboMax||+d.combo||0;
    const qc = +d.questsCleared||0, qt = +d.questsTotal||3;
    const scoreGoal = {easy:300,normal:500,hard:700}[difficulty] || 500;
    const sNorm = clamp(score/scoreGoal, 0, 1);
    const cNorm = clamp(combo/20, 0, 1);
    const qNorm = clamp(qt? qc/qt : 0, 0, 1);
    const mNorm = clamp(1 - Math.min(1, miss/10), 0, 1);
    const raw = 0.4*sNorm + 0.25*cNorm + 0.2*qNorm + 0.15*mNorm;
    const nStar = clamp(Math.max(1, Math.round(raw*5)), 1, 5);

    // เติมค่า
    $('#rsMode').textContent = (d.mode || mode);
    $('#rsDiff').textContent = difficulty;
    $('#rsScore').textContent = score.toLocaleString();
    $('#rsCombo').textContent = combo;
    $('#rsMiss').textContent  = miss;
    $('#rsQuests').textContent= `${qc}/${qt}`;
    $('#rsTime').textContent  = `${dur}s`;
    $('#stars').textContent   = stars(nStar);

    const panel = $('#resultPanel');
    panel.style.display = 'grid';
    $('#btnBack').onclick = ()=> location.href = './hub.html';
    $('#btnReplay').onclick = ()=> location.reload();
  });

  // ---- Boot mode ----
  (async ()=>{
    try{
      const path = MODS[mode] || MODS.goodjunk;
      const mod  = await import(path + '?v=' + Date.now());
      if (!mod?.boot) throw new Error('ไม่มีฟังก์ชัน boot() ในโหมด');
      await mod.boot({ difficulty, duration: dur });
    }catch(err){
      alert('โหลดโหมดไม่สำเร็จ: ' + (err?.message || err));
      console.error(err);
    }
  })();
</script>
</body>
</html>