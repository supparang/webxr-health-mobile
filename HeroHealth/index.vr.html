<script type="module">
  /* ---------- HUD (เดิม) ---------- */
  (function(){
    const $ = s=>document.querySelector(s);
    window.addEventListener('hha:score', e=>{
      const d=e.detail||{};$('#badgeScore').textContent=`คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
    });
    window.addEventListener('hha:time', e=>{
      const t=Math.max(0,Math.round(e.detail?.sec||0));$('#badgeTime').textContent='เวลา: '+t+'s';
    });
    window.addEventListener('hha:quest', e=>{
      $('#badgeQuest').textContent=e.detail?.text||'Mini Quest';
    });
    window.addEventListener('hha:miss', e=>{
      const el=$('#badgeMiss'); el.style.display='';
      const n=e?.detail?.count ?? (parseInt(el.dataset.n||'0',10)+1);
      el.dataset.n=n; el.textContent='พลาด: '+n+' ครั้ง';
    });
  })();

  /* ---------- Loader (แก้ safeImport ให้รีไรท์พาธ ../vr/ → ./vr/) ---------- */
  const spawnHost = document.getElementById('spawnHost');
  const MAP = {
    goodjunk : './modes/goodjunk.safe.js',
    groups   : './modes/groups.safe.js',
    hydration: './modes/hydration.quest.js',
    plate    : './modes/plate.quest.js'
  };
  const withStamp = u => u + (u.includes('?')?'&':'?') + 'v=' + Date.now();

  async function safeImport(url) {
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    let txt = await res.text();

    // กันกรณี 404/HTML ถูกเสิร์ฟแทน JS
    const ct  = (res.headers.get('content-type')||'').toLowerCase();
    if ((ct.includes('text/html') || txt.trim().startsWith('<')) && !ct.includes('javascript')) {
      throw new Error('Not a JavaScript module (404/HTML?) at ' + url);
    }

    // ✨ รีไรท์พาธ import: "../vr/..." → "./vr/..."
    // รองรับทั้ง `from '...'` และ `from "..."` และ import dynamic แบบธรรมดา
    txt = txt
      .replace(/from\s+(['"])..\/vr\//g, 'from $1./vr/')
      .replace(/import\s*\(\s*(['"])..\/vr\//g, 'import($1./vr/');

    const blob = new Blob([txt], { type:'text/javascript' });
    const blobUrl = URL.createObjectURL(blob);
    try { return await import(blobUrl); }
    finally { setTimeout(()=>URL.revokeObjectURL(blobUrl), 3000); }
  }

  function cleanup(){
    try{ window.dispatchEvent(new Event('hha:dispose-ui')); }catch{}
    document.querySelectorAll('[data-hha-ui]').forEach(n=>n.remove());
    spawnHost.querySelectorAll('a-image,a-entity').forEach(n=>n.remove());
    document.body.classList.remove('fever-on');
    const f=document.getElementById('feverFill'); if(f) f.style.width='0%';
  }

  let current = null;
  document.getElementById('startBtn').addEventListener('click', async ()=>{
    const mode = document.getElementById('modeSel').value;
    const diff = document.getElementById('diffSel').value;

    document.getElementById('badgeScore').textContent='คะแนน: 0 | คอมโบ: x0';
    document.getElementById('badgeTime').textContent='เวลา: ' + (diff==='easy'?90:diff==='hard'?45:60) + 's';
    document.getElementById('badgeQuest').textContent='Mini Quest — กำลังเริ่ม…';
    const missEl=document.getElementById('badgeMiss'); missEl.style.display='none'; missEl.dataset.n='0';

    document.getElementById('menu').style.display='none';
    try{ current?.stop?.(); }catch{}
    cleanup();

    const url = withStamp(MAP[mode]||MAP.goodjunk);
    try{
      const mod = await safeImport(url);
      if(!mod?.boot) throw new Error('โหมดนี้ไม่มี boot()');
      current = await mod.boot({ host:spawnHost, difficulty:diff });
      window.addEventListener('blur',  ()=>current?.pause?.());
      window.addEventListener('focus', ()=>current?.resume?.());
    }catch(err){
      alert('โหลดโหมดไม่สำเร็จ: ' + (err?.message||err));
      console.error(err);
      document.getElementById('menu').style.display='';
    }
  });
</script>