<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HERO HEALTH ACADEMY — VR</title>

  <!-- A-Frame (ให้ THREE พร้อมใช้งานเสมอ) -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>

  <style>
    :root{ --bg:#0e1319; --card:#1c2a3b; --panel:#24364d; --chip:#2a3340; --text:#e9f0f7; --accent:#27c26a; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,'Prompt',sans-serif; }

    /* HUD chips */
    .chip{ position:fixed; top:14px; padding:8px 12px; background:#2a3340d0; border-radius:12px; font-weight:700; font-size:18px; backdrop-filter: blur(6px); }
    #hudTime{ left:14px; }
    #hudScore{ left:50%; transform:translateX(-50%); }
    #hudQuest{ right:14px; }

    /* Center panel (menu) */
    .wrap{ max-width:1200px; margin:0 auto; padding:32px 16px 80px; }
    .panel{ margin:24px auto; padding:28px 24px 36px; background:
            radial-gradient(120% 180% at 50% 0%, #2e4460 0%, #24364d 48%, #21344d 100%);
            border-radius:22px; box-shadow: 0 20px 60px rgba(0,0,0,.35); }
    .panel h1{ margin:0 0 18px; font-size:44px; letter-spacing:.5px; }
    .row{ display:flex; gap:12px; align-items:center; justify-content:center; margin:12px 0; }
    select{ background:#0f1620; color:var(--text); border:1px solid #3a4657; border-radius:10px; padding:8px 10px; font-size:16px; }
    button.start{ background:var(--accent); color:#092612; border:0; padding:12px 20px; border-radius:14px; font-weight:800; cursor:pointer; font-size:18px; box-shadow: 0 8px 24px rgba(39,194,106,.35); }
    button.start:active{ transform: translateY(1px); }

    /* Scene area */
    .scene-wrap{ margin:22px auto 0; width:100%; height:58vh; background:#6aa2ff40; border-radius:16px; display:flex; align-items:center; justify-content:center; }
    .note{ opacity:.75; font-weight:700; }

    /* Status bottom */
    #status{ position:fixed; bottom:14px; left:50%; transform:translateX(-50%); opacity:.7; font-size:16px; }

    /* A-Frame canvas sizing */
    a-scene.embedded{ width:100%; height:100%; }
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="hudTime"  class="chip">เวลา: 60s</div>
  <div id="hudScore" class="chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="hudQuest" class="chip">Mini Quest — เตรียมเริ่ม</div>

  <div class="wrap">
    <div class="panel">
      <h1>เริ่ม: <strong>HERO HEALTH ACADEMY</strong></h1>

      <div class="row">
        <label>เลือกโหมด:&nbsp;
          <select id="modeSel">
            <option value="goodjunk">Good vs Junk</option>
            <option value="groups">Food Groups</option>
            <option value="hydration">Hydration Balance</option>
            <option value="plate">Healthy Plate</option>
          </select>
        </label>
        <label>ระดับความยาก:&nbsp;
          <select id="diffSel">
            <option value="easy">ง่าย</option>
            <option value="normal" selected>ปกติ</option>
            <option value="hard">ยาก</option>
          </select>
        </label>
      </div>

      <div class="row">
        <button id="startBtn" class="start">เริ่มเกม</button>
      </div>

      <!-- Scene viewport -->
      <div class="scene-wrap">
        <!-- A-Frame scene (embedded) -->
        <a-scene id="scene" embedded renderer="antialias: true; colorManagement: true;" vr-mode-ui="enabled: true">
          <a-entity id="cameraRig" position="0 1.6 0">
            <a-entity camera look-controls wasd-controls></a-entity>
          </a-entity>

          <!-- Host สำหรับ spawn เป้า/เอฟเฟกต์ -->
          <a-entity id="spawnHost" position="0 1.2 -1.2"></a-entity>

          <!-- เสียงโค้ช (optional; MiniQuest จะพยายามเรียกใช้ถ้ามี) -->
          <a-entity id="coach_start"  sound="src: #s_coach_start"></a-entity>
          <a-entity id="coach_clear"  sound="src: #s_coach_clear"></a-entity>
          <a-entity id="coach_good"   sound="src: #s_coach_good"></a-entity>
          <a-entity id="coach_warn"   sound="src: #s_coach_warn"></a-entity>
          <a-entity id="coach_fever"  sound="src: #s_coach_fever"></a-entity>
          <a-entity id="coach_quest"  sound="src: #s_coach_quest"></a-entity>

          <!-- minimal assets (สามารถชี้ไฟล์จริงภายหลัง) -->
          <a-assets>
            <audio id="s_coach_start" src="./assets/audio/coach_start_th.mp3"></audio>
            <audio id="s_coach_clear" src="./assets/audio/coach_clear_th.mp3"></audio>
            <audio id="s_coach_good"  src="./assets/audio/pop.mp3"></audio>
            <audio id="s_coach_warn"  src="./assets/audio/boo.mp3"></audio>
            <audio id="s_coach_fever" src="./assets/audio/fever_start.mp3"></audio>
            <audio id="s_coach_quest" src="./assets/audio/star.mp3"></audio>
          </a-assets>
        </a-scene>
      </div>

      <div class="row note"><span>เคล็ดลับ: เลือกโหมด/ระดับ แล้วกด “เริ่มเกม”</span></div>
    </div>
  </div>

  <div id="status">Idle</div>

  <!-- จุดแสดงข้อความ Mini Quest ทีละข้อ (factory จะอัปเดต) -->
  <div id="tQmain" style="position:fixed; right:16px; top:64px; max-width:34vw; text-align:right; opacity:.92;"></div>

  <!-- Booter (ESM) -->
  <script type="module">
    // ป้องกัน double-boot / variable ซ้ำ
    (function(){
      if (window.__HHA_INDEX_BOOTED) return;
      window.__HHA_INDEX_BOOTED = true;
    })();

    // โหลดโหมดเวอร์ชัน production (มี query เดียวกันกัน cache mismatch)
    import { boot as bootGoodJunk } from './modes/goodjunk.safe.js?v=prod';
    import { boot as bootGroups   } from './modes/groups.safe.js?v=prod';
    import { boot as bootHydra    } from './modes/hydration.quest.js?v=prod';
    import { boot as bootPlate    } from './modes/plate.quest.js?v=prod';

    const $ = (s)=>document.querySelector(s);
    const status = (t)=> { const el=$('#status'); if(el) el.textContent=t; };

    // แผนที่โหมด
    const MODE_BOOT = {
      goodjunk: bootGoodJunk,
      groups:   bootGroups,
      hydration:bootHydra,
      plate:    bootPlate
    };

    // อัปเดต HUD เบื้องต้น
    function setHUD({time=60, score=0, combo=0, quest='เตรียมเริ่ม'}={}){
      $('#hudTime') .textContent = `เวลา: ${time}s`;
      $('#hudScore').textContent = `คะแนน: ${score} | คอมโบ: x${combo}`;
      $('#hudQuest').textContent = `Mini Quest — ${quest}`;
    }
    setHUD({});

    // รับ event จากโหมด (factory ยิงออกมา)
    window.addEventListener('hha:score', e=>{
      const { score=0, combo=0 } = e.detail||{};
      const cur = $('#hudTime').textContent.match(/\d+/);
      const time = cur? Number(cur[0]):60;
      setHUD({ time, score, combo, quest: $('#hudQuest').textContent.split('—')[1]?.trim()||'กำลังเล่น' });
    });
    window.addEventListener('hha:end', e=>{
      status(`Finished — score ${e.detail?.score||0}`);
    });

    // ปุ่มเริ่มเกม
    async function startGame(){
      try{ window.__MODE_API?.stop?.(); }catch{}
      window.__MODE_API = null;

      const mode = $('#modeSel')?.value || 'goodjunk';
      const diff = $('#diffSel')?.value || 'normal';

      status(`Loading mode: ${mode} (${diff}) ...`);
      const boot = MODE_BOOT[mode] || bootGoodJunk;

      try{
        const api = await boot({ difficulty: diff });
        window.__MODE_API = api;
        status(`Running (${mode}/${diff})`);
      }catch(err){
        console.error(err);
        alert(`โหลดโหมดไม่สำเร็จ: ${err?.message||err}`);
        status('Error');
      }
    }

    // คลิก/กด Enter เพื่อเริ่ม
    $('#startBtn')?.addEventListener('click', startGame);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); startGame(); }});

    // ถ้ามีพารามิเตอร์ ?autostart=1 จะเริ่มอัตโนมัติ
    try{
      const url = new URL(location.href);
      if (url.searchParams.get('autostart')==='1') startGame();
    }catch{}
  </script>
</body>
</html>