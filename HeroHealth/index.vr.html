<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hero Health VR — Nutrition Hub</title>
<meta name="color-scheme" content="light dark"/>
<style>
  html,body{height:100%;margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
  .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px;z-index:10}
  .fallback strong{color:#9ff}
</style>

<!-- A-Frame / Troika (รองรับไทย) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

<!-- บังคับเรนเดอร์หน้าสุด -->
<script>
AFRAME.registerComponent('front-most', {
  schema:{order:{default:10000}},
  init(){
    const apply=(o)=>{
      o.traverse(n=>{
        if(n.material){
          n.material.depthTest=false;
          n.material.depthWrite=false;
          n.renderOrder=this.data.order;
        }
      });
    };
    if(this.el.object3D) apply(this.el.object3D);
    this.el.addEventListener('object3dset',()=>apply(this.el.object3D));
  }
});
</script>

<!-- Hub -->
<script type="module">
  import { GameHub } from './vr/hub.js?v=thai5';
  window.addEventListener('DOMContentLoaded',()=>{ window.__hub=new GameHub(); });
</script>
</head>
<body>
<div class="fallback" id="bootStatus">
  <div><strong>Status:</strong> Booting…</div>
  <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">
    Force Start
  </button>
</div>

<a-scene background="color:#0b1324" vr-mode-ui="enterVRButton:true"
         renderer="colorManagement:true; physicallyCorrectLights:true">
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
  <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
  <a-sky color="#0b1324"></a-sky>

  <!-- HUD -->
  <a-entity id="hudRoot" position="0 2.18 -2.8">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.30"
              material="color:#111a33; opacity:0.9; depthTest:false; depthWrite:false"></a-entity>
    <a-entity troika-text="value: โหมด: -; color:#9fd; fontSize:0.06;" position="-0.9 0.08 0.05"></a-entity>
    <a-entity troika-text="value: เวลา: 60s; color:#fff; fontSize:0.06;" position="-0.9 -0.02 0.05"></a-entity>
    <a-entity troika-text="value: คะแนน: 0; color:#fff; fontSize:0.06;" position="0.15 0.08 0.05"></a-entity>
    <a-entity troika-text="value: คอมโบ: x1; color:#fff; fontSize:0.06;" position="0.15 -0.02 0.05"></a-entity>
    <a-entity position="0 -0.20 0">
      <a-entity geometry="primitive: plane; width: 1.9; height: 0.08"
                material="color:#1b2752; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
      <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.95 0 0.06"
                material="color:#ff6600; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
      <a-entity troika-text="value: Fever 0%; color:#ffd54f; fontSize:0.06;" position="-0.92 -0.01 0.08"></a-entity>
    </a-entity>
  </a-entity>

  <!-- เมนูหลัก -->
  <a-entity id="modeMenu" position="0 1.35 -1.2" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.05; height: 0.58"
              material="color:#0e1b38; opacity:0.95; transparent:true"></a-entity>

    <a-entity troika-text="value: เลือกโหมดเกม; color:#9fd; fontSize:0.065;"
              position="-0.40 0.23 0.26"></a-entity>

    <a-entity troika-text="value: ดี  vs  ขยะ; color:#fff; fontSize:0.058;"
              position="-0.38 0.07 0.26"></a-entity>
    <a-entity troika-text="value: หมวดอาหาร; color:#fff; fontSize:0.058;"
              position="0.06 0.07 0.26"></a-entity>
    <a-entity troika-text="value: สมดุลน้ำ; color:#fff; fontSize:0.058;"
              position="-0.38 -0.14 0.26"></a-entity>
    <a-entity troika-text="value: จานสุขภาพ; color:#fff; fontSize:0.058;"
              position="0.06 -0.14 0.26"></a-entity>

    <!-- hitboxes โปร่งใส -->
    <a-plane class="clickable" data-mode="goodjunk" position="-0.16 0.07 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"
             onmouseenter="this.setAttribute('opacity',0.06)" onmouseleave="this.setAttribute('opacity',0.001)"></a-plane>

    <a-plane class="clickable" data-mode="groups" position="0.40 0.07 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"
             onmouseenter="this.setAttribute('opacity',0.06)" onmouseleave="this.setAttribute('opacity',0.001)"></a-plane>

    <a-plane class="clickable" data-mode="hydration" position="-0.16 -0.14 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"
             onmouseenter="this.setAttribute('opacity',0.06)" onmouseleave="this.setAttribute('opacity',0.001)"></a-plane>

    <a-plane class="clickable" data-mode="plate" position="0.40 -0.14 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"
             onmouseenter="this.setAttribute('opacity',0.06)" onmouseleave="this.setAttribute('opacity',0.001)"></a-plane>
  </a-entity>

  <!-- ปุ่มเริ่ม -->
  <a-entity id="startPanel" position="0 0.72 -1.15" visible="false" front-most="order:10000">
    <a-plane id="startBtn" class="clickable" position="0 0 0.30"
             width="0.90" height="0.24"
             material="color:#2e8b57; transparent:true; opacity:1.0"></a-plane>
    <a-entity id="startBtnFx" position="0 0 0.31"
              geometry="primitive: plane; width:0.92; height:0.26"
              material="color:#ffffff; opacity:0.0; transparent:true"></a-entity>
    <a-entity id="startLbl" troika-text="value: เลือกโหมดก่อน; color:#fff; fontSize:0.058;"
              position="-0.27 0 0.40"></a-entity>
  </a-entity>

  <!-- กล้อง -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="camera" camera look-controls cursor="rayOrigin: mouse"
              raycaster="objects: .clickable, .target; far: 6">
      <a-entity position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                material="color:#9fd; shader: flat; depthTest:false; depthWrite:false"></a-entity>
    </a-entity>
    <a-entity laser-controls="hand: right"
              raycaster="objects: .clickable, .target; far: 6"></a-entity>
  </a-entity>

  <a-entity id="spawnZone" position="0 1.00 -3.80"></a-entity>
  <a-entity id="fxLayer" position="0 0 0"></a-entity>
</a-scene>

<!-- จับคลิก + Fallback start -->
<script>
function logBoot(msg){
  const box=document.getElementById('bootStatus');
  if(box) box.firstElementChild.innerHTML='<strong>Status:</strong> '+msg;
  console.log('[HVR]',msg);
}

function wireClicks(){
  const hub=()=>window.__hub;

  // เลือกโหมด
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    const mode=btn.getAttribute('data-mode');
    const onPick=()=>{
      if(hub() && typeof hub().selectMode==='function') hub().selectMode(mode);
      const lbl=document.querySelector('#startLbl');
      if(lbl) lbl.setAttribute('troika-text','value','เริ่ม: '+mode.toUpperCase());
      const panel=document.querySelector('#startPanel');
      if(panel) panel.setAttribute('visible',true);
      logBoot('Picked mode: '+mode);
    };
    ['click','mousedown','mouseup','triggerdown'].forEach(ev=>btn.addEventListener(ev,onPick));
  });

  // ปุ่มเริ่ม
  const start=document.querySelector('#startBtn');
  const fx=document.querySelector('#startBtnFx');
  if(start){
    start.addEventListener('mouseenter',()=>fx.setAttribute('material','opacity',0.08));
    start.addEventListener('mouseleave',()=>fx.setAttribute('material','opacity',0.0));
    const tryStart=async ()=>{
      logBoot('Start pressed');
      if(hub()){
        if(typeof hub().startGame==='function'){ hub().startGame(); return; }
        if(typeof hub().start==='function'){ hub().start(); return; }
        if(typeof hub().begin==='function'){ hub().begin(); return; }
      }
      // Fallback: start goodjunk.safe.js ทันที
      try{
        logBoot('Fallback: loading goodjunk.safe.js');
        const mod=await import('./modes/goodjunk.safe.js?v=fallback');
        if(mod && typeof mod.boot==='function'){
          mod.boot({ host: document.getElementById('spawnZone'), duration:60, difficulty:'normal' });
          logBoot('Fallback mode started.');
        }else{
          logBoot('Fallback module has no boot()');
        }
      }catch(e){ console.error(e); logBoot('Fallback failed: '+(e?.message||e)); }
    };
    ['click','mousedown','mouseup','triggerdown'].forEach(ev=>start.addEventListener(ev,tryStart));
  }
}

if(document.readyState!=='loading') setTimeout(wireClicks,0);
else window.addEventListener('DOMContentLoaded',()=>setTimeout(wireClicks,0));
</script>
</body>
</html>
