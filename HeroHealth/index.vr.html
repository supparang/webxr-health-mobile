<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy ‚Äî VR</title>

  <!-- Favicon 16x16 (base64) ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô 404 -->
  <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAUVBMVEUAAAB0dnx2eIA7Q0c/P09NT1BISlJgYmZqa3B1d4Bxc4FOTlB7fYJvb3+HjJN7f4NfYGYsMDVoa3JYZWpTU1VKS0+Sk5g1OT5fYWhyc4F5fYKChI1oam5YZWpLz5d7AAAAD3RSTlMAYM1g7b0gFQeD9Z0rX2n0b3HcAAAAbElEQVQY02WPSQ6DMBADzSBwJm7//7gSVm2d4m0s0bV2Z5e8Vqg3z9d1c0m2iYg3m2e1T0p8r4XQmV5Q2y2qk/2m0w6mC+e3vE1lWk5sK8y0q4p2gk2+F2g1lG9H4o9kWJkQqf2r0zE0s0j4w7k8oQx8D0Y7f0L1ZQ3vJ9JzJ9i8t7gGf0Qh7gB2QmY2wCkq7o3wAAAABJRU5ErkJggg==" />

  <!-- Preconnect ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Twemoji (fallback emoji) -->
  <link rel="preconnect" href="https://twemoji.maxcdn.com" crossorigin>

  <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå local ‡πÅ‡∏•‡∏∞ fallback ‡πÑ‡∏õ CDN ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -->
  <script>
    function loadScriptFallback(src, cdn){
      return new Promise(function(resolve){
        var s=document.createElement('script');
        s.src=src; s.onload=resolve; s.onerror=function(){
          var c=document.createElement('script'); c.src=cdn; c.onload=resolve; document.head.appendChild(c);
        }; document.head.appendChild(s);
      });
    }
  </script>
  <script>
    // ‡πÇ‡∏´‡∏•‡∏î A-Frame
    loadScriptFallback(
      "./vendor/aframe-1.5.0.min.js",
      "https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"
    );
  </script>
  <script>
    // ‡πÇ‡∏´‡∏•‡∏î troika-text
    loadScriptFallback(
      "./vendor/aframe-troika-text-0.12.0.min.js",
      "https://unpkg.com/aframe-troika-text@0.12.0/dist/aframe-troika-text.min.js"
    );
  </script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --danger:#ef4444; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}

    /* Fever bar */
    #feverWrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:900;
      width:min(540px,86vw);height:12px;background:#0f172a;border:1px solid #334155;border-radius:999px;overflow:hidden}
    #feverFill{height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0);transition:width .15s ease-out}
    .fever-on{ box-shadow: inset 0 0 0 4px #ffd16655; animation:feverPulse .9s ease-in-out infinite alternate; }
    @keyframes feverPulse{ from{ filter:none } to{ filter: drop-shadow(0 0 12px #ffd166) } }

    /* ‡πÄ‡∏°‡∏ô‡∏π */
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);width:min(1080px,86vw);
      padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
  <div id="badgeScore" class="hud-chip">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest ‚Äî ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
  <div id="badgeMiss"  class="hud-chip">‡∏û‡∏•‡∏≤‡∏î: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>

  <!-- Fever bar -->
  <div id="feverWrap"><div id="feverFill"></div></div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) -->
  <div id="menu" class="menu-wrap">
    <h1>‡πÄ‡∏£‡∏¥‡πà‡∏°: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î:</label>
        <select id="modeSel">
          <option value="goodjunk" selected>Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
        <select id="diffSel">
          <option value="easy">‡∏á‡πà‡∏≤‡∏¢</option>
          <option value="normal" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="hard">‡∏¢‡∏≤‡∏Å</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      </div>
    </div>
  </div>

  <!-- A-Frame scene -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>
    <a-entity id="cam" camera look-controls
              cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects: .clickable; far: 6"
              position="0 1.6 0"></a-entity>
    <!-- ‡∏ß‡∏≤‡∏á‡πÇ‡∏ã‡∏ô‡∏™‡∏õ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡πÜ -->
    <a-entity id="spawnHost" position="0 1.0 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <!-- ===== Emoji Sprite Module: ‡∏ù‡∏±‡∏á + ‡∏™‡∏£‡πâ‡∏≤‡∏á import map ‡πÄ‡∏õ‡πá‡∏ô ./vr/emoji-sprite.js ===== -->
  <script type="module">
    const code = `
      const POOLS = {
        GOOD:['üçé','üçì','üçá','ü•¶','ü•ï','üçÖ','ü•¨','üçä','üçå','ü´ê','üçê','üçç','üçã','üçâ','ü•ù','üçö','ü•õ','üçû','üêü','ü•ó'],
        JUNK:['üçî','üçü','üçï','üç©','üç™','üßÅ','ü•§','üßã','ü•ì','üç´','üå≠'],
        STAR:['‚≠ê'], DIAMOND:['üíé'], SHIELD:['üõ°Ô∏è']
      };
      const _cache = new Map();
      function _emojiWithVS16(s){ return /\\uFE0F$/.test(s)?s:s+'\\uFE0F'; }
      function _setEmojiFont(ctx, px){
        ctx.font = \`\${px}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji",system-ui,sans-serif\`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      }
      function twemojiUrl(emoji){
        const cps = Array.from(emoji).map(c=>c.codePointAt(0).toString(16)).join('-');
        return \`https://twemoji.maxcdn.com/v/latest/72x72/\${cps}.png\`;
      }
      function _canvasForEmoji(char, px=96, fx={glow:true, shadow:true}){
        const key = \`\${char}@\${px}@\${fx.glow?'g':'-'}@\${fx.shadow?'s':'-'}\`;
        if (_cache.has(key)) return _cache.get(key);
        const pad = Math.floor(px*0.45), W = px + pad*2, H = px + pad*2;
        const cv = document.createElement('canvas'); cv.width=W; cv.height=H;
        const ctx = cv.getContext('2d');
        const ch = _emojiWithVS16(char);
        _setEmojiFont(ctx, px);
        if (fx.glow){ ctx.save(); ctx.shadowColor='rgba(255,255,255,.55)'; ctx.shadowBlur=px*.25; ctx.fillText(ch,W/2,H/2); ctx.restore(); }
        if (fx.shadow){ ctx.save(); ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=px*.18; ctx.shadowOffsetX=px*.04; ctx.shadowOffsetY=px*.06; ctx.fillText(ch,W/2,H/2); ctx.restore(); }
        ctx.fillText(ch,W/2,H/2);
        const ok = ctx.getImageData(W>>1,H>>1,1,1).data[3]>0;
        let tex;
        if(!ok){ tex = {src:twemojiUrl(char),w:72,h:72,external:true}; }
        else   { tex = {src:cv.toDataURL('image/png'),w:W,h:H,external:false}; }
        _cache.set(key,tex); return tex;
      }
      function _makeImageEntity(tex,scale=0.6){
        const el = document.createElement('a-image');
        el.setAttribute('src',tex.src);
        el.setAttribute('crossorigin','anonymous');
        el.setAttribute('material', tex.external ? 'side:double' : 'transparent:true;alphaTest:0.01;side:double');
        el.setAttribute('scale',\`\${scale} \${scale} \${scale}\`);
        el.setAttribute('animation__pop',{
          property:'scale', from:\`\${scale*0.7} \${scale*0.7} \${scale*0.7}\`,
          to:\`\${scale} \${scale} \${scale}\`, dur:140, easing:'easeOutCubic', startEvents:'spawned'
        });
        setTimeout(()=>el.emit('spawned'),0);
        return el;
      }
      export const Emoji = {
        create({type='GOOD',char=null,size=96,scale=0.6,glow=true,shadow=true}={}){
          const pool=POOLS[type]||POOLS.GOOD;
          const symbol=char||pool[(Math.random()*pool.length)|0];
          const tex=_canvasForEmoji(symbol,size,{glow,shadow});
          const el=_makeImageEntity(tex,scale);
          el.dataset.emoji=symbol; el.dataset.type=type;
          return el;
        },
        fromChar(char,{size=96,scale=0.6,glow=true,shadow=true}={}){
          const tex=_canvasForEmoji(char,size,{glow,shadow});
          return _makeImageEntity(tex,scale);
        }
      };
      export default Emoji;
      // global helper (optional)
      window.EmojiSprite = { Emoji };
    `;
    const blob = new Blob([code], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);

    // import map -> ./vr/emoji-sprite.js
    const im = document.createElement('script');
    im.type = 'importmap';
    im.textContent = JSON.stringify({ imports: { './vr/emoji-sprite.js': url }});
    document.currentScript.after(im);
  </script>
  <!-- ===== /Emoji Sprite Module ===== -->

  <script>
    // ‡∏Å‡∏±‡∏ô‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (mobile)
    document.addEventListener('touchmove',function(e){
      if(!e.target.closest('.menu-wrap')) e.preventDefault();
    },{passive:false});

    // HUD listeners (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    (function(){
      const $=s=>document.querySelector(s);
      window.addEventListener('hha:score', e=>{
        const d=e?.detail||{}; $('#badgeScore').textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${d.score||0} | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${d.combo||0}`;
      });
      window.addEventListener('hha:time', e=>{
        const t=Math.max(0,Math.round(e?.detail?.sec||0)); $('#badgeTime').textContent=`‡πÄ‡∏ß‡∏•‡∏≤: ${t}s`;
      });
      window.addEventListener('hha:quest', e=>{
        $('#badgeQuest').textContent=e?.detail?.text||'Mini Quest';
      });
      window.addEventListener('hha:miss', e=>{
        const el=$('#badgeMiss'); el.style.display='';
        const n=(e?.detail?.count!=null)?e.detail.count:(parseInt(el.dataset.n||'0',10)+1);
        el.dataset.n=n; el.textContent=`‡∏û‡∏•‡∏≤‡∏î: ${n} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
      });
      // Fever gauge
      const fill=document.getElementById('feverFill');
      window.addEventListener('hha:fever', e=>{
        const d=e?.detail||{}; const state=d.state||'change'; const lv=d.level??0;
        const pct=Math.max(0,Math.min(100,Math.round(lv)));
        if(state==='start'){ document.body.classList.add('fever-on'); fill.style.background='linear-gradient(90deg,#ffb703,#fb5607)'; fill.style.width='100%'; }
        else if(state==='end'){ document.body.classList.remove('fever-on'); fill.style.background='linear-gradient(90deg,#37d67a,#06d6a0)'; fill.style.width='0%'; }
        else { fill.style.width=pct+'%'; }
      });
    })();

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°: ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ import './vr/emoji-sprite.js' ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
    (function(){
      const $=s=>document.querySelector(s);
      function withStamp(u){ return u+(u.includes('?')?'&':'?')+'v='+Date.now(); }
      const MAP={
        goodjunk : './modes/goodjunk.safe.js',
        groups   : './modes/groups.safe.js',
        hydration: './modes/hydration.quest.js',
        plate    : './modes/plate.quest.js'
      };
      $('#startBtn').addEventListener('click', async ()=>{
        const mode = $('#modeSel').value;
        const diff = $('#diffSel').value;
        $('#menu').style.display='none';
        document.getElementById('feverFill').style.width='0%';
        try{
          const mod = await import(withStamp(MAP[mode]||MAP.goodjunk));
          if(!mod?.boot) throw new Error('‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ boot()');
          await mod.boot({ host: document.getElementById('spawnHost'), difficulty: diff, duration: 60 });
        }catch(err){
          alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err?.message||err));
          console.error(err); $('#menu').style.display='';
        }
      });
    })();
  </script>
</body>
</html>
