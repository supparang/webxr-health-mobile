<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Hero Health (VR-lite)</title>
<style>
  :root{--bg:#0b1220;--card:#111827e6;--line:#334155;--ink:#e6edf7;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial;}
  .hud{position:fixed;left:0;right:0;top:0;display:flex;gap:10px;justify-content:space-between;padding:14px;}
  .pill{background:#0f172acc;border:1px solid var(--line);padding:10px 14px;border-radius:14px;font-weight:800;}
  #goalPanel{position:fixed;left:10px;right:10px;bottom:64px;background:#0f172ab3;border:1px solid var(--line);border-radius:16px;padding:12px;}
  .bar{height:12px;background:#0b1222;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#93c5fd)}
  #waterWrap{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;width:min(560px,92vw);z-index:5;
             background:#0f172acc;border:1px solid var(--line);border-radius:14px;padding:12px 14px;font-weight:800;display:none}
</style>
</head>
<body>

<div class="hud">
  <div id="time"  class="pill">เวลา: 60s</div>
  <div id="score" class="pill">คะแนน: 0 | คอมโบ: x0</div>
  <div id="quest" class="pill">Mini Quest — กำลังเริ่ม…</div>
</div>

<!-- แผง Goal + Mini Quest (แสดงทีละใบ) -->
<div id="goalPanel" aria-live="polite">
  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
    <div id="goalTitle" style="font-weight:900">เป้า: —</div>
    <div id="modeBadge" style="opacity:.8"></div>
  </div>
  <div class="bar" style="margin-top:8px"><div id="goalFill" class="fill"></div></div>
  <div id="miniOne" style="margin-top:10px;font-weight:800">Quest 1/3 — …</div>
  <div class="bar" style="margin-top:6px"><div id="miniFill" class="fill" style="background:linear-gradient(90deg,#60a5fa,#a78bfa)"></div></div>
</div>

<!-- Water Gauge (เฉพาะ Hydration) -->
<div id="waterWrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
    <span>Water</span><span id="waterLbl">Balanced</span>
  </div>
  <div class="bar"><div id="waterFill" class="fill" style="background:linear-gradient(90deg,#22c55e,#93c5fd)"></div></div>
</div>

<script type="module">
  // ===== Helper: รับโหมดจาก query =====
  const Q = new URLSearchParams(location.search);
  const mode = (Q.get('mode')||'goodjunk').toLowerCase();
  const diff = (Q.get('difficulty')||'normal').toLowerCase();
  const duration = Number(Q.get('dur')||60);
  const v = '20251107g'; // cache-buster

  // ===== HUD refs =====
  const elTime   = document.getElementById('time');
  const elScore  = document.getElementById('score');
  const elQuest  = document.getElementById('quest');
  const elGoalT  = document.getElementById('goalTitle');
  const elGoalF  = document.getElementById('goalFill');
  const elMini1  = document.getElementById('miniOne');
  const elMiniF  = document.getElementById('miniFill');
  const elMode   = document.getElementById('modeBadge');
  const wWrap    = document.getElementById('waterWrap');
  const wFill    = document.getElementById('waterFill');
  const wLbl     = document.getElementById('waterLbl');

  elMode.textContent = `โหมด: ${diff}`;

  // ===== Event wiring from modes =====
  window.addEventListener('hha:time', e=>{
    const s = (e.detail?.sec ?? duration);
    elTime.textContent = `เวลา: ${s}s`;
  });

  window.addEventListener('hha:score', e=>{
    const d = e.detail||{};
    elScore.textContent = `คะแนน: ${d.score ?? 0} | คอมโบ: x${d.combo ?? 0}`;
  });

  // goal
  window.addEventListener('hha:goal', e=>{
    const d = e.detail||{};
    elGoalT.textContent = d.label || 'เป้า: —';
    const pct = Math.max(0, Math.min(100, Math.round((d.progress||0)/(d.target||1)*100)));
    elGoalF.style.width = pct+'%';
  });

  // quest (ตัวเดียวต่อครั้ง)
  window.addEventListener('hha:quest', e=>{
    const d = e.detail||{};
    if(d.text) elQuest.textContent = d.text;
    if(d.label) elMini1.textContent = d.label;
    if(d.prog!=null && d.target){
      const pct = Math.max(0, Math.min(100, Math.round(d.prog/d.target*100)));
      elMiniF.style.width = pct+'%';
    }
  });

  // hydration UI
  window.addEventListener('hha:water-ui', e=>{
    wWrap.style.display = e.detail?.show ? 'block' : 'none';
  });
  window.addEventListener('hha:water', e=>{
    const v = Math.max(0, Math.min(100, Math.round(e.detail?.val||0)));
    wFill.style.width = v+'%';
    let zone='Low';
    if(v>=40&&v<=70) zone='Balanced'; else if(v>70) zone='High';
    wLbl.textContent = zone;
    wFill.style.background = (zone==='Balanced')
      ? 'linear-gradient(90deg,#22c55e,#93c5fd)'
      : (zone==='High' ? 'linear-gradient(90deg,#06d6a0,#37d67a)'
                       : 'linear-gradient(90deg,#f59e0b,#ef4444)');
  });

  // สรุปท้ายเกม (จากแต่ละโหมด)
  window.addEventListener('hha:quest-summary', e=>{
    const d = e.detail||{};
    const txt =
`สรุปโหมด: ${d.mode}
คะแนนรวม: ${d.score}
คอมโบสูงสุด: ${d.combo}
Goal: ${d.goalDone?'✔️ สำเร็จ':'❌ ไม่สำเร็จ'}
Mini Quest: ${d.questsCleared}/${d.questsTotal}`;
    alert(txt);
  });

  // ===== โหลดโหมด =====
  try{
    const mod = await import(`./modes/${mode}.safe.js?v=${v}`);
    if(!mod || typeof mod.boot!=='function') throw new Error('mod.boot is not a function');
    await mod.boot({difficulty:diff, duration});
  }catch(err){
    alert('โหลดโหมดไม่สำเร็จ: '+ err.message);
    console.error(err);
  }
</script>
</body>
</html>