<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health VR</title>
  <meta name="color-scheme" content="light dark"/>
  <!-- A-Frame + Troika Text -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
  <style>
    html,body{margin:0;padding:0;background:#0b1324;}
  </style>
</head>
<body>
  <a-scene renderer="antialias:true" background="color: #0b1324">
    <!-- RIG + CAMERA (รองรับ mouse/VR controller) -->
    <a-entity id="rig">
      <a-entity id="cam" camera look-controls
        cursor="rayOrigin: mouse; fuse: false"
        raycaster="objects: .hit; far: 6; interval: 0; lineColor: #0ff; lineOpacity: 0.18">
      </a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
      <a-entity laser-controls="hand: left"></a-entity>
    </a-entity>

    <!-- Crosshair ให้เล็งง่าย -->
    <a-entity position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.008"
              material="color: #7ff; shader: flat; opacity: 0.9"></a-entity>

    <!-- Sky (Fever จะสลับสี) -->
    <a-sky color="#0b1324"></a-sky>

    <!-- โซนวางเป้า/สปอน -->
    <a-entity id="spawnZone" position="0 0 0"></a-entity>

    <!-- ===== HUD Top ===== -->
    <a-entity id="hudRoot" position="0 1.95 -1.6">
      <a-entity troika-text="value: โหมด: -; color: #aef; fontSize: 0.06; anchor: left;"></a-entity>
      <a-entity position="0 -0.08 0" troika-text="value: เวลา: 60s; color: #aef; fontSize: 0.05; anchor: left;"></a-entity>
      <a-entity position="0.95 0 0" troika-text="value: คะแนน: 0; color: #fff; fontSize: 0.06; anchor: right;"></a-entity>
      <a-entity position="0.95 -0.08 0" troika-text="value: คอมโบ: x0; color: #fff; fontSize: 0.05; anchor: right;"></a-entity>

      <!-- Fever bar -->
      <a-entity id="feverBarWrap" position="0 -0.19 0">
        <a-plane width="1.9" height="0.035" color="#223a5c"></a-plane>
        <a-plane id="feverBar" position="-0.95 0 0.001" width="0" height="0.035" color="#ffb300" anchor="left"></a-plane>
        <a-entity id="feverLabel" position="-0.95 0.03 0" troika-text="value: Fever 0%; color: #ffb300; fontSize: 0.04; anchor: left;"></a-entity>
      </a-entity>
    </a-entity>

    <!-- ===== Quest Panel ===== -->
    <a-entity id="questPanel" position="0 1.45 -1.5" visible="false">
      <a-plane width="1.9" height="0.8" color="#0e1a2b" opacity="0.85"></a-plane>
      <a-entity position="-0.9 0.32 0.01" troika-text="value: Mini Quests; color:#fff; fontSize:0.07; anchor:left;"></a-entity>
      <a-entity id="tQ1" position="-0.9 0.18 0.01" troika-text="value: ; color:#eaeaea; fontSize:0.055; anchor:left;"></a-entity>
      <a-entity id="tQ2" position="-0.9 0.06 0.01" troika-text="value: ; color:#eaeaea; fontSize:0.055; anchor:left;"></a-entity>
      <a-entity id="tQ3" position="-0.9 -0.06 0.01" troika-text="value: ; color:#eaeaea; fontSize:0.055; anchor:left;"></a-entity>
    </a-entity>

    <!-- ===== ป้ายเป้าหมายเฉพาะบางโหมด (groups/plate/hydration) ===== -->
    <a-entity id="hudTarget" position="0 1.72 -1.6" troika-text="value: ; color:#8be9fd; fontSize:0.06; anchor:center;"></a-entity>
    <a-entity id="hydrationLabel" position="0 1.62 -1.6" troika-text="value: ; color:#a3ffac; fontSize:0.05; anchor:center;"></a-entity>

    <!-- ===== Start Panel ===== -->
    <a-entity id="startPanel" position="0 1.15 -1.2" visible="true">
      <a-plane width="1.6" height="0.7" color="#102033" opacity="0.92"></a-plane>
      <a-entity id="startLbl" position="0 0.18 0.01" troika-text="value: เริ่ม: -; color:#fff; fontSize:0.08; anchor:center;"></a-entity>
      <a-entity position="0 0.02 0.01" troika-text="value: เลือกโหมดด้วยพารามิเตอร์ ?mode=goodjunk|groups|hydration|plate; color:#bcd; fontSize:0.045; anchor:center;"></a-entity>

      <!-- ปุ่มเริ่ม -->
      <a-plane id="btnStart" class="hit" position="0 -0.18 0.02" width="0.9" height="0.18" color="#1b7f5a"></a-plane>
      <a-entity position="0 -0.18 0.03" troika-text="value: เริ่มเกม; color:#fff; fontSize:0.065; anchor:center;"></a-entity>
    </a-entity>

    <!-- ===== Boot status (มุมล่างซ้าย) ===== -->
    <a-entity id="bootStatus" position="-0.85 0.15 -1.0">
      <a-entity troika-text="value: Status: Preparing...; color:#fff; fontSize:0.055; anchor:left;"></a-entity>
    </a-entity>

  </a-scene>

  <script type="module">
    // -------- Utils --------
    function getParam(name, def=null){
      try { return (new URL(location.href)).searchParams.get(name) ?? def; } catch { return def; }
    }
    const mode = (getParam('mode','goodjunk')||'').toLowerCase();
    const diff = (getParam('diff','normal')||'normal').toLowerCase();
    const secs = parseInt(getParam('time','60')||'60',10) || 60;

    const MODULES = {
      goodjunk: './modes/goodjunk.safe.js',
      groups:   './modes/groups.safe.js',
      hydration:'./modes/hydration.safe.js',
      plate:    './modes/plate.safe.js'
    };
    const url = MODULES[mode] || MODULES.goodjunk;

    // HUD labels
    const hud = {
      mode: document.querySelector('#hudRoot a-entity[troika-text]'),
      time: document.querySelector('#hudRoot a-entity[position="0 -0.08 0"]'),
      score: document.querySelector('#hudRoot a-entity[position="0.95 0 0"]'),
      combo: document.querySelector('#hudRoot a-entity[position="0.95 -0.08 0"]'),
      startLbl: document.getElementById('startLbl')
    };
    if (hud.mode)   hud.mode.setAttribute('troika-text', 'value', `โหมด: ${mode} (ระดับ:${diff})`);
    if (hud.time)   hud.time.setAttribute('troika-text', 'value', `เวลา: ${secs}s`);
    if (hud.score)  hud.score.setAttribute('troika-text', 'value', `คะแนน: 0`);
    if (hud.combo)  hud.combo.setAttribute('troika-text', 'value', `คอมโบ: x0`);
    if (hud.startLbl) hud.startLbl.setAttribute('troika-text','value', `เริ่ม: ${mode.toUpperCase()}`);

    const startPanel = document.getElementById('startPanel');
    const questPanel = document.getElementById('questPanel');
    const bootBox    = document.querySelector('#bootStatus a-entity[troika-text]');
    const spawnHost  = document.getElementById('spawnZone');

    function setBoot(msg){
      try { bootBox.setAttribute('troika-text','value', `Status: ${msg}`); } catch {}
    }
    setBoot('Hub ready');

    async function startGame(){
      try{
        setBoot('Loading mode…');
        const mod = await import(url + '?v=' + Date.now());
        if (typeof mod.boot !== 'function') throw new Error('Mode has no boot()');
        if (startPanel) startPanel.setAttribute('visible', false);
        if (questPanel) questPanel.setAttribute('visible', true);
        await mod.boot({ host: spawnHost, duration: secs, difficulty: diff, goal: (mode==='plate'?20:40) });
        setBoot('Running');
      }catch(e){
        console.error('[VR] load mode failed:', e);
        setBoot('Load failed, check console');
      }
    }

    // ปุ่มเริ่ม (รองรับ mouse/touch/VR)
    const btnStart = document.getElementById('btnStart');
    const bindOnce = (el, ev, fn, opt)=>{ const h=(e)=>{el.removeEventListener(ev,h,opt); fn(e);} ; el.addEventListener(ev,h,opt); };
    if (btnStart){
      bindOnce(btnStart, 'click',      startGame);
      bindOnce(btnStart, 'mousedown',  startGame);
      bindOnce(btnStart, 'touchstart', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
      btnStart.classList.add('hit');
    }

    // อัปเดตคะแนน/คอมโบจากโหมด (รับอีเวนต์)
    window.addEventListener('hha:score', (e)=>{
      const {score=0, combo=0} = e.detail||{};
      if (hud.score) hud.score.setAttribute('troika-text','value', `คะแนน: ${score}`);
      if (hud.combo) hud.combo.setAttribute('troika-text','value', `คอมโบ: x${combo}`);
    });

    // อัปเดต Fever bar (ถ้าโหมดส่งอีเวนต์)
    const feverBar = document.getElementById('feverBar');
    const feverLabel = document.getElementById('feverLabel');
    window.addEventListener('hha:feverLevel', (e)=>{
      const lv = Math.max(0, Math.min(100, (e.detail?.level||0)));
      const w  = 1.9 * (lv/100);
      if (feverBar){
        feverBar.setAttribute('width', w);
        feverBar.setAttribute('position', `${-0.95 + (w/2)} 0 0.001`);
      }
      if (feverLabel){
        feverLabel.setAttribute('troika-text','value', `Fever ${lv}%`);
      }
    });

    // จบเกม
    window.addEventListener('hha:end', (e)=>{
      setBoot('Finished');
      if (startPanel) startPanel.setAttribute('visible', true);
      if (questPanel) questPanel.setAttribute('visible', true);
    });
  </script>
</body>
</html>
