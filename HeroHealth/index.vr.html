<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy ‚Äî VR</title>

  <!-- A-Frame ‡∏Å‡πà‡∏≠‡∏ô, ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô Troika -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text@0.12.0/dist/aframe-troika-text.min.js"></script>

  <!-- favicon ‡∏Å‡∏±‡∏ô 404 -->
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <rect width="64" height="64" rx="12" fill="#0b1324"/>
    <text x="50%" y="54%" font-size="44" text-anchor="middle">üçé</text>
  </svg>'>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --danger:#ef4444; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}
    #logChip{left:12px;bottom:12px}
    .fever-on{box-shadow:inset 0 0 0 4px #ffd16655;animation:feverPulse .9s ease-in-out infinite alternate;}
    @keyframes feverPulse{from{filter:none}to{filter:drop-shadow(0 0 12px #ffd166)}}
    .a-enter-vr,.a-enter-vr-button{position:absolute !important;right:12px !important;
      bottom:12px !important;z-index:1000 !important}
    #vrBtn{position:fixed;right:14px;bottom:14px;z-index:999;background:#ffffff12;border:1px solid #4a5568;
      color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
    .xr-supported #vrBtn{display:none}
  </style>
</head>

<body>
  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
  <div id="badgeScore" class="hud-chip">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest ‚Äî ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
  <div id="badgeMiss"  class="hud-chip">‡∏û‡∏•‡∏≤‡∏î: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
  <div id="logChip"    class="hud-chip">log: --</div>

  <!-- Scene -->
  <a-scene id="scene" background="color:#0b1324">
    <a-assets></a-assets>
    <a-entity id="cam" camera look-controls cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects:.clickable; far:6" position="0 1.6 0"></a-entity>
    <a-entity id="spawnHost" position="0 1.6 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ ES module ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ import() ‡∏ô‡∏¥‡πâ‡∏á) -->
  <script type="module">
    const $  = (s)=>document.querySelector(s);
    const log = (m)=>{ $('#logChip').textContent = 'log: ' + m; console.log('[VR]', m); };

    // ‡∏î‡∏±‡∏Å error ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢
    window.addEventListener('error', (e)=>{ log('error: '+ (e?.message||e)); });
    window.addEventListener('unhandledrejection', (e)=>{ log('promise: '+ (e?.reason?.message||e?.reason||e)); });

    const MODE_URL = './modes/goodjunk.safe.js';
    const withStamp = (u)=> u + (u.includes('?')?'&':'?') + 'v=' + Date.now();

    // HUD event bus
    window.addEventListener('hha:score', (e)=>{
      const d=e.detail||{}; $('#badgeScore').textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${d.score||0} | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${d.combo||0}`;
    });
    window.addEventListener('hha:time', (e)=>{
      const t=Math.max(0, Math.round((e.detail&&e.detail.sec)||0));
      $('#badgeTime').textContent=`‡πÄ‡∏ß‡∏•‡∏≤: ${t}s`;
    });
    window.addEventListener('hha:quest', (e)=>{
      $('#badgeQuest').textContent=(e.detail&&e.detail.text)||'Mini Quest';
    });
    window.addEventListener('hha:miss', (e)=>{
      const el=$('#badgeMiss'); el.style.display='';
      const n=(e.detail&&e.detail.count!=null)?e.detail.count:(parseInt(el.dataset.n||'0',10)+1);
      el.dataset.n=n; el.textContent='‡∏û‡∏•‡∏≤‡∏î: '+n+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
    });
    window.addEventListener('hha:fever', (e)=>{
      const st=(e.detail&&e.detail.state)||'end';
      if(st==='start') document.body.classList.add('fever-on'); else document.body.classList.remove('fever-on');
    });

    // ‡∏õ‡∏∏‡πà‡∏° VR ‡∏™‡∏≥‡∏£‡∏≠‡∏á
    (function(){
      const b=document.createElement('button'); b.id='vrBtn'; b.textContent='VR';
      document.body.appendChild(b);
      const sc=$('#scene');
      b.addEventListener('click', ()=>{ try{ sc && sc.enterVR && sc.enterVR(); }catch(e){} });
    })();

    // ‡∏£‡∏≠ scene ‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏°‡∏µ timeout ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á)
    function waitSceneLoaded(sceneEl, timeoutMs=1500){
      return new Promise((resolve)=>{
        if (sceneEl && sceneEl.hasLoaded) return resolve();
        let done=false;
        const t=setTimeout(()=>{ if(!done){ done=true; resolve(); }}, timeoutMs);
        sceneEl.addEventListener('loaded', ()=>{ if(!done){ done=true; clearTimeout(t); resolve(); } }, {once:true});
      });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
    async function start(){
      const sceneEl = $('#scene');
      await waitSceneLoaded(sceneEl);
      log('scene ready');

      // ensure spawnHost ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
      let host = $('#spawnHost');
      if(!host){
        host = document.createElement('a-entity');
        host.id = 'spawnHost';
        host.setAttribute('position', '0 1.6 -1.6');
        sceneEl.appendChild(host);
        log('spawnHost created');
      } else {
        host.setAttribute('position', '0 1.6 -1.6');
      }

      try{
        log('import goodjunk‚Ä¶');
        const mod = await import(withStamp(MODE_URL));
        if(!mod || typeof mod.boot!=='function') throw new Error('boot() not found');
        await mod.boot({ host, difficulty:'normal', duration:60 });
        log('goodjunk running');
      }catch(err){
        log('load fail: '+(err?.message||err));
        alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err?.message||err));
        console.error(err);
      }
    }

    // DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ start (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start, {once:true});
    } else {
      start();
    }
  </script>
</body>
</html>
