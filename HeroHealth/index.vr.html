<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health Academy VR</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-troika-text@0.9.1/dist/aframe-troika-text.min.js"></script>
  <style>
    :root{--bg:#0b0d14;--fg:#e5e7eb;--muted:#9aa4b2;--accent:#22c55e;}
    html,body{height:100%} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Roboto,'Prompt',sans-serif}
    /* ===== Overlay HUD ===== */
    #overlay{position:fixed;inset:0;pointer-events:none}
    #hudBar{position:absolute;left:24px;right:24px;top:14px;display:flex;gap:16px;align-items:center;justify-content:space-between}
    .hudBox{backdrop-filter:blur(6px);background:rgba(15,23,42,.35);border:1px solid rgba(255,255,255,.08);
            color:var(--fg);border-radius:12px;padding:10px 14px;font-size:16px;line-height:1}
    #feverBanner{position:absolute;left:50%;top:66px;transform:translateX(-50%);
                 background:#b91c1c;color:#fff;border-radius:12px;padding:8px 14px;display:none}
    /* ===== Menu ===== */
    #menu{position:absolute;inset:0;display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;pointer-events:auto}
    h2{margin:0 0 6px;color:#fff}
    label{color:#cbd5e1;margin-right:.5rem}
    select{padding:.35rem .5rem;border-radius:.5rem;border:1px solid #374151;background:#0f172a;color:#e5e7eb}
    button{background:var(--accent);border:none;padding:.8rem 1.4rem;border-radius:.7rem;color:#fff;font-size:1rem;cursor:pointer}
    button:hover{filter:brightness(0.95)}
    /* Status */
    #status{position:absolute;left:0;right:0;bottom:12px;text-align:center;color:#cbd5e1}
  </style>
</head>
<body>
  <a-scene background="color:#0b0d14" vr-mode-ui="enabled:true">
    <!-- Camera + cursor -->
    <a-entity id="rig" position="0 0 0">
      <a-entity id="cam" camera position="0 1.6 0"
                cursor="rayOrigin: mouse"
                raycaster="objects: .clickable; interval: 0"></a-entity>
    </a-entity>
    <!-- เป้าเกม -->
    <a-entity id="spawnZone" position="0 0 -1.2"></a-entity>
  </a-scene>

  <!-- ===== Overlay (HUD + Menu + Status) ===== -->
  <div id="overlay">
    <!-- HUD bar -->
    <div id="hudBar" style="display:none">
      <div class="hudBox" id="hudTime">เวลา: 60s</div>
      <div class="hudBox" id="hudScore">คะแนน: 0 | คอมโบ: x0</div>
      <div class="hudBox" id="hudQuest">Mini Quest — เตรียมเริ่ม</div>
    </div>
    <div id="feverBanner">FEVER!</div>

    <!-- Menu -->
    <div id="menu">
      <h2>เริ่ม: HERO HEALTH ACADEMY</h2>
      <div>
        <label>เลือกโหมด:</label>
        <select id="selMode">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div>
        <label>ระดับความยาก:</label>
        <select id="selDiff">
          <option value="easy">ง่าย</option>
          <option value="normal" selected>ปกติ</option>
          <option value="hard">ยาก</option>
        </select>
      </div>
      <button id="btnStart" type="button">เริ่มเกม</button>
    </div>

    <div id="status">Status: Ready</div>
  </div>

  <script type="module">
    const $ = s=>document.querySelector(s);
    const selMode=$('#selMode'), selDiff=$('#selDiff'), btnStart=$('#btnStart');
    const menu=$('#menu'), statusEl=$('#status'), hudBar=$('#hudBar');
    const timeEl=$('#hudTime'), scoreEl=$('#hudScore'), questEl=$('#hudQuest');
    const feverBanner=$('#feverBanner'), spawn=$('#spawnZone');

    // read URL params (mode/diff)
    try{
      const u=new URL(location.href);
      const m=(u.searchParams.get('mode')||'').toLowerCase();
      const d=(u.searchParams.get('diff')||'').toLowerCase();
      if(m) selMode.value=m;
      if(['easy','normal','hard'].includes(d)) selDiff.value=d;
    }catch{}

    // HUD listeners from mode-factory
    window.addEventListener('hha:score',(e)=>{
      const {score=0, combo=0} = e.detail||{};
      scoreEl.textContent = `คะแนน: ${score} | คอมโบ: x${combo}`;
    });
    window.addEventListener('hha:time',(e)=>{
      const {remainSec=0} = e.detail||{};
      timeEl.textContent = `เวลา: ${remainSec}s`;
    });
    window.addEventListener('hha:quest',(e)=>{
      questEl.textContent = e.detail?.text || 'Mini Quest';
    });
    window.addEventListener('hha:fever',(e)=>{
      const s=e.detail?.state;
      feverBanner.style.display = (s==='start') ? 'block' : 'none';
    });

    const MODE_URL={
      goodjunk:'./modes/goodjunk.safe.js',
      groups:'./modes/groups.safe.js',
      hydration:'./modes/hydration.safe.js',
      plate:'./modes/plate.safe.js'
    };

    btnStart.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const mode=selMode.value||'goodjunk';
      const diff=selDiff.value||'normal';
      statusEl.textContent = `Loading ${mode} (${diff})...`;
      menu.style.display='none';
      hudBar.style.display='flex'; // show HUD

      try{
        const mod = await import((MODE_URL[mode]||MODE_URL.goodjunk) + '?v=' + Date.now());
        await mod.boot({ host: spawn, difficulty: diff, goal: 40 });
        statusEl.textContent = `Running (${mode}/${diff})`;
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Fallback demo';
        hudBar.style.display='none';
        // fallback box
        const scene=document.querySelector('a-scene');
        const box=document.createElement('a-box'); box.setAttribute('color','#60a5fa');
        box.setAttribute('position','0 1.2 -1.2'); box.classList.add('clickable'); scene.appendChild(box);
        box.addEventListener('click',()=>box.setAttribute('color','#22c55e'));
        setTimeout(()=>{menu.style.display='flex';},800);
      }
    });
  </script>
</body>
</html>
