<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy ‚Äî VR</title>

  <!-- ‚úÖ Favicon ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô 404 -->
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <rect width="64" height="64" rx="12" fill="#0b1324"/>
    <text x="50%" y="54%" font-size="44" text-anchor="middle">üçé</text>
  </svg>'>

  <!-- ‚úÖ A-Frame -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --danger:#ef4444; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}

    /* === HUD === */
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}
    #logChip{left:12px;bottom:12px}

    /* === ‡πÄ‡∏°‡∏ô‡∏π === */
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);
      width:min(1080px,86vw);padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);
      border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;
      border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;
      color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}

    /* === ‡∏õ‡∏∏‡πà‡∏° VR === */
    .a-enter-vr,.a-enter-vr-button{position:absolute !important;right:12px !important;
      bottom:12px !important;z-index:1000 !important}
    #vrBtn{position:fixed;right:14px;bottom:14px;z-index:999;background:#ffffff12;
      border:1px solid #4a5568;color:#fff;padding:10px 14px;border-radius:10px;
      font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
    .xr-supported #vrBtn{display:none}

    /* === Fever effect === */
    .fever-on{box-shadow:inset 0 0 0 4px #ffd16655;animation:feverPulse .9s ease-in-out infinite alternate;}
    @keyframes feverPulse{from{filter:none}to{filter:drop-shadow(0 0 12px #ffd166)}}

    /* === Modal Summary === */
    .modal{position:fixed;inset:0;display:none;place-items:center;z-index:850;background:rgba(0,0,0,.5);}
    .card{width:min(560px,92vw);background:#0f172acc;border:1px solid #475569;color:#e8eefc;
      padding:20px;border-radius:14px;backdrop-filter:blur(8px)}
    .card h2{margin:0 0 8px;}
    .card .grid{display:grid;grid-template-columns:130px 1fr;gap:8px 12px;margin:10px 0 18px;}
  </style>
</head>

<body>
  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
  <div id="badgeScore" class="hud-chip">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest ‚Äî ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
  <div id="badgeMiss"  class="hud-chip">‡∏û‡∏•‡∏≤‡∏î: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
  <div id="logChip"    class="hud-chip">log: --</div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
  <div id="menu" class="menu-wrap">
    <h1>‡πÄ‡∏£‡∏¥‡πà‡∏°: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î:</label>
        <select id="modeSel" name="modeSel">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
        <select id="diffSel" name="diffSel">
          <option value="easy">‡∏á‡πà‡∏≤‡∏¢</option>
          <option value="normal" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="hard">‡∏¢‡∏≤‡∏Å</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      </div>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° VR -->
  <button id="vrBtn" title="Enter VR">VR</button>

  <!-- Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
  <div id="summary" class="modal">
    <div class="card">
      <h2 id="sumTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <div class="grid">
        <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div><div id="sumScore">0</div>
        <div>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div id="sumCombo">0</div>
        <div>‡∏û‡∏•‡∏≤‡∏î</div><div id="sumMiss">0</div>
        <div id="sumExtraLabel" style="display:none"></div><div id="sumExtraValue" style="display:none"></div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="btnClose">‡∏õ‡∏¥‡∏î</button>
        <button id="btnMenu" class="primary">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
      </div>
    </div>
  </div>

  <!-- ‡∏â‡∏≤‡∏Å VR -->
  <a-scene id="scene" background="color:#0b1324">
    <a-assets></a-assets>
    <a-entity id="cam" camera look-controls cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects:.clickable; far:6" position="0 1.6 0"></a-entity>
    <a-entity id="spawnHost" position="0 1.6 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <script>
    // ===== Helpers =====
    const $ = (s)=>document.querySelector(s);
    const BASE = '/webxr-health-mobile/HeroHealth';
    const MAP = {
      goodjunk: BASE + '/modes/goodjunk.safe.js',
      groups:   BASE + '/modes/groups.safe.js',
      hydration:BASE + '/modes/hydration.quest.js',
      plate:    BASE + '/modes/plate.quest.js'
    };
    const stamp = (url)=>url+(url.includes('?')?'&':'?')+'v='+(Date.now());
    const log = (t)=>{ $('#logChip').textContent='log: '+t; console.log('[HHA]',t); };

    // ===== HUD Events =====
    window.addEventListener('hha:score',(e)=>{
      const d=e.detail||{}; $('#badgeScore').textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${d.score||0} | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${d.combo||0}`;
    });
    window.addEventListener('hha:time',(e)=>{
      const t=Math.max(0,Math.round(e.detail?.sec||0)); $('#badgeTime').textContent=`‡πÄ‡∏ß‡∏•‡∏≤: ${t}s`;
    });
    window.addEventListener('hha:quest',(e)=>{
      $('#badgeQuest').textContent=e.detail?.text||'Mini Quest';
    });
    window.addEventListener('hha:miss',(e)=>{
      const el=$('#badgeMiss'); el.style.display='';
      const n=(e.detail?.count!=null)?e.detail.count:(parseInt(el.dataset.n||'0',10)+1);
      el.dataset.n=n; el.textContent='‡∏û‡∏•‡∏≤‡∏î: '+n+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
    });
    window.addEventListener('hha:fever',(e)=>{
      const st=e.detail?.state||'end';
      if(st==='start') document.body.classList.add('fever-on');
      else document.body.classList.remove('fever-on');
    });
    window.addEventListener('hha:end',(e)=>{
      const d=e.detail||{};
      $('#sumTitle').textContent='‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Äî '+(d.title||'');
      $('#sumScore').textContent=d.score||0;
      $('#sumCombo').textContent=d.combo||d.comboMax||0;
      $('#sumMiss').textContent=d.misses||0;
      if(d.rounds){ $('#sumExtraLabel').style.display=''; $('#sumExtraValue').style.display='';
        $('#sumExtraLabel').textContent='‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô'; $('#sumExtraValue').textContent=d.rounds; }
      $('#summary').style.display='grid'; $('#menu').style.display='';
    });

    // ===== VR Button =====
    $('#vrBtn').addEventListener('click',()=>{
      try{ const scene=document.getElementById('scene'); if(scene.enterVR) scene.enterVR(); }catch{}
    });

    // ===== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° =====
    $('#startBtn').addEventListener('click',()=>{
      const mode=$('#modeSel').value, diff=$('#diffSel').value;
      $('#menu').style.display='none'; $('#summary').style.display='none';
      $('#badgeMiss').dataset.n='0'; $('#badgeMiss').style.display='none';
      log('load '+mode);

      fetch(stamp(MAP[mode]),{method:'HEAD'}).then(r=>{
        if(!r.ok) throw new Error('404 '+MAP[mode]);
        return import(stamp(MAP[mode]));
      }).then(mod=>{
        if(!mod.boot) throw new Error('boot() missing');
        log('boot '+mode);
        return mod.boot({host:$('#spawnHost'),difficulty:diff,duration:60});
      }).then(()=>log('running '+mode))
      .catch(err=>{ alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message); console.error(err); $('#menu').style.display=''; });
    });

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ =====
    $('#btnClose').addEventListener('click',()=>$('#summary').style.display='none');
    $('#btnMenu').addEventListener('click',()=>{$('#summary').style.display='none';$('#menu').style.display='';});
  </script>
</body>
</html>
