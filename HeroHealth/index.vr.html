<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hero Health Academy — VR</title>

<!-- ใช้ไฟล์ local ป้องกัน CORS -->
<link rel="icon" href="./favicon.ico" />
<script src="./vendor/aframe-1.5.0.min.js"></script>
<script src="./vendor/aframe-troika-text-0.12.0.min.js"></script>

<style>
:root{--bg:#0b1324;--fg:#e8eefc;--chip:#0f172a99;--acc:#22c55e;--danger:#ef4444}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden}
a-scene{width:100%;height:100%}
.hud{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
  padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:800}
#hudTime{left:12px;top:12px}
#hudScore{left:50%;top:12px;transform:translateX(-50%)}
#hudQuest{right:12px;top:12px}
#hudMiss{right:12px;top:64px;display:none}
#fever{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:900;
  width:min(560px,90vw);height:12px;background:#0f172a;border:1px solid #334155;border-radius:999px;overflow:hidden}
#fever>div{height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0);transition:width .15s}
.fever-on{box-shadow:inset 0 0 0 4px #ffd16655;animation:pulse .9s ease-in-out infinite alternate}
@keyframes pulse{from{filter:none}to{filter:drop-shadow(0 0 10px #ffd166)}}

.menu{position:fixed;inset:0;display:grid;place-items:center;z-index:800}
.card{width:min(980px,92vw);background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;
  border-radius:18px;padding:24px;box-shadow:0 24px 60px #000a}
h1{margin:6px 0 16px;text-align:center;font-size:clamp(22px,3.6vw,42px)}
.row{display:flex;gap:12px;justify-content:center;align-items:center;margin:10px 0}
select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222}
button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:900}

#result{position:fixed;inset:0;display:none;place-items:center;z-index:1200;
  background:rgba(5,10,20,.72);backdrop-filter:blur(6px)}
#result .card{width:min(620px,92vw)}
#stars{font-size:40px;text-align:center;letter-spacing:4px;margin:6px 0}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;font-weight:700}
.stats b{color:#93c5fd}
</style>
</head>
<body>
<div id="hudTime"  class="hud" role="status">เวลา: 60s</div>
<div id="hudScore" class="hud" role="status">คะแนน: 0 | คอมโบ: x0</div>
<div id="hudQuest" class="hud" role="status">Mini Quest — เตรียมเริ่ม</div>
<div id="hudMiss"  class="hud" role="status">พลาด: 0 ครั้ง</div>
<div id="fever"><div></div></div>

<div id="menu" class="menu">
  <div class="card">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>
    <div class="row">
      <label for="modeSel">เลือกโหมด:</label>
      <select id="modeSel">
        <option value="goodjunk" selected>Good vs Junk</option>
        <option value="groups">Food Groups</option>
        <option value="hydration">Hydration</option>
        <option value="plate">Healthy Plate</option>
      </select>
    </div>
    <div class="row">
      <label for="diffSel">ระดับความยาก:</label>
      <select id="diffSel">
        <option value="easy">ง่าย</option>
        <option value="normal" selected>ปกติ</option>
        <option value="hard">ยาก</option>
      </select>
    </div>
    <div class="row"><button id="btnStart" class="primary">เริ่มเกม</button></div>
  </div>
</div>

<div id="result">
  <div class="card">
    <div id="stars">☆☆☆☆☆</div>
    <div class="stats">
      <div>โหมด: <b id="rsMode">-</b></div>
      <div>ระดับ: <b id="rsDiff">-</b></div>
      <div>คะแนน: <b id="rsScore">0</b></div>
      <div>คอมโบสูงสุด: <b id="rsCombo">0</b></div>
      <div>พลาด: <b id="rsMiss">0</b></div>
      <div>ความแม่นยำ: <b id="rsAcc">0%</b></div>
      <div>เควส: <b id="rsQ">0/3</b></div>
      <div>เวลาใช้: <b id="rsTime">0s</b></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnBack">กลับเมนู</button>
      <button id="btnReplay" class="primary">เล่นอีกครั้ง</button>
    </div>
  </div>
</div>

<a-scene id="scene" background="color:#0b1324">
  <a-assets></a-assets>
  <a-entity id="cam" camera look-controls
            cursor="rayOrigin: mouse; fuse: false"
            raycaster="objects: .clickable; far: 6"
            position="0 1.6 0"></a-entity>
  <!-- host ให้เกิดกลางจอ (จะถูกเลื่อนอัตโนมัติ) -->
  <a-entity id="spawnHost" position="0 0.8 -1.5"></a-entity>
  <a-sky color="#0b1324"></a-sky>
</a-scene>

<script>
/* ---------- HUD bindings ---------- */
(function(){
  const $ = s=>document.querySelector(s);
  window.addEventListener('hha:score', e=>{
    const d = e.detail||{};
    $('#hudScore').textContent = `คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
  });
  window.addEventListener('hha:time', e=>{
    const t = Math.max(0,Math.round((e.detail&&e.detail.sec)||0));
    $('#hudTime').textContent = `เวลา: ${t}s`;
  });
  window.addEventListener('hha:miss', e=>{
    const el = $('#hudMiss'); el.style.display='';
    const n = (e.detail&&e.detail.count!=null)?e.detail.count:(+el.dataset.n||0)+1;
    el.dataset.n=n; el.textContent=`พลาด: ${n} ครั้ง`;
  });
  window.addEventListener('hha:quest', e=>{
    $('#hudQuest').textContent = e.detail?.text || 'Mini Quest';
  });
  // fever bar
  const bar = document.querySelector('#fever>div');
  window.addEventListener('hha:fever', e=>{
    const d=e.detail||{}, st=d.state||'change', lv=d.level||0;
    if(st==='start'){
      document.body.classList.add('fever-on'); bar.style.width='100%';
      bar.style.background='linear-gradient(90deg,#ffb703,#fb5607)';
    }else if(st==='end'){
      document.body.classList.remove('fever-on'); bar.style.width='0%';
      bar.style.background='linear-gradient(90deg,#37d67a,#06d6a0)';
    }else{
      bar.style.width=Math.max(0,Math.min(100,Math.round(lv)))+'%';
    }
  });
})();

/* ---------- Auto center spawnHost ---------- */
(function(){
  const scene = document.querySelector('#scene');
  const cam   = document.querySelector('#cam');
  const host  = document.querySelector('#spawnHost');
  function center(){
    const y = (cam?.object3D?.position?.y ?? cam.getAttribute('position')?.y ?? 1.6) - 0.8;
    host.setAttribute('position',{x:0,y:Math.max(0.6,y),z:-1.5});
  }
  scene.addEventListener('loaded', center);
  scene.addEventListener('enter-vr', center);
  window.addEventListener('resize', center);
  setTimeout(center,80);
})();

/* ---------- Result panel ---------- */
(function(){
  const $=s=>document.querySelector(s);
  function stars(n){ return '★'.repeat(n)+'☆'.repeat(5-n); }
  window.addEventListener('hha:end', e=>{
    const d=e.detail||{};
    $('#rsMode').textContent = d.mode||'Unknown';
    $('#rsDiff').textContent = d.difficulty||'normal';
    $('#rsScore').textContent= (d.score||0).toLocaleString();
    $('#rsCombo').textContent= d.comboMax||d.combo||0;
    $('#rsMiss').textContent = d.misses||0;
    const spawns = d.spawns || ((d.hits||0)+(d.misses||0));
    const acc = spawns? (d.hits||0)/spawns : 0;
    $('#rsAcc').textContent = Math.round(acc*100)+'%';
    $('#rsQ').textContent   = (d.questsCleared||0)+'/'+(d.questsTotal||3);
    $('#rsTime').textContent= Math.round(d.duration||0)+'s';
    const diff = (d.difficulty||'normal');
    const goal={easy:300,normal:500,hard:700}[diff]||500;
    const scoreNorm = Math.max(0,Math.min(1,(d.score||0)/goal));
    const questNorm = Math.max(0,Math.min(1, (d.questsTotal? (d.questsCleared||0)/d.questsTotal : 0)));
    const accNorm   = acc;
    const star = Math.max(1,Math.round((0.45*accNorm+0.4*scoreNorm+0.15*questNorm)*5));
    $('#stars').textContent = stars(star);
    document.querySelector('#result').style.display='grid';
  });
  $('#btnBack').onclick=()=>{ document.querySelector('#result').style.display='none'; document.querySelector('#menu').style.display=''; };
  $('#btnReplay').onclick=()=>{ document.querySelector('#result').style.display='none'; document.querySelector('#btnStart').click(); };
})();

/* ---------- Loader ---------- */
(function(){
  const MAP={
    goodjunk : './modes/goodjunk.safe.js',
    groups   : './modes/groups.safe.js',
    hydration: './modes/hydration.quest.js',
    plate    : './modes/plate.quest.js'
  };
  const $=s=>document.querySelector(s);
  function withStamp(u){return u+(u.includes('?')?'&':'?')+'v='+Date.now();}
  $('#btnStart').addEventListener('click', ()=>{
    const mode=$('#modeSel').value, diff=$('#diffSel').value;
    document.querySelector('#menu').style.display='none';
    // reset HUD
    document.querySelector('#hudScore').textContent='คะแนน: 0 | คอมโบ: x0';
    document.querySelector('#hudTime').textContent='เวลา: 60s';
    document.querySelector('#hudQuest').textContent='Mini Quest — กำลังเริ่ม…';
    const miss=document.querySelector('#hudMiss'); miss.style.display='none'; miss.dataset.n='0';
    document.body.classList.remove('fever-on'); document.querySelector('#fever>div').style.width='0%';

    import(withStamp(MAP[mode]||MAP.goodjunk))
      .then(mod=>mod.boot({host:document.querySelector('#spawnHost'),difficulty:diff,duration:60}))
      .catch(err=>{
        alert('โหลดโหมดไม่สำเร็จ: '+(err?.message||err));
        console.error(err);
        document.querySelector('#menu').style.display='';
      });
  });
})();
</script>
</body>
</html>
