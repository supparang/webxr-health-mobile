<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy ‚Äî VR</title>

  <link rel="icon" href="/webxr-health-mobile/HeroHealth/favicon.ico" type="image/x-icon"/>

  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text@0.12.0/dist/aframe-troika-text.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}
    #feverWrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:900;
      width:min(540px,86vw);height:12px;background:#0f172a;border:1px solid #334155;border-radius:999px;overflow:hidden}
    #feverFill{height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0);transition:width .15s}
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);
      width:min(1080px,86vw);padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);
      border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
    #resultPanel{position:fixed;inset:0;display:none;place-items:center;z-index:1200;background:rgba(5,10,20,.72);backdrop-filter:blur(6px)}
    #resultCard{width:min(620px,90vw);color:#e8eefc;background:linear-gradient(#1b2538,#21304a);border:1px solid #3a4a66;border-radius:16px;padding:18px 20px;box-shadow:0 24px 60px #000a}
    #stars{font-size:40px;letter-spacing:4px;text-align:center;margin:8px 0 6px}
    #resultStats{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;font-weight:700}
    #resultStats div b{color:#93c5fd;font-weight:800}
    #resultBtns{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #475569;background:#0b1222;color:#fff;font-weight:800;cursor:pointer}
    .btn.primary{background:#22c55e;color:#052e12;border-color:#16a34a}
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
  <div id="badgeScore" class="hud-chip">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest ‚Äî ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
  <div id="badgeMiss"  class="hud-chip">‡∏û‡∏•‡∏≤‡∏î: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
  <div id="feverWrap"><div id="feverFill"></div></div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
  <div id="menu" class="menu-wrap">
    <h1>‡πÄ‡∏£‡∏¥‡πà‡∏°: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î:</label>
        <select id="modeSel">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">‡∏£‡∏∞‡∏î‡∏±‡∏ö:</label>
        <select id="diffSel">
          <option value="easy">‡∏á‡πà‡∏≤‡∏¢ (90s)</option>
          <option value="normal" selected>‡∏õ‡∏Å‡∏ï‡∏¥ (60s)</option>
          <option value="hard">‡∏¢‡∏≤‡∏Å (45s)</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      </div>
    </div>
  </div>

  <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
  <div id="resultPanel" role="dialog" aria-modal="true">
    <div id="resultCard">
      <div id="resultTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
      <div id="resultStats">
        <div>‡πÇ‡∏´‡∏°‡∏î: <b id="rsMode">-</b></div>
        <div>‡∏£‡∏∞‡∏î‡∏±‡∏ö: <b id="rsDiff">-</b></div>
        <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b id="rsScore">0</b></div>
        <div>‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b id="rsCombo">0</b></div>
        <div>‡∏û‡∏•‡∏≤‡∏î: <b id="rsMiss">0</b></div>
        <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: <b id="rsAcc">0%</b></div>
        <div>‡πÄ‡∏Ñ‡∏ß‡∏™: <b id="rsQuests">0/3</b></div>
        <div>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: <b id="rsTime">0s</b></div>
      </div>
      <div id="resultBtns">
        <button class="btn" id="btnBackMenu">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
        <button class="btn primary" id="btnReplay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Scene -->
  <a-scene id="scene" background="color:#0b1324">
    <a-entity id="cam" camera look-controls cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects:.clickable; far:6" position="0 1.6 0"></a-entity>
    <a-entity id="spawnHost" position="0 1.0 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <script>
  // HUD listeners (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡∏¢‡πà‡∏≠‡πÑ‡∏ß‡πâ)
  (function(){
    const $=s=>document.querySelector(s);
    window.addEventListener('hha:score',e=>{$('#badgeScore').textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${e.detail?.score||0} | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${e.detail?.combo||0}`;});
    window.addEventListener('hha:miss',e=>{const el=$('#badgeMiss');el.style.display='';const n=e?.detail?.count??(parseInt(el.dataset.n||'0',10)+1);el.dataset.n=n;el.textContent='‡∏û‡∏•‡∏≤‡∏î: '+n+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';});
    window.addEventListener('hha:time',e=>{$('#badgeTime').textContent='‡πÄ‡∏ß‡∏•‡∏≤: '+Math.max(0,Math.round(e?.detail?.sec||0))+'s';});
    window.addEventListener('hha:quest',e=>{$('#badgeQuest').textContent=e?.detail?.text||'Mini Quest';});
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏¢‡πà‡∏≠)
    function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
    function stars(n){return '‚òÖ'.repeat(n)+'‚òÜ'.repeat(5-n);}
    window.addEventListener('hha:end',e=>{
      const d=e.detail||{},hits=+d.hits||0,miss=+d.misses||0,sp=+d.spawns||(hits+miss),acc=sp?hits/sp:0;
      const diff=d.difficulty||'normal',goal={easy:300,normal:500,hard:700}[diff]||500;
      const st=clamp(Math.max(1,Math.round((0.45*acc+0.40*((+d.score||0)/goal)+0.15*((+d.questsTotal? +d.questsCleared/d.questsTotal:0)))*5)),1,5);
      rsMode.textContent=d.mode||'Game';rsDiff.textContent=diff;rsScore.textContent=(+d.score||0).toLocaleString();
      rsCombo.textContent=d.comboMax||d.combo||0;rsMiss.textContent=miss;rsAcc.textContent=Math.round(acc*100)+'%';
      rsQuests.textContent=(+d.questsCleared||0)+'/'+(+d.questsTotal||3);rsTime.textContent=Math.round(+d.duration||0)+'s';
      starsEl.textContent=stars(st);resultPanel.style.display='grid';
    });
    btnBackMenu.onclick=()=>{resultPanel.style.display='none';menu.style.display='';};
    btnReplay.onclick=()=>{resultPanel.style.display='none';startBtn.click();};
    const rsMode=$('#rsMode'),rsDiff=$('#rsDiff'),rsScore=$('#rsScore'),rsCombo=$('#rsCombo'),
      rsMiss=$('#rsMiss'),rsAcc=$('#rsAcc'),rsQuests=$('#rsQuests'),rsTime=$('#rsTime'),starsEl=$('#stars');
  })();

  // Loader (‡πÅ‡∏Å‡πâ: rewrite import paths ‡πÄ‡∏õ‡πá‡∏ô absolute ‡∏Å‡πà‡∏≠‡∏ô import ‡∏ú‡πà‡∏≤‡∏ô Blob)
  (function(){
    const spawnHost=document.getElementById('spawnHost');
    const ROOT='/webxr-health-mobile/HeroHealth';
    const ABS=(p)=>`${location.origin}${ROOT}${p}`;
    const MAP={
      goodjunk : ABS('/modes/goodjunk.safe.js'),
      groups   : ABS('/modes/groups.safe.js'),
      hydration: ABS('/modes/hydration.quest.js'),
      plate    : ABS('/modes/plate.quest.js')
    };
    let current=null;
    function cleanup(){
      try{window.dispatchEvent(new Event('hha:dispose-ui'));}catch{}
      document.querySelectorAll('[data-hha-ui]').forEach(n=>n.remove());
      spawnHost.querySelectorAll('a-image,a-entity').forEach(n=>n.remove());
      document.getElementById('feverFill').style.width='0%';
    }

    // üëâ ‡∏£‡∏µ‡πÑ‡∏£‡∏ó‡πå‡∏ó‡∏∏‡∏Å import ../vr/*.js ‡∏´‡∏£‡∏∑‡∏≠ ./../vr/*.js ‡∏´‡∏£‡∏∑‡∏≠ /webxr-health-mobile/HeroHealth/vr/*.js
    function fixImports(src){
      const baseVR = `${location.origin}${ROOT}/vr`;
      return src
        .replace(/from\s+['"](\.\.\/|\.\.\\\/|\.\/\.\.\/)?vr\/([a-zA-Z0-9_-]+\.js)['"]/g,
                 (_m,_p,fn)=>`from "${baseVR}/${fn}"`)
        .replace(/from\s+['"]\/webxr-health-mobile\/HeroHealth\/vr\/([a-zA-Z0-9_-]+\.js)['"]/g,
                 (_m,fn)=>`from "${baseVR}/${fn}"`);
    }

    async function importSafe(url){
      const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(`HTTP ${res.status}`);
      let code=await res.text();
      if(!code || code.length<50) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡πâ‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
      if(code.trim().startsWith('<')) throw new Error('‡πÑ‡∏î‡πâ HTML/404 ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡∏û‡∏≤‡∏ò‡∏≠‡∏≤‡∏à‡∏ú‡∏¥‡∏î)');
      code = fixImports(code);
      const blob=new Blob([code],{type:'text/javascript'});
      const blobUrl=URL.createObjectURL(blob);
      const mod=await import(/* @vite-ignore */ blobUrl);
      URL.revokeObjectURL(blobUrl);
      return mod;
    }

    document.getElementById('startBtn').addEventListener('click', async ()=>{
      const mode=document.getElementById('modeSel').value;
      const diff=document.getElementById('diffSel').value;
      // reset HUD
      badgeScore.textContent='‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0';
      badgeTime.textContent='‡πÄ‡∏ß‡∏•‡∏≤: '+(diff==='easy'?90:diff==='hard'?45:60)+'s';
      badgeQuest.textContent='Mini Quest ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶'; badgeMiss.style.display='none'; badgeMiss.dataset.n='0';
      // stop + cleanup
      try{current?.stop?.();}catch{} cleanup(); menu.style.display='none';
      try{
        const mod = await importSafe(MAP[mode]||MAP.goodjunk);
        current = await mod.boot({ host: spawnHost, difficulty: diff });
        window.addEventListener('blur', ()=>current?.pause?.());
        window.addEventListener('focus',()=>current?.resume?.());
      }catch(err){
        console.error(err); alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err?.message||err)); cleanup(); menu.style.display='';
      }
    });
  })();
  </script>
</body>
</html>