<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health VR — Nutrition Suite</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body{margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
    .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px}
    .fallback strong{color:#9ff}
    .btn{cursor:pointer}
  </style>
</head>
<body>
  <div class="fallback" id="bootStatus">
    <div><strong>Status:</strong> Booting…</div>
    <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">
      Force Start
    </button>
  </div>

  <a-scene background="color:#0b1324" vr-mode-ui="enterVRButton:true">
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>
    <a-sky color="#0b1324"></a-sky>

    <!-- HUD -->
    <a-entity id="hud" position="0 2.2 -2" render-order-deep="100">
      <a-entity geometry="primitive: plane; width: 1.8; height: 0.26"
                material="color:#111a33; opacity:0.88; depthTest:false; depthWrite:false"></a-entity>
      <a-text id="tTime" value="เวลา:60s" position="-0.84 0.07 0.01" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tScore" value="คะแนน:0" position="-0.84 -0.03 0.01" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tCombo" value="คอมโบ:x1" position="0.15 -0.03 0.01" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tStat" value="เลือกโหมด →" position="0.15 0.07 0.01" width="2.4" color="#7ea8ff"></a-text>
    </a-entity>

    <!-- เมนูเลือกโหมด -->
    <a-entity id="modeMenu" position="0 1.45 -0.95" render-order-deep="1000" ui-layer="1">
      <a-entity geometry="primitive: plane; width: 1.2; height: 0.72"
                material="color:#0e1b38; opacity:0.99; depthTest:false; depthWrite:false"></a-entity>
      <a-text value="เลือกโหมดเกม" position="-0.45 0.28 0.01" width="2" color="#9fd"></a-text>

      <a-plane class="clickable btn" position="-0.38 0.10 0.01" width="0.52" height="0.20" color="#1f3a6d" data-mode="goodjunk"></a-plane>
      <a-text value="ดี vs ขยะ" position="-0.58 0.09 0.02" width="2" color="#fff"></a-text>

      <a-plane class="clickable btn" position="0.38 0.10 0.01" width="0.52" height="0.20" color="#1f3a6d" data-mode="groups"></a-plane>
      <a-text value="หมวดอาหาร" position="0.16 0.09 0.02" width="2" color="#fff"></a-text>

      <a-plane class="clickable btn" position="-0.38 -0.16 0.01" width="0.52" height="0.20" color="#1f3a6d" data-mode="hydration"></a-plane>
      <a-text value="สมดุลน้ำ" position="-0.58 -0.17 0.02" width="2" color="#fff"></a-text>

      <a-plane class="clickable btn" position="0.38 -0.16 0.01" width="0.52" height="0.20" color="#1f3a6d" data-mode="plate"></a-plane>
      <a-text value="จานสุขภาพ" position="0.18 -0.17 0.02" width="2" color="#fff"></a-text>
    </a-entity>

    <!-- ปุ่มเริ่ม -->
    <a-entity id="startPanel" position="0 0.95 -1.05" render-order-deep="900" visible="false">
      <a-plane id="startBtn" width="0.9" height="0.26" color="#3b6" class="clickable" material="depthTest:false; depthWrite:false"></a-plane>
      <a-text id="startLbl" value="เลือกโหมดก่อน" position="-0.32 0 0.01" width="2" color="#fff"></a-text>
    </a-entity>

    <!-- Game zone -->
    <a-entity id="spawnZone" position="0 1.00 -3.80"></a-entity>
    <a-entity id="game" game-manager="goal:40;duration:60"></a-entity>

    <!-- กล้อง -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls cursor="rayOrigin:mouse"
        raycaster="objects:.clickable,.target;far:6">
        <a-entity position="0 0 -1" geometry="primitive:ring;radiusInner:0.01;radiusOuter:0.015"
                  material="color:#9fd;shader:flat;depthTest:false;depthWrite:false"></a-entity>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
  // --- render-order-deep + ui-layer components ---
  AFRAME.registerComponent('render-order-deep',{
    schema:{default:0},
    _apply(el,n){ (el.object3D||el).traverse(o=>o.renderOrder=n); },
    init(){ this._apply(this.el,this.data);
      this._on=()=>this._apply(this.el,this.data);
      this.el.addEventListener('object3dset',this._on);
      this.el.addEventListener('child-attached',this._on);
    },
    update(){ this._apply(this.el,this.data); },
    remove(){ this.el.removeEventListener('object3dset',this._on);
              this.el.removeEventListener('child-attached',this._on);}
  });
  AFRAME.registerComponent('ui-layer',{
    schema:{default:1},
    init(){
      const n=this.data;
      this.el.object3D.traverse(o=>o.layers.set(n));
      const cam=document.querySelector('#camera');
      if(cam && cam.object3D && cam.object3D.children[0]){
        const c3=cam.object3D.children[0];
        c3.layers.enable(n);
        c3.layers.enable(0);
      }
    }
  });
  // --- game manager fallback ---
  (function(){
    const btns=document.querySelectorAll('.btn');
    const startPanel=document.getElementById('startPanel');
    const startBtn=document.getElementById('startBtn');
    const startLbl=document.getElementById('startLbl');
    const tStat=document.getElementById('tStat');
    const menu=document.getElementById('modeMenu');
    let MODE='';

    btns.forEach(b=>b.addEventListener('click',()=>{
      MODE=b.getAttribute('data-mode');
      startPanel.setAttribute('visible','true');
      startLbl.setAttribute('value','เริ่มเกม');
      startBtn.setAttribute('color','#2e8b57');
      tStat.setAttribute('value','โหมด: '+MODE.toUpperCase());
    }));

    startBtn.addEventListener('click',()=>{ if(!MODE){alert('เลือกโหมดก่อน');return;}
      menu.setAttribute('visible','false'); startBtn.setAttribute('color','#555');
      startLbl.setAttribute('value','กำลังโหลด...');
      document.getElementById('bgm')?.components?.sound?.playSound?.();
      // เริ่มเกมปลอม (demo)
      console.log('Start mode',MODE);
    });
  })();
  </script>
</body>
</html>
