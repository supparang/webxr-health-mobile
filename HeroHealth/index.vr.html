<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px}
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);width:min(1080px,86vw);padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff33;border:1px solid #5c7fae66}
    h1{ text-align:center;margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px) }
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
    .a-enter-vr,.a-enter-vr-button{position:absolute!important;right:12px!important;bottom:12px!important;z-index:1000!important}
    #vrBtn{position:fixed;right:14px;bottom:14px;z-index:999;background:#ffffff12;border:1px solid #4a5568;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
    .xr-supported #vrBtn{display:none}
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip" style="display:none">พลาด: 0</div>

  <!-- เมนู -->
  <div id="menu" class="menu-wrap">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label>เลือกโหมด:</label>
        <select id="modeSel">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label>ระดับความยาก:</label>
        <select id="diffSel">
          <option value="easy">ง่าย</option>
          <option value="normal" selected>ปกติ</option>
          <option value="hard">ยาก</option>
        </select>
      </div>
      <div class="row"><button id="startBtn" class="primary">เริ่มเกม</button></div>
    </div>
  </div>

  <!-- ปุ่ม VR (fallback) -->
  <button id="vrBtn" title="Enter VR">VR</button>

  <!-- Scene -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>
    <a-entity id="cam" camera look-controls wasd-controls position="0 1.6 0"></a-entity>
    <a-entity id="spawnHost" position="0 0 -1.2"></a-entity>
    <a-sky color="#0b1324"></a-sky>
    <!-- fallback visual (จะซ่อนเองเมื่อโหมดทำงาน) -->
    <a-box id="fallbackBox" position="0 1.2 -1.2" depth="0.2" height="0.4" width="0.4" color="#3b82f6"
           animation="property: position; to: 0 1.3 -1.2; dir: alternate; loop: true; dur: 800"></a-box>
  </a-scene>

  <script type="module">
    // XR flag
    (async function(){
      var ok=false; try{ ok = !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-vr')); }catch(e){}
      document.body.classList.add(ok?'xr-supported':'xr-unsupported');
    })();

    // VR fallback
    document.getElementById('vrBtn').addEventListener('click', function(){
      var sc=document.getElementById('scene'); try{ sc && sc.enterVR && sc.enterVR(); }catch(e){}
    });

    // กัน scroll
    document.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});

    // Helpers
    function $(s){ return document.querySelector(s); }
    function setText(sel,txt){ var el=$(sel); if(el) el.textContent=txt; }

    // HUD listeners (ครั้งเดียว)
    if(!window.__HHA_LISTENERS__){
      window.addEventListener('hha:score', function(e){
        var d=e&&e.detail?e.detail:{};
        setText('#badgeScore','คะแนน: '+(d.score||0)+' | คอมโบ: x'+(d.combo||0));
      });
      window.addEventListener('hha:time', function(e){
        var s=(e&&e.detail&&typeof e.detail.sec==='number')?e.detail.sec:0;
        setText('#badgeTime','เวลา: '+s+'s');
        window.__HHA_LAST_TIME_EVT__ = performance.now();
      });
      window.addEventListener('hha:quest', function(e){
        setText('#badgeQuest', (e&&e.detail&&e.detail.text)||'Mini Quest');
      });
      window.addEventListener('hha:miss', function(e){
        var m=(e&&e.detail&&typeof e.detail.count==='number')?e.detail.count:0;
        var el=$('#badgeMiss'); if(el){ el.style.display=''; el.textContent='พลาด: '+m; }
      });
      window.addEventListener('hha:end', function(){
        var menu=$('#menu'); if(menu) menu.style.display='';
        var fb=$('#fallbackBox'); if(fb) fb.setAttribute('visible','true');
      });
      window.__HHA_LISTENERS__=true;
    }

    // Local countdown (ใช้เมื่อโหมดไม่ส่งเวลา)
    var localTimer=null, localRemain=60;
    function startLocalCountdown(sec){
      stopLocalCountdown();
      localRemain = sec|0;
      setText('#badgeTime','เวลา: '+localRemain+'s');
      localTimer = setInterval(function(){
        localRemain = Math.max(0, localRemain-1);
        setText('#badgeTime','เวลา: '+localRemain+'s');
        if(localRemain<=0) stopLocalCountdown();
      },1000);
    }
    function stopLocalCountdown(){ if(localTimer){ clearInterval(localTimer); localTimer=null; } }

    // Start button
    $('#startBtn').addEventListener('click', async function(){
      var mode=$('#modeSel').value, diff=$('#diffSel').value;

      // stop โหมดเดิม
      if(window.__HHA_API__ && typeof window.__HHA_API__.stop==='function'){
        try{ window.__HHA_API__.stop(); }catch(e){}
        window.__HHA_API__=null;
      }

      // Map
      var MAP={
        goodjunk :'./modes/goodjunk.safe.js',
        groups   :'./modes/groups.safe.js',
        hydration:'./modes/hydration.quest.js',
        plate    :'./modes/plate.quest.js'
      };
      var url=(MAP[mode]||MAP.goodjunk)+'?v='+Date.now();

      // Reset HUD
      setText('#badgeScore','คะแนน: 0 | คอมโบ: x0');
      setText('#badgeTime','เวลา: 60s');
      setText('#badgeQuest','Mini Quest — กำลังเริ่ม…');
      var missEl=$('#badgeMiss'); if(missEl) missEl.style.display='none';

      // Hide menu
      $('#menu').style.display='none';

      try{
        // import mode
        var mod=await import(url);
        var boot = (mod && (mod.boot || (mod.default && mod.default.boot)));
        if(typeof boot!=='function') throw new Error('Mode module missing boot()');

        var api=await boot({ host:$('#spawnHost'), difficulty:diff, duration:60 });
        window.__HHA_API__=api;

        // ซ่อน fallback box เมื่อโหมดเริ่ม
        var fb=$('#fallbackBox'); if(fb) fb.setAttribute('visible','false');

        // resume guard
        function tryResume(){ try{ window.__HHA_API__ && window.__HHA_API__.resume && window.__HHA_API__.resume(); }catch(e){} }
        window.addEventListener('pointerdown', tryResume, {passive:true});
        document.addEventListener('visibilitychange', function(){
          if(!document.hidden) tryResume();
        });

        // ---- Boot watchdog ----
        window.__HHA_LAST_TIME_EVT__ = performance.now();
        // ถ้า 2 วินาทีไม่มี hha:time → ใช้ local countdown เดินเอง และพยายาม resume ซ้ำ
        setTimeout(function(){
          var gap = performance.now() - (window.__HHA_LAST_TIME_EVT__||0);
          if(gap > 1800){
            startLocalCountdown(60);
            tryResume();
          }else{
            stopLocalCountdown();
          }
        }, 2000);

      }catch(err){
        alert('โหลดโหมดไม่สำเร็จ: '+(err && err.message ? err.message : err));
        $('#menu').style.display='';
        console.error(err);
      }
    });
  </script>
</body>
</html>