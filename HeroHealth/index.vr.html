<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health VR — Nutrition Suite</title>
  <meta name="color-scheme" content="light dark"/>
  <style>
    body{margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
    .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px}
    .fallback strong{color:#9ff}
  </style>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script type="module" src="./vr/emoji-sprite.js"></script>
  <script type="module" src="./vr/miniquest.js"></script>
  <script type="module" src="./vr/game-router.js"></script>
</head>
<body>
  <!-- Debug/Helper: สถานะการบูต + ปุ่มเริ่มแบบฮาร์ดคอล -->
  <div class="fallback" id="bootStatus">
    <div><strong>Status:</strong> Booting… (เปิดด้วย ?mode=goodjunk|groups|hydration|plate & goal=30|40|50)</div>
    <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">
      Force Start
    </button>
  </div>

  <a-scene background="color: #0b1324" renderer="colorManagement: true; physicallyCorrectLights: true" vr-mode-ui="enterVRButton: true">

    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>
    <a-sky color="#0b1324"></a-sky>

    <!-- HUD -->
    <a-entity id="hud" position="0 2.2 -2">
      <a-entity geometry="primitive: plane; width: 1.8; height: 0.26" material="color:#111a33; opacity:0.88"></a-entity>
      <a-text id="tTime" value="เวลา: 60s" position="-0.84 0.07 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tScore" value="คะแนน: 0" position="-0.84 -0.03 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tCombo" value="คอมโบ: x1" position="0.15 -0.03 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tStat" value="READY" position="0.15 0.07 0.01" align="left" width="2.4" color="#7ea8ff"></a-text>

      <!-- Mission -->
      <a-entity position="0 -0.23 0">
        <a-entity geometry="primitive: plane; width: 1.8; height: 0.08" material="color:#1b2752; opacity:0.95"></a-entity>
        <a-entity id="missionFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.9 0 0.01" material="color:#23a4ff; opacity:0.95"></a-entity>
        <a-text id="tMission" value="ภารกิจ: 0/40" position="-0.88 -0.005 0.02" align="left" width="2.4" color="#dff"></a-text>
      </a-entity>

      <!-- Streak + Fever -->
      <a-entity position="0 -0.42 0">
        <a-entity geometry="primitive: plane; width: 1.8; height: 0.08" material="color:#1b2752; opacity:0.95"></a-entity>
        <a-text id="tStreak" value="Streak: 0" position="-0.88 -0.005 0.02" align="left" width="2.4" color="#ffd54f"></a-text>
        <a-entity id="feverBg" geometry="primitive: plane; width: 0.9; height: 0.06" position="0.45 0 0.01" material="color:#1b2752; opacity:0.95"></a-entity>
        <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.06" position="0.0 0 0.02" material="color:#ff9043; opacity:0.95"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Mini Quest Panel -->
    <a-entity id="questPanel" position="0 1.62 -2">
      <a-entity geometry="primitive: plane; width: 1.8; height: 0.28" material="color:#111a33; opacity:0.85"></a-entity>
      <a-text value="Mini Quests" position="-0.84 0.09 0.01" align="left" width="2.4" color="#ffd54f"></a-text>
      <a-text id="tQ1" value="-" position="-0.84 -0.01 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tQ2" value="-" position="-0.84 -0.08 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tQ3" value="-" position="-0.84 -0.15 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
    </a-entity>

    <!-- Start / Result Panels -->
    <a-entity id="startPanel" position="0 1.4 -1.2">
      <a-plane id="startBtn" width="0.8" height="0.24" color="#2e8b57" class="clickable"
        onclick="(function(){window.__HARD_START__&&window.__HARD_START__();})();">
      </a-plane>
      <a-text value="เริ่มเกม" position="-0.22 0 0.01" width="2" color="#fff"></a-text>
    </a-entity>

    <a-entity id="resultPanel" position="0 1.6 -1.3" visible="false">
      <a-plane width="1.2" height="0.6" color="#111a33" opacity="0.95"></a-plane>
      <a-text id="tResultTitle" value="RESULT" position="-0.5 0.22 0.01" width="2" color="#7ea8ff"></a-text>
      <a-text id="tResultBody" value="-" position="-0.5 0.04 0.01" width="2" color="#e8f0ff"></a-text>
      <a-plane id="restartBtn" position="0 -0.18 0.01" width="0.6" height="0.2" color="#2e8b57" class="clickable"></a-plane>
      <a-text value="เล่นอีกครั้ง" position="-0.24 -0.18 0.02" width="1.6" color="#fff"></a-text>
    </a-entity>

    <!-- Camera + cursor -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls wasd-controls="acceleration: 40"
        cursor="rayOrigin: mouse; fuse: false"
        raycaster="objects: .clickable, .target; far: 6">
        <a-entity position="0 0 -1" geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                  material="color: #9fd; shader: flat"></a-entity>
      </a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable, .target; far: 6"></a-entity>
    </a-entity>

    <!-- Sounds -->
    <a-entity id="sfx" position="0 1.6 0">
      <!-- Coach voice (Thai) -->
      <a-sound id="coach_start" src="url(assets/audio/coach_start_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_good"  src="url(assets/audio/coach_good_th.mp3)"  volume="1.0"></a-sound>
      <a-sound id="coach_warn"  src="url(assets/audio/coach_warn_th.mp3)"  volume="1.0"></a-sound>
      <a-sound id="coach_fever" src="url(assets/audio/coach_fever_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_quest" src="url(assets/audio/coach_quest_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_clear" src="url(assets/audio/coach_clear_th.mp3)" volume="1.0"></a-sound>

      <a-sound id="bgm" src="url(assets/audio/bgm_loop.mp3)" autoplay="false" loop="true" volume="0.6"></a-sound>
      <a-sound id="sndPop" src="url(assets/audio/pop.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndBoo" src="url(assets/audio/boo.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndOk"  src="url(assets/audio/cheer_ok.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndWin" src="url(assets/audio/cheer_victory.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndFvr" src="url(assets/audio/cheer_fever.mp3)" volume="1.0"></a-sound>
    </a-entity>

    <!-- Game zone -->
    <a-entity id="spawnZone" position="0 1.4 -2.6"></a-entity>
    <a-entity id="game" game-manager="goal: auto; duration: 60"></a-entity>
  </a-scene>

  <!-- Robust Hard-Start logic -->
  <script>
    (function(){
      const statusEl = document.getElementById('bootStatus');
      const setStatus = (txt)=>{ if(statusEl) statusEl.firstElementChild.innerHTML = '<strong>Status:</strong> ' + txt; };

      function getGM(){
        return document.querySelector('[game-manager]')?.components?.['game-manager'] || null;
      }
      function compRegistered(){
        return !!AFRAME.components['game-manager'];
      }

      // พยายามเริ่มซ้ำทุก 250ms จนกว่า game-manager จะพร้อม (สูงสุด 10s)
      function hardStartWithRetry(msLeft=10000){
        const gm = getGM();
        if (gm && !gm.running){
          try{ gm.start(); setStatus('Started ✅'); return true; }
          catch(e){ console.error(e); setStatus('Error while starting: '+e.message); }
        }
        if (msLeft<=0){
          if (!compRegistered()){
            setStatus('Failed ❌ game-manager not loaded (โหมดไม่โหลด). ตรวจ path: vr/modes/*.js');
          }else{
            setStatus('Failed ❌ game-manager not found on entity #game');
          }
          return false;
        }
        setStatus('Waiting for game… ('+Math.ceil(msLeft/1000)+'s)');
        setTimeout(()=>hardStartWithRetry(msLeft-250),250);
        return false;
      }

      // เปิดทางให้ปุ่มสีเขียว/ปุ่ม Force/คลิกที่ใดก็ได้/Space/Enter ใช้ตัวนี้
      window.__HARD_START__ = ()=>hardStartWithRetry(10000);

      window.addEventListener('DOMContentLoaded', ()=>{
        setStatus('Loaded (press Start / Space / Enter)');
        document.getElementById('forceStartBtn')?.addEventListener('click', window.__HARD_START__);
        const scene = document.querySelector('a-scene');
        scene?.addEventListener('click', ()=>window.__HARD_START__());
        window.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter'){ window.__HARD_START__(); }});
      });

      // ถ้าโหมดโหลดสำเร็จ ให้โชว์ข้อความ
      (function pollModeReady(tries=0){
        if (AFRAME.components['game-manager']) { setStatus('Mode ready ✔ (กด Start เพื่อเริ่ม)'); return; }
        if (tries>60){ setStatus('Mode not loaded ⚠ ตรวจ game-router / โหมด'); return; }
        setTimeout(()=>pollModeReady(tries+1),150);
      })();
    })();
  </script>
</body>
</html>
