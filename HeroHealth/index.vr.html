<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hero Health Academy ‚Äî VR Edition</title>
  <meta name="color-scheme" content="light dark" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; background:#0b1120; color:#fff; font-family:'Prompt',sans-serif; }
    .hud { position:fixed; top:10px; left:0; right:0; display:flex; justify-content:space-between; align-items:center; padding:0 1rem; font-size:1rem; z-index:10; }
    .hud > div { background:rgba(255,255,255,0.08); padding:6px 12px; border-radius:12px; backdrop-filter:blur(6px); }
    #vrButton { position:fixed; bottom:16px; right:16px; background:white; color:black; font-weight:bold; border-radius:8px; padding:6px 14px; font-size:1rem; }
    a-scene { width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div class="hud">
    <div id="timeBox">‡πÄ‡∏ß‡∏•‡∏≤: 60s</div>
    <div id="scoreBox">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0 | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x0</div>
    <div id="questBox">Mini Quest ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‚Ä¶</div>
  </div>

  <a-scene vr-mode-ui="enabled: true" background="color: #0b1120">
    <a-entity id="cameraRig">
      <a-entity id="playerCam"
        camera
        look-controls
        wasd-controls
        position="0 1.6 0"
        cursor="fuse: false; rayOrigin: mouse"
        raycaster="objects: a-image, a-plane, .clickable">
      </a-entity>
    </a-entity>
    <a-entity id="spawnHost" position="0 1.6 -1.5"></a-entity>
  </a-scene>

  <button id="vrButton">VR</button>

  <script type="module">
    console.log("[HeroHealth VR] Booting production...");

    const MAP = {
      goodjunk : './modes/goodjunk.safe.js',
      groups   : './modes/groups.safe.js',
      hydration: './modes/hydration.quest.js',
      plate    : './modes/plate.quest.js'
    };

    // ===== UI Bind =====
    const hud = {
      time: document.querySelector('#timeBox'),
      score: document.querySelector('#scoreBox'),
      quest: document.querySelector('#questBox')
    };

    function setText(el, txt){ if(el) el.textContent = txt; }

    window.addEventListener('hha:time', e => setText(hud.time, `‡πÄ‡∏ß‡∏•‡∏≤: ${e.detail.sec}s`));
    window.addEventListener('hha:score', e => {
      const s = e.detail.score||0, c = e.detail.combo||0;
      setText(hud.score, `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${s} | ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${c}`);
    });
    window.addEventListener('hha:quest', e => setText(hud.quest, e.detail.text||''));
    window.addEventListener('hha:end', e => {
      const d=e.detail||{};
      alert(`üèÅ ‡∏à‡∏ö‡πÄ‡∏Å‡∏° ${d.title||''}\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${d.score}\n‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${d.combo}\n‡∏û‡∏•‡∏≤‡∏î: ${d.misses}`);
    });

    // ===== Main Boot =====
    async function loadMode(name='goodjunk'){
      const url = MAP[name];
      if(!url){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏´‡∏°‡∏î: '+name); return; }
      try{
        const mod = await import(url + '?v=' + Date.now());
        if(!mod || !mod.boot) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö boot()');
        console.log('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', name);
        mod.boot({ host: document.querySelector('#spawnHost'), duration:60, difficulty:'normal' });
      }catch(err){
        console.error('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
        alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏£‡∏Å
    loadMode('goodjunk');

    // ‡∏õ‡∏∏‡πà‡∏° VR
    document.getElementById('vrButton').onclick = ()=>{
      document.querySelector('a-scene').enterVR();
    };
  </script>
</body>
</html>