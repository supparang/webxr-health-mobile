<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>

  <!-- ใช้ไฟล์โลคอลป้องกัน CORS -->
  <script src="./vendor/aframe-1.5.0.min.js"></script>
  <script src="./vendor/aframe-troika-text-0.12.0.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --danger:#ef4444; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}

    /* HUD */
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}

    /* Fever gauge */
    #feverWrap{ position:fixed; left:50%; top:56px; transform:translateX(-50%); z-index:900;
      width:min(520px,80vw); background:#0f172a; border:1px solid #334155; border-radius:12px; padding:10px 12px; }
    #feverBarBox{ height:10px;background:#1f2937;border-radius:999px;overflow:hidden;border:1px solid #334155 }
    #feverBar{ height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0); transition:width .15s ease-out }
    #feverLabel{ margin-top:6px;font-weight:700;opacity:.9 }

    /* เมนูเริ่มเกม */
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);width:min(1080px,86vw);padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}

    /* ปุ่ม VR ของ A-Frame ให้ลอยชัด */
    .a-enter-vr,.a-enter-vr-button{position:absolute !important;right:12px !important;bottom:12px !important;z-index:1000 !important}

    /* FEVER effect */
    .fever-on{ box-shadow: inset 0 0 0 4px #ffd16655; animation:feverPulse .9s ease-in-out infinite alternate; }
    @keyframes feverPulse{ from{ filter:none } to{ filter: drop-shadow(0 0 12px #ffd166) } }

    /* RESULT PANEL */
    #resultPanel{ position:fixed; inset:0; display:none; place-items:center; z-index:1200;
      background:rgba(5,10,20,.72); backdrop-filter:blur(6px); }
    #resultCard{ width:min(620px,90vw); color:#e8eefc; background:linear-gradient(#1b2538,#21304a);
      border:1px solid #3a4a66; border-radius:16px; padding:18px 20px; box-shadow:0 24px 60px #000a; }
    #stars{ font-size:40px; letter-spacing:4px; text-align:center; margin:8px 0 6px; }
    #resultTitle{ text-align:center; font-weight:800; font-size:20px; margin:6px 0 12px; }
    #resultStats{ display:grid; grid-template-columns:1fr 1fr; gap:8px 14px; font-weight:700; }
    #resultStats div b{ color:#93c5fd; font-weight:800; }
    #resultBtns{ display:flex; gap:10px; justify-content:center; margin-top:14px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #475569; background:#0b1222; color:#fff; font-weight:800; cursor:pointer; }
    .btn.primary{ background:#22c55e; color:#052e12; border-color:#16a34a; }
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip" role="status" aria-live="polite">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip" role="status" aria-live="polite">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip" role="status" aria-live="polite">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip" role="status" aria-live="polite">พลาด: 0 ครั้ง</div>

  <!-- Fever Gauge -->
  <div id="feverWrap" class="hud-chip" aria-label="Fever gauge">
    <div style="font-weight:800;margin-bottom:6px">FEVER</div>
    <div id="feverBarBox"><div id="feverBar"></div></div>
    <div id="feverLabel">Fever 0%</div>
  </div>

  <!-- เมนูเริ่มเกม -->
  <div id="menu" class="menu-wrap">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">เลือกโหมด:</label>
        <select id="modeSel" name="modeSel">
          <option value="goodjunk" selected>Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">ระดับความยาก:</label>
        <select id="diffSel" name="diffSel">
          <option value="easy">ง่าย</option>
          <option value="normal" selected>ปกติ</option>
          <option value="hard">ยาก</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">เริ่มเกม</button>
      </div>
    </div>
  </div>

  <!-- Result panel -->
  <div id="resultPanel" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
    <div id="resultCard">
      <div id="resultTitle">สรุปผล</div>
      <div id="stars" aria-label="Star rating">☆☆☆☆☆</div>
      <div id="resultStats">
        <div>โหมด: <b id="rsMode">-</b></div>
        <div>ระดับ: <b id="rsDiff">-</b></div>
        <div>คะแนน: <b id="rsScore">0</b></div>
        <div>คอมโบสูงสุด: <b id="rsCombo">0</b></div>
        <div>พลาด: <b id="rsMiss">0</b></div>
        <div>ความแม่นยำ: <b id="rsAcc">0%</b></div>
        <div>เควส: <b id="rsQuests">0/3</b></div>
        <div>ใช้เวลา: <b id="rsTime">0s</b></div>
      </div>
      <div id="resultBtns">
        <button class="btn" id="btnBackMenu">กลับเมนู</button>
        <button class="btn primary" id="btnReplay">เล่นอีกครั้ง</button>
      </div>
    </div>
  </div>

  <!-- ฉาก A-Frame -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>

    <!-- กล้อง + cursor (ชี้ class=clickable) -->
    <a-entity id="cam"
              camera
              look-controls
              cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects: .clickable; far: 6"
              position="0 1.6 0"></a-entity>

    <!-- โหนดสแปว์น: วางให้ตรงหน้ากล้องระดับสายตา -->
    <a-entity id="spawnHost" position="0 1.6 -1.6"></a-entity>

    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <script>
    // กันลากหน้า (นอกจากบริเวณเมนู)
    document.addEventListener('touchmove',function(e){
      if(!e.target.closest('.menu-wrap')) e.preventDefault();
    },{passive:false});

    // ===== HUD listeners =====
    (function(){
      var $=s=>document.querySelector(s);
      window.addEventListener('hha:score', function(e){
        var d=e&&e.detail?e.detail:{}; $('#badgeScore').textContent='คะแนน: '+(d.score||0)+' | คอมโบ: x'+(d.combo||0);
      });
      window.addEventListener('hha:miss', function(e){
        var el=$('#badgeMiss'); el.style.display=''; var n=e&&e.detail&&e.detail.count!=null?e.detail.count:(parseInt(el.dataset.n||'0',10)+1);
        el.dataset.n=n; el.textContent='พลาด: '+n+' ครั้ง';
      });
      window.addEventListener('hha:time', function(e){
        var t=e&&e.detail&&e.detail.sec!=null?Math.max(0,Math.round(e.detail.sec)):0; $('#badgeTime').textContent='เวลา: '+t+'s';
      });
      window.addEventListener('hha:quest', function(e){
        var text=e&&e.detail&&e.detail.text?e.detail.text:'Mini Quest'; $('#badgeQuest').textContent=text;
      });

      // Fever gauge
      var bar=document.getElementById('feverBar'), lbl=document.getElementById('feverLabel');
      function setBar(p,active){
        var pct=Math.max(0,Math.min(100,Math.round(p||0)));
        if(bar){ bar.style.width=pct+'%'; bar.style.background=active?'linear-gradient(90deg,#ffb703,#fb5607)':'linear-gradient(90deg,#37d67a,#06d6a0)'; }
        if(lbl){ lbl.textContent=active?('FEVER! ('+pct+'%)'):('Fever '+pct+'%'); }
      }
      window.addEventListener('hha:fever', function(e){
        var d=e && e.detail ? e.detail : {};
        if(d.state==='start'){ document.body.classList.add('fever-on'); setBar(100,true); }
        else if(d.state==='end'){ document.body.classList.remove('fever-on'); setBar(0,false); }
        else { setBar(d.level||0, !!d.active); }
      });
    })();

    // ===== Result panel =====
    (function(){
      function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
      function stars(n){ return '★'.repeat(n)+'☆'.repeat(5-n); }
      window.addEventListener('hha:end', function(e){
        var d=e.detail||{};
        var score   = +d.score||0;
        var comboMx = +d.comboMax || +d.combo || 0;
        var misses  = +d.misses||0;
        var hits    = +d.hits||0;
        var spawns  = +d.spawns || (hits+misses);
        var acc     = spawns>0 ? hits/spawns : 0;
        var qCleared= +d.questsCleared||0;
        var qTotal  = +d.questsTotal||3;
        var sec     = +d.duration||0;
        var mode    = d.mode||d.title||'Unknown';
        var diff    = d.difficulty||'normal';

        var scoreGoal={easy:300,normal:500,hard:700}[diff]||500;
        var scoreNorm = clamp(score/scoreGoal,0,1);
        var accNorm   = clamp(acc,0,1);
        var questNorm = clamp(qTotal? qCleared/qTotal : 0,0,1);
        var starRaw = 0.45*accNorm + 0.40*scoreNorm + 0.15*questNorm;
        var starNum = clamp(Math.max(1, Math.round(starRaw*5)),1,5);

        document.getElementById('rsMode').textContent   = mode;
        document.getElementById('rsDiff').textContent   = diff;
        document.getElementById('rsScore').textContent  = score.toLocaleString();
        document.getElementById('rsCombo').textContent  = comboMx;
        document.getElementById('rsMiss').textContent   = misses;
        document.getElementById('rsAcc').textContent    = Math.round(accNorm*100)+'%';
        document.getElementById('rsQuests').textContent = qCleared+'/'+qTotal;
        document.getElementById('rsTime').textContent   = Math.round(sec)+'s';
        document.getElementById('stars').textContent    = stars(starNum);

        var panel=document.getElementById('resultPanel');
        panel.style.display='grid';
        document.getElementById('btnBackMenu').onclick=function(){ panel.style.display='none'; document.getElementById('menu').style.display=''; };
        document.getElementById('btnReplay').onclick=function(){ panel.style.display='none'; document.getElementById('startBtn').click(); };
      });
    })();

    // ===== Loader (โหลดโหมด & บูต) =====
    (function(){
      var $=s=>document.querySelector(s);
      function withStamp(url){ var sep=url.indexOf('?')>-1?'&':'?'; return url+sep+'v='+Date.now(); }
      var startedApi=null;

      document.getElementById('startBtn').addEventListener('click', function(){
        var mode = $('#modeSel').value;
        var diff = $('#diffSel').value;

        // reset HUD
        $('#badgeScore').textContent='คะแนน: 0 | คอมโบ: x0';
        $('#badgeTime').textContent ='เวลา: 60s';
        $('#badgeQuest').textContent='Mini Quest — กำลังเริ่ม…';
        var miss = $('#badgeMiss'); miss.style.display='none'; miss.dataset.n='0';
        document.body.classList.remove('fever-on');
        var bar=document.getElementById('feverBar'); if(bar) bar.style.width='0%';
        var lbl=document.getElementById('feverLabel'); if(lbl) lbl.textContent='Fever 0%';

        // ซ่อนเมนู
        $('#menu').style.display = 'none';

        var MAP = {
          goodjunk : './modes/goodjunk.safe.js',
          groups   : './modes/groups.safe.js',
          hydration: './modes/hydration.quest.js',
          plate    : './modes/plate.quest.js'
        };
        var url = withStamp(MAP[mode] || MAP.goodjunk);

        import(url).then(function(mod){
          if(!mod || !mod.boot) throw new Error('โหมดนี้ไม่มี boot()');
          return mod.boot({ host: document.getElementById('spawnHost'), difficulty: diff, duration: 60 });
        }).then(function(api){
          startedApi = api || null;
        }).catch(function(err){
          alert('โหลดโหมดไม่สำเร็จ: ' + (err && err.message ? err.message : err));
          console.error(err);
          $('#menu').style.display = '';
        });
      });

      // pause/resume ตาม visibility
      window.addEventListener('blur',  function(){ try{ startedApi && startedApi.pause && startedApi.pause(); }catch(e){} });
      window.addEventListener('focus', function(){ try{ startedApi && startedApi.resume && startedApi.resume(); }catch(e){} });
      document.addEventListener('visibilitychange', function(){
        try{
          if(document.hidden){ startedApi && startedApi.pause && startedApi.pause(); }
          else { startedApi && startedApi.resume && startedApi.resume(); }
        }catch(e){}
      });
    })();
  </script>
</body>
</html>
