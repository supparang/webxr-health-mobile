<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>

  <!-- A-Frame + Troika (ใช้ไฟล์โลคัลใน /vendor) -->
  <script src="./vendor/aframe-1.5.0.min.js"></script>
  <script src="./vendor/aframe-troika-text-0.12.0.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}

    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px;max-width:min(92vw,820px)}
    #badgeMiss{right:12px;top:58px;display:none}

    /* Fever gauge */
    #feverWrap{
      position:fixed; left:50%; top:56px; transform:translateX(-50%);
      width:min(520px,74vw); height:10px; border-radius:999px;
      border:1px solid #475569; background:#0b1222; overflow:hidden;
      display:none; z-index:901;
    }
    #feverBar{
      height:100%; width:0%;
      background:linear-gradient(90deg,#ffb703,#fb5607);
      transition:width .12s linear;
    }

    /* ปุ่ม VR fallback */
    .a-enter-vr,.a-enter-vr-button{position:absolute !important;right:12px !important;bottom:12px !important;z-index:1000 !important}
    #vrBtn{position:fixed;right:14px;bottom:14px;z-index:999;background:#ffffff12;border:1px solid #4a5568;color:#fff;
      padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
    .xr-supported #vrBtn{display:none}
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip">พลาด: 0 ครั้ง</div>
  <div id="feverWrap"><div id="feverBar"></div></div>

  <!-- A-Frame scene -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>

    <!-- กล้อง + cursor (ลากเมาส์/แตะเพื่อชี้ class=clickable) -->
    <a-entity id="cam"
              camera look-controls
              cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects: .clickable; far: 6"
              position="0 1.6 0"></a-entity>

    <!-- โหนดสแปว์น -->
    <a-entity id="spawnHost" position="0 0 -1.2"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <button id="vrBtn" title="Enter VR">VR</button>

  <script>
    // กันลากหน้า (นอกเมนู)
    document.addEventListener('touchmove',e=>{ e.preventDefault(); },{passive:false});

    // ตรวจ WebXR เพื่อซ่อนปุ่ม VR ของเรา
    (function(){
      function set(flag){ document.body.classList.add(flag?'xr-supported':'xr-unsupported'); }
      try{
        if(navigator.xr && navigator.xr.isSessionSupported){
          navigator.xr.isSessionSupported('immersive-vr').then(ok=>set(!!ok)).catch(()=>set(false));
        }else set(false);
      }catch(_){ set(false); }
    })();

    // ปุ่ม VR fallback
    (function(){
      var btn=document.getElementById('vrBtn'), sc=document.getElementById('scene');
      btn.addEventListener('click',()=>{ try{ sc && sc.enterVR && sc.enterVR(); }catch(_){ } });
    })();

    // ===== HUD listeners =====
    (function(){
      const $ = s=>document.querySelector(s);

      window.addEventListener('hha:score', e=>{
        const d = e?.detail || {};
        const s = (d.score!=null)?d.score:0;
        const c = (d.combo!=null)?d.combo:0;
        $('#badgeScore').textContent = 'คะแนน: '+s+' | คอมโบ: x'+c;
      });

      window.addEventListener('hha:time', e=>{
        const t = e?.detail?.sec!=null ? Math.max(0, Math.round(e.detail.sec)) : 0;
        $('#badgeTime').textContent = 'เวลา: '+t+'s';
      });

      window.addEventListener('hha:quest', e=>{
        const text = e?.detail?.text || 'Mini Quest';
        $('#badgeQuest').textContent = text;
      });

      window.addEventListener('hha:miss', e=>{
        const el = $('#badgeMiss'); el.style.display='';
        const n = e?.detail?.count!=null ? e.detail.count : (parseInt(el.dataset.n||'0',10)+1);
        el.dataset.n = n; el.textContent = 'พลาด: '+n+' ครั้ง';
      });
    })();

    // ===== Fever gauge (รับอีเวนต์จากโหมด) =====
    (function(){
      var wrap = document.getElementById('feverWrap');
      var bar  = document.getElementById('feverBar');
      var tEnd = 0, tick = null, total = 10000;

      function setPct(p){
        if(!bar) return;
        var pct = Math.max(0, Math.min(100, Math.round(p)));
        bar.style.width = pct+'%';
      }

      window.addEventListener('hha:fever', function(ev){
        var d = ev && ev.detail ? ev.detail : {};
        var st = d.state || 'change';
        if(st==='start'){
          total = d.ms|0 || 10000;
          wrap.style.display='';
          setPct(100);
          tEnd = Date.now() + total;
          clearInterval(tick);
          tick = setInterval(function(){
            var left = Math.max(0, tEnd - Date.now());
            setPct((left/total)*100);
            if(left<=0){ clearInterval(tick); }
          }, 120);
        }else if(st==='change'){
          if(typeof d.level==='number') setPct(d.level);
        }else if(st==='end'){
          clearInterval(tick); setPct(0); wrap.style.display='none';
        }
      });
    })();

    // ===== โหลดโหมด (goodjunk.safe.js) =====
    (function(){
      const host = document.getElementById('spawnHost');
      function withStamp(u){ const s=u.indexOf('?')>-1?'&':'?'; return u+s+'v='+(Date.now()); }
      const url = withStamp('./modes/goodjunk.safe.js');

      // เริ่มหลัง scene loaded เพื่อกัน timing A-Frame
      const scene = document.getElementById('scene');
      function start(){
        import(url).then(mod=>{
          if(!mod || !mod.boot) throw new Error('โหมดนี้ไม่มี boot()');
          console.log('log: goodjunk running');
          return mod.boot({ host, duration: 60, difficulty: 'normal' });
        }).catch(err=>{
          alert('โหลดโหมดไม่สำเร็จ: '+(err?.message||err));
          console.error(err);
        });
      }
      if(scene.hasLoaded) start();
      else scene.addEventListener('loaded', start, {once:true});
    })();
  </script>
</body>
</html>
