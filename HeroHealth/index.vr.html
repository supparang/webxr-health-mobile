<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hero Health VR â€” Nutrition Hub</title>
<meta name="color-scheme" content="light dark"/>
<style>
  html,body{height:100%;margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
  .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px;z-index:10}
  .fallback strong{color:#9ff}
  .ver{position:fixed;right:10px;bottom:10px;opacity:0.6;font-size:12px}
</style>

<!-- A-Frame & Troika -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

<!-- Ensure on-top rendering for UI -->
<script>
AFRAME.registerComponent('front-most', {
  schema:{order:{default:10000}},
  init(){
    const apply=(o)=>{ o.traverse(n=>{ if(n.material){ n.material.depthTest=false; n.material.depthWrite=false; n.renderOrder=this.data.order; }}); };
    if(this.el.object3D) apply(this.el.object3D);
    this.el.addEventListener('object3dset',()=>apply(this.el.object3D));
  }
});
</script>

<!-- Hub -->
<script type="module">
  import { GameHub } from './vr/hub.js?v=starter';
  window.addEventListener('DOMContentLoaded',()=>{ window.__hub=new GameHub(); });
</script>
</head>
<body>
<div class="fallback" id="bootStatus"><div><strong>Status:</strong> Bootingâ€¦</div>
  <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Force Start</button>
</div>
<div class="ver">HeroHealth Starter</div>

<a-scene background="color:#0b1324" vr-mode-ui="enterVRButton:true"
         renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true">
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
  <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
  <a-sky color="#0b1324"></a-sky>

  <!-- HUD -->
  <a-entity id="hudRoot" position="0 2.18 -2.8">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.30"
              material="color:#111a33; opacity:0.9; depthTest:false; depthWrite:false"></a-entity>
    <a-entity troika-text="value: à¹‚à¸«à¸¡à¸”: -; color:#9fd; fontSize:0.06;" position="-0.9 0.08 0.05"></a-entity>
    <a-entity troika-text="value: à¹€à¸§à¸¥à¸²: 60s; color:#fff; fontSize:0.06;" position="-0.9 -0.02 0.05"></a-entity>
    <a-entity troika-text="value: à¸„à¸°à¹à¸™à¸™: 0; color:#fff; fontSize:0.06;" position="0.15 0.08 0.05"></a-entity>
    <a-entity troika-text="value: à¸„à¸­à¸¡à¹‚à¸š: x1; color:#fff; fontSize:0.06;" position="0.15 -0.02 0.05"></a-entity>

    <!-- Fever bar -->
    <a-entity position="0 -0.20 0">
      <a-entity geometry="primitive: plane; width: 1.9; height: 0.08"
                material="color:#1b2752; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
      <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.95 0 0.06"
                material="color:#ff6600; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
      <a-entity troika-text="value: Fever 0%; color:#ffd54f; fontSize:0.06;" position="-0.92 -0.01 0.08"></a-entity>
    </a-entity>

    <!-- Buttons: Pause / Lang -->
    <a-entity id="pauseBtn" class="clickable" position="-0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#5b2b2b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: Pause; color:#fff; fontSize:0.045;" position="-0.95 0.095 0.08"></a-entity>

    <a-entity id="langBtn" class="clickable" position="0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#243a6b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: TH/EN; color:#fff; fontSize:0.045;" position="0.80 0.095 0.08"></a-entity>
  </a-entity>

  <!-- Mini Quests (stub) -->
  <a-entity id="questPanel" position="0 1.65 -2.8" visible="false">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.28"
              material="color:#111a33; opacity:0.88; transparent:true; depthTest:false; depthWrite:false"></a-entity>
    <a-entity troika-text="value: Mini Quests; color:#ffd54f; fontSize:0.07;" position="-0.9 0.09 0.05"></a-entity>
    <a-entity id="tQ" troika-text="value: ; color:#e8f0ff; fontSize:0.06;" position="-0.9 -0.06 0.05"></a-entity>
  </a-entity>

  <!-- à¹€à¸¡à¸™à¸¹à¹‚à¸«à¸¡à¸” -->
  <a-entity id="modeMenu" position="0 1.35 -1.2" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.05; height: 0.58"
              material="color:#0e1b38; opacity:0.95; transparent:true"></a-entity>
    <a-entity troika-text="value: à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¹€à¸à¸¡; color:#9fd; fontSize:0.065;" position="-0.40 0.23 0.26"></a-entity>
    <a-entity troika-text="value: à¸”à¸µ  vs  à¸‚à¸¢à¸°; color:#fff; fontSize:0.058;" position="-0.38 0.07 0.26"></a-entity>
    <a-entity troika-text="value: à¸«à¸¡à¸§à¸”à¸­à¸²à¸«à¸²à¸£; color:#fff; fontSize:0.058;" position="0.06 0.07 0.26"></a-entity>
    <a-entity troika-text="value: à¸ªà¸¡à¸”à¸¸à¸¥à¸™à¹‰à¸³; color:#fff; fontSize:0.058;" position="-0.38 -0.14 0.26"></a-entity>
    <a-entity troika-text="value: à¸ˆà¸²à¸™à¸ªà¸¸à¸‚à¸ à¸²à¸ž; color:#fff; fontSize:0.058;" position="0.06 -0.14 0.26"></a-entity>

    <!-- hitboxes -->
    <a-plane class="clickable" data-mode="goodjunk" position="-0.16 0.07 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"></a-plane>
    <a-plane class="clickable" data-mode="groups" position="0.40 0.07 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"></a-plane>
    <a-plane class="clickable" data-mode="hydration" position="-0.16 -0.14 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"></a-plane>
    <a-plane class="clickable" data-mode="plate" position="0.40 -0.14 0.24" width="0.46" height="0.18"
             material="transparent:true; opacity:0.001;"></a-plane>
  </a-entity>

  <!-- à¸›à¸¸à¹ˆà¸¡à¹€à¸£à¸´à¹ˆà¸¡ -->
  <a-entity id="startPanel" position="0 0.72 -1.15" visible="false" front-most="order:10000">
    <a-plane id="startBtn" class="clickable" position="0 0 0.30"
             width="0.90" height="0.24"
             material="color:#2e8b57; transparent:true; opacity:1.0"></a-plane>
    <a-entity id="startBtnFx" position="0 0 0.31"
              geometry="primitive: plane; width:0.92; height:0.26"
              material="color:#ffffff; opacity:0.0; transparent:true"></a-entity>
    <a-entity id="startLbl" troika-text="value: à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¸à¹ˆà¸­à¸™; color:#fff; fontSize:0.058;"
              position="-0.27 0 0.40"></a-entity>
  </a-entity>

  <!-- Rig/Camera -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="camera" camera look-controls cursor="rayOrigin: mouse"
              raycaster="objects: .clickable, .target, .hitbox; far: 6">
      <a-entity position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                material="color:#9fd; shader: flat; depthTest:false; depthWrite:false"></a-entity>
    </a-entity>
    <a-entity laser-controls="hand: right"
              raycaster="objects: .clickable, .target, .hitbox; far: 6"></a-entity>
  </a-entity>

  <!-- à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹€à¸à¸¡ -->
  <a-entity id="spawnZone" position="0 1.00 -3.80"></a-entity>
  <a-entity id="fxLayer" position="0 0 0"></a-entity>
</a-scene>

<!-- App wiring / Audio unlock / Pause / i18n / Fallback inline GoodJunk -->
<script>
function logBoot(msg){
  const box=document.getElementById('bootStatus');
  if(box) box.firstElementChild.innerHTML='<strong>Status:</strong> '+msg;
  console.log('[HVR]',msg);
}

// Audio unlock (à¸¡à¸·à¸­à¸–à¸·à¸­/VR)
let _ctx;
function getAudioCtx(){
  if(_ctx) return _ctx;
  const AC = window.AudioContext||window.webkitAudioContext;
  _ctx = new AC();
  return _ctx;
}
['click','touchstart','pointerdown','keydown'].forEach(ev=>{
  window.addEventListener(ev,()=>{ try{ getAudioCtx().resume(); }catch{} }, {once:true});
});

// Pause/Resume global
(function(){
  let paused=false;
  function setPaused(v){
    if(paused===v) return; paused=v;
    window.dispatchEvent(new CustomEvent(v?'hha:pause':'hha:resume'));
    logBoot(v?'Paused':'Resumed');
  }
  window.addEventListener('visibilitychange',()=>setPaused(document.hidden));
  window.addEventListener('blur',()=>setPaused(true));
  window.addEventListener('focus',()=>setPaused(false));
  document.getElementById('pauseBtn').addEventListener('click',()=>setPaused(!paused));
})();

// i18n stub
const i18n = {
  th: { mode:'à¹‚à¸«à¸¡à¸”', time:'à¹€à¸§à¸¥à¸²', score:'à¸„à¸°à¹à¸™à¸™', start:'à¹€à¸£à¸´à¹ˆà¸¡', quests:'à¸¡à¸´à¸Šà¸Šà¸±à¹ˆà¸™' },
  en: { mode:'Mode', time:'Time', score:'Score', start:'Start', quests:'Quests' }
};
let lang='th';
document.getElementById('langBtn').addEventListener('click', ()=>{
  lang = (lang==='th'?'en':'th');
  const heads = document.querySelectorAll('#hudRoot a-entity[troika-text]');
  if(heads.length>=3){
    heads[0].setAttribute('troika-text','value', (i18n[lang].mode||'Mode')+': -');
    heads[1].setAttribute('troika-text','value', (i18n[lang].time||'Time')+': 60s');
    heads[2].setAttribute('troika-text','value', (i18n[lang].score||'Score')+': 0');
  }
});

// à¹€à¸¡à¸™à¸¹/à¹€à¸£à¸´à¹ˆà¸¡/Force fallback
function wireClicks(){
  const hub=()=>window.__hub;

  // à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    const mode=btn.getAttribute('data-mode');
    const onPick=()=>{
      if(hub() && typeof hub().selectMode==='function') hub().selectMode(mode);
      const lbl=document.getElementById('startLbl');
      if(lbl) lbl.setAttribute('troika-text','value','à¹€à¸£à¸´à¹ˆà¸¡: '+mode.toUpperCase());
      document.getElementById('startPanel').setAttribute('visible',true);
      logBoot('Picked mode: '+mode);
    };
    ['click','mousedown','mouseup','triggerdown'].forEach(ev=>btn.addEventListener(ev,onPick));
  });

  // à¸›à¸¸à¹ˆà¸¡ Start
  const start=document.getElementById('startBtn');
  const fx=document.getElementById('startBtnFx');
  start.addEventListener('mouseenter',()=>fx.setAttribute('material','opacity',0.08));
  start.addEventListener('mouseleave',()=>fx.setAttribute('material','opacity',0.0));
  const tryStart=async ()=>{
    logBoot('Start pressed');
    if(hub()){
      if(typeof hub().startGame==='function'){ hub().startGame(); return; }
      if(typeof hub().start==='function'){ hub().start(); return; }
      if(typeof hub().begin==='function'){ hub().begin(); return; }
    }
    // fallback inline
    logBoot('Fallback inline GoodJunk');
    inlineGoodJunkBoot({host:document.getElementById('spawnZone'), duration:60, difficulty:'normal'});
  };
  ['click','mousedown','mouseup','triggerdown'].forEach(ev=>start.addEventListener(ev,tryStart));

  // Force start (debug)
  document.getElementById('forceStartBtn').addEventListener('click', tryStart);
}
if(document.readyState!=='loading') setTimeout(wireClicks,0);
else window.addEventListener('DOMContentLoaded',()=>setTimeout(wireClicks,0));

/* ---------------- Helper HUD ---------------- */
function setHudTime(sec){
  const t = document.querySelector('#hudRoot a-entity[troika-text]:nth-of-type(2)');
  if(t) t.setAttribute('troika-text','value',(i18n[lang].time||'Time')+': '+sec+'s');
}
function setHudScore(sc){
  const t = document.querySelector('#hudRoot a-entity[troika-text]:nth-of-type(3)');
  if(t) t.setAttribute('troika-text','value',(i18n[lang].score||'Score')+': '+sc);
}
function setHudFever(p){
  const bar = document.getElementById('feverFill');
  if (bar) bar.setAttribute('geometry','width', (Math.max(0,Math.min(1,p))*1.9));
  const label = document.querySelector('#hudRoot a-entity[troika-text][position="-0.92 -0.01 0.08"]');
  if (label) label.setAttribute('troika-text','value','Fever ' + Math.round(p*100) + '%');
}
function burst3D(host, pos=[0,0,0], color='#7ee'){
  for(let i=0;i<10;i++){
    const piece = document.createElement('a-entity');
    piece.setAttribute('geometry','primitive: box; depth: 0.02; height: 0.02; width: 0.02');
    piece.setAttribute('material',`color:${color}; opacity:0.95; transparent:true`);
    piece.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    const dx = (Math.random()*0.6-0.3).toFixed(2);
    const dy = (Math.random()*0.6-0.2).toFixed(2);
    const dz = (Math.random()*0.2+0.05).toFixed(2);
    piece.setAttribute('animation__move', `property: position; to: ${(+pos[0]+ +dx)} ${(+pos[1]+ +dy)} ${(+pos[2]+ +dz)}; dur: 450; easing: easeOutQuad`);
    piece.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 420; delay:80; easing: linear');
    host.appendChild(piece);
    setTimeout(()=>piece.remove(), 520);
  }
}
function popupScore(host, pos=[0,0,0], text='+1', color='#7CFC00'){
  const node = document.createElement('a-entity');
  node.setAttribute('troika-text', `value: ${text}; color:${color}; fontSize:0.06; anchor:center;`);
  node.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]+0.02}`);
  node.setAttribute('animation__rise', `property: position; to: ${pos[0]} ${(+pos[1]+0.24).toFixed(2)} ${pos[2]+0.02}; dur:600; easing:easeOutQuad`);
  node.setAttribute('animation__fade', `property: opacity; to: 0; dur: 500; delay:100; easing: linear`);
  host.appendChild(node);
  setTimeout(()=>node.remove(), 700);
}

/* ---------------- Inline GoodJunk with power-ups & Glow/Hitbox ---------------- */
(function(){
  // à¸žà¸²à¹€à¸¥à¸•à¸ªà¸µà¹à¸¢à¸à¸•à¸²à¸¡à¸Šà¸™à¸´à¸”
  const PALETTE = {
    good:    { base:'#7CFC00', glow:'#b7ff66', text:'#ffffff' },
    junk:    { base:'#ff4d4d', glow:'#ff9999', text:'#ffffff' },
    decoy:   { base:'#ff9e7a', glow:'#ffd0bf', text:'#ffffff' },
    star:    { base:'#ffea00', glow:'#fff27a', text:'#3b3300' },
    diamond: { base:'#66ccff', glow:'#bfe8ff', text:'#06263a' },
    shield:  { base:'#5ef',    glow:'#bbf3ff', text:'#003344' },
    x2:      { base:'#FFD700', glow:'#ffe885', text:'#4d3b00' }
  };

  window.inlineGoodJunkBoot = function inlineGoodJunkBoot({host,duration=60,difficulty='normal'}){
    const zone = host || document.getElementById('spawnZone');
    while(zone.firstChild) zone.removeChild(zone.firstChild);

    // à¸‰à¸²à¸à¸«à¸¥à¸±à¸‡à¸‚à¸­à¸‡à¹€à¸à¸¡
    const plane = document.createElement('a-plane');
    plane.setAttribute('width','2.2'); plane.setAttribute('height','1.2');
    plane.setAttribute('color','#0e1b38'); plane.setAttribute('opacity','0.85');
    plane.setAttribute('position','0 0 -0.01');
    zone.appendChild(plane);

    // à¸Šà¸¸à¸”à¸­à¸µà¹‚à¸¡à¸ˆà¸´
    const GOOD   = ['ðŸŽ','ðŸ“','ðŸ‡','ðŸ¥¦','ðŸ¥•','ðŸ…','ðŸ¥¬','ðŸŠ','ðŸŒ','ðŸ«','ðŸ','ðŸ','ðŸ‹','ðŸ‰','ðŸ¥','ðŸš','ðŸ¥›','ðŸž','ðŸŸ','ðŸ¥—'];
    const JUNK   = ['ðŸ”','ðŸŸ','ðŸ•','ðŸ©','ðŸª','ðŸ§','ðŸ¥¤','ðŸ§‹','ðŸ¥“','ðŸ«','ðŸŒ­'];
    const DECOY  = ['ðŸ¥¯','ðŸ§€','ðŸ—','ðŸ–','ðŸ¥ ','ðŸœ'];
    const STAR   = 'â­';
    const DIAM   = 'ðŸ”·';
    const SHIELD = 'ðŸ›¡ï¸';
    const X2     = 'âœ–ï¸';

    // à¸ªà¸–à¸²à¸™à¸°à¹€à¸à¸¡
    let score=0, tLeft=duration, fever=0, combo=0;
    let hasShield=false, hasX2=false, x2Timer=null;
    setHudScore(score); setHudTime(tLeft); setHudFever(fever);

    // HUD à¹à¸ªà¸”à¸‡ x2
    const hudRoot = document.getElementById('hudRoot');
    const hudX2 = document.createElement('a-entity');
    hudX2.setAttribute('troika-text','value: ; color:#FFD700; fontSize:0.08;');
    hudX2.setAttribute('position','0.65 0.06 0.05');
    hudRoot.appendChild(hudX2);

    // à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸ªà¸¸à¹ˆà¸¡ (à¸à¸¥à¸²à¸‡à¸ˆà¸­ 1.8 x 0.9)
    function randPos(){ return [ (Math.random()*1.8-0.9), (Math.random()*0.9-0.45), 0.01 ]; }
    // à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸•à¹‡à¸¡ plane 2.2 x 1.2 à¹ƒà¸Šà¹‰:
    // function randPos(){ return [ (Math.random()*2.2-1.1), (Math.random()*1.2-0.6), 0.01 ]; }

    // à¸•à¸±à¸§à¸Šà¹ˆà¸§à¸¢à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸›à¹‰à¸²à¸žà¸£à¹‰à¸­à¸¡ Glow + Hitbox
    function makeTarget(kind, emoji, pos){
      const pal = PALETTE[kind] || {base:'#fff', glow:'#ddd', text:'#000'};
      const root = document.createElement('a-entity');
      root.classList.add('target');

      const glow = document.createElement('a-plane');
      glow.setAttribute('width','0.28'); glow.setAttribute('height','0.28');
      glow.setAttribute('material', `color:${pal.glow}; opacity:0.35; transparent:true; shader: standard; emissive:${pal.glow}; emissiveIntensity:0.55`);
      glow.setAttribute('position', '0 0 -0.002');
      root.appendChild(glow);

      const txt = document.createElement('a-entity');
      txt.setAttribute('troika-text', `value: ${emoji}; color:${pal.text}; fontSize:${(kind==='diamond'||kind==='star')?0.24:(kind==='x2'?0.22:0.22)}; anchor:center;`);
      txt.setAttribute('position', '0 0 0');
      root.appendChild(txt);

      const box = document.createElement('a-plane');
      box.classList.add('hitbox','clickable');
      box.setAttribute('width','0.34'); box.setAttribute('height','0.34');
      box.setAttribute('material','transparent:true; opacity:0.001; color:#fff');
      box.setAttribute('position','0 0 0.002');
      root.appendChild(box);

      root.setAttribute('position', `${pos[0].toFixed(2)} ${pos[1].toFixed(2)} ${pos[2]}`);

      box.addEventListener('mouseenter', () => glow.setAttribute('material','opacity:0.5; transparent:true; color:'+pal.glow+'; emissive:'+pal.glow+'; emissiveIntensity:0.75'));
      box.addEventListener('mouseleave', () => glow.setAttribute('material','opacity:0.35; transparent:true; color:'+pal.glow+'; emissive:'+pal.glow+'; emissiveIntensity:0.55'));

      return {root, box};
    }

    // à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸›à¹‰à¸² 1 à¸Šà¸´à¹‰à¸™
    function spawnOne(){
      const r = Math.random();
      let kind, emoji, value=0;
      if (r < 0.06){ kind='diamond'; emoji=DIAM; value=10; }
      else if (r < 0.14){ kind='star'; emoji=STAR; value=5; }
      else if (r < 0.20){ kind='shield'; emoji=SHIELD; value=0; }
      else if (r < 0.26){ kind='x2'; emoji=X2; value=0; }
      else if (r < 0.40){ kind='decoy'; emoji=DECOY[(Math.random()*DECOY.length)|0]; value=-2; }
      else if (r < 0.78){ kind='good'; emoji=GOOD[(Math.random()*GOOD.length)|0]; value=1; }
      else { kind='junk'; emoji=JUNK[(Math.random()*JUNK.length)|0]; value=-1; }

      const pos = randPos();
      const {root, box} = makeTarget(kind, emoji, pos);
      zone.appendChild(root);

      const life = setTimeout(()=>root.remove(), 2200);

      const onHit = ()=>{
        clearTimeout(life);

        // Power-ups à¸à¹ˆà¸­à¸™
        if(kind==='shield'){
          hasShield = true;
          burst3D(zone, pos, PALETTE.shield.base);
          popupScore(zone, pos, 'ðŸ›¡ï¸ à¹„à¸”à¹‰à¹€à¸à¸£à¸²à¸°à¸›à¹‰à¸­à¸‡à¸à¸±à¸™!', PALETTE.shield.base);
          root.remove(); return;
        }
        if(kind==='x2'){
          hasX2 = true;
          if(x2Timer) clearTimeout(x2Timer);
          burst3D(zone, pos, PALETTE.x2.base);
          popupScore(zone, pos, 'âœ–ï¸ x2 Mode!', PALETTE.x2.base);
          hudX2.setAttribute('troika-text','value','x2 ACTIVE!');
          x2Timer = setTimeout(()=>{
            hasX2=false;
            hudX2.setAttribute('troika-text','value','');
            popupScore(zone, [0,0.2,0.01],'x2 à¸«à¸¡à¸”à¹€à¸§à¸¥à¸²','#999');
          }, 8000);
          root.remove(); return;
        }

        // Bad hit à¹à¸•à¹ˆà¸¡à¸µ shield â†’ à¸¢à¸à¹€à¸¥à¸´à¸à¹‚à¸—à¸©
        if((kind==='decoy' || kind==='junk') && hasShield){
          hasShield=false;
          burst3D(zone, pos, PALETTE.shield.base);
          popupScore(zone, pos, 'ðŸ›¡ï¸ à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!', PALETLETE.shield?.base||'#5ef');
          root.remove(); return;
        }

        // à¸„à¸³à¸™à¸§à¸“à¸„à¸°à¹à¸™à¸™/fever
        const mult = (hasX2?2:1) * (fever>=1?2:1);
        const delta = (value>0 ? value*mult : value);
        score = Math.max(0, score + delta);

        if (value>0){
          combo++;
          fever = Math.min(1, fever + (kind==='diamond'?0.15: kind==='star'?0.08:0.04));
        } else {
          combo = 0;
          fever = Math.max(0, fever - 0.10);
          zone.setAttribute('material','color','#2a0b1a');
          setTimeout(()=>zone.setAttribute('material','color','#0e1b38'), 120);
        }

        const col = (delta>=0)
          ? (kind==='diamond'?PALETTE.diamond.base:(kind==='star'?PALETTE.star.base:PALETTE.good.base))
          : PALETTE.junk.base;

        burst3D(zone, pos, col);
        popupScore(zone, pos, (delta>0?'+':'')+delta + (kind==='star'?' â­':'' ) + (kind==='diamond'?' ðŸ’Ž':'' ), col);

        setHudScore(score); setHudFever(fever);
        root.remove();
      };

      ['click','mousedown','mouseup','triggerdown'].forEach(ev=> box.addEventListener(ev,onHit));
    }

    // à¸­à¸±à¸•à¸£à¸² spawn à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸¢à¸²à¸
    const rate = (difficulty==='hard')? 260 : (difficulty==='normal')? 360 : 480;
    const spawner = setInterval(spawnOne, rate);
    const timer = setInterval(()=>{
      tLeft--; setHudTime(tLeft);
      if (tLeft<=0){
        clearInterval(spawner); clearInterval(timer);
        popupScore(zone, [0,0.1,0.01], 'à¸ˆà¸šà¹€à¸à¸¡! à¸„à¸°à¹à¸™à¸™: '+score, '#9fd');
      }
    }, 1000);

    // à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ 5 à¸Šà¸´à¹‰à¸™
    for(let i=0;i<5;i++) spawnOne();
  };
})();
</script>
</body>
</html>
