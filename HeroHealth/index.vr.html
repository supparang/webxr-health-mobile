<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>

  <!-- ใช้ไฟล์โลคอล ลด CORS -->
  <script src="./vendor/aframe-1.5.0.min.js"></script>
  <script src="./vendor/aframe-troika-text-0.12.0.min.js"></script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --warn:#fbbf24; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%}

    /* HUD */
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}

    /* Fever bar */
    #feverWrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:900;
      width:min(540px,86vw);height:12px;background:#0f172a;border:1px solid #334155;border-radius:999px;overflow:hidden}
    #feverFill{height:100%;width:0%;background:linear-gradient(90deg,#37d67a,#06d6a0);transition:width .15s ease-out}
    .fever-on{ box-shadow: inset 0 0 0 4px #ffd16655; animation:feverPulse .9s ease-in-out infinite alternate;}
    @keyframes feverPulse{ from{ filter:none } to{ filter: drop-shadow(0 0 12px #ffd166) } }

    /* เมนู */
    .menu-wrap{position:fixed;left:50%;top:22%;transform:translateX(-50%);width:min(1080px,86vw);
      padding:24px;border-radius:18px;background:linear-gradient(#1f2b40,#22314b);border:1px solid #384861;z-index:800;box-shadow:0 20px 50px #0008}
    .menu-inner{margin:0 auto;max-width:min(920px,88vw);text-align:center;padding:24px;border-radius:16px;background:#6ea8ff2e;border:1px solid #5c7fae66}
    h1{margin:8px 0 24px;font-size:clamp(22px,3.6vw,42px);text-align:center}
    .row{margin:14px 0;display:flex;gap:12px;justify-content:center;align-items:center}
    select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #475569;color:#fff;background:#0b1222;outline:0}
    button.primary{background:var(--acc);color:#052e12;border-color:#16a34a;font-weight:800}
    #modeWarn{display:none;margin-top:8px;color:var(--warn);font-weight:800}
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip">พลาด: 0 ครั้ง</div>

  <!-- Fever bar -->
  <div id="feverWrap"><div id="feverFill"></div></div>

  <!-- เมนูเริ่มเกม (โชว์แน่ๆ เมื่อเข้าหน้า) -->
  <div id="menu" class="menu-wrap" style="display:block">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>
    <div class="menu-inner">
      <div class="row">
        <label for="modeSel">เลือกโหมด:</label>
        <select id="modeSel" name="modeSel">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="diffSel">ระดับความยาก:</label>
        <select id="diffSel" name="diffSel">
          <option value="easy">ง่าย</option>
          <option value="normal" selected>ปกติ</option>
          <option value="hard">ยาก</option>
        </select>
      </div>
      <div class="row">
        <button id="startBtn" class="primary">เริ่มเกม</button>
      </div>
      <div id="modeWarn"></div>
    </div>
  </div>

  <!-- ฉาก A-Frame -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>

    <a-entity id="cam"
      camera
      look-controls
      cursor="rayOrigin: mouse; fuse:false"
      raycaster="objects: .clickable; far: 6"
      position="0 1.6 0"></a-entity>

    <!-- โซนสแปว์น วางกลางจอชัดๆ -->
    <a-entity id="spawnHost" position="0 1.0 -1.6"></a-entity>

    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <script>
    // กันลากหน้า (ยกเว้นบริเวณเมนู)
    document.addEventListener('touchmove',e=>{
      if(!e.target.closest('.menu-wrap')) e.preventDefault();
    },{passive:false});

    // HUD listeners
    (function(){
      const $ = s => document.querySelector(s);
      window.addEventListener('hha:score', e=>{
        const d=e?.detail||{};
        $('#badgeScore').textContent = `คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
      });
      window.addEventListener('hha:time', e=>{
        const t = Math.max(0, Math.round(e?.detail?.sec ?? 0));
        $('#badgeTime').textContent = `เวลา: ${t}s`;
      });
      window.addEventListener('hha:quest', e=>{
        $('#badgeQuest').textContent = e?.detail?.text || 'Mini Quest';
      });
      window.addEventListener('hha:miss', e=>{
        const el = $('#badgeMiss'); el.style.display='';
        const n = (e?.detail?.count ?? (parseInt(el.dataset.n||'0',10)+1));
        el.dataset.n=n; el.textContent = `พลาด: ${n} ครั้ง`;
      });
      // Fever bar
      const fill = document.getElementById('feverFill');
      window.addEventListener('hha:fever', e=>{
        const d=e?.detail||{}; const st=d.state||'change';
        const pct = Math.max(0,Math.min(100, Math.round(d.level||0)));
        if(st==='start'){ document.body.classList.add('fever-on'); fill.style.background='linear-gradient(90deg,#ffb703,#fb5607)'; fill.style.width='100%'; }
        else if(st==='end'){ document.body.classList.remove('fever-on'); fill.style.background='linear-gradient(90deg,#37d67a,#06d6a0)'; fill.style.width='0%'; }
        else { fill.style.width = pct+'%'; }
      });
      // จบเกม → แสดงเมนู
      window.addEventListener('hha:end', ()=>{ const m=$('#menu'); if(m) m.style.display=''; });
    })();

    // ตัวโหลดโหมด + เช็กไฟล์
    (function(){
      const $ = s => document.querySelector(s);
      const withStamp = url => url + (url.includes('?')?'&':'?') + 'v=' + Date.now();

      // ไฟล์ของแต่ละโหมด (แก้ path ให้ตรงโปรเจ็กต์คุณ)
      const MAP = {
        goodjunk : './modes/goodjunk.safe.js',
        groups   : './modes/groups.safe.js',
        hydration: './modes/hydration.quest.js',
        plate    : './modes/plate.quest.js'
      };

      async function probe(url){
        try{ const r = await fetch(url, {method:'HEAD', cache:'no-store'}); return r.ok; }
        catch{ return false; }
      }
      async function checkAll(){
        const warn = $('#modeWarn'); const missing=[];
        for(const [k,p] of Object.entries(MAP)){
          const u = new URL(p, location.href).toString();
          if(!(await probe(u))) missing.push(`${k} → ${p}`);
        }
        if(missing.length){ warn.style.display='block'; warn.textContent='ไฟล์โหมดที่ขาด: ' + missing.join(' | '); }
        else { warn.style.display='none'; warn.textContent=''; }
      }
      checkAll();

      $('#startBtn').addEventListener('click', async ()=>{
        const mode = $('#modeSel').value;
        const diff = $('#diffSel').value;

        // reset HUD
        $('#badgeScore').textContent='คะแนน: 0 | คอมโบ: x0';
        $('#badgeTime').textContent='เวลา: 60s';
        $('#badgeQuest').textContent='Mini Quest — กำลังเริ่ม…';
        const miss=$('#badgeMiss'); miss.style.display='none'; miss.dataset.n='0';
        document.body.classList.remove('fever-on');
        const f=document.getElementById('feverFill'); if(f) f.style.width='0%';

        // ซ่อนเมนู
        $('#menu').style.display='none';

        const path = MAP[mode] || MAP.goodjunk;
        try{
          const mod = await import(withStamp(path));
          if(!mod || typeof mod.boot!=='function') throw new Error('โมดูลไม่มี boot()');
          await mod.boot({
            host: document.getElementById('spawnHost'),
            difficulty: diff,
            duration: 60
          });
        }catch(err){
          alert('โหลดโหมดไม่สำเร็จ: ' + (err?.message || err));
          console.error(err);
          $('#menu').style.display='';
          checkAll();
        }
      });
    })();
  </script>
</body>
</html>
