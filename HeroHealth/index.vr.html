<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health VR ‚Äî Nutrition Suite</title>
  <meta name="color-scheme" content="light dark"/>
  <style>
    body{margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
    .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px}
    .fallback strong{color:#9ff}
  </style>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script type="module" src="./vr/emoji-sprite.js"></script>
  <script type="module" src="./vr/miniquest.js"></script>
  <script type="module" src="./vr/game-router.js"></script>
</head>
<body>
  <div class="fallback" id="bootStatus">
    <div><strong>Status:</strong> Booting‚Ä¶ (?mode=goodjunk|groups|hydration|plate & goal=30|40|50)</div>
    <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">
      Force Start
    </button>
  </div>

  <a-scene background="color: #0b1324" renderer="colorManagement: true; physicallyCorrectLights: true" vr-mode-ui="enterVRButton: true">

    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>
    <a-sky color="#0b1324"></a-sky>

    <!-- HUD (‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏á‡∏õ‡∏¥‡∏î depthTest/depthWrite ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏á‡∏≤‡∏î‡∏≥‡∏ã‡πâ‡∏≠‡∏ô) -->
    <a-entity id="hud" position="0 2.2 -2">
      <a-entity geometry="primitive: plane; width: 1.8; height: 0.26"
                material="color:#111a33; opacity:0.88; depthTest:false; depthWrite:false"></a-entity>
      <a-text id="tTime"  value="‡πÄ‡∏ß‡∏•‡∏≤: 60s" position="-0.84 0.07 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tScore" value="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0"   position="-0.84 -0.03 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tCombo" value="‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x1"  position="0.15 -0.03 0.01"  align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tStat"  value="READY"       position="0.15 0.07 0.01"   align="left" width="2.4" color="#7ea8ff"></a-text>

      <!-- Mission -->
      <a-entity position="0 -0.23 0">
        <a-entity geometry="primitive: plane; width: 1.8; height: 0.08"
                  material="color:#1b2752; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
        <a-entity id="missionFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.9 0 0.01"
                  material="color:#23a4ff; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
        <a-text id="tMission" value="‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: 0/40" position="-0.88 -0.005 0.02" align="left" width="2.4" color="#dff"></a-text>
      </a-entity>

      <!-- Streak + Fever -->
      <a-entity position="0 -0.42 0">
        <a-entity geometry="primitive: plane; width: 1.8; height: 0.08"
                  material="color:#1b2752; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
        <a-text id="tStreak" value="Streak: 0" position="-0.88 -0.005 0.02" align="left" width="2.4" color="#ffd54f"></a-text>
        <a-entity id="feverBg" geometry="primitive: plane; width: 0.9; height: 0.06" position="0.45 0 0.01"
                  material="color:#1b2752; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
        <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.06" position="0.0 0 0.02"
                  material="color:#ff9043; opacity:0.95; depthTest:false; depthWrite:false"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Mini Quest Panel -->
    <a-entity id="questPanel" position="0 1.62 -2">
      <a-entity geometry="primitive: plane; width: 1.8; height: 0.28"
                material="color:#111a33; opacity:0.85; depthTest:false; depthWrite:false"></a-entity>
      <a-text value="Mini Quests" position="-0.84 0.09 0.01" align="left" width="2.4" color="#ffd54f"></a-text>
      <a-text id="tQ1" value="-" position="-0.84 -0.01 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tQ2" value="-" position="-0.84 -0.08 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
      <a-text id="tQ3" value="-" position="-0.84 -0.15 0.01" align="left" width="2.4" color="#e8f0ff"></a-text>
    </a-entity>

    <!-- Start / Result Panels (‡∏õ‡∏¥‡∏î depth ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô) -->
    <a-entity id="startPanel" position="0 1.4 -1.2">
      <a-plane id="startBtn" width="0.8" height="0.24" color="#2e8b57" class="clickable"
               material="depthTest:false; depthWrite:false"
               onclick="(function(){window.__HARD_START__&&window.__HARD_START__();})();"></a-plane>
      <a-text value="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°" position="-0.22 0 0.01" width="2" color="#fff"></a-text>
    </a-entity>

    <a-entity id="resultPanel" position="0 1.6 -1.3" visible="false">
      <a-plane width="1.2" height="0.6" color="#111a33" opacity="0.95" material="depthTest:false; depthWrite:false"></a-plane>
      <a-text id="tResultTitle" value="RESULT" position="-0.5 0.22 0.01" width="2" color="#7ea8ff"></a-text>
      <a-text id="tResultBody"  value="-"      position="-0.5 0.04 0.01"  width="2" color="#e8f0ff"></a-text>
      <a-plane id="restartBtn" position="0 -0.18 0.01" width="0.6" height="0.2" color="#2e8b57" class="clickable"
               material="depthTest:false; depthWrite:false"></a-plane>
      <a-text value="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" position="-0.24 -0.18 0.02" width="1.6" color="#fff"></a-text>
    </a-entity>

    <!-- Camera + cursor -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls wasd-controls="acceleration: 40"
        cursor="rayOrigin: mouse; fuse: false"
        raycaster="objects: .clickable, .target; far: 6">
        <a-entity position="0 0 -1" geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                  material="color: #9fd; shader: flat; depthTest:false; depthWrite:false"></a-entity>
      </a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable, .target; far: 6"></a-entity>
    </a-entity>

    <!-- Sounds -->
    <a-entity id="sfx" position="0 1.6 0">
      <a-sound id="coach_start" src="url(assets/audio/coach_start_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_good"  src="url(assets/audio/coach_good_th.mp3)"  volume="1.0"></a-sound>
      <a-sound id="coach_warn"  src="url(assets/audio/coach_warn_th.mp3)"  volume="1.0"></a-sound>
      <a-sound id="coach_fever" src="url(assets/audio/coach_fever_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_quest" src="url(assets/audio/coach_quest_th.mp3)" volume="1.0"></a-sound>
      <a-sound id="coach_clear" src="url(assets/audio/coach_clear_th.mp3)" volume="1.0"></a-sound>

      <a-sound id="bgm"   src="url(assets/audio/bgm_loop.mp3)" autoplay="false" loop="true" volume="0.6"></a-sound>
      <a-sound id="sndPop" src="url(assets/audio/pop.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndBoo" src="url(assets/audio/boo.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndOk"  src="url(assets/audio/cheer_ok.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndWin" src="url(assets/audio/cheer_victory.mp3)" volume="1.0"></a-sound>
      <a-sound id="sndFvr" src="url(assets/audio/cheer_fever.mp3)" volume="1.0"></a-sound>
    </a-entity>

    <!-- Game zone: ‡∏ñ‡∏≠‡∏¢‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≤‡∏á HUD -->
    <a-entity id="spawnZone" position="0 1.3 -3.2"></a-entity>
    <a-entity id="game" game-manager="goal: 40; duration: 60"></a-entity>
  </a-scene>

  <!-- Hard-start + Safety fallback -->
  <script>
    (function(){
      const statusEl = document.getElementById('bootStatus');
      const setStatus = (t)=>{ if(statusEl) statusEl.firstElementChild.innerHTML = '<strong>Status:</strong> '+t; };

      const url = new URL(location.href);
      let GOAL = Number(url.searchParams.get('goal') ?? 40); if(!Number.isFinite(GOAL)) GOAL = 40;
      let DURA = Number(url.searchParams.get('time') ?? 60); if(!Number.isFinite(DURA)) DURA = 60;

      function getGM(){ return document.querySelector('[game-manager]')?.components?.['game-manager'] || null; }

      // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ component ‡∏Ç‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ fallback ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
      if (!AFRAME.components['game-manager']) {
        console.warn('[HHA] Using SAFETY game-manager fallback');
        AFRAME.registerComponent('game-manager', {
          schema:{goal:{default:GOAL}, duration:{default:DURA}},
          init:function(){
            this.running=false; this.timeLeft=this.data.duration;
            this.score=0; this.combo=1; this.streak=0; this.goodHits=0;
            const byId=(id)=>document.getElementById(id);
            this.tTime=byId('tTime'); this.tScore=byId('tScore'); this.tCombo=byId('tCombo');
            this.tStat=byId('tStat'); this.tMission=byId('tMission'); this.missionFill=byId('missionFill');
            this.tStreak=byId('tStreak'); this.spawn=document.getElementById('spawnZone');
            byId('startBtn')?.addEventListener('click', ()=>this.start());
            byId('restartBtn')?.addEventListener('click', ()=>this.start());
            document.querySelector('a-scene')?.addEventListener('click', ()=>{ if(!this.running) this.start(); }, {once:true});
            this._updateHUD('READY');
          },
          start:function(){
            if(this.running)return;
            this.running=true; this.timeLeft=this.data.duration; this.score=0; this.combo=1; this.streak=0; this.goodHits=0;
            this._updateHUD('PLAY');
            this._tickTimer=setInterval(()=>{ this.timeLeft--; this._updateHUD(); if(this.timeLeft<=0) this.end(); },1000);
            this._spawnLoop();
            try{ document.getElementById('bgm')?.components.sound.playSound(); }catch(e){}
          },
          end:function(){
            this.running=false; clearInterval(this._tickTimer); this._tickTimer=null; this._updateHUD('END');
            const res=document.getElementById('resultPanel'); if(res) res.setAttribute('visible', true);
            const body=document.getElementById('tResultBody');
            if(body) body.setAttribute('value', `Score: ${this.score}\nGood: ${this.goodHits}/${this.data.goal}`);
          },
          _spawnLoop:function(){
            if(!this.running) return;
            const e=document.createElement('a-entity');
            e.setAttribute('emoji-sprite', {char: this._pickEmoji(), size: 0.55});
            // ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ + ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô depth ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏á‡∏≤‡∏î‡∏≥
            e.setAttribute('material', 'transparent: true; alphaTest: 0.05; depthWrite: false');
            // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡∏ä‡∏ô HUD)
            const x=(Math.random()-0.5)*1.6, y=1.0+Math.random()*0.5, z=-3.2;
            e.setAttribute('position', `${x} ${y} ${z}`);
            e.classList.add('target','clickable');
            const good = Math.random()>0.35; // 65% good
            e.dataset.good = good ? '1' : '0';
            e.addEventListener('click', ()=>{
              if(!this.running) return;
              if (e._dead) return; e._dead=true;
              e.remove();
              if (good){
                this.goodHits++; this.score += 10*this.combo; this.combo++; this.streak++;
                if (this.goodHits>=this.data.goal) this.end();
              } else {
                this.combo=1; this.streak=0;
              }
              this._updateHUD();
            });
            this.spawn.appendChild(e);
            setTimeout(()=>{ e?.remove?.(); }, 2200+Math.random()*1200);
            setTimeout(()=>this._spawnLoop(), 360+Math.random()*240);
          },
          _pickEmoji:function(){
            const GOOD=['üçé','üçì','üçá','ü•¶','ü•ï','üçÖ','ü•¨','üçä','üçå','ü´ê','üçê','üçç','üçã','üçâ','ü•ù','üçö','ü•õ','üçû','üêü','ü•ó'];
            const JUNK=['üçî','üçü','üçï','üç©','üç™','üßÅ','ü•§','üßã','ü•ì','üç´','üå≠'];
            return (Math.random()>0.35?GOOD:JUNK)[Math.floor(Math.random()*20)% (Math.random()>0.35?GOOD.length:JUNK.length)];
          },
          _updateHUD:function(state){
            if (state) this.tStat?.setAttribute('value', state);
            this.tTime?.setAttribute('value', `‡πÄ‡∏ß‡∏•‡∏≤: ${this.timeLeft}s`);
            this.tScore?.setAttribute('value', `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${this.score}`);
            this.tCombo?.setAttribute('value', `‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x${this.combo}`);
            this.tMission?.setAttribute('value', `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${this.goodHits}/${this.data.goal}`);
            const w=Math.max(0,Math.min(1,this.goodHits/this.data.goal))*1.8;
            this.missionFill?.setAttribute('geometry', {primitive:'plane', width:w, height:0.08});
            this.tStreak?.setAttribute('value', `Streak: ${this.streak}`);
          }
        });
        const game=document.getElementById('game');
        if (game && !game.getAttribute('game-manager')) game.setAttribute('game-manager', `goal: ${GOAL}; duration: ${DURA}`);
      } else {
        console.log('[HHA] External game-manager found');
      }

      function startWithRetry(msLeft=10000){
        const gm=getGM();
        if (gm && !gm.running){ try{ gm.start(); setStatus('Started ‚úÖ'); return; }catch(e){ console.error(e); setStatus('Error: '+e.message); } }
        if (msLeft<=0){ setStatus('Failed ‚ùå'); return; }
        setStatus('Waiting for game‚Ä¶ ('+Math.ceil(msLeft/1000)+'s)');
        setTimeout(()=>startWithRetry(msLeft-250),250);
      }
      window.__HARD_START__=()=>startWithRetry(10000);

      window.addEventListener('DOMContentLoaded', ()=>{
        setStatus('Loaded (press Start / Space / Enter)');
        document.getElementById('forceStartBtn')?.addEventListener('click', window.__HARD_START__);
        const scene=document.querySelector('a-scene');
        scene?.addEventListener('click', ()=>window.__HARD_START__());
        window.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter') window.__HARD_START__(); });
      });
    })();
  </script>
</body>
</html>
