<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Hero Health Academy — VR</title>

  <!-- กัน 404 favicon -->
  <link rel="icon" href="data:,">

  <!-- A-Frame + patch แบบ onload (การันตีลำดับ) -->
  <script
    src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"
    onload="
      try {
        if (window.AFRAME && AFRAME.THREE) {
          window.THREE = AFRAME.THREE;
          if (!THREE.MathUtils && THREE.Math) THREE.MathUtils = THREE.Math;
          console.log('[Patch] THREE linked via onload');

          // โหลด Troika หลังจาก THREE พร้อมแล้วเท่านั้น
          var s = document.createElement('script');
          s.id = 'troika-js';
          s.src = 'https://unpkg.com/aframe-troika-text@0.12.0/dist/aframe-troika-text.min.js';
          document.head.appendChild(s);
        } else {
          console.warn('[Patch] AFRAME.THREE not available in onload');
        }
      } catch (e) { console.error('[Patch] onload error:', e); }
    ">
  </script>

  <style>
    :root{ --bg:#0b1324; --fg:#e8eefc; --chip:#0f172a99; --acc:#22c55e; --danger:#ef4444; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif;overflow:hidden;}
    a-scene{width:100%;height:100%;}
    .hud-chip{position:fixed;z-index:900;background:var(--chip);border:1px solid #475569;
      padding:8px 12px;border-radius:12px;backdrop-filter:blur(6px);font-weight:700}
    #badgeTime{left:12px;top:12px}
    #badgeScore{left:50%;top:12px;transform:translateX(-50%)}
    #badgeQuest{right:12px;top:12px}
    #badgeMiss{right:12px;top:64px;display:none}
    #log{position:fixed;left:8px;bottom:8px;z-index:900;background:#1e293b66;border:1px solid #475569;
      border-radius:10px;padding:4px 10px;font-size:14px;color:#e2e8f0}

    .a-enter-vr,.a-enter-vr-button{position:absolute !important;right:12px !important;bottom:12px !important;z-index:1000 !important}
    #vrBtn{position:fixed;right:14px;bottom:14px;z-index:999;background:#ffffff12;border:1px solid #4a5568;color:#fff;
      padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;backdrop-filter:blur(6px)}
    .xr-supported #vrBtn{display:none}

    .fever-on{ box-shadow: inset 0 0 0 4px #ffd16655; animation: feverPulse .9s ease-in-out infinite alternate; }
    @keyframes feverPulse{ from{ filter:none } to{ filter: drop-shadow(0 0 12px #ffd166) } }
  </style>
</head>
<body>

  <!-- HUD -->
  <div id="badgeTime"  class="hud-chip">เวลา: 60s</div>
  <div id="badgeScore" class="hud-chip">คะแนน: 0 | คอมโบ: x0</div>
  <div id="badgeQuest" class="hud-chip">Mini Quest — เตรียมเริ่ม</div>
  <div id="badgeMiss"  class="hud-chip">พลาด: 0 ครั้ง</div>
  <div id="log">log: --</div>

  <!-- A-Frame scene -->
  <a-scene id="scene" background="color: #0b1324">
    <a-assets></a-assets>

    <!-- กล้อง + cursor -->
    <a-entity id="cam"
      camera
      look-controls
      cursor="rayOrigin: mouse; fuse: false"
      raycaster="objects: .clickable; far: 6"
      position="0 1.6 0"></a-entity>

    <!-- โหนดสแปว์น -->
    <a-entity id="spawnHost" position="0 1.6 -1.6"></a-entity>
    <a-sky color="#0b1324"></a-sky>
  </a-scene>

  <!-- VR fallback button -->
  <button id="vrBtn" title="Enter VR">VR</button>

  <script>
    // กันลากหน้า
    document.addEventListener('touchmove', e => e.preventDefault(), {passive:false});

    // ตรวจ XR เพื่อซ่อนปุ่ม VR ถ้ารองรับ
    (function(){
      const set = flag => document.body.classList.add(flag ? 'xr-supported' : 'xr-unsupported');
      try{
        if (navigator.xr && navigator.xr.isSessionSupported)
          navigator.xr.isSessionSupported('immersive-vr').then(ok=>set(!!ok)).catch(()=>set(false));
        else set(false);
      }catch{ set(false); }
    })();

    // ปุ่ม VR
    (function(){
      const btn=document.getElementById('vrBtn');
      const sc=document.getElementById('scene');
      btn.addEventListener('click', ()=>{ try{ sc && sc.enterVR && sc.enterVR(); }catch(e){} });
    })();

    // ===== Loader & Event bridge =====
    (function(){
      const $=sel=>document.querySelector(sel);
      const log=msg=>$('#log').textContent='log: '+msg;

      const MAP={
        goodjunk:'./modes/goodjunk.safe.js',
        groups:'./modes/groups.safe.js',
        hydration:'./modes/hydration.quest.js',
        plate:'./modes/plate.quest.js'
      };

      // HUD listeners
      window.addEventListener('hha:score', e=>{
        const d=e.detail||{};
        $('#badgeScore').textContent=`คะแนน: ${d.score||0} | คอมโบ: x${d.combo||0}`;
      });
      window.addEventListener('hha:time', e=>{
        const t=Math.max(0,Math.round((e.detail&&e.detail.sec)||0));
        $('#badgeTime').textContent=`เวลา: ${t}s`;
      });
      window.addEventListener('hha:quest', e=>{
        $('#badgeQuest').textContent=(e.detail&&e.detail.text)||'Mini Quest';
      });
      window.addEventListener('hha:miss', e=>{
        const el=$('#badgeMiss'); el.style.display='';
        const n=(e.detail&&e.detail.count)!=null?e.detail.count:(parseInt(el.dataset.n||'0',10)+1);
        el.dataset.n=n; el.textContent='พลาด: '+n+' ครั้ง';
      });
      window.addEventListener('hha:fever', e=>{
        const st=(e.detail&&e.detail.state)||'end';
        document.body.classList.toggle('fever-on', st==='start');
      });

      function start(){
        log('Loading goodjunk...');
        import(MAP.goodjunk+'?v='+Date.now())
          .then(mod=>{
            if(!mod || !mod.boot) throw new Error('no boot()');
            log('goodjunk running');
            return mod.boot({host:$('#spawnHost'),difficulty:'normal',duration:60});
          })
          .catch(err=>{
            alert('โหลดโหมดไม่สำเร็จ: '+(err && err.message?err.message:err));
            console.error(err);
          });
      }

      const scene=$('#scene');
      if (scene && scene.hasLoaded) start();
      else if (scene) scene.addEventListener('loaded', ()=>setTimeout(start,150), {once:true});
      else start();
    })();
  </script>
</body>
</html>
