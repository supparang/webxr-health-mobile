<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health VR</title>
  <meta name="color-scheme" content="light dark"/>
  <!-- Core libs -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#0b1324}
    .selected{outline:3px solid #22c55e!important}
  </style>
</head>
<body>
  <a-scene renderer="antialias: true; colorManagement: true" vr-mode-ui="enabled: true">
    <a-sky color="#0b1324"></a-sky>
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.7" position="0 2 1"></a-entity>

    <!-- Camera -->
    <a-entity id="rig" position="0 0 0">
      <a-entity id="cam" camera position="0 1.6 0" look-controls cursor="rayOrigin: mouse"
                raycaster="objects: .clickable, a-link"></a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
    </a-entity>

    <!-- ===== HUD: Mini-Quest (บน) ===== -->
    <a-entity id="hudQuest" position="0 1.92 -1.0">
      <a-plane width="1.6" height="0.24" color="#111827" opacity="0.85" radius="0.04"></a-plane>
      <a-entity id="tQTitle" position="-0.72 0.06 0.001"
                troika-text="value: Mini Quest; color:#93c5fd; fontSize:0.08; maxWidth:1.5"></a-entity>
      <a-entity id="tQmain"  position="-0.72 -0.05 0.001"
                troika-text="value: -; color:#fff; fontSize:0.10; maxWidth:1.5"></a-entity>
    </a-entity>

    <!-- ===== HUD: Score/Time (ขวาบน) ===== -->
    <a-entity id="hudStats" position="0.95 1.75 -1.0">
      <a-plane width="0.62" height="0.26" color="#0f172a" opacity="0.85" radius="0.04"></a-plane>
      <a-entity id="hudScore" position="-0.27 0.05 0.001"
                troika-text="value: คะแนน: 0; color:#fff; fontSize:0.085; maxWidth:0.6"></a-entity>
      <a-entity id="hudTime" position="-0.27 -0.08 0.001"
                troika-text="value: เวลา: 60s; color:#a7f3d0; fontSize:0.08; maxWidth:0.6"></a-entity>
    </a-entity>

    <!-- ===== โซนสปอน (ล่างกลาง) ===== -->
    <a-entity id="spawnZone" position="0 1.0 0"></a-entity>

    <!-- ===== เมนู (กลางจอ) ===== -->
    <a-entity id="hubMenu" position="0 1.55 -1.05">
      <a-plane width="1.36" height="0.78" color="#111827" opacity="0.92" radius="0.08"></a-plane>
      <a-entity position="0 0.28 0.001"
                troika-text="value: HERO HEALTH — เลือกโหมดและระดับ; color:#fff; fontSize:0.12; anchor:center"></a-entity>

      <!-- โหมด -->
      <a-entity position="-0.55 0.12 0.001" troika-text="value: โหมด; color:#cbd5e1; fontSize:0.08"></a-entity>
      <a-plane id="m-goodjunk" class="clickable" position="-0.15 0.12 0.002" width="0.42" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="-0.15 0.12 0.003" troika-text="value: goodjunk; color:#fff; fontSize:0.09; anchor:center"></a-entity>
      <a-plane id="m-groups"   class="clickable" position="0.33 0.12 0.002" width="0.42" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="0.33 0.12 0.003" troika-text="value: groups; color:#fff; fontSize:0.09; anchor:center"></a-entity>
      <a-plane id="m-hydration"class="clickable" position="-0.15 -0.02 0.002" width="0.42" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="-0.15 -0.02 0.003" troika-text="value: hydration; color:#fff; fontSize:0.09; anchor:center"></a-entity>
      <a-plane id="m-plate"    class="clickable" position="0.33 -0.02 0.002" width="0.42" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="0.33 -0.02 0.003" troika-text="value: plate; color:#fff; fontSize:0.09; anchor:center"></a-entity>

      <!-- ระดับ -->
      <a-entity position="-0.55 -0.18 0.001" troika-text="value: ระดับ; color:#cbd5e1; fontSize:0.08"></a-entity>
      <a-plane id="d-easy"   class="clickable" position="-0.15 -0.18 0.002" width="0.28" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="-0.15 -0.18 0.003" troika-text="value: easy; color:#fff; fontSize:0.09; anchor:center"></a-entity>
      <a-plane id="d-normal" class="clickable" position="0.12 -0.18 0.002" width="0.28" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="0.12 -0.18 0.003" troika-text="value: normal; color:#fff; fontSize:0.09; anchor:center"></a-entity>
      <a-plane id="d-hard"   class="clickable" position="0.39 -0.18 0.002" width="0.28" height="0.16" color="#1f2937" radius="0.04"></a-plane>
      <a-entity position="0.39 -0.18 0.003" troika-text="value: hard; color:#fff; fontSize:0.09; anchor:center"></a-entity>

      <!-- Start -->
      <a-plane id="btnStart" class="clickable" position="0 -0.38 0.002" width="0.74" height="0.18" color="#22c55e" radius="0.06"></a-plane>
      <a-entity position="0 -0.38 0.003" troika-text="value: เริ่มเกม; color:#0b1324; fontSize:0.11; anchor:center"></a-entity>
    </a-entity>

    <!-- สถานะ/บั๊ก -->
    <a-entity id="bootStatus" position="-0.95 1.05 -1.0"
              troika-text="value: Status: Booting…; color:#9ca3af; fontSize:0.06; maxWidth:1.2"></a-entity>

    <!-- เสียง (ไม่บล็อกเรนเดอร์) -->
    <a-entity id="coach_start"  sound="src: url(./assets/audio/coach_start_th.mp3); poolSize: 1"></a-entity>
    <a-entity id="coach_clear"  sound="src: url(./assets/audio/coach_clear_th.mp3); poolSize: 1"></a-entity>
    <a-entity id="coach_good"   sound="src: url(./assets/audio/star.mp3); poolSize: 4"></a-entity>
    <a-entity id="coach_warn"   sound="src: url(./assets/audio/boo.mp3); poolSize: 4"></a-entity>
    <a-entity id="coach_fever"  sound="src: url(./assets/audio/fever_start.mp3); poolSize: 1"></a-entity>
    <a-entity id="coach_quest"  sound="src: url(./assets/audio/star.mp3); poolSize: 1"></a-entity>
  </a-scene>

  <!-- ===== Orchestrator (no external imports) ===== -->
  <script type="module">
    const statusEl = document.getElementById('bootStatus');
    const setStatus = (msg)=>{ try{ statusEl.setAttribute('troika-text', `value: ${msg}`); }catch{} };

    // ปุ่มเลือก
    const modeButtons = ['m-goodjunk','m-groups','m-hydration','m-plate'];
    const diffButtons = ['d-easy','d-normal','d-hard'];
    let selectedMode = 'goodjunk';
    let selectedDiff = 'normal';

    function setSelected(ids, id){
      ids.forEach(x=>{
        const el=document.getElementById(x);
        if(!el) return;
        if(x===id) el.classList.add('selected'); else el.classList.remove('selected');
      });
    }
    setSelected(modeButtons,'m-goodjunk');
    setSelected(diffButtons,'d-normal');

    document.getElementById('m-goodjunk').addEventListener('click', ()=>{ selectedMode='goodjunk'; setSelected(modeButtons,'m-goodjunk'); });
    document.getElementById('m-groups').addEventListener('click',   ()=>{ selectedMode='groups';   setSelected(modeButtons,'m-groups'); });
    document.getElementById('m-hydration').addEventListener('click',()=>{ selectedMode='hydration';setSelected(modeButtons,'m-hydration'); });
    document.getElementById('m-plate').addEventListener('click',    ()=>{ selectedMode='plate';    setSelected(modeButtons,'m-plate'); });

    document.getElementById('d-easy').addEventListener('click',   ()=>{ selectedDiff='easy';   setSelected(diffButtons,'d-easy'); });
    document.getElementById('d-normal').addEventListener('click', ()=>{ selectedDiff='normal'; setSelected(diffButtons,'d-normal'); });
    document.getElementById('d-hard').addEventListener('click',   ()=>{ selectedDiff='hard';   setSelected(diffButtons,'d-hard'); });

    // โหมด → ไฟล์ (ชี้พาธตรงกับโครง HeroHealth/)
    const MODE_URL = {
      goodjunk: './modes/goodjunk.safe.js',
      groups:   './modes/groups.safe.js',
      hydration:'./modes/hydration.safe.js',
      plate:    './modes/plate.safe.js'
    };

    // อัปเดตคะแนนแบบเบา ๆ
    window.addEventListener('hha:score', (e)=>{
      const {score=0, combo=0} = e.detail||{};
      const hud=document.getElementById('hudScore');
      if(hud) hud.setAttribute('troika-text', `value: คะแนน: ${score} (x${combo})`);
    });

    // Start
    document.getElementById('btnStart').addEventListener('click', async ()=>{
      try{
        setStatus('Status: Loading mode "'+selectedMode+'"…');
        document.getElementById('hubMenu')?.setAttribute('visible', false);

        const url = MODE_URL[selectedMode] || MODE_URL.goodjunk;
        const mod = await import(url + '?v=' + Date.now());
        if(!mod || typeof mod.boot!=='function') throw new Error('Mode has no boot()');

        await mod.boot({
          host: document.getElementById('spawnZone'),
          difficulty: selectedDiff,
          goal: 40
          // duration: ให้โหมดกำหนดตามระดับ
        });
        setStatus('Status: Mode loaded: '+selectedMode+' ('+selectedDiff+')');
      }catch(err){
        console.error(err);
        setStatus('Error: '+(err?.message||err));
        // Fallback → goodjunk
        try{
          const f = await import('./modes/goodjunk.safe.js?v='+Date.now());
          await f.boot({ host: document.getElementById('spawnZone'), difficulty: 'easy', goal: 30 });
          setStatus('Status: Fallback goodjunk (easy) started');
        }catch(e2){
          console.error('Fallback failed', e2);
          setStatus('Error: Fallback failed. Check paths under /HeroHealth/modes/*.safe.js');
        }
      }
    });

    // บู๊ตสำเร็จ
    setStatus('Status: Hub ready');
  </script>
</body>
</html>
