<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hero Health VR ‚Äî Nutrition (Offline Emoji)</title>
<meta name="color-scheme" content="light dark"/>

<style>
  html,body{height:100%;margin:0;background:#0b1324;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial}
  .fallback{position:fixed;left:12px;bottom:12px;padding:8px 10px;background:#111a33;color:#cfe;border-radius:10px;z-index:10}
  .fallback strong{color:#9ff}
  .ver{position:fixed;right:10px;bottom:10px;opacity:0.6;font-size:12px}
  button{font:600 14px/1.2 system-ui,Segoe UI,Inter}
</style>

<!-- A-Frame & Troika (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° HUD/‡πÄ‡∏°‡∏ô‡∏π) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

<!-- helpers: render on-top + billboard -->
<script>
AFRAME.registerComponent('front-most', {
  schema:{order:{default:10000}},
  init(){
    const apply=(o)=>{ o.traverse(n=>{ if(n.material){ n.material.depthTest=false; n.material.depthWrite=false; n.renderOrder=this.data.order; }}); };
    if(this.el.object3D) apply(this.el.object3D);
    this.el.addEventListener('object3dset',()=>apply(this.el.object3D));
  }
});
AFRAME.registerComponent('billboard', {
  tick(){ const cam=document.getElementById('camera'); if(cam){ this.el.object3D.lookAt(cam.object3D.position); } }
});
</script>
</head>
<body>
<div class="fallback" id="bootStatus"><div><strong>Status:</strong> Booting‚Ä¶</div>
  <button id="forceStartBtn" style="margin-top:6px;background:#2e8b57;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Force Start</button>
  <button id="dbgSpawn10" style="margin-left:6px;background:#0b7bd6;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Spawn x10 (Debug)</button>
</div>
<div class="ver">HeroHealth VR ‚Äî Offline Emoji</div>

<a-scene background="color:#0b1324" vr-mode-ui="enterVRButton:true"
         renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true">
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
  <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
  <a-sky color="#0b1324"></a-sky>

  <!-- HUD -->
  <a-entity id="hudRoot" position="0 2.18 -2.8" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.30"
              material="color:#111a33; opacity:0.9;"></a-entity>
    <a-entity id="hudMode"  troika-text="value: ‡πÇ‡∏´‡∏°‡∏î: -; color:#9fd; fontSize:0.06;" position="-0.9 0.08 0.05"></a-entity>
    <a-entity id="hudTime"  troika-text="value: ‡πÄ‡∏ß‡∏•‡∏≤: 60s; color:#fff; fontSize:0.06;" position="-0.9 -0.02 0.05"></a-entity>
    <a-entity id="hudScore" troika-text="value: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0; color:#fff; fontSize:0.06;" position="0.15 0.08 0.05"></a-entity>
    <a-entity id="hudCombo" troika-text="value: ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x1; color:#fff; fontSize:0.06;" position="0.15 -0.02 0.05"></a-entity>

    <!-- Fever bar -->
    <a-entity position="0 -0.20 0">
      <a-entity geometry="primitive: plane; width: 1.9; height: 0.08"
                material="color:#1b2752; opacity:0.95;"></a-entity>
      <a-entity id="feverFill" geometry="primitive: plane; width: 0.0; height: 0.08" position="-0.95 0 0.06"
                material="color:#ff6600; opacity:0.95;"></a-entity>
      <a-entity id="feverLbl" troika-text="value: Fever 0%; color:#ffd54f; fontSize:0.06;" position="-0.92 -0.01 0.08"></a-entity>
    </a-entity>

    <!-- Buttons -->
    <a-entity id="pauseBtn" class="clickable" position="-0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#5b2b2b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: Pause; color:#fff; fontSize:0.045;" position="-0.95 0.095 0.08"></a-entity>

    <a-entity id="langBtn" class="clickable" position="0.88 0.10 0.06"
      geometry="primitive: plane; width:0.18; height:0.08"
      material="color:#243a6b; opacity:0.9"></a-entity>
    <a-entity troika-text="value: TH/EN; color:#fff; fontSize:0.045;" position="0.80 0.095 0.08"></a-entity>
  </a-entity>

  <!-- Mini Quest -->
  <a-entity id="questPanel" position="0 1.65 -2.8" visible="false" front-most="order:10000">
    <a-entity geometry="primitive: plane; width: 1.9; height: 0.28"
              material="color:#111a33; opacity:0.88; transparent:true;"></a-entity>
    <a-entity troika-text="value: Mini Quests; color:#ffd54f; fontSize:0.07;" position="-0.9 0.09 0.05"></a-entity>
    <a-entity id="tQ" troika-text="value: ; color:#e8f0ff; fontSize:0.06;" position="-0.9 -0.06 0.05"></a-entity>
  </a-entity>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏´‡∏°‡∏î -->
  <a-entity id="modeMenu" position="0 1.35 -1.0" front-most="order:10001">
    <a-entity geometry="primitive: plane; width: 1.05; height: 0.80"
              material="color:#0e1b38; opacity:0.95; transparent:true"></a-entity>
    <a-entity troika-text="value: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°; color:#9fd; fontSize:0.065;" position="-0.40 0.30 0.26"></a-entity>
    <a-entity troika-text="value: ‡∏î‡∏µ  vs  ‡∏Ç‡∏¢‡∏∞; color:#fff; fontSize:0.058;" position="-0.38 0.15 0.26"></a-entity>
    <a-entity troika-text="value: ‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£; color:#fff; fontSize:0.058;" position="0.06 0.15 0.26"></a-entity>
    <a-entity troika-text="value: ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡πâ‡∏≥; color:#fff; fontSize:0.058;" position="-0.38 -0.06 0.26"></a-entity>
    <a-entity troika-text="value: ‡∏à‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û; color:#fff; fontSize:0.058;" position="0.06 -0.06 0.26"></a-entity>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î -->
    <a-plane class="clickable" data-mode="goodjunk" position="-0.16 0.15 0.24" width="0.46" height="0.18"
             material="color:#00ff88; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="groups" position="0.40 0.15 0.24" width="0.46" height="0.18"
             material="color:#00aaff; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="hydration" position="-0.16 -0.06 0.24" width="0.46" height="0.18"
             material="color:#ffd400; opacity:0.12"></a-plane>
    <a-plane class="clickable" data-mode="plate" position="0.40 -0.06 0.24" width="0.46" height="0.18"
             material="color:#ff6a6a; opacity:0.12"></a-plane>

    <!-- ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö -->
    <a-entity id="diffRow" position="0 -0.32 0.24">
      <a-entity troika-text="value: ‡∏£‡∏∞‡∏î‡∏±‡∏ö:; color:#9fd; fontSize:0.058;" position="-0.50 0.00 0.02"></a-entity>

      <a-plane id="btnDiffEasy"   class="clickable" position="-0.10 0.00 0.00" width="0.28" height="0.14"
               material="color:#2e8b57; opacity:0.95"></a-plane>
      <a-entity troika-text="value: ‡∏á‡πà‡∏≤‡∏¢; color:#fff; fontSize:0.055;" position="-0.18 -0.005 0.02"></a-entity>

      <a-plane id="btnDiffNormal" class="clickable" position="0.22 0.00 0.00" width="0.32" height="0.14"
               material="color:#3a4b77; opacity:0.75"></a-plane>
      <a-entity troika-text="value: ‡∏õ‡∏Å‡∏ï‡∏¥; color:#fff; fontSize:0.055;" position="0.10 -0.005 0.02"></a-entity>

      <a-plane id="btnDiffHard"   class="clickable" position="0.58 0.00 0.00" width="0.28" height="0.14"
               material="color:#7a263a; opacity:0.70"></a-plane>
      <a-entity troika-text="value: ‡∏¢‡∏≤‡∏Å; color:#fff; fontSize:0.055;" position="0.50 -0.005 0.02"></a-entity>
    </a-entity>
  </a-entity>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° -->
  <a-entity id="startPanel" position="0 0.72 -1.15" visible="false" front-most="order:10000">
    <a-plane id="startBtn" class="clickable" position="0 0 0.30"
             width="0.90" height="0.24"
             material="color:#2e8b57; transparent:true; opacity:1.0"></a-plane>
    <a-entity id="startBtnFx" position="0 0 0.31"
              geometry="primitive: plane; width:0.92; height:0.26"
              material="color:#ffffff; opacity:0.0; transparent:true"></a-entity>
    <a-entity id="startLbl" troika-text="value: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô; color:#fff; fontSize:0.058;"
              position="-0.27 0 0.40"></a-entity>
  </a-entity>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
  <a-entity id="resultPanel" visible="false" position="0 1.4 -1.8" front-most="order:10002">
    <a-plane width="1.8" height="1.0" color="#0e1b38" opacity="0.94"></a-plane>
    <a-entity troika-text="value: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏Å‡∏°; color:#9fd; fontSize:0.08;" position="-0.5 0.38 0.05"></a-entity>
    <a-entity id="resultScore" troika-text="value: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: 0; color:#fff; fontSize:0.07;" position="-0.5 0.20 0.05"></a-entity>
    <a-entity id="resultCombo" troika-text="value: ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0; color:#fff; fontSize:0.07;" position="-0.5 0.05 0.05"></a-entity>
    <a-entity id="resultQuest" troika-text="value: ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: 0/3; color:#fff; fontSize:0.07;" position="-0.5 -0.10 0.05"></a-entity>

    <a-plane id="retryBtn" class="clickable" position="-0.40 -0.35 0.06" width="0.6" height="0.18"
             material="color:#2e8b57; opacity:0.95;"></a-plane>
    <a-entity troika-text="value: ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á; color:#fff; fontSize:0.06;" position="-0.57 -0.34 0.08"></a-entity>

    <a-plane id="menuBtn" class="clickable" position="0.45 -0.35 0.06" width="0.6" height="0.18"
             material="color:#3a4b77; opacity:0.95;"></a-plane>
    <a-entity troika-text="value: ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π; color:#fff; fontSize:0.06;" position="0.27 -0.34 0.08"></a-entity>
  </a-entity>

  <!-- Rig/Camera -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="camera"
              camera look-controls
              cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 550"
              raycaster="objects: .hitbox, .clickable; far: 6; interval: 0">
      <a-entity id="aimRing" position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                material="color:#9fd; shader: flat; depthTest:false; depthWrite:false"></a-entity>
    </a-entity>
    <a-entity laser-controls="hand: right"
              raycaster="objects: .hitbox, .clickable; far: 6; interval: 0"></a-entity>
  </a-entity>

  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏° -->
  <a-entity id="spawnZone" position="0 1.00 -3.80"></a-entity>
  <a-entity id="fxLayer" position="0 0 0"></a-entity>
</a-scene>

<!-- App wiring / Emoji canvas / Fallback inline GoodJunk -->
<script>
// ===== Utils =====
function logBoot(msg){
  const box=document.getElementById('bootStatus');
  if(box) box.firstElementChild.innerHTML='<strong>Status:</strong> '+msg;
  console.log('[HVR]',msg);
}

// Emoji ‚Üí dataURL (offline)
function emojiDataUrl(char, sizePx = 256) {
  const c = document.createElement('canvas');
  c.width = c.height = sizePx;
  const ctx = c.getContext('2d');
  const fontStack = '"Noto Color Emoji","Segoe UI Emoji","Apple Color Emoji","Twemoji Mozilla",system-ui,sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = `900 ${Math.floor(sizePx*0.68)}px ${fontStack}`;
  ctx.shadowColor = 'rgba(0,0,0,.18)';
  ctx.shadowBlur = sizePx*0.04;
  ctx.fillText(char, sizePx/2, Math.floor(sizePx*0.53));
  return c.toDataURL('image/png');
}

// Audio unlock
let _ctx;
function getAudioCtx(){ if(_ctx) return _ctx; const AC = window.AudioContext||window.webkitAudioContext; _ctx = new AC(); return _ctx; }
['click','touchstart','pointerdown','keydown'].forEach(ev=>{
  window.addEventListener(ev,()=>{ try{ getAudioCtx().resume(); }catch{} }, {once:true});
});

// Pause/Resume
(function(){
  let paused=false;
  function setPaused(v){ if(paused===v) return; paused=v; window.dispatchEvent(new CustomEvent(v?'hha:pause':'hha:resume')); logBoot(v?'Paused':'Resumed'); }
  window.addEventListener('visibilitychange',()=>setPaused(document.hidden));
  window.addEventListener('blur',()=>setPaused(true));
  window.addEventListener('focus',()=>setPaused(false));
  document.getElementById('pauseBtn').addEventListener('click',()=>setPaused(!paused));
})();

// i18n
const i18n = {
  th: { mode:'‡πÇ‡∏´‡∏°‡∏î', time:'‡πÄ‡∏ß‡∏•‡∏≤', score:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', start:'‡πÄ‡∏£‡∏¥‡πà‡∏°', quests:'Quests' },
  en: { mode:'Mode', time:'Time', score:'Score', start:'Start', quests:'Quests' }
};
let lang='th';
document.getElementById('langBtn').addEventListener('click', ()=>{
  lang = (lang==='th'?'en':'th');
  document.getElementById('hudMode') .setAttribute('troika-text','value', (i18n[lang].mode||'Mode')+': -');
  document.getElementById('hudTime') .setAttribute('troika-text','value', (i18n[lang].time||'Time')+': 60s');
  document.getElementById('hudScore').setAttribute('troika-text','value', (i18n[lang].score||'Score')+': 0');
});

// Difficulty UI
let selectedDifficulty = 'easy';
function setDiffUI(d){
  selectedDifficulty = d;
  const set = (id,active,color,on=0.95,off=0.60)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.setAttribute('material', `color:${color}; opacity:${active?on:off}`);
  };
  set('btnDiffEasy',   d==='easy',   '#2e8b57');
  set('btnDiffNormal', d==='normal', '#3a4b77');
  set('btnDiffHard',   d==='hard',   '#7a263a');

  const hud = document.getElementById('hudMode');
  if(hud){
    const cur = hud.getAttribute('troika-text')?.value || '‡πÇ‡∏´‡∏°‡∏î: -';
    const noDiff = cur.replace(/\s*\(‡∏£‡∏∞‡∏î‡∏±‡∏ö:.*\)$/,'');
    hud.setAttribute('troika-text', `value: ${noDiff} (‡∏£‡∏∞‡∏î‡∏±‡∏ö:${d})`);
  }
}
window.addEventListener('DOMContentLoaded', ()=> setDiffUI(selectedDifficulty));

// HUD helpers
function setHudTime(sec){ document.getElementById('hudTime').setAttribute('troika-text','value',(i18n[lang].time||'Time')+': '+sec+'s'); }
function setHudScore(sc){ document.getElementById('hudScore').setAttribute('troika-text','value', (i18n[lang].score||'Score')+': '+sc); }
function setHudCombo(c){ document.getElementById('hudCombo').setAttribute('troika-text','value','‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: x'+Math.max(1,c)); }
function setHudFever(p){
  const bar = document.getElementById('feverFill');
  if (bar) bar.setAttribute('geometry','width', (Math.max(0,Math.min(1,p))*1.9));
  const label = document.getElementById('feverLbl');
  if (label) label.setAttribute('troika-text','value','Fever ' + Math.round(p*100) + '%');
}
function burst3D(host, pos=[0,0,0], color='#7ee'){
  for(let i=0;i<10;i++){
    const piece = document.createElement('a-entity');
    piece.setAttribute('geometry','primitive: box; depth: 0.02; height: 0.02; width: 0.02');
    piece.setAttribute('material',`color:${color}; opacity:0.95; transparent:true`);
    piece.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    const dx = (Math.random()*0.6-0.3).toFixed(2);
    const dy = (Math.random()*0.6-0.2).toFixed(2);
    const dz = (Math.random()*0.2+0.05).toFixed(2);
    piece.setAttribute('animation__move', `property: position; to: ${(+pos[0]+ +dx)} ${(+pos[1]+ +dy)} ${(+pos[2]+ +dz)}; dur: 450; easing: easeOutQuad`);
    piece.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 420; delay:80; easing: linear');
    host.appendChild(piece);
    setTimeout(()=>piece.remove(), 520);
  }
}
function popupScore(host, pos=[0,0,0], text='+1', color='#7CFC00'){
  const node = document.createElement('a-entity');
  node.setAttribute('troika-text', `value: ${text}; color:${color}; fontSize:0.06; anchor:center;`);
  node.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]+0.02}`);
  node.setAttribute('animation__rise', `property: position; to: ${pos[0]} ${(+pos[1]+0.24).toFixed(2)} ${pos[2]+0.02}; dur:600; easing:easeOutQuad`);
  node.setAttribute('animation__fade', `property: opacity; to: 0; dur: 500; delay:100; easing: linear`);
  host.appendChild(node);
  setTimeout(()=>node.remove(), 700);
}

// Menu wiring
function wireClicks(){
  const hub=()=>window.__hub;

  // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
  const bind = (id, diff)=> {
    const el = document.getElementById(id);
    if(!el) return;
    ['click','mousedown','mouseup','triggerdown','touchstart','pointerdown']
      .forEach(ev=> el.addEventListener(ev, ()=> setDiffUI(diff)));
  };
  bind('btnDiffEasy','easy'); bind('btnDiffNormal','normal'); bind('btnDiffHard','hard');

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    const mode=btn.getAttribute('data-mode');
    const onPick=()=>{
      if(hub() && typeof hub().selectMode==='function') hub().selectMode(mode);
      const lbl=document.getElementById('startLbl');
      if(lbl) lbl.setAttribute('troika-text','value','‡πÄ‡∏£‡∏¥‡πà‡∏°: '+mode.toUpperCase());
      document.getElementById('startPanel').setAttribute('visible',true);
      logBoot('Picked mode: '+mode);
      document.getElementById('hudMode').setAttribute('troika-text','value',(i18n[lang].mode||'Mode')+': '+mode+' (‡∏£‡∏∞‡∏î‡∏±‡∏ö:'+selectedDifficulty+')');
    };
    ['click','mousedown','mouseup','triggerdown','touchstart','pointerdown'].forEach(ev=>btn.addEventListener(ev,onPick));
  });

  // ‡∏õ‡∏∏‡πà‡∏° Start
  const start=document.getElementById('startBtn');
  const fx=document.getElementById('startBtnFx');
  start?.addEventListener('mouseenter',()=>fx.setAttribute('material','opacity',0.08));
  start?.addEventListener('mouseleave',()=>fx.setAttribute('material','opacity',0.0));

  const tryStart=async ()=>{
    logBoot('Start pressed: diff='+selectedDifficulty);

    if(hub()){
      if(typeof hub().setDifficulty==='function') hub().setDifficulty(selectedDifficulty);
      if(typeof hub().startGame==='function'){ hub().startGame(); gotoPlayUI(); return; }
      if(typeof hub().start==='function'){ hub().start(); gotoPlayUI(); return; }
      if(typeof hub().begin==='function'){ hub().begin(); gotoPlayUI(); return; }
    }
    inlineGoodJunkBoot({
      host: document.getElementById('spawnZone'),
      duration: 60,
      difficulty: selectedDifficulty
    });
    gotoPlayUI();
  };

  function gotoPlayUI(){
    document.getElementById('modeMenu').setAttribute('visible', false);
    document.getElementById('startPanel').setAttribute('visible', false);
  }

  ['click','mousedown','mouseup','triggerdown','touchstart','pointerdown']
    .forEach(ev=> start?.addEventListener(ev,tryStart));

  document.getElementById('forceStartBtn')?.addEventListener('click', tryStart);

  // Debug
  document.getElementById('dbgSpawn10')?.addEventListener('click', ()=>{
    if(typeof window.__HHA_DEBUG_SPAWN10==='function') window.__HHA_DEBUG_SPAWN10();
  });
}
if(document.readyState!=='loading') setTimeout(wireClicks,0);
else window.addEventListener('DOMContentLoaded',()=>setTimeout(wireClicks,0));

// Keyboard shortcut for difficulty
window.addEventListener('keydown',(e)=>{
  if(e.key==='1') setDiffUI('easy');
  if(e.key==='2') setDiffUI('normal');
  if(e.key==='3') setDiffUI('hard');
});

/* ================= Inline GoodJunk (offline emoji) ================= */
(function(){
  const PALETTE = {
    good:    { base:'#7CFC00', glow:'#b7ff66', text:'#ffffff' },
    junk:    { base:'#ff4d4d', glow:'#ff9999', text:'#ffffff' },
    decoy:   { base:'#ff9e7a', glow:'#ffd0bf', text:'#ffffff' },
    star:    { base:'#ffea00', glow:'#fff27a', text:'#3b3300' },
    diamond: { base:'#66ccff', glow:'#bfe8ff', text:'#06263a' },
    shield:  { base:'#5ef',    glow:'#bbf3ff', text:'#003344' },
    x2:      { base:'#FFD700', glow:'#ffe885', text:'#4d3b00' }
  };
  // ‡∏Ç‡∏ô‡∏≤‡∏î/‡∏Æ‡∏¥‡∏ï‡∏ö‡πá‡∏≠‡∏Å‡∏ã‡πå/‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
  const DIFF_SCALE   = { easy: 1.05, normal: 0.90, hard: 0.78 };
  const HITBOX_BASE  = 0.22;
  const HITBOX_SCALE = { easy: 1.45, normal: 1.22, hard: 1.08 };
  const LIFE_MS      = { easy: 3000, normal: 2500, hard: 2200 };

  const GOOD   = ['üçé','üçì','üçá','ü•¶','ü•ï','üçÖ','ü•¨','üçä','üçå','ü´ê','üçê','üçç','üçã','üçâ','ü•ù','üçö','ü•õ','üçû','üêü','ü•ó'];
  const JUNK   = ['üçî','üçü','üçï','üç©','üç™','üßÅ','ü•§','üßã','ü•ì','üç´','üå≠'];
  const DECOY  = ['ü•Ø','üßÄ','üçó','üçñ','ü•†','üçú'];
  const STAR='‚≠ê', DIAM='üî∑', SHIELD='üõ°Ô∏è', X2='‚úñÔ∏è';
  const FRUIT = new Set(['üçé','üçì','üçá','üçä','üçå','ü´ê','üçê','üçç','üçã','üçâ','ü•ù']);
  const VEGGIE= new Set(['ü•¶','ü•ï','üçÖ','ü•¨']);

  // ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ 2.2√ó1.2
  function randPosSafe(sizeMul){
    const halfW=1.1, halfH=0.6, m=0.14*sizeMul;
    const x = Math.random()*(halfW*2-2*m) - (halfW-m);
    const y = Math.random()*(halfH*2-2*m) - (halfH-m);
    return [ x, y, 0.01 ];
  }

  // ‡πÄ‡∏õ‡πâ‡∏≤: glow + ‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå emoji (canvas) + hitbox (billboard)
  function makeTarget(kind, emoji, pos, sizeMul, difficulty){
    const pal = PALETTE[kind] || {base:'#fff', glow:'#ddd', text:'#000'};
    const root = document.createElement('a-entity');
    root.classList.add('target'); root.dataset.scored='0';
    root.setAttribute('position', `${pos[0].toFixed(2)} ${pos[1].toFixed(2)} ${pos[2]}`);

    // glow
    const glow = document.createElement('a-plane');
    const glowSz = (0.30*sizeMul).toFixed(3);
    glow.setAttribute('width', glowSz);
    glow.setAttribute('height',glowSz);
    glow.setAttribute('material', `color:${pal.glow}; opacity:0.40; transparent:true; emissive:${pal.glow}; emissiveIntensity:0.9`);
    glow.setAttribute('position', '0 0 -0.002');
    glow.setAttribute('front-most','order:9998');
    glow.setAttribute('billboard','');
    root.appendChild(glow);

    // emoji sticker (offline)
    const sticker = document.createElement('a-plane');
    const texURL = emojiDataUrl(emoji, 256);
    const side = (0.26*sizeMul).toFixed(3);
    sticker.setAttribute('width', side);
    sticker.setAttribute('height', side);
    sticker.setAttribute('material', `src: url(${texURL}); transparent: true; alphaTest: 0.01; side: double;`);
    sticker.setAttribute('position', '0 0 0.000');
    sticker.setAttribute('front-most','order:9999');
    sticker.setAttribute('billboard','');
    root.appendChild(sticker);

    // hitbox ‡πÇ‡∏õ‡∏£‡πà‡∏á
    const hbScale = (HITBOX_SCALE[difficulty]||1.22);
    const hit = document.createElement('a-entity');
    hit.classList.add('hitbox','clickable');
    hit.setAttribute('geometry', `primitive: circle; radius: ${ (HITBOX_BASE*sizeMul*hbScale).toFixed(3) }`);
    hit.setAttribute('material','transparent:true; opacity:0.001; color:#fff; side:double');
    hit.setAttribute('position','0 0 0.002');
    hit.setAttribute('front-most','order:10000');
    hit.setAttribute('billboard','');
    root.appendChild(hit);

    // hover FX
    hit.addEventListener('mouseenter', ()=>{
      glow.setAttribute('material', `color:${pal.glow}; opacity:0.60; transparent:true; emissive:${pal.glow}; emissiveIntensity:1.1`);
      const aimRing=document.getElementById('aimRing');
      if(aimRing){ aimRing.setAttribute('geometry','primitive:ring; radiusInner:0.012; radiusOuter:0.020'); }
    });
    hit.addEventListener('mouseleave', ()=>{
      glow.setAttribute('material', `color:${pal.glow}; opacity:0.40; transparent:true; emissive:${pal.glow}; emissiveIntensity:0.9`);
      const aimRing=document.getElementById('aimRing');
      if(aimRing){ aimRing.setAttribute('geometry','primitive:ring; radiusInner:0.010; radiusOuter:0.015'); }
    });

    return {root, hit};
  }

  // Space/Enter ‡∏¢‡∏¥‡∏á
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space' || e.code==='Enter'){
      const cam=document.getElementById('camera');
      const ray = cam && cam.components && cam.components.raycaster;
      const el = (ray && ray.intersections && ray.intersections[0] && ray.intersections[0].object && ray.intersections[0].object.el);
      if(el && el.classList.contains('hitbox')) el.emit('click');
    }
  });

  // Result
  function showResult(score, maxCombo, questsDone){
    const rp = document.getElementById('resultPanel');
    rp.setAttribute('visible', true);
    document.getElementById('resultScore').setAttribute('troika-text','value',`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${score}`);
    document.getElementById('resultCombo').setAttribute('troika-text','value',`‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${maxCombo}`);
    document.getElementById('resultQuest').setAttribute('troika-text','value',`‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${questsDone}/3`);
    const retry = document.getElementById('retryBtn');
    const menu  = document.getElementById('menuBtn');
    const once=(el,ev,fn)=>{ const h=()=>{ el.removeEventListener(ev,h); fn(); }; el.addEventListener(ev,h); };
    once(retry,'click', ()=>{
      rp.setAttribute('visible',false);
      inlineGoodJunkBoot({host:document.getElementById('spawnZone'), duration:60, difficulty:selectedDifficulty});
    });
    once(menu,'click', ()=>{
      rp.setAttribute('visible',false);
      document.getElementById('modeMenu').setAttribute('visible',true);
      document.getElementById('startPanel').setAttribute('visible',false);
      const zone=document.getElementById('spawnZone'); while(zone.firstChild) zone.removeChild(zone.firstChild);
    });
  }

  // Mini Quests (10 ‡πÅ‡∏ö‡∏ö: ‡∏™‡∏∏‡πà‡∏° 3)
  const QUESTS = [
    { id:'q_good',      title:'‡∏Å‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ (GOOD)',              goalBase:{easy:30,normal:40,hard:50},
      want:(kind)=> kind==='good', weights:{good:0.60, junk:0.15, decoy:0.10, star:0.05, diamond:0.03, shield:0.04, x2:0.03} },
    { id:'q_fruit',     title:'‡∏Å‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ (FRUIT only)',          goalBase:{easy:24,normal:34,hard:44},
      subset:'fruit',    want:(k,e)=> k==='good' && FRUIT.has(e),
      weights:{good:0.65, junk:0.12, decoy:0.08, star:0.05, diamond:0.03, shield:0.04, x2:0.03} },
    { id:'q_veggie',    title:'‡∏Å‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏±‡∏Å (VEGGIE only)',            goalBase:{easy:18,normal:26,hard:34},
      subset:'veggie',   want:(k,e)=> k==='good' && VEGGIE.has(e),
      weights:{good:0.62, junk:0.14, decoy:0.08, star:0.05, diamond:0.04, shield:0.05, x2:0.03} },
    { id:'q_star',      title:'‡∏•‡πà‡∏≤ ‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',                         goalBase:{easy:10,normal:14,hard:18},
      want:(k)=> k==='star', weights:{star:0.22, good:0.38, junk:0.15, decoy:0.08, diamond:0.06, shield:0.06, x2:0.05} },
    { id:'q_diamond',   title:'‡∏•‡πà‡∏≤ üíé ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',                         goalBase:{easy:8, normal:12,hard:16},
      want:(k)=> k==='diamond', weights:{diamond:0.20, good:0.36, junk:0.16, decoy:0.08, star:0.10, shield:0.05, x2:0.05} },
    { id:'q_combo',     title:'‡∏ó‡∏≥‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î)',          goalBase:{easy:12,normal:18,hard:24},
      want:(k,e,sets,ctx)=> ctx.delta>0 && ctx.combo>0, weights:{good:0.56, junk:0.18, decoy:0.10, star:0.06, diamond:0.04, shield:0.04, x2:0.02} },
    { id:'q_speed',     title:'‡∏™‡∏õ‡∏µ‡∏î‡∏£‡∏≠‡∏ö: ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‚Äì‡πÄ‡∏Å‡∏¥‡∏î‡∏ñ‡∏µ‡πà',           goalBase:{easy:28,normal:38,hard:48},
      speed:true, sizeMul:0.85, want:(k)=> k==='good', weights:{good:0.58, junk:0.18, decoy:0.10, star:0.06, diamond:0.04, shield:0.02, x2:0.02} },
    { id:'q_mix',       title:'‡∏î‡∏µ + ‚≠ê ‡∏Ñ‡∏¥‡∏î 2 ‡πÅ‡∏ï‡πâ‡∏°',                    goalBase:{easy:20,normal:28,hard:36},
      want:(k)=> (k==='good' || k==='star'), scoreMap:{good:1, star:2}, weights:{good:0.52, star:0.16, junk:0.16, decoy:0.08, diamond:0.04, shield:0.02, x2:0.02} },
    { id:'q_x2',        title:'‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î ‚úñÔ∏èx2 ‡πÉ‡∏´‡πâ‡∏ö‡πà‡∏≠‡∏¢ ‡∏ï‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡∏Ñ‡∏∏‡πâ‡∏°',  goalBase:{easy:26,normal:36,hard:46},
      want:(k,e,sets,ctx)=> ctx.delta>0, weights:{x2:0.14, good:0.44, star:0.12, junk:0.14, decoy:0.08, diamond:0.05, shield:0.03} },
    { id:'q_shield',    title:'‡πÉ‡∏ä‡πâ üõ°Ô∏è ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö GOOD',         goalBase:{easy:24,normal:34,hard:44},
      want:(k,e,sets,ctx)=> (k==='good' || (ctx.usedShield===true)), weights:{shield:0.16, good:0.46, junk:0.16, decoy:0.10, star:0.06, diamond:0.04, x2:0.02} },
  ];
  function pick3(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,3); }
  function normWeights(w){
    const base = {diamond:0.06, star:0.08, shield:0.06, x2:0.06, decoy:0.14, good:0.38, junk:0.22};
    const mix = Object.assign({}, base, w||{});
    const sum = Object.values(mix).reduce((s,n)=>s+n,0)||1;
    Object.keys(mix).forEach(k=> mix[k]=mix[k]/sum);
    return mix;
  }

  // Boot
  window.inlineGoodJunkBoot = function inlineGoodJunkBoot({host,duration=60,difficulty='easy'}){
    const zone = host || document.getElementById('spawnZone');
    while(zone.firstChild) zone.removeChild(zone.firstChild);

    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    const plane = document.createElement('a-plane');
    plane.setAttribute('width','2.2'); plane.setAttribute('height','1.2');
    plane.setAttribute('color','#0e1b38'); plane.setAttribute('opacity','0.85');
    plane.setAttribute('position','0 0 -0.01');
    zone.appendChild(plane);

    // debug
    let live=0, spawned=0;
    const bootBox=document.getElementById('bootStatus');
    const showDbg=()=>{ if(bootBox) bootBox.firstElementChild.innerHTML = `<strong>Status:</strong> Spawning‚Ä¶ live=${live} / spawned=${spawned}`; };

    let score=0, fever=0, combo=0, maxCombo=0;
    setHudScore(score); setHudFever(fever); setHudCombo(combo);

    const qp = document.getElementById('questPanel'); if(qp) qp.setAttribute('visible', true);
    const tQ = document.getElementById('tQ');

    const picks = pick3(QUESTS);
    let qi = 0, qProgress = 0, qGoal = 0, qWeights = null;

    const diffScale = DIFF_SCALE[difficulty] || 1.0;
    const lifeMs   = LIFE_MS[difficulty]   || 2800;

    let hasShield=false, hasX2=false, x2Timer=null;
    const baseRate = (difficulty==='hard')? 260 : (difficulty==='normal')? 360 : 480;
    let spawnRate = baseRate;
    let perTargetSizeMul = diffScale;

    function startQuest(q){
      qGoal = q.goalBase?.[difficulty] ?? q.goalBase?.easy ?? 30;
      qProgress = 0;
      qWeights = normWeights(q.weights);
      spawnRate = q.speed ? baseRate*0.80 : baseRate;
      perTargetSizeMul = diffScale * (q.sizeMul || 1.0);
      if(tQ) tQ.setAttribute('troika-text','value', `${q.title} ‚Äî ${qProgress}/${qGoal}`);
      restartSpawner();
    }
    function updateQuestText(q){ if(tQ) tQ.setAttribute('troika-text','value', `${q.title} ‚Äî ${qProgress}/${qGoal}`); }
    function completeQuest(q){
      popupScore(zone, [0,0.28,0.01], `‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${q.title}`, '#90ee90');
      qi++;
      if(qi>=picks.length){
        popupScore(zone, [0,0.16,0.01], `‡∏à‡∏ö‡∏Ñ‡∏£‡∏ö 3 ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${score}`, '#9fd');
        stopAll();
        showResult(score, maxCombo, qi);
      }else{
        setTimeout(()=> startQuest(picks[qi]), 700);
      }
    }

    function pickKind(){
      const w = qWeights || normWeights();
      const r = Math.random(); let acc=0;
      for(const k of ['diamond','star','shield','x2','decoy','good','junk']){
        acc += w[k]||0; if(r<=acc) return k;
      }
      return 'good';
    }

    let lastSpawnAt=0, spawner=null;
    function spawnOne(){
      const now=performance.now(); if(now-lastSpawnAt<50) { /* allow firsts */ } lastSpawnAt=now;

      const k = pickKind();
      let kind=k, emoji, value=0;
      if(kind==='diamond'){ emoji=DIAM; value=10; }
      else if(kind==='star'){ emoji=STAR; value=5; }
      else if(kind==='shield'){ emoji=SHIELD; value=0; }
      else if(kind==='x2'){ emoji=X2; value=0; }
      else if(kind==='decoy'){ emoji=DECOY[(Math.random()*DECOY.length)|0]; value=-2; }
      else if(kind==='good'){ emoji=GOOD[(Math.random()*GOOD.length)|0]; value=1; }
      else { kind='junk'; emoji=JUNK[(Math.random()*JUNK.length)|0]; value=-1; }

      const pos = randPosSafe(perTargetSizeMul);
      const {root, hit} = makeTarget(kind, emoji, pos, perTargetSizeMul, difficulty);
      zone.appendChild(root);
      live++; spawned++; showDbg();

      const life = setTimeout(()=>{ root.remove(); live--; showDbg(); }, lifeMs);

      const onHit = ()=>{
        if(root.dataset.scored==='1') return;
        root.dataset.scored='1';
        clearTimeout(life);
        live--; showDbg();

        let usedShield=false;
        if(kind==='shield'){
          hasShield = true;
          burst3D(zone, pos, '#5ef');
          popupScore(zone, pos, 'üõ°Ô∏è ‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞!', '#5ef');
          setTimeout(()=>root.remove(),0); return;
        }
        if(kind==='x2'){
          hasX2 = true;
          if(x2Timer) clearTimeout(x2Timer);
          burst3D(zone, pos, '#FFD700');
          popupScore(zone, pos, '‚úñÔ∏è x2 Mode!', '#FFD700');
          x2Timer = setTimeout(()=>{ hasX2=false; popupScore(zone,[0,0.2,0.01],'x2 ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤','#999'); }, 8000);
          setTimeout(()=>root.remove(),0); return;
        }
        if((kind==='decoy' || kind==='junk') && hasShield){
          hasShield=false; usedShield=true;
          burst3D(zone, pos, '#5ef');
          popupScore(zone, pos, 'üõ°Ô∏è ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô!', '#5ef');
          setTimeout(()=>root.remove(),0); return;
        }

        const mult = (hasX2?2:1) * (fever>=1?2:1);
        const delta = (value>0 ? value*mult : value);
        score = Math.max(0, score + delta);
        if (value>0){ combo++; if(combo>maxCombo) maxCombo = combo; fever = Math.min(1, fever + (kind==='diamond'?0.15: kind==='star'?0.08:0.04)); }
        else { combo=0; fever=Math.max(0, fever-0.10); }
        setHudScore(score); setHudFever(fever); setHudCombo(combo);

        // ‡∏ô‡∏±‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå
        const q = picks[qi]; let add = 0; const ctx = {delta, combo, usedShield};
        if(q.want){
          if(q.subset==='fruit' && kind==='good' && !FRUIT.has(emoji)) { /* no */ }
          else if(q.subset==='veggie' && kind==='good' && !VEGGIE.has(emoji)) { /* no */ }
          else {
            if(q.scoreMap && q.scoreMap[kind]!=null){
              if(q.want(kind,emoji,{FRUIT,VEGGIE},ctx)) add = q.scoreMap[kind];
            }else if(q.want(kind,emoji,{FRUIT,VEGGIE},ctx)){ add = 1; }
          }
        }
        if(add>0){
          qProgress += add;
          popupScore(zone, pos, `+${add} (‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå)`, '#7fffd4');
          if(tQ) updateQuestText(q);
          if(qProgress>=qGoal){ setTimeout(()=>completeQuest(q), 250); }
        }

        burst3D(zone, pos, (delta>=0 ? '#7CFC00' : '#ff4d4d'));
        setTimeout(()=>root.remove(),0);
      };
      ['click','mousedown','mouseup','triggerdown','triggerup','touchstart','touchend','pointerdown','pointerup']
        .forEach(ev=> hit.addEventListener(ev,onHit,{passive:true}));
    }

    function restartSpawner(){ if(spawner) clearInterval(spawner); spawner = setInterval(spawnOne, spawnRate); }
    function stopAll(){ try{ clearInterval(spawner); }catch{} }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 10 ‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ô‡πà ‡πÜ
    for(let i=0;i<10;i++) spawnOne();
    restartSpawner();

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÅ‡∏£‡∏Å
    startQuest(picks[0]);

    // Debug
    window.__HHA_DEBUG_SPAWN10 = ()=>{ for(let i=0;i<10;i++) spawnOne(); };
  };
})();
</script>
</body>
</html>
