<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>HERO HEALTH ACADEMY — VR</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    :root{ --bg:#0b1118; --card:#18212b; --pill:#2b3038; --text:#e7eefc; --accent:#21c064; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font:600 16px/1.3 system-ui,Segoe UI,Inter,Arial,sans-serif; }
    .wrap{ max-width:980px; margin:24px auto; padding:0 16px; }
    h1{ text-align:center; font-size:32px; margin:10px 0 14px; }

    /* UI Start Panel */
    .ui-card{ position:relative; z-index:32; background:linear-gradient(180deg,#22304a,#1a2537);
      border-radius:16px; padding:22px; box-shadow:0 18px 40px rgba(0,0,0,.35); text-align:center; }
    .row{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px 0; }
    label{ opacity:.85; }
    select{ background:#0e151d; color:var(--text); border:1px solid #324052; border-radius:8px; padding:8px 10px; }
    .btn{ cursor:pointer; background:var(--accent); color:#0e151d; border:0; border-radius:12px; font-weight:800;
      padding:12px 22px; margin:10px auto 0; display:block; box-shadow:0 8px 20px rgba(33,192,100,.35); }
    .btn:active{ transform:translateY(1px); }

    /* Fallback demo */
    #fallbackPanel{ position:relative; width:100%; height:420px; border-radius:14px;
      background:#67a8ff; display:flex; align-items:end; justify-content:center; }
    #fallbackPanel > div{ opacity:.85; color:#fff; padding:18px; font-size:22px; }

    /* HUD Overlay */
    #hudOverlay{ position:fixed; inset:0; pointer-events:none; z-index:30; }
    .pill{ pointer-events:none; position:fixed; padding:10px 14px; background:var(--pill); color:var(--text);
           border-radius:12px; font:600 16px/1.1 system-ui,ui-sans-serif; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:31; }
    .pill-tl{ top:14px; left:14px; }
    .pill-tc{ top:14px; left:50%; transform:translateX(-50%); }
    .pill-tr{ top:14px; right:14px; }
    #hudFever{ top:56px; background:#8b1e1e; display:none; }

    .scene-wrap{ margin-top:18px; border-radius:14px; overflow:hidden; box-shadow:0 16px 40px rgba(0,0,0,.35); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>เริ่ม: HERO HEALTH ACADEMY</h1>

    <!-- Start Panel -->
    <div id="startPanel" class="ui-card">
      <div class="row">
        <label for="selMode">เลือกโหมด:</label>
        <select id="selMode">
          <option value="goodjunk">Good vs Junk</option>
          <option value="groups">Food Groups</option>
          <option value="hydration">Hydration</option>
          <option value="plate">Healthy Plate</option>
        </select>
      </div>
      <div class="row">
        <label for="selDiff">ระดับความยาก:</label>
        <select id="selDiff">
          <option value="easy">ง่าย</option>
          <option value="normal" selected>ปกติ</option>
          <option value="hard">ยาก</option>
        </select>
      </div>
      <button id="btnStart" class="btn">เริ่มเกม</button>

      <!-- Fallback demo (จะถูกลบเมื่อเริ่มเกม) -->
      <div id="fallbackPanel"><div>Fallback demo</div></div>
    </div>

    <!-- HUD -->
    <div id="hudOverlay">
      <div id="hudTime"  class="pill pill-tl">เวลา: 60s</div>
      <div id="hudScore" class="pill pill-tc">คะแนน: 0 | คอมโบ: x0</div>
      <div id="hudQuest" class="pill pill-tr">Mini Quest — เตรียมเริ่ม</div>
      <div id="hudFever" class="pill pill-tc">FEVER!</div>
    </div>

    <!-- Scene -->
    <div class="scene-wrap">
      <a-scene renderer="colorManagement:true" vr-mode-ui="enabled:true" embedded background="color: #0b1118">
        <a-entity id="rig">
          <a-entity camera look-controls position="0 1.6 0"></a-entity>
        </a-entity>
        <a-sky color="#0b1118"></a-sky>
      </a-scene>
    </div>
  </div>

  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const hide = (el)=>{ if(el) el.style.display='none'; };

    function killFallback(){
      hide($('#fallbackPanel'));
      $('#fallbackPanel')?.remove();
      $$('#startPanel [id*="fallback"], #startPanel div')
      .forEach(el=>{
        if(el.textContent && el.textContent.trim().toLowerCase().includes('fallback demo')){
          el.remove();
        }
      });
    }

    async function startGame(ev){
      try{ ev?.preventDefault?.(); }catch{}
      const mode = ($('#selMode')?.value || 'goodjunk').toLowerCase();
      const difficulty = ($('#selDiff')?.value || 'normal').toLowerCase();

      hide($('#startPanel'));
      killFallback(); setTimeout(killFallback,0);

    const map = {
     goodjunk : './modes/goodjunk.safe.js'
     groups   : './modes/groups.safe.js',
     hydration: './modes/hydration.quest.js',
     plate    : './modes/plate.quest.js',
      };

      };
      try{
        const url = map[mode] || map.goodjunk;
        const mod = await import(url + '?v=' + Date.now());
        const api = await (mod.boot?.({ difficulty }) || null);
        window.__HHA_API__ = api;
      }catch(err){
        console.error('[HHA] load mode failed:', err);
        document.getElementById('startPanel').style.display='block';
      }
    }

    window.__HHA_START__ = startGame;
    window.addEventListener('load', ()=>{
      const btn=document.getElementById('btnStart');
      if(btn) btn.addEventListener('click',startGame,{passive:false});
    });

    // HUD events
    window.addEventListener('hha:time', e=>{
      const s=e?.detail?.remainSec??0;
      $('#hudTime').textContent=`เวลา: ${s}s`;
    });
    window.addEventListener('hha:score', e=>{
      const {score=0,combo=0}=e.detail||{};
      $('#hudScore').textContent=`คะแนน: ${score} | คอมโบ: x${combo}`;
    });
    window.addEventListener('hha:quest', e=>{
      $('#hudQuest').textContent=e?.detail?.text||'Mini Quest';
    });
    window.addEventListener('hha:fever', e=>{
      const on=(e?.detail?.state==='start');
      $('#hudFever').style.display=on?'block':'none';
    });
  </script>
  <script>
(function(){
  const $ = s=>document.querySelector(s);
  const goalEl  = $('#hudGoal');
  const chipsEl = $('#hudChips');

  // อัปเดตกล่อง Goal กลางบน (รองรับหลายเป้า)
  function renderGoal(detail){
    if(!goalEl) return;
    const list = detail?.multiTargets;
    if(Array.isArray(list) && list.length){
      const parts = list.map(t=>{
        const ex = (t.examples||[]).slice(0,3).join(' ');
        return `[${t.label} ${t.have}/${t.need}] ${ex}`;
      });
      goalEl.innerHTML = `เป้าหมาย: ${parts.join(' &nbsp; | &nbsp; ')}`;
      goalEl.style.display = 'block';
    }else{
      // เผื่อโหมดเดิมที่ส่งแบบเดี่ยว
      const {label='-', have=0, need=10, examples=[]} = detail||{};
      goalEl.innerHTML = `เป้าหมาย: ${label} — ${have}/${need} &nbsp;&nbsp;|&nbsp;&nbsp; ตัวอย่าง: ${(examples||[]).slice(0,3).join(' ')}`;
      goalEl.style.display = 'block';
    }
  }

  // อัปเดตชิพหมวด (ขวาบน)
  function renderChips(detail){
    if(!chipsEl) return;
    chipsEl.innerHTML = '';
    const cats = detail?.categories || [];
    cats.forEach(c=>{
      const d = document.createElement('div');
      d.className = 'chip small' + (c.active?' active':'');
      d.textContent = c.label || c.id;
      chipsEl.appendChild(d);
    });
  }

  window.addEventListener('hha:goal',  e=> renderGoal(e.detail||{}) );
  window.addEventListener('hha:chips', e=> renderChips(e.detail||{}) );

  // mini quest (หากมีอยู่แล้วก็ใช้ร่วมกันได้)
  const hudQuest = document.getElementById('hudQuest');
  window.addEventListener('hha:quest', e=>{
    if(hudQuest) hudQuest.textContent = e.detail?.text || '';
  });
})();
</script>

</body>
</html>
