<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Hero Health Academy</title>
<meta name="color-scheme" content="light dark"/>
<style>
/* ... (สไตล์เดิมของคุณคงไว้ทั้งหมด) ... */
#menuBar[data-hidden]{opacity:0;visibility:hidden;pointer-events:none;display:none}
.toast{position:fixed;left:50%;top:68px;transform:translateX(-50%);background:#0e1930;border:1px solid #214064;color:#e8f3ff;padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .3s;z-index:60}
.toast.show{opacity:1}
#bootWarn{position:fixed;inset:auto 0 0 0;background:#b00020;color:#fff;padding:10px 12px;font:700 14px ui-sans-serif;z-index:10000;display:none}
</style>
</head>
<body>

<!-- ... เนื้อหาเดิมทั้งหมดของคุณ (menu, hud, audio, etc.) ... -->

<!-- โหลดหลักปกติ -->
<script type="module" src="./game/main.js"></script>

<!-- 🔒 Fail-safe binder (ลองหลาย path + แสดง error ชัดเจน) -->
<script type="module">
const toast=(t)=>{ let el=document.getElementById('toast'); if(!el){ el=document.createElement('div'); el.id='toast'; el.className='toast'; document.body.appendChild(el); } el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1400); };
const warn =(lines)=>{ let w=document.getElementById('bootWarn'); if(!w){ w=document.createElement('div'); w.id='bootWarn'; document.body.appendChild(w);} w.innerHTML=(Array.isArray(lines)?lines:[lines]).map(t=>`<div>${t}</div>`).join(''); w.style.display='block'; };

async function tryImport(url){
  const bust = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
  await import(bust);
}

async function ensureMainLoaded(){
  if (window.HHA?.startGame) return true;
  const candidates = ['./game/main.js','game/main.js','./main.js'];
  let lastErr=null;
  for (const u of candidates){
    try{
      await tryImport(u);
      if (window.HHA?.startGame) return true;
      lastErr = new Error('main loaded but HHA.startGame missing');
    }catch(e){ lastErr=e; }
  }
  warn([
    '⚠️ เริ่มเกมไม่สำเร็จ (โหลดสคริปต์ไม่ได้หรือพังระหว่างรัน)',
    'ตรวจ path: ./game/main.js และไฟล์ที่มัน import (./core/*, ./modes/*)',
    'รายละเอียดล่าสุด: ' + String(lastErr?.message||lastErr)
  ]);
  console.error('[HHA boot fail]', lastErr);
  return false;
}

(function bindMenu(){
  const mb=document.getElementById('menuBar'); if(!mb) return;

  // เลือกโหมด/ความยาก
  mb.addEventListener('click',(ev)=>{
    const t=ev.target.closest('.btn'); if(!t) return;
    if (t.hasAttribute('data-mode'))  { document.body.setAttribute('data-mode', t.getAttribute('data-mode'));  mb.querySelectorAll('[data-mode]').forEach(b=>b.classList.toggle('active',b===t)); }
    if (t.hasAttribute('data-diff'))  { document.body.setAttribute('data-diff', t.getAttribute('data-diff'));  mb.querySelectorAll('[data-diff]').forEach(b=>b.classList.toggle('active',b===t)); }
    if (t.dataset.action==='howto')   { toast('แตะของดี เลี่ยงของไม่ดี ภายในเวลาที่กำหนด'); }
    if (t.dataset.action==='sound')   {
      const aud = [...document.querySelectorAll('audio')];
      const nowMuted = aud.every(a=>a.muted);
      aud.forEach(a=>{ try{ a.muted = !nowMuted; }catch{} });
      t.textContent = nowMuted ? '🔇 Sound' : '🔊 Sound';
      toast(nowMuted?'เสียง: ปิด':'เสียง: เปิด');
    }
  }, false);

  // ปุ่ม Start แบบ “กันพลาด”
  const btn=document.getElementById('btn_start');
  if (btn){
    const startNow = async ()=>{
      // เผื่อ main.js ไม่รันเพราะ error → โหลดแบบ fail-safe
      const ok = await ensureMainLoaded();
      if (ok) {
        try { window.HHA.startGame(); }
        catch(e){
          warn(['⚠️ เริ่มเกมไม่สำเร็จ', String(e?.message||e)]);
          console.error('[HHA start error]', e);
        }
      }
    };
    const clone = btn.cloneNode(true); btn.replaceWith(clone);
    ['click','pointerup','touchend'].forEach(ev=>{
      clone.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); startNow(); }, {capture:true, passive:false});
    });
    clone.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); startNow(); }},{capture:true});
  }
})();
</script>

<div id="toast" class="toast"></div>
<div id="bootWarn"></div>
</body>
</html>
