<!doctype html>
<html lang="th" data-hha-lang="TH">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hero Health Academy</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="./styles/game.css">

  <!-- SFX / BGM assets -->
  <audio id="bgm-main" preload="auto" loop></audio>
  <audio id="sfx-good" preload="auto"></audio>
  <audio id="sfx-bad" preload="auto"></audio>
  <audio id="sfx-perfect" preload="auto"></audio>
  <audio id="sfx-tick" preload="auto"></audio>
  <audio id="sfx-powerup" preload="auto"></audio>
</head>
<body data-mode="goodjunk" data-diff="Normal">
  <canvas id="c" aria-hidden="true"></canvas>

  <div id="app">
    <!-- HERO -->
    <section id="hero">
      <h1>Hero Health Academy</h1>
      <p class="sub">‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° ‚Ä¢ ‡∏à‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‚Ä¢ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
    </section>

    <!-- MENU -->
    <section id="menuBar" class="menu">
      <div class="grid">
        <button id="m_goodjunk" class="tile active" data-mode="goodjunk"><i>ü•ó</i><b>Good vs Junk</b><small>‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡∏î‡∏µ/‡∏Ç‡∏¢‡∏∞</small></button>
        <button id="m_groups"   class="tile" data-mode="groups"><i>üß∫</i><b>5 Food Groups</b><small>‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏ß‡∏î</small></button>
        <button id="m_hydration"class="tile" data-mode="hydration"><i>üíß</i><b>Hydration</b><small>‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</small></button>
        <button id="m_plate"    class="tile" data-mode="plate"><i>üçΩÔ∏è</i><b>Healthy Plate</b><small>‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏ß‡∏î</small></button>
      </div>

      <div class="row">
        <div class="seg">
          <span class="lbl">Mode:</span>
          <span id="modeName" class="value">Good vs Junk</span>
        </div>
        <div class="seg">
          <span class="lbl">Difficulty:</span>
          <button id="d_easy"   class="chip">Easy</button>
          <button id="d_normal" class="chip active">Normal</button>
          <button id="d_hard"   class="chip">Hard</button>
          <span id="difficulty" class="value" style="margin-left:8px">Normal</span>
        </div>
        <div class="seg" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="soundToggle" class="chip" title="Toggle Sound">üîä</button>
          <button class="chip" id="toggleVR" data-action="toggle-vr" title="VR / Gaze">üï∂Ô∏è VR</button>
          <span class="lbl">Gaze:</span>
          <button class="chip" id="dwellMinus" data-action="dwell-">‚àí</button>
          <span id="dwellVal" class="value">850ms</span>
          <button class="chip" id="dwellPlus" data-action="dwell+">Ôºã</button>
          <label class="lbl" for="gazeCooldown">Cooldown</label>
          <input id="gazeCooldown" type="range" min="0" max="1000" step="50" value="350" style="vertical-align:middle">
          <span id="gazeCooldownVal" class="value">350ms</span>
          <button class="chip" id="reticleLight" data-action="reticle-light">Reticle Light</button>
          <button class="chip" id="reticleBold"  data-action="reticle-bold">Reticle Bold</button>
        </div>
      </div>

      <div class="cta">
        <button id="btn_start" class="start" data-action="play">Start</button>
      </div>
    </section>

    <!-- GAME LAYER -->
    <section id="gameLayer" aria-live="polite" aria-label="playfield">
      <div id="spawnHost"></div>

      <!-- HUD -->
      <div id="hudWrap" class="hud" style="display:none">
        <!-- Groups mode target pill -->
        <div class="pill" id="targetWrap" style="display:none">
          <span id="targetBadge">target</span>
        </div>

        <div id="scoreTime">
          <div class="pill">‚≠ê <span id="score">0</span></div>
          <div class="pill">‚è± <span id="time">45</span>s</div>
          <div class="pill">Combo <span id="combo">0</span></div>
        </div>

        <!-- Quests -->
        <div id="questBar">
          <ul id="questChips"></ul>
        </div>

        <!-- Plate tracker (used by plate.js) -->
        <div id="plateTracker" style="display:none;pointer-events:none">
          <div id="platePills" class="pillrow"></div>
        </div>

        <!-- Coach / Toast / Mission line -->
        <div id="coachHUD" class="coach"><span id="coachText"></span></div>
        <div id="missionLine" class="missionLine"></div>
        <div id="toast" class="toast"></div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="result" style="display:none;align-items:center;justify-content:center;gap:16px;flex-direction:column">
      <h2 id="resultText">Score 0</h2>
      <ul id="pbRow" style="list-style:none;padding:0;margin:0;display:flex;gap:8px;flex-wrap:wrap"></ul>
      <div style="display:flex;gap:10px">
        <button class="chip" data-result="home">üè† Home</button>
        <button class="chip" data-result="replay">üîÑ Replay</button>
      </div>
    </section>
  </div>

  <!-- RUNTIME -->
  <script type="module" src="./game/main.js"></script>
  <script src="./game/ui.js" defer></script>
  <!-- === EMERGENCY CLICK HOTFIX (2025-10-30) === -->
<style id="HHA_CLICK_HOTFIX">
  #c{pointer-events:none !important;}
  #menuBar{z-index:100000 !important; pointer-events:auto !important; display:block !important;}
  #menuBar *{pointer-events:auto !important; cursor:pointer;}
  #gameLayer{z-index:9000; pointer-events:none !important;} /* ‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å */
  #spawnHost{pointer-events:auto !important;}
  #hudWrap,#hudWrap *,#toast,#coachHUD,#missionLine,#questChips,#targetWrap{pointer-events:none !important;}
  #result{z-index:100001; pointer-events:auto !important;}
  [hidden],[aria-hidden="true"],.hidden,.visually-hidden{pointer-events:none !important;}
</style>

<script>
(function(){
  // ---- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ----
  function ensureRescue(){
    if (document.getElementById('clickRescue')) return;
    const bar = document.createElement('div');
    bar.id = 'clickRescue';
    bar.style.cssText = 'position:fixed;left:8px;bottom:8px;z-index:200000;display:flex;gap:8px';
    bar.innerHTML = `
      <button id="btnUnblock" style="padding:6px 10px;border:1px solid #888;border-radius:8px;background:#fff;cursor:pointer">üõ° Force-Unblock</button>
      <button id="btnStartHot" style="padding:6px 10px;border:1px solid #888;border-radius:8px;background:#fff;cursor:pointer">‚ñ∂ Start</button>
      <button id="btnHomeHot"  style="padding:6px 10px;border:1px solid #888;border-radius:8px;background:#fff;cursor:pointer">üè† Home</button>
    `;
    document.body.appendChild(bar);
    document.getElementById('btnUnblock')?.addEventListener('click', forceUnblock, {passive:false});
    document.getElementById('btnStartHot')?.addEventListener('click', startGameSafe, {passive:false});
    document.getElementById('btnHomeHot') ?.addEventListener('click', showMenuSafe,  {passive:false});
  }

  // ---- ‡∏õ‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏ö‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÄ‡∏°‡∏ô‡∏π/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå) ----
  function forceUnblock(){
    const vw = innerWidth, vh = innerHeight;
    const allow = new Set(['menuBar','result','gameLayer','spawnHost','app','c']);
    document.querySelectorAll('body *').forEach(el=>{
      const id = el.id || '';
      if (allow.has(id)) return;
      const cs = getComputedStyle(el);
      if (cs.display==='none' || cs.visibility==='hidden' || el.hasAttribute('hidden')) return;
      // ‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ + z ‡∏™‡∏π‡∏á + ‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å ‚Üí ‡∏õ‡∏¥‡∏î pointer-events
      if ((cs.position==='fixed' || cs.position==='absolute')) {
        const r = el.getBoundingClientRect();
        const large = r.width >= vw*0.9 && r.height >= vh*0.9;
        const highZ = (parseInt(cs.zIndex||'0',10) >= 999);
        if (large && highZ && cs.pointerEvents!=='none') el.style.pointerEvents = 'none';
      }
    });
    // ‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
    const m=document.getElementById('menuBar'); if(m){ m.style.pointerEvents='auto'; m.style.display='block'; }
    const g=document.getElementById('gameLayer'); if(g){ g.style.pointerEvents='none'; }
    const c=document.getElementById('c'); if(c){ c.style.pointerEvents='none'; }
    console.log('[HHA] forceUnblock applied');
  }

  // ---- ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏ô‡∏π / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏• (fallback ‡∏ñ‡πâ‡∏≤ main.js ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà bind) ----
  function showMenuSafe(){
    const menu = document.getElementById('menuBar');
    const hud  = document.getElementById('hudWrap');
    const res  = document.getElementById('result');
    if (menu) menu.style.display = 'block';
    if (hud)  hud.style.display  = 'none';
    if (res)  res.style.display  = 'none';
    const layer = document.getElementById('gameLayer'); if (layer) layer.style.pointerEvents='none';
    const spawn = document.getElementById('spawnHost'); if (spawn) spawn.style.pointerEvents='auto';
  }
  function showPlaySafe(){
    const menu = document.getElementById('menuBar');
    const hud  = document.getElementById('hudWrap');
    if (menu) menu.style.display = 'none';
    if (hud)  hud.style.display  = 'block';
    const layer = document.getElementById('gameLayer'); if (layer) layer.style.pointerEvents='auto';
  }
  function startGameSafe(){
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ HHA ‡∏à‡∏≤‡∏Å main.js ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
    if (window.HHA && typeof window.HHA.startSelectedMode==='function'){ window.HHA.startSelectedMode(); return; }
    // ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ fallback: ‡πÅ‡∏Ñ‡πà‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
    showPlaySafe();
    console.warn('[HHA] Fallback start: main.js ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà bind ‚Äî ‡∏ï‡∏£‡∏ß‡∏à path/console error ‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏•');
  }

  // ---- ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ã‡πâ‡∏≥ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö click / pointerdown / touchend) ----
  function bindAll(sel, fn){
    document.querySelectorAll(sel).forEach(el=>{
      ['click','pointerdown','touchend'].forEach(ev=> el.addEventListener(ev, e=>{ e.preventDefault?.(); fn(); }, {passive:false}));
    });
  }

  // init
  ensureRescue();
  bindAll('#btn_start', startGameSafe);
  bindAll('[data-result="home"]', showMenuSafe);
  bindAll('[data-result="replay"]', startGameSafe);

  // ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 500ms ‡∏Å‡∏±‡∏ô element ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏ö‡∏±‡∏á
  setInterval(forceUnblock, 500);
  addEventListener('resize', forceUnblock, {passive:true});
  requestAnimationFrame(forceUnblock);
})();
</script>

</body>
</html>
