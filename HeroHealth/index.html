<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Hero Health Academy</title>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1020;--fg:#e8f3ff;--muted:#94a3b8;--accent:#22d3ee;}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#173056 10%,var(--bg) 55%);color:var(--fg);
font:500 16px/1.5 ui-rounded,system-ui,Segoe UI,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
.game-wrap{position:relative;min-height:100dvh;overflow:hidden;}
#gameLayer,#spawnHost{position:fixed;inset:0;pointer-events:none}
#spawnHost{pointer-events:auto;z-index:5}

/* === MENU === */
#menuBar{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
background:linear-gradient(#0b1020d0,#0b1020d0);pointer-events:auto;}
.menu-card{width:min(860px,94vw);background:#0e1930;border:1px solid #132a4f;border-radius:16px;
padding:18px;box-shadow:0 18px 60px rgba(0,0,0,.45);}
.btnrow{display:flex;flex-wrap:wrap;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;
border-radius:12px;background:#0f1e38;color:#e6f2ff;border:1px solid #16325d;cursor:pointer;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn[aria-pressed="true"]{outline:2px solid var(--accent);outline-offset:2px}

/* === POWER BAR (‡πÑ‡∏ü‡∏•‡∏∏‡∏Å) === */
#powerBarWrap{position:fixed;left:12px;bottom:12px;z-index:18;width:min(380px,92vw);}
#powerBar{position:relative;height:14px;border-radius:999px;background:#0a1931;border:1px solid #0f2a54;overflow:hidden;}
#powerFill{position:absolute;inset:0;width:0%;}
.fire{position:absolute;left:0;top:0;bottom:0;width:100%;
background:
 radial-gradient(30px 24px at 20% 110%,rgba(255,200,0,.9),rgba(255,130,0,.65)55%,rgba(255,80,0,.0)70%),
 radial-gradient(26px 20px at 45% 110%,rgba(255,210,80,.85),rgba(255,120,0,.55)55%,rgba(255,80,0,.0)70%),
 radial-gradient(34px 26px at 70% 110%,rgba(255,190,40,.9),rgba(255,110,0,.55)55%,rgba(255,80,0,.0)70%),
 linear-gradient(0deg,rgba(255,140,0,.65),rgba(255,100,0,.25));
mix-blend-mode:screen;animation:fireRise .9s ease-in-out infinite;}
@keyframes fireRise{0%{transform:translateY(8px) scaleY(.9)}50%{transform:translateY(0) scaleY(1)}100%{transform:translateY(8px) scaleY(.9)}}

/* HUD ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ñ‡∏ô‡∏±‡∏î */
h2,h3{margin:4px 0 8px}
hr{margin:12px 0;border-color:#133}
</style>
</head>
<body>

<div class="game-wrap">
  <div id="gameLayer"></div>
  <div id="spawnHost"></div>

  <div id="menuBar" aria-modal="true">
    <div class="menu-card">
      <h2 style="margin:4px 0 12px;font:900 22px ui-rounded">Hero Health Academy</h2>

      <div>
        <h3>Play Mode</h3>
        <div class="btnrow" id="modeRow" role="group" aria-label="Play Mode">
          <div class="btn" data-mode="goodjunk" role="button" tabindex="0" aria-pressed="true">ü•ó Good vs Junk</div>
          <div class="btn" data-mode="groups" role="button" tabindex="0">üß∫ 5 Food Groups</div>
          <div class="btn" data-mode="hydration" role="button" tabindex="0">üíß Hydration</div>
          <div class="btn" data-mode="plate" role="button" tabindex="0">üçΩÔ∏è Healthy Plate</div>
        </div>
      </div>

      <hr/>

      <div>
        <h3>Difficulty</h3>
        <div class="btnrow" id="diffRow" role="group" aria-label="Difficulty">
          <div class="btn" data-diff="Easy" role="button" tabindex="0">Easy</div>
          <div class="btn" data-diff="Normal" role="button" tabindex="0" aria-pressed="true">Normal</div>
          <div class="btn" data-diff="Hard" role="button" tabindex="0">Hard</div>
        </div>
      </div>

      <hr/>

      <div class="btnrow">
        <div class="btn" data-action="start" role="button" tabindex="0">‚ñ∂Ô∏è Start</div>
        <div class="btn" data-action="howto" role="button" tabindex="0">‚ùì How to Play</div>
      </div>
    </div>
  </div>

  <div id="powerBarWrap"><div id="powerBar"><div id="powerFill"><div class="fire"></div></div></div></div>
</div>

<!-- SFX -->
<audio id="sfx-good" preload="auto" src="assets/sfx/good.mp3"></audio>
<audio id="sfx-bad" preload="auto" src="assets/sfx/bad.mp3"></audio>
<audio id="sfx-perfect" preload="auto" src="assets/sfx/perfect.mp3"></audio>
<audio id="sfx-tick" preload="auto" src="assets/sfx/tick.mp3"></audio>
<audio id="sfx-powerup" preload="auto" src="assets/sfx/powerup.mp3"></audio>

<script type="module">
/* ===== Imports ===== */
import { sfx as SFX } from './core/sfx.js';
import { Engine } from './core/engine.js';
import * as goodjunk from './game/modes/goodjunk.js';
import * as groups   from './game/modes/groups.js';
import * as hydration from './game/modes/hydration.js';
import * as plate    from './game/modes/plate.js';

/* ===== Boot ===== */
const engine = new Engine();
engine.sfx = SFX;
SFX.loadIds(['sfx-good','sfx-bad','sfx-perfect','sfx-tick','sfx-powerup']);

const MODS = { goodjunk, groups, hydration, plate };
let current = { mode:'goodjunk', diff:'Normal' };

/* ===== Menu wiring (‡∏Å‡∏±‡∏ô ‚Äú‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‚Äù) ===== */
const $ = (s)=>document.querySelector(s);
const menu = $('#menuBar');
function setPressed(rowSel, el){
  const row = $(rowSel); if(!row) return;
  row.querySelectorAll('.btn').forEach(b=>b.setAttribute('aria-pressed','false'));
  el.setAttribute('aria-pressed','true');
}
function handleActivate(target){
  if (target.hasAttribute('data-mode')){
    current.mode = target.getAttribute('data-mode');
    setPressed('#modeRow', target);
    return;
  }
  if (target.hasAttribute('data-diff')){
    current.diff = target.getAttribute('data-diff');
    setPressed('#diffRow', target);
    return;
  }
  if (target.getAttribute('data-action') === 'start'){
    startGame(current.mode, current.diff);
    return;
  }
  if (target.getAttribute('data-action') === 'howto'){
    alert('‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î!');
    return;
  }
}
function keyActivate(ev){
  if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); handleActivate(ev.currentTarget); }
}
menu.addEventListener('click', (ev)=>{
  const t = ev.target.closest('.btn'); if (t) handleActivate(t);
},{passive:true});
menu.querySelectorAll('.btn').forEach(b=>{
  b.addEventListener('pointerup', ()=>handleActivate(b), {passive:true});
  b.addEventListener('touchend',  ()=>handleActivate(b), {passive:true});
  b.addEventListener('keydown',   keyActivate);
});

/* ===== Minimal HUD/Bus for modes ===== */
const Bus = {
  hit(p){ try{SFX.play(p.kind==='perfect'?'sfx-perfect':'sfx-good');}catch{}
           score += (p.kind==='perfect'?18:10); combo = Math.min(combo+1, 999);
           pumpPower( (p.kind==='perfect'?6:3) + (p.meta?.golden?4:0) );
         },
  miss(){ try{SFX.play('sfx-bad');}catch{} combo = 0; score = Math.max(0, score-6); pumpPower(-8); }
};

let rafId=0, lastT=0, runner=null, updater=null, stopper=null;
let score=0, combo=0, power01=0;

/* ===== Power bar logic (‡πÑ‡∏ü‡∏•‡∏∏‡∏Å) ===== */
function pumpPower(delta){
  power01 = Math.max(0, Math.min(1, power01 + (delta||0)/100));
  const fill = document.getElementById('powerFill');
  if (fill) fill.style.width = Math.round(power01*100)+'%';
}

/* ===== Game start/stop/loop ===== */
function startGame(modeKey, diff){
  // hide menu
  menu.style.display='none';

  // resolve module and factory
  const mod = MODS[modeKey];
  if (!mod){ fail('Mode not found: '+modeKey); return; }

  // reset score/state
  score=0; combo=0; pumpPower(-1);

  // try create({engine}) API first, fallback to start()
  runner = null; updater = null; stopper = null;

  try{
    if (typeof mod.create === 'function'){
      runner = mod.create({ engine, coach:{ onStart(){}, onBad(){}, onGood(){} } });
      if (runner && typeof runner.start==='function') runner.start();
      if (runner && typeof runner.update==='function') updater = (dt)=>runner.update(dt, Bus);
      if (runner && typeof runner.stop==='function')   stopper = ()=>runner.stop();
    } else {
      // legacy fallback
      if (typeof mod.start==='function') mod.start({ difficulty: diff });
      if (typeof mod.update==='function') updater = (dt)=>mod.update(dt, Bus);
      if (typeof mod.stop==='function')   stopper = ()=>mod.stop();
    }
  }catch(e){ fail('Start error: '+(e?.message||e)); return; }

  // run loop
  cancelAnimationFrame(rafId); lastT = performance.now();
  const loop = (t)=>{
    rafId = requestAnimationFrame(loop);
    const dt = Math.max(0, Math.min(0.050, (t - lastT)/1000)); // cap 50ms
    lastT = t;
    try{ updater && updater(dt); }catch(e){ fail('Update error: '+(e?.message||e)); }
    // gentle power decay
    if (power01>0) pumpPower(-0.3);
  };
  rafId = requestAnimationFrame(loop);

  // escape back to menu
  window.onkeydown = (ev)=>{
    if (ev.key === 'Escape'){
      stopGame();
      menu.style.display='flex';
    }
  };
}

function stopGame(){
  cancelAnimationFrame(rafId); rafId=0;
  try{ stopper && stopper(); }catch{}
  // clear spawns safely
  try{ const sh=document.getElementById('spawnHost'); if (sh) sh.innerHTML=''; }catch{}
}

/* ===== Error box for quick diagnosis ===== */
function fail(msg){
  stopGame();
  const box=document.createElement('div');
  box.style.cssText='position:fixed;left:0;right:0;bottom:0;z-index:10000;background:#7f1d1d;color:#fff;padding:8px 12px;font:600 13px ui-rounded';
  box.textContent='‚ö†Ô∏è '+msg;
  document.body.appendChild(box);
}

/* Global helpers (optional) */
window.hha_start = ()=> startGame(current.mode,current.diff);

</script>
</body>
</html>
