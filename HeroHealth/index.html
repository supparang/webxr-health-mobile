<!doctype html>
<html lang="th" data-hha-mode="goodjunk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hero Health Academy</title>
  <base href="./" />
  <link rel="stylesheet" href="styles/game.css" />
  <link rel="stylesheet" href="styles/groups.css" />
  <meta name="theme-color" content="#0b1220" />
</head>
<body data-mode="goodjunk">
  <!-- ===== AUDIO ===== -->
  <audio id="sfx-good"     preload="auto" src="assets/sfx/good.mp3"></audio>
  <audio id="sfx-bad"      preload="auto" src="assets/sfx/bad.mp3"></audio>
  <audio id="sfx-perfect"  preload="auto" src="assets/sfx/perfect.mp3"></audio>
  <audio id="sfx-tick"     preload="auto" src="assets/sfx/tick.mp3"></audio>
  <audio id="sfx-powerup"  preload="auto" src="assets/sfx/power.mp3"></audio>
  <audio id="bgm-main"     preload="auto" src="assets/bgm/main.mp3" loop></audio>

  <main id="gameLayer" role="main" aria-label="Hero Health Academy">
    <div id="spawnHost" aria-hidden="true"></div>

    <!-- ===== HUD (‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏´‡∏°‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô) ===== -->
    <div id="hudWrap" class="hud">
      <div class="hud-pill">
        üéÆ <span id="hudMode">Good vs Junk</span>
        ‚Ä¢ ‚öôÔ∏è <span id="hudDiff">Normal</span>
      </div>
      <div class="hud-pill">‚è± <span id="time">45</span>s</div>
      <div class="hud-pill">‚≠ê <span id="score">0</span></div>
      <div class="hud-pill">üîó <span id="combo">0</span>x</div>
      <div class="hud-pill" id="feverBarWrap">
        <span>FEVER</span>
        <div id="feverBar" style="margin-left:8px;width:120px;height:6px;border-radius:8px;background:#ffffff20;overflow:hidden;">
          <i id="feverFill" style="display:block;height:100%;width:0%;background:linear-gradient(90deg,#ffd54a,#ff7f50)"></i>
        </div>
      </div>
      <div id="targetWrap" class="hud-pill" style="display:none;">üéØ <span id="targetBadge">‡∏ú‡∏±‡∏Å ‚Ä¢ 0/8</span></div>
    </div>

    <!-- Hydration HUD -->
    <div id="hydroWrap" style="display:none;">
      <div class="hydroBar" aria-label="hydration-bar">
        <div class="seg low"><span>‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ</span></div>
        <div class="seg ok"><span>‡∏û‡∏≠‡∏î‡∏µ</span></div>
        <div class="seg high"><span>‡∏°‡∏≤‡∏Å‡πÑ‡∏õ</span></div>
        <div class="needle"></div>
        <div class="flame" hidden><i></i><i></i><i></i></div>
      </div>
    </div>

    <!-- Plate tracker -->
    <div id="plateTracker" style="display:none;">
      <div id="platePills"></div>
    </div>

    <div id="missionLine" style="display:none;"></div>
    <div id="toast" class="toast"></div>

    <!-- Coach bubble (Ready? ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á) -->
    <section id="coachHUD" class="coach">
      <div class="bubble" id="coachText">Ready?</div>
    </section>

    <!-- ===== MENU (‡∏ä‡∏±‡∏î‡πÇ‡∏´‡∏°‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å + ‡∏õ‡∏∏‡πà‡∏° START ‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡πà) ===== -->
    <nav id="menuBar" class="menu" aria-label="Game Menu" style="
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      z-index:100;display:flex;flex-direction:column;align-items:center;gap:14px;
      pointer-events:auto;">
      <h1 style="margin:0 0 4px 0">Hero Health Academy</h1>

      <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î -->
      <div aria-live="polite" style="font-weight:800;">
        <span>‡πÇ‡∏´‡∏°‡∏î:</span> <span id="menuModeBadge">Good vs Junk</span>
        &nbsp; ‚Ä¢ &nbsp;
        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</span> <span id="menuDiffBadge">Normal</span>
      </div>

      <!-- Mode selector -->
      <div id="modeSelector" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
        <button type="button" id="m_goodjunk" class="btn mode is-active">ü•¶ Good vs Junk</button>
        <button type="button" id="m_groups"   class="btn mode">üç± 5 Food Groups</button>
        <button type="button" id="m_hydration" class="btn mode">üíß Hydration</button>
        <button type="button" id="m_plate"     class="btn mode">üçΩÔ∏è Healthy Plate</button>
      </div>

      <!-- Difficulty selector -->
      <div id="diffSelector" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
        <button type="button" id="d_easy"   class="btn diff">Easy</button>
        <button type="button" id="d_normal" class="btn diff is-active">Normal</button>
        <button type="button" id="d_hard"   class="btn diff">Hard</button>
      </div>

      <!-- Toggles -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
        <button type="button" id="langToggle"  class="btn">TH/EN</button>
        <button type="button" id="soundToggle" class="btn">üîä</button>
        <button type="button" id="gfxToggle"   class="btn">üé®</button>
        <button type="button" id="btn_help"    class="btn">‚ùì Help</button>
      </div>

      <!-- START -->
      <div style="margin-top:6px;">
        <button type="button" id="btn_start" class="btn btn-primary"
                style="min-width:240px;height:52px;font-weight:900; font-size:18px;">
          ‚ñ∂Ô∏è Start
        </button>
      </div>
    </nav>

    <!-- RESULT -->
    <section id="result" class="modal" role="dialog" style="display:none;">
      <div class="modal-body">
        <h2 id="h_result">Result</h2>
        <div id="resultStats"></div>
        <div class="modal-actions" style="display:flex;gap:10px;justify-content:center;">
          <button type="button" data-result="replay" class="btn">‚Üª Replay</button>
          <button type="button" data-result="home"   class="btn">üè† Home</button>
        </div>
      </div>
    </section>

    <!-- HELP -->
    <section id="help" class="modal" role="dialog" style="display:none;">
      <div class="modal-body" style="max-width:760px;">
        <h2 id="h_help">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</h2>
        <pre id="helpBody" style="white-space:pre-wrap;font-family:inherit;"></pre>
        <div style="text-align:center;margin-top:10px;">
          <button type="button" id="btn_ok" class="btn btn-primary">OK</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Boot & UI (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) -->
  <script type="module" src="game/boot.js"></script>
  <script type="module" src="game/ui.js"></script>

  <!-- ===== Hardening: ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π & Start ‡πÅ‡∏ö‡∏ö in-page (‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏ä‡∏±‡∏î & Start ‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡πà) ===== -->
  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);
      const $$= (s)=>Array.from(document.querySelectorAll(s));

      const modeMap = {
        goodjunk: { th:'‡∏î‡∏µ vs ‡∏Ç‡∏¢‡∏∞', en:'Good vs Junk' },
        groups:   { th:'‡∏à‡∏≤‡∏ô 5 ‡∏´‡∏°‡∏π‡πà', en:'5 Food Groups' },
        hydration:{ th:'‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ô‡πâ‡∏≥', en:'Hydration' },
        plate:    { th:'‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', en:'Healthy Plate' },
      };

      const state = {
        mode: 'goodjunk',
        diff: 'Normal',
        lang: 'TH'
      };

      // ----- UI helpers -----
      function setActive(btns, el){
        btns.forEach(b=>b.classList.remove('is-active'));
        el?.classList.add('is-active');
      }
      function refreshBadges(){
        const modeName = (state.lang==='EN' ? modeMap[state.mode].en : modeMap[state.mode].th);
        $('#menuModeBadge').textContent = modeName;
        $('#hudMode').textContent = (state.lang==='EN' ? modeMap[state.mode].en : 'Good vs Junk' && modeName);
        $('#menuDiffBadge').textContent = state.diff;
        $('#hudDiff').textContent = state.diff;
        document.body.setAttribute('data-mode', state.mode);
        document.documentElement.setAttribute('data-hha-mode', state.mode);
        window.__HHA_DIFF = state.diff; // ‡πÉ‡∏´‡πâ main.js ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠
      }

      // ----- Bind Mode buttons -----
      const modeBtns = $$('.btn.mode');
      modeBtns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.id.replace(/^m_/, '');
          state.mode = id;
          setActive(modeBtns, btn);
          refreshBadges();
        }, {passive:true});
      });

      // ----- Bind Difficulty -----
      const diffBtns = $$('.btn.diff');
      const diffMap = { d_easy:'Easy', d_normal:'Normal', d_hard:'Hard' };
      diffBtns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          state.diff = diffMap[btn.id] || 'Normal';
          setActive(diffBtns, btn);
          refreshBadges();
        }, {passive:true});
      });

      // ----- Lang toggle (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ badge/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) -----
      $('#langToggle')?.addEventListener('click', ()=>{
        state.lang = (state.lang==='TH'?'EN':'TH');
        refreshBadges();
      });

      // Ï¥àÍ∏∞ ÏÉÅÌÉú
      refreshBadges();

      // ====== START: bind ‡πÅ‡∏ö‡∏ö‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏™‡∏∏‡∏î ‡πÜ ======
      const startBtn = $('#btn_start');
      function callStart(){
        // ‡∏ã‡πà‡∏≠‡∏ô warning (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const w = document.getElementById('bootWarn'); if (w) w.style.display='none';
        // ‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏´‡∏°‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ main
        window.__HHA_MODE = state.mode;
        window.__HHA_DIFF = state.diff;

        // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ signature
        if (typeof window.startFlow === 'function') { window.startFlow(); return; }
        if (window.preStartFlow) { window.preStartFlow(); return; }
        if (window.HHA && typeof window.HHA.startGame === 'function'){ window.HHA.startGame({demoPassed:true}); return; }
        if (typeof window.start === 'function'){ window.start({demoPassed:true}); return; }

        // ‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡∏¢‡∏¥‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ main.js ‡∏î‡∏±‡∏Å‡πÄ‡∏≠‡∏á
        window.dispatchEvent(new CustomEvent('hha:start', { detail:{ mode:state.mode, diff:state.diff }}));
        // ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
        const menu = $('#menuBar'); if(menu) menu.style.display='none';
      }

      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô overlay ‡∏ö‡∏±‡∏á + ‡∏à‡∏±‡∏ö‡∏Å‡∏î Enter/Space
      if (startBtn){
        startBtn.style.pointerEvents='auto';
        startBtn.style.zIndex = '1000';
        startBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); callStart(); }, {capture:true});
        startBtn.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); callStart(); }});
        // probe overlay
        setTimeout(()=>{
          const r = startBtn.getBoundingClientRect();
          const cx=r.left+r.width/2, cy=r.top+r.height/2;
          const topEl = document.elementsFromPoint(cx, cy)[0];
          if (topEl && topEl!==startBtn){
            console.warn('[Overlay on Start]', topEl);
            // ‡∏î‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            startBtn.style.position='relative';
            startBtn.style.zIndex='2147483647';
          }
        }, 600);
      }

      // sync ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏±‡∏ö HUD/‡πÄ‡∏°‡∏ô‡∏π
      refreshBadges();
    })();
  </script>

  <!-- Minimal styles for buttons & modals -->
  <style>
    .btn{
      appearance:none;border:0;border-radius:12px;padding:8px 14px;font-weight:800;
      background:#22314d;color:#e8f0ff;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background: linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; }
    .btn.mode{ background:#1b263b; }
    .btn.diff.is-active, .btn.mode.is-active{ outline:2px solid #7fffd4; }

    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(5,8,15,.55); z-index:101;
    }
    .modal-body{
      background:rgba(15,20,35,.9); color:#eaf2ff; padding:16px 18px; border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      max-width:92vw;
    }
  </style>

  <noscript>
    <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;z-index:9999">
      ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô JavaScript ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ
    </div>
  </noscript>
</body>
</html>
