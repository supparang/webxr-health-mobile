<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Hero Health Academy</title>
<meta name="color-scheme" content="light dark"/>

<style>
:root{--bg:#0b1020;--fg:#e8f3ff;--accent:#22d3ee;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--fg);
  background:radial-gradient(1200px 800px at 50% -10%,#173056 10%,var(--bg) 55%);
  font:500 16px/1.5 ui-rounded,system-ui,Segoe UI,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent;
  transition: background .25s ease;
}
body.fever-on{ background: radial-gradient(1200px 800px at 50% -10%, #513017 10%, var(--bg) 55%); }

/* Layers */
.game-wrap{position:relative;min-height:100dvh;overflow:hidden}
#gameLayer{position:fixed;inset:0;z-index:1}
#spawnHost{position:fixed;inset:0;z-index:5000;pointer-events:auto}

/* HUD shell */
#hud{position:fixed;inset:0;pointer-events:none;z-index:2000}

/* Menu */
#menuBar{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  z-index:9999;background:linear-gradient(#0b1020d0,#0b1020d0);pointer-events:auto;}
#menuBar[data-hidden="1"]{display:none !important;}
.menu-card{width:min(860px,94vw);background:#0e1930;border:1px solid #132a4f;border-radius:16px;
  padding:18px;box-shadow:0 18px 60px rgba(0,0,0,.45);}
.row{display:flex;flex-wrap:wrap;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;
  border-radius:12px;background:#0f1e38;color:#e6f2ff;border:1px solid #16325d;cursor:pointer;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn[data-mode].active,.btn[data-diff].active{outline:2px solid var(--accent);box-shadow:0 0 0 4px #22d3ee22}

/* Toast + warn */
.toast{position:fixed;left:50%;top:68px;transform:translateX(-50%);
  background:#0e1930;border:1px solid #214064;color:#e8f3ff;
  padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .3s;z-index:10040}
.toast.show{opacity:1}
#bootWarn{position:fixed;inset:auto 0 0 0;background:#b00020;color:#fff;padding:10px 12px;font:700 14px ui-sans-serif;z-index:10050;display:none}

/* Fever bar */
#powerBarWrap{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
 width:min(420px,90vw);z-index:2000;}
#powerBar{position:relative;height:16px;border-radius:999px;background:#0a1931;border:1px solid #0f2a54;overflow:hidden}
#powerFill{position:absolute;inset:0;width:100%}
</style>
</head>

<body data-mode="goodjunk" data-diff="Normal">
<div class="game-wrap">
  <div id="gameLayer"></div>
  <div id="spawnHost"></div>

  <div id="menuBar" aria-label="Main menu">
    <div class="menu-card">
      <h2 style="margin:4px 0 12px;font:900 22px ui-rounded">Hero Health Academy</h2>

      <div>
        <h3>Play Mode</h3>
        <div class="row" role="group" aria-label="Mode">
          <div class="btn active" data-mode="goodjunk">ü•ó Good vs Junk</div>
          <div class="btn" data-mode="groups">üß∫ 5 Food Groups</div>
          <div class="btn" data-mode="hydration">üíß Hydration</div>
          <div class="btn" data-mode="plate">üçΩÔ∏è Healthy Plate</div>
        </div>
      </div>

      <hr style="margin:12px 0;border-color:#133"/>

      <div>
        <h3>Difficulty</h3>
        <div class="row">
          <div class="btn" data-diff="Easy">Easy</div>
          <div class="btn active" data-diff="Normal">Normal</div>
          <div class="btn" data-diff="Hard">Hard</div>
        </div>
      </div>

      <hr style="margin:12px 0;border-color:#133"/>

      <div class="row">
        <button id="btn_start" class="btn" data-action="start" type="button" tabindex="0">‚ñ∂Ô∏è Start</button>
        <div class="btn" data-action="howto">‚ùì How to Play</div>
        <div class="btn" data-action="sound">üîä Sound</div>
      </div>
    </div>
  </div>

  <div id="powerBarWrap">
    <div id="powerBar"><div id="powerFill"></div></div>
  </div>
</div>

<!-- AUDIO -->
<audio id="bgm-main" preload="auto"></audio>
<audio id="bgm-fever" preload="auto"></audio>
<audio id="sfx-good" preload="auto" src="assets/sfx/good.mp3"></audio>
<audio id="sfx-bad" preload="auto" src="assets/sfx/bad.mp3"></audio>
<audio id="sfx-perfect" preload="auto" src="assets/sfx/perfect.mp3"></audio>
<audio id="sfx-tick" preload="auto" src="assets/sfx/tick.mp3"></audio>
<audio id="sfx-powerup" preload="auto" src="assets/sfx/powerup.mp3"></audio>

<!-- ‚úÖ Main -->
<script type="module" src="./game/main.js"></script>

<!-- ‚úÖ Emergency DOM Spawner + Binder -->
<script>
(function(){
const $=(s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
function toast(t){let el=$('#toast');if(!el){el=document.createElement('div');el.id='toast';el.className='toast';document.body.appendChild(el);}el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1200);}
function warn(lines){let w=$('#bootWarn');if(!w){w=document.createElement('div');w.id='bootWarn';document.body.appendChild(w);}w.innerHTML=(Array.isArray(lines)?lines:[lines]).map(t=>`<div>${t}</div>`).join('');w.style.display='block';}

/* üß© Emergency DOM Spawner (EDS) */
const EDS=(()=>{
 let run=false,timers=[];
 function host(){return document.getElementById('spawnHost')||document.body;}
 function spawn(){
   const isGood=Math.random()<0.7,isGold=Math.random()<0.1;
   const G=['ü•¶','üçé','ü•ï','ü•ó','üêü','üçå'],B=['üçî','üçü','üç©','üçï','ü•§'];
   const glyph=isGold?'üåü':(isGood?G[Math.random()*G.length|0]:B[Math.random()*B.length|0]);
   const el=document.createElement('button');
   el.textContent=glyph;el.type='button';
   el.style.cssText='position:fixed;z-index:7000;border:0;background:transparent;cursor:pointer;'+
     'font:900 '+(isGold?64:52)+'px ui-rounded;filter:drop-shadow(0 6px 16px rgba(0,0,0,.55));'+
     'left:'+(60+Math.random()*(innerWidth-120))+'px;top:'+(100+Math.random()*(innerHeight-260))+'px;transform:translate(-50%,-50%);';
   const killer=setTimeout(()=>{try{el.remove();}catch{};},isGold?2200:1800);
   el.addEventListener('click',ev=>{
     clearTimeout(killer);try{el.remove();}catch{};
     const fx=document.createElement('div');
     fx.textContent=isGood?'+100':'Oops!';fx.style.cssText='position:fixed;left:'+ev.clientX+'px;top:'+ev.clientY+'px;transform:translate(-50%,-50%);font:900 18px ui-rounded;color:#fff;text-shadow:0 2px 8px #000;opacity:1;transition:all .6s;z-index:7100;';
     document.body.appendChild(fx);requestAnimationFrame(()=>{fx.style.top=(ev.clientY-40)+'px';fx.style.opacity='0';});
     setTimeout(()=>{try{fx.remove();}catch{};},600);
     try{window.HHA=window.HHA||{};window.HHA._seenEvent=true;}catch{}
   },{passive:true});
   host().appendChild(el);
 }
 function loop(){
   if(!run)return;
   if(window.HHA&&window.HHA._seenEvent){stop();return;}
   if(document.querySelectorAll('.eds-target').length<5){spawn();}
   timers.push(setTimeout(loop,700));
 }
 function start(){if(run)return;run=true;for(let i=0;i<4;i++)spawn();loop();timers.push(setTimeout(stop,60000));}
 function stop(){run=false;while(timers.length)clearTimeout(timers.pop());document.querySelectorAll('.eds-target').forEach(e=>{try{e.remove();}catch{}});}
 return{start,stop};
})();

/* MENU binding */
(function(){
 const mb=$('#menuBar');if(!mb)return;
 function setActive(sel,el){$$(sel).forEach(b=>b.classList.remove('active'));el.classList.add('active');}
 mb.addEventListener('click',ev=>{
   const t=ev.target.closest('.btn');if(!t)return;
   if(t.dataset.mode){setActive('[data-mode]',t);document.body.dataset.mode=t.dataset.mode;return;}
   if(t.dataset.diff){setActive('[data-diff]',t);document.body.dataset.diff=t.dataset.diff;return;}
   if(t.dataset.action==='howto'){toast('‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‚Ä¢ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ ‚Ä¢ ‚≠ê ‡πÅ‡∏•‡∏∞ üõ°Ô∏è ‡∏Ñ‡∏∑‡∏≠‡∏û‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©');return;}
   if(t.dataset.action==='sound'){const A=[...document.querySelectorAll('audio')];const anyOn=A.some(a=>!a.muted);A.forEach(a=>a.muted=anyOn);t.textContent=anyOn?'üîá Sound':'üîä Sound';toast(anyOn?'‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î':'‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î');return;}
   if(t.dataset.action==='start'){ev.preventDefault();startNow();return;}
 },false);
})();

function hideMenu(){const mb=$('#menuBar');if(mb){mb.setAttribute('data-hidden','1');mb.style.display='none';}}
function primeAudio(){(['bgm-main','bgm-fever','sfx-good','sfx-bad','sfx-perfect','sfx-tick','sfx-powerup']).forEach(id=>{const a=document.getElementById(id);try{a&&a.play&&a.play().then(()=>a.pause()).catch(()=>{});}catch{}});}

function startNow(){
 hideMenu();primeAudio();EDS.start();
 import(`./game/main.js?ts=${Date.now()}`).then(()=>{if(window.HHA?.startGame){window.HHA.startGame();}}).catch(e=>{console.error('import fail',e);warn(['‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ./game/main.js',String(e?.message||e)])});
 const stopCheck=setInterval(()=>{if(window.HHA&&window.HHA._seenEvent){clearInterval(stopCheck);EDS.stop();}},700);
}

const btn=document.getElementById('btn_start');
if(btn){['click','pointerup','touchend'].forEach(ev=>btn.addEventListener(ev,e=>{e.preventDefault();startNow();},{passive:false}));}

window.addEventListener('keydown',e=>{if((e.key==='Enter'||e.key===' ')&&!document.body.dataset.playing){const vis=!$('#menuBar')?.hasAttribute('data-hidden');if(vis){e.preventDefault();startNow();}}});
})();
</script>

<div id="toast" class="toast"></div>
<div id="bootWarn"></div>
</body>
</html>
