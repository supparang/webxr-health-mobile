<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Hero Health Academy</title>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#0b1020;--fg:#e8f3ff;--muted:#94a3b8;--accent:#22d3ee;}
body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#173056 10%,var(--bg) 55%);color:var(--fg);
font:500 16px/1.5 ui-rounded,system-ui,Segoe UI,Arial,sans-serif;}
.game-wrap{position:relative;min-height:100dvh;overflow:hidden;}
/* ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á */
#gameLayer,#spawnHost{position:fixed;inset:0;pointer-events:none;z-index:1;}
body[data-playing="1"] #gameLayer,
body[data-playing="1"] #spawnHost{pointer-events:auto;}
/* ‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠ */
#menuBar{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
z-index:2147483647;background:linear-gradient(#0b1020d0,#0b1020d0);pointer-events:auto;}
#menuBar[data-hidden="1"]{display:none;}
.menu-card{width:min(860px,94vw);background:#0e1930;border:1px solid #132a4f;border-radius:16px;
padding:18px;box-shadow:0 18px 60px rgba(0,0,0,.45);}
.row{display:flex;flex-wrap:wrap;gap:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;
border-radius:12px;background:#0f1e38;color:#e6f2ff;border:1px solid #16325d;cursor:pointer;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn[data-mode].active,.btn[data-diff].active{outline:2px solid var(--accent);box-shadow:0 0 0 4px #22d3ee22}
#hudTop{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;gap:8px;z-index:50;pointer-events:none}
.badge{background:#0f1e38;border:1px solid #16325d;border-radius:10px;padding:6px 10px;pointer-events:auto}
#scoreVal{font-weight:900}
#powerBarWrap{position:fixed;left:12px;bottom:12px;z-index:18;width:min(380px,92vw)}
#powerBar{position:relative;height:14px;border-radius:999px;background:#0a1931;border:1px solid #0f2a54;overflow:hidden}
#powerFill{position:absolute;inset:0;width:0%}
.fire{position:absolute;left:0;top:0;bottom:0;width:100%;
background:radial-gradient(30px 24px at 20% 110%,rgba(255,200,0,.9),rgba(255,130,0,.65)55%,rgba(255,80,0,.0)70%),
radial-gradient(26px 20px at 45% 110%,rgba(255,210,80,.85),rgba(255,120,0,.55)55%,rgba(255,80,0,.0)70%),
radial-gradient(34px 26px at 70% 110%,rgba(255,190,40,.9),rgba(255,110,0,.55)55%,rgba(255,80,0,.0)70%),
linear-gradient(0deg,rgba(255,140,0,.65),rgba(255,100,0,.25));
mix-blend-mode:screen;animation:fireRise .9s ease-in-out infinite}
@keyframes fireRise{0%{transform:translateY(8px) scaleY(.9)}50%{transform:translateY(0) scaleY(1)}100%{transform:translateY(8px) scaleY(.9)}}
.toast{position:fixed;left:50%;top:68px;transform:translateX(-50%);background:#0e1930;border:1px solid #214064;
color:#e8f3ff;padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .3s;z-index:60}
.toast.show{opacity:1}
</style>
</head>
<body>

<div class="game-wrap">
  <div id="gameLayer"></div>
  <div id="spawnHost"></div>

  <div id="hudTop">
    <div class="badge">Mode: <b id="modeBadge">goodjunk</b> ‚Ä¢ Diff: <b id="diffBadge">Normal</b></div>
    <div class="badge">Score: <span id="scoreVal">0</span></div>
    <div class="badge" id="targetWrap" style="display:none"><span id="targetBadge">Target</span></div>
    <div class="badge" id="missionLine" style="display:none"></div>
  </div>

  <div id="menuBar">
    <div class="menu-card">
      <h2 style="margin:4px 0 12px;font:900 22px ui-rounded">Hero Health Academy</h2>
      <div>
        <h3>Play Mode</h3>
        <div class="row">
          <div class="btn" data-mode="goodjunk">ü•ó Good vs Junk</div>
          <div class="btn" data-mode="groups">üß∫ 5 Food Groups</div>
          <div class="btn" data-mode="hydration">üíß Hydration</div>
          <div class="btn" data-mode="plate">üçΩÔ∏è Healthy Plate</div>
        </div>
      </div>
      <hr style="margin:12px 0;border-color:#133"/>
      <div>
        <h3>Difficulty</h3>
        <div class="row">
          <div class="btn" data-diff="Easy">Easy</div>
          <div class="btn active" data-diff="Normal">Normal</div>
          <div class="btn" data-diff="Hard">Hard</div>
        </div>
      </div>
      <hr style="margin:12px 0;border-color:#133"/>
      <div class="row">
        <!-- ‡∏õ‡∏∏‡πà‡∏° Start ‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î‡∏™‡∏∏‡∏î: id + role + tabindex + onclick fallback -->
        <div id="btn_start" class="btn" data-action="start" role="button" tabindex="0"
             onclick="window.HHA&&typeof HHA.startGame==='function'?HHA.startGame():window.__StartShim&&__StartShim()">‚ñ∂Ô∏è Start</div>
        <div class="btn" data-action="howto">‚ùì How to Play</div>
        <div class="btn" data-action="sound">üîä Sound</div>
      </div>
    </div>
  </div>

  <div id="powerBarWrap"><div id="powerBar"><div id="powerFill"><div class="fire"></div></div></div></div>
</div>

<!-- SFX tags -->
<audio id="sfx-good" preload="auto" src="assets/sfx/good.mp3"></audio>
<audio id="sfx-bad" preload="auto" src="assets/sfx/bad.mp3"></audio>
<audio id="sfx-perfect" preload="auto" src="assets/sfx/perfect.mp3"></audio>
<audio id="sfx-tick" preload="auto" src="assets/sfx/tick.mp3"></audio>
<audio id="sfx-powerup" preload="auto" src="assets/sfx/powerup.mp3"></audio>

<!-- ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏ö) -->
<script type="module" src="./game/main.js"></script>
<script type="module" src="./game/menu-bind.js"></script>

<!-- ‚úÖ SHIM: ‡∏à‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Start ‡∏£‡∏∞‡∏î‡∏±‡∏ö window (capture) + Fallback start ‡∏ñ‡πâ‡∏≤ main.js ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° -->
<script>
(function(){
  // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà main ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô
  window.__HHA_MODE = window.__HHA_MODE || 'goodjunk';
  window.__HHA_DIFF = window.__HHA_DIFF || 'Normal';

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö Fallback (‡πÄ‡∏î‡πÇ‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ) ‚Äî ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡πà ‡πÜ
  window.__StartShim = function(){
    try{
      console.log('[shim] Start fallback');
      document.body.setAttribute('data-mode', window.__HHA_MODE);
      document.body.setAttribute('data-diff', window.__HHA_DIFF);
      const menu = document.getElementById('menuBar');
      menu && menu.setAttribute('data-hidden','1');
      document.body.setAttribute('data-playing','1');
      const host = document.getElementById('spawnHost');
      let n=0; const t=setInterval(()=>{
        if(n++>30){ clearInterval(t); document.body.removeAttribute('data-playing'); menu && menu.removeAttribute('data-hidden'); return; }
        const b=document.createElement('button');
        b.textContent = Math.random()<0.7?'ü•¶':'üçî';
        b.style.cssText='position:absolute;background:transparent;border:0;font-size:40px;left:'+(40+Math.random()*(innerWidth-80))+'px;top:'+(80+Math.random()*(innerHeight-200))+'px;filter:drop-shadow(0 3px 6px rgba(0,0,0,.45))';
        host.appendChild(b); setTimeout(()=>b.remove(),1200);
      }, 400);
    }catch(e){ alert('Start fallback error: '+(e.message||e)); }
  };

  function startSafe(){
    if (window.HHA && typeof window.HHA.startGame==='function'){
      window.HHA.startGame();
    } else {
      // ‡∏£‡∏≠ main.js ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ fallback
      let tries=0;
      const iv=setInterval(()=>{
        tries++;
        if (window.HHA && typeof window.HHA.startGame==='function'){ clearInterval(iv); window.HHA.startGame(); }
        else if (tries>30){ clearInterval(iv); window.__StartShim(); }
      }, 100);
    }
  }

  function handleStart(e){
    const tgt = e.target.closest('#btn_start,[data-action="start"]'); if(!tgt) return;
    e.preventDefault(); e.stopImmediatePropagation();
    console.log('[shim] Start clicked via', e.type);
    // sync badge ‡∏Ñ‡πà‡∏≤ mode/diff
    const mAct = document.querySelector('.btn[data-mode].active'); if(mAct) window.__HHA_MODE = mAct.getAttribute('data-mode')||window.__HHA_MODE;
    const dAct = document.querySelector('.btn[data-diff].active'); if(dAct) window.__HHA_DIFF = dAct.getAttribute('data-diff')||window.__HHA_DIFF;
    document.body.setAttribute('data-mode', window.__HHA_MODE);
    document.body.setAttribute('data-diff', window.__HHA_DIFF);
    startSafe();
  }

  // ‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô capture phase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏î‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô
  ['click','pointerup','touchend','keydown'].forEach(ev=>{
    window.addEventListener(ev, (e)=>{
      if (ev==='keydown'){ if(!(e.key==='Enter'||e.key===' ')) return; }
      handleStart(e);
    }, true); // <-- capture = true
  });

  // ‡∏Å‡∏±‡∏ô element ‡πÉ‡∏î ‡πÜ ‡∏ó‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
  const btn = document.getElementById('btn_start');
  if (btn){ btn.style.position='relative'; btn.style.zIndex='2147483647'; }

  // ‡∏Å‡∏±‡∏ô overlay ‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ ‡∏°‡∏≤‡∏õ‡∏¥‡∏î
  setInterval(()=>{ 
    const menu = document.getElementById('menuBar');
    if(menu && getComputedStyle(menu).display!=='none'){ 
      // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö top-most
      menu.style.zIndex='2147483647';
    }
  }, 800);
})();
</script>

<!-- Toast -->
<div id="toast" class="toast"></div>
</body>
</html>
