<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hero Health Academy</title>
  <meta name="color-scheme" content="light dark"/>

  <style>
    :root{--bg:#0b1020;--fg:#e8f3ff;--accent:#22d3ee;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--fg);
      background:radial-gradient(1200px 800px at 50% -10%,#173056 10%,var(--bg) 55%);
      font:500 16px/1.5 ui-rounded,system-ui,Segoe UI,Arial,sans-serif;
      -webkit-tap-highlight-color:transparent;
      transition:background .25s ease;
    }
    body.fever-on{ background: radial-gradient(1200px 800px at 50% -10%, #513017 10%, var(--bg) 55%); }

    /* Layers */
    .game-wrap{position:relative;min-height:100dvh;overflow:hidden}
    #gameLayer{position:fixed;inset:0;z-index:1}
    #spawnHost{position:fixed;inset:0;z-index:5000;pointer-events:auto}

    /* canvases never block clicks */
    canvas, canvas#c { pointer-events:none !important; z-index:1; position:fixed; inset:0 }

    /* Menu */
    #menuBar{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:9999; background:linear-gradient(#0b1020d0,#0b1020d0); pointer-events:auto;
    }
    #menuBar[data-hidden="1"]{ display:none !important; }
    .menu-card{
      width:min(860px,94vw); background:#0e1930; border:1px solid #132a4f; border-radius:16px;
      padding:18px; box-shadow:0 18px 60px rgba(0,0,0,.45);
    }
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px;
      border-radius:12px; background:#0f1e38; color:#e6f2ff; border:1px solid #16325d; cursor:pointer; user-select:none
    }
    .btn:hover{ filter:brightness(1.08) }
    .btn[data-mode].active,.btn[data-diff].active{ outline:2px solid var(--accent); box-shadow:0 0 0 4px #22d3ee22 }

    /* HUD shell (‡∏ï‡∏±‡∏ß HUD ‡∏à‡∏∞ inject ‡πÄ‡∏≠‡∏á) */
    #hud{position:fixed;inset:0;pointer-events:none;z-index:2000}
    #hud #resultModal{z-index:20020}

    /* Toast + boot warn */
    .toast{
      position:fixed;left:50%;top:68px;transform:translateX(-50%);
      background:#0e1930;border:1px solid #214064;color:#e8f3ff;
      padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .3s;z-index:10040
    }
    .toast.show{opacity:1}
    #bootWarn{position:fixed;inset:auto 0 0 0;background:#b00020;color:#fff;padding:10px 12px;font:700 14px ui-sans-serif;z-index:10050;display:none}

    /* Fever/Power bar (‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö HUD) */
    #powerBarWrap{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); z-index:2200; }
    #powerBar{ position:relative; height:16px; width:min(520px,92vw); border-radius:999px; background:#0a1931; border:1px solid #0f2a54; overflow:hidden }
    #powerFill{ position:absolute; inset:0; width:0% }
  </style>
</head>

<!-- ‡πÇ‡∏´‡∏°‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
<body data-mode="goodjunk" data-diff="Normal">

<div class="game-wrap">
  <div id="gameLayer"></div>
  <div id="spawnHost"></div>

  <!-- MENU -->
  <div id="menuBar" aria-label="Main menu">
    <div class="menu-card">
      <h2 style="margin:4px 0 12px;font:900 22px ui-rounded">Hero Health Academy</h2>

      <div>
        <h3>Play Mode</h3>
        <div class="row" role="group" aria-label="Mode">
          <div class="btn active" data-mode="goodjunk">ü•ó Good vs Junk</div>
          <div class="btn" data-mode="groups">üß∫ 5 Food Groups</div>
          <div class="btn" data-mode="hydration">üíß Hydration</div>
          <div class="btn" data-mode="plate">üçΩÔ∏è Healthy Plate</div>
        </div>
      </div>

      <hr style="margin:12px 0;border-color:#133"/>

      <div>
        <h3>Difficulty</h3>
        <div class="row" role="group" aria-label="Difficulty">
          <div class="btn" data-diff="Easy">Easy</div>
          <div class="btn active" data-diff="Normal">Normal</div>
          <div class="btn" data-diff="Hard">Hard</div>
        </div>
      </div>

      <hr style="margin:12px 0;border-color:#133"/>

      <div class="row">
        <button id="btn_start" class="btn" data-action="start" type="button" tabindex="0" aria-label="Start game">‚ñ∂Ô∏è Start</button>
        <div class="btn" data-action="howto" role="button" tabindex="0">‚ùì How to Play</div>
        <div class="btn" data-action="sound" role="button" tabindex="0">üîä Sound</div>
      </div>
    </div>
  </div>

  <!-- Fever/Power bar container (HUD ‡∏à‡∏∞‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á) -->
  <div id="powerBarWrap">
    <div id="powerBar">
      <div id="powerFill"></div>
    </div>
  </div>

  <!-- AUDIO (bgm + sfx) -->
  <audio id="bgm-main" preload="auto"></audio>
  <audio id="bgm-fever" preload="auto"></audio>
  <audio id="sfx-good" preload="auto" src="assets/sfx/good.mp3"></audio>
  <audio id="sfx-bad" preload="auto" src="assets/sfx/bad.mp3"></audio>
  <audio id="sfx-perfect" preload="auto" src="assets/sfx/perfect.mp3"></audio>
  <audio id="sfx-tick" preload="auto" src="assets/sfx/tick.mp3"></audio>
  <audio id="sfx-powerup" preload="auto" src="assets/sfx/powerup.mp3"></audio>
</div>

<!-- Binder + Dynamic Import (force-fresh) -->
<script>
(function(){
  const MUTED_KEY = 'hha_muted';
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);

  // UI helpers
  function toast(text){
    let el = $('#toast'); if(!el){ el=document.createElement('div'); el.id='toast'; el.className='toast'; document.body.appendChild(el); }
    el.textContent = text; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1200);
  }
  function warn(lines){
    let w = $('#bootWarn'); if(!w){ w=document.createElement('div'); w.id='bootWarn'; document.body.appendChild(w); }
    w.innerHTML = (Array.isArray(lines)?lines:[lines]).map(t=>`<div>${t}</div>`).join('');
    w.style.display='block';
  }

  // Apply mute from storage
  function applyMuteFromStorage(){
    const muted = localStorage.getItem(MUTED_KEY) === '1';
    $$('audio').forEach(a=>{ try{ a.muted = muted; }catch{} });
    const btn = $('.btn[data-action="sound"]');
    if(btn) btn.textContent = muted ? 'üîá Sound' : 'üîä Sound';
  }
  applyMuteFromStorage();

  // Always import fresh main.js
  async function ensureMainFresh(){
    try { delete window.HHA; } catch {}
    const v = Date.now(); // cache-buster
    await import(`./game/main.js?v=${v}`);
    if (!window.HHA?.startGame) throw new Error('HHA.startGame missing after import');
  }

  // Clean start
  async function startNow(e){
    if (e){ e.preventDefault(); e.stopPropagation(); }

    // prime audio gesture
    try{
      (['bgm-main','bgm-fever','sfx-good','sfx-bad','sfx-perfect','sfx-tick','sfx-powerup'])
        .forEach(id=>{ const a=document.getElementById(id); a && a.play && a.play().then(()=>a.pause()).catch(()=>{}); });
    }catch{}

    try{
      await ensureMainFresh();
      // Hide menu
      const mb = $('#menuBar');
      if (mb){ mb.setAttribute('data-hidden','1'); mb.style.display='none'; }
      // Start new round
      window.HHA.startGame();
    }catch(err){
      console.error(err);
      warn(['‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î ./game/main.js ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err?.message||err)]);
    }
  }

  // Bind menu buttons
  const mb = $('#menuBar');
  if (mb){
    function setActive(sel,el){ $$(sel).forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
    mb.addEventListener('click', (ev)=>{
      const t=ev.target.closest('.btn'); if(!t) return;
      if (t.dataset.action==='start'){ startNow(ev); return; }
      if (t.dataset.action==='howto'){ toast('‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‚Ä¢ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏î‡∏µ ‚Ä¢ ‚≠ê Golden ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á ‚Ä¢ ‡πÄ‡∏Å‡∏à‡πÄ‡∏ï‡πá‡∏° = FEVER'); return; }
      if (t.dataset.action==='sound'){
        const nowMuted = !(localStorage.getItem(MUTED_KEY) === '1');
        localStorage.setItem(MUTED_KEY, nowMuted ? '1' : '0');
        applyMuteFromStorage(); toast(nowMuted ? '‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î'); return;
      }
      if (t.hasAttribute('data-mode')){ setActive('[data-mode]', t); document.body.setAttribute('data-mode', t.getAttribute('data-mode')); return; }
      if (t.hasAttribute('data-diff')){ setActive('[data-diff]', t); document.body.setAttribute('data-diff', t.getAttribute('data-diff')); return; }
    }, false);

    // rebuild Start button listener (clean)
    const old = document.getElementById('btn_start'); if (old){
      const clone = old.cloneNode(true);
      old.replaceWith(clone);
      const opts = { capture:true, passive:false };
      ['click','pointerup','touchend'].forEach(ev=> clone.addEventListener(ev, startNow, opts));
      clone.addEventListener('keydown', (e)=>{ if (e.key==='Enter'||e.key===' ') { startNow(e); } }, opts);
    }
  }

  // Keyboard quick start (from menu)
  window.addEventListener('keydown', (e)=>{
    const inGame = document.body.getAttribute('data-playing')==='1';
    const menuVisible = !document.getElementById('menuBar')?.hasAttribute('data-hidden');
    if ((e.key==='Enter'||e.key===' ') && !inGame && menuVisible){ e.preventDefault(); startNow(e); }
  }, {passive:false});

  // Resize guard: canvases never capture pointer
  const ensureCanvas = ()=>{ document.querySelectorAll('canvas').forEach(c=>{ try{ c.style.pointerEvents='none'; c.style.zIndex='1'; }catch{} }); };
  window.addEventListener('resize', ensureCanvas);
  setTimeout(ensureCanvas, 0);
})();
</script>

<div id="toast" class="toast"></div>
<div id="bootWarn"></div>
</body>
</html>
